parcelRequire=function(e,r,n,t){function i(n,t){function o(e){return i(o.resolve(e))}function c(r){return e[n][1][r]||r}if(!r[n]){if(!e[n]){var l="function"==typeof parcelRequire&&parcelRequire;if(!t&&l)return l(n,!0);if(u)return u(n,!0);if(f&&"string"==typeof n)return f(n);var p=new Error("Cannot find module '"+n+"'");throw p.code="MODULE_NOT_FOUND",p}o.resolve=c;var a=r[n]=new i.Module(n);e[n][0].call(a.exports,o,a,a.exports,this)}return r[n].exports}function o(e){this.id=e,this.bundle=i,this.exports={}}var u="function"==typeof parcelRequire&&parcelRequire,f="function"==typeof require&&require;i.isParcelRequire=!0,i.Module=o,i.modules=e,i.cache=r,i.parent=u;for(var c=0;c<n.length;c++)i(n[c]);if(n.length){var l=i(n[n.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):t&&(this[t]=l)}return i}({19:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(){function t(){this._events=this._events||{}}return t.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},t.prototype.addDisposableListener=function(t,e){var n=this;return this.on(t,e),{dispose:function(){e&&(n.off(t,e),e=null)}}},t.prototype.off=function(t,e){if(this._events[t])for(var n=this._events[t],s=n.length;s--;)if(n[s]===e)return void n.splice(s,1)},t.prototype.removeAllListeners=function(t){this._events[t]&&delete this._events[t]},t.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(this._events[t])for(var s=this._events[t],i=0;i<s.length;i++)s[i].apply(this,e)},t.prototype.listeners=function(t){return this._events[t]||[]},t.prototype.dispose=function(){this._events={}},t}();exports.EventEmitter=t;
},{}],145:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../EventEmitter"),i=function(e){function i(t){var i=e.call(this)||this;return i._maxLength=t,i._array=new Array(i._maxLength),i._startIndex=0,i._length=0,i}return t(i,e),Object.defineProperty(i.prototype,"maxLength",{get:function(){return this._maxLength},set:function(t){if(this._maxLength!==t){for(var e=new Array(t),i=0;i<Math.min(t,this.length);i++)e[i]=this._array[this._getCyclicIndex(i)];this._array=e,this._maxLength=t,this._startIndex=0}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"length",{get:function(){return this._length},set:function(t){if(t>this._length)for(var e=this._length;e<t;e++)this._array[e]=void 0;this._length=t},enumerable:!0,configurable:!0}),i.prototype.get=function(t){return this._array[this._getCyclicIndex(t)]},i.prototype.set=function(t,e){this._array[this._getCyclicIndex(t)]=e},i.prototype.push=function(t){this._array[this._getCyclicIndex(this._length)]=t,this._length===this._maxLength?(this._startIndex++,this._startIndex===this._maxLength&&(this._startIndex=0),this.emit("trim",1)):this._length++},i.prototype.pop=function(){return this._array[this._getCyclicIndex(this._length---1)]},i.prototype.splice=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];if(e){for(var r=t;r<this._length-e;r++)this._array[this._getCyclicIndex(r)]=this._array[this._getCyclicIndex(r+e)];this._length-=e}if(i&&i.length){for(r=this._length-1;r>=t;r--)this._array[this._getCyclicIndex(r+i.length)]=this._array[this._getCyclicIndex(r)];for(r=0;r<i.length;r++)this._array[this._getCyclicIndex(t+r)]=i[r];if(this._length+i.length>this.maxLength){var h=this._length+i.length-this.maxLength;this._startIndex+=h,this._length=this.maxLength,this.emit("trim",h)}else this._length+=i.length}},i.prototype.trimStart=function(t){t>this._length&&(t=this._length),this._startIndex+=t,this._length-=t,this.emit("trim",t)},i.prototype.shiftElements=function(t,e,i){if(!(e<=0)){if(t<0||t>=this._length)throw new Error("start argument out of range");if(t+i<0)throw new Error("Cannot shift elements in list beyond index 0");if(i>0){for(var n=e-1;n>=0;n--)this.set(t+n+i,this.get(t+n));var r=t+e+i-this._length;if(r>0)for(this._length+=r;this._length>this.maxLength;)this._length--,this._startIndex++,this.emit("trim",1)}else for(n=0;n<e;n++)this.set(t+n+i,this.get(t+n))}},i.prototype._getCyclicIndex=function(t){return(this._startIndex+t)%this.maxLength},i}(e.EventEmitter);exports.CircularList=i;
},{"../EventEmitter":19}],17:[function(require,module,exports) {

"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var i in s)s.hasOwnProperty(i)&&(t[i]=s[i])};return function(s,i){function e(){this.constructor=s}t(s,i),s.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var s=require("./utils/CircularList"),i=require("./EventEmitter");exports.CHAR_DATA_ATTR_INDEX=0,exports.CHAR_DATA_CHAR_INDEX=1,exports.CHAR_DATA_WIDTH_INDEX=2,exports.CHAR_DATA_CODE_INDEX=3,exports.MAX_BUFFER_SIZE=4294967295;var e=function(){function t(t,s){this._terminal=t,this._hasScrollback=s,this.markers=[],this.clear()}return Object.defineProperty(t.prototype,"hasScrollback",{get:function(){return this._hasScrollback&&this.lines.maxLength>this._terminal.rows},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isCursorInViewport",{get:function(){var t=this.ybase+this.y-this.ydisp;return t>=0&&t<this._terminal.rows},enumerable:!0,configurable:!0}),t.prototype._getCorrectBufferLength=function(t){if(!this._hasScrollback)return t;var s=t+this._terminal.options.scrollback;return s>exports.MAX_BUFFER_SIZE?exports.MAX_BUFFER_SIZE:s},t.prototype.fillViewportRows=function(){if(0===this.lines.length)for(var t=this._terminal.rows;t--;)this.lines.push(this._terminal.blankLine())},t.prototype.clear=function(){this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.lines=new s.CircularList(this._getCorrectBufferLength(this._terminal.rows)),this.scrollTop=0,this.scrollBottom=this._terminal.rows-1,this.setupTabStops()},t.prototype.resize=function(t,s){var i=this._getCorrectBufferLength(s);if(i>this.lines.maxLength&&(this.lines.maxLength=i),this.lines.length>0){if(this._terminal.cols<t)for(var e=[this._terminal.defAttr," ",1,32],r=0;r<this.lines.length;r++)for(;this.lines.get(r).length<t;)this.lines.get(r).push(e);var n=0;if(this._terminal.rows<s)for(var o=this._terminal.rows;o<s;o++)this.lines.length<s+this.ybase&&(this.ybase>0&&this.lines.length<=this.ybase+this.y+n+1?(this.ybase--,n++,this.ydisp>0&&this.ydisp--):this.lines.push(this._terminal.blankLine(void 0,void 0,t)));else for(o=this._terminal.rows;o>s;o--)this.lines.length>s+this.ybase&&(this.lines.length>this.ybase+this.y+1?this.lines.pop():(this.ybase++,this.ydisp++));if(i<this.lines.maxLength){var h=this.lines.length-i;h>0&&(this.lines.trimStart(h),this.ybase=Math.max(this.ybase-h,0),this.ydisp=Math.max(this.ydisp-h,0)),this.lines.maxLength=i}this.x=Math.min(this.x,t-1),this.y=Math.min(this.y,s-1),n&&(this.y+=n),this.savedY=Math.min(this.savedY,s-1),this.savedX=Math.min(this.savedX,t-1),this.scrollTop=0}this.scrollBottom=s-1},t.prototype.translateBufferLineToString=function(t,s,i,e){void 0===i&&(i=0),void 0===e&&(e=null);var r="",n=this.lines.get(t);if(!n)return"";var o=i;null===e&&(e=n.length);for(var h=e,a=0;a<n.length;a++){var l=n[a];r+=l[exports.CHAR_DATA_CHAR_INDEX],0===l[exports.CHAR_DATA_WIDTH_INDEX]?(i>=a&&o--,e>=a&&h--):l[exports.CHAR_DATA_CHAR_INDEX].length>1&&(i>a&&(o+=l[exports.CHAR_DATA_CHAR_INDEX].length-1),e>a&&(h+=l[exports.CHAR_DATA_CHAR_INDEX].length-1))}if(s){var p=r.search(/\s+$/);if(-1!==p&&(h=Math.min(h,p)),h<=o)return""}return r.substring(o,h)},t.prototype.setupTabStops=function(t){for(null!=t?this.tabs[t]||(t=this.prevStop(t)):(this.tabs={},t=0);t<this._terminal.cols;t+=this._terminal.options.tabStopWidth)this.tabs[t]=!0},t.prototype.prevStop=function(t){for(null==t&&(t=this.x);!this.tabs[--t]&&t>0;);return t>=this._terminal.cols?this._terminal.cols-1:t<0?0:t},t.prototype.nextStop=function(t){for(null==t&&(t=this.x);!this.tabs[++t]&&t<this._terminal.cols;);return t>=this._terminal.cols?this._terminal.cols-1:t<0?0:t},t.prototype.addMarker=function(t){var s=this,i=new r(t);return this.markers.push(i),i.disposables.push(this.lines.addDisposableListener("trim",function(t){i.line-=t,i.line<0&&i.dispose()})),i.on("dispose",function(){return s._removeMarker(i)}),i},t.prototype._removeMarker=function(t){this.markers.splice(this.markers.indexOf(t),1)},t}();exports.Buffer=e;var r=function(s){function i(t){var e=s.call(this)||this;return e.line=t,e._id=i.NEXT_ID++,e.isDisposed=!1,e.disposables=[],e}return t(i,s),Object.defineProperty(i.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),i.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.disposables.forEach(function(t){return t.dispose()}),this.disposables.length=0,this.emit("dispose"))},i.NEXT_ID=1,i}(i.EventEmitter);exports.Marker=r;
},{"./utils/CircularList":145,"./EventEmitter":19}],16:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./Buffer"),r=require("./EventEmitter"),i=function(r){function i(t){var i=r.call(this)||this;return i._terminal=t,i._normal=new e.Buffer(i._terminal,!0),i._normal.fillViewportRows(),i._alt=new e.Buffer(i._terminal,!1),i._activeBuffer=i._normal,i.setupTabStops(),i}return t(i,r),Object.defineProperty(i.prototype,"alt",{get:function(){return this._alt},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"active",{get:function(){return this._activeBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"normal",{get:function(){return this._normal},enumerable:!0,configurable:!0}),i.prototype.activateNormalBuffer=function(){this._activeBuffer!==this._normal&&(this._alt.clear(),this._activeBuffer=this._normal,this.emit("activate",{activeBuffer:this._normal,inactiveBuffer:this._alt}))},i.prototype.activateAltBuffer=function(){this._activeBuffer!==this._alt&&(this._alt.fillViewportRows(),this._activeBuffer=this._alt,this.emit("activate",{activeBuffer:this._alt,inactiveBuffer:this._normal}))},i.prototype.resize=function(t,e){this._normal.resize(t,e),this._alt.resize(t,e)},i.prototype.setupTabStops=function(t){this._normal.setupTabStops(t),this._alt.setupTabStops(t)},i}(r.EventEmitter);exports.BufferSet=i;
},{"./Buffer":17,"./EventEmitter":19}],18:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(){function t(t,i,e){this._textarea=t,this._compositionView=i,this._terminal=e,this._isComposing=!1,this._isSendingComposition=!1,this._compositionPosition={start:null,end:null}}return t.prototype.compositionstart=function(){this._isComposing=!0,this._compositionPosition.start=this._textarea.value.length,this._compositionView.textContent="",this._compositionView.classList.add("active")},t.prototype.compositionupdate=function(t){var i=this;this._compositionView.textContent=t.data,this.updateCompositionElements(),setTimeout(function(){i._compositionPosition.end=i._textarea.value.length},0)},t.prototype.compositionend=function(){this._finalizeComposition(!0)},t.prototype.keydown=function(t){if(this._isComposing||this._isSendingComposition){if(229===t.keyCode)return!1;if(16===t.keyCode||17===t.keyCode||18===t.keyCode)return!1;this._finalizeComposition(!1)}return 229!==t.keyCode||(this._handleAnyTextareaChanges(),!1)},t.prototype._finalizeComposition=function(t){var i=this;if(this._compositionView.classList.remove("active"),this._isComposing=!1,this._clearTextareaPosition(),t){var e={start:this._compositionPosition.start,end:this._compositionPosition.end};this._isSendingComposition=!0,setTimeout(function(){if(i._isSendingComposition){i._isSendingComposition=!1;var t=void 0;t=i._isComposing?i._textarea.value.substring(e.start,e.end):i._textarea.value.substring(e.start),i._terminal.handler(t)}},0)}else{this._isSendingComposition=!1;var o=this._textarea.value.substring(this._compositionPosition.start,this._compositionPosition.end);this._terminal.handler(o)}},t.prototype._handleAnyTextareaChanges=function(){var t=this,i=this._textarea.value;setTimeout(function(){if(!t._isComposing){var e=t._textarea.value.replace(i,"");e.length>0&&t._terminal.handler(e)}},0)},t.prototype.updateCompositionElements=function(t){var i=this;if(this._isComposing){if(this._terminal.buffer.isCursorInViewport){var e=Math.ceil(this._terminal.charMeasure.height*this._terminal.options.lineHeight),o=this._terminal.buffer.y*e,s=this._terminal.buffer.x*this._terminal.charMeasure.width;this._compositionView.style.left=s+"px",this._compositionView.style.top=o+"px",this._compositionView.style.height=e+"px",this._compositionView.style.lineHeight=e+"px";var n=this._compositionView.getBoundingClientRect();this._textarea.style.left=s+"px",this._textarea.style.top=o+"px",this._textarea.style.width=n.width+"px",this._textarea.style.height=n.height+"px",this._textarea.style.lineHeight=n.height+"px"}t||setTimeout(function(){return i.updateCompositionElements(!0)},0)}},t.prototype._clearTextareaPosition=function(){this._textarea.style.left="",this._textarea.style.top=""},t}();exports.CompositionHelper=t;
},{}],20:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=15,t=function(){function t(t,r,i,o){var s=this;this._terminal=t,this._viewportElement=r,this._scrollArea=i,this._charMeasure=o,this.scrollBarWidth=0,this._currentRowHeight=0,this._lastRecordedBufferLength=0,this._lastRecordedViewportHeight=0,this._lastRecordedBufferHeight=0,this._wheelPartialScroll=0,this.scrollBarWidth=this._viewportElement.offsetWidth-this._scrollArea.offsetWidth||e,this._viewportElement.addEventListener("scroll",this._onScroll.bind(this)),setTimeout(function(){return s.syncScrollArea()},0)}return t.prototype.onThemeChanged=function(e){this._viewportElement.style.backgroundColor=e.background.css},t.prototype._refresh=function(){if(this._charMeasure.height>0){this._currentRowHeight=this._terminal.renderer.dimensions.scaledCellHeight/window.devicePixelRatio,this._lastRecordedViewportHeight=this._viewportElement.offsetHeight;var e=Math.round(this._currentRowHeight*this._lastRecordedBufferLength)+(this._lastRecordedViewportHeight-this._terminal.renderer.dimensions.canvasHeight);this._lastRecordedBufferHeight!==e&&(this._lastRecordedBufferHeight=e,this._scrollArea.style.height=this._lastRecordedBufferHeight+"px")}},t.prototype.syncScrollArea=function(){this._lastRecordedBufferLength!==this._terminal.buffer.lines.length?(this._lastRecordedBufferLength=this._terminal.buffer.lines.length,this._refresh()):this._lastRecordedViewportHeight!==this._terminal.renderer.dimensions.canvasHeight?this._refresh():this._terminal.renderer.dimensions.scaledCellHeight/window.devicePixelRatio!==this._currentRowHeight&&this._refresh();var e=this._terminal.buffer.ydisp*this._currentRowHeight;this._viewportElement.scrollTop!==e&&(this._viewportElement.scrollTop=e)},t.prototype._onScroll=function(e){if(this._viewportElement.offsetParent){var t=Math.round(this._viewportElement.scrollTop/this._currentRowHeight)-this._terminal.buffer.ydisp;this._terminal.scrollLines(t,!0)}},t.prototype.onWheel=function(e){var t=this._getPixelsScrolled(e);0!==t&&(this._viewportElement.scrollTop+=t,e.preventDefault())},t.prototype._getPixelsScrolled=function(e){if(0===e.deltaY)return 0;var t=e.deltaY;return e.deltaMode===WheelEvent.DOM_DELTA_LINE?t*=this._currentRowHeight:e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._currentRowHeight*this._terminal.rows),t},t.prototype.getLinesScrolled=function(e){if(0===e.deltaY)return 0;var t=e.deltaY;return e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?(t/=this._currentRowHeight+0,this._wheelPartialScroll+=t,t=Math.floor(Math.abs(this._wheelPartialScroll))*(this._wheelPartialScroll>0?1:-1),this._wheelPartialScroll%=1):e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._terminal.rows),t},t.prototype.onTouchStart=function(e){this._lastTouchY=e.touches[0].pageY},t.prototype.onTouchMove=function(e){var t=this._lastTouchY-e.touches[0].pageY;this._lastTouchY=e.touches[0].pageY,0!==t&&(this._viewportElement.scrollTop+=t,e.preventDefault())},t}();exports.Viewport=t;
},{}],29:[function(require,module,exports) {
"use strict";function e(e){return e.replace(/\r?\n/g,"\r")}function t(e,t){return t?"[200~"+e+"[201~":e}function l(e,t,l){t.browser.isMSIE?window.clipboardData.setData("Text",l.selectionText):e.clipboardData.setData("text/plain",l.selectionText),e.preventDefault()}function a(l,a){l.stopPropagation();var o=function(o){o=t(o=e(o),a.bracketedPasteMode),a.handler(o),a.textarea.value="",a.emit("paste",o),a.cancel(l)};a.browser.isMSIE?window.clipboardData&&o(window.clipboardData.getData("Text")):l.clipboardData&&o(l.clipboardData.getData("text/plain"))}function o(e,t){t.style.position="fixed",t.style.width="20px",t.style.height="20px",t.style.left=e.clientX-10+"px",t.style.top=e.clientY-10+"px",t.style.zIndex="1000",t.focus(),setTimeout(function(){t.style.position=null,t.style.width=null,t.style.height=null,t.style.left=null,t.style.top=null,t.style.zIndex=null},200)}function n(e,t,l,a){o(e,t),a&&!l.isClickInSelection(e)&&l.selectWordAtCursor(e),t.value=l.selectionText,t.select()}Object.defineProperty(exports,"__esModule",{value:!0}),exports.prepareTextForTerminal=e,exports.bracketTextForPaste=t,exports.copyHandler=l,exports.pasteHandler=a,exports.moveTextAreaUnderMouseCursor=o,exports.rightClickHandler=n;
},{}],21:[function(require,module,exports) {
"use strict";var S;Object.defineProperty(exports,"__esModule",{value:!0}),function(S){S.NUL="\0",S.SOH="",S.STX="",S.ETX="",S.EOT="",S.ENQ="",S.ACK="",S.BEL="",S.BS="\b",S.HT="\t",S.LF="\n",S.VT="\v",S.FF="\f",S.CR="\r",S.SO="",S.SI="",S.DLE="",S.DC1="",S.DC2="",S.DC3="",S.DC4="",S.NAK="",S.SYN="",S.ETB="",S.CAN="",S.EM="",S.SUB="",S.ESC="",S.FS="",S.GS="",S.RS="",S.US="",S.SP=" ",S.DEL=""}(S=exports.C0||(exports.C0={}));
},{}],142:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CHARSETS={},exports.DEFAULT_CHARSET=exports.CHARSETS.B,exports.CHARSETS[0]={"`":"◆",a:"▒",b:"\t",c:"\f",d:"\r",e:"\n",f:"°",g:"±",h:"␤",i:"\v",j:"┘",k:"┐",l:"┌",m:"└",n:"┼",o:"⎺",p:"⎻",q:"─",r:"⎼",s:"⎽",t:"├",u:"┤",v:"┴",w:"┬",x:"│",y:"≤",z:"≥","{":"π","|":"≠","}":"£","~":"·"},exports.CHARSETS.A={"#":"£"},exports.CHARSETS.B=null,exports.CHARSETS[4]={"#":"£","@":"¾","[":"ij","\\":"½","]":"|","{":"¨","|":"f","}":"¼","~":"´"},exports.CHARSETS.C=exports.CHARSETS[5]={"[":"Ä","\\":"Ö","]":"Å","^":"Ü","`":"é","{":"ä","|":"ö","}":"å","~":"ü"},exports.CHARSETS.R={"#":"£","@":"à","[":"°","\\":"ç","]":"§","{":"é","|":"ù","}":"è","~":"¨"},exports.CHARSETS.Q={"@":"à","[":"â","\\":"ç","]":"ê","^":"î","`":"ô","{":"é","|":"ù","}":"è","~":"û"},exports.CHARSETS.K={"@":"§","[":"Ä","\\":"Ö","]":"Ü","{":"ä","|":"ö","}":"ü","~":"ß"},exports.CHARSETS.Y={"#":"£","@":"§","[":"°","\\":"ç","]":"é","`":"ù","{":"à","|":"ò","}":"è","~":"ì"},exports.CHARSETS.E=exports.CHARSETS[6]={"@":"Ä","[":"Æ","\\":"Ø","]":"Å","^":"Ü","`":"ä","{":"æ","|":"ø","}":"å","~":"ü"},exports.CHARSETS.Z={"#":"£","@":"§","[":"¡","\\":"Ñ","]":"¿","{":"°","|":"ñ","}":"ç"},exports.CHARSETS.H=exports.CHARSETS[7]={"@":"É","[":"Ä","\\":"Ö","]":"Å","^":"Ü","`":"é","{":"ä","|":"ö","}":"å","~":"ü"},exports.CHARSETS["="]={"#":"ù","@":"à","[":"é","\\":"ç","]":"ê","^":"î",_:"è","`":"ô","{":"ä","|":"ö","}":"ü","~":"û"};
},{}],143:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.wcwidth=function(r){var n=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],t=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]];function e(r,n){var t,e=0,u=n.length-1;if(r<n[0][0]||r>n[u][1])return!1;for(;u>=e;)if(r>n[t=e+u>>1][1])e=t+1;else{if(!(r<n[t][0]))return!0;u=t-1}return!1}var u=0|r.control,o=null;return function(f){if((f|=0)<32)return 0|u;if(f<127)return 1;var i,a=o||function(){var t;o="undefined"==typeof Uint32Array?new Array(4096):new Uint32Array(4096);for(var u=0;u<4096;++u){for(var f=0,i=16;i--;)f=f<<2|(0===(t=16*u+i)?r.nul:t<32||t>=127&&t<160?r.control:e(t,n)?0:function(r){return r>=4352&&(r<=4447||9001===r||9002===r||r>=11904&&r<=42191&&12351!==r||r>=44032&&r<=55203||r>=63744&&r<=64255||r>=65040&&r<=65049||r>=65072&&r<=65135||r>=65280&&r<=65376||r>=65504&&r<=65510)}(t)?2:1);o[u]=f}return o}();return f<65536?a[f>>4]>>((15&f)<<1)&3:e(i=f,t)?0:i>=131072&&i<=196605||i>=196608&&i<=262141?2:1}}({nul:0,control:0});
},{}],22:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./EscapeSequences"),e=require("./Charsets"),i=require("./Buffer"),r=require("./CharWidth"),s=function(){function s(t){this._terminal=t}return s.prototype.addChar=function(t,e){if(t>=" "){var s=this._terminal.buffer,a=r.wcwidth(e);this._terminal.charset&&this._terminal.charset[t]&&(t=this._terminal.charset[t]),this._terminal.options.screenReaderMode&&this._terminal.emit("a11y.char",t);var n=s.y+s.ybase;if(!a&&s.x)return void(s.lines.get(n)[s.x-1]&&(s.lines.get(n)[s.x-1][i.CHAR_DATA_WIDTH_INDEX]?(s.lines.get(n)[s.x-1][i.CHAR_DATA_CHAR_INDEX]+=t,s.lines.get(n)[s.x-1][3]=t.charCodeAt(0)):s.lines.get(n)[s.x-2]&&(s.lines.get(n)[s.x-2][i.CHAR_DATA_CHAR_INDEX]+=t,s.lines.get(n)[s.x-2][3]=t.charCodeAt(0)),this._terminal.updateRange(s.y)));if(s.x+a-1>=this._terminal.cols)if(this._terminal.wraparoundMode)s.x=0,s.y++,s.y>s.scrollBottom?(s.y--,this._terminal.scroll(!0)):s.lines.get(s.y).isWrapped=!0;else if(2===a)return;if(n=s.y+s.ybase,this._terminal.insertMode)for(var l=0;l<a;++l){0===s.lines.get(s.y+s.ybase).pop()[i.CHAR_DATA_WIDTH_INDEX]&&s.lines.get(n)[this._terminal.cols-2]&&2===s.lines.get(n)[this._terminal.cols-2][i.CHAR_DATA_WIDTH_INDEX]&&(s.lines.get(n)[this._terminal.cols-2]=[this._terminal.curAttr," ",1," ".charCodeAt(0)]),s.lines.get(n).splice(s.x,0,[this._terminal.curAttr," ",1," ".charCodeAt(0)])}s.lines.get(n)[s.x]=[this._terminal.curAttr,t,a,t.charCodeAt(0)],s.x++,this._terminal.updateRange(s.y),2===a&&(s.lines.get(n)[s.x]=[this._terminal.curAttr,"",0,void 0],s.x++)}},s.prototype.bell=function(){this._terminal.bell()},s.prototype.lineFeed=function(){var t=this._terminal.buffer;this._terminal.convertEol&&(t.x=0),t.y++,t.y>t.scrollBottom&&(t.y--,this._terminal.scroll()),t.x>=this._terminal.cols&&t.x--,this._terminal.emit("linefeed")},s.prototype.carriageReturn=function(){this._terminal.buffer.x=0},s.prototype.backspace=function(){this._terminal.buffer.x>0&&this._terminal.buffer.x--},s.prototype.tab=function(){var t=this._terminal.buffer.x;this._terminal.buffer.x=this._terminal.buffer.nextStop(),this._terminal.options.screenReaderMode&&this._terminal.emit("a11y.tab",this._terminal.buffer.x-t)},s.prototype.shiftOut=function(){this._terminal.setgLevel(1)},s.prototype.shiftIn=function(){this._terminal.setgLevel(0)},s.prototype.insertChars=function(t){var e=t[0];e<1&&(e=1);for(var i=this._terminal.buffer,r=i.y+i.ybase,s=i.x,a=[this._terminal.eraseAttr()," ",1,32];e--&&s<this._terminal.cols;)i.lines.get(r).splice(s++,0,a),i.lines.get(r).pop()},s.prototype.cursorUp=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y-=e,this._terminal.buffer.y<0&&(this._terminal.buffer.y=0)},s.prototype.cursorDown=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y+=e,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--},s.prototype.cursorForward=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.x+=e,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},s.prototype.cursorBackward=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--,this._terminal.buffer.x-=e,this._terminal.buffer.x<0&&(this._terminal.buffer.x=0)},s.prototype.cursorNextLine=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y+=e,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x=0},s.prototype.cursorPrecedingLine=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y-=e,this._terminal.buffer.y<0&&(this._terminal.buffer.y=0),this._terminal.buffer.x=0},s.prototype.cursorCharAbsolute=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.x=e-1},s.prototype.cursorPosition=function(t){var e,i=t[0]-1;e=t.length>=2?t[1]-1:0,i<0?i=0:i>=this._terminal.rows&&(i=this._terminal.rows-1),e<0?e=0:e>=this._terminal.cols&&(e=this._terminal.cols-1),this._terminal.buffer.x=e,this._terminal.buffer.y=i},s.prototype.cursorForwardTab=function(t){for(var e=t[0]||1;e--;)this._terminal.buffer.x=this._terminal.buffer.nextStop()},s.prototype.eraseInDisplay=function(t){var e;switch(t[0]){case 0:for(this._terminal.eraseRight(this._terminal.buffer.x,this._terminal.buffer.y),e=this._terminal.buffer.y+1;e<this._terminal.rows;e++)this._terminal.eraseLine(e);break;case 1:for(this._terminal.eraseLeft(this._terminal.buffer.x,this._terminal.buffer.y),e=this._terminal.buffer.y;e--;)this._terminal.eraseLine(e);break;case 2:for(e=this._terminal.rows;e--;)this._terminal.eraseLine(e);break;case 3:var i=this._terminal.buffer.lines.length-this._terminal.rows;i>0&&(this._terminal.buffer.lines.trimStart(i),this._terminal.buffer.ybase=Math.max(this._terminal.buffer.ybase-i,0),this._terminal.buffer.ydisp=Math.max(this._terminal.buffer.ydisp-i,0),this._terminal.emit("scroll",0))}},s.prototype.eraseInLine=function(t){switch(t[0]){case 0:this._terminal.eraseRight(this._terminal.buffer.x,this._terminal.buffer.y);break;case 1:this._terminal.eraseLeft(this._terminal.buffer.x,this._terminal.buffer.y);break;case 2:this._terminal.eraseLine(this._terminal.buffer.y)}},s.prototype.insertLines=function(t){var e=t[0];e<1&&(e=1);for(var i=this._terminal.buffer,r=i.y+i.ybase,s=this._terminal.rows-1-i.scrollBottom,a=this._terminal.rows-1+i.ybase-s+1;e--;)i.lines.splice(a-1,1),i.lines.splice(r,0,this._terminal.blankLine(!0));this._terminal.updateRange(i.y),this._terminal.updateRange(i.scrollBottom)},s.prototype.deleteLines=function(t){var e=t[0];e<1&&(e=1);var i,r=this._terminal.buffer,s=r.y+r.ybase;for(i=this._terminal.rows-1-r.scrollBottom,i=this._terminal.rows-1+r.ybase-i;e--;)r.lines.splice(s,1),r.lines.splice(i,0,this._terminal.blankLine(!0));this._terminal.updateRange(r.y),this._terminal.updateRange(r.scrollBottom)},s.prototype.deleteChars=function(t){var e=t[0];e<1&&(e=1);for(var i=this._terminal.buffer,r=i.y+i.ybase,s=[this._terminal.eraseAttr()," ",1,32];e--;)i.lines.get(r).splice(i.x,1),i.lines.get(r).push(s);this._terminal.updateRange(i.y)},s.prototype.scrollUp=function(t){for(var e=t[0]||1,i=this._terminal.buffer;e--;)i.lines.splice(i.ybase+i.scrollTop,1),i.lines.splice(i.ybase+i.scrollBottom,0,this._terminal.blankLine());this._terminal.updateRange(i.scrollTop),this._terminal.updateRange(i.scrollBottom)},s.prototype.scrollDown=function(t){for(var e=t[0]||1,i=this._terminal.buffer;e--;)i.lines.splice(i.ybase+i.scrollBottom,1),i.lines.splice(i.ybase+i.scrollTop,0,this._terminal.blankLine());this._terminal.updateRange(i.scrollTop),this._terminal.updateRange(i.scrollBottom)},s.prototype.eraseChars=function(t){var e=t[0];e<1&&(e=1);for(var i=this._terminal.buffer,r=i.y+i.ybase,s=i.x,a=[this._terminal.eraseAttr()," ",1,32];e--&&s<this._terminal.cols;)i.lines.get(r)[s++]=a},s.prototype.cursorBackwardTab=function(t){for(var e=t[0]||1,i=this._terminal.buffer;e--;)i.x=i.prevStop()},s.prototype.charPosAbsolute=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.x=e-1,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},s.prototype.HPositionRelative=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.x+=e,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},s.prototype.repeatPrecedingCharacter=function(t){for(var e=t[0]||1,i=this._terminal.buffer,r=i.lines.get(i.ybase+i.y),s=r[i.x-1]||[this._terminal.defAttr," ",1,32];e--;)r[i.x++]=s},s.prototype.sendDeviceAttributes=function(e){e[0]>0||(this._terminal.prefix?">"===this._terminal.prefix&&(this._terminal.is("xterm")?this._terminal.send(t.C0.ESC+"[>0;276;0c"):this._terminal.is("rxvt-unicode")?this._terminal.send(t.C0.ESC+"[>85;95;0c"):this._terminal.is("linux")?this._terminal.send(e[0]+"c"):this._terminal.is("screen")&&this._terminal.send(t.C0.ESC+"[>83;40003;0c")):this._terminal.is("xterm")||this._terminal.is("rxvt-unicode")||this._terminal.is("screen")?this._terminal.send(t.C0.ESC+"[?1;2c"):this._terminal.is("linux")&&this._terminal.send(t.C0.ESC+"[?6c"))},s.prototype.linePosAbsolute=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y=e-1,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1)},s.prototype.VPositionRelative=function(t){var e=t[0];e<1&&(e=1),this._terminal.buffer.y+=e,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--},s.prototype.HVPosition=function(t){t[0]<1&&(t[0]=1),t[1]<1&&(t[1]=1),this._terminal.buffer.y=t[0]-1,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x=t[1]-1,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},s.prototype.tabClear=function(t){var e=t[0];e<=0?delete this._terminal.buffer.tabs[this._terminal.buffer.x]:3===e&&(this._terminal.buffer.tabs={})},s.prototype.setMode=function(t){if(t.length>1)for(var i=0;i<t.length;i++)this.setMode([t[i]]);else if(this._terminal.prefix){if("?"===this._terminal.prefix)switch(t[0]){case 1:this._terminal.applicationCursor=!0;break;case 2:this._terminal.setgCharset(0,e.DEFAULT_CHARSET),this._terminal.setgCharset(1,e.DEFAULT_CHARSET),this._terminal.setgCharset(2,e.DEFAULT_CHARSET),this._terminal.setgCharset(3,e.DEFAULT_CHARSET);break;case 3:this._terminal.savedCols=this._terminal.cols,this._terminal.resize(132,this._terminal.rows);break;case 6:this._terminal.originMode=!0;break;case 7:this._terminal.wraparoundMode=!0;break;case 12:break;case 66:this._terminal.log("Serial port requested application keypad."),this._terminal.applicationKeypad=!0,this._terminal.viewport.syncScrollArea();break;case 9:case 1e3:case 1002:case 1003:this._terminal.x10Mouse=9===t[0],this._terminal.vt200Mouse=1e3===t[0],this._terminal.normalMouse=t[0]>1e3,this._terminal.mouseEvents=!0,this._terminal.element.classList.add("enable-mouse-events"),this._terminal.selectionManager.disable(),this._terminal.log("Binding to mouse events.");break;case 1004:this._terminal.sendFocus=!0;break;case 1005:this._terminal.utfMouse=!0;break;case 1006:this._terminal.sgrMouse=!0;break;case 1015:this._terminal.urxvtMouse=!0;break;case 25:this._terminal.cursorHidden=!1;break;case 1049:case 47:case 1047:this._terminal.buffers.activateAltBuffer(),this._terminal.viewport.syncScrollArea(),this._terminal.showCursor();break;case 2004:this._terminal.bracketedPasteMode=!0}}else switch(t[0]){case 4:this._terminal.insertMode=!0}},s.prototype.resetMode=function(t){if(t.length>1)for(var e=0;e<t.length;e++)this.resetMode([t[e]]);else if(this._terminal.prefix){if("?"===this._terminal.prefix)switch(t[0]){case 1:this._terminal.applicationCursor=!1;break;case 3:132===this._terminal.cols&&this._terminal.savedCols&&this._terminal.resize(this._terminal.savedCols,this._terminal.rows),delete this._terminal.savedCols;break;case 6:this._terminal.originMode=!1;break;case 7:this._terminal.wraparoundMode=!1;break;case 12:break;case 66:this._terminal.log("Switching back to normal keypad."),this._terminal.applicationKeypad=!1,this._terminal.viewport.syncScrollArea();break;case 9:case 1e3:case 1002:case 1003:this._terminal.x10Mouse=!1,this._terminal.vt200Mouse=!1,this._terminal.normalMouse=!1,this._terminal.mouseEvents=!1,this._terminal.element.classList.remove("enable-mouse-events"),this._terminal.selectionManager.enable();break;case 1004:this._terminal.sendFocus=!1;break;case 1005:this._terminal.utfMouse=!1;break;case 1006:this._terminal.sgrMouse=!1;break;case 1015:this._terminal.urxvtMouse=!1;break;case 25:this._terminal.cursorHidden=!0;break;case 1049:case 47:case 1047:this._terminal.buffers.activateNormalBuffer(),this._terminal.refresh(0,this._terminal.rows-1),this._terminal.viewport.syncScrollArea(),this._terminal.showCursor();break;case 2004:this._terminal.bracketedPasteMode=!1}}else switch(t[0]){case 4:this._terminal.insertMode=!1}},s.prototype.charAttributes=function(t){if(1!==t.length||0!==t[0]){for(var e,i=t.length,r=this._terminal.curAttr>>18,s=this._terminal.curAttr>>9&511,a=511&this._terminal.curAttr,n=0;n<i;n++)(e=t[n])>=30&&e<=37?s=e-30:e>=40&&e<=47?a=e-40:e>=90&&e<=97?s=(e+=8)-90:e>=100&&e<=107?a=(e+=8)-100:0===e?(r=this._terminal.defAttr>>18,s=this._terminal.defAttr>>9&511,a=511&this._terminal.defAttr):1===e?r|=1:3===e?r|=64:4===e?r|=2:5===e?r|=4:7===e?r|=8:8===e?r|=16:2===e?r|=32:22===e?(r&=-2,r&=-33):24===e?r&=-3:25===e?r&=-5:27===e?r&=-9:28===e?r&=-17:39===e?s=this._terminal.defAttr>>9&511:49===e?a=511&this._terminal.defAttr:38===e?2===t[n+1]?(n+=2,-1===(s=this._terminal.matchColor(255&t[n],255&t[n+1],255&t[n+2]))&&(s=511),n+=2):5===t[n+1]&&(s=e=255&t[n+=2]):48===e?2===t[n+1]?(n+=2,-1===(a=this._terminal.matchColor(255&t[n],255&t[n+1],255&t[n+2]))&&(a=511),n+=2):5===t[n+1]&&(a=e=255&t[n+=2]):100===e?(s=this._terminal.defAttr>>9&511,a=511&this._terminal.defAttr):this._terminal.error("Unknown SGR attribute: %d.",e);this._terminal.curAttr=r<<18|s<<9|a}else this._terminal.curAttr=this._terminal.defAttr},s.prototype.deviceStatus=function(e){if(this._terminal.prefix){if("?"===this._terminal.prefix)switch(e[0]){case 6:this._terminal.send(t.C0.ESC+"[?"+(this._terminal.buffer.y+1)+";"+(this._terminal.buffer.x+1)+"R")}}else switch(e[0]){case 5:this._terminal.send(t.C0.ESC+"[0n");break;case 6:this._terminal.send(t.C0.ESC+"["+(this._terminal.buffer.y+1)+";"+(this._terminal.buffer.x+1)+"R")}},s.prototype.softReset=function(t){this._terminal.cursorHidden=!1,this._terminal.insertMode=!1,this._terminal.originMode=!1,this._terminal.wraparoundMode=!0,this._terminal.applicationKeypad=!1,this._terminal.viewport.syncScrollArea(),this._terminal.applicationCursor=!1,this._terminal.buffer.scrollTop=0,this._terminal.buffer.scrollBottom=this._terminal.rows-1,this._terminal.curAttr=this._terminal.defAttr,this._terminal.buffer.x=this._terminal.buffer.y=0,this._terminal.charset=null,this._terminal.glevel=0,this._terminal.charsets=[null]},s.prototype.setCursorStyle=function(t){var e=t[0]<1?1:t[0];switch(e){case 1:case 2:this._terminal.setOption("cursorStyle","block");break;case 3:case 4:this._terminal.setOption("cursorStyle","underline");break;case 5:case 6:this._terminal.setOption("cursorStyle","bar")}var i=e%2==1;this._terminal.setOption("cursorBlink",i)},s.prototype.setScrollRegion=function(t){this._terminal.prefix||(this._terminal.buffer.scrollTop=(t[0]||1)-1,this._terminal.buffer.scrollBottom=(t[1]&&t[1]<=this._terminal.rows?t[1]:this._terminal.rows)-1,this._terminal.buffer.x=0,this._terminal.buffer.y=0)},s.prototype.saveCursor=function(t){this._terminal.buffer.savedX=this._terminal.buffer.x,this._terminal.buffer.savedY=this._terminal.buffer.y},s.prototype.restoreCursor=function(t){this._terminal.buffer.x=this._terminal.buffer.savedX||0,this._terminal.buffer.y=this._terminal.buffer.savedY||0},s}();exports.InputHandler=s;
},{"./EscapeSequences":21,"./Charsets":142,"./Buffer":17,"./CharWidth":143}],23:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./EscapeSequences"),e=require("./Charsets"),r={};r[t.C0.BEL]=function(t,e){return e.bell()},r[t.C0.LF]=function(t,e){return e.lineFeed()},r[t.C0.VT]=r[t.C0.LF],r[t.C0.FF]=r[t.C0.LF],r[t.C0.CR]=function(t,e){return e.carriageReturn()},r[t.C0.BS]=function(t,e){return e.backspace()},r[t.C0.HT]=function(t,e){return e.tab()},r[t.C0.SO]=function(t,e){return e.shiftOut()},r[t.C0.SI]=function(t,e){return e.shiftIn()},r[t.C0.ESC]=function(t,e){return t.setState(1)};var i={"[":function(t,e){e.params=[],e.currentParam=0,t.setState(2)},"]":function(t,e){e.params=[],e.currentParam=0,t.setState(4)},P:function(t,e){e.params=[],e.currentParam=0,t.setState(6)},_:function(t,e){t.setState(7)},"^":function(t,e){t.setState(7)},c:function(t,e){e.reset()},E:function(t,e){e.buffer.x=0,e.index(),t.setState(0)},D:function(t,e){e.index(),t.setState(0)},M:function(t,e){e.reverseIndex(),t.setState(0)},"%":function(t,r){r.setgLevel(0),r.setgCharset(0,e.DEFAULT_CHARSET),t.setState(0),t.skipNextChar()}};i[t.C0.CAN]=function(t){return t.setState(0)};var n={"?":function(t){return t.setPrefix("?")},">":function(t){return t.setPrefix(">")},"!":function(t){return t.setPrefix("!")},0:function(t){return t.setParam(10*t.getParam())},1:function(t){return t.setParam(10*t.getParam()+1)},2:function(t){return t.setParam(10*t.getParam()+2)},3:function(t){return t.setParam(10*t.getParam()+3)},4:function(t){return t.setParam(10*t.getParam()+4)},5:function(t){return t.setParam(10*t.getParam()+5)},6:function(t){return t.setParam(10*t.getParam()+6)},7:function(t){return t.setParam(10*t.getParam()+7)},8:function(t){return t.setParam(10*t.getParam()+8)},9:function(t){return t.setParam(10*t.getParam()+9)},$:function(t){return t.setPostfix("$")},'"':function(t){return t.setPostfix('"')}," ":function(t){return t.setPostfix(" ")},"'":function(t){return t.setPostfix("'")},";":function(t){return t.finalizeParam()}};n[t.C0.CAN]=function(t){return t.setState(0)};var a={"@":function(t,e,r){return t.insertChars(e)},A:function(t,e,r){return t.cursorUp(e)},B:function(t,e,r){return t.cursorDown(e)},C:function(t,e,r){return t.cursorForward(e)},D:function(t,e,r){return t.cursorBackward(e)},E:function(t,e,r){return t.cursorNextLine(e)},F:function(t,e,r){return t.cursorPrecedingLine(e)},G:function(t,e,r){return t.cursorCharAbsolute(e)},H:function(t,e,r){return t.cursorPosition(e)},I:function(t,e,r){return t.cursorForwardTab(e)},J:function(t,e,r){return t.eraseInDisplay(e)},K:function(t,e,r){return t.eraseInLine(e)},L:function(t,e,r){return t.insertLines(e)},M:function(t,e,r){return t.deleteLines(e)},P:function(t,e,r){return t.deleteChars(e)},S:function(t,e,r){return t.scrollUp(e)},T:function(t,e,r){e.length<2&&!r&&t.scrollDown(e)},X:function(t,e,r){return t.eraseChars(e)},Z:function(t,e,r){return t.cursorBackwardTab(e)},"`":function(t,e,r){return t.charPosAbsolute(e)},a:function(t,e,r){return t.HPositionRelative(e)},b:function(t,e,r){return t.repeatPrecedingCharacter(e)},c:function(t,e,r){return t.sendDeviceAttributes(e)},d:function(t,e,r){return t.linePosAbsolute(e)},e:function(t,e,r){return t.VPositionRelative(e)},f:function(t,e,r){return t.HVPosition(e)},g:function(t,e,r){return t.tabClear(e)},h:function(t,e,r){return t.setMode(e)},l:function(t,e,r){return t.resetMode(e)},m:function(t,e,r){return t.charAttributes(e)},n:function(t,e,r){return t.deviceStatus(e)},p:function(t,e,r){switch(r){case"!":t.softReset(e)}},q:function(t,e,r,i){" "===i&&t.setCursorStyle(e)},r:function(t,e){return t.setScrollRegion(e)},s:function(t,e){return t.saveCursor(e)},u:function(t,e){return t.restoreCursor(e)}};a[t.C0.CAN]=function(t,e,r,i,n){return n.setState(0)};var s=function(){function s(t,e){this._inputHandler=t,this._terminal=e,this._state=0}return s.prototype.parse=function(s){var u,o,c,h,l=s.length,m=this._terminal.buffer.x,_=this._terminal.buffer.y;for(this._terminal.debug&&this._terminal.log("data: "+s),this._position=0,this._terminal.surrogate_high&&(s=this._terminal.surrogate_high+s,this._terminal.surrogate_high="");this._position<l;this._position++){if(o=s[this._position],55296<=(c=s.charCodeAt(this._position))&&c<=56319){if(h=s.charCodeAt(this._position+1),isNaN(h)){this._terminal.surrogate_high=o;continue}c=1024*(c-55296)+(h-56320)+65536,o+=s.charAt(this._position+1)}if(!(56320<=c&&c<=57343))switch(this._state){case 0:o in r?r[o](this,this._inputHandler):this._inputHandler.addChar(o,c);break;case 1:if(o in i){i[o](this,this._terminal);break}switch(o){case"(":case")":case"*":case"+":case"-":case".":switch(o){case"(":this._terminal.gcharset=0;break;case")":this._terminal.gcharset=1;break;case"*":this._terminal.gcharset=2;break;case"+":this._terminal.gcharset=3;break;case"-":this._terminal.gcharset=1;break;case".":this._terminal.gcharset=2}this._state=5;break;case"/":this._terminal.gcharset=3,this._state=5,this._position--;break;case"N":case"O":this._state=0;break;case"n":this._terminal.setgLevel(2),this._state=0;break;case"o":case"|":this._terminal.setgLevel(3),this._state=0;break;case"}":this._terminal.setgLevel(2),this._state=0;break;case"~":this._terminal.setgLevel(1),this._state=0;break;case"7":this._inputHandler.saveCursor(),this._state=0;break;case"8":this._inputHandler.restoreCursor(),this._state=0;break;case"#":this._state=0,this._position++;break;case"H":this._terminal.tabSet(),this._state=0;break;case"=":this._terminal.log("Serial port requested application keypad."),this._terminal.applicationKeypad=!0,this._terminal.viewport&&this._terminal.viewport.syncScrollArea(),this._state=0;break;case">":this._terminal.log("Switching back to normal keypad."),this._terminal.applicationKeypad=!1,this._terminal.viewport&&this._terminal.viewport.syncScrollArea(),this._state=0;break;default:this._state=0,this._terminal.error("Unknown ESC control: %s.",o)}break;case 5:o in e.CHARSETS?(u=e.CHARSETS[o],"/"===o&&this.skipNextChar()):u=e.DEFAULT_CHARSET,this._terminal.setgCharset(this._terminal.gcharset,u),this._terminal.gcharset=null,this._state=0;break;case 4:if(o===t.C0.ESC||o===t.C0.BEL){switch(o===t.C0.ESC&&this._position++,this._terminal.params.push(this._terminal.currentParam),this._terminal.params[0]){case 0:case 1:case 2:this._terminal.params[1]&&(this._terminal.title=this._terminal.params[1],this._terminal.handleTitle(this._terminal.title))}this._terminal.params=[],this._terminal.currentParam=0,this._state=0}else this._terminal.params.length?this._terminal.currentParam+=o:o>="0"&&o<="9"?this._terminal.currentParam=10*this._terminal.currentParam+o.charCodeAt(0)-48:";"===o&&(this._terminal.params.push(this._terminal.currentParam),this._terminal.currentParam="");break;case 2:if(o in n){n[o](this);break}this.finalizeParam(),this._state=3;case 3:o in a?(this._terminal.debug&&this._terminal.log("CSI "+(this._terminal.prefix?this._terminal.prefix:"")+" "+(this._terminal.params?this._terminal.params.join(";"):"")+" "+(this._terminal.postfix?this._terminal.postfix:"")+" "+o),a[o](this._inputHandler,this._terminal.params,this._terminal.prefix,this._terminal.postfix,this)):this._terminal.error("Unknown CSI code: %s.",o),this._state=0,this._terminal.prefix="",this._terminal.postfix="";break;case 6:if(o===t.C0.ESC||o===t.C0.BEL){o===t.C0.ESC&&this._position++;var f=void 0,p=void 0;switch(this._terminal.prefix){case"":break;case"$q":switch(p=!1,f=this._terminal.currentParam){case'"q':f='0"q';break;case'"p':f='61"p';break;case"r":f=this._terminal.buffer.scrollTop+1+";"+(this._terminal.buffer.scrollBottom+1)+"r";break;case"m":f="0m";break;default:this._terminal.error("Unknown DCS Pt: %s.",f),f=""}this._terminal.send(t.C0.ESC+"P"+ +p+"$r"+f+t.C0.ESC+"\\");break;case"+p":break;case"+q":f=this._terminal.currentParam,p=!1,this._terminal.send(t.C0.ESC+"P"+ +p+"+r"+f+t.C0.ESC+"\\");break;default:this._terminal.error("Unknown DCS prefix: %s.",this._terminal.prefix)}this._terminal.currentParam=0,this._terminal.prefix="",this._state=0}else this._terminal.currentParam?this._terminal.currentParam+=o:this._terminal.prefix||"$"===o||"+"===o?2===this._terminal.prefix.length?this._terminal.currentParam=o:this._terminal.prefix+=o:this._terminal.currentParam=o;break;case 7:o!==t.C0.ESC&&o!==t.C0.BEL||(o===t.C0.ESC&&this._position++,this._state=0)}}return this._terminal.buffer.x===m&&this._terminal.buffer.y===_||this._terminal.emit("cursormove"),this._state},s.prototype.setState=function(t){this._state=t},s.prototype.setPrefix=function(t){this._terminal.prefix=t},s.prototype.setPostfix=function(t){this._terminal.postfix=t},s.prototype.setParam=function(t){this._terminal.currentParam=t},s.prototype.getParam=function(){return this._terminal.currentParam},s.prototype.finalizeParam=function(){this._terminal.params.push(this._terminal.currentParam),this._terminal.currentParam=0},s.prototype.skipNextChar=function(){this._position++},s}();exports.Parser=s;
},{"./EscapeSequences":21,"./Charsets":142}],171:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.INVERTED_DEFAULT_COLOR=-1,exports.DIM_OPACITY=.5;
},{}],169:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=function(){function e(){this.cache=[]}return e.prototype.resize=function(e,t){for(var h=0;h<e;h++){this.cache.length<=h&&this.cache.push([]);for(var c=this.cache[h].length;c<t;c++)this.cache[h].push(null);this.cache[h].length=t}this.cache.length=e},e.prototype.clear=function(){for(var e=0;e<this.cache.length;e++)for(var t=0;t<this.cache[e].length;t++)this.cache[e][t]=null},e}();exports.GridCache=e;
},{}],162:[function(require,module,exports) {
"use strict";function o(o,e,n,t){var r={foreground:t.foreground,background:t.background,cursor:null,cursorAccent:null,selection:null,ansi:t.ansi.slice(0,16)};return{type:n.options.experimentalCharAtlas,devicePixelRatio:window.devicePixelRatio,scaledCharWidth:o,scaledCharHeight:e,fontFamily:n.options.fontFamily,fontSize:n.options.fontSize,fontWeight:n.options.fontWeight,fontWeightBold:n.options.fontWeightBold,allowTransparency:n.options.allowTransparency,colors:r}}function e(o,e){for(var n=0;n<o.colors.ansi.length;n++)if(o.colors.ansi[n].rgba!==e.colors.ansi[n].rgba)return!1;return o.type===e.type&&o.devicePixelRatio===e.devicePixelRatio&&o.fontFamily===e.fontFamily&&o.fontSize===e.fontSize&&o.fontWeight===e.fontWeight&&o.fontWeightBold===e.fontWeightBold&&o.allowTransparency===e.allowTransparency&&o.scaledCharWidth===e.scaledCharWidth&&o.scaledCharHeight===e.scaledCharHeight&&o.colors.foreground===e.colors.foreground&&o.colors.background===e.colors.background}Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateConfig=o,exports.configEquals=e;
},{}],172:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(){function t(){this._didWarmUp=!1}return t.prototype.warmUp=function(){this._didWarmUp||(this._doWarmUp(),this._didWarmUp=!0)},t.prototype._doWarmUp=function(){},t.prototype.beginFrame=function(){},t}();exports.default=t;
},{}],35:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var s=i("#ffffff"),r=i("#000000"),o=i("#ffffff"),t=i("#000000"),e={css:"rgba(255, 255, 255, 0.3)",rgba:4294967159};function i(s){return{css:s,rgba:parseInt(s.slice(1),16)<<8|255}}function a(s){var r=s.toString(16);return r.length<2?"0"+r:r}exports.DEFAULT_ANSI_COLORS=function(){for(var s=[i("#2e3436"),i("#cc0000"),i("#4e9a06"),i("#c4a000"),i("#3465a4"),i("#75507b"),i("#06989a"),i("#d3d7cf"),i("#555753"),i("#ef2929"),i("#8ae234"),i("#fce94f"),i("#729fcf"),i("#ad7fa8"),i("#34e2e2"),i("#eeeeec")],r=[0,95,135,175,215,255],o=0;o<216;o++){var t=r[o/36%6|0],e=r[o/6%6|0],l=r[o%6];s.push({css:"#"+a(t)+a(e)+a(l),rgba:(t<<24|e<<16|l<<8|255)>>>0})}for(o=0;o<24;o++){var c=8+10*o,n=a(c);s.push({css:"#"+n+n+n,rgba:(c<<24|c<<16|c<<8|255)>>>0})}return s}();var l=function(){function i(i,a){this.allowTransparency=a;var l=i.createElement("canvas");l.width=1,l.height=1,this._ctx=l.getContext("2d"),this._ctx.globalCompositeOperation="copy",this._litmusColor=this._ctx.createLinearGradient(0,0,1,1),this.colors={foreground:s,background:r,cursor:o,cursorAccent:t,selection:e,ansi:exports.DEFAULT_ANSI_COLORS.slice()}}return i.prototype.setTheme=function(i){this.colors.foreground=this._parseColor(i.foreground,s),this.colors.background=this._parseColor(i.background,r),this.colors.cursor=this._parseColor(i.cursor,o,!0),this.colors.cursorAccent=this._parseColor(i.cursorAccent,t,!0),this.colors.selection=this._parseColor(i.selection,e,!0),this.colors.ansi[0]=this._parseColor(i.black,exports.DEFAULT_ANSI_COLORS[0]),this.colors.ansi[1]=this._parseColor(i.red,exports.DEFAULT_ANSI_COLORS[1]),this.colors.ansi[2]=this._parseColor(i.green,exports.DEFAULT_ANSI_COLORS[2]),this.colors.ansi[3]=this._parseColor(i.yellow,exports.DEFAULT_ANSI_COLORS[3]),this.colors.ansi[4]=this._parseColor(i.blue,exports.DEFAULT_ANSI_COLORS[4]),this.colors.ansi[5]=this._parseColor(i.magenta,exports.DEFAULT_ANSI_COLORS[5]),this.colors.ansi[6]=this._parseColor(i.cyan,exports.DEFAULT_ANSI_COLORS[6]),this.colors.ansi[7]=this._parseColor(i.white,exports.DEFAULT_ANSI_COLORS[7]),this.colors.ansi[8]=this._parseColor(i.brightBlack,exports.DEFAULT_ANSI_COLORS[8]),this.colors.ansi[9]=this._parseColor(i.brightRed,exports.DEFAULT_ANSI_COLORS[9]),this.colors.ansi[10]=this._parseColor(i.brightGreen,exports.DEFAULT_ANSI_COLORS[10]),this.colors.ansi[11]=this._parseColor(i.brightYellow,exports.DEFAULT_ANSI_COLORS[11]),this.colors.ansi[12]=this._parseColor(i.brightBlue,exports.DEFAULT_ANSI_COLORS[12]),this.colors.ansi[13]=this._parseColor(i.brightMagenta,exports.DEFAULT_ANSI_COLORS[13]),this.colors.ansi[14]=this._parseColor(i.brightCyan,exports.DEFAULT_ANSI_COLORS[14]),this.colors.ansi[15]=this._parseColor(i.brightWhite,exports.DEFAULT_ANSI_COLORS[15])},i.prototype._parseColor=function(s,r,o){if(void 0===o&&(o=this.allowTransparency),!s)return r;if(this._ctx.fillStyle=this._litmusColor,this._ctx.fillStyle=s,"string"!=typeof this._ctx.fillStyle)return console.warn("Color: "+s+" is invalid using fallback "+r.css),r;this._ctx.fillRect(0,0,1,1);var t=this._ctx.getImageData(0,0,1,1).data;return o||255===t[3]?{css:s,rgba:(t[0]<<24|t[1]<<16|t[2]<<8|t[3])>>>0}:(console.warn("Color: "+s+" is using transparency, but allowTransparency is false. Using fallback "+r.css+"."),r)},i}();exports.ColorManager=l;
},{}],175:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CHAR_ATLAS_CELL_SPACING=1;
},{}],48:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e="undefined"==typeof navigator,i=e?"node":navigator.userAgent,n=e?"node":navigator.platform;function o(e,i){return e.indexOf(i)>=0}exports.isFirefox=!!~i.indexOf("Firefox"),exports.isMSIE=!!~i.indexOf("MSIE")||!!~i.indexOf("Trident"),exports.isMac=o(["Macintosh","MacIntel","MacPPC","Mac68K"],n),exports.isIpad="iPad"===n,exports.isIphone="iPhone"===n,exports.isMSWindows=o(["Windows","Win16","Win32","WinCE"],n),exports.isLinux=n.indexOf("Linux")>=0;
},{}],173:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./Types"),t=require("../utils/Browser");function r(r,i,n){var l=n.scaledCharWidth+e.CHAR_ATLAS_CELL_SPACING,s=n.scaledCharHeight+e.CHAR_ATLAS_CELL_SPACING,f=i(255*l,34*s),c=f.getContext("2d",{alpha:n.allowTransparency});c.fillStyle=n.colors.background.css,c.fillRect(0,0,f.width,f.height),c.save(),c.fillStyle=n.colors.foreground.css,c.font=o(n.fontWeight,n),c.textBaseline="top";for(var g=0;g<256;g++)c.save(),c.beginPath(),c.rect(g*l,0,l,s),c.clip(),c.fillText(String.fromCharCode(g),g*l,0),c.restore();c.save(),c.font=o(n.fontWeightBold,n);for(g=0;g<256;g++)c.save(),c.beginPath(),c.rect(g*l,s,l,s),c.clip(),c.fillText(String.fromCharCode(g),g*l,s),c.restore();c.restore(),c.font=o(n.fontWeight,n);for(var h=0;h<16;h++){var d=(h+2)*s;for(g=0;g<256;g++)c.save(),c.beginPath(),c.rect(g*l,d,l,s),c.clip(),c.fillStyle=n.colors.ansi[h].css,c.fillText(String.fromCharCode(g),g*l,d),c.restore()}c.font=o(n.fontWeightBold,n);for(h=0;h<16;h++)for(d=(h+2+16)*s,g=0;g<256;g++)c.save(),c.beginPath(),c.rect(g*l,d,l,s),c.clip(),c.fillStyle=n.colors.ansi[h].css,c.fillText(String.fromCharCode(g),g*l,d),c.restore();if(c.restore(),!("createImageBitmap"in r)||t.isFirefox)return f instanceof HTMLCanvasElement?f:new Promise(function(e){return e(f.transferToImageBitmap())});var C=c.getImageData(0,0,f.width,f.height);return a(C,n.colors.background),r.createImageBitmap(C)}function a(e,t){for(var r=!0,a=t.rgba>>>24,o=t.rgba>>>16&255,i=t.rgba>>>8&255,n=0;n<e.data.length;n+=4)e.data[n]===a&&e.data[n+1]===o&&e.data[n+2]===i?e.data[n+3]=0:r=!1;return r}function o(e,t){return e+" "+t.fontSize*t.devicePixelRatio+"px "+t.fontFamily}exports.generateStaticCharAtlasTexture=r,exports.clearColor=a;
},{"./Types":175,"../utils/Browser":48}],174:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=function(){function e(e){this.capacity=e,this._map={},this._head=null,this._tail=null,this._nodePool=[],this.size=0}return e.prototype._unlinkNode=function(e){var t=e.prev,i=e.next;e===this._head&&(this._head=i),e===this._tail&&(this._tail=t),null!==t&&(t.next=i),null!==i&&(i.prev=t)},e.prototype._appendNode=function(e){var t=this._tail;null!==t&&(t.next=e),e.prev=t,e.next=null,this._tail=e,null===this._head&&(this._head=e)},e.prototype.prealloc=function(e){for(var t=this._nodePool,i=0;i<e;i++)t.push({prev:null,next:null,key:null,value:null})},e.prototype.get=function(e){var t=this._map[e];return void 0!==t?(this._unlinkNode(t),this._appendNode(t),t.value):null},e.prototype.peek=function(){var e=this._head;return null===e?null:e.value},e.prototype.set=function(e,t){var i=this._map[e];if(void 0!==i)i=this._map[e],this._unlinkNode(i),i.value=t;else if(this.size>=this.capacity)i=this._head,this._unlinkNode(i),delete this._map[i.key],i.key=e,i.value=t,this._map[e]=i;else{var l=this._nodePool;l.length>0?((i=l.pop()).key=e,i.value=t):i={prev:null,next:null,key:e,value:t},this._map[e]=i,this.size++}this._appendNode(i)},e}();exports.default=e;
},{}],163:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./Types"),o=require("./BaseCharAtlas"),i=require("../ColorManager"),a=require("../../shared/atlas/CharAtlasGenerator"),r=require("./LRUMap"),c=1024,h=1024,n={css:"rgba(0, 0, 0, 0)",rgba:0},s=100;function _(t){var e=(t.bold?0:4)+(t.dim?0:2)+(t.italic?0:1);return t.bg+"_"+t.fg+"_"+e+t.char}var l=function(o){function l(t,e){var i=o.call(this)||this;i._config=e,i._drawToCacheCount=0,i._cacheCanvas=t.createElement("canvas"),i._cacheCanvas.width=c,i._cacheCanvas.height=h,i._cacheCtx=i._cacheCanvas.getContext("2d",{alpha:!0});var a=t.createElement("canvas");a.width=i._config.scaledCharWidth,a.height=i._config.scaledCharHeight,i._tmpCtx=a.getContext("2d",{alpha:i._config.allowTransparency}),i._width=Math.floor(c/i._config.scaledCharWidth),i._height=Math.floor(h/i._config.scaledCharHeight);var n=i._width*i._height;return i._cacheMap=new r.default(n),i._cacheMap.prealloc(n),i}return t(l,o),l.prototype.beginFrame=function(){this._drawToCacheCount=0},l.prototype.draw=function(t,e,o,i){var a=_(e),r=this._cacheMap.get(a);if(null!=r)return this._drawFromCache(t,r,o,i),!0;if(this._canCache(e)&&this._drawToCacheCount<s){var c=void 0;c=this._cacheMap.size<this._cacheMap.capacity?this._cacheMap.size:this._cacheMap.peek().index;var h=this._drawToCache(e,c);return this._cacheMap.set(a,h),this._drawFromCache(t,h,o,i),!0}return!1},l.prototype._canCache=function(t){return t.code<256},l.prototype._toCoordinates=function(t){return[t%this._width*this._config.scaledCharWidth,Math.floor(t/this._width)*this._config.scaledCharHeight]},l.prototype._drawFromCache=function(t,e,o,i){if(!e.isEmpty){var a=this._toCoordinates(e.index),r=a[0],c=a[1];t.drawImage(this._cacheCanvas,r,c,this._config.scaledCharWidth,this._config.scaledCharHeight,o,i,this._config.scaledCharWidth,this._config.scaledCharHeight)}},l.prototype._getColorFromAnsiIndex=function(t){return t<this._config.colors.ansi.length?this._config.colors.ansi[t]:i.DEFAULT_ANSI_COLORS[t]},l.prototype._getBackgroundColor=function(t){return this._config.allowTransparency?n:t.bg===e.INVERTED_DEFAULT_COLOR?this._config.colors.foreground:t.bg<256?this._getColorFromAnsiIndex(t.bg):this._config.colors.background},l.prototype._getForegroundColor=function(t){return t.fg===e.INVERTED_DEFAULT_COLOR?this._config.colors.background:t.fg<256?this._getColorFromAnsiIndex(t.fg):this._config.colors.foreground},l.prototype._drawToCache=function(t,o){this._drawToCacheCount++,this._tmpCtx.save();var i=this._getBackgroundColor(t);this._tmpCtx.globalCompositeOperation="copy",this._tmpCtx.fillStyle=i.css,this._tmpCtx.fillRect(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),this._tmpCtx.globalCompositeOperation="source-over";var r=t.bold?this._config.fontWeightBold:this._config.fontWeight,c=t.italic?"italic":"";this._tmpCtx.font=c+" "+r+" "+this._config.fontSize*this._config.devicePixelRatio+"px "+this._config.fontFamily,this._tmpCtx.textBaseline="top",this._tmpCtx.fillStyle=this._getForegroundColor(t).css,t.dim&&(this._tmpCtx.globalAlpha=e.DIM_OPACITY),this._tmpCtx.fillText(t.char,0,0),this._tmpCtx.restore();var h=this._tmpCtx.getImageData(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),n=!1;this._config.allowTransparency||(n=a.clearColor(h,i));var s=this._toCoordinates(o),_=s[0],l=s[1];return this._cacheCtx.putImageData(h,_,l),{index:o,isEmpty:n}},l}(o.default);exports.default=l;
},{"./Types":171,"./BaseCharAtlas":172,"../ColorManager":35,"../../shared/atlas/CharAtlasGenerator":173,"./LRUMap":174}],164:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e])};return function(r,e){function o(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var r=require("./BaseCharAtlas"),e=function(r){function e(t,e){return r.call(this)||this}return t(e,r),e.prototype.draw=function(t,r,e,o){return!1},e}(r.default);exports.default=e;
},{"./BaseCharAtlas":172}],165:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./Types"),r=require("../../shared/atlas/Types"),a=require("../../shared/atlas/CharAtlasGenerator"),n=require("./BaseCharAtlas"),o=function(n){function o(t,e){var r=n.call(this)||this;return r._document=t,r._config=e,r._canvasFactory=function(t,e){var a=r._document.createElement("canvas");return a.width=t,a.height=e,a},r}return t(o,n),o.prototype._doWarmUp=function(){var t=this,e=a.generateStaticCharAtlasTexture(window,this._canvasFactory,this._config);e instanceof HTMLCanvasElement?this._texture=e:e.then(function(e){t._texture=e})},o.prototype._isCached=function(t,e){var r=t.code<256,a=t.fg<16,n=t.fg>=256,o=t.bg>=256;return r&&(a||n)&&o&&!t.italic},o.prototype.draw=function(t,a,n,o){if(null==this._texture)return!1;var i=0;if(a.fg<256?i=2+a.fg+(a.bold?16:0):a.bold&&(i=1),!this._isCached(a,i))return!1;t.save();var s=this._config.scaledCharWidth+r.CHAR_ATLAS_CELL_SPACING,c=this._config.scaledCharHeight+r.CHAR_ATLAS_CELL_SPACING;return a.dim&&(t.globalAlpha=e.DIM_OPACITY),t.drawImage(this._texture,a.code*s,i*c,s,this._config.scaledCharHeight,n,o,s,this._config.scaledCharHeight),t.restore(),!0},o}(n.default);exports.default=o;
},{"./Types":171,"../../shared/atlas/Types":175,"../../shared/atlas/CharAtlasGenerator":173,"./BaseCharAtlas":172}],52:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./CharAtlasUtils"),a=require("./DynamicCharAtlas"),r=require("./NoneCharAtlas"),n=require("./StaticCharAtlas"),t={none:r.default,static:n.default,dynamic:a.default},i=[];function o(a,r,n,o){for(var l=e.generateConfig(n,o,a,r),s=0;s<i.length;s++){var f=(u=i[s]).ownedBy.indexOf(a);if(f>=0){if(e.configEquals(u.config,l))return u.atlas;1===u.ownedBy.length?i.splice(s,1):u.ownedBy.splice(f,1);break}}for(s=0;s<i.length;s++){var u=i[s];if(e.configEquals(u.config,l))return u.ownedBy.push(a),u.atlas}var c={atlas:new t[a.options.experimentalCharAtlas](document,l),config:l,ownedBy:[a]};return i.push(c),c.atlas}function l(e){for(var a=0;a<i.length;a++){var r=i[a].ownedBy.indexOf(e);if(-1!==r){1===i[a].ownedBy.length?i.splice(a,1):i[a].ownedBy.splice(r,1);break}}}exports.acquireCharAtlas=o,exports.removeTerminalFromCache=l;
},{"./CharAtlasUtils":162,"./DynamicCharAtlas":163,"./NoneCharAtlas":164,"./StaticCharAtlas":165}],170:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./atlas/Types"),i=require("./atlas/CharAtlasCache"),e=require("../Buffer"),s=function(){function s(t,i,e,s,l){this._container=t,this._alpha=s,this._colors=l,this._scaledCharWidth=0,this._scaledCharHeight=0,this._scaledCellWidth=0,this._scaledCellHeight=0,this._scaledCharLeft=0,this._scaledCharTop=0,this._canvas=document.createElement("canvas"),this._canvas.classList.add("xterm-"+i+"-layer"),this._canvas.style.zIndex=e.toString(),this._initCanvas(),this._container.appendChild(this._canvas)}return s.prototype._initCanvas=function(){this._ctx=this._canvas.getContext("2d",{alpha:this._alpha}),this._alpha||this.clearAll()},s.prototype.onOptionsChanged=function(t){},s.prototype.onBlur=function(t){},s.prototype.onFocus=function(t){},s.prototype.onCursorMove=function(t){},s.prototype.onGridChanged=function(t,i,e){},s.prototype.onSelectionChanged=function(t,i,e){},s.prototype.onThemeChanged=function(t,i){this._refreshCharAtlas(t,i)},s.prototype.setTransparency=function(t,i){if(i!==this._alpha){var e=this._canvas;this._alpha=i,this._canvas=this._canvas.cloneNode(),this._initCanvas(),this._container.replaceChild(this._canvas,e),this._refreshCharAtlas(t,this._colors),this.onGridChanged(t,0,t.rows-1)}},s.prototype._refreshCharAtlas=function(t,e){this._scaledCharWidth<=0&&this._scaledCharHeight<=0||(this._charAtlas=i.acquireCharAtlas(t,e,this._scaledCharWidth,this._scaledCharHeight),this._charAtlas.warmUp())},s.prototype.resize=function(t,i){this._scaledCellWidth=i.scaledCellWidth,this._scaledCellHeight=i.scaledCellHeight,this._scaledCharWidth=i.scaledCharWidth,this._scaledCharHeight=i.scaledCharHeight,this._scaledCharLeft=i.scaledCharLeft,this._scaledCharTop=i.scaledCharTop,this._canvas.width=i.scaledCanvasWidth,this._canvas.height=i.scaledCanvasHeight,this._canvas.style.width=i.canvasWidth+"px",this._canvas.style.height=i.canvasHeight+"px",this._alpha||this.clearAll(),this._refreshCharAtlas(t,this._colors)},s.prototype.fillCells=function(t,i,e,s){this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight)},s.prototype.fillBottomLineAtCells=function(t,i,e){void 0===e&&(e=1),this._ctx.fillRect(t*this._scaledCellWidth,(i+1)*this._scaledCellHeight-window.devicePixelRatio-1,e*this._scaledCellWidth,window.devicePixelRatio)},s.prototype.fillLeftLineAtCell=function(t,i){this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,window.devicePixelRatio,this._scaledCellHeight)},s.prototype.strokeRectAtCell=function(t,i,e,s){this._ctx.lineWidth=window.devicePixelRatio,this._ctx.strokeRect(t*this._scaledCellWidth+window.devicePixelRatio/2,i*this._scaledCellHeight+window.devicePixelRatio/2,e*this._scaledCellWidth-window.devicePixelRatio,s*this._scaledCellHeight-window.devicePixelRatio)},s.prototype.clearAll=function(){this._alpha?this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height))},s.prototype.clearCells=function(t,i,e,s){this._alpha?this._ctx.clearRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight))},s.prototype.fillCharTrueColor=function(t,i,s,l){this._ctx.font=this._getFont(t,!1,!1),this._ctx.textBaseline="top",this._clipRow(t,l),this._ctx.fillText(i[e.CHAR_DATA_CHAR_INDEX],s*this._scaledCellWidth+this._scaledCharLeft,l*this._scaledCellHeight+this._scaledCharTop)},s.prototype.drawChar=function(t,i,e,s,l,h,a,c,o,n,d){a+=t.options.drawBoldTextInBrightColors&&o&&a<8?8:0,this._charAtlas&&this._charAtlas.draw(this._ctx,{char:i,code:e,bg:c,fg:a,bold:o&&t.options.enableBold,dim:n,italic:d},l*this._scaledCellWidth+this._scaledCharLeft,h*this._scaledCellHeight+this._scaledCharTop)||this._drawUncachedChar(t,i,s,a,l,h,o&&t.options.enableBold,n,d)},s.prototype._drawUncachedChar=function(i,e,s,l,h,a,c,o,n){this._ctx.save(),this._ctx.font=this._getFont(i,c,n),this._ctx.textBaseline="top",l===t.INVERTED_DEFAULT_COLOR?this._ctx.fillStyle=this._colors.background.css:this._ctx.fillStyle=l<256?this._colors.ansi[l].css:this._colors.foreground.css,this._clipRow(i,a),o&&(this._ctx.globalAlpha=t.DIM_OPACITY),this._ctx.fillText(e,h*this._scaledCellWidth+this._scaledCharLeft,a*this._scaledCellHeight+this._scaledCharTop),this._ctx.restore()},s.prototype._clipRow=function(t,i){this._ctx.beginPath(),this._ctx.rect(0,i*this._scaledCellHeight,t.cols*this._scaledCellWidth,this._scaledCellHeight),this._ctx.clip()},s.prototype._getFont=function(t,i,e){var s=i?t.options.fontWeightBold:t.options.fontWeight;return(e?"italic":"")+" "+s+" "+t.options.fontSize*window.devicePixelRatio+"px "+t.options.fontFamily},s}();exports.BaseRenderLayer=s;
},{"./atlas/Types":171,"./atlas/CharAtlasCache":52,"../Buffer":17}],157:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var e in r)r.hasOwnProperty(e)&&(t[e]=r[e])};return function(r,e){function a(){this.constructor=r}t(r,e),r.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var r=require("../Buffer"),e=require("./atlas/Types"),a=require("./GridCache"),s=require("./BaseRenderLayer"),o=function(s){function o(t,r,e,o){var i=s.call(this,t,"text",r,o,e)||this;return i._characterOverlapCache={},i._state=new a.GridCache,i}return t(o,s),o.prototype.resize=function(t,r){s.prototype.resize.call(this,t,r);var e=this._getFont(t,!1,!1);this._characterWidth===r.scaledCharWidth&&this._characterFont===e||(this._characterWidth=r.scaledCharWidth,this._characterFont=e,this._characterOverlapCache={}),this._state.clear(),this._state.resize(t.cols,t.rows)},o.prototype.reset=function(t){this._state.clear(),this.clearAll()},o.prototype._forEachCell=function(t,a,s,o){for(var i=a;i<=s;i++)for(var c=i+t.buffer.ydisp,n=t.buffer.lines.get(c),l=0;l<t.cols;l++){var _=n[l],h=_[r.CHAR_DATA_CODE_INDEX],f=_[r.CHAR_DATA_CHAR_INDEX],u=_[r.CHAR_DATA_ATTR_INDEX],p=_[r.CHAR_DATA_WIDTH_INDEX];if(0!==p){this._isOverlapping(_)&&l<n.length-1&&32===n[l+1][r.CHAR_DATA_CODE_INDEX]&&(p=2);var C=u>>18,A=511&u,d=u>>9&511;if(8&C){var y=A;A=d,256===(d=y)&&(d=e.INVERTED_DEFAULT_COLOR),257===A&&(A=e.INVERTED_DEFAULT_COLOR)}o(h,f,p,l,i,d,A,C)}}},o.prototype._drawBackground=function(t,r,a){var s=this,o=this._ctx,i=t.cols,c=0,n=0,l=null;o.save(),this._forEachCell(t,r,a,function(t,r,a,_,h,f,u,p){var C=null;u===e.INVERTED_DEFAULT_COLOR?C=s._colors.foreground.css:u<256&&(C=s._colors.ansi[u].css),null===l&&(c=_,n=h),h!==n?(o.fillStyle=l,s.fillCells(c,n,i-c,1),c=_,n=h):l!==C&&(o.fillStyle=l,s.fillCells(c,n,_-c,1),c=_,n=h),l=C}),null!==l&&(o.fillStyle=l,this.fillCells(c,n,i-c,1)),o.restore()},o.prototype._drawForeground=function(t,r,a){var s=this;this._forEachCell(t,r,a,function(r,a,o,i,c,n,l,_){16&_||(2&_&&(s._ctx.save(),n===e.INVERTED_DEFAULT_COLOR?s._ctx.fillStyle=s._colors.background.css:s._ctx.fillStyle=n<256?s._colors.ansi[n].css:s._colors.foreground.css,s.fillBottomLineAtCells(i,c),s._ctx.restore()),s.drawChar(t,a,r,o,i,c,n,l,!!(1&_),!!(32&_),!!(64&_)))})},o.prototype.onGridChanged=function(t,r,e){0!==this._state.cache.length&&(this._charAtlas.beginFrame(),this.clearCells(0,r,t.cols,e-r+1),this._drawBackground(t,r,e),this._drawForeground(t,r,e))},o.prototype.onOptionsChanged=function(t){this.setTransparency(t,t.options.allowTransparency)},o.prototype._isOverlapping=function(t){if(1!==t[r.CHAR_DATA_WIDTH_INDEX])return!1;if(t[r.CHAR_DATA_CODE_INDEX]<256)return!1;var e=t[r.CHAR_DATA_CHAR_INDEX];if(this._characterOverlapCache.hasOwnProperty(e))return this._characterOverlapCache[e];this._ctx.save(),this._ctx.font=this._characterFont;var a=Math.floor(this._ctx.measureText(e).width)>this._characterWidth;return this._ctx.restore(),this._characterOverlapCache[e]=a,a},o}(s.BaseRenderLayer);exports.TextRenderLayer=o;
},{"../Buffer":17,"./atlas/Types":171,"./GridCache":169,"./BaseRenderLayer":170}],158:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])};return function(e,s){function r(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(r.prototype=s.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./BaseRenderLayer"),s=function(e){function s(t,s,r){var n=e.call(this,t,"selection",s,!0,r)||this;return n._state={start:null,end:null},n}return t(s,e),s.prototype.resize=function(t,s){e.prototype.resize.call(this,t,s),this._state={start:null,end:null}},s.prototype.reset=function(t){this._state.start&&this._state.end&&(this._state={start:null,end:null},this.clearAll())},s.prototype.onSelectionChanged=function(t,e,s){if(this._state.start!==e&&this._state.end!==s&&(this.clearAll(),e&&s)){var r=e[1]-t.buffer.ydisp,n=s[1]-t.buffer.ydisp,i=Math.max(r,0),o=Math.min(n,t.rows-1);if(!(i>=t.rows||o<0)){var l=r===i?e[0]:0,a=i===o?s[0]:t.cols;this._ctx.fillStyle=this._colors.selection.css,this.fillCells(l,i,a-l,1);var c=Math.max(o-i-1,0);if(this.fillCells(0,i+1,t.cols,c),i!==o){var u=n===o?s[0]:t.cols;this.fillCells(0,o,u,1)}this._state.start=[e[0],e[1]],this._state.end=[s[0],s[1]]}}},s}(e.BaseRenderLayer);exports.SelectionRenderLayer=s;
},{"./BaseRenderLayer":170}],159:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../Buffer"),r=require("./BaseRenderLayer"),i=600,s=function(r){function i(t,e,i){var s=r.call(this,t,"cursor",e,!0,i)||this;return s._state={x:null,y:null,isFocused:null,style:null,width:null},s._cursorRenderers={bar:s._renderBarCursor.bind(s),block:s._renderBlockCursor.bind(s),underline:s._renderUnderlineCursor.bind(s)},s}return t(i,r),i.prototype.resize=function(t,e){r.prototype.resize.call(this,t,e),this._state={x:null,y:null,isFocused:null,style:null,width:null}},i.prototype.reset=function(t){this._clearCursor(),this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=null,this.onOptionsChanged(t))},i.prototype.onBlur=function(t){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.pause(),t.refresh(t.buffer.y,t.buffer.y)},i.prototype.onFocus=function(t){this._cursorBlinkStateManager?this._cursorBlinkStateManager.resume(t):t.refresh(t.buffer.y,t.buffer.y)},i.prototype.onOptionsChanged=function(t){var e=this;t.options.cursorBlink?this._cursorBlinkStateManager||(this._cursorBlinkStateManager=new n(t,function(){e._render(t,!0)})):(this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=null),t.refresh(t.buffer.y,t.buffer.y))},i.prototype.onCursorMove=function(t){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.restartBlinkAnimation(t)},i.prototype.onGridChanged=function(t,e,r){!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isPaused?this._render(t,!1):this._cursorBlinkStateManager.restartBlinkAnimation(t)},i.prototype._render=function(t,r){if(t.cursorState&&!t.cursorHidden){var i=t.buffer.ybase+t.buffer.y,s=i-t.buffer.ydisp;if(s<0||s>=t.rows)this._clearCursor();else{var n=t.buffer.lines.get(i)[t.buffer.x];if(n){if(!t.isFocused)return this._clearCursor(),this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._renderBlurCursor(t,t.buffer.x,s,n),this._ctx.restore(),this._state.x=t.buffer.x,this._state.y=s,this._state.isFocused=!1,this._state.style=t.options.cursorStyle,void(this._state.width=n[e.CHAR_DATA_WIDTH_INDEX]);if(!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isCursorVisible){if(this._state){if(this._state.x===t.buffer.x&&this._state.y===s&&this._state.isFocused===t.isFocused&&this._state.style===t.options.cursorStyle&&this._state.width===n[e.CHAR_DATA_WIDTH_INDEX])return;this._clearCursor()}this._ctx.save(),this._cursorRenderers[t.options.cursorStyle||"block"](t,t.buffer.x,s,n),this._ctx.restore(),this._state.x=t.buffer.x,this._state.y=s,this._state.isFocused=!1,this._state.style=t.options.cursorStyle,this._state.width=n[e.CHAR_DATA_WIDTH_INDEX]}else this._clearCursor()}}}else this._clearCursor()},i.prototype._clearCursor=function(){this._state&&(this.clearCells(this._state.x,this._state.y,this._state.width,1),this._state={x:null,y:null,isFocused:null,style:null,width:null})},i.prototype._renderBarCursor=function(t,e,r,i){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillLeftLineAtCell(e,r),this._ctx.restore()},i.prototype._renderBlockCursor=function(t,r,i,s){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillCells(r,i,s[e.CHAR_DATA_WIDTH_INDEX],1),this._ctx.fillStyle=this._colors.cursorAccent.css,this.fillCharTrueColor(t,s,r,i),this._ctx.restore()},i.prototype._renderUnderlineCursor=function(t,e,r,i){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillBottomLineAtCells(e,r),this._ctx.restore()},i.prototype._renderBlurCursor=function(t,r,i,s){this._ctx.save(),this._ctx.strokeStyle=this._colors.cursor.css,this.strokeRectAtCell(r,i,s[e.CHAR_DATA_WIDTH_INDEX],1),this._ctx.restore()},i}(r.BaseRenderLayer);exports.CursorRenderLayer=s;var n=function(){function t(t,e){this._renderCallback=e,this.isCursorVisible=!0,t.isFocused&&this._restartInterval()}return Object.defineProperty(t.prototype,"isPaused",{get:function(){return!(this._blinkStartTimeout||this._blinkInterval)},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=null),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=null),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.restartBlinkAnimation=function(t){var e=this;this.isPaused||(this._animationTimeRestarted=Date.now(),this.isCursorVisible=!0,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null})))},t.prototype._restartInterval=function(t){var e=this;void 0===t&&(t=i),this._blinkInterval&&window.clearInterval(this._blinkInterval),this._blinkStartTimeout=setTimeout(function(){if(e._animationTimeRestarted){var t=i-(Date.now()-e._animationTimeRestarted);if(e._animationTimeRestarted=null,t>0)return void e._restartInterval(t)}e.isCursorVisible=!1,e._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null}),e._blinkInterval=setInterval(function(){if(e._animationTimeRestarted){var t=i-(Date.now()-e._animationTimeRestarted);return e._animationTimeRestarted=null,void e._restartInterval(t)}e.isCursorVisible=!e.isCursorVisible,e._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null})},i)},t)},t.prototype.pause=function(){this.isCursorVisible=!0,this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=null),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=null),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.resume=function(t){this._animationTimeRestarted=null,this._restartInterval(),this.restartBlinkAnimation(t)},t}();
},{"../Buffer":17,"./BaseRenderLayer":170}],160:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./BaseRenderLayer"),i=function(e){function i(t,i,s,n){var r=e.call(this,t,"link",i,!0,s)||this;return r._state=null,n.linkifier.on("linkhover",function(t){return r._onLinkHover(t)}),n.linkifier.on("linkleave",function(t){return r._onLinkLeave(t)}),r}return t(i,e),i.prototype.resize=function(t,i){e.prototype.resize.call(this,t,i),this._state=null},i.prototype.reset=function(t){this._clearCurrentLink()},i.prototype._clearCurrentLink=function(){if(this._state){this.clearCells(this._state.x1,this._state.y1,this._state.cols-this._state.x1,1);var t=this._state.y2-this._state.y1-1;t>0&&this.clearCells(0,this._state.y1+1,this._state.cols,t),this.clearCells(0,this._state.y2,this._state.x2,1),this._state=null}},i.prototype._onLinkHover=function(t){if(this._ctx.fillStyle=this._colors.foreground.css,t.y1===t.y2)this.fillBottomLineAtCells(t.x1,t.y1,t.x2-t.x1);else{this.fillBottomLineAtCells(t.x1,t.y1,t.cols-t.x1);for(var e=t.y1+1;e<t.y2;e++)this.fillBottomLineAtCells(0,e,t.cols);this.fillBottomLineAtCells(0,t.y2,t.x2)}this._state=t},i.prototype._onLinkLeave=function(t){this._clearCurrentLink()},i}(e.BaseRenderLayer);exports.LinkRenderLayer=i;
},{"./BaseRenderLayer":170}],147:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(){function t(t,i){this._terminal=t,this._callback=i,this._animationFrame=null}return t.prototype.dispose=function(){this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.refresh=function(t,i){var n=this;t=t||0,i=i||this._terminal.rows-1,this._rowStart=void 0!==this._rowStart?Math.min(this._rowStart,t):t,this._rowEnd=void 0!==this._rowEnd?Math.max(this._rowEnd,i):i,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){return n._innerRefresh()}))},t.prototype._innerRefresh=function(){this._rowStart=Math.max(this._rowStart,0),this._rowEnd=Math.min(this._rowEnd,this._terminal.rows-1),this._callback(this._rowStart,this._rowEnd),this._rowStart=null,this._rowEnd=null,this._animationFrame=null},t}();exports.RenderDebouncer=t;
},{}],37:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=function(){function e(){}return e.prototype.setListener=function(e){var t=this;this._listener&&this.clearListener(),this._listener=e,this._outerListener=function(){t._listener(window.devicePixelRatio,t._currentDevicePixelRatio),t._updateDpr()},this._updateDpr()},e.prototype._updateDpr=function(){this._resolutionMediaMatchList&&this._resolutionMediaMatchList.removeListener(this._outerListener),this._currentDevicePixelRatio=window.devicePixelRatio,this._resolutionMediaMatchList=window.matchMedia("screen and (resolution: "+window.devicePixelRatio+"dppx)"),this._resolutionMediaMatchList.addListener(this._outerListener)},e.prototype.clearListener=function(){this._listener&&(this._resolutionMediaMatchList.removeListener(this._outerListener),this._listener=null,this._outerListener=null)},e}();exports.ScreenDprMonitor=e;
},{}],30:[function(require,module,exports) {
"use strict";var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var i in n)n.hasOwnProperty(i)&&(e[i]=n[i])};return function(n,i){function t(){this.constructor=n}e(n,i),n.prototype=null===i?Object.create(i):(t.prototype=i.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var n=require("./TextRenderLayer"),i=require("./SelectionRenderLayer"),t=require("./CursorRenderLayer"),r=require("./ColorManager"),s=require("./LinkRenderLayer"),o=require("../EventEmitter"),a=require("../utils/RenderDebouncer"),h=require("../utils/ScreenDprMonitor"),l=function(o){function l(e,l){var c=o.call(this)||this;c._terminal=e,c._isPaused=!1,c._needsFullRefresh=!1;var d=c._terminal.options.allowTransparency;(c.colorManager=new r.ColorManager(document,d),l&&c.colorManager.setTheme(l),c._renderLayers=[new n.TextRenderLayer(c._terminal.screenElement,0,c.colorManager.colors,d),new i.SelectionRenderLayer(c._terminal.screenElement,1,c.colorManager.colors),new s.LinkRenderLayer(c._terminal.screenElement,2,c.colorManager.colors,c._terminal),new t.CursorRenderLayer(c._terminal.screenElement,3,c.colorManager.colors)],c.dimensions={scaledCharWidth:null,scaledCharHeight:null,scaledCellWidth:null,scaledCellHeight:null,scaledCharLeft:null,scaledCharTop:null,scaledCanvasWidth:null,scaledCanvasHeight:null,canvasWidth:null,canvasHeight:null,actualCellWidth:null,actualCellHeight:null},c._devicePixelRatio=window.devicePixelRatio,c._updateDimensions(),c.onOptionsChanged(),c._renderDebouncer=new a.RenderDebouncer(c._terminal,c._renderRows.bind(c)),c._screenDprMonitor=new h.ScreenDprMonitor,c._screenDprMonitor.setListener(function(){return c.onWindowResize(window.devicePixelRatio)}),"IntersectionObserver"in window)&&new IntersectionObserver(function(e){return c.onIntersectionChange(e[0])},{threshold:0}).observe(c._terminal.element);return c}return e(l,o),l.prototype.onIntersectionChange=function(e){this._isPaused=0===e.intersectionRatio,!this._isPaused&&this._needsFullRefresh&&this._terminal.refresh(0,this._terminal.rows-1)},l.prototype.onWindowResize=function(e){this._devicePixelRatio!==e&&(this._devicePixelRatio=e,this.onResize(this._terminal.cols,this._terminal.rows))},l.prototype.setTheme=function(e){var n=this;return this.colorManager.setTheme(e),this._renderLayers.forEach(function(e){e.onThemeChanged(n._terminal,n.colorManager.colors),e.reset(n._terminal)}),this._isPaused?this._needsFullRefresh=!0:this._terminal.refresh(0,this._terminal.rows-1),this.colorManager.colors},l.prototype.onResize=function(e,n){var i=this;this._updateDimensions(),this._renderLayers.forEach(function(e){return e.resize(i._terminal,i.dimensions)}),this._isPaused?this._needsFullRefresh=!0:this._terminal.refresh(0,this._terminal.rows-1),this._terminal.screenElement.style.width=this.dimensions.canvasWidth+"px",this._terminal.screenElement.style.height=this.dimensions.canvasHeight+"px",this.emit("resize",{width:this.dimensions.canvasWidth,height:this.dimensions.canvasHeight})},l.prototype.onCharSizeChanged=function(){this.onResize(this._terminal.cols,this._terminal.rows)},l.prototype.onBlur=function(){var e=this;this._runOperation(function(n){return n.onBlur(e._terminal)})},l.prototype.onFocus=function(){var e=this;this._runOperation(function(n){return n.onFocus(e._terminal)})},l.prototype.onSelectionChanged=function(e,n){var i=this;this._runOperation(function(t){return t.onSelectionChanged(i._terminal,e,n)})},l.prototype.onCursorMove=function(){var e=this;this._runOperation(function(n){return n.onCursorMove(e._terminal)})},l.prototype.onOptionsChanged=function(){var e=this;this.colorManager.allowTransparency=this._terminal.options.allowTransparency,this._runOperation(function(n){return n.onOptionsChanged(e._terminal)})},l.prototype.clear=function(){var e=this;this._runOperation(function(n){return n.reset(e._terminal)})},l.prototype._runOperation=function(e){this._isPaused?this._needsFullRefresh=!0:this._renderLayers.forEach(function(n){return e(n)})},l.prototype.refreshRows=function(e,n){this._isPaused?this._needsFullRefresh=!0:this._renderDebouncer.refresh(e,n)},l.prototype._renderRows=function(e,n){var i=this;this._renderLayers.forEach(function(t){return t.onGridChanged(i._terminal,e,n)}),this._terminal.emit("refresh",{start:e,end:n})},l.prototype._updateDimensions=function(){this._terminal.charMeasure.width&&this._terminal.charMeasure.height&&(this.dimensions.scaledCharWidth=Math.floor(this._terminal.charMeasure.width*window.devicePixelRatio),this.dimensions.scaledCharHeight=Math.ceil(this._terminal.charMeasure.height*window.devicePixelRatio),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._terminal.options.lineHeight),this.dimensions.scaledCharTop=1===this._terminal.options.lineHeight?0:Math.round((this.dimensions.scaledCellHeight-this.dimensions.scaledCharHeight)/2),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._terminal.options.letterSpacing),this.dimensions.scaledCharLeft=Math.floor(this._terminal.options.letterSpacing/2),this.dimensions.scaledCanvasHeight=this._terminal.rows*this.dimensions.scaledCellHeight,this.dimensions.scaledCanvasWidth=this._terminal.cols*this.dimensions.scaledCellWidth,this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._terminal.rows,this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._terminal.cols)},l}(o.EventEmitter);exports.Renderer=l;
},{"./TextRenderLayer":157,"./SelectionRenderLayer":158,"./CursorRenderLayer":159,"./ColorManager":35,"./LinkRenderLayer":160,"../EventEmitter":19,"../utils/RenderDebouncer":147,"../utils/ScreenDprMonitor":37}],36:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=500,e=function(){function e(t){var e=this;this._terminal=t,this._zones=[],this._areZonesActive=!1,this._tooltipTimeout=null,this._currentZone=null,this._lastHoverCoords=[null,null],this._terminal.element.addEventListener("mousedown",function(t){return e._onMouseDown(t)}),this._mouseMoveListener=function(t){return e._onMouseMove(t)},this._clickListener=function(t){return e._onClick(t)}}return e.prototype.add=function(t){this._zones.push(t),1===this._zones.length&&this._activate()},e.prototype.clearAll=function(t,e){if(0!==this._zones.length){e||(t=0,e=this._terminal.rows-1);for(var i=0;i<this._zones.length;i++){var n=this._zones[i];(n.y1>t&&n.y1<=e+1||n.y2>t&&n.y2<=e+1||n.y1<t&&n.y2>e+1)&&(this._currentZone&&this._currentZone===n&&(this._currentZone.leaveCallback(),this._currentZone=null),this._zones.splice(i--,1))}0===this._zones.length&&this._deactivate()}},e.prototype._activate=function(){this._areZonesActive||(this._areZonesActive=!0,this._terminal.element.addEventListener("mousemove",this._mouseMoveListener),this._terminal.element.addEventListener("click",this._clickListener))},e.prototype._deactivate=function(){this._areZonesActive&&(this._areZonesActive=!1,this._terminal.element.removeEventListener("mousemove",this._mouseMoveListener),this._terminal.element.removeEventListener("click",this._clickListener))},e.prototype._onMouseMove=function(t){this._lastHoverCoords[0]===t.pageX&&this._lastHoverCoords[1]===t.pageY||(this._onHover(t),this._lastHoverCoords=[t.pageX,t.pageY])},e.prototype._onHover=function(e){var i=this,n=this._findZoneEventAt(e);n!==this._currentZone&&(this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=null,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout)),n&&(this._currentZone=n,n.hoverCallback&&n.hoverCallback(e),this._tooltipTimeout=setTimeout(function(){return i._onTooltip(e)},t)))},e.prototype._onTooltip=function(t){this._tooltipTimeout=null;var e=this._findZoneEventAt(t);e&&e.tooltipCallback&&e.tooltipCallback(t)},e.prototype._onMouseDown=function(t){if(this._areZonesActive){var e=this._findZoneEventAt(t);e&&e.willLinkActivate(t)&&(t.preventDefault(),t.stopImmediatePropagation())}},e.prototype._onClick=function(t){var e=this._findZoneEventAt(t);e&&(e.clickCallback(t),t.preventDefault(),t.stopImmediatePropagation())},e.prototype._findZoneEventAt=function(t){var e=this._terminal.mouseHelper.getCoords(t,this._terminal.screenElement,this._terminal.charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows);if(!e)return null;for(var i=e[0],n=e[1],o=0;o<this._zones.length;o++){var s=this._zones[o];if(s.y1===s.y2){if(n===s.y1&&i>=s.x1&&i<s.x2)return s}else if(n===s.y1&&i>=s.x1||n===s.y2&&i<s.x2||n>s.y1&&n<s.y2)return s}return null},e}();exports.MouseZoneManager=e;var i=function(){return function(t,e,i,n,o,s,r,l,a){this.x1=t,this.y1=e,this.x2=i,this.y2=n,this.clickCallback=o,this.hoverCallback=s,this.tooltipCallback=r,this.leaveCallback=l,this.willLinkActivate=a}}();exports.MouseZone=i;
},{}],24:[function(require,module,exports) {
"use strict";var t=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])};return function(i,e){function n(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=require("./input/MouseZoneManager"),e=require("./EventEmitter"),n=function(e){function n(t){var i=e.call(this)||this;return i._terminal=t,i._linkMatchers=[],i._nextLinkMatcherId=0,i._rowsToLinkify={start:null,end:null},i}return t(n,e),n.prototype.attachToDom=function(t){this._mouseZoneManager=t},n.prototype.linkifyRows=function(t,i){var e=this;this._mouseZoneManager&&(null===this._rowsToLinkify.start?(this._rowsToLinkify.start=t,this._rowsToLinkify.end=i):(this._rowsToLinkify.start=Math.min(this._rowsToLinkify.start,t),this._rowsToLinkify.end=Math.max(this._rowsToLinkify.end,i)),this._mouseZoneManager.clearAll(t,i),this._rowsTimeoutId&&clearTimeout(this._rowsTimeoutId),this._rowsTimeoutId=setTimeout(function(){return e._linkifyRows()},n.TIME_BEFORE_LINKIFY))},n.prototype._linkifyRows=function(){this._rowsTimeoutId=null;for(var t=this._rowsToLinkify.start;t<=this._rowsToLinkify.end;t++)this._linkifyRow(t);this._rowsToLinkify.start=null,this._rowsToLinkify.end=null},n.prototype.registerLinkMatcher=function(t,i,e){if(void 0===e&&(e={}),!i)throw new Error("handler must be defined");var n={id:this._nextLinkMatcherId++,regex:t,handler:i,matchIndex:e.matchIndex,validationCallback:e.validationCallback,hoverTooltipCallback:e.tooltipCallback,hoverLeaveCallback:e.leaveCallback,willLinkActivate:e.willLinkActivate,priority:e.priority||0};return this._addLinkMatcherToList(n),n.id},n.prototype._addLinkMatcherToList=function(t){if(0!==this._linkMatchers.length){for(var i=this._linkMatchers.length-1;i>=0;i--)if(t.priority<=this._linkMatchers[i].priority)return void this._linkMatchers.splice(i+1,0,t);this._linkMatchers.splice(0,0,t)}else this._linkMatchers.push(t)},n.prototype.deregisterLinkMatcher=function(t){for(var i=0;i<this._linkMatchers.length;i++)if(this._linkMatchers[i].id===t)return this._linkMatchers.splice(i,1),!0;return!1},n.prototype._linkifyRow=function(t){var i=this._terminal.buffer.ydisp+t;if(!(i>=this._terminal.buffer.lines.length)){if(this._terminal.buffer.lines.get(i).isWrapped){if(0!==t)return;do{t--,i--}while(this._terminal.buffer.lines.get(i).isWrapped)}for(var e=this._terminal.buffer.translateBufferLineToString(i,!1),n=i+1;n<this._terminal.buffer.lines.length&&this._terminal.buffer.lines.get(n).isWrapped;)e+=this._terminal.buffer.translateBufferLineToString(n++,!1);for(var r=0;r<this._linkMatchers.length;r++)this._doLinkifyRow(t,e,this._linkMatchers[r])}},n.prototype._doLinkifyRow=function(t,i,e,n){var r=this;void 0===n&&(n=0);var o=i.match(e.regex);if(o&&0!==o.length){var a=o["number"!=typeof e.matchIndex?0:e.matchIndex],s=i.indexOf(a);e.validationCallback?e.validationCallback(a,function(i){r._rowsTimeoutId||i&&r._addLink(n+s,t,a,e)}):this._addLink(n+s,t,a,e);var l=s+a.length,h=i.substr(l);h.length>0&&this._doLinkifyRow(t,h,e,n+l)}},n.prototype._addLink=function(t,e,n,r){var o=this,a=t%this._terminal.cols,s=e+Math.floor(t/this._terminal.cols),l=(a+n.length)%this._terminal.cols,h=s+Math.floor((a+n.length)/this._terminal.cols);0===l&&(l=this._terminal.cols,h--),this._mouseZoneManager.add(new i.MouseZone(a+1,s+1,l+1,h+1,function(t){if(r.handler)return r.handler(t,n);window.open(n,"_blank")},function(t){o.emit("linkhover",o._createLinkHoverEvent(a,s,l,h)),o._terminal.element.classList.add("xterm-cursor-pointer")},function(t){o.emit("linktooltip",o._createLinkHoverEvent(a,s,l,h)),r.hoverTooltipCallback&&r.hoverTooltipCallback(t,n)},function(){o.emit("linkleave",o._createLinkHoverEvent(a,s,l,h)),o._terminal.element.classList.remove("xterm-cursor-pointer"),r.hoverLeaveCallback&&r.hoverLeaveCallback()},function(t){return!r.willLinkActivate||r.willLinkActivate(t,n)}))},n.prototype._createLinkHoverEvent=function(t,i,e,n){return{x1:t,y1:i,x2:e,y2:n,cols:this._terminal.cols}},n.TIME_BEFORE_LINKIFY=200,n}(e.EventEmitter);exports.Linkifier=n;
},{"./input/MouseZoneManager":36,"./EventEmitter":19}],33:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=function(){function e(e){this._renderer=e}return e.getCoordsRelativeToElement=function(e,t){if(null==e.pageX)return null;for(var r=t,o=e.pageX,n=e.pageY;t;)o-=t.offsetLeft,n-=t.offsetTop,t=t.offsetParent;for(t=r;t&&t!==t.ownerDocument.body;)o+=t.scrollLeft,n+=t.scrollTop,t=t.parentElement;return[o,n]},e.prototype.getCoords=function(t,r,o,n,i,l,a){if(!o.width||!o.height)return null;var s=e.getCoordsRelativeToElement(t,r);return s?(s[0]=Math.ceil((s[0]+(a?this._renderer.dimensions.actualCellWidth/2:0))/this._renderer.dimensions.actualCellWidth),s[1]=Math.ceil(s[1]/this._renderer.dimensions.actualCellHeight),s[0]=Math.min(Math.max(s[0],1),i+(a?1:0)),s[1]=Math.min(Math.max(s[1],1),l),s):null},e.prototype.getRawByteCoords=function(e,t,r,o,n,i){var l=this.getCoords(e,t,r,o,n,i),a=l[0],s=l[1];return{x:a+=32,y:s+=32}},e}();exports.MouseHelper=e;
},{}],144:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(){function t(t){this._terminal=t,this.clearSelection()}return t.prototype.clearSelection=function(){this.selectionStart=null,this.selectionEnd=null,this.isSelectAllActive=!1,this.selectionStartLength=0},Object.defineProperty(t.prototype,"finalSelectionStart",{get:function(){return this.isSelectAllActive?[0,0]:this.selectionEnd&&this.selectionStart&&this.areSelectionValuesReversed()?this.selectionEnd:this.selectionStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"finalSelectionEnd",{get:function(){return this.isSelectAllActive?[this._terminal.cols,this._terminal.buffer.ybase+this._terminal.rows-1]:this.selectionStart?!this.selectionEnd||this.areSelectionValuesReversed()?[this.selectionStart[0]+this.selectionStartLength,this.selectionStart[1]]:this.selectionStartLength&&this.selectionEnd[1]===this.selectionStart[1]?[Math.max(this.selectionStart[0]+this.selectionStartLength,this.selectionEnd[0]),this.selectionEnd[1]]:this.selectionEnd:null},enumerable:!0,configurable:!0}),t.prototype.areSelectionValuesReversed=function(){var t=this.selectionStart,e=this.selectionEnd;return!(!t||!e)&&(t[1]>e[1]||t[1]===e[1]&&t[0]>e[0])},t.prototype.onTrim=function(t){return this.selectionStart&&(this.selectionStart[1]-=t),this.selectionEnd&&(this.selectionEnd[1]-=t),this.selectionEnd&&this.selectionEnd[1]<0?(this.clearSelection(),!0):(this.selectionStart&&this.selectionStart[1]<0&&(this.selectionStart[1]=0),!1)},t}();exports.SelectionModel=t;
},{}],146:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../EscapeSequences"),e=function(){function e(t,e){this._mouseEvent=t,this._terminal=e,this._lines=this._terminal.buffer.lines,this._startCol=this._terminal.buffer.x,this._startRow=this._terminal.buffer.y;var o,i=this._terminal.mouseHelper.getCoords(this._mouseEvent,this._terminal.element,this._terminal.charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows,!1);i&&(o=i.map(function(t){return t-1}),this._endCol=o[0],this._endRow=o[1])}return e.prototype.move=function(){this._mouseEvent.altKey&&void 0!==this._endCol&&void 0!==this._endRow&&this._terminal.send(this._arrowSequences())},e.prototype._arrowSequences=function(){return this._terminal.buffer.hasScrollback?this._moveHorizontallyOnly():this._resetStartingRow()+this._moveToRequestedRow()+this._moveToRequestedCol()},e.prototype._resetStartingRow=function(){return 0===this._moveToRequestedRow().length?"":o(this._bufferLine(this._startCol,this._startRow,this._startCol,this._startRow-this._wrappedRowsForRow(this._startRow),!1).length,this._sequence("D"))},e.prototype._moveToRequestedRow=function(){var t=this._startRow-this._wrappedRowsForRow(this._startRow),e=this._endRow-this._wrappedRowsForRow(this._endRow);return o(Math.abs(t-e)-this._wrappedRowsCount(),this._sequence(this._verticalDirection()))},e.prototype._moveToRequestedCol=function(){var t;t=this._moveToRequestedRow().length>0?this._endRow-this._wrappedRowsForRow(this._endRow):this._startRow;var e=this._endRow,i=this._horizontalDirection();return o(this._bufferLine(this._startCol,t,this._endCol,e,"C"===i).length,this._sequence(i))},e.prototype._moveHorizontallyOnly=function(){var t=this._horizontalDirection();return o(Math.abs(this._startCol-this._endCol),this._sequence(t))},e.prototype._wrappedRowsCount=function(){for(var t=0,e=this._startRow-this._wrappedRowsForRow(this._startRow),o=this._endRow-this._wrappedRowsForRow(this._endRow),i=0;i<Math.abs(e-o);i++){var r="A"===this._verticalDirection()?-1:1;this._lines.get(e+r*i).isWrapped&&t++}return t},e.prototype._wrappedRowsForRow=function(t){for(var e=0,o=this._lines.get(t).isWrapped;o&&t>=0&&t<this._terminal.rows;)e++,t--,o=this._lines.get(t).isWrapped;return e},e.prototype._horizontalDirection=function(){var t;return t=this._moveToRequestedRow().length>0?this._endRow-this._wrappedRowsForRow(this._endRow):this._startRow,this._startCol<this._endCol&&t<=this._endRow||this._startCol>=this._endCol&&t<this._endRow?"C":"D"},e.prototype._verticalDirection=function(){return this._startRow>this._endRow?"A":"B"},e.prototype._bufferLine=function(t,e,o,i,r){for(var s=t,n=e,h="";s!==o||n!==i;)s+=r?1:-1,r&&s>this._terminal.cols-1?(h+=this._terminal.buffer.translateBufferLineToString(n,!1,t,s),s=0,t=0,n++):!r&&s<0&&(h+=this._terminal.buffer.translateBufferLineToString(n,!1,0,t+1),t=s=this._terminal.cols-1,n--);return h+this._terminal.buffer.translateBufferLineToString(n,!1,t,s)},e.prototype._sequence=function(e){var o=this._terminal.applicationCursor?"O":"[";return t.C0.ESC+o+e},e}();function o(t,e){t=Math.floor(t);for(var o="",i=0;i<t;i++)o+=e;return o}exports.AltClickHandler=e;
},{"../EscapeSequences":21}],25:[function(require,module,exports) {
"use strict";var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./utils/MouseHelper"),i=require("./shared/utils/Browser"),n=require("./EventEmitter"),o=require("./SelectionModel"),r=require("./Buffer"),s=require("./handlers/AltClickHandler"),l=50,h=15,_=50,a=500,c=" ()[]{}'\"",u=String.fromCharCode(160),f=new RegExp(u,"g"),m=function(n){function u(e,t){var i=n.call(this)||this;return i._terminal=e,i._charMeasure=t,i._enabled=!0,i._initListeners(),i.enable(),i._model=new o.SelectionModel(e),i._activeSelectionMode=0,i}return e(u,n),Object.defineProperty(u.prototype,"_buffer",{get:function(){return this._terminal.buffers.active},enumerable:!0,configurable:!0}),u.prototype._initListeners=function(){var e=this;this._mouseMoveListener=function(t){return e._onMouseMove(t)},this._mouseUpListener=function(t){return e._onMouseUp(t)},this._trimListener=function(t){return e._onTrim(t)},this.initBuffersListeners()},u.prototype.initBuffersListeners=function(){var e=this;this._terminal.buffer.lines.on("trim",this._trimListener),this._terminal.buffers.on("activate",function(t){return e._onBufferActivate(t)})},u.prototype.disable=function(){this.clearSelection(),this._enabled=!1},u.prototype.enable=function(){this._enabled=!0},Object.defineProperty(u.prototype,"selectionStart",{get:function(){return this._model.finalSelectionStart},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"selectionEnd",{get:function(){return this._model.finalSelectionEnd},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"hasSelection",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;return!(!e||!t)&&(e[0]!==t[0]||e[1]!==t[1])},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"selectionText",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;if(!e||!t)return"";var n=e[1]===t[1]?t[0]:null,o=[];o.push(this._buffer.translateBufferLineToString(e[1],!0,e[0],n));for(var r=e[1]+1;r<=t[1]-1;r++){var s=this._buffer.lines.get(r),l=this._buffer.translateBufferLineToString(r,!0);s.isWrapped?o[o.length-1]+=l:o.push(l)}if(e[1]!==t[1]){s=this._buffer.lines.get(t[1]),l=this._buffer.translateBufferLineToString(t[1],!0,0,t[0]);s.isWrapped?o[o.length-1]+=l:o.push(l)}return o.map(function(e){return e.replace(f," ")}).join(i.isMSWindows?"\r\n":"\n")},enumerable:!0,configurable:!0}),u.prototype.clearSelection=function(){this._model.clearSelection(),this._removeMouseDownListeners(),this.refresh()},u.prototype.refresh=function(e){var t=this;(this._refreshAnimationFrame||(this._refreshAnimationFrame=window.requestAnimationFrame(function(){return t._refresh()})),i.isLinux&&e)&&(this.selectionText.length&&this.emit("newselection",this.selectionText))},u.prototype._refresh=function(){this._refreshAnimationFrame=null,this.emit("refresh",{start:this._model.finalSelectionStart,end:this._model.finalSelectionEnd})},u.prototype.isClickInSelection=function(e){var t=this._getMouseBufferCoords(e),i=this._model.finalSelectionStart,n=this._model.finalSelectionEnd;return!(!i||!n)&&(t[1]>i[1]&&t[1]<n[1]||i[1]===n[1]&&t[1]===i[1]&&t[0]>i[0]&&t[0]<n[0]||i[1]<n[1]&&t[1]===n[1]&&t[0]<n[0])},u.prototype.selectWordAtCursor=function(e){var t=this._getMouseBufferCoords(e);t&&(this._selectWordAt(t,!1),this._model.selectionEnd=null,this.refresh(!0))},u.prototype.selectAll=function(){this._model.isSelectAllActive=!0,this.refresh(),this._terminal.emit("selection")},u.prototype.selectLines=function(e,t){this._model.clearSelection(),e=Math.max(e,0),t=Math.min(t,this._terminal.buffer.lines.length-1),this._model.selectionStart=[0,e],this._model.selectionEnd=[this._terminal.cols,t],this.refresh(),this._terminal.emit("selection")},u.prototype._onTrim=function(e){this._model.onTrim(e)&&this.refresh()},u.prototype._getMouseBufferCoords=function(e){var t=this._terminal.mouseHelper.getCoords(e,this._terminal.screenElement,this._charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows,!0);return t?(t[0]--,t[1]--,t[1]+=this._terminal.buffer.ydisp,t):null},u.prototype._getMouseEventScrollAmount=function(e){var i=t.MouseHelper.getCoordsRelativeToElement(e,this._terminal.screenElement)[1],n=this._terminal.rows*Math.ceil(this._charMeasure.height*this._terminal.options.lineHeight);return i>=0&&i<=n?0:(i>n&&(i-=n),i=Math.min(Math.max(i,-l),l),(i/=l)/Math.abs(i)+Math.round(i*(h-1)))},u.prototype.shouldForceSelection=function(e){return i.isMac?e.altKey:e.shiftKey},u.prototype.onMouseDown=function(e){if(this._mouseDownTimeStamp=e.timeStamp,(2!==e.button||!this.hasSelection)&&0===e.button){if(!this._enabled){if(!this.shouldForceSelection(e))return;e.stopPropagation()}e.preventDefault(),this._dragScrollAmount=0,this._enabled&&e.shiftKey?this._onIncrementalClick(e):1===e.detail?this._onSingleClick(e):2===e.detail?this._onDoubleClick(e):3===e.detail&&this._onTripleClick(e),this._addMouseDownListeners(),this.refresh(!0)}},u.prototype._addMouseDownListeners=function(){var e=this;this._terminal.element.ownerDocument.addEventListener("mousemove",this._mouseMoveListener),this._terminal.element.ownerDocument.addEventListener("mouseup",this._mouseUpListener),this._dragScrollIntervalTimer=setInterval(function(){return e._dragScroll()},_)},u.prototype._removeMouseDownListeners=function(){this._terminal.element.ownerDocument.removeEventListener("mousemove",this._mouseMoveListener),this._terminal.element.ownerDocument.removeEventListener("mouseup",this._mouseUpListener),clearInterval(this._dragScrollIntervalTimer),this._dragScrollIntervalTimer=null},u.prototype._onIncrementalClick=function(e){this._model.selectionStart&&(this._model.selectionEnd=this._getMouseBufferCoords(e))},u.prototype._onSingleClick=function(e){if(this._model.selectionStartLength=0,this._model.isSelectAllActive=!1,this._activeSelectionMode=0,this._model.selectionStart=this._getMouseBufferCoords(e),this._model.selectionStart){this._model.selectionEnd=null;var t=this._buffer.lines.get(this._model.selectionStart[1]);if(t)if(!(t.length>=this._model.selectionStart[0]))0===t[this._model.selectionStart[0]][r.CHAR_DATA_WIDTH_INDEX]&&this._model.selectionStart[0]++}},u.prototype._onDoubleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=1,this._selectWordAt(t,!0))},u.prototype._onTripleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=2,this._selectLineAt(t[1]))},u.prototype._onMouseMove=function(e){e.stopImmediatePropagation();var t=this._model.selectionEnd?[this._model.selectionEnd[0],this._model.selectionEnd[1]]:null;if(this._model.selectionEnd=this._getMouseBufferCoords(e),this._model.selectionEnd){if(2===this._activeSelectionMode?this._model.selectionEnd[1]<this._model.selectionStart[1]?this._model.selectionEnd[0]=0:this._model.selectionEnd[0]=this._terminal.cols:1===this._activeSelectionMode&&this._selectToWordAt(this._model.selectionEnd),this._dragScrollAmount=this._getMouseEventScrollAmount(e),this._dragScrollAmount>0?this._model.selectionEnd[0]=this._terminal.cols:this._dragScrollAmount<0&&(this._model.selectionEnd[0]=0),this._model.selectionEnd[1]<this._buffer.lines.length){var i=this._buffer.lines.get(this._model.selectionEnd[1])[this._model.selectionEnd[0]];i&&0===i[r.CHAR_DATA_WIDTH_INDEX]&&this._model.selectionEnd[0]++}t&&t[0]===this._model.selectionEnd[0]&&t[1]===this._model.selectionEnd[1]||this.refresh(!0)}else this.refresh(!0)},u.prototype._dragScroll=function(){this._dragScrollAmount&&(this._terminal.scrollLines(this._dragScrollAmount,!1),this._dragScrollAmount>0?this._model.selectionEnd=[this._terminal.cols-1,Math.min(this._terminal.buffer.ydisp+this._terminal.rows,this._terminal.buffer.lines.length-1)]:this._model.selectionEnd=[0,this._terminal.buffer.ydisp],this.refresh())},u.prototype._onMouseUp=function(e){var t=e.timeStamp-this._mouseDownTimeStamp;this._removeMouseDownListeners(),this.selectionText.length<=1&&t<a?new s.AltClickHandler(e,this._terminal).move():this.hasSelection&&this._terminal.emit("selection")},u.prototype._onBufferActivate=function(e){this.clearSelection(),e.inactiveBuffer.lines.off("trim",this._trimListener),e.activeBuffer.lines.on("trim",this._trimListener)},u.prototype._convertViewportColToCharacterIndex=function(e,t){for(var i=t[0],n=0;t[0]>=n;n++){var o=e[n];0===o[r.CHAR_DATA_WIDTH_INDEX]?i--:o[r.CHAR_DATA_CHAR_INDEX].length>1&&t[0]!==n&&(i+=o[r.CHAR_DATA_CHAR_INDEX].length-1)}return i},u.prototype.setSelection=function(e,t,i){this._model.clearSelection(),this._removeMouseDownListeners(),this._model.selectionStart=[e,t],this._model.selectionStartLength=i,this.refresh()},u.prototype._getWordAt=function(e,t){if(e[0]>=this._terminal.cols)return null;var i=this._buffer.lines.get(e[1]);if(!i)return null;var n=this._buffer.translateBufferLineToString(e[1],!1),o=this._convertViewportColToCharacterIndex(i,e),s=o,l=e[0]-o,h=0,_=0,a=0,c=0;if(" "===n.charAt(o)){for(;o>0&&" "===n.charAt(o-1);)o--;for(;s<n.length&&" "===n.charAt(s+1);)s++}else{var u=e[0],f=e[0];for(0===i[u][r.CHAR_DATA_WIDTH_INDEX]&&(h++,u--),2===i[f][r.CHAR_DATA_WIDTH_INDEX]&&(_++,f++),i[f][r.CHAR_DATA_CHAR_INDEX].length>1&&(c+=i[f][r.CHAR_DATA_CHAR_INDEX].length-1,s+=i[f][r.CHAR_DATA_CHAR_INDEX].length-1);u>0&&o>0&&!this._isCharWordSeparator(i[u-1]);){0===(m=i[u-1])[r.CHAR_DATA_WIDTH_INDEX]?(h++,u--):m[r.CHAR_DATA_CHAR_INDEX].length>1&&(a+=m[r.CHAR_DATA_CHAR_INDEX].length-1,o-=m[r.CHAR_DATA_CHAR_INDEX].length-1),o--,u--}for(;f<i.length&&s+1<n.length&&!this._isCharWordSeparator(i[f+1]);){var m;2===(m=i[f+1])[r.CHAR_DATA_WIDTH_INDEX]?(_++,f++):m[r.CHAR_DATA_CHAR_INDEX].length>1&&(c+=m[r.CHAR_DATA_CHAR_INDEX].length-1,s+=m[r.CHAR_DATA_CHAR_INDEX].length-1),s++,f++}}s++;var d=o+l-h+a,p=Math.min(this._terminal.cols,s-o+h+_-a-c);return t||""!==n.slice(o,s).trim()?{start:d,length:p}:null},u.prototype._selectWordAt=function(e,t){var i=this._getWordAt(e,t);i&&(this._model.selectionStart=[i.start,e[1]],this._model.selectionStartLength=i.length)},u.prototype._selectToWordAt=function(e){var t=this._getWordAt(e,!0);t&&(this._model.selectionEnd=[this._model.areSelectionValuesReversed()?t.start:t.start+t.length,e[1]])},u.prototype._isCharWordSeparator=function(e){return 0!==e[r.CHAR_DATA_WIDTH_INDEX]&&c.indexOf(e[r.CHAR_DATA_CHAR_INDEX])>=0},u.prototype._selectLineAt=function(e){this._model.selectionStart=[0,e],this._model.selectionStartLength=this._terminal.cols},u}(n.EventEmitter);exports.SelectionManager=m;
},{"./utils/MouseHelper":33,"./shared/utils/Browser":48,"./EventEmitter":19,"./SelectionModel":144,"./Buffer":17,"./handlers/AltClickHandler":146}],31:[function(require,module,exports) {
"use strict";var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../EventEmitter"),n=function(t){function n(e,n){var r=t.call(this)||this;return r._document=e,r._parentElement=n,r._measureElement=r._document.createElement("span"),r._measureElement.classList.add("xterm-char-measure-element"),r._measureElement.textContent="W",r._measureElement.setAttribute("aria-hidden","true"),r._parentElement.appendChild(r._measureElement),r}return e(n,t),Object.defineProperty(n.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),n.prototype.measure=function(e){this._measureElement.style.fontFamily=e.fontFamily,this._measureElement.style.fontSize=e.fontSize+"px";var t=this._measureElement.getBoundingClientRect();0!==t.width&&0!==t.height&&(this._width===t.width&&this._height===t.height||(this._width=t.width,this._height=Math.ceil(t.height),this.emit("charsizechanged")))},n}(t.EventEmitter);exports.CharMeasure=n;
},{"../EventEmitter":19}],32:[function(require,module,exports) {
"use strict";function e(e,t,n,s){return e.addEventListener(t,n,s),{dispose:function(){n&&(e.removeEventListener(t,n,s),e=null,n=null)}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.addDisposableListener=e;
},{}],26:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.blankLine="Blank line",exports.promptLabel="Terminal input",exports.tooMuchOutput="Too much output to announce, navigate to rows manually to read";
},{}],34:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.clone=function(r,e){if(void 0===e&&(e=5),"object"!=typeof r)return r;if(null===r)return null;var t=Array.isArray(r)?[]:{};for(var o in r)t[o]=e<=1?r[o]:exports.clone(r[o],e-1);return t};
},{}],27:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEFAULT_BELL_SOUND="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAADpAFgCwAMlBZoG/wdmCcoKRAypDQ8PbRDBEQQTOxRtFYcWlBePGIUZXhoiG88bcBz7HHIdzh0WHlMeZx51HmkeUx4WHs8dah0AHXwc3hs9G4saxRnyGBIYGBcQFv8U4RPAEoYRQBACD70NWwwHC6gJOwjWBloF7gOBAhABkf8b/qv8R/ve+Xf4Ife79W/0JfPZ8Z/wde9N7ijtE+wU6xvqM+lb6H7nw+YX5mrlxuQz5Mzje+Ma49fioeKD4nXiYeJy4pHitOL04j/jn+MN5IPkFOWs5U3mDefM55/ogOl36m7rdOyE7abuyu8D8Unyj/Pg9D/2qfcb+Yn6/vuK/Qj/lAAlAg==";var e=function(){function e(e){this._terminal=e}return e.prototype.playBellSound=function(){var e=window.AudioContext||window.webkitAudioContext;if(!this._audioContext&&e&&(this._audioContext=new e),this._audioContext){var t=this._audioContext.createBufferSource(),o=this._audioContext;this._audioContext.decodeAudioData(this._base64ToArrayBuffer(this._removeMimeType(this._terminal.options.bellSound)),function(e){t.buffer=e,t.connect(o.destination),t.start(0)})}else console.warn("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version")},e.prototype._base64ToArrayBuffer=function(e){for(var t=window.atob(e),o=t.length,n=new Uint8Array(o),i=0;i<o;i++)n[i]=t.charCodeAt(i);return n.buffer},e.prototype._removeMimeType=function(e){return e.split(",")[1]},e}();exports.SoundManager=e;
},{}],28:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./Strings"),t=require("./shared/utils/Browser"),i=require("./utils/RenderDebouncer"),s=require("./utils/Dom"),n=20,r=function(){function r(e){var t=this;this._terminal=e,this._liveRegionLineCount=0,this._disposables=[],this._charsToConsume=[],this._accessibilityTreeRoot=document.createElement("div"),this._accessibilityTreeRoot.classList.add("xterm-accessibility"),this._rowContainer=document.createElement("div"),this._rowContainer.classList.add("xterm-accessibility-tree"),this._rowElements=[];for(var n=0;n<this._terminal.rows;n++)this._rowElements[n]=this._createAccessibilityTreeNode(),this._rowContainer.appendChild(this._rowElements[n]);this._topBoundaryFocusListener=function(e){return t._onBoundaryFocus(e,0)},this._bottomBoundaryFocusListener=function(e){return t._onBoundaryFocus(e,1)},this._rowElements[0].addEventListener("focus",this._topBoundaryFocusListener),this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._refreshRowsDimensions(),this._accessibilityTreeRoot.appendChild(this._rowContainer),this._renderRowsDebouncer=new i.RenderDebouncer(this._terminal,this._renderRows.bind(this)),this._refreshRows(),this._liveRegion=document.createElement("div"),this._liveRegion.classList.add("live-region"),this._liveRegion.setAttribute("aria-live","assertive"),this._accessibilityTreeRoot.appendChild(this._liveRegion),this._terminal.element.insertAdjacentElement("afterbegin",this._accessibilityTreeRoot),this._disposables.push(this._renderRowsDebouncer),this._disposables.push(this._terminal.addDisposableListener("resize",function(e){return t._onResize(e.cols,e.rows)})),this._disposables.push(this._terminal.addDisposableListener("refresh",function(e){return t._refreshRows(e.start,e.end)})),this._disposables.push(this._terminal.addDisposableListener("scroll",function(e){return t._refreshRows()})),this._disposables.push(this._terminal.addDisposableListener("a11y.char",function(e){return t._onChar(e)})),this._disposables.push(this._terminal.addDisposableListener("linefeed",function(){return t._onChar("\n")})),this._disposables.push(this._terminal.addDisposableListener("a11y.tab",function(e){return t._onTab(e)})),this._disposables.push(this._terminal.addDisposableListener("key",function(e){return t._onKey(e)})),this._disposables.push(this._terminal.addDisposableListener("blur",function(){return t._clearLiveRegion()})),this._disposables.push(this._terminal.addDisposableListener("dprchange",function(){return t._refreshRowsDimensions()})),this._disposables.push(this._terminal.renderer.addDisposableListener("resize",function(){return t._refreshRowsDimensions()})),this._disposables.push(s.addDisposableListener(window,"resize",function(){return t._refreshRowsDimensions()}))}return r.prototype.dispose=function(){this._disposables.forEach(function(e){return e.dispose()}),this._disposables.length=0,this._terminal.element.removeChild(this._accessibilityTreeRoot),this._rowElements.length=0},r.prototype._onBoundaryFocus=function(e,t){var i=e.target,s=this._rowElements[0===t?1:this._rowElements.length-2];if(i.getAttribute("aria-posinset")!==(0===t?"1":""+this._terminal.buffer.lines.length)&&e.relatedTarget===s){var n,r;if(0===t?(n=i,r=this._rowElements.pop(),this._rowContainer.removeChild(r)):(n=this._rowElements.shift(),r=i,this._rowContainer.removeChild(n)),n.removeEventListener("focus",this._topBoundaryFocusListener),r.removeEventListener("focus",this._bottomBoundaryFocusListener),0===t){var o=this._createAccessibilityTreeNode();this._rowElements.unshift(o),this._rowContainer.insertAdjacentElement("afterbegin",o)}else{o=this._createAccessibilityTreeNode();this._rowElements.push(o),this._rowContainer.appendChild(o)}this._rowElements[0].addEventListener("focus",this._topBoundaryFocusListener),this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._terminal.scrollLines(0===t?-1:1),this._rowElements[0===t?1:this._rowElements.length-2].focus(),e.preventDefault(),e.stopImmediatePropagation()}},r.prototype._onResize=function(e,t){this._rowElements[this._rowElements.length-1].removeEventListener("focus",this._bottomBoundaryFocusListener);for(var i=this._rowContainer.children.length;i<this._terminal.rows;i++)this._rowElements[i]=this._createAccessibilityTreeNode(),this._rowContainer.appendChild(this._rowElements[i]);for(;this._rowElements.length>t;)this._rowContainer.removeChild(this._rowElements.pop());this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._refreshRowsDimensions()},r.prototype._createAccessibilityTreeNode=function(){var e=document.createElement("div");return e.setAttribute("role","listitem"),e.tabIndex=-1,this._refreshRowDimensions(e),e},r.prototype._onTab=function(e){for(var t=0;t<e;t++)this._onChar(" ")},r.prototype._onChar=function(i){var s=this;if(this._liveRegionLineCount<n+1){if(this._charsToConsume.length>0)this._charsToConsume.shift()!==i&&this._announceCharacter(i);else this._announceCharacter(i);"\n"===i&&(this._liveRegionLineCount++,this._liveRegionLineCount===n+1&&(this._liveRegion.textContent+=e.tooMuchOutput)),t.isMac&&this._liveRegion.textContent&&this._liveRegion.textContent.length>0&&!this._liveRegion.parentNode&&setTimeout(function(){s._accessibilityTreeRoot.appendChild(s._liveRegion)},0)}},r.prototype._clearLiveRegion=function(){this._liveRegion.textContent="",this._liveRegionLineCount=0,t.isMac&&this._liveRegion.parentNode&&this._accessibilityTreeRoot.removeChild(this._liveRegion)},r.prototype._onKey=function(e){this._clearLiveRegion(),this._charsToConsume.push(e)},r.prototype._refreshRows=function(e,t){this._renderRowsDebouncer.refresh(e,t)},r.prototype._renderRows=function(t,i){for(var s=this._terminal.buffer,n=s.lines.length.toString(),r=t;r<=i;r++){var o=s.translateBufferLineToString(s.ydisp+r,!0),h=(s.ydisp+r+1).toString(),a=this._rowElements[r];a.textContent=0===o.length?e.blankLine:o,a.setAttribute("aria-posinset",h),a.setAttribute("aria-setsize",n)}},r.prototype._refreshRowsDimensions=function(){if(this._terminal.renderer.dimensions.actualCellHeight)for(var e=0;e<this._terminal.rows;e++)this._refreshRowDimensions(this._rowElements[e])},r.prototype._refreshRowDimensions=function(e){e.style.height=this._terminal.renderer.dimensions.actualCellHeight+"px"},r.prototype._announceCharacter=function(e){" "===e?this._liveRegion.innerHTML+="&nbsp;":this._liveRegion.textContent+=e},r}();exports.AccessibilityManager=r;
},{"./Strings":26,"./shared/utils/Browser":48,"./utils/RenderDebouncer":147,"./utils/Dom":32}],9:[function(require,module,exports) {
"use strict";var e=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./BufferSet"),r=require("./Buffer"),i=require("./CompositionHelper"),s=require("./EventEmitter"),n=require("./Viewport"),o=require("./handlers/Clipboard"),a=require("./EscapeSequences"),h=require("./InputHandler"),l=require("./Parser"),c=require("./renderer/Renderer"),u=require("./Linkifier"),f=require("./SelectionManager"),p=require("./utils/CharMeasure"),d=require("./shared/utils/Browser"),y=require("./utils/Dom"),C=require("./Strings"),b=require("./utils/MouseHelper"),m=require("./utils/Clone"),k=require("./SoundManager"),w=require("./renderer/ColorManager"),v=require("./input/MouseZoneManager"),S=require("./AccessibilityManager"),g=require("./utils/ScreenDprMonitor"),_=require("./renderer/atlas/CharAtlasCache"),E={48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"']},M="undefined"!=typeof window?window.document:null,x=5,L=300,A={cols:80,rows:24,convertEol:!1,termName:"xterm",cursorBlink:!1,cursorStyle:"block",bellSound:k.DEFAULT_BELL_SOUND,bellStyle:"none",drawBoldTextInBrightColors:!0,enableBold:!0,experimentalCharAtlas:"static",fontFamily:"courier-new, courier, monospace",fontSize:15,fontWeight:"normal",fontWeightBold:"bold",lineHeight:1,letterSpacing:0,scrollback:1e3,screenKeys:!1,screenReaderMode:!1,debug:!1,macOptionIsMeta:!1,cancelEvents:!1,disableStdin:!1,useFlowControl:!1,allowTransparency:!1,tabStopWidth:8,theme:null,rightClickSelectsWord:d.isMac},T=function(s){function w(e){void 0===e&&(e={});var t=s.call(this)||this;return t.browser=d,t.options=m.clone(e),t._setup(),t}return e(w,s),w.prototype.dispose=function(){s.prototype.dispose.call(this),this._disposables.forEach(function(e){return e.dispose()}),this._disposables.length=0,_.removeTerminalFromCache(this),this.handler=function(){},this.write=function(){},this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},w.prototype.destroy=function(){this.dispose()},w.prototype._setup=function(){var e=this;this._disposables=[],Object.keys(A).forEach(function(t){null==e.options[t]&&(e.options[t]=A[t]),e[t]=e.options[t]}),this._parent=M?M.body:null,this.cols=this.options.cols,this.rows=this.options.rows,this.options.handler&&this.on("data",this.options.handler),this.cursorState=0,this.cursorHidden=!1,this._sendDataQueue="",this._customKeyEventHandler=null,this.applicationKeypad=!1,this.applicationCursor=!1,this.originMode=!1,this.insertMode=!1,this.wraparoundMode=!0,this.bracketedPasteMode=!1,this.charset=null,this.gcharset=null,this.glevel=0,this.charsets=[null],this.defAttr=131840,this.curAttr=131840,this.params=[],this.currentParam=0,this.prefix="",this.postfix="",this.writeBuffer=[],this._writeInProgress=!1,this._xoffSentToCatchUp=!1,this._userScrolling=!1,this._inputHandler=new h.InputHandler(this),this._parser=new l.Parser(this._inputHandler,this),this.renderer=this.renderer||null,this.selectionManager=this.selectionManager||null,this.linkifier=this.linkifier||new u.Linkifier(this),this._mouseZoneManager=this._mouseZoneManager||null,this.soundManager=this.soundManager||new k.SoundManager(this),this.buffers=new t.BufferSet(this),this.selectionManager&&(this.selectionManager.clearSelection(),this.selectionManager.initBuffersListeners())},Object.defineProperty(w.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!0,configurable:!0}),Object.defineProperty(w,"strings",{get:function(){return C},enumerable:!0,configurable:!0}),w.prototype.eraseAttr=function(){return-512&this.defAttr|511&this.curAttr},w.prototype.focus=function(){this.textarea&&this.textarea.focus()},Object.defineProperty(w.prototype,"isFocused",{get:function(){return M.activeElement===this.textarea},enumerable:!0,configurable:!0}),w.prototype.getOption=function(e){if(!(e in A))throw new Error('No option with key "'+e+'"');return void 0!==this.options[e]?this.options[e]:this[e]},w.prototype.setOption=function(e,t){if(!(e in A))throw new Error('No option with key "'+e+'"');switch(e){case"bellStyle":t||(t="none");break;case"cursorStyle":t||(t="block");break;case"fontWeight":t||(t="normal");break;case"fontWeightBold":t||(t="bold");break;case"lineHeight":if(t<1)return void console.warn(e+" cannot be less than 1, value: "+t);case"tabStopWidth":if(t<1)return void console.warn(e+" cannot be less than 1, value: "+t);break;case"theme":if(this.renderer)return void this._setTheme(t);break;case"scrollback":if((t=Math.min(t,r.MAX_BUFFER_SIZE))<0)return void console.warn(e+" cannot be less than 0, value: "+t);if(this.options[e]!==t){var i=this.rows+t;if(this.buffer.lines.length>i){var s=this.buffer.lines.length-i,n=this.buffer.ydisp-s<0;this.buffer.lines.trimStart(s),this.buffer.ybase=Math.max(this.buffer.ybase-s,0),this.buffer.ydisp=Math.max(this.buffer.ydisp-s,0),n&&this.refresh(0,this.rows-1)}}}switch(this[e]=t,this.options[e]=t,e){case"fontFamily":case"fontSize":this.renderer&&(this.renderer.clear(),this.charMeasure.measure(this.options));break;case"experimentalCharAtlas":case"enableBold":case"letterSpacing":case"lineHeight":case"fontWeight":case"fontWeightBold":this.renderer&&(this.renderer.clear(),this.renderer.onResize(this.cols,this.rows),this.refresh(0,this.rows-1));case"scrollback":this.buffers.resize(this.cols,this.rows),this.viewport&&this.viewport.syncScrollArea();break;case"screenReaderMode":t?this._accessibilityManager||(this._accessibilityManager=new S.AccessibilityManager(this)):this._accessibilityManager&&(this._accessibilityManager.dispose(),this._accessibilityManager=null);break;case"tabStopWidth":this.buffers.setupTabStops()}this.renderer&&this.renderer.onOptionsChanged()},w.prototype._onTextAreaFocus=function(){this.sendFocus&&this.send(a.C0.ESC+"[I"),this.element.classList.add("focus"),this.showCursor(),this.emit("focus")},w.prototype.blur=function(){return this.textarea.blur()},w.prototype._onTextAreaBlur=function(){this.textarea.value="",this.refresh(this.buffer.y,this.buffer.y),this.sendFocus&&this.send(a.C0.ESC+"[O"),this.element.classList.remove("focus"),this.emit("blur")},w.prototype._initGlobal=function(){var e=this;this._bindKeys(),B(this.element,"copy",function(t){e.hasSelection()&&o.copyHandler(t,e,e.selectionManager)});var t=function(t){return o.pasteHandler(t,e)};B(this.textarea,"paste",t),B(this.element,"paste",t),d.isFirefox?B(this.element,"mousedown",function(t){2===t.button&&o.rightClickHandler(t,e.textarea,e.selectionManager,e.options.rightClickSelectsWord)}):B(this.element,"contextmenu",function(t){o.rightClickHandler(t,e.textarea,e.selectionManager,e.options.rightClickSelectsWord)}),d.isLinux&&B(this.element,"auxclick",function(t){1===t.button&&o.moveTextAreaUnderMouseCursor(t,e.textarea)})},w.prototype._bindKeys=function(){var e=this,t=this;B(this.element,"keydown",function(e){M.activeElement===this&&t._keyDown(e)},!0),B(this.element,"keypress",function(e){M.activeElement===this&&t._keyPress(e)},!0),B(this.element,"keyup",function(t){D(t)||e.focus()},!0),B(this.textarea,"keydown",function(t){return e._keyDown(t)},!0),B(this.textarea,"keypress",function(t){return e._keyPress(t)},!0),B(this.textarea,"compositionstart",function(){return e._compositionHelper.compositionstart()}),B(this.textarea,"compositionupdate",function(t){return e._compositionHelper.compositionupdate(t)}),B(this.textarea,"compositionend",function(){return e._compositionHelper.compositionend()}),this.on("refresh",function(){return e._compositionHelper.updateCompositionElements()}),this.on("refresh",function(t){return e._queueLinkification(t.start,t.end)})},w.prototype.open=function(e){var t=this;if(this._parent=e||this._parent,!this._parent)throw new Error("Terminal requires a parent element.");this._context=this._parent.ownerDocument.defaultView,this._document=this._parent.ownerDocument,this._screenDprMonitor=new g.ScreenDprMonitor,this._screenDprMonitor.setListener(function(){return t.emit("dprchange",window.devicePixelRatio)}),this.element=this._document.createElement("div"),this.element.dir="ltr",this.element.classList.add("terminal"),this.element.classList.add("xterm"),this.element.setAttribute("tabindex","0"),this._parent.appendChild(this.element);var r=M.createDocumentFragment();this._viewportElement=M.createElement("div"),this._viewportElement.classList.add("xterm-viewport"),r.appendChild(this._viewportElement),this._viewportScrollArea=M.createElement("div"),this._viewportScrollArea.classList.add("xterm-scroll-area"),this._viewportElement.appendChild(this._viewportScrollArea),this.screenElement=M.createElement("div"),this.screenElement.classList.add("xterm-screen"),this._helperContainer=M.createElement("div"),this._helperContainer.classList.add("xterm-helpers"),this.screenElement.appendChild(this._helperContainer),r.appendChild(this.screenElement),this._mouseZoneManager=new v.MouseZoneManager(this),this.on("scroll",function(){return t._mouseZoneManager.clearAll()}),this.linkifier.attachToDom(this._mouseZoneManager),this.textarea=M.createElement("textarea"),this.textarea.classList.add("xterm-helper-textarea"),this.textarea.setAttribute("aria-label",C.promptLabel),this.textarea.setAttribute("aria-multiline","false"),this.textarea.setAttribute("autocorrect","off"),this.textarea.setAttribute("autocapitalize","off"),this.textarea.setAttribute("spellcheck","false"),this.textarea.tabIndex=0,this.textarea.addEventListener("focus",function(){return t._onTextAreaFocus()}),this.textarea.addEventListener("blur",function(){return t._onTextAreaBlur()}),this._helperContainer.appendChild(this.textarea),this._compositionView=M.createElement("div"),this._compositionView.classList.add("composition-view"),this._compositionHelper=new i.CompositionHelper(this.textarea,this._compositionView,this),this._helperContainer.appendChild(this._compositionView),this.charMeasure=new p.CharMeasure(M,this._helperContainer),this.element.appendChild(r),this.renderer=new c.Renderer(this,this.options.theme),this.options.theme=null,this.viewport=new n.Viewport(this,this._viewportElement,this._viewportScrollArea,this.charMeasure),this.viewport.onThemeChanged(this.renderer.colorManager.colors),this.on("cursormove",function(){return t.renderer.onCursorMove()}),this.on("resize",function(){return t.renderer.onResize(t.cols,t.rows)}),this.on("blur",function(){return t.renderer.onBlur()}),this.on("focus",function(){return t.renderer.onFocus()}),this.on("dprchange",function(){return t.renderer.onWindowResize(window.devicePixelRatio)}),this._disposables.push(y.addDisposableListener(window,"resize",function(){return t.renderer.onWindowResize(window.devicePixelRatio)})),this.charMeasure.on("charsizechanged",function(){return t.renderer.onResize(t.cols,t.rows)}),this.renderer.on("resize",function(e){return t.viewport.syncScrollArea()}),this.selectionManager=new f.SelectionManager(this,this.charMeasure),this.element.addEventListener("mousedown",function(e){return t.selectionManager.onMouseDown(e)}),this.selectionManager.on("refresh",function(e){return t.renderer.onSelectionChanged(e.start,e.end)}),this.selectionManager.on("newselection",function(e){t.textarea.value=e,t.textarea.focus(),t.textarea.select()}),this.on("scroll",function(){t.viewport.syncScrollArea(),t.selectionManager.refresh()}),this._viewportElement.addEventListener("scroll",function(){return t.selectionManager.refresh()}),this.mouseHelper=new b.MouseHelper(this.renderer),this.options.screenReaderMode&&(this._accessibilityManager=new S.AccessibilityManager(this)),this.charMeasure.measure(this.options),this.refresh(0,this.rows-1),this._initGlobal(),this.bindMouse()},w.prototype._setTheme=function(e){var t=this.renderer.setTheme(e);this.viewport&&this.viewport.onThemeChanged(t)},w.applyAddon=function(e){e.apply(w)},w.prototype.bindMouse=function(){var e=this,t=this.element,r=this,i=32;function s(e){var t,s;if(t=function(e){var t,i,s,n,o;switch(e.overrideType||e.type){case"mousedown":t=null!=e.button?+e.button:null!=e.which?e.which-1:null,d.isMSIE&&(t=1===t?0:4===t?1:t);break;case"mouseup":t=3;break;case"DOMMouseScroll":t=e.detail<0?64:65;break;case"wheel":t=e.wheelDeltaY>0?64:65}i=e.shiftKey?4:0,s=e.metaKey?8:0,n=e.ctrlKey?16:0,o=i|s|n,r.vt200Mouse?o&=n:r.normalMouse||(o=0);return t=32+(o<<2)+t}(e),s=r.mouseHelper.getRawByteCoords(e,r.screenElement,r.charMeasure,r.options.lineHeight,r.cols,r.rows))switch(h(t,s),e.overrideType||e.type){case"mousedown":i=t;break;case"mouseup":i=32}}function n(e){var t=i,s=r.mouseHelper.getRawByteCoords(e,r.screenElement,r.charMeasure,r.options.lineHeight,r.cols,r.rows);s&&h(t+=32,s)}function o(e,t){if(r.utfMouse){if(2047===t)return void e.push(0);t<127?e.push(t):(t>2047&&(t=2047),e.push(192|t>>6),e.push(128|63&t))}else{if(255===t)return void e.push(0);t>127&&(t=127),e.push(t)}}function h(e,t){if(r._vt300Mouse){e&=3,t.x-=32,t.y-=32;var i=a.C0.ESC+"[24";if(0===e)i+="1";else if(1===e)i+="3";else if(2===e)i+="5";else{if(3===e)return;i+="0"}return i+="~["+t.x+","+t.y+"]\r",void r.send(i)}if(r._decLocator)return e&=3,t.x-=32,t.y-=32,0===e?e=2:1===e?e=4:2===e?e=6:3===e&&(e=3),void r.send(a.C0.ESC+"["+e+";"+(3===e?4:0)+";"+t.y+";"+t.x+";"+t.page||"0&w");if(r.urxvtMouse)return t.x-=32,t.y-=32,t.x++,t.y++,void r.send(a.C0.ESC+"["+e+";"+t.x+";"+t.y+"M");if(r.sgrMouse)return t.x-=32,t.y-=32,void r.send(a.C0.ESC+"[<"+((3==(3&e)?-4&e:e)-32)+";"+t.x+";"+t.y+(3==(3&e)?"m":"M"));var s=[];o(s,e),o(s,t.x),o(s,t.y),r.send(a.C0.ESC+"[M"+String.fromCharCode.apply(String,s))}B(t,"mousedown",function(t){if(t.preventDefault(),e.focus(),e.mouseEvents&&!e.selectionManager.shouldForceSelection(t)){if(s(t),e.vt200Mouse)return t.overrideType="mouseup",s(t),e.cancel(t);if(e.normalMouse&&B(e._document,"mousemove",n),!e.x10Mouse){var r=function(t){return s(t),e.normalMouse&&H(e._document,"mousemove",n),H(e._document,"mouseup",r),e.cancel(t)};B(e._document,"mouseup",r)}return e.cancel(t)}}),B(t,"wheel",function(t){if(e.mouseEvents)e.x10Mouse||e._vt300Mouse||e._decLocator||(s(t),t.preventDefault());else if(!e.buffer.hasScrollback){var r=e.viewport.getLinesScrolled(t);if(0===r)return;for(var i=a.C0.ESC+(e.applicationCursor?"O":"[")+(t.deltaY<0?"A":"B"),n="",o=0;o<Math.abs(r);o++)n+=i;e.send(n)}}),B(t,"wheel",function(t){if(!e.mouseEvents)return e.viewport.onWheel(t),e.cancel(t)}),B(t,"touchstart",function(t){if(!e.mouseEvents)return e.viewport.onTouchStart(t),e.cancel(t)}),B(t,"touchmove",function(t){if(!e.mouseEvents)return e.viewport.onTouchMove(t),e.cancel(t)})},w.prototype.refresh=function(e,t){this.renderer&&this.renderer.refreshRows(e,t)},w.prototype._queueLinkification=function(e,t){this.linkifier&&this.linkifier.linkifyRows(e,t)},w.prototype.showCursor=function(){this.cursorState||(this.cursorState=1,this.refresh(this.buffer.y,this.buffer.y))},w.prototype.scroll=function(e){var t=this.blankLine(void 0,e),r=this.buffer.ybase+this.buffer.scrollTop,i=this.buffer.ybase+this.buffer.scrollBottom;if(0===this.buffer.scrollTop){var s=this.buffer.lines.length===this.buffer.lines.maxLength;i===this.buffer.lines.length-1?this.buffer.lines.push(t):this.buffer.lines.splice(i+1,0,t),s?this._userScrolling&&(this.buffer.ydisp=Math.max(this.buffer.ydisp-1,0)):(this.buffer.ybase++,this._userScrolling||this.buffer.ydisp++)}else{var n=i-r+1;this.buffer.lines.shiftElements(r+1,n-1,-1),this.buffer.lines.set(i,t)}this._userScrolling||(this.buffer.ydisp=this.buffer.ybase),this.updateRange(this.buffer.scrollTop),this.updateRange(this.buffer.scrollBottom),this.emit("scroll",this.buffer.ydisp)},w.prototype.scrollLines=function(e,t){if(e<0){if(0===this.buffer.ydisp)return;this._userScrolling=!0}else e+this.buffer.ydisp>=this.buffer.ybase&&(this._userScrolling=!1);var r=this.buffer.ydisp;this.buffer.ydisp=Math.max(Math.min(this.buffer.ydisp+e,this.buffer.ybase),0),r!==this.buffer.ydisp&&(t||this.emit("scroll",this.buffer.ydisp),this.refresh(0,this.rows-1))},w.prototype.scrollPages=function(e){this.scrollLines(e*(this.rows-1))},w.prototype.scrollToTop=function(){this.scrollLines(-this.buffer.ydisp)},w.prototype.scrollToBottom=function(){this.scrollLines(this.buffer.ybase-this.buffer.ydisp)},w.prototype.scrollToLine=function(e){var t=e-this.buffer.ydisp;0!==t&&this.scrollLines(t)},w.prototype.write=function(e){var t=this;e&&(this.writeBuffer.push(e),this.options.useFlowControl&&!this._xoffSentToCatchUp&&this.writeBuffer.length>=x&&(this.send(a.C0.DC3),this._xoffSentToCatchUp=!0),!this._writeInProgress&&this.writeBuffer.length>0&&(this._writeInProgress=!0,setTimeout(function(){t._innerWrite()})))},w.prototype._innerWrite=function(){for(var e=this,t=this.writeBuffer.splice(0,L);t.length>0;){var r=t.shift();this._xoffSentToCatchUp&&0===t.length&&0===this.writeBuffer.length&&(this.send(a.C0.DC1),this._xoffSentToCatchUp=!1),this._refreshStart=this.buffer.y,this._refreshEnd=this.buffer.y;var i=this._parser.parse(r);this._parser.setState(i),this.updateRange(this.buffer.y),this.refresh(this._refreshStart,this._refreshEnd)}this.writeBuffer.length>0?setTimeout(function(){return e._innerWrite()},0):this._writeInProgress=!1},w.prototype.writeln=function(e){this.write(e+"\r\n")},w.prototype.attachCustomKeyEventHandler=function(e){this._customKeyEventHandler=e},w.prototype.registerLinkMatcher=function(e,t,r){var i=this.linkifier.registerLinkMatcher(e,t,r);return this.refresh(0,this.rows-1),i},w.prototype.deregisterLinkMatcher=function(e){this.linkifier.deregisterLinkMatcher(e)&&this.refresh(0,this.rows-1)},Object.defineProperty(w.prototype,"markers",{get:function(){return this.buffer.markers},enumerable:!0,configurable:!0}),w.prototype.addMarker=function(e){if(this.buffer===this.buffers.normal)return this.buffer.addMarker(this.buffer.ybase+this.buffer.y+e)},w.prototype.hasSelection=function(){return!!this.selectionManager&&this.selectionManager.hasSelection},w.prototype.getSelection=function(){return this.selectionManager?this.selectionManager.selectionText:""},w.prototype.clearSelection=function(){this.selectionManager&&this.selectionManager.clearSelection()},w.prototype.selectAll=function(){this.selectionManager&&this.selectionManager.selectAll()},w.prototype.selectLines=function(e,t){this.selectionManager&&this.selectionManager.selectLines(e,t)},w.prototype._keyDown=function(e){if(this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(!this._compositionHelper.keydown(e))return this.buffer.ybase!==this.buffer.ydisp&&this.scrollToBottom(),!1;var t=this._evaluateKeyEscapeSequence(e);return t.scrollLines?(this.scrollLines(t.scrollLines),this.cancel(e,!0)):!!this._isThirdLevelShift(this.browser,e)||(t.cancel&&this.cancel(e,!0),!t.key||(this.emit("keydown",e),this.emit("key",t.key,e),this.showCursor(),this.handler(t.key),this.cancel(e,!0)))},w.prototype._isThirdLevelShift=function(e,t){var r=e.isMac&&!this.options.macOptionIsMeta&&t.altKey&&!t.ctrlKey&&!t.metaKey||e.isMSWindows&&t.altKey&&t.ctrlKey&&!t.metaKey;return"keypress"===t.type?r:r&&(!t.keyCode||t.keyCode>47)},w.prototype._evaluateKeyEscapeSequence=function(e){var t={cancel:!1,key:void 0,scrollLines:void 0},r=(e.shiftKey?1:0)|(e.altKey?2:0)|(e.ctrlKey?4:0)|(e.metaKey?8:0);switch(e.keyCode){case 0:"UIKeyInputUpArrow"===e.key?this.applicationCursor?t.key=a.C0.ESC+"OA":t.key=a.C0.ESC+"[A":"UIKeyInputLeftArrow"===e.key?this.applicationCursor?t.key=a.C0.ESC+"OD":t.key=a.C0.ESC+"[D":"UIKeyInputRightArrow"===e.key?this.applicationCursor?t.key=a.C0.ESC+"OC":t.key=a.C0.ESC+"[C":"UIKeyInputDownArrow"===e.key&&(this.applicationCursor?t.key=a.C0.ESC+"OB":t.key=a.C0.ESC+"[B");break;case 8:if(e.shiftKey){t.key=a.C0.BS;break}if(e.altKey){t.key=a.C0.ESC+a.C0.DEL;break}t.key=a.C0.DEL;break;case 9:if(e.shiftKey){t.key=a.C0.ESC+"[Z";break}t.key=a.C0.HT,t.cancel=!0;break;case 13:t.key=a.C0.CR,t.cancel=!0;break;case 27:t.key=a.C0.ESC,t.cancel=!0;break;case 37:r?(t.key=a.C0.ESC+"[1;"+(r+1)+"D",t.key===a.C0.ESC+"[1;3D"&&(t.key=this.browser.isMac?a.C0.ESC+"b":a.C0.ESC+"[1;5D")):this.applicationCursor?t.key=a.C0.ESC+"OD":t.key=a.C0.ESC+"[D";break;case 39:r?(t.key=a.C0.ESC+"[1;"+(r+1)+"C",t.key===a.C0.ESC+"[1;3C"&&(t.key=this.browser.isMac?a.C0.ESC+"f":a.C0.ESC+"[1;5C")):this.applicationCursor?t.key=a.C0.ESC+"OC":t.key=a.C0.ESC+"[C";break;case 38:r?(t.key=a.C0.ESC+"[1;"+(r+1)+"A",t.key===a.C0.ESC+"[1;3A"&&(t.key=a.C0.ESC+"[1;5A")):this.applicationCursor?t.key=a.C0.ESC+"OA":t.key=a.C0.ESC+"[A";break;case 40:r?(t.key=a.C0.ESC+"[1;"+(r+1)+"B",t.key===a.C0.ESC+"[1;3B"&&(t.key=a.C0.ESC+"[1;5B")):this.applicationCursor?t.key=a.C0.ESC+"OB":t.key=a.C0.ESC+"[B";break;case 45:e.shiftKey||e.ctrlKey||(t.key=a.C0.ESC+"[2~");break;case 46:t.key=r?a.C0.ESC+"[3;"+(r+1)+"~":a.C0.ESC+"[3~";break;case 36:r?t.key=a.C0.ESC+"[1;"+(r+1)+"H":this.applicationCursor?t.key=a.C0.ESC+"OH":t.key=a.C0.ESC+"[H";break;case 35:r?t.key=a.C0.ESC+"[1;"+(r+1)+"F":this.applicationCursor?t.key=a.C0.ESC+"OF":t.key=a.C0.ESC+"[F";break;case 33:e.shiftKey?t.scrollLines=-(this.rows-1):t.key=a.C0.ESC+"[5~";break;case 34:e.shiftKey?t.scrollLines=this.rows-1:t.key=a.C0.ESC+"[6~";break;case 112:t.key=r?a.C0.ESC+"[1;"+(r+1)+"P":a.C0.ESC+"OP";break;case 113:t.key=r?a.C0.ESC+"[1;"+(r+1)+"Q":a.C0.ESC+"OQ";break;case 114:t.key=r?a.C0.ESC+"[1;"+(r+1)+"R":a.C0.ESC+"OR";break;case 115:t.key=r?a.C0.ESC+"[1;"+(r+1)+"S":a.C0.ESC+"OS";break;case 116:t.key=r?a.C0.ESC+"[15;"+(r+1)+"~":a.C0.ESC+"[15~";break;case 117:t.key=r?a.C0.ESC+"[17;"+(r+1)+"~":a.C0.ESC+"[17~";break;case 118:t.key=r?a.C0.ESC+"[18;"+(r+1)+"~":a.C0.ESC+"[18~";break;case 119:t.key=r?a.C0.ESC+"[19;"+(r+1)+"~":a.C0.ESC+"[19~";break;case 120:t.key=r?a.C0.ESC+"[20;"+(r+1)+"~":a.C0.ESC+"[20~";break;case 121:t.key=r?a.C0.ESC+"[21;"+(r+1)+"~":a.C0.ESC+"[21~";break;case 122:t.key=r?a.C0.ESC+"[23;"+(r+1)+"~":a.C0.ESC+"[23~";break;case 123:t.key=r?a.C0.ESC+"[24;"+(r+1)+"~":a.C0.ESC+"[24~";break;default:if(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey)if(this.browser.isMac&&!this.options.macOptionIsMeta||!e.altKey||e.metaKey)this.browser.isMac&&!e.altKey&&!e.ctrlKey&&e.metaKey&&65===e.keyCode&&this.selectAll();else{var i=E[e.keyCode],s=i&&i[e.shiftKey?1:0];if(s)t.key=a.C0.ESC+s;else if(e.keyCode>=65&&e.keyCode<=90){var n=e.ctrlKey?e.keyCode-64:e.keyCode+32;t.key=a.C0.ESC+String.fromCharCode(n)}}else e.keyCode>=65&&e.keyCode<=90?t.key=String.fromCharCode(e.keyCode-64):32===e.keyCode?t.key=String.fromCharCode(0):e.keyCode>=51&&e.keyCode<=55?t.key=String.fromCharCode(e.keyCode-51+27):56===e.keyCode?t.key=String.fromCharCode(127):219===e.keyCode?t.key=String.fromCharCode(27):220===e.keyCode?t.key=String.fromCharCode(28):221===e.keyCode&&(t.key=String.fromCharCode(29))}return t},w.prototype.setgLevel=function(e){this.glevel=e,this.charset=this.charsets[e]},w.prototype.setgCharset=function(e,t){this.charsets[e]=t,this.glevel===e&&(this.charset=t)},w.prototype._keyPress=function(e){var t;if(this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(this.cancel(e),e.charCode)t=e.charCode;else if(null==e.which)t=e.keyCode;else{if(0===e.which||0===e.charCode)return!1;t=e.which}return!(!t||(e.altKey||e.ctrlKey||e.metaKey)&&!this._isThirdLevelShift(this.browser,e))&&(t=String.fromCharCode(t),this.emit("keypress",t,e),this.emit("key",t,e),this.showCursor(),this.handler(t),!0)},w.prototype.send=function(e){var t=this;this._sendDataQueue||setTimeout(function(){t.handler(t._sendDataQueue),t._sendDataQueue=""},1),this._sendDataQueue+=e},w.prototype.bell=function(){var e=this;this.emit("bell"),this._soundBell()&&this.soundManager.playBellSound(),this._visualBell()&&(this.element.classList.add("visual-bell-active"),clearTimeout(this._visualBellTimer),this._visualBellTimer=window.setTimeout(function(){e.element.classList.remove("visual-bell-active")},200))},w.prototype.log=function(e,t){this.options.debug&&this._context.console&&this._context.console.log&&this._context.console.log(e,t)},w.prototype.error=function(e,t){this.options.debug&&this._context.console&&this._context.console.error&&this._context.console.error(e,t)},w.prototype.resize=function(e,t){isNaN(e)||isNaN(t)||(e!==this.cols||t!==this.rows?(e<1&&(e=1),t<1&&(t=1),this.buffers.resize(e,t),this.cols=e,this.rows=t,this.buffers.setupTabStops(this.cols),this.charMeasure&&this.charMeasure.measure(this.options),this.refresh(0,this.rows-1),this.emit("resize",{cols:e,rows:t})):!this.charMeasure||this.charMeasure.width&&this.charMeasure.height||this.charMeasure.measure(this.options))},w.prototype.updateRange=function(e){e<this._refreshStart&&(this._refreshStart=e),e>this._refreshEnd&&(this._refreshEnd=e)},w.prototype.maxRange=function(){this._refreshStart=0,this._refreshEnd=this.rows-1},w.prototype.eraseRight=function(e,t){var r=this.buffer.lines.get(this.buffer.ybase+t);if(r){for(var i=[this.eraseAttr()," ",1,32];e<this.cols;e++)r[e]=i;this.updateRange(t)}},w.prototype.eraseLeft=function(e,t){var r=this.buffer.lines.get(this.buffer.ybase+t);if(r){var i=[this.eraseAttr()," ",1,32];for(e++;e--;)r[e]=i;this.updateRange(t)}},w.prototype.clear=function(){if(0!==this.buffer.ybase||0!==this.buffer.y){this.buffer.lines.set(0,this.buffer.lines.get(this.buffer.ybase+this.buffer.y)),this.buffer.lines.length=1,this.buffer.ydisp=0,this.buffer.ybase=0,this.buffer.y=0;for(var e=1;e<this.rows;e++)this.buffer.lines.push(this.blankLine());this.refresh(0,this.rows-1),this.emit("scroll",this.buffer.ydisp)}},w.prototype.eraseLine=function(e){this.eraseRight(0,e)},w.prototype.blankLine=function(e,t,r){var i=[e?this.eraseAttr():this.defAttr," ",1,32],s=[];t&&(s.isWrapped=t),r=r||this.cols;for(var n=0;n<r;n++)s[n]=i;return s},w.prototype.ch=function(e){return e?[this.eraseAttr()," ",1,32]:[this.defAttr," ",1,32]},w.prototype.is=function(e){return 0===(this.options.termName+"").indexOf(e)},w.prototype.handler=function(e){this.options.disableStdin||(this.selectionManager&&this.selectionManager.hasSelection&&this.selectionManager.clearSelection(),this.buffer.ybase!==this.buffer.ydisp&&this.scrollToBottom(),this.emit("data",e))},w.prototype.handleTitle=function(e){this.emit("title",e)},w.prototype.index=function(){this.buffer.y++,this.buffer.y>this.buffer.scrollBottom&&(this.buffer.y--,this.scroll()),this.buffer.x>=this.cols&&this.buffer.x--},w.prototype.reverseIndex=function(){if(this.buffer.y===this.buffer.scrollTop){var e=this.buffer.scrollBottom-this.buffer.scrollTop;this.buffer.lines.shiftElements(this.buffer.y+this.buffer.ybase,e,1),this.buffer.lines.set(this.buffer.y+this.buffer.ybase,this.blankLine(!0)),this.updateRange(this.buffer.scrollTop),this.updateRange(this.buffer.scrollBottom)}else this.buffer.y--},w.prototype.reset=function(){this.options.rows=this.rows,this.options.cols=this.cols;var e=this._customKeyEventHandler,t=this._inputHandler;this._setup(),this._customKeyEventHandler=e,this._inputHandler=t,this.refresh(0,this.rows-1),this.viewport&&this.viewport.syncScrollArea()},w.prototype.tabSet=function(){this.buffer.tabs[this.buffer.x]=!0},w.prototype.cancel=function(e,t){if(this.options.cancelEvents||t)return e.preventDefault(),e.stopPropagation(),!1},w.prototype.matchColor=function(e,t,r){return q(e,t,r)},w.prototype._visualBell=function(){return!1},w.prototype._soundBell=function(){return"sound"===this.options.bellStyle},w}(s.EventEmitter);function K(e,t,r,i){Array.isArray(e)||(e=[e]),e.forEach(function(e){e.addEventListener(t,r,i||!1)})}exports.Terminal=T;var B=K;function H(e,t,r,i){void 0===i&&(i=!1),e.removeEventListener(t,r,i)}function D(e){return 16===e.keyCode||17===e.keyCode||18===e.keyCode}var O={};function R(e,t,r,i,s,n){return Math.pow(30*(e-i),2)+Math.pow(59*(t-s),2)+Math.pow(11*(r-n),2)}function q(e,t,r){var i=e<<16|t<<8|r;if(null!=O[i])return O[i];for(var s,n,o=1/0,a=-1,h=0;h<w.DEFAULT_ANSI_COLORS.length;h++){if(0===(n=R(e,t,r,(s=w.DEFAULT_ANSI_COLORS[h].rgba)>>>24,s>>>16&255,s>>>8&255))){a=h;break}n<o&&(o=n,a=h)}return O[i]=a}
},{"./BufferSet":16,"./Buffer":17,"./CompositionHelper":18,"./EventEmitter":19,"./Viewport":20,"./handlers/Clipboard":29,"./EscapeSequences":21,"./InputHandler":22,"./Parser":23,"./renderer/Renderer":30,"./Linkifier":24,"./SelectionManager":25,"./utils/CharMeasure":31,"./shared/utils/Browser":48,"./utils/Dom":32,"./Strings":26,"./utils/MouseHelper":33,"./utils/Clone":34,"./SoundManager":27,"./renderer/ColorManager":35,"./input/MouseZoneManager":36,"./AccessibilityManager":28,"./utils/ScreenDprMonitor":37,"./renderer/atlas/CharAtlasCache":52}],12:[function(require,module,exports) {
"use strict";function e(e){if(!e.element.parentElement)return null;var t=window.getComputedStyle(e.element.parentElement),r=parseInt(t.getPropertyValue("height")),o=Math.max(0,parseInt(t.getPropertyValue("width"))),n=window.getComputedStyle(e.element),p=r-(parseInt(n.getPropertyValue("padding-top"))+parseInt(n.getPropertyValue("padding-bottom"))),l=o-(parseInt(n.getPropertyValue("padding-right"))+parseInt(n.getPropertyValue("padding-left")))-e.viewport.scrollBarWidth;return{cols:Math.floor(l/e.renderer.dimensions.actualCellWidth),rows:Math.floor(p/e.renderer.dimensions.actualCellHeight)}}function t(t){var r=e(t);r&&(t.rows===r.rows&&t.cols===r.cols||(t.renderer.clear(),t.resize(r.cols,r.rows)))}function r(r){r.prototype.proposeGeometry=function(){return e(this)},r.prototype.fit=function(){t(this)}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.proposeGeometry=e,exports.fit=t,exports.apply=r;
},{}],10:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=exports.stateUrl="bin/vm-state.bin",t=exports.vmStateCache="vm-state",r=exports.molokaiTheme={background:"#1B1D1E",cursor:"#A0A0A0",foreground:"#A0A0A0",black:"#1B1D1E",blue:"#268BD2",brightBlack:"#505354",brightBlue:"#62ADE3",brightCyan:"#94D8E5",brightGreen:"#B7EB46",brightMagenta:"#BFA0FE",brightRed:"#FF5995",brightWhite:"#F8F8F2",brightYellow:"#FEED6C",cyan:"#56C2D6",green:"#82B414 ",magenta:"#8C54FE",red:"#F92672",white:"#CCCCC6",yellow:"#FD971F"},i=exports.defaultEmulatorOptions={memory_size:33554432,vga_memory_size:2097152,bios:{url:"bin/seabios.bin"},vga_bios:{url:"bin/vgabios.bin"},cdrom:{url:"bin/v86-linux.iso"},filesystem:{},disable_mouse:!0,disable_keyboard:!0,autostart:!0};
},{}],111:[function(require,module,exports) {
var global = arguments[3];
var t=arguments[3];!function(t){"use strict";var r,e=Object.prototype,n=e.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag",u="object"==typeof module,h=t.regeneratorRuntime;if(h)u&&(module.exports=h);else{(h=t.regeneratorRuntime=u?module.exports:{}).wrap=w;var s="suspendedStart",f="suspendedYield",l="executing",p="completed",y={},v={};v[i]=function(){return this};var d=Object.getPrototypeOf,g=d&&d(d(P([])));g&&g!==e&&n.call(g,i)&&(v=g);var m=b.prototype=x.prototype=Object.create(v);E.prototype=m.constructor=b,b.constructor=E,b[c]=E.displayName="GeneratorFunction",h.isGeneratorFunction=function(t){var r="function"==typeof t&&t.constructor;return!!r&&(r===E||"GeneratorFunction"===(r.displayName||r.name))},h.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,c in t||(t[c]="GeneratorFunction")),t.prototype=Object.create(m),t},h.awrap=function(t){return{__await:t}},_(j.prototype),j.prototype[a]=function(){return this},h.AsyncIterator=j,h.async=function(t,r,e,n){var o=new j(w(t,r,e,n));return h.isGeneratorFunction(r)?o:o.next().then(function(t){return t.done?t.value:o.next()})},_(m),m[c]="Generator",m[i]=function(){return this},m.toString=function(){return"[object Generator]"},h.keys=function(t){var r=[];for(var e in t)r.push(e);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},h.values=P,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(G),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=r)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function o(n,o){return c.type="throw",c.arg=t,e.next=n,o&&(e.method="next",e.arg=r),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],c=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var u=n.call(a,"catchLoc"),h=n.call(a,"finallyLoc");if(u&&h){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!h)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,r){for(var e=this.tryEntries.length-1;e>=0;--e){var o=this.tryEntries[e];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=r&&r<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=r,i?(this.method="next",this.next=i.finallyLoc,y):this.complete(a)},complete:function(t,r){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&r&&(this.next=r),y},finish:function(t){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.finallyLoc===t)return this.complete(e.completion,e.afterLoc),G(e),y}},catch:function(t){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc===t){var n=e.completion;if("throw"===n.type){var o=n.arg;G(e)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:P(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=r),y}}}function w(t,r,e,n){var o=r&&r.prototype instanceof x?r:x,i=Object.create(o.prototype),a=new N(n||[]);return i._invoke=function(t,r,e){var n=s;return function(o,i){if(n===l)throw new Error("Generator is already running");if(n===p){if("throw"===o)throw i;return F()}for(e.method=o,e.arg=i;;){var a=e.delegate;if(a){var c=O(a,e);if(c){if(c===y)continue;return c}}if("next"===e.method)e.sent=e._sent=e.arg;else if("throw"===e.method){if(n===s)throw n=p,e.arg;e.dispatchException(e.arg)}else"return"===e.method&&e.abrupt("return",e.arg);n=l;var u=L(t,r,e);if("normal"===u.type){if(n=e.done?p:f,u.arg===y)continue;return{value:u.arg,done:e.done}}"throw"===u.type&&(n=p,e.method="throw",e.arg=u.arg)}}}(t,e,a),i}function L(t,r,e){try{return{type:"normal",arg:t.call(r,e)}}catch(t){return{type:"throw",arg:t}}}function x(){}function E(){}function b(){}function _(t){["next","throw","return"].forEach(function(r){t[r]=function(t){return this._invoke(r,t)}})}function j(t){var r;this._invoke=function(e,o){function i(){return new Promise(function(r,i){!function r(e,o,i,a){var c=L(t[e],t,o);if("throw"!==c.type){var u=c.arg,h=u.value;return h&&"object"==typeof h&&n.call(h,"__await")?Promise.resolve(h.__await).then(function(t){r("next",t,i,a)},function(t){r("throw",t,i,a)}):Promise.resolve(h).then(function(t){u.value=t,i(u)},a)}a(c.arg)}(e,o,r,i)})}return r=r?r.then(i,i):i()}}function O(t,e){var n=t.iterator[e.method];if(n===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=r,O(t,e),"throw"===e.method))return y;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var o=L(n,t.iterator,e.arg);if("throw"===o.type)return e.method="throw",e.arg=o.arg,e.delegate=null,y;var i=o.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=r),e.delegate=null,y):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,y)}function k(t){var r={tryLoc:t[0]};1 in t&&(r.catchLoc=t[1]),2 in t&&(r.finallyLoc=t[2],r.afterLoc=t[3]),this.tryEntries.push(r)}function G(t){var r=t.completion||{};r.type="normal",delete r.arg,t.completion=r}function N(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function P(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function e(){for(;++o<t.length;)if(n.call(t,o))return e.value=t[o],e.done=!1,e;return e.value=r,e.done=!0,e};return a.next=a}}return{next:F}}function F(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")());
},{}],84:[function(require,module,exports) {
var e=function(){return this}()||Function("return this")(),r=e.regeneratorRuntime&&Object.getOwnPropertyNames(e).indexOf("regeneratorRuntime")>=0,t=r&&e.regeneratorRuntime;if(e.regeneratorRuntime=void 0,module.exports=require("./runtime"),r)e.regeneratorRuntime=t;else try{delete e.regeneratorRuntime}catch(r){e.regeneratorRuntime=void 0}
},{"./runtime":111}],76:[function(require,module,exports) {
module.exports=require("regenerator-runtime");
},{"regenerator-runtime":84}],77:[function(require,module,exports) {

},{}],112:[function(require,module,exports) {
var o=Math.ceil,r=Math.floor;module.exports=function(t){return isNaN(t=+t)?0:(t>0?r:o)(t)};
},{}],113:[function(require,module,exports) {
module.exports=function(o){if(void 0==o)throw TypeError("Can't call method on  "+o);return o};
},{}],85:[function(require,module,exports) {
var e=require("./_to-integer"),r=require("./_defined");module.exports=function(t){return function(n,i){var o,u,c=String(r(n)),d=e(i),a=c.length;return d<0||d>=a?t?"":void 0:(o=c.charCodeAt(d))<55296||o>56319||d+1===a||(u=c.charCodeAt(d+1))<56320||u>57343?t?c.charAt(d):o:t?c.slice(d,d+2):u-56320+(o-55296<<10)+65536}};
},{"./_to-integer":112,"./_defined":113}],92:[function(require,module,exports) {
module.exports=!0;
},{}],88:[function(require,module,exports) {

var e=module.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e);
},{}],83:[function(require,module,exports) {
var e=module.exports={version:"2.5.7"};"number"==typeof __e&&(__e=e);
},{}],97:[function(require,module,exports) {
module.exports=function(o){if("function"!=typeof o)throw TypeError(o+" is not a function!");return o};
},{}],93:[function(require,module,exports) {
var r=require("./_a-function");module.exports=function(n,t,u){if(r(n),void 0===t)return n;switch(u){case 1:return function(r){return n.call(t,r)};case 2:return function(r,u){return n.call(t,r,u)};case 3:return function(r,u,e){return n.call(t,r,u,e)}}return function(){return n.apply(t,arguments)}};
},{"./_a-function":97}],96:[function(require,module,exports) {
module.exports=function(o){return"object"==typeof o?null!==o:"function"==typeof o};
},{}],129:[function(require,module,exports) {
var r=require("./_is-object");module.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e};
},{"./_is-object":96}],141:[function(require,module,exports) {
module.exports=function(r){try{return!!r()}catch(r){return!0}};
},{}],122:[function(require,module,exports) {
module.exports=!require("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a});
},{"./_fails":141}],134:[function(require,module,exports) {
var e=require("./_is-object"),r=require("./_global").document,t=e(r)&&e(r.createElement);module.exports=function(e){return t?r.createElement(e):{}};
},{"./_is-object":96,"./_global":88}],139:[function(require,module,exports) {
module.exports=!require("./_descriptors")&&!require("./_fails")(function(){return 7!=Object.defineProperty(require("./_dom-create")("div"),"a",{get:function(){return 7}}).a});
},{"./_descriptors":122,"./_fails":141,"./_dom-create":134}],140:[function(require,module,exports) {
var t=require("./_is-object");module.exports=function(r,e){if(!t(r))return r;var o,n;if(e&&"function"==typeof(o=r.toString)&&!t(n=o.call(r)))return n;if("function"==typeof(o=r.valueOf)&&!t(n=o.call(r)))return n;if(!e&&"function"==typeof(o=r.toString)&&!t(n=o.call(r)))return n;throw TypeError("Can't convert object to primitive value")};
},{"./_is-object":96}],120:[function(require,module,exports) {
var e=require("./_an-object"),r=require("./_ie8-dom-define"),t=require("./_to-primitive"),i=Object.defineProperty;exports.f=require("./_descriptors")?Object.defineProperty:function(o,n,u){if(e(o),n=t(n,!0),e(u),r)try{return i(o,n,u)}catch(e){}if("get"in u||"set"in u)throw TypeError("Accessors not supported!");return"value"in u&&(o[n]=u.value),o};
},{"./_an-object":129,"./_ie8-dom-define":139,"./_to-primitive":140,"./_descriptors":122}],121:[function(require,module,exports) {
module.exports=function(e,r){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:r}};
},{}],89:[function(require,module,exports) {
var r=require("./_object-dp"),e=require("./_property-desc");module.exports=require("./_descriptors")?function(t,u,o){return r.f(t,u,e(1,o))}:function(r,e,t){return r[e]=t,r};
},{"./_object-dp":120,"./_property-desc":121,"./_descriptors":122}],126:[function(require,module,exports) {
var r={}.hasOwnProperty;module.exports=function(e,n){return r.call(e,n)};
},{}],95:[function(require,module,exports) {

var e=require("./_global"),r=require("./_core"),n=require("./_ctx"),t=require("./_hide"),i=require("./_has"),u="prototype",o=function(c,a,f){var l,s,p,h=c&o.F,v=c&o.G,q=c&o.S,w=c&o.P,_=c&o.B,y=c&o.W,d=v?r:r[a]||(r[a]={}),F=d[u],g=v?e:q?e[a]:(e[a]||{})[u];for(l in v&&(f=a),f)(s=!h&&g&&void 0!==g[l])&&i(d,l)||(p=s?g[l]:f[l],d[l]=v&&"function"!=typeof g[l]?f[l]:_&&s?n(p,e):y&&g[l]==p?function(e){var r=function(r,n,t){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(r);case 2:return new e(r,n)}return new e(r,n,t)}return e.apply(this,arguments)};return r[u]=e[u],r}(p):w&&"function"==typeof p?n(Function.call,p):p,w&&((d.virtual||(d.virtual={}))[l]=p,c&o.R&&F&&!F[l]&&t(F,l,p)))};o.F=1,o.G=2,o.S=4,o.P=8,o.B=16,o.W=32,o.U=64,o.R=128,module.exports=o;
},{"./_global":88,"./_core":83,"./_ctx":93,"./_hide":89,"./_has":126}],114:[function(require,module,exports) {
module.exports=require("./_hide");
},{"./_hide":89}],90:[function(require,module,exports) {
module.exports={};
},{}],125:[function(require,module,exports) {
var r={}.toString;module.exports=function(t){return r.call(t).slice(8,-1)};
},{}],138:[function(require,module,exports) {
var e=require("./_cof");module.exports=Object("z").propertyIsEnumerable(0)?Object:function(r){return"String"==e(r)?r.split(""):Object(r)};
},{"./_cof":125}],119:[function(require,module,exports) {
var e=require("./_iobject"),r=require("./_defined");module.exports=function(i){return e(r(i))};
},{"./_iobject":138,"./_defined":113}],130:[function(require,module,exports) {
var e=require("./_to-integer"),r=Math.min;module.exports=function(t){return t>0?r(e(t),9007199254740991):0};
},{"./_to-integer":112}],168:[function(require,module,exports) {
var e=require("./_to-integer"),r=Math.max,t=Math.min;module.exports=function(n,a){return(n=e(n))<0?r(n+a,0):t(n,a)};
},{"./_to-integer":112}],167:[function(require,module,exports) {
var e=require("./_to-iobject"),r=require("./_to-length"),t=require("./_to-absolute-index");module.exports=function(n){return function(i,o,u){var f,l=e(i),a=r(l.length),c=t(u,a);if(n&&o!=o){for(;a>c;)if((f=l[c++])!=f)return!0}else for(;a>c;c++)if((n||c in l)&&l[c]===o)return n||c||0;return!n&&-1}};
},{"./_to-iobject":119,"./_to-length":130,"./_to-absolute-index":168}],123:[function(require,module,exports) {

var r=require("./_core"),e=require("./_global"),o="__core-js_shared__",i=e[o]||(e[o]={});(module.exports=function(r,e){return i[r]||(i[r]=void 0!==e?e:{})})("versions",[]).push({version:r.version,mode:require("./_library")?"pure":"global",copyright:"© 2018 Denis Pushkarev (zloirock.ru)"});
},{"./_core":83,"./_global":88,"./_library":92}],124:[function(require,module,exports) {
var o=0,t=Math.random();module.exports=function(n){return"Symbol(".concat(void 0===n?"":n,")_",(++o+t).toString(36))};
},{}],137:[function(require,module,exports) {
var e=require("./_shared")("keys"),r=require("./_uid");module.exports=function(u){return e[u]||(e[u]=r(u))};
},{"./_shared":123,"./_uid":124}],166:[function(require,module,exports) {
var r=require("./_has"),e=require("./_to-iobject"),u=require("./_array-includes")(!1),i=require("./_shared-key")("IE_PROTO");module.exports=function(o,a){var n,s=e(o),t=0,h=[];for(n in s)n!=i&&r(s,n)&&h.push(n);for(;a.length>t;)r(s,n=a[t++])&&(~u(h,n)||h.push(n));return h};
},{"./_has":126,"./_to-iobject":119,"./_array-includes":167,"./_shared-key":137}],155:[function(require,module,exports) {
module.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",");
},{}],161:[function(require,module,exports) {
var e=require("./_object-keys-internal"),r=require("./_enum-bug-keys");module.exports=Object.keys||function(u){return e(u,r)};
},{"./_object-keys-internal":166,"./_enum-bug-keys":155}],154:[function(require,module,exports) {
var e=require("./_object-dp"),r=require("./_an-object"),t=require("./_object-keys");module.exports=require("./_descriptors")?Object.defineProperties:function(o,i){r(o);for(var u,c=t(i),n=c.length,s=0;n>s;)e.f(o,u=c[s++],i[u]);return o};
},{"./_object-dp":120,"./_an-object":129,"./_object-keys":161,"./_descriptors":122}],133:[function(require,module,exports) {
var e=require("./_global").document;module.exports=e&&e.documentElement;
},{"./_global":88}],135:[function(require,module,exports) {
var e=require("./_an-object"),r=require("./_object-dps"),t=require("./_enum-bug-keys"),n=require("./_shared-key")("IE_PROTO"),o=function(){},i="prototype",u=function(){var e,r=require("./_dom-create")("iframe"),n=t.length;for(r.style.display="none",require("./_html").appendChild(r),r.src="javascript:",(e=r.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),u=e.F;n--;)delete u[i][t[n]];return u()};module.exports=Object.create||function(t,c){var a;return null!==t?(o[i]=e(t),a=new o,o[i]=null,a[n]=t):a=u(),void 0===c?a:r(a,c)};
},{"./_an-object":129,"./_object-dps":154,"./_enum-bug-keys":155,"./_shared-key":137,"./_dom-create":134,"./_html":133}],91:[function(require,module,exports) {
var e=require("./_shared")("wks"),r=require("./_uid"),o=require("./_global").Symbol,u="function"==typeof o,i=module.exports=function(i){return e[i]||(e[i]=u&&o[i]||(u?o:r)("Symbol."+i))};i.store=e;
},{"./_shared":123,"./_uid":124,"./_global":88}],108:[function(require,module,exports) {
var e=require("./_object-dp").f,r=require("./_has"),o=require("./_wks")("toStringTag");module.exports=function(t,u,i){t&&!r(t=i?t:t.prototype,o)&&e(t,o,{configurable:!0,value:u})};
},{"./_object-dp":120,"./_has":126,"./_wks":91}],115:[function(require,module,exports) {
"use strict";var e=require("./_object-create"),r=require("./_property-desc"),t=require("./_set-to-string-tag"),i={};require("./_hide")(i,require("./_wks")("iterator"),function(){return this}),module.exports=function(o,u,s){o.prototype=e(i,{next:r(1,s)}),t(o,u+" Iterator")};
},{"./_object-create":135,"./_property-desc":121,"./_set-to-string-tag":108,"./_hide":89,"./_wks":91}],136:[function(require,module,exports) {
var e=require("./_defined");module.exports=function(r){return Object(e(r))};
},{"./_defined":113}],116:[function(require,module,exports) {
var t=require("./_has"),e=require("./_to-object"),o=require("./_shared-key")("IE_PROTO"),r=Object.prototype;module.exports=Object.getPrototypeOf||function(c){return c=e(c),t(c,o)?c[o]:"function"==typeof c.constructor&&c instanceof c.constructor?c.constructor.prototype:c instanceof Object?r:null};
},{"./_has":126,"./_to-object":136,"./_shared-key":137}],86:[function(require,module,exports) {
"use strict";var e=require("./_library"),r=require("./_export"),t=require("./_redefine"),i=require("./_hide"),n=require("./_iterators"),u=require("./_iter-create"),o=require("./_set-to-string-tag"),s=require("./_object-gpo"),a=require("./_wks")("iterator"),c=!([].keys&&"next"in[].keys()),f="@@iterator",l="keys",q="values",y=function(){return this};module.exports=function(_,p,h,k,v,w,d){u(h,p,k);var x,b,g,j=function(e){if(!c&&e in I)return I[e];switch(e){case l:case q:return function(){return new h(this,e)}}return function(){return new h(this,e)}},m=p+" Iterator",A=v==q,F=!1,I=_.prototype,O=I[a]||I[f]||v&&I[v],P=O||j(v),z=v?A?j("entries"):P:void 0,B="Array"==p&&I.entries||O;if(B&&(g=s(B.call(new _)))!==Object.prototype&&g.next&&(o(g,m,!0),e||"function"==typeof g[a]||i(g,a,y)),A&&O&&O.name!==q&&(F=!0,P=function(){return O.call(this)}),e&&!d||!c&&!F&&I[a]||i(I,a,P),n[p]=P,n[m]=y,v)if(x={values:A?P:j(q),keys:w?P:j(l),entries:z},d)for(b in x)b in I||t(I,b,x[b]);else r(r.P+r.F*(c||F),p,x);return x};
},{"./_library":92,"./_export":95,"./_redefine":114,"./_hide":89,"./_iterators":90,"./_iter-create":115,"./_set-to-string-tag":108,"./_object-gpo":116,"./_wks":91}],78:[function(require,module,exports) {
"use strict";var i=require("./_string-at")(!0);require("./_iter-define")(String,"String",function(i){this._t=String(i),this._i=0},function(){var t,e=this._t,n=this._i;return n>=e.length?{value:void 0,done:!0}:(t=i(e,n),this._i+=t.length,{value:t,done:!1})});
},{"./_string-at":85,"./_iter-define":86}],117:[function(require,module,exports) {
module.exports=function(){};
},{}],118:[function(require,module,exports) {
module.exports=function(e,n){return{value:n,done:!!e}};
},{}],87:[function(require,module,exports) {
"use strict";var e=require("./_add-to-unscopables"),r=require("./_iter-step"),t=require("./_iterators"),i=require("./_to-iobject");module.exports=require("./_iter-define")(Array,"Array",function(e,r){this._t=i(e),this._i=0,this._k=r},function(){var e=this._t,t=this._k,i=this._i++;return!e||i>=e.length?(this._t=void 0,r(1)):r(0,"keys"==t?i:"values"==t?e[i]:[i,e[i]])},"values"),t.Arguments=t.Array,e("keys"),e("values"),e("entries");
},{"./_add-to-unscopables":117,"./_iter-step":118,"./_iterators":90,"./_to-iobject":119,"./_iter-define":86}],79:[function(require,module,exports) {

require("./es6.array.iterator");for(var t=require("./_global"),e=require("./_hide"),i=require("./_iterators"),r=require("./_wks")("toStringTag"),s="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),L=0;L<s.length;L++){var a=s[L],l=t[a],S=l&&l.prototype;S&&!S[r]&&e(S,r,a),i[a]=i.Array}
},{"./es6.array.iterator":87,"./_global":88,"./_hide":89,"./_iterators":90,"./_wks":91}],94:[function(require,module,exports) {
var e=require("./_cof"),t=require("./_wks")("toStringTag"),n="Arguments"==e(function(){return arguments}()),r=function(e,t){try{return e[t]}catch(e){}};module.exports=function(u){var o,c,i;return void 0===u?"Undefined":null===u?"Null":"string"==typeof(c=r(o=Object(u),t))?c:n?e(o):"Object"==(i=e(o))&&"function"==typeof o.callee?"Arguments":i};
},{"./_cof":125,"./_wks":91}],98:[function(require,module,exports) {
module.exports=function(o,n,r,i){if(!(o instanceof n)||void 0!==i&&i in o)throw TypeError(r+": incorrect invocation!");return o};
},{}],127:[function(require,module,exports) {
var r=require("./_an-object");module.exports=function(t,e,o,a){try{return a?e(r(o)[0],o[1]):e(o)}catch(e){var c=t.return;throw void 0!==c&&r(c.call(t)),e}};
},{"./_an-object":129}],128:[function(require,module,exports) {
var r=require("./_iterators"),e=require("./_wks")("iterator"),t=Array.prototype;module.exports=function(o){return void 0!==o&&(r.Array===o||t[e]===o)};
},{"./_iterators":90,"./_wks":91}],131:[function(require,module,exports) {
var r=require("./_classof"),e=require("./_wks")("iterator"),t=require("./_iterators");module.exports=require("./_core").getIteratorMethod=function(o){if(void 0!=o)return o[e]||o["@@iterator"]||t[r(o)]};
},{"./_classof":94,"./_wks":91,"./_iterators":90,"./_core":83}],99:[function(require,module,exports) {
var e=require("./_ctx"),r=require("./_iter-call"),t=require("./_is-array-iter"),i=require("./_an-object"),o=require("./_to-length"),n=require("./core.get-iterator-method"),u={},a={},f=module.exports=function(f,l,c,q,_){var h,s,d,g,p=_?function(){return f}:n(f),v=e(c,q,l?2:1),x=0;if("function"!=typeof p)throw TypeError(f+" is not iterable!");if(t(p)){for(h=o(f.length);h>x;x++)if((g=l?v(i(s=f[x])[0],s[1]):v(f[x]))===u||g===a)return g}else for(d=p.call(f);!(s=d.next()).done;)if((g=r(d,v,s.value,l))===u||g===a)return g};f.BREAK=u,f.RETURN=a;
},{"./_ctx":93,"./_iter-call":127,"./_is-array-iter":128,"./_an-object":129,"./_to-length":130,"./core.get-iterator-method":131}],100:[function(require,module,exports) {
var r=require("./_an-object"),e=require("./_a-function"),o=require("./_wks")("species");module.exports=function(i,u){var n,t=r(i).constructor;return void 0===t||void 0==(n=r(t)[o])?u:e(n)};
},{"./_an-object":129,"./_a-function":97,"./_wks":91}],132:[function(require,module,exports) {
module.exports=function(e,r,l){var a=void 0===l;switch(r.length){case 0:return a?e():e.call(l);case 1:return a?e(r[0]):e.call(l,r[0]);case 2:return a?e(r[0],r[1]):e.call(l,r[0],r[1]);case 3:return a?e(r[0],r[1],r[2]):e.call(l,r[0],r[1],r[2]);case 4:return a?e(r[0],r[1],r[2],r[3]):e.call(l,r[0],r[1],r[2],r[3])}return e.apply(l,r)};
},{}],101:[function(require,module,exports) {


var e,t,n,i=require("./_ctx"),o=require("./_invoke"),r=require("./_html"),s=require("./_dom-create"),a=require("./_global"),c=a.process,u=a.setImmediate,p=a.clearImmediate,f=a.MessageChannel,l=a.Dispatch,d=0,m={},h="onreadystatechange",g=function(){var e=+this;if(m.hasOwnProperty(e)){var t=m[e];delete m[e],t()}},v=function(e){g.call(e.data)};u&&p||(u=function(t){for(var n=[],i=1;arguments.length>i;)n.push(arguments[i++]);return m[++d]=function(){o("function"==typeof t?t:Function(t),n)},e(d),d},p=function(e){delete m[e]},"process"==require("./_cof")(c)?e=function(e){c.nextTick(i(g,e,1))}:l&&l.now?e=function(e){l.now(i(g,e,1))}:f?(n=(t=new f).port2,t.port1.onmessage=v,e=i(n.postMessage,n,1)):a.addEventListener&&"function"==typeof postMessage&&!a.importScripts?(e=function(e){a.postMessage(e+"","*")},a.addEventListener("message",v,!1)):e=h in s("script")?function(e){r.appendChild(s("script"))[h]=function(){r.removeChild(this),g.call(e)}}:function(e){setTimeout(i(g,e,1),0)}),module.exports={set:u,clear:p};
},{"./_ctx":93,"./_invoke":132,"./_html":133,"./_dom-create":134,"./_global":88,"./_cof":125}],102:[function(require,module,exports) {


var e=require("./_global"),t=require("./_task").set,r=e.MutationObserver||e.WebKitMutationObserver,n=e.process,o=e.Promise,a="process"==require("./_cof")(n);module.exports=function(){var i,c,s,v=function(){var e,t;for(a&&(e=n.domain)&&e.exit();i;){t=i.fn,i=i.next;try{t()}catch(e){throw i?s():c=void 0,e}}c=void 0,e&&e.enter()};if(a)s=function(){n.nextTick(v)};else if(!r||e.navigator&&e.navigator.standalone)if(o&&o.resolve){var u=o.resolve(void 0);s=function(){u.then(v)}}else s=function(){t.call(e,v)};else{var f=!0,l=document.createTextNode("");new r(v).observe(l,{characterData:!0}),s=function(){l.data=f=!f}}return function(e){var t={fn:e,next:void 0};c&&(c.next=t),i||(i=t,s()),c=t}};
},{"./_global":88,"./_task":101,"./_cof":125}],103:[function(require,module,exports) {
"use strict";var r=require("./_a-function");function e(e){var o,t;this.promise=new e(function(r,e){if(void 0!==o||void 0!==t)throw TypeError("Bad Promise constructor");o=r,t=e}),this.resolve=r(o),this.reject=r(t)}module.exports.f=function(r){return new e(r)};
},{"./_a-function":97}],104:[function(require,module,exports) {
module.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}};
},{}],105:[function(require,module,exports) {

var e=require("./_global"),r=e.navigator;module.exports=r&&r.userAgent||"";
},{"./_global":88}],106:[function(require,module,exports) {
var r=require("./_an-object"),e=require("./_is-object"),i=require("./_new-promise-capability");module.exports=function(o,t){if(r(o),e(t)&&t.constructor===o)return t;var u=i.f(o);return(0,u.resolve)(t),u.promise};
},{"./_an-object":129,"./_is-object":96,"./_new-promise-capability":103}],107:[function(require,module,exports) {
var r=require("./_hide");module.exports=function(e,i,n){for(var o in i)n&&e[o]?e[o]=i[o]:r(e,o,i[o]);return e};
},{"./_hide":89}],109:[function(require,module,exports) {

"use strict";var e=require("./_global"),r=require("./_core"),i=require("./_object-dp"),t=require("./_descriptors"),u=require("./_wks")("species");module.exports=function(o){var c="function"==typeof r[o]?r[o]:e[o];t&&c&&!c[u]&&i.f(c,u,{configurable:!0,get:function(){return this}})};
},{"./_global":88,"./_core":83,"./_object-dp":120,"./_descriptors":122,"./_wks":91}],110:[function(require,module,exports) {
var r=require("./_wks")("iterator"),t=!1;try{var n=[7][r]();n.return=function(){t=!0},Array.from(n,function(){throw 2})}catch(r){}module.exports=function(n,e){if(!e&&!t)return!1;var u=!1;try{var o=[7],c=o[r]();c.next=function(){return{done:u=!0}},o[r]=function(){return c},n(o)}catch(r){}return u};
},{"./_wks":91}],80:[function(require,module,exports) {


"use strict";var e,r,t,i,n=require("./_library"),o=require("./_global"),c=require("./_ctx"),s=require("./_classof"),u=require("./_export"),a=require("./_is-object"),_=require("./_a-function"),h=require("./_an-instance"),f=require("./_for-of"),l=require("./_species-constructor"),v=require("./_task").set,d=require("./_microtask")(),p=require("./_new-promise-capability"),m=require("./_perform"),q=require("./_user-agent"),y=require("./_promise-resolve"),j="Promise",w=o.TypeError,g=o.process,x=g&&g.versions,b=x&&x.v8||"",k=o[j],P="process"==s(g),F=function(){},S=r=p.f,E=!!function(){try{var e=k.resolve(1),r=(e.constructor={})[require("./_wks")("species")]=function(e){e(F,F)};return(P||"function"==typeof PromiseRejectionEvent)&&e.then(F)instanceof r&&0!==b.indexOf("6.6")&&-1===q.indexOf("Chrome/66")}catch(e){}}(),O=function(e){var r;return!(!a(e)||"function"!=typeof(r=e.then))&&r},R=function(e,r){if(!e._n){e._n=!0;var t=e._c;d(function(){for(var i=e._v,n=1==e._s,o=0,c=function(r){var t,o,c,s=n?r.ok:r.fail,u=r.resolve,a=r.reject,_=r.domain;try{s?(n||(2==e._h&&H(e),e._h=1),!0===s?t=i:(_&&_.enter(),t=s(i),_&&(_.exit(),c=!0)),t===r.promise?a(w("Promise-chain cycle")):(o=O(t))?o.call(t,u,a):u(t)):a(i)}catch(e){_&&!c&&_.exit(),a(e)}};t.length>o;)c(t[o++]);e._c=[],e._n=!1,r&&!e._h&&C(e)})}},C=function(e){v.call(o,function(){var r,t,i,n=e._v,c=G(e);if(c&&(r=m(function(){P?g.emit("unhandledRejection",n,e):(t=o.onunhandledrejection)?t({promise:e,reason:n}):(i=o.console)&&i.error&&i.error("Unhandled promise rejection",n)}),e._h=P||G(e)?2:1),e._a=void 0,c&&r.e)throw r.v})},G=function(e){return 1!==e._h&&0===(e._a||e._c).length},H=function(e){v.call(o,function(){var r;P?g.emit("rejectionHandled",e):(r=o.onrejectionhandled)&&r({promise:e,reason:e._v})})},T=function(e){var r=this;r._d||(r._d=!0,(r=r._w||r)._v=e,r._s=2,r._a||(r._a=r._c.slice()),R(r,!0))},U=function(e){var r,t=this;if(!t._d){t._d=!0,t=t._w||t;try{if(t===e)throw w("Promise can't be resolved itself");(r=O(e))?d(function(){var i={_w:t,_d:!1};try{r.call(e,c(U,i,1),c(T,i,1))}catch(e){T.call(i,e)}}):(t._v=e,t._s=1,R(t,!1))}catch(e){T.call({_w:t,_d:!1},e)}}};E||(k=function(r){h(this,k,j,"_h"),_(r),e.call(this);try{r(c(U,this,1),c(T,this,1))}catch(e){T.call(this,e)}},(e=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=require("./_redefine-all")(k.prototype,{then:function(e,r){var t=S(l(this,k));return t.ok="function"!=typeof e||e,t.fail="function"==typeof r&&r,t.domain=P?g.domain:void 0,this._c.push(t),this._a&&this._a.push(t),this._s&&R(this,!1),t.promise},catch:function(e){return this.then(void 0,e)}}),t=function(){var r=new e;this.promise=r,this.resolve=c(U,r,1),this.reject=c(T,r,1)},p.f=S=function(e){return e===k||e===i?new t(e):r(e)}),u(u.G+u.W+u.F*!E,{Promise:k}),require("./_set-to-string-tag")(k,j),require("./_set-species")(j),i=require("./_core")[j],u(u.S+u.F*!E,j,{reject:function(e){var r=S(this);return(0,r.reject)(e),r.promise}}),u(u.S+u.F*(n||!E),j,{resolve:function(e){return y(n&&this===i?k:this,e)}}),u(u.S+u.F*!(E&&require("./_iter-detect")(function(e){k.all(e).catch(F)})),j,{all:function(e){var r=this,t=S(r),i=t.resolve,n=t.reject,o=m(function(){var t=[],o=0,c=1;f(e,!1,function(e){var s=o++,u=!1;t.push(void 0),c++,r.resolve(e).then(function(e){u||(u=!0,t[s]=e,--c||i(t))},n)}),--c||i(t)});return o.e&&n(o.v),t.promise},race:function(e){var r=this,t=S(r),i=t.reject,n=m(function(){f(e,!1,function(e){r.resolve(e).then(t.resolve,i)})});return n.e&&i(n.v),t.promise}});
},{"./_library":92,"./_global":88,"./_ctx":93,"./_classof":94,"./_export":95,"./_is-object":96,"./_a-function":97,"./_an-instance":98,"./_for-of":99,"./_species-constructor":100,"./_task":101,"./_microtask":102,"./_new-promise-capability":103,"./_perform":104,"./_user-agent":105,"./_promise-resolve":106,"./_wks":91,"./_redefine-all":107,"./_set-to-string-tag":108,"./_set-species":109,"./_core":83,"./_iter-detect":110}],81:[function(require,module,exports) {

"use strict";var r=require("./_export"),e=require("./_core"),t=require("./_global"),n=require("./_species-constructor"),i=require("./_promise-resolve");r(r.P+r.R,"Promise",{finally:function(r){var o=n(this,e.Promise||t.Promise),u="function"==typeof r;return this.then(u?function(e){return i(o,r()).then(function(){return e})}:r,u?function(e){return i(o,r()).then(function(){throw e})}:r)}});
},{"./_export":95,"./_core":83,"./_global":88,"./_species-constructor":100,"./_promise-resolve":106}],82:[function(require,module,exports) {
"use strict";var r=require("./_export"),e=require("./_new-promise-capability"),i=require("./_perform");r(r.S,"Promise",{try:function(r){var t=e.f(this),o=i(r);return(o.e?t.reject:t.resolve)(o.v),t.promise}});
},{"./_export":95,"./_new-promise-capability":103,"./_perform":104}],75:[function(require,module,exports) {
require("../modules/es6.object.to-string"),require("../modules/es6.string.iterator"),require("../modules/web.dom.iterable"),require("../modules/es6.promise"),require("../modules/es7.promise.finally"),require("../modules/es7.promise.try"),module.exports=require("../modules/_core").Promise;
},{"../modules/es6.object.to-string":77,"../modules/es6.string.iterator":78,"../modules/web.dom.iterable":79,"../modules/es6.promise":80,"../modules/es7.promise.finally":81,"../modules/es7.promise.try":82,"../modules/_core":83}],69:[function(require,module,exports) {
module.exports={default:require("core-js/library/fn/promise"),__esModule:!0};
},{"core-js/library/fn/promise":75}],66:[function(require,module,exports) {
"use strict";exports.__esModule=!0;var e=require("../core-js/promise"),t=n(e);function n(e){return e&&e.__esModule?e:{default:e}}exports.default=function(e){return function(){var n=e.apply(this,arguments);return new t.default(function(e,r){return function u(o,i){try{var f=n[o](i),c=f.value}catch(e){return void r(e)}if(!f.done)return t.default.resolve(c).then(function(e){u("next",e)},function(e){u("throw",e)});e(c)}("next")})}};
},{"../core-js/promise":69}],67:[function(require,module,exports) {
"use strict";exports.__esModule=!0,exports.default=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};
},{}],70:[function(require,module,exports) {

var t,e,n=module.exports={};function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(t===setTimeout)return setTimeout(e,0);if((t===r||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}function u(t){if(e===clearTimeout)return clearTimeout(t);if((e===o||!e)&&clearTimeout)return e=clearTimeout,clearTimeout(t);try{return e(t)}catch(n){try{return e.call(null,t)}catch(n){return e.call(this,t)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:r}catch(e){t=r}try{e="function"==typeof clearTimeout?clearTimeout:o}catch(t){e=o}}();var c,s=[],l=!1,a=-1;function f(){l&&c&&(l=!1,c.length?s=c.concat(s):a=-1,s.length&&h())}function h(){if(!l){var t=i(f);l=!0;for(var e=s.length;e;){for(c=s,s=[];++a<e;)c&&c[a].run();a=-1,e=s.length}c=null,l=!1,u(t)}}function m(t,e){this.fun=t,this.array=e}function p(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];s.push(new m(t,e)),1!==s.length||l||i(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=p,n.addListener=p,n.once=p,n.off=p,n.removeListener=p,n.removeAllListeners=p,n.emit=p,n.prependListener=p,n.prependOnceListener=p,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0};
},{}],72:[function(require,module,exports) {
"use strict";exports.byteLength=u,exports.toByteArray=i,exports.fromByteArray=d;for(var r=[],t=[],e="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,a=n.length;o<a;++o)r[o]=n[o],t[n.charCodeAt(o)]=o;function h(r){var t=r.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=r.indexOf("=");return-1===e&&(e=t),[e,e===t?0:4-e%4]}function u(r){var t=h(r),e=t[0],n=t[1];return 3*(e+n)/4-n}function c(r,t,e){return 3*(t+e)/4-e}function i(r){for(var n,o=h(r),a=o[0],u=o[1],i=new e(c(r,a,u)),f=0,A=u>0?a-4:a,d=0;d<A;d+=4)n=t[r.charCodeAt(d)]<<18|t[r.charCodeAt(d+1)]<<12|t[r.charCodeAt(d+2)]<<6|t[r.charCodeAt(d+3)],i[f++]=n>>16&255,i[f++]=n>>8&255,i[f++]=255&n;return 2===u&&(n=t[r.charCodeAt(d)]<<2|t[r.charCodeAt(d+1)]>>4,i[f++]=255&n),1===u&&(n=t[r.charCodeAt(d)]<<10|t[r.charCodeAt(d+1)]<<4|t[r.charCodeAt(d+2)]>>2,i[f++]=n>>8&255,i[f++]=255&n),i}function f(t){return r[t>>18&63]+r[t>>12&63]+r[t>>6&63]+r[63&t]}function A(r,t,e){for(var n,o=[],a=t;a<e;a+=3)n=(r[a]<<16&16711680)+(r[a+1]<<8&65280)+(255&r[a+2]),o.push(f(n));return o.join("")}function d(t){for(var e,n=t.length,o=n%3,a=[],h=0,u=n-o;h<u;h+=16383)a.push(A(t,h,h+16383>u?u:h+16383));return 1===o?(e=t[n-1],a.push(r[e>>2]+r[e<<4&63]+"==")):2===o&&(e=(t[n-2]<<8)+t[n-1],a.push(r[e>>10]+r[e>>4&63]+r[e<<2&63]+"=")),a.join("")}t["-".charCodeAt(0)]=62,t["_".charCodeAt(0)]=63;
},{}],73:[function(require,module,exports) {
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:1/0*(s?-1:1);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=o<0||0===o&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),(o+=p+N>=1?n/f:n*Math.pow(2,1-N))*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};
},{}],74:[function(require,module,exports) {
var r={}.toString;module.exports=Array.isArray||function(t){return"[object Array]"==r.call(t)};
},{}],71:[function(require,module,exports) {

var global = arguments[3];
var t=arguments[3],r=require("base64-js"),e=require("ieee754"),n=require("isarray");function i(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}function o(){return f.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function u(t,r){if(o()<r)throw new RangeError("Invalid typed array length");return f.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(r)).__proto__=f.prototype:(null===t&&(t=new f(r)),t.length=r),t}function f(t,r,e){if(!(f.TYPED_ARRAY_SUPPORT||this instanceof f))return new f(t,r,e);if("number"==typeof t){if("string"==typeof r)throw new Error("If encoding is specified then the first argument must be a string");return c(this,t)}return s(this,t,r,e)}function s(t,r,e,n){if("number"==typeof r)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&r instanceof ArrayBuffer?g(t,r,e,n):"string"==typeof r?l(t,r,e):y(t,r)}function h(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function a(t,r,e,n){return h(r),r<=0?u(t,r):void 0!==e?"string"==typeof n?u(t,r).fill(e,n):u(t,r).fill(e):u(t,r)}function c(t,r){if(h(r),t=u(t,r<0?0:0|w(r)),!f.TYPED_ARRAY_SUPPORT)for(var e=0;e<r;++e)t[e]=0;return t}function l(t,r,e){if("string"==typeof e&&""!==e||(e="utf8"),!f.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');var n=0|v(r,e),i=(t=u(t,n)).write(r,e);return i!==n&&(t=t.slice(0,i)),t}function p(t,r){var e=r.length<0?0:0|w(r.length);t=u(t,e);for(var n=0;n<e;n+=1)t[n]=255&r[n];return t}function g(t,r,e,n){if(r.byteLength,e<0||r.byteLength<e)throw new RangeError("'offset' is out of bounds");if(r.byteLength<e+(n||0))throw new RangeError("'length' is out of bounds");return r=void 0===e&&void 0===n?new Uint8Array(r):void 0===n?new Uint8Array(r,e):new Uint8Array(r,e,n),f.TYPED_ARRAY_SUPPORT?(t=r).__proto__=f.prototype:t=p(t,r),t}function y(t,r){if(f.isBuffer(r)){var e=0|w(r.length);return 0===(t=u(t,e)).length?t:(r.copy(t,0,0,e),t)}if(r){if("undefined"!=typeof ArrayBuffer&&r.buffer instanceof ArrayBuffer||"length"in r)return"number"!=typeof r.length||W(r.length)?u(t,0):p(t,r);if("Buffer"===r.type&&n(r.data))return p(t,r.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function w(t){if(t>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|t}function d(t){return+t!=t&&(t=0),f.alloc(+t)}function v(t,r){if(f.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var e=t.length;if(0===e)return 0;for(var n=!1;;)switch(r){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":case void 0:return $(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*e;case"hex":return e>>>1;case"base64":return K(t).length;default:if(n)return $(t).length;r=(""+r).toLowerCase(),n=!0}}function E(t,r,e){var n=!1;if((void 0===r||r<0)&&(r=0),r>this.length)return"";if((void 0===e||e>this.length)&&(e=this.length),e<=0)return"";if((e>>>=0)<=(r>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return x(this,r,e);case"utf8":case"utf-8":return Y(this,r,e);case"ascii":return L(this,r,e);case"latin1":case"binary":return D(this,r,e);case"base64":return S(this,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,r,e);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function b(t,r,e){var n=t[r];t[r]=t[e],t[e]=n}function R(t,r,e,n,i){if(0===t.length)return-1;if("string"==typeof e?(n=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,isNaN(e)&&(e=i?0:t.length-1),e<0&&(e=t.length+e),e>=t.length){if(i)return-1;e=t.length-1}else if(e<0){if(!i)return-1;e=0}if("string"==typeof r&&(r=f.from(r,n)),f.isBuffer(r))return 0===r.length?-1:_(t,r,e,n,i);if("number"==typeof r)return r&=255,f.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(t,r,e):Uint8Array.prototype.lastIndexOf.call(t,r,e):_(t,[r],e,n,i);throw new TypeError("val must be string, number or Buffer")}function _(t,r,e,n,i){var o,u=1,f=t.length,s=r.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||r.length<2)return-1;u=2,f/=2,s/=2,e/=2}function h(t,r){return 1===u?t[r]:t.readUInt16BE(r*u)}if(i){var a=-1;for(o=e;o<f;o++)if(h(t,o)===h(r,-1===a?0:o-a)){if(-1===a&&(a=o),o-a+1===s)return a*u}else-1!==a&&(o-=o-a),a=-1}else for(e+s>f&&(e=f-s),o=e;o>=0;o--){for(var c=!0,l=0;l<s;l++)if(h(t,o+l)!==h(r,l)){c=!1;break}if(c)return o}return-1}function A(t,r,e,n){e=Number(e)||0;var i=t.length-e;n?(n=Number(n))>i&&(n=i):n=i;var o=r.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var u=0;u<n;++u){var f=parseInt(r.substr(2*u,2),16);if(isNaN(f))return u;t[e+u]=f}return u}function m(t,r,e,n){return Q($(r,t.length-e),t,e,n)}function P(t,r,e,n){return Q(G(r),t,e,n)}function T(t,r,e,n){return P(t,r,e,n)}function B(t,r,e,n){return Q(K(r),t,e,n)}function U(t,r,e,n){return Q(H(r,t.length-e),t,e,n)}function S(t,e,n){return 0===e&&n===t.length?r.fromByteArray(t):r.fromByteArray(t.slice(e,n))}function Y(t,r,e){e=Math.min(t.length,e);for(var n=[],i=r;i<e;){var o,u,f,s,h=t[i],a=null,c=h>239?4:h>223?3:h>191?2:1;if(i+c<=e)switch(c){case 1:h<128&&(a=h);break;case 2:128==(192&(o=t[i+1]))&&(s=(31&h)<<6|63&o)>127&&(a=s);break;case 3:o=t[i+1],u=t[i+2],128==(192&o)&&128==(192&u)&&(s=(15&h)<<12|(63&o)<<6|63&u)>2047&&(s<55296||s>57343)&&(a=s);break;case 4:o=t[i+1],u=t[i+2],f=t[i+3],128==(192&o)&&128==(192&u)&&128==(192&f)&&(s=(15&h)<<18|(63&o)<<12|(63&u)<<6|63&f)>65535&&s<1114112&&(a=s)}null===a?(a=65533,c=1):a>65535&&(a-=65536,n.push(a>>>10&1023|55296),a=56320|1023&a),n.push(a),i+=c}return O(n)}exports.Buffer=f,exports.SlowBuffer=d,exports.INSPECT_MAX_BYTES=50,f.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:i(),exports.kMaxLength=o(),f.poolSize=8192,f._augment=function(t){return t.__proto__=f.prototype,t},f.from=function(t,r,e){return s(null,t,r,e)},f.TYPED_ARRAY_SUPPORT&&(f.prototype.__proto__=Uint8Array.prototype,f.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&f[Symbol.species]===f&&Object.defineProperty(f,Symbol.species,{value:null,configurable:!0})),f.alloc=function(t,r,e){return a(null,t,r,e)},f.allocUnsafe=function(t){return c(null,t)},f.allocUnsafeSlow=function(t){return c(null,t)},f.isBuffer=function(t){return!(null==t||!t._isBuffer)},f.compare=function(t,r){if(!f.isBuffer(t)||!f.isBuffer(r))throw new TypeError("Arguments must be Buffers");if(t===r)return 0;for(var e=t.length,n=r.length,i=0,o=Math.min(e,n);i<o;++i)if(t[i]!==r[i]){e=t[i],n=r[i];break}return e<n?-1:n<e?1:0},f.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},f.concat=function(t,r){if(!n(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return f.alloc(0);var e;if(void 0===r)for(r=0,e=0;e<t.length;++e)r+=t[e].length;var i=f.allocUnsafe(r),o=0;for(e=0;e<t.length;++e){var u=t[e];if(!f.isBuffer(u))throw new TypeError('"list" argument must be an Array of Buffers');u.copy(i,o),o+=u.length}return i},f.byteLength=v,f.prototype._isBuffer=!0,f.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var r=0;r<t;r+=2)b(this,r,r+1);return this},f.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var r=0;r<t;r+=4)b(this,r,r+3),b(this,r+1,r+2);return this},f.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var r=0;r<t;r+=8)b(this,r,r+7),b(this,r+1,r+6),b(this,r+2,r+5),b(this,r+3,r+4);return this},f.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?Y(this,0,t):E.apply(this,arguments)},f.prototype.equals=function(t){if(!f.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===f.compare(this,t)},f.prototype.inspect=function(){var t="",r=exports.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(t+=" ... ")),"<Buffer "+t+">"},f.prototype.compare=function(t,r,e,n,i){if(!f.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===r&&(r=0),void 0===e&&(e=t?t.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),r<0||e>t.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&r>=e)return 0;if(n>=i)return-1;if(r>=e)return 1;if(r>>>=0,e>>>=0,n>>>=0,i>>>=0,this===t)return 0;for(var o=i-n,u=e-r,s=Math.min(o,u),h=this.slice(n,i),a=t.slice(r,e),c=0;c<s;++c)if(h[c]!==a[c]){o=h[c],u=a[c];break}return o<u?-1:u<o?1:0},f.prototype.includes=function(t,r,e){return-1!==this.indexOf(t,r,e)},f.prototype.indexOf=function(t,r,e){return R(this,t,r,e,!0)},f.prototype.lastIndexOf=function(t,r,e){return R(this,t,r,e,!1)},f.prototype.write=function(t,r,e,n){if(void 0===r)n="utf8",e=this.length,r=0;else if(void 0===e&&"string"==typeof r)n=r,e=this.length,r=0;else{if(!isFinite(r))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");r|=0,isFinite(e)?(e|=0,void 0===n&&(n="utf8")):(n=e,e=void 0)}var i=this.length-r;if((void 0===e||e>i)&&(e=i),t.length>0&&(e<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return A(this,t,r,e);case"utf8":case"utf-8":return m(this,t,r,e);case"ascii":return P(this,t,r,e);case"latin1":case"binary":return T(this,t,r,e);case"base64":return B(this,t,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return U(this,t,r,e);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var I=4096;function O(t){var r=t.length;if(r<=I)return String.fromCharCode.apply(String,t);for(var e="",n=0;n<r;)e+=String.fromCharCode.apply(String,t.slice(n,n+=I));return e}function L(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(127&t[i]);return n}function D(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(t[i]);return n}function x(t,r,e){var n=t.length;(!r||r<0)&&(r=0),(!e||e<0||e>n)&&(e=n);for(var i="",o=r;o<e;++o)i+=Z(t[o]);return i}function C(t,r,e){for(var n=t.slice(r,e),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function M(t,r,e){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+r>e)throw new RangeError("Trying to access beyond buffer length")}function k(t,r,e,n,i,o){if(!f.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(r>i||r<o)throw new RangeError('"value" argument is out of bounds');if(e+n>t.length)throw new RangeError("Index out of range")}function N(t,r,e,n){r<0&&(r=65535+r+1);for(var i=0,o=Math.min(t.length-e,2);i<o;++i)t[e+i]=(r&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function z(t,r,e,n){r<0&&(r=4294967295+r+1);for(var i=0,o=Math.min(t.length-e,4);i<o;++i)t[e+i]=r>>>8*(n?i:3-i)&255}function F(t,r,e,n,i,o){if(e+n>t.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function j(t,r,n,i,o){return o||F(t,r,n,4,3.4028234663852886e38,-3.4028234663852886e38),e.write(t,r,n,i,23,4),n+4}function q(t,r,n,i,o){return o||F(t,r,n,8,1.7976931348623157e308,-1.7976931348623157e308),e.write(t,r,n,i,52,8),n+8}f.prototype.slice=function(t,r){var e,n=this.length;if(t=~~t,r=void 0===r?n:~~r,t<0?(t+=n)<0&&(t=0):t>n&&(t=n),r<0?(r+=n)<0&&(r=0):r>n&&(r=n),r<t&&(r=t),f.TYPED_ARRAY_SUPPORT)(e=this.subarray(t,r)).__proto__=f.prototype;else{var i=r-t;e=new f(i,void 0);for(var o=0;o<i;++o)e[o]=this[o+t]}return e},f.prototype.readUIntLE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n},f.prototype.readUIntBE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t+--r],i=1;r>0&&(i*=256);)n+=this[t+--r]*i;return n},f.prototype.readUInt8=function(t,r){return r||M(t,1,this.length),this[t]},f.prototype.readUInt16LE=function(t,r){return r||M(t,2,this.length),this[t]|this[t+1]<<8},f.prototype.readUInt16BE=function(t,r){return r||M(t,2,this.length),this[t]<<8|this[t+1]},f.prototype.readUInt32LE=function(t,r){return r||M(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},f.prototype.readUInt32BE=function(t,r){return r||M(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},f.prototype.readIntLE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*r)),n},f.prototype.readIntBE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=r,i=1,o=this[t+--n];n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*r)),o},f.prototype.readInt8=function(t,r){return r||M(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},f.prototype.readInt16LE=function(t,r){r||M(t,2,this.length);var e=this[t]|this[t+1]<<8;return 32768&e?4294901760|e:e},f.prototype.readInt16BE=function(t,r){r||M(t,2,this.length);var e=this[t+1]|this[t]<<8;return 32768&e?4294901760|e:e},f.prototype.readInt32LE=function(t,r){return r||M(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},f.prototype.readInt32BE=function(t,r){return r||M(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},f.prototype.readFloatLE=function(t,r){return r||M(t,4,this.length),e.read(this,t,!0,23,4)},f.prototype.readFloatBE=function(t,r){return r||M(t,4,this.length),e.read(this,t,!1,23,4)},f.prototype.readDoubleLE=function(t,r){return r||M(t,8,this.length),e.read(this,t,!0,52,8)},f.prototype.readDoubleBE=function(t,r){return r||M(t,8,this.length),e.read(this,t,!1,52,8)},f.prototype.writeUIntLE=function(t,r,e,n){(t=+t,r|=0,e|=0,n)||k(this,t,r,e,Math.pow(2,8*e)-1,0);var i=1,o=0;for(this[r]=255&t;++o<e&&(i*=256);)this[r+o]=t/i&255;return r+e},f.prototype.writeUIntBE=function(t,r,e,n){(t=+t,r|=0,e|=0,n)||k(this,t,r,e,Math.pow(2,8*e)-1,0);var i=e-1,o=1;for(this[r+i]=255&t;--i>=0&&(o*=256);)this[r+i]=t/o&255;return r+e},f.prototype.writeUInt8=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,1,255,0),f.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[r]=255&t,r+1},f.prototype.writeUInt16LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,65535,0),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):N(this,t,r,!0),r+2},f.prototype.writeUInt16BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,65535,0),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):N(this,t,r,!1),r+2},f.prototype.writeUInt32LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,4294967295,0),f.TYPED_ARRAY_SUPPORT?(this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=255&t):z(this,t,r,!0),r+4},f.prototype.writeUInt32BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,4294967295,0),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):z(this,t,r,!1),r+4},f.prototype.writeIntLE=function(t,r,e,n){if(t=+t,r|=0,!n){var i=Math.pow(2,8*e-1);k(this,t,r,e,i-1,-i)}var o=0,u=1,f=0;for(this[r]=255&t;++o<e&&(u*=256);)t<0&&0===f&&0!==this[r+o-1]&&(f=1),this[r+o]=(t/u>>0)-f&255;return r+e},f.prototype.writeIntBE=function(t,r,e,n){if(t=+t,r|=0,!n){var i=Math.pow(2,8*e-1);k(this,t,r,e,i-1,-i)}var o=e-1,u=1,f=0;for(this[r+o]=255&t;--o>=0&&(u*=256);)t<0&&0===f&&0!==this[r+o+1]&&(f=1),this[r+o]=(t/u>>0)-f&255;return r+e},f.prototype.writeInt8=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,1,127,-128),f.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[r]=255&t,r+1},f.prototype.writeInt16LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,32767,-32768),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):N(this,t,r,!0),r+2},f.prototype.writeInt16BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,32767,-32768),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):N(this,t,r,!1),r+2},f.prototype.writeInt32LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,2147483647,-2147483648),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24):z(this,t,r,!0),r+4},f.prototype.writeInt32BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):z(this,t,r,!1),r+4},f.prototype.writeFloatLE=function(t,r,e){return j(this,t,r,!0,e)},f.prototype.writeFloatBE=function(t,r,e){return j(this,t,r,!1,e)},f.prototype.writeDoubleLE=function(t,r,e){return q(this,t,r,!0,e)},f.prototype.writeDoubleBE=function(t,r,e){return q(this,t,r,!1,e)},f.prototype.copy=function(t,r,e,n){if(e||(e=0),n||0===n||(n=this.length),r>=t.length&&(r=t.length),r||(r=0),n>0&&n<e&&(n=e),n===e)return 0;if(0===t.length||0===this.length)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(e<0||e>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-r<n-e&&(n=t.length-r+e);var i,o=n-e;if(this===t&&e<r&&r<n)for(i=o-1;i>=0;--i)t[i+r]=this[i+e];else if(o<1e3||!f.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)t[i+r]=this[i+e];else Uint8Array.prototype.set.call(t,this.subarray(e,e+o),r);return o},f.prototype.fill=function(t,r,e,n){if("string"==typeof t){if("string"==typeof r?(n=r,r=0,e=this.length):"string"==typeof e&&(n=e,e=this.length),1===t.length){var i=t.charCodeAt(0);i<256&&(t=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!f.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof t&&(t&=255);if(r<0||this.length<r||this.length<e)throw new RangeError("Out of range index");if(e<=r)return this;var o;if(r>>>=0,e=void 0===e?this.length:e>>>0,t||(t=0),"number"==typeof t)for(o=r;o<e;++o)this[o]=t;else{var u=f.isBuffer(t)?t:$(new f(t,n).toString()),s=u.length;for(o=0;o<e-r;++o)this[o+r]=u[o%s]}return this};var V=/[^+\/0-9A-Za-z-_]/g;function X(t){if((t=J(t).replace(V,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}function J(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function Z(t){return t<16?"0"+t.toString(16):t.toString(16)}function $(t,r){var e;r=r||1/0;for(var n=t.length,i=null,o=[],u=0;u<n;++u){if((e=t.charCodeAt(u))>55295&&e<57344){if(!i){if(e>56319){(r-=3)>-1&&o.push(239,191,189);continue}if(u+1===n){(r-=3)>-1&&o.push(239,191,189);continue}i=e;continue}if(e<56320){(r-=3)>-1&&o.push(239,191,189),i=e;continue}e=65536+(i-55296<<10|e-56320)}else i&&(r-=3)>-1&&o.push(239,191,189);if(i=null,e<128){if((r-=1)<0)break;o.push(e)}else if(e<2048){if((r-=2)<0)break;o.push(e>>6|192,63&e|128)}else if(e<65536){if((r-=3)<0)break;o.push(e>>12|224,e>>6&63|128,63&e|128)}else{if(!(e<1114112))throw new Error("Invalid code point");if((r-=4)<0)break;o.push(e>>18|240,e>>12&63|128,e>>6&63|128,63&e|128)}}return o}function G(t){for(var r=[],e=0;e<t.length;++e)r.push(255&t.charCodeAt(e));return r}function H(t,r){for(var e,n,i,o=[],u=0;u<t.length&&!((r-=2)<0);++u)n=(e=t.charCodeAt(u))>>8,i=e%256,o.push(i),o.push(n);return o}function K(t){return r.toByteArray(X(t))}function Q(t,r,e,n){for(var i=0;i<n&&!(i+e>=r.length||i>=t.length);++i)r[i+e]=t[i];return i}function W(t){return t!=t}
},{"base64-js":72,"ieee754":73,"isarray":74,"buffer":71}],64:[function(require,module,exports) {
var define;
var global = arguments[3];
var process = require("process");
var Buffer = require("buffer").Buffer;
var t,e=arguments[3],n=require("process"),r=require("buffer").Buffer;!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof t&&t.amd)t([],n);else{("undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:this).Filer=n()}}(function(){return function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var f=n[s]={exports:{}};e[s][0].call(f.exports,function(t){var n=e[s][1][t];return i(n||t)},f,f.exports,t,e,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t,e,r){var i;i={},void 0!==n&&n.nextTick?(i.nextTick=n.nextTick,"undefined"!=typeof setImmediate?i.setImmediate=function(t){setImmediate(t)}:i.setImmediate=i.nextTick):"function"==typeof setImmediate?(i.nextTick=function(t){setImmediate(t)},i.setImmediate=i.nextTick):(i.nextTick=function(t){setTimeout(t,0)},i.setImmediate=i.nextTick),i.eachSeries=function(t,e,n){if(n=n||function(){},!t.length)return n();var r=0,i=function(){e(t[r],function(e){e?(n(e),n=function(){}):(r+=1)>=t.length?n():i()})};i()},i.forEachSeries=i.eachSeries,void 0!==e&&e.exports?e.exports=i:root.async=i},{}],2:[function(t,e,n){var r=function(){};r.createInterface=function(t){var e={on:function(e,n){void 0===this[t]&&(this[t]={}),this[t].hasOwnProperty(e)||(this[t][e]=[]),this[t][e].push(n)},off:function(e,n){void 0!==this[t]&&this[t].hasOwnProperty(e)&&function(t,e){for(var n=e.length-1;n>=0;n--)e[n]===t&&e.splice(n,1)}(n,this[t][e])},trigger:function(e){if(void 0!==this[t]&&this[t].hasOwnProperty(e))for(var n=Array.prototype.slice.call(arguments,1),r=0;r<this[t][e].length;r++)this[t][e][r].apply(this[t][e][r],n)},removeAllListeners:function(e){if(void 0!==this[t]){var n=this;n[t][e].forEach(function(t){n.off(e,t)})}}};return e};var i=r.createInterface("_handlers");r.prototype._on=i.on,r.prototype._off=i.off,r.prototype._trigger=i.trigger;var o=r.createInterface("handlers");r.prototype.on=function(){o.on.apply(this,arguments),Array.prototype.unshift.call(arguments,"on"),this._trigger.apply(this,arguments)},r.prototype.off=o.off,r.prototype.trigger=o.trigger,r.prototype.removeAllListeners=o.removeAllListeners,e.exports=r},{}],3:[function(t,n,r){(function(e){var r=t("./eventemitter.js"),i=t("../src/shared.js").guid;function o(t,e){var n=0;return function(){var r=Date.now();r-n>t&&(n=r,e.apply(this,arguments))}}var s,a=void 0===(s=e)||void 0===s.localStorage?{getItem:function(){},setItem:function(){},removeItem:function(){}}:s.localStorage;function u(){var t=this,n=Date.now();this.origin=i(),this.lastMessage=n,this.receivedIDs={},this.previousValues={};var r=function(){t._onStorageEvent.apply(t,arguments)};"undefined"!=typeof document&&(document.attachEvent?document.attachEvent("onstorage",r):e.addEventListener("storage",r,!1))}u.prototype._transaction=function(t){var e=1e3,n=20,r=this,i=!1,o=!1,s=null;function u(){if(!i){var c=Date.now(),f=0|a.getItem(l);if(f&&c-f<e)return o||(r._on("storage",u),o=!0),void(s=setTimeout(u,n));i=!0,a.setItem(l,c),t(),function(){o&&r._off("storage",u);s&&clearTimeout(s);a.removeItem(l)}()}}u()},u.prototype._cleanup_emit=o(100,function(){this._transaction(function(){var t,e=Date.now()-p,n=0;try{t=JSON.parse(a.getItem(f)||"[]")}catch(e){t=[]}for(var r=t.length-1;r>=0;r--)t[r].timestamp<e&&(t.splice(r,1),n++);n>0&&a.setItem(f,JSON.stringify(t))})}),u.prototype._cleanup_once=o(100,function(){var t=this;t._transaction(function(){Date.now();var e,n,r=0;try{n=JSON.parse(a.getItem(h)||"{}")}catch(t){n={}}for(e in n)t._once_expired(e,n)&&(delete n[e],r++);r>0&&a.setItem(h,JSON.stringify(n))})}),u.prototype._once_expired=function(t,e){if(!e)return!0;if(!e.hasOwnProperty(t))return!0;if("object"!=typeof e[t])return!0;var n=e[t].ttl||d,r=Date.now();return e[t].timestamp<r-n},u.prototype._localStorageChanged=function(t,e){if(t&&t.key)return t.key===e;var n=a.getItem(e);return n!==this.previousValues[e]&&(this.previousValues[e]=n,!0)},u.prototype._onStorageEvent=function(t){t=t||e.event;var n=this;this._localStorageChanged(t,f)&&this._transaction(function(){var t,e=Date.now(),r=a.getItem(f);try{t=JSON.parse(r||"[]")}catch(e){t=[]}for(var i=0;i<t.length;i++)if(t[i].origin!==n.origin&&!(t[i].timestamp<n.lastMessage)){if(t[i].id){if(n.receivedIDs.hasOwnProperty(t[i].id))continue;n.receivedIDs[t[i].id]=!0}n.trigger(t[i].name,t[i].payload)}n.lastMessage=e}),this._trigger("storage",t)},u.prototype._emit=function(t,e,n){if((n="string"==typeof n||"number"==typeof n?String(n):null)&&n.length){if(this.receivedIDs.hasOwnProperty(n))return;this.receivedIDs[n]=!0}var r={id:n,name:t,origin:this.origin,timestamp:Date.now(),payload:e},i=this;this._transaction(function(){var n=a.getItem(f)||"[]",o="[]"===n?"":",";n=[n.substring(0,n.length-1),o,JSON.stringify(r),"]"].join(""),a.setItem(f,n),i.trigger(t,e),setTimeout(function(){i._cleanup_emit()},50)})},u.prototype.emit=function(t,e){this._emit.apply(this,arguments),this._trigger("emit",t,e)},u.prototype.once=function(t,e,n){if(u.supported){var r=this;this._transaction(function(){var i;try{i=JSON.parse(a.getItem(h)||"{}")}catch(t){i={}}r._once_expired(t,i)&&(i[t]={},i[t].timestamp=Date.now(),"number"==typeof n&&(i[t].ttl=1e3*n),a.setItem(h,JSON.stringify(i)),e(),setTimeout(function(){r._cleanup_once()},50))})}},function(t,e){if(void 0!==t&&t||(t={}),"object"==typeof e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}(u.prototype,r.prototype),u.supported=void 0!==a;var c,f="intercom",h="intercom_once",l="intercom_lock",p=5e4,d=36e5;u.destroy=function(){a.removeItem(l),a.removeItem(f),a.removeItem(h)},u.getInstance=function(){return c||(c=new u),c},n.exports=u}).call(this,void 0!==e?e:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../src/shared.js":30,"./eventemitter.js":2}],4:[function(t,e,n){var r=Array.prototype,i=r.forEach,o=r.indexOf,s=r.some,a=Object.prototype.hasOwnProperty,u={};function c(t,e){return a.call(t,e)}var f=Object.keys||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)c(t,n)&&e.push(n);return e};function h(t){return t}function l(t,e,n){e||(e=h);var r=!1;return null==t?r:s&&t.some===s?t.some(e,n):(function(t,e,n){var r,o;if(null!=t)if(i&&t.forEach===i)t.forEach(e,n);else if(t.length===+t.length){for(r=0,o=t.length;r<o;r++)if(e.call(n,t[r],r,t)===u)return}else{var s=s(t);for(r=0,o=s.length;r<o;r++)if(e.call(n,t[s[r]],s[r],t)===u)return}}(t,function(t,i,o){if(r||(r=e.call(n,t,i,o)))return u}),!!r)}function p(t){this.value=t}p.prototype.has=function(t){return c(this.value,t)},p.prototype.contains=function(t){return function(t,e){return null!=t&&(o&&t.indexOf===o?-1!=t.indexOf(e):l(t,function(t){return t===e}))}(this.value,t)},p.prototype.size=function(){return null==(t=this.value)?0:t.length===+t.length?t.length:f(t).length;var t},e.exports=function(t){return t&&"object"==typeof t&&!Array.isArray(t)&&a.call(t,"__wrapped__")?t:new p(t)}},{}],5:[function(t,e,n){!function(){"use strict";for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),r=0;r<t.length;r++)e[t.charCodeAt(r)]=r;n.encode=function(e){var n,r=new Uint8Array(e),i=r.length,o="";for(n=0;n<i;n+=3)o+=t[r[n]>>2],o+=t[(3&r[n])<<4|r[n+1]>>4],o+=t[(15&r[n+1])<<2|r[n+2]>>6],o+=t[63&r[n+2]];return i%3==2?o=o.substring(0,o.length-1)+"=":i%3==1&&(o=o.substring(0,o.length-2)+"=="),o},n.decode=function(t){var n,r,i,o,s,a=.75*t.length,u=t.length,c=0;"="===t[t.length-1]&&(a--,"="===t[t.length-2]&&a--);var f=new ArrayBuffer(a),h=new Uint8Array(f);for(n=0;n<u;n+=4)r=e[t.charCodeAt(n)],i=e[t.charCodeAt(n+1)],o=e[t.charCodeAt(n+2)],s=e[t.charCodeAt(n+3)],h[c++]=r<<2|i>>4,h[c++]=(15&i)<<4|o>>2,h[c++]=(3&o)<<6|63&s;return f}}()},{}],6:[function(t,e,n){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(t){"use strict";var e="undefined"!=typeof Uint8Array?Uint8Array:Array,n="+".charCodeAt(0),i="/".charCodeAt(0),o="0".charCodeAt(0),s="a".charCodeAt(0),a="A".charCodeAt(0),u="-".charCodeAt(0),c="_".charCodeAt(0);function f(t){var e=t.charCodeAt(0);return e===n||e===u?62:e===i||e===c?63:e<o?-1:e<o+10?e-o+26+26:e<a+26?e-a:e<s+26?e-s+26:void 0}t.toByteArray=function(t){var n,r,i,o,s,a;if(t.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var u=t.length;s="="===t.charAt(u-2)?2:"="===t.charAt(u-1)?1:0,a=new e(3*t.length/4-s),i=s>0?t.length-4:t.length;var c=0;function h(t){a[c++]=t}for(n=0,r=0;n<i;n+=4,r+=3)h((16711680&(o=f(t.charAt(n))<<18|f(t.charAt(n+1))<<12|f(t.charAt(n+2))<<6|f(t.charAt(n+3))))>>16),h((65280&o)>>8),h(255&o);return 2===s?h(255&(o=f(t.charAt(n))<<2|f(t.charAt(n+1))>>4)):1===s&&(h((o=f(t.charAt(n))<<10|f(t.charAt(n+1))<<4|f(t.charAt(n+2))>>2)>>8&255),h(255&o)),a},t.fromByteArray=function(t){var e,n,i,o,s=t.length%3,a="";function u(t){return r.charAt(t)}for(e=0,i=t.length-s;e<i;e+=3)n=(t[e]<<16)+(t[e+1]<<8)+t[e+2],a+=u((o=n)>>18&63)+u(o>>12&63)+u(o>>6&63)+u(63&o);switch(s){case 1:a+=u((n=t[t.length-1])>>2),a+=u(n<<4&63),a+="==";break;case 2:a+=u((n=(t[t.length-2]<<8)+t[t.length-1])>>10),a+=u(n>>4&63),a+=u(n<<2&63),a+="="}return a}}(void 0===n?this.base64js={}:n)},{}],7:[function(t,n,r){(function(e){"use strict";var n=t("base64-js"),i=t("ieee754"),o=t("isarray");r.Buffer=u,r.SlowBuffer=function t(e,n){if(!(this instanceof t))return new t(e,n);var r=new u(e,n);delete r.parent;return r},r.INSPECT_MAX_BYTES=50,u.poolSize=8192;var s={};function a(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function u(t){return this instanceof u?(u.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof t?function(t,e){if(t=f(t,e<0?0:0|h(e)),!u.TYPED_ARRAY_SUPPORT)for(var n=0;n<e;n++)t[n]=0;return t}(this,t):"string"==typeof t?function(t,e,n){"string"==typeof n&&""!==n||(n="utf8");var r=0|l(e,n);return(t=f(t,r)).write(e,n),t}(this,t,arguments.length>1?arguments[1]:"utf8"):function(t,e){if(u.isBuffer(e))return function(t,e){var n=0|h(e.length);return t=f(t,n),e.copy(t,0,0,n),t}(t,e);if(o(e))return function(t,e){var n=0|h(e.length);t=f(t,n);for(var r=0;r<n;r+=1)t[r]=255&e[r];return t}(t,e);if(null==e)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(e.buffer instanceof ArrayBuffer)return c(t,e);if(e instanceof ArrayBuffer)return function(t,e){u.TYPED_ARRAY_SUPPORT?(e.byteLength,t=u._augment(new Uint8Array(e))):t=c(t,new Uint8Array(e));return t}(t,e)}return e.length?function(t,e){var n=0|h(e.length);t=f(t,n);for(var r=0;r<n;r+=1)t[r]=255&e[r];return t}(t,e):function(t,e){var n,r=0;"Buffer"===e.type&&o(e.data)&&(n=e.data,r=0|h(n.length)),t=f(t,r);for(var i=0;i<r;i+=1)t[i]=255&n[i];return t}(t,e)}(this,t)):arguments.length>1?new u(t,arguments[1]):new u(t)}function c(t,e){var n=0|h(e.length);t=f(t,n);for(var r=0;r<n;r+=1)t[r]=255&e[r];return t}function f(t,e){return u.TYPED_ARRAY_SUPPORT?(t=u._augment(new Uint8Array(e))).__proto__=u.prototype:(t.length=e,t._isBuffer=!0),0!==e&&e<=u.poolSize>>>1&&(t.parent=s),t}function h(t){if(t>=a())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a().toString(16)+" bytes");return 0|t}function l(t,e){"string"!=typeof t&&(t=""+t);var n=t.length;if(0===n)return 0;for(var r=!1;;)switch(e){case"ascii":case"binary":case"raw":case"raws":return n;case"utf8":case"utf-8":return B(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return F(t).length;default:if(r)return B(t).length;e=(""+e).toLowerCase(),r=!0}}function p(t,e,n,r){n=Number(n)||0;var i=t.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=e.length;if(o%2!=0)throw new Error("Invalid hex string");r>o/2&&(r=o/2);for(var s=0;s<r;s++){var a=parseInt(e.substr(2*s,2),16);if(isNaN(a))throw new Error("Invalid hex string");t[n+s]=a}return s}function d(t,e,n,r){return M(B(e,t.length-n),t,n,r)}function g(t,e,n,r){return M(function(t){for(var e=[],n=0;n<t.length;n++)e.push(255&t.charCodeAt(n));return e}(e),t,n,r)}function E(t,e,n,r){return g(t,e,n,r)}function m(t,e,n,r){return M(F(e),t,n,r)}function y(t,e,n,r){return M(function(t,e){for(var n,r,i,o=[],s=0;s<t.length&&!((e-=2)<0);s++)n=t.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r);return o}(e,t.length-n),t,n,r)}function v(t,e,r){return 0===e&&r===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(e,r))}function w(t,e,n){n=Math.min(t.length,n);for(var r=[],i=e;i<n;){var o,s,a,u,c=t[i],f=null,h=c>239?4:c>223?3:c>191?2:1;if(i+h<=n)switch(h){case 1:c<128&&(f=c);break;case 2:128==(192&(o=t[i+1]))&&(u=(31&c)<<6|63&o)>127&&(f=u);break;case 3:o=t[i+1],s=t[i+2],128==(192&o)&&128==(192&s)&&(u=(15&c)<<12|(63&o)<<6|63&s)>2047&&(u<55296||u>57343)&&(f=u);break;case 4:o=t[i+1],s=t[i+2],a=t[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(u=(15&c)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(f=u)}null===f?(f=65533,h=1):f>65535&&(f-=65536,r.push(f>>>10&1023|55296),f=56320|1023&f),r.push(f),i+=h}return function(t){var e=t.length;if(e<=b)return String.fromCharCode.apply(String,t);var n="",r=0;for(;r<e;)n+=String.fromCharCode.apply(String,t.slice(r,r+=b));return n}(r)}u.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){function t(){}try{var e=new Uint8Array(1);return e.foo=function(){return 42},e.constructor=t,42===e.foo()&&e.constructor===t&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(t){return!1}}(),u.TYPED_ARRAY_SUPPORT?(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array):(u.prototype.length=void 0,u.prototype.parent=void 0),u.isBuffer=function(t){return!(null==t||!t._isBuffer)},u.compare=function(t,e){if(!u.isBuffer(t)||!u.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var n=t.length,r=e.length,i=0,o=Math.min(n,r);i<o&&t[i]===e[i];)++i;return i!==o&&(n=t[i],r=e[i]),n<r?-1:r<n?1:0},u.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(t,e){if(!o(t))throw new TypeError("list argument must be an Array of Buffers.");if(0===t.length)return new u(0);var n;if(void 0===e)for(e=0,n=0;n<t.length;n++)e+=t[n].length;var r=new u(e),i=0;for(n=0;n<t.length;n++){var s=t[n];s.copy(r,i),i+=s.length}return r},u.byteLength=l,u.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?w(this,0,t):function(t,e,n){var r=!1;if(e|=0,n=void 0===n||n===1/0?this.length:0|n,t||(t="utf8"),e<0&&(e=0),n>this.length&&(n=this.length),n<=e)return"";for(;;)switch(t){case"hex":return O(this,e,n);case"utf8":case"utf-8":return w(this,e,n);case"ascii":return _(this,e,n);case"binary":return I(this,e,n);case"base64":return v(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,e,n);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}.apply(this,arguments)},u.prototype.equals=function(t){if(!u.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===u.compare(this,t)},u.prototype.inspect=function(){var t="",e=r.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,e).match(/.{2}/g).join(" "),this.length>e&&(t+=" ... ")),"<Buffer "+t+">"},u.prototype.compare=function(t){if(!u.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?0:u.compare(this,t)},u.prototype.indexOf=function(t,e){if(e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e>>=0,0===this.length)return-1;if(e>=this.length)return-1;if(e<0&&(e=Math.max(this.length+e,0)),"string"==typeof t)return 0===t.length?-1:String.prototype.indexOf.call(this,t,e);if(u.isBuffer(t))return n(this,t,e);if("number"==typeof t)return u.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,t,e):n(this,[t],e);function n(t,e,n){for(var r=-1,i=0;n+i<t.length;i++)if(t[n+i]===e[-1===r?0:i-r]){if(-1===r&&(r=i),i-r+1===e.length)return n+r}else r=-1;return-1}throw new TypeError("val must be string, number or Buffer")},u.prototype.get=function(t){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(t)},u.prototype.set=function(t,e){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(t,e)},u.prototype.write=function(t,e,n,r){if(void 0===e)r="utf8",n=this.length,e=0;else if(void 0===n&&"string"==typeof e)r=e,n=this.length,e=0;else if(isFinite(e))e|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0);else{var i=r;r=e,e=0|n,n=i}var o=this.length-e;if((void 0===n||n>o)&&(n=o),t.length>0&&(n<0||e<0)||e>this.length)throw new RangeError("attempt to write outside buffer bounds");r||(r="utf8");for(var s=!1;;)switch(r){case"hex":return p(this,t,e,n);case"utf8":case"utf-8":return d(this,t,e,n);case"ascii":return g(this,t,e,n);case"binary":return E(this,t,e,n);case"base64":return m(this,t,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return y(this,t,e,n);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var b=4096;function _(t,e,n){var r="";n=Math.min(t.length,n);for(var i=e;i<n;i++)r+=String.fromCharCode(127&t[i]);return r}function I(t,e,n){var r="";n=Math.min(t.length,n);for(var i=e;i<n;i++)r+=String.fromCharCode(t[i]);return r}function O(t,e,n){var r=t.length;(!e||e<0)&&(e=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=e;o<n;o++)i+=C(t[o]);return i}function A(t,e,n){for(var r=t.slice(e,n),i="",o=0;o<r.length;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function R(t,e,n){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>n)throw new RangeError("Trying to access beyond buffer length")}function T(t,e,n,r,i,o){if(!u.isBuffer(t))throw new TypeError("buffer must be a Buffer instance");if(e>i||e<o)throw new RangeError("value is out of bounds");if(n+r>t.length)throw new RangeError("index out of range")}function S(t,e,n,r){e<0&&(e=65535+e+1);for(var i=0,o=Math.min(t.length-n,2);i<o;i++)t[n+i]=(e&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function j(t,e,n,r){e<0&&(e=4294967295+e+1);for(var i=0,o=Math.min(t.length-n,4);i<o;i++)t[n+i]=e>>>8*(r?i:3-i)&255}function D(t,e,n,r,i,o){if(e>i||e<o)throw new RangeError("value is out of bounds");if(n+r>t.length)throw new RangeError("index out of range");if(n<0)throw new RangeError("index out of range")}function N(t,e,n,r,o){return o||D(t,e,n,4,3.4028234663852886e38,-3.4028234663852886e38),i.write(t,e,n,r,23,4),n+4}function x(t,e,n,r,o){return o||D(t,e,n,8,1.7976931348623157e308,-1.7976931348623157e308),i.write(t,e,n,r,52,8),n+8}u.prototype.slice=function(t,e){var n,r=this.length;if(t=~~t,e=void 0===e?r:~~e,t<0?(t+=r)<0&&(t=0):t>r&&(t=r),e<0?(e+=r)<0&&(e=0):e>r&&(e=r),e<t&&(e=t),u.TYPED_ARRAY_SUPPORT)n=u._augment(this.subarray(t,e));else{var i=e-t;n=new u(i,void 0);for(var o=0;o<i;o++)n[o]=this[o+t]}return n.length&&(n.parent=this.parent||this),n},u.prototype.readUIntLE=function(t,e,n){t|=0,e|=0,n||R(t,e,this.length);for(var r=this[t],i=1,o=0;++o<e&&(i*=256);)r+=this[t+o]*i;return r},u.prototype.readUIntBE=function(t,e,n){t|=0,e|=0,n||R(t,e,this.length);for(var r=this[t+--e],i=1;e>0&&(i*=256);)r+=this[t+--e]*i;return r},u.prototype.readUInt8=function(t,e){return e||R(t,1,this.length),this[t]},u.prototype.readUInt16LE=function(t,e){return e||R(t,2,this.length),this[t]|this[t+1]<<8},u.prototype.readUInt16BE=function(t,e){return e||R(t,2,this.length),this[t]<<8|this[t+1]},u.prototype.readUInt32LE=function(t,e){return e||R(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},u.prototype.readUInt32BE=function(t,e){return e||R(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},u.prototype.readIntLE=function(t,e,n){t|=0,e|=0,n||R(t,e,this.length);for(var r=this[t],i=1,o=0;++o<e&&(i*=256);)r+=this[t+o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*e)),r},u.prototype.readIntBE=function(t,e,n){t|=0,e|=0,n||R(t,e,this.length);for(var r=e,i=1,o=this[t+--r];r>0&&(i*=256);)o+=this[t+--r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*e)),o},u.prototype.readInt8=function(t,e){return e||R(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},u.prototype.readInt16LE=function(t,e){e||R(t,2,this.length);var n=this[t]|this[t+1]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt16BE=function(t,e){e||R(t,2,this.length);var n=this[t+1]|this[t]<<8;return 32768&n?4294901760|n:n},u.prototype.readInt32LE=function(t,e){return e||R(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},u.prototype.readInt32BE=function(t,e){return e||R(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},u.prototype.readFloatLE=function(t,e){return e||R(t,4,this.length),i.read(this,t,!0,23,4)},u.prototype.readFloatBE=function(t,e){return e||R(t,4,this.length),i.read(this,t,!1,23,4)},u.prototype.readDoubleLE=function(t,e){return e||R(t,8,this.length),i.read(this,t,!0,52,8)},u.prototype.readDoubleBE=function(t,e){return e||R(t,8,this.length),i.read(this,t,!1,52,8)},u.prototype.writeUIntLE=function(t,e,n,r){t=+t,e|=0,n|=0,r||T(this,t,e,n,Math.pow(2,8*n),0);var i=1,o=0;for(this[e]=255&t;++o<n&&(i*=256);)this[e+o]=t/i&255;return e+n},u.prototype.writeUIntBE=function(t,e,n,r){t=+t,e|=0,n|=0,r||T(this,t,e,n,Math.pow(2,8*n),0);var i=n-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+n},u.prototype.writeUInt8=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,1,255,0),u.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},u.prototype.writeUInt16LE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):S(this,t,e,!0),e+2},u.prototype.writeUInt16BE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):S(this,t,e,!1),e+2},u.prototype.writeUInt32LE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):j(this,t,e,!0),e+4},u.prototype.writeUInt32BE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):j(this,t,e,!1),e+4},u.prototype.writeIntLE=function(t,e,n,r){if(t=+t,e|=0,!r){var i=Math.pow(2,8*n-1);T(this,t,e,n,i-1,-i)}var o=0,s=1,a=t<0?1:0;for(this[e]=255&t;++o<n&&(s*=256);)this[e+o]=(t/s>>0)-a&255;return e+n},u.prototype.writeIntBE=function(t,e,n,r){if(t=+t,e|=0,!r){var i=Math.pow(2,8*n-1);T(this,t,e,n,i-1,-i)}var o=n-1,s=1,a=t<0?1:0;for(this[e+o]=255&t;--o>=0&&(s*=256);)this[e+o]=(t/s>>0)-a&255;return e+n},u.prototype.writeInt8=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,1,127,-128),u.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},u.prototype.writeInt16LE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):S(this,t,e,!0),e+2},u.prototype.writeInt16BE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):S(this,t,e,!1),e+2},u.prototype.writeInt32LE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):j(this,t,e,!0),e+4},u.prototype.writeInt32BE=function(t,e,n){return t=+t,e|=0,n||T(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),u.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):j(this,t,e,!1),e+4},u.prototype.writeFloatLE=function(t,e,n){return N(this,t,e,!0,n)},u.prototype.writeFloatBE=function(t,e,n){return N(this,t,e,!1,n)},u.prototype.writeDoubleLE=function(t,e,n){return x(this,t,e,!0,n)},u.prototype.writeDoubleBE=function(t,e,n){return x(this,t,e,!1,n)},u.prototype.copy=function(t,e,n,r){if(n||(n=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-n&&(r=t.length-e+n);var i,o=r-n;if(this===t&&n<e&&e<r)for(i=o-1;i>=0;i--)t[i+e]=this[i+n];else if(o<1e3||!u.TYPED_ARRAY_SUPPORT)for(i=0;i<o;i++)t[i+e]=this[i+n];else t._set(this.subarray(n,n+o),e);return o},u.prototype.fill=function(t,e,n){if(t||(t=0),e||(e=0),n||(n=this.length),n<e)throw new RangeError("end < start");if(n!==e&&0!==this.length){if(e<0||e>=this.length)throw new RangeError("start out of bounds");if(n<0||n>this.length)throw new RangeError("end out of bounds");var r;if("number"==typeof t)for(r=e;r<n;r++)this[r]=t;else{var i=B(t.toString()),o=i.length;for(r=e;r<n;r++)this[r]=i[r%o]}return this}},u.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(u.TYPED_ARRAY_SUPPORT)return new u(this).buffer;for(var t=new Uint8Array(this.length),e=0,n=t.length;e<n;e+=1)t[e]=this[e];return t.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var L=u.prototype;u._augment=function(t){return t.constructor=u,t._isBuffer=!0,t._set=t.set,t.get=L.get,t.set=L.set,t.write=L.write,t.toString=L.toString,t.toLocaleString=L.toString,t.toJSON=L.toJSON,t.equals=L.equals,t.compare=L.compare,t.indexOf=L.indexOf,t.copy=L.copy,t.slice=L.slice,t.readUIntLE=L.readUIntLE,t.readUIntBE=L.readUIntBE,t.readUInt8=L.readUInt8,t.readUInt16LE=L.readUInt16LE,t.readUInt16BE=L.readUInt16BE,t.readUInt32LE=L.readUInt32LE,t.readUInt32BE=L.readUInt32BE,t.readIntLE=L.readIntLE,t.readIntBE=L.readIntBE,t.readInt8=L.readInt8,t.readInt16LE=L.readInt16LE,t.readInt16BE=L.readInt16BE,t.readInt32LE=L.readInt32LE,t.readInt32BE=L.readInt32BE,t.readFloatLE=L.readFloatLE,t.readFloatBE=L.readFloatBE,t.readDoubleLE=L.readDoubleLE,t.readDoubleBE=L.readDoubleBE,t.writeUInt8=L.writeUInt8,t.writeUIntLE=L.writeUIntLE,t.writeUIntBE=L.writeUIntBE,t.writeUInt16LE=L.writeUInt16LE,t.writeUInt16BE=L.writeUInt16BE,t.writeUInt32LE=L.writeUInt32LE,t.writeUInt32BE=L.writeUInt32BE,t.writeIntLE=L.writeIntLE,t.writeIntBE=L.writeIntBE,t.writeInt8=L.writeInt8,t.writeInt16LE=L.writeInt16LE,t.writeInt16BE=L.writeInt16BE,t.writeInt32LE=L.writeInt32LE,t.writeInt32BE=L.writeInt32BE,t.writeFloatLE=L.writeFloatLE,t.writeFloatBE=L.writeFloatBE,t.writeDoubleLE=L.writeDoubleLE,t.writeDoubleBE=L.writeDoubleBE,t.fill=L.fill,t.inspect=L.inspect,t.toArrayBuffer=L.toArrayBuffer,t};var P=/[^+\/0-9A-Za-z-_]/g;function C(t){return t<16?"0"+t.toString(16):t.toString(16)}function B(t,e){var n;e=e||1/0;for(var r=t.length,i=null,o=[],s=0;s<r;s++){if((n=t.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(e-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(e-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((e-=1)<0)break;o.push(n)}else if(n<2048){if((e-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((e-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function F(t){return n.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(P,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function M(t,e,n,r){for(var i=0;i<r&&!(i+n>=e.length||i>=t.length);i++)e[i+n]=t[i];return i}}).call(this,void 0!==e?e:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":6,ieee754:9,isarray:8}],8:[function(t,e,n){var r={}.toString;e.exports=Array.isArray||function(t){return"[object Array]"==r.call(t)}},{}],9:[function(t,e,n){n.read=function(t,e,n,r,i){var o,s,a=8*i-r-1,u=(1<<a)-1,c=u>>1,f=-7,h=n?i-1:0,l=n?-1:1,p=t[e+h];for(h+=l,o=p&(1<<-f)-1,p>>=-f,f+=a;f>0;o=256*o+t[e+h],h+=l,f-=8);for(s=o&(1<<-f)-1,o>>=-f,f+=r;f>0;s=256*s+t[e+h],h+=l,f-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,r),o-=c}return(p?-1:1)*s*Math.pow(2,o-r)},n.write=function(t,e,n,r,i,o){var s,a,u,c=8*o-i-1,f=(1<<c)-1,h=f>>1,l=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:o-1,d=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=f):(s=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-s))<1&&(s--,u*=2),(e+=s+h>=1?l/u:l*Math.pow(2,1-h))*u>=2&&(s++,u/=2),s+h>=f?(a=0,s=f):s+h>=1?(a=(e*u-1)*Math.pow(2,i),s+=h):(a=e*Math.pow(2,h-1)*Math.pow(2,i),s=0));i>=8;t[n+p]=255&a,p+=d,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;t[n+p]=255&s,p+=d,s/=256,c-=8);t[n+p-d]|=128*g}},{}],10:[function(t,e,n){!function(){function t(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function n(){return 1}function r(t){if(!(this instanceof r))return new r(t);"number"==typeof t&&(t={max:t}),t||(t={}),this._max=t.max,(!this._max||"number"!=typeof this._max||this._max<=0)&&(this._max=1/0),this._lengthCalculator=t.length||n,"function"!=typeof this._lengthCalculator&&(this._lengthCalculator=n),this._allowStale=t.stale||!1,this._maxAge=t.maxAge||null,this._dispose=t.dispose,this.reset()}function i(t,e,n){var r=t._cache[e];return r&&(t._maxAge&&Date.now()-r.now>t._maxAge?(a(t,r),t._allowStale||(r=void 0)):n&&function(t,e){s(t,e),e.lu=t._mru++,t._maxAge&&(e.now=Date.now());t._lruList[e.lu]=e}(t,r),r&&(r=r.value)),r}function o(t){for(;t._lru<t._mru&&t._length>t._max;)a(t,t._lruList[t._lru])}function s(t,e){for(delete t._lruList[e.lu];t._lru<t._mru&&!t._lruList[t._lru];)t._lru++}function a(t,e){e&&(t._dispose&&t._dispose(e.key,e.value),t._length-=e.length,t._itemCount--,delete t._cache[e.key],s(t,e))}"object"==typeof e&&e.exports?e.exports=r:this.LRUCache=r,Object.defineProperty(r.prototype,"max",{set:function(t){(!t||"number"!=typeof t||t<=0)&&(t=1/0),this._max=t,this._length>this._max&&o(this)},get:function(){return this._max},enumerable:!0}),Object.defineProperty(r.prototype,"lengthCalculator",{set:function(t){if("function"!=typeof t)for(var e in this._lengthCalculator=n,this._length=this._itemCount,this._cache)this._cache[e].length=1;else for(var e in this._lengthCalculator=t,this._length=0,this._cache)this._cache[e].length=this._lengthCalculator(this._cache[e].value),this._length+=this._cache[e].length;this._length>this._max&&o(this)},get:function(){return this._lengthCalculator},enumerable:!0}),Object.defineProperty(r.prototype,"length",{get:function(){return this._length},enumerable:!0}),Object.defineProperty(r.prototype,"itemCount",{get:function(){return this._itemCount},enumerable:!0}),r.prototype.forEach=function(t,e){e=e||this;for(var n=0,r=this._mru-1;r>=0&&n<this._itemCount;r--)if(this._lruList[r]){n++;var i=this._lruList[r];this._maxAge&&Date.now()-i.now>this._maxAge&&(a(this,i),this._allowStale||(i=void 0)),i&&t.call(e,i.value,i.key,this)}},r.prototype.keys=function(){for(var t=new Array(this._itemCount),e=0,n=this._mru-1;n>=0&&e<this._itemCount;n--)if(this._lruList[n]){var r=this._lruList[n];t[e++]=r.key}return t},r.prototype.values=function(){for(var t=new Array(this._itemCount),e=0,n=this._mru-1;n>=0&&e<this._itemCount;n--)if(this._lruList[n]){var r=this._lruList[n];t[e++]=r.value}return t},r.prototype.reset=function(){if(this._dispose&&this._cache)for(var t in this._cache)this._dispose(t,this._cache[t].value);this._cache=Object.create(null),this._lruList=Object.create(null),this._mru=0,this._lru=0,this._length=0,this._itemCount=0},r.prototype.dump=function(){return this._cache},r.prototype.dumpLru=function(){return this._lruList},r.prototype.set=function(e,n){if(t(this._cache,e))return this._dispose&&this._dispose(e,this._cache[e].value),this._maxAge&&(this._cache[e].now=Date.now()),this._cache[e].value=n,this.get(e),!0;var r=this._lengthCalculator(n),i=this._maxAge?Date.now():0,s=new function(t,e,n,r,i){this.key=t,this.value=e,this.lu=n,this.length=r,this.now=i}(e,n,this._mru++,r,i);return s.length>this._max?(this._dispose&&this._dispose(e,n),!1):(this._length+=s.length,this._lruList[s.lu]=this._cache[e]=s,this._itemCount++,this._length>this._max&&o(this),!0)},r.prototype.has=function(e){if(!t(this._cache,e))return!1;var n=this._cache[e];return!(this._maxAge&&Date.now()-n.now>this._maxAge)},r.prototype.get=function(t){return i(this,t,!0)},r.prototype.peek=function(t){return i(this,t,!1)},r.prototype.pop=function(){var t=this._lruList[this._lru];return a(this,t),t||null},r.prototype.del=function(t){a(this,this._cache[t])}}()},{}],11:[function(t,e,r){!function(t,e,n,r){n?n.exports=g:e.minimatch=g,t||(t=function(t){switch(t){case"sigmund":return function(t){return JSON.stringify(t)};case"path":return{basename:function(t){var e=(t=t.split(/[\/\\]/)).pop();return e||(e=t.pop()),e}};case"lru-cache":return function(){var t={},e=0;this.set=function(n,r){++e>=100&&(t={}),t[n]=r},this.get=function(e){return t[e]}}}}),g.Minimatch=E;var i=t("lru-cache"),o=g.cache=new i({max:100}),s=g.GLOBSTAR=E.GLOBSTAR={},a=t("sigmund"),u=(t("path"),"[^/]"),c=u+"*?",f="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",h="(?:(?!(?:\\/|^)\\.).)*?",l="().*{}+?[]^$\\!".split("").reduce(function(t,e){return t[e]=!0,t},{});var p=/\/+/;function d(t,e){t=t||{},e=e||{};var n={};return Object.keys(e).forEach(function(t){n[t]=e[t]}),Object.keys(t).forEach(function(e){n[e]=t[e]}),n}function g(t,e,n){if("string"!=typeof e)throw new TypeError("glob pattern string required");return n||(n={}),!(!n.nocomment&&"#"===e.charAt(0))&&(""===e.trim()?""===t:new E(e,n).match(t))}function E(t,e){if(!(this instanceof E))return new E(t,e,o);if("string"!=typeof t)throw new TypeError("glob pattern string required");e||(e={}),t=t.trim(),"win32"===r&&(t=t.split("\\").join("/"));var n=t+"\n"+a(e),i=g.cache.get(n);if(i)return i;g.cache.set(n,this),this.options=e,this.set=[],this.pattern=t,this.regexp=null,this.negate=!1,this.comment=!1,this.empty=!1,this.make()}function m(t,e,n){return n=n||"0",(t+="").length>=e?t:new Array(e-t.length+1).join(n)+t}g.filter=function(t,e){return e=e||{},function(n,r,i){return g(n,t,e)}},g.defaults=function(t){if(!t||!Object.keys(t).length)return g;var e=g,n=function(n,r,i){return e.minimatch(n,r,d(t,i))};return n.Minimatch=function(n,r){return new e.Minimatch(n,d(t,r))},n},E.defaults=function(t){return t&&Object.keys(t).length?g.defaults(t).Minimatch:E},E.prototype.debug=function(){},E.prototype.make=function(){if(this._made)return;var t=this.pattern,e=this.options;if(!e.nocomment&&"#"===t.charAt(0))return void(this.comment=!0);if(!t)return void(this.empty=!0);this.parseNegate();var n=this.globSet=this.braceExpand();e.debug&&(this.debug=console.error);this.debug(this.pattern,n),n=this.globParts=n.map(function(t){return t.split(p)}),this.debug(this.pattern,n),n=n.map(function(t,e,n){return t.map(this.parse,this)},this),this.debug(this.pattern,n),n=n.filter(function(t){return-1===t.indexOf(!1)}),this.debug(this.pattern,n),this.set=n},E.prototype.parseNegate=function(){var t=this.pattern,e=!1,n=0;if(this.options.nonegate)return;for(var r=0,i=t.length;r<i&&"!"===t.charAt(r);r++)e=!e,n++;n&&(this.pattern=t.substr(n));this.negate=e},g.braceExpand=function(t,e){return new E(t,e).braceExpand()},E.prototype.braceExpand=function t(e,n){n=n||this.options;e=void 0===e?this.pattern:e;if(void 0===e)throw new Error("undefined pattern");if(n.nobrace||!e.match(/\{.*\}/))return[e];var r=!1;if("{"!==e.charAt(0)){this.debug(e);for(var i=null,o=0,s=e.length;o<s;o++){var a=e.charAt(o);if(this.debug(o,a),"\\"===a)r=!r;else if("{"===a&&!r){i=e.substr(0,o);break}}if(null===i)return this.debug("no sets"),[e];var u=t.call(this,e.substr(o),n);return u.map(function(t){return i+t})}var c=e.match(/^\{(-?[0-9]+)\.\.(-?[0-9]+)\}/);if(c){this.debug("numset",c[1],c[2]);for(var f,h=t.call(this,e.substr(c[0].length),n),l=+c[1],p="0"===c[1][0],d=c[1].length,g=+c[2],E=l>g?-1:1,y=[],o=l;o!=g+E;o+=E){f=p?m(o,d):o+"";for(var v=0,w=h.length;v<w;v++)y.push(f+h[v])}return y}var o=1,b=1,y=[],_="",r=!1;function I(){y.push(_),_=""}this.debug("Entering for");t:for(o=1,s=e.length;o<s;o++){var a=e.charAt(o);if(this.debug("",o,a),r)r=!1,_+="\\"+a;else switch(a){case"\\":r=!0;continue;case"{":b++,_+="{";continue;case"}":if(0===--b){I(),o++;break t}_+=a;continue;case",":1===b?I():_+=a;continue;default:_+=a;continue}}if(0!==b)return this.debug("didn't close",e),t.call(this,"\\"+e,n);this.debug("set",y);this.debug("suffix",e.substr(o));var h=t.call(this,e.substr(o),n);var O=1===y.length;this.debug("set pre-expanded",y);y=y.map(function(e){return t.call(this,e,n)},this);this.debug("set expanded",y);y=y.reduce(function(t,e){return t.concat(e)});O&&(y=y.map(function(t){return"{"+t+"}"}));var A=[];for(var o=0,s=y.length;o<s;o++)for(var v=0,w=h.length;v<w;v++)A.push(y[o]+h[v]);return A},E.prototype.parse=function(t,e){var n=this.options;if(!n.noglobstar&&"**"===t)return s;if(""===t)return"";var r,i,o,a="",f=!!n.nocase,h=!1,p=[],d=!1,g=-1,E=-1,m="."===t.charAt(0)?"":n.dot?"(?!(?:^|\\/)\\.{1,2}(?:$|\\/))":"(?!\\.)",v=this;function w(){if(i){switch(i){case"*":a+=c,f=!0;break;case"?":a+=u,f=!0;break;default:a+="\\"+i}v.debug("clearStateChar %j %j",i,a),i=!1}}for(var b,_=0,I=t.length;_<I&&(b=t.charAt(_));_++)if(this.debug("%s\t%s %s %j",t,_,a,b),h&&l[b])a+="\\"+b,h=!1;else switch(b){case"/":return!1;case"\\":w(),h=!0;continue;case"?":case"*":case"+":case"@":case"!":if(this.debug("%s\t%s %s %j <-- stateChar",t,_,a,b),d){this.debug("  in class"),"!"===b&&_===E+1&&(b="^"),a+=b;continue}v.debug("call clearStateChar %j",i),w(),i=b,n.noext&&w();continue;case"(":if(d){a+="(";continue}if(!i){a+="\\(";continue}r=i,p.push({type:r,start:_-1,reStart:a.length}),a+="!"===i?"(?:(?!":"(?:",this.debug("plType %j %j",i,a),i=!1;continue;case")":if(d||!p.length){a+="\\)";continue}switch(w(),f=!0,a+=")",r=p.pop().type){case"!":a+="[^/]*?)";break;case"?":case"+":case"*":a+=r}continue;case"|":if(d||!p.length||h){a+="\\|",h=!1;continue}w(),a+="|";continue;case"[":if(w(),d){a+="\\"+b;continue}d=!0,E=_,g=a.length,a+=b;continue;case"]":if(_===E+1||!d){a+="\\"+b,h=!1;continue}f=!0,d=!1,a+=b;continue;default:w(),h?h=!1:!l[b]||"^"===b&&d||(a+="\\"),a+=b}if(d){var O=t.substr(E+1),A=this.parse(O,y);a=a.substr(0,g)+"\\["+A[0],f=f||A[1]}for(;o=p.pop();){var R=a.slice(o.reStart+3);R=R.replace(/((?:\\{2})*)(\\?)\|/g,function(t,e,n){return n||(n="\\"),e+e+n+"|"}),this.debug("tail=%j\n   %s",R,R);var T="*"===o.type?c:"?"===o.type?u:"\\"+o.type;f=!0,a=a.slice(0,o.reStart)+T+"\\("+R}w(),h&&(a+="\\\\");var S=!1;switch(a.charAt(0)){case".":case"[":case"(":S=!0}""!==a&&f&&(a="(?=.)"+a);S&&(a=m+a);if(e===y)return[a,f];if(!f)return t.replace(/\\(.)/g,"$1");var j=n.nocase?"i":"",D=new RegExp("^"+a+"$",j);return D._glob=t,D._src=a,D};var y={};g.makeRe=function(t,e){return new E(t,e||{}).makeRe()},E.prototype.makeRe=function(){if(this.regexp||!1===this.regexp)return this.regexp;var t=this.set;if(!t.length)return this.regexp=!1;var e=this.options,n=e.noglobstar?c:e.dot?f:h,r=e.nocase?"i":"",i=t.map(function(t){return t.map(function(t){return t===s?n:"string"==typeof t?t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"):t._src}).join("\\/")}).join("|");i="^(?:"+i+")$",this.negate&&(i="^(?!"+i+").*$");try{return this.regexp=new RegExp(i,r)}catch(t){return this.regexp=!1}},g.match=function(t,e,n){var r=new E(e,n=n||{});return t=t.filter(function(t){return r.match(t)}),r.options.nonull&&!t.length&&t.push(e),t},E.prototype.match=function(t,e){if(this.debug("match",t,this.pattern),this.comment)return!1;if(this.empty)return""===t;if("/"===t&&e)return!0;var n=this.options;"win32"===r&&(t=t.split("\\").join("/"));t=t.split(p),this.debug(this.pattern,"split",t);var i,o=this.set;this.debug(this.pattern,"set",o);for(var s=t.length-1;s>=0&&!(i=t[s]);s--);for(var s=0,a=o.length;s<a;s++){var u=o[s],c=t;n.matchBase&&1===u.length&&(c=[i]);var f=this.matchOne(c,u,e);if(f)return!!n.flipNegate||!this.negate}return!n.flipNegate&&this.negate},E.prototype.matchOne=function(t,e,n){var r=this.options;this.debug("matchOne",{this:this,file:t,pattern:e}),this.debug("matchOne",t.length,e.length);for(var i=0,o=0,a=t.length,u=e.length;i<a&&o<u;i++,o++){this.debug("matchOne loop");var c,f=e[o],h=t[i];if(this.debug(e,f,h),!1===f)return!1;if(f===s){this.debug("GLOBSTAR",[e,f,h]);var l=i,p=o+1;if(p===u){for(this.debug("** at the end");i<a;i++)if("."===t[i]||".."===t[i]||!r.dot&&"."===t[i].charAt(0))return!1;return!0}t:for(;l<a;){var d=t[l];if(this.debug("\nglobstar while",t,l,e,p,d),this.matchOne(t.slice(l),e.slice(p),n))return this.debug("globstar found match!",l,a,d),!0;if("."===d||".."===d||!r.dot&&"."===d.charAt(0)){this.debug("dot detected!",t,l,e,p);break t}this.debug("globstar swallow a segment, and continue"),l++}return!(!n||(this.debug("\n>>> no match, partial?",t,l,e,p),l!==a))}if("string"==typeof f?(c=r.nocase?h.toLowerCase()===f.toLowerCase():h===f,this.debug("string match",f,h,c)):(c=h.match(f),this.debug("pattern match",f,h,c)),!c)return!1}if(i===a&&o===u)return!0;if(i===a)return n;if(o===u)return i===a-1&&""===t[i];throw new Error("wtf?")}}("function"==typeof t?t:null,this,"object"==typeof e?e:null,"object"==typeof n?n.platform:"win32")},{"lru-cache":10,path:12,sigmund:13}],12:[function(t,e,r){function i(t,e){for(var n=0,r=t.length-1;r>=0;r--){var i=t[r];"."===i?t.splice(r,1):".."===i?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var o=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,s=function(t){return o.exec(t).slice(1)};function a(t,e){if(t.filter)return t.filter(e);for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}r.resolve=function(){for(var t="",e=!1,r=arguments.length-1;r>=-1&&!e;r--){var o=r>=0?arguments[r]:n.cwd();if("string"!=typeof o)throw new TypeError("Arguments to path.resolve must be strings");o&&(t=o+"/"+t,e="/"===o.charAt(0))}return t=i(a(t.split("/"),function(t){return!!t}),!e).join("/"),(e?"/":"")+t||"."},r.normalize=function(t){var e=r.isAbsolute(t),n="/"===u(t,-1);return(t=i(a(t.split("/"),function(t){return!!t}),!e).join("/"))||e||(t="."),t&&n&&(t+="/"),(e?"/":"")+t},r.isAbsolute=function(t){return"/"===t.charAt(0)},r.join=function(){var t=Array.prototype.slice.call(arguments,0);return r.normalize(a(t,function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))},r.relative=function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=r.resolve(t).substr(1),e=r.resolve(e).substr(1);for(var i=n(t.split("/")),o=n(e.split("/")),s=Math.min(i.length,o.length),a=s,u=0;u<s;u++)if(i[u]!==o[u]){a=u;break}var c=[];for(u=a;u<i.length;u++)c.push("..");return(c=c.concat(o.slice(a))).join("/")},r.sep="/",r.delimiter=":",r.dirname=function(t){var e=s(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},r.basename=function(t,e){var n=s(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},r.extname=function(t){return s(t)[3]};var u="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return e<0&&(e=t.length+e),t.substr(e,n)}},{}],13:[function(t,e,n){e.exports=function(t,e){e=e||10;var n=[],r="",i=RegExp;return function t(o,s){s>e||"function"!=typeof o&&void 0!==o&&("object"!=typeof o||!o||o instanceof i?r+=o:-1===n.indexOf(o)&&s!==e&&(n.push(o),r+="{",Object.keys(o).forEach(function(e,n,i){if("_"!==e.charAt(0)){var a=typeof o[e];"function"!==a&&"undefined"!==a&&(r+=e,t(o[e],s+1))}})))}(t,0),r}},{}],14:[function(t,e,n){(function(t){function n(e,n,r){return e instanceof ArrayBuffer&&(e=new Uint8Array(e)),new t(e,n,r)}n.prototype=Object.create(t.prototype),n.prototype.constructor=n,Object.keys(t).forEach(function(e){t.hasOwnProperty(e)&&(n[e]=t[e])}),e.exports=n}).call(this,t("buffer").Buffer)},{buffer:7}],15:[function(t,e,n){e.exports={FILE_SYSTEM_NAME:"local",FILE_STORE_NAME:"files",IDB_RO:"readonly",IDB_RW:"readwrite",WSQL_VERSION:"1",WSQL_SIZE:5242880,WSQL_DESC:"FileSystem Storage",NODE_TYPE_FILE:"FILE",NODE_TYPE_DIRECTORY:"DIRECTORY",NODE_TYPE_SYMBOLIC_LINK:"SYMLINK",NODE_TYPE_META:"META",S_IFREG:32768,S_IFDIR:16384,S_IFLNK:40960,DEFAULT_DIR_PERMISSIONS:493,DEFAULT_FILE_PERMISSIONS:420,FULL_READ_WRITE_EXEC_PERMISSIONS:511,READ_WRITE_PERMISSIONS:438,SYMLOOP_MAX:10,BINARY_MIME_TYPE:"application/octet-stream",JSON_MIME_TYPE:"application/json",ROOT_DIRECTORY_NAME:"/",FS_FORMAT:"FORMAT",FS_NOCTIME:"NOCTIME",FS_NOMTIME:"NOMTIME",FS_NODUPEIDCHECK:"FS_NODUPEIDCHECK",O_READ:"READ",O_WRITE:"WRITE",O_CREATE:"CREATE",O_EXCLUSIVE:"EXCLUSIVE",O_TRUNCATE:"TRUNCATE",O_APPEND:"APPEND",O_FLAGS:{r:["READ"],"r+":["READ","WRITE"],w:["WRITE","CREATE","TRUNCATE"],"w+":["WRITE","READ","CREATE","TRUNCATE"],wx:["WRITE","CREATE","EXCLUSIVE","TRUNCATE"],"wx+":["WRITE","READ","CREATE","EXCLUSIVE","TRUNCATE"],a:["WRITE","CREATE","APPEND"],"a+":["WRITE","READ","CREATE","APPEND"],ax:["WRITE","CREATE","EXCLUSIVE","APPEND"],"ax+":["WRITE","READ","CREATE","EXCLUSIVE","APPEND"]},XATTR_CREATE:"CREATE",XATTR_REPLACE:"REPLACE",FS_READY:"READY",FS_PENDING:"PENDING",FS_ERROR:"ERROR",SUPER_NODE_ID:"00000000-0000-0000-0000-000000000000",STDIN:0,STDOUT:1,STDERR:2,FIRST_DESCRIPTOR:3,ENVIRONMENT:{TMP:"/tmp",PATH:""},fsConstants:{O_RDONLY:0,O_WRONLY:1,O_RDWR:2,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:512,O_EXCL:2048,O_NOCTTY:131072,O_TRUNC:1024,O_APPEND:8,O_DIRECTORY:1048576,O_NOFOLLOW:256,O_SYNC:128,O_DSYNC:4194304,O_SYMLINK:2097152,O_NONBLOCK:4,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1}}},{}],16:[function(t,e,n){var r=t("./constants.js").NODE_TYPE_FILE;e.exports=function(t,e){this.id=t,this.type=e||r}},{"./constants.js":15}],17:[function(t,e,n){(function(t){e.exports={encode:function(e){return new t(e,"utf8")},decode:function(t){return t.toString("utf8")}}}).call(this,t("buffer").Buffer)},{buffer:7}],18:[function(t,e,n){var r={};["9:EBADF:bad file descriptor","10:EBUSY:resource busy or locked","18:EINVAL:invalid argument","27:ENOTDIR:not a directory","28:EISDIR:illegal operation on a directory","34:ENOENT:no such file or directory","47:EEXIST:file already exists","50:EPERM:operation not permitted","51:ELOOP:too many symbolic links encountered","53:ENOTEMPTY:directory not empty","55:EIO:i/o error","1000:ENOTMOUNTED:not mounted","1001:EFILESYSTEMERROR:missing super node, use 'FORMAT' flag to format filesystem.","1002:ENOATTR:attribute does not exist"].forEach(function(t){var e=+(t=t.split(":"))[0],n=t[1],i=t[2];function o(t,r){Error.call(this),this.name=n,this.code=n,this.errno=e,this.message=t||i,r&&(this.path=r),this.stack=new Error(this.message).stack}o.prototype=Object.create(Error.prototype),o.prototype.constructor=o,o.prototype.toString=function(){var t=this.path?", '"+this.path+"'":"";return this.name+": "+this.message+t},r[n]=r[e]=o}),e.exports=r},{}],19:[function(t,e,n){var r=t("../../lib/nodash.js"),i=t("../path.js"),o=i.normalize,s=i.dirname,a=i.basename,u=i.isAbsolute,c=i.isNull,f=t("../constants.js"),h=f.NODE_TYPE_FILE,l=f.NODE_TYPE_DIRECTORY,p=f.NODE_TYPE_SYMBOLIC_LINK,d=f.NODE_TYPE_META,g=(f.DEFAULT_FILE_PERMISSIONS,f.DEFAULT_DIR_PERMISSIONS,f.FULL_READ_WRITE_EXEC_PERMISSIONS),E=f.ROOT_DIRECTORY_NAME,m=f.SUPER_NODE_ID,y=f.SYMLOOP_MAX,v=f.O_READ,w=f.O_WRITE,b=f.O_CREATE,_=f.O_EXCLUSIVE,I=(f.O_TRUNCATE,f.O_APPEND),O=f.O_FLAGS,A=f.XATTR_CREATE,R=f.XATTR_REPLACE,T=f.FS_NOMTIME,S=f.FS_NOCTIME,j=t("../encoding.js"),D=t("../errors.js"),N=t("../directory-entry.js"),x=t("../open-file-description.js"),L=t("../super-node.js"),P=t("../node.js"),C=t("../stats.js"),B=t("../buffer.js");function F(t,e,n,i,o){var s=t.flags;r(s).contains(S)&&delete i.ctime,r(s).contains(T)&&delete i.mtime;var a=!1;function u(n){t.changes.push({event:"change",path:e}),o(n)}i.ctime&&(n.ctime=i.ctime,n.atime=i.ctime,a=!0),i.atime&&(n.atime=i.atime,a=!0),i.mtime&&(n.mtime=i.mtime,a=!0),a?t.putObject(n.id,n,u):u()}function M(t,e,n){if(!(e=o(e)))return n(new D.ENOENT("path is an empty string"));var i=a(e),u=s(e),c=0;function f(e,r){e?n(e):r&&r.type===d&&r.rnode?t.getObject(r.rnode,h):n(new D.EFILESYSTEMERROR)}function h(t,e){t?n(t):e?n(null,e):n(new D.ENOENT)}function g(r,i){r?n(r):i.type===l&&i.data?t.getObject(i.data,v):n(new D.ENOTDIR("a component of the path prefix is not a directory",e))}function v(o,s){if(o)n(o);else if(r(s).has(i)){var a=s[i].id;t.getObject(a,w)}else n(new D.ENOENT(null,e))}function w(r,h){var l;r?n(r):h.type===p?++c>y?n(new D.ELOOP(null,e)):(l=h.data,l=o(l),u=s(l),i=a(l),E===i?t.getObject(m,f):M(t,u,g)):n(null,h)}E===i?t.getObject(m,f):M(t,u,g)}function U(t,e,n,r,i,o,s){var a=n.xattrs;o===A&&a.hasOwnProperty(r)?s(new D.EEXIST("attribute already exists",e)):o!==R||a.hasOwnProperty(r)?(a[r]=i,t.putObject(n.id,n,function(r){r?s(r):F(t,e,n,{ctime:Date.now()},s)})):s(new D.ENOATTR(null,e))}function Y(t,e,n){e=o(e);var i,u,c,f=a(e),h=s(e);function p(o,s){o?n(o):E===f?n(new D.EBUSY(null,e)):r(s).has(f)?(i=(c=s)[f].id,t.getObject(i,d)):n(new D.ENOENT(null,e))}function d(r,o){r?n(r):o.type!==l?n(new D.ENOTDIR(null,e)):(i=o,t.getObject(i.data,g))}function g(i,o){i?n(i):r(o).size()>0?n(new D.ENOTEMPTY(null,e)):(delete c[f],t.putObject(u.data,c,m))}function m(e){if(e)n(e);else{var r=Date.now();F(t,h,u,{mtime:r,ctime:r},y)}}function y(e){e?n(e):t.delete(i.id,v)}function v(e){e?n(e):t.delete(i.data,n)}M(t,h,function(e,r){e?n(e):(u=r,t.getObject(u.data,p))})}function k(t,e,n,i){e=o(e);var u,c,f,d,g,m=a(e),v=s(e),I=0;function O(n,r){n?i(n):r.type!==l?i(new D.ENOENT(null,e)):(u=r,t.getObject(u.data,A))}function A(o,s){o?i(o):r(c=s).has(m)?r(n).contains(_)?i(new D.ENOENT("O_CREATE and O_EXCLUSIVE are set, and the named file exists",e)):(f=c[m]).type===l&&r(n).contains(w)?i(new D.EISDIR("the named file is a directory and O_WRITE is set",e)):t.getObject(f.id,R):r(n).contains(b)?P.create({guid:t.guid,type:h},function(e,n){e?i(e):((d=n).nlinks+=1,t.putObject(d.id,d,S))}):i(new D.ENOENT("O_CREATE is not set and the named file does not exist",e))}function R(u,c){if(u)i(u);else{var f=c;f.type===p?++I>y?i(new D.ELOOP(null,e)):function(u){u=o(u),v=s(u),m=a(u),E===m&&(r(n).contains(w)?i(new D.EISDIR("the named file is a directory and O_WRITE is set",e)):M(t,e,T));M(t,v,O)}(f.data):T(void 0,f)}}function T(t,e){t?i(t):i(null,d=e)}function S(e){e?i(e):((g=new B(0)).fill(0),t.putBuffer(d.data,g,x))}function j(e){if(e)i(e);else{var n=Date.now();F(t,v,u,{mtime:n,ctime:n},L)}}function x(e){e?i(e):(c[m]=new N(d.id,h),t.putObject(u.data,c,j))}function L(t){t?i(t):i(null,d)}E===m?r(n).contains(w)?i(new D.EISDIR("the named file is a directory and O_WRITE is set",e)):M(t,e,T):M(t,v,O)}function V(t,e,n,r,i,o,s){var a,u;function c(t){t?s(t):s(null,i)}function f(n){if(n)s(n);else{var r=Date.now();F(t,e.path,a,{mtime:r,ctime:r},c)}}function h(e){e?s(e):t.putObject(a.id,a,f)}function l(c,f){if(c)s(c);else{if(!(u=f))return s(new D.EIO("Expected Buffer"));var l=void 0!==o&&null!==o?o:e.position,p=Math.max(u.length,l+i),d=new B(p);d.fill(0),u&&u.copy(d),n.copy(d,l,r,r+i),void 0===o&&(e.position+=i),a.size=p,a.version+=1,t.putBuffer(a.data,d,h)}}t.getObject(e.id,function(e,n){e?s(e):(a=n,t.getBuffer(a.data,l))})}function W(t,e,n,r,i,o,s){var a,u;function c(t,a){if(t)s(t);else{if(!(u=a))return s(new D.EIO("Expected Buffer"));var c=void 0!==o&&null!==o?o:e.position;i=c+i>n.length?i-c:i,u.copy(n,r,c,c+i),void 0===o&&(e.position+=i),s(null,i)}}t.getObject(e.id,function(n,r){n?s(n):r.type===l?s(new D.EISDIR("the named file is a directory",e.path)):(a=r,t.getBuffer(a.data,c))})}function X(t,e,n){e.getNode(t,n)}function z(t,e,n,i){e=o(e);var u=a(e),c=s(e);n=o(n);var f,h,p,d,g,E,m=a(n),y=s(n),v=Date.now();function w(e){e?i(e):F(t,n,E,{ctime:v},i)}function b(e,n){e?i(e):((E=n).nlinks+=1,t.putObject(E.id,E,w))}function _(e,n){e?i(e):t.getObject(g,b)}function I(e,n){e?i(e):r(d=n).has(m)?i(new D.EEXIST("newpath resolves to an existing file",m)):(d[m]=h[u],g=d[m].id,t.putObject(p.data,d,_))}function O(e,n){e?i(e):(p=n,t.getObject(p.data,I))}function A(e,n){e?i(e):r(h=n).has(u)?h[u].type===l?i(new D.EPERM("oldpath refers to a directory")):M(t,y,O):i(new D.ENOENT("a component of either path prefix does not exist",u))}M(t,c,function(e,n){e?i(e):(f=n,t.getObject(f.data,A))})}function q(t,e,n){e=o(e);var i,u,c,f=a(e),h=s(e);function p(e){e?n(e):(delete u[f],t.putObject(i.data,u,function(e){var r=Date.now();F(t,h,i,{mtime:r,ctime:r},n)}))}function d(e){e?n(e):t.delete(c.data,p)}function g(r,i){r?n(r):i.type===l?n(new D.EPERM("unlink not permitted on directories",f)):function(r,i){r?n(r):((c=i).nlinks-=1,c.nlinks<1?t.delete(c.id,d):t.putObject(c.id,c,function(n){F(t,e,c,{ctime:Date.now()},p)}))}(null,i)}function E(e,i){e?n(e):r(u=i).has(f)?t.getObject(u[f].id,g):n(new D.ENOENT("a component of the path does not name an existing file",f))}M(t,h,function(e,r){e?n(e):(i=r,t.getObject(i.data,E))})}function K(t,e,n,c){n=o(n);var f,h,l,d=a(n),g=s(n);function m(n,o){n?c(n):r(h=o).has(d)?c(new D.EEXIST(null,d)):P.create({guid:t.guid,type:p},function(n,r){n?c(n):((l=r).nlinks+=1,u(e)||(l.symlink_relpath=e,e=i.resolve(g,e)),l.size=e.length,l.data=e,t.putObject(l.id,l,v))})}function y(e){if(e)c(e);else{var n=Date.now();F(t,g,f,{mtime:n,ctime:n},c)}}function v(e){e?c(e):(h[d]=new N(l.id,p),t.putObject(f.data,h,y))}E===d?c(new D.EEXIST(null,d)):M(t,g,function(e,n){e?c(e):(f=n,t.getObject(f.data,m))})}function $(t){return r(O).has(t)?O[t]:null}function G(t,e,n){return t?"function"==typeof t?t={encoding:e,flag:n}:"string"==typeof t&&(t={encoding:t,flag:n}):t={encoding:e,flag:n},t}function J(t,e,n){var r;return"function"==typeof e&&(n=e,e=!1),t?c(t)?r=new D.EINVAL("Path must be a string without null bytes.",t):e||u(t)||(r=new D.EINVAL("Path must be absolute.",t)):r=new D.EINVAL("Path must be a string",t),!r||(n(r),!1)}function H(t,e,n,r){J(n,r)&&function(t,e,n){e=o(e),a(e),M(t,e,n)}(e,n,function(e,i){if(e)r(e);else{var o=new C(n,i,t.name);r(null,o)}})}var Q=/^[0-7]+$/;function Z(t){return t===t>>>0}function tt(t,e,n){return"function"==typeof e&&(n=e,e=void 0),Z(t)?t&g:"number"==typeof t?(Number.isInteger(t),n(new D.EINVAL("mode not a valid an integer value",t)),!1):"string"==typeof t?Q.test(t)?parseInt(t,8)&g:(n(new D.EINVAL("mode not a valid octal string",t)),!1):void 0!==e?e:(n(new D.EINVAL("mode not valid",t)),!1)}e.exports={ensureRootDirectory:function(t,e){var n,r,i;function o(i){i?e(i):P.create({guid:t.guid,id:n.rnode,type:l},function(n,i){n?e(n):((r=i).nlinks+=1,t.putObject(r.id,r,s))})}function s(n){n?e(n):(i={},t.putObject(r.data,i,e))}t.getObject(m,function(r,i){!r&&i?e():!r||r instanceof D.ENOENT?L.create({guid:t.guid},function(r,i){r?e(r):(n=i,t.putObject(n.id,n,o))}):e(r)})},open:function(t,e,n,i,o,s){s=arguments[arguments.length-1],J(n,s)&&((i=$(i))||s(new D.EINVAL("flags is not valid"),n),k(e,n,i,function(e,o){if(e)s(e);else{var a;a=r(i).contains(I)?o.size:0;var u=new x(n,o.id,i,a),c=t.allocDescriptor(u);s(null,c)}}))},chmod:function(t,e,n,r,i){J(n,i)&&(r=tt(r,"mode"))&&function(t,e,n,r){e=o(e),"number"!=typeof n?r(new D.EINVAL("mode must be number",e)):M(t,e,function(i,o){i?r(i):(P.setMode(n,o),F(t,e,o,{mtime:Date.now()},r))})}(e,n,r,i)},fchmod:function(t,e,n,i,o){if(i=tt(i,"mode")){var s=t.openFiles[n];s?r(s.flags).contains(w)?function(t,e,n,r){"number"!=typeof n?r(new D.EINVAL("mode must be a number")):e.getNode(t,function(i,o){i?r(i):(o.mode=n,F(t,e.path,o,{mtime:Date.now()},r))})}(e,s,i,o):o(new D.EBADF("descriptor does not permit writing")):o(new D.EBADF)}},chown:function(t,e,n,r,i,s){if(J(n,s))return Z(r)?Z(i)?void function(t,e,n,r,i){e=o(e),M(t,e,function(o,s){o?i(o):(s.uid=n,s.gid=r,F(t,e,s,{mtime:Date.now()},i))})}(e,n,r,i,s):s(new D.EINVAL("gid must be a valid integer",i)):s(new D.EINVAL("uid must be a valid integer",r))},fchown:function(t,e,n,i,o,s){if(!Z(i))return s(new D.EINVAL("uid must be a valid integer",i));if(!Z(o))return s(new D.EINVAL("gid must be a valid integer",o));var a=t.openFiles[n];a?r(a.flags).contains(w)?function(t,e,n,r,i){e.getNode(t,function(o,s){o?i(o):(s.uid=n,s.gid=r,F(t,e.path,s,{mtime:Date.now()},i))})}(e,a,i,o,s):s(new D.EBADF("descriptor does not permit writing")):s(new D.EBADF)},close:function(t,e,n,i){r(t.openFiles).has(n)?(t.releaseDescriptor(n),i(null)):i(new D.EBADF)},mknod:function(t,e,n,r,i){J(n,i)&&function(t,e,n,r){if(n!==l&&n!==h)return r(new D.EINVAL("type must be a directory or file",e));e=o(e);var i,u,c,f=a(e),p=s(e);function d(n,o){!n&&o?r(new D.EEXIST("path name already exists",e)):!n||n instanceof D.ENOENT?t.getObject(i.data,g):r(n)}function g(e,i){e?r(e):(u=i,P.create({guid:t.guid,type:n},function(e,n){e?r(e):((c=n).nlinks+=1,t.putObject(c.id,c,m))}))}function E(e){if(e)r(e);else{var n=Date.now();F(t,p,c,{mtime:n,ctime:n},r)}}function m(e){e?r(e):(u[f]=new N(c.id,n),t.putObject(i.data,u,E))}M(t,p,function(n,o){n?r(n):o.type!==l?r(new D.ENOTDIR("a component of the path prefix is not a directory",e)):(i=o,M(t,e,d))})}(e,n,r,i)},mkdir:function(t,e,n,r,i){if(arguments.length<5)i=r,r=g;else if(!(r=tt(r,g,i)))return;J(n,i)&&function(t,e,n){e=o(e);var r,i,u,c,f=a(e),h=s(e);function p(e,r){e?n(e):(u=r,t.getObject(u.data,d))}function d(e,i){e?n(e):(c=i,P.create({guid:t.guid,type:l},function(e,i){e?n(e):((r=i).nlinks+=1,t.putObject(r.id,r,g))}))}function g(e){e?n(e):(i={},t.putObject(r.data,i,m))}function E(e){if(e)n(e);else{var r=Date.now();F(t,h,u,{mtime:r,ctime:r},n)}}function m(e){e?n(e):(c[f]=new N(r.id,l),t.putObject(u.data,c,E))}M(t,e,function(r,i){!r&&i?n(new D.EEXIST(null,e)):!r||r instanceof D.ENOENT?M(t,h,p):n(r)})}(e,n,i)},rmdir:function(t,e,n,r){J(n,r)&&Y(e,n,r)},unlink:function(t,e,n,r){J(n,r)&&q(e,n,r)},stat:H,fstat:function(t,e,n,r){var i=t.openFiles[n];i?X(e,i,function(e,n){if(e)r(e);else{var o=new C(i.path,n,t.name);r(null,o)}}):r(new D.EBADF)},link:function(t,e,n,r,i){J(n,i)&&J(r,i)&&z(e,n,r,i)},read:function(t,e,n,i,o,s,a,u){o=void 0===o?0:o,s=void 0===s?i.length-o:s,u=arguments[arguments.length-1];var c=t.openFiles[n];c?r(c.flags).contains(v)?W(e,c,i,o,s,a,function(t,e){u(t,e||0,i)}):u(new D.EBADF("descriptor does not permit reading")):u(new D.EBADF)},readFile:function(t,e,n,r,i){if(i=arguments[arguments.length-1],r=G(r,null,"r"),J(n,i)){var o=$(r.flag||"r");if(!o)return i(new D.EINVAL("flags is not valid",n));k(e,n,o,function(s,a){if(s)return i(s);var u=new x(n,a.id,o,0),c=t.allocDescriptor(u);function f(){t.releaseDescriptor(c)}X(e,u,function(o,s){if(o)return f(),i(o);var a=new C(u.path,s,t.name);if(a.isDirectory())return f(),i(new D.EISDIR("illegal operation on directory",n));var c=a.size,h=new B(c);h.fill(0),W(e,u,h,0,c,0,function(t,e){if(f(),t)return i(t);var n;n="utf8"===r.encoding?j.decode(h):h,i(null,n)})})})}},write:function(t,e,n,i,o,s,a,u){u=arguments[arguments.length-1],o=void 0===o?0:o,s=void 0===s?i.length-o:s;var c=t.openFiles[n];c?r(c.flags).contains(w)?i.length-o<s?u(new D.EIO("intput buffer is too small")):V(e,c,i,o,s,a,u):u(new D.EBADF("descriptor does not permit writing")):u(new D.EBADF)},writeFile:function(t,e,n,r,i,o){if(o=arguments[arguments.length-1],i=G(i,"utf8","w"),J(n,o)){var s=$(i.flag||"w");if(!s)return o(new D.EINVAL("flags is not valid",n));"number"==typeof(r=r||"")&&(r=""+r),"string"==typeof r&&"utf8"===i.encoding&&(r=j.encode(r)),k(e,n,s,function(i,a){if(i)return o(i);var u=new x(n,a.id,s,0),c=t.allocDescriptor(u);!function(t,e,n,r,i,o){var s;function a(t){t?o(t):o(null,i)}function u(n){if(n)o(n);else{var r=Date.now();F(t,e.path,s,{mtime:r,ctime:r},a)}}function c(e){e?o(e):t.putObject(s.id,s,u)}t.getObject(e.id,function(a,u){if(a)o(a);else{s=u;var f=new B(i);f.fill(0),n.copy(f,0,r,r+i),e.position=i,s.size=i,s.version+=1,t.putBuffer(s.data,f,c)}})}(e,u,r,0,r.length,function(e,n){if(t.releaseDescriptor(c),e)return o(e);o(null)})})}},appendFile:function(t,e,n,r,i,o){if(o=arguments[arguments.length-1],i=G(i,"utf8","a"),J(n,o)){var s=$(i.flag||"a");if(!s)return o(new D.EINVAL("flags is not valid",n));"number"==typeof(r=r||"")&&(r=""+r),"string"==typeof r&&"utf8"===i.encoding&&(r=j.encode(r)),k(e,n,s,function(i,a){if(i)return o(i);var u=new x(n,a.id,s,a.size),c=t.allocDescriptor(u);V(e,u,r,0,r.length,u.position,function(e,n){if(t.releaseDescriptor(c),e)return o(e);o(null)})})}},exists:function(t,e,n,r){H(t,e,n,function(t,e){r(!t)})},getxattr:function(t,e,n,r,i){J(n,i)&&function(t,e,n,r){e=o(e),"string"!=typeof n?r(new D.EINVAL("attribute name must be a string",e)):n?M(t,e,function(t,i){if(t)return r(t);var o=i.xattrs;o.hasOwnProperty(n)?r(null,o[n]):r(new D.ENOATTR(null,e))}):r(new D.EINVAL("attribute name cannot be an empty string",e))}(e,n,r,i)},fgetxattr:function(t,e,n,r,i){var o=t.openFiles[n];o?function(t,e,n,r){"string"!=typeof n?r(new D.EINVAL):n?e.getNode(t,function(t,e){if(t)return r(t);var i=e.xattrs;i.hasOwnProperty(n)?r(null,i[n]):r(new D.ENOATTR)}):r(new D.EINVAL("attribute name cannot be an empty string"))}(e,o,r,i):i(new D.EBADF)},setxattr:function(t,e,n,r,i,s,a){"function"==typeof s&&(a=s,s=null),J(n,a)&&function(t,e,n,r,i,s){e=o(e),"string"!=typeof n?s(new D.EINVAL("attribute name must be a string",e)):n?null!==i&&i!==A&&i!==R?s(new D.EINVAL("invalid flag, must be null, XATTR_CREATE or XATTR_REPLACE",e)):M(t,e,function(o,a){if(o)return s(o);U(t,e,a,n,r,i,s)}):s(new D.EINVAL("attribute name cannot be an empty string",e))}(e,n,r,i,s,a)},fsetxattr:function(t,e,n,i,o,s,a){"function"==typeof s&&(a=s,s=null);var u=t.openFiles[n];u?r(u.flags).contains(w)?function(t,e,n,r,i,o){"string"!=typeof n?o(new D.EINVAL("attribute name must be a string")):n?null!==i&&i!==A&&i!==R?o(new D.EINVAL("invalid flag, must be null, XATTR_CREATE or XATTR_REPLACE")):e.getNode(t,function(s,a){if(s)return o(s);U(t,e.path,a,n,r,i,o)}):o(new D.EINVAL("attribute name cannot be an empty string"))}(e,u,i,o,s,a):a(new D.EBADF("descriptor does not permit writing")):a(new D.EBADF)},removexattr:function(t,e,n,r,i){J(n,i)&&function(t,e,n,r){e=o(e),"string"!=typeof n?r(new D.EINVAL("attribute name must be a string",e)):n?M(t,e,function(i,o){if(i)return r(i);var s=o.xattrs;s.hasOwnProperty(n)?(delete s[n],t.putObject(o.id,o,function(n){n?r(n):F(t,e,o,{ctime:Date.now()},r)})):r(new D.ENOATTR(null,e))}):r(new D.EINVAL("attribute name cannot be an empty string",e))}(e,n,r,i)},fremovexattr:function(t,e,n,i,o){var s=t.openFiles[n];s?r(s.flags).contains(w)?function(t,e,n,r){"string"!=typeof n?r(new D.EINVAL("attribute name must be a string")):n?e.getNode(t,function(i,o){if(i)return r(i);var s=o.xattrs;s.hasOwnProperty(n)?(delete s[n],t.putObject(o.id,o,function(n){n?r(n):F(t,e.path,o,{ctime:Date.now()},r)})):r(new D.ENOATTR)}):r(new D.EINVAL("attribute name cannot be an empty string"))}(e,s,i,o):o(new D.EBADF("descriptor does not permit writing")):o(new D.EBADF)},lseek:function(t,e,n,r,i,o){var s=t.openFiles[n];s||o(new D.EBADF),"SET"===i?r<0?o(new D.EINVAL("resulting file offset would be negative")):(s.position=r,o(null,s.position)):"CUR"===i?s.position+r<0?o(new D.EINVAL("resulting file offset would be negative")):(s.position+=r,o(null,s.position)):"END"===i?X(e,s,function(t,e){t?o(t):e.size+r<0?o(new D.EINVAL("resulting file offset would be negative")):(s.position=e.size+r,o(null,s.position))}):o(new D.EINVAL("whence argument is not a proper value"))},readdir:function(t,e,n,r){J(n,r)&&function(t,e,n){var r,i;function s(t,e){if(t)n(t);else{i=e;var r=Object.keys(i);n(null,r)}}e=o(e),a(e),M(t,e,function(i,o){i?n(i):o.type!==l?n(new D.ENOTDIR(null,e)):(r=o,t.getObject(r.data,s))})}(e,n,r)},utimes:function(t,e,n,r,i,s){if(J(n,s)){var a=Date.now();!function(t,e,n,r,i){e=o(e),"number"!=typeof n||"number"!=typeof r?i(new D.EINVAL("atime and mtime must be number",e)):n<0||r<0?i(new D.EINVAL("atime and mtime must be positive integers",e)):M(t,e,function(o,s){o?i(o):F(t,e,s,{atime:n,ctime:r,mtime:r},i)})}(e,n,r=r||a,i=i||a,s)}},futimes:function(t,e,n,i,o,s){var a=Date.now();i=i||a,o=o||a;var u=t.openFiles[n];u?r(u.flags).contains(w)?function(t,e,n,r,i){"number"!=typeof n||"number"!=typeof r?i(new D.EINVAL("atime and mtime must be a number")):n<0||r<0?i(new D.EINVAL("atime and mtime must be positive integers")):e.getNode(t,function(o,s){o?i(o):F(t,e.path,s,{atime:n,ctime:r,mtime:r},i)})}(e,u,i,o,s):s(new D.EBADF("descriptor does not permit writing")):s(new D.EBADF)},rename:function(t,e,n,s,a){if(J(n,a)&&J(s,a)){n=o(n),s=o(s);var u,c,f,h,p=i.dirname(n),d=i.dirname(n),g=i.basename(n),E=i.basename(s),m=Date.now();M(e,n,function(t,r){t?a(t):r.type===l?M(e,p,A):z(e,n,s,R)})}function y(t,n){t?a(t):F(e,s,n,{ctime:m},a)}function v(t){t?a(t):e.getObject(h[E].id,y)}function w(t){t?a(t):(u.id===f.id&&(c=h),delete c[g],e.putObject(u.data,c,v))}function b(t){t?a(t):(h[E]=c[g],e.putObject(f.data,h,w))}function _(t,n){t?a(t):r(h=n).has(E)?Y(e,s,b):b()}function I(t,n){t?a(t):(f=n,e.getObject(f.data,_))}function O(t,n){t?a(t):(c=n,M(e,d,I))}function A(t,n){t?a(t):(u=n,e.getObject(n.data,O))}function R(t){t?a(t):q(e,n,a)}},symlink:function(t,e,n,r,i,o){J(n,!0,o=arguments[arguments.length-1])&&J(r,o)&&K(e,n,r,o)},readlink:function(t,e,n,i){J(n,i)&&function(t,e,n){e=o(e);var i,u,c=a(e),f=s(e);function h(e,i){e?n(e):r(u=i).has(c)?t.getObject(u[c].id,l):n(new D.ENOENT("a component of the path does not name an existing file",c))}function l(t,r){if(t)n(t);else if(r.type!==p)n(new D.EINVAL("path not a symbolic link",e));else{var i=r.symlink_relpath?r.symlink_relpath:r.data;n(null,i)}}M(t,f,function(e,r){e?n(e):(i=r,t.getObject(i.data,h))})}(e,n,i)},lstat:function(t,e,n,i){J(n,i)&&function(t,e,n){e=o(e);var i,u,c=a(e),f=s(e);function h(i,o){i?n(i):r(u=o).has(c)?t.getObject(u[c].id,n):n(new D.ENOENT("a component of the path does not name an existing file",e))}E===c?M(t,e,n):M(t,f,function(e,r){e?n(e):(i=r,t.getObject(i.data,h))})}(e,n,function(e,r){if(e)i(e);else{var o=new C(n,r,t.name);i(null,o)}})},truncate:function(t,e,n,r,i){i=arguments[arguments.length-1],r=r||0,J(n,i)&&function(t,e,n,r){var i;function s(e,o){if(e)r(e);else{if(!o)return r(new D.EIO("Expected Buffer"));var s=new B(n);s.fill(0),o&&o.copy(s),t.putBuffer(i.data,s,u)}}function a(n){if(n)r(n);else{var o=Date.now();F(t,e,i,{mtime:o,ctime:o},r)}}function u(e){e?r(e):(i.size=n,i.version+=1,t.putObject(i.id,i,a))}e=o(e),n<0?r(new D.EINVAL("length cannot be negative")):M(t,e,function(n,o){n?r(n):o.type===l?r(new D.EISDIR(null,e)):(i=o,t.getBuffer(i.data,s))})}(e,n,r,i)},ftruncate:function(t,e,n,i,o){o=arguments[arguments.length-1],i=i||0;var s=t.openFiles[n];s?r(s.flags).contains(w)?function(t,e,n,r){var i;function o(e,o){if(e)r(e);else{var s;if(!o)return r(new D.EIO("Expected Buffer"));o?s=o.slice(0,n):(s=new B(n)).fill(0),t.putBuffer(i.data,s,a)}}function s(n){if(n)r(n);else{var o=Date.now();F(t,e.path,i,{mtime:o,ctime:o},r)}}function a(e){e?r(e):(i.size=n,i.version+=1,t.putObject(i.id,i,s))}n<0?r(new D.EINVAL("length cannot be negative")):e.getNode(t,function(e,n){e?r(e):n.type===l?r(new D.EISDIR):(i=n,t.getBuffer(i.data,o))})}(e,s,i,o):o(new D.EBADF("descriptor does not permit writing")):o(new D.EBADF)}}},{"../../lib/nodash.js":4,"../buffer.js":14,"../constants.js":15,"../directory-entry.js":16,"../encoding.js":17,"../errors.js":18,"../node.js":23,"../open-file-description.js":24,"../path.js":25,"../stats.js":33,"../super-node.js":34}],20:[function(t,e,n){var r=t("../../lib/nodash.js"),i=t("../path.js").isNull,o=t("../shared.js").nop,s=t("../constants.js"),a=s.FILE_SYSTEM_NAME,u=s.FS_FORMAT,c=s.FS_READY,f=s.FS_PENDING,h=s.FS_ERROR,l=s.FS_NODUPEIDCHECK,p=t("../providers/index.js"),d=t("../shell/shell.js"),g=t("../../lib/intercom.js"),E=t("../fs-watcher.js"),m=t("../errors.js"),y=t("../shared.js").guid,v=s.STDIN,w=s.STDOUT,b=s.STDERR,_=s.FIRST_DESCRIPTOR,I=t("./implementation.js");function O(t){t&&console.error("Filer error: ",t)}function A(t,e){t=t||{},e=e||O;var n=t.flags,A=t.guid?t.guid:y,R=t.provider||new p.Default(t.name||a),T=t.name||R.name,S=r(n).contains(u),j=this;j.readyState=f,j.name=T,j.error=null,j.stdin=v,j.stdout=w,j.stderr=b,j.constants=s.fsConstants,this.Shell=d.bind(void 0,this);var D={},N=_;Object.defineProperty(this,"openFiles",{get:function(){return D}}),this.allocDescriptor=function(t){var e=N++;return D[e]=t,e},this.releaseDescriptor=function(t){delete D[t]};var x=[];function L(t){return function(e){r(n).contains(l)?e(null,A()):function e(n){var r=A();t.getObject(r,function(t,i){t?n(t):i?e(n):n(null,r)})}(e)}}this.queueOrRun=function(t){var e;return c==j.readyState?t.call(j):h==j.readyState?e=new m.EFILESYSTEMERROR("unknown error"):x.push(t),e},this.watch=function(t,e,n){if(i(t))throw new Error("Path must be a string without null bytes.");"function"==typeof e&&(n=e,e={}),e=e||{},n=n||o;var r=new E;return r.start(t,!1,e.recursive),r.on("change",n),r},R.open(function(t){function r(t){function r(t){var e=R[t]();return e.flags=n,e.changes=[],e.guid=L(e),e.close=function(){var t=e.changes;!function(t){if(t.length){var e=g.getInstance();t.forEach(function(t){e.emit(t.event,t.path)})}}(t),t.length=0},e}j.provider={openReadWriteContext:function(){return r("getReadWriteContext")},openReadOnlyContext:function(){return r("getReadOnlyContext")}},j.readyState=t?h:c,x.forEach(function(t){t.call(this)}.bind(j)),x=null,e(t,j)}if(t)return r(t);var i=R.getReadWriteContext();i.guid=L(i),S?i.clear(function(t){if(t)return r(t);I.ensureRootDirectory(i,r)}):I.ensureRootDirectory(i,r)})}A.providers=p,["open","chmod","fchmod","chown","fchown","close","mknod","mkdir","rmdir","stat","fstat","link","unlink","read","readFile","write","writeFile","appendFile","exists","lseek","readdir","rename","readlink","symlink","lstat","truncate","ftruncate","utimes","futimes","setxattr","getxattr","fsetxattr","fgetxattr","removexattr","fremovexattr"].forEach(function(t){A.prototype[t]=function(){var e=this,n=Array.prototype.slice.call(arguments,0),r=n.length-1,i="function"!=typeof n[r],o=function(t){return"function"==typeof t?t:function(t){if(t)throw t}}(n[r]),s=e.queueOrRun(function(){var s=e.provider.openReadWriteContext();if(h===e.readyState){var a=new m.EFILESYSTEMERROR("filesystem unavailable, operation canceled");return o.call(e,a)}function u(){s.close(),o.apply(e,arguments)}i?n.push(u):n[r]=u;var c=[e,s].concat(n);I[t].apply(null,c)});s&&o(s)}}),e.exports=A},{"../../lib/intercom.js":3,"../../lib/nodash.js":4,"../constants.js":15,"../errors.js":18,"../fs-watcher.js":21,"../path.js":25,"../providers/index.js":26,"../shared.js":30,"../shell/shell.js":32,"./implementation.js":19}],21:[function(t,e,n){var r=t("../lib/eventemitter.js"),i=t("./path.js"),o=t("../lib/intercom.js");function s(){r.call(this);var t,e,n=this,s=!1;function a(r){(e===r||s&&0===r.indexOf(t))&&n.trigger("change","change",r)}n.start=function(n,r,u){if(!e){if(i.isNull(n))throw new Error("Path must be a string without null bytes.");e=i.normalize(n),(s=!0===u)&&(t="/"===e?"/":e+"/"),o.getInstance().on("change",a)}},n.close=function(){o.getInstance().off("change",a),n.removeAllListeners("change")}}s.prototype=new r,s.prototype.constructor=s,e.exports=s},{"../lib/eventemitter.js":2,"../lib/intercom.js":3,"./path.js":25}],22:[function(t,e,n){e.exports={FileSystem:t("./filesystem/interface.js"),Buffer:t("./buffer.js"),Path:t("./path.js"),Errors:t("./errors.js"),Shell:t("./shell/shell.js")}},{"./buffer.js":14,"./errors.js":18,"./filesystem/interface.js":20,"./path.js":25,"./shell/shell.js":32}],23:[function(t,e,n){var r=t("./constants.js").NODE_TYPE_FILE,i=t("./constants.js").NODE_TYPE_DIRECTORY,o=t("./constants.js").NODE_TYPE_SYMBOLIC_LINK,s=(t("./constants.js").NODE_TYPE_META,t("./constants.js").ROOT_DIRECTORY_NAME,t("./constants.js").S_IFREG),a=t("./constants.js").S_IFDIR,u=t("./constants.js").S_IFLNK,c=t("./constants.js").DEFAULT_FILE_PERMISSIONS,f=t("./constants.js").DEFAULT_DIR_PERMISSIONS;function h(t,e){switch(t){case i:return(e||f)|a;case o:return(e||c)|u;case r:default:return(e||c)|s}}function l(t){var e=Date.now();this.id=t.id,this.type=t.type||r,this.size=t.size||0,this.atime=t.atime||e,this.ctime=t.ctime||e,this.mtime=t.mtime||e,this.flags=t.flags||[],this.xattrs=t.xattrs||{},this.nlinks=t.nlinks||0,this.data=t.data,this.version=t.version||1,this.mode=t.mode||h(this.type),this.uid=t.uid||0,this.gid=t.gid||0}function p(t,e,n){t[e]?n(null):t.guid(function(r,i){t[e]=i,n(r)})}l.create=function(t,e){p(t,"id",function(n){n?e(n):p(t,"data",function(n){n?e(n):e(null,new l(t))})})},l.setMode=function(t,e){e.mode=h(e.type,t)},e.exports=l},{"./constants.js":15}],24:[function(t,e,n){var r=t("./errors.js");function i(t,e,n,r){this.path=t,this.id=e,this.flags=n,this.position=r}i.prototype.getNode=function(t,e){var n=this.id,i=this.path;t.getObject(n,function(t,n){return t?e(t):n?void e(null,n):e(new r.EBADF("file descriptor refers to unknown node",i))})},e.exports=i},{"./errors.js":18}],25:[function(t,e,n){function r(t,e){for(var n=0,r=t.length-1;r>=0;r--){var i=t[r];"."===i?t.splice(r,1):".."===i?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var i=/^(\/?)([\s\S]+\/(?!$)|\/)?((?:\.{1,2}$|[\s\S]+?)?(\.[^.\/]*)?)$/,o=function(t){var e=i.exec(t);return[e[1]||"",e[2]||"",e[3]||"",e[4]||""]};function s(){for(var t="",e=!1,n=arguments.length-1;n>=-1&&!e;n--){var i=n>=0?arguments[n]:"/";"string"==typeof i&&i&&(t=i+"/"+t,e="/"===i.charAt(0))}return t=r(t.split("/").filter(function(t){return!!t}),!e).join("/"),(e?"/":"")+t||"."}function a(t){var e="/"===t.charAt(0);t.substr(-1);return(t=r(t.split("/").filter(function(t){return!!t}),!e).join("/"))||e||(t="."),(e?"/":"")+t}e.exports={normalize:a,resolve:s,join:function(){return a(Array.prototype.slice.call(arguments,0).filter(function(t,e){return t&&"string"==typeof t}).join("/"))},relative:function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=s(t).substr(1),e=s(e).substr(1);for(var r=n(t.split("/")),i=n(e.split("/")),o=Math.min(r.length,i.length),a=o,u=0;u<o;u++)if(r[u]!==i[u]){a=u;break}var c=[];for(u=a;u<r.length;u++)c.push("..");return(c=c.concat(i.slice(a))).join("/")},sep:"/",delimiter:":",dirname:function(t){var e=o(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},basename:function(t,e){var n=o(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),""===n?"/":n},extname:function(t){return o(t)[3]},isAbsolute:function(t){return"/"===t.charAt(0)},isNull:function(t){return-1!==(""+t).indexOf("\0")},addTrailing:function(t){return t.replace(/\/*$/,"/")},removeTrailing:function(t){return""===(t=t.replace(/\/*$/,""))?"/":t}}},{}],26:[function(t,e,n){var r=t("./indexeddb.js"),i=t("./websql.js"),o=t("./memory.js");e.exports={IndexedDB:r,WebSQL:i,Memory:o,Default:r,Fallback:function(){if(r.isSupported())return r;if(i.isSupported())return i;function t(){throw"[Filer Error] Your browser doesn't support IndexedDB or WebSQL."}return t.isSupported=function(){return!1},t}()}},{"./indexeddb.js":27,"./memory.js":28,"./websql.js":29}],27:[function(t,n,r){(function(e){var r=t("../constants.js").FILE_SYSTEM_NAME,i=t("../constants.js").FILE_STORE_NAME,o=t("../constants.js").IDB_RW,s=t("../constants.js").IDB_RO,a=(t("../errors.js"),t("../buffer.js")),u=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB;function c(t,e){this.db=t,this.mode=e}function f(t){this.name=t||r,this.db=null}c.prototype._getObjectStore=function(){if(this.objectStore)return this.objectStore;var t=this.db.transaction(i,this.mode);return this.objectStore=t.objectStore(i),this.objectStore},c.prototype.clear=function(t){try{var e=this._getObjectStore().clear();e.onsuccess=function(){t()},e.onerror=function(e){e.preventDefault(),t(e.error)}}catch(e){t(e)}},c.prototype._get=function(t,e){try{var n=this._getObjectStore().get(t);n.onsuccess=function(t){var n=t.target.result;e(null,n)},n.onerror=function(t){t.preventDefault(),e(t.error)}}catch(t){e(t)}},c.prototype.getObject=function(t,e){this._get(t,e)},c.prototype.getBuffer=function(t,e){this._get(t,function(t,n){if(t)return e(t);e(null,new a(n))})},c.prototype._put=function(t,e,n){try{var r=this._getObjectStore().put(e,t);r.onsuccess=function(t){var e=t.target.result;n(null,e)},r.onerror=function(t){t.preventDefault(),n(t.error)}}catch(t){n(t)}},c.prototype.putObject=function(t,e,n){this._put(t,e,n)},c.prototype.putBuffer=function(t,e,n){var r=e.buffer;this._put(t,r,n)},c.prototype.delete=function(t,e){try{var n=this._getObjectStore().delete(t);n.onsuccess=function(t){var n=t.target.result;e(null,n)},n.onerror=function(t){t.preventDefault(),e(t.error)}}catch(t){e(t)}},f.isSupported=function(){return!!u},f.prototype.open=function(t){var e=this;if(e.db)return t();try{var n=u.open(e.name);n.onupgradeneeded=function(t){var e=t.target.result;e.objectStoreNames.contains(i)&&e.deleteObjectStore(i),e.createObjectStore(i)},n.onsuccess=function(n){e.db=n.target.result,t()},n.onerror=function(e){e.preventDefault(),t(e.error)}}catch(e){t(e)}},f.prototype.getReadOnlyContext=function(){return new c(this.db,s)},f.prototype.getReadWriteContext=function(){return new c(this.db,o)},n.exports=f}).call(this,void 0!==e?e:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../buffer.js":14,"../constants.js":15,"../errors.js":18}],28:[function(t,e,n){var r,i=t("../constants.js").FILE_SYSTEM_NAME,o=t("../../lib/async.js").setImmediate,s=(r={},function(t){return r.hasOwnProperty(t)||(r[t]={}),r[t]});function a(t,e){this.readOnly=e,this.objectStore=t}function u(t){this.name=t||i}a.prototype.clear=function(t){if(this.readOnly)o(function(){t("[MemoryContext] Error: write operation on read only context")});else{var e=this.objectStore;Object.keys(e).forEach(function(t){delete e[t]}),o(t)}},a.prototype.getObject=a.prototype.getBuffer=function(t,e){var n=this;o(function(){e(null,n.objectStore[t])})},a.prototype.putObject=a.prototype.putBuffer=function(t,e,n){this.readOnly?o(function(){n("[MemoryContext] Error: write operation on read only context")}):(this.objectStore[t]=e,o(n))},a.prototype.delete=function(t,e){this.readOnly?o(function(){e("[MemoryContext] Error: write operation on read only context")}):(delete this.objectStore[t],o(e))},u.isSupported=function(){return!0},u.prototype.open=function(t){this.db=s(this.name),o(t)},u.prototype.getReadOnlyContext=function(){return new a(this.db,!0)},u.prototype.getReadWriteContext=function(){return new a(this.db,!1)},e.exports=u},{"../../lib/async.js":1,"../constants.js":15}],29:[function(t,n,r){(function(e){var r=t("../constants.js").FILE_SYSTEM_NAME,i=t("../constants.js").FILE_STORE_NAME,o=t("../constants.js").WSQL_VERSION,s=t("../constants.js").WSQL_SIZE,a=t("../constants.js").WSQL_DESC,u=t("../errors.js"),c=t("../buffer.js"),f=t("base64-arraybuffer");function h(t,e){var n=this;this.getTransaction=function(r){n.transaction?r(n.transaction):t[e?"readTransaction":"transaction"](function(t){n.transaction=t,r(t)})}}function l(t,e,n){function r(t,e){var r=0===e.rows.length?null:e.rows.item(0).data;n(null,r)}function o(t,e){n(e)}t(function(t){t.executeSql("SELECT data FROM "+i+" WHERE id = ? LIMIT 1;",[e],r,o)})}function p(t,e,n,r){function o(t,e){r(null)}function s(t,e){r(e)}t(function(t){t.executeSql("INSERT OR REPLACE INTO "+i+" (id, data) VALUES (?, ?);",[e,n],o,s)})}function d(t){this.name=t||r,this.db=null}h.prototype.clear=function(t){function e(e,n){t(n)}function n(e,n){t(null)}this.getTransaction(function(t){t.executeSql("DELETE FROM "+i+";",[],n,e)})},h.prototype.getObject=function(t,e){l(this.getTransaction,t,function(t,n){if(t)return e(t);try{n&&(n=JSON.parse(n))}catch(t){return e(t)}e(null,n)})},h.prototype.getBuffer=function(t,e){l(this.getTransaction,t,function(t,n){if(t)return e(t);if(n||""===n){var r=f.decode(n);n=new c(r)}e(null,n)})},h.prototype.putObject=function(t,e,n){var r=JSON.stringify(e);p(this.getTransaction,t,r,n)},h.prototype.putBuffer=function(t,e,n){var r=f.encode(e.buffer);p(this.getTransaction,t,r,n)},h.prototype.delete=function(t,e){function n(t,n){e(null)}function r(t,n){e(n)}this.getTransaction(function(e){e.executeSql("DELETE FROM "+i+" WHERE id = ?;",[t],n,r)})},d.isSupported=function(){return!!e.openDatabase},d.prototype.open=function(t){var n=this;if(n.db)return t();var r=e.openDatabase(n.name,o,a,s);function c(e,n){5===n.code&&t(new u.EINVAL("WebSQL cannot be accessed. If private browsing is enabled, disable it.")),t(n)}function f(e,i){n.db=r,t()}r?r.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS "+i+" (id unique, data TEXT);",[],function(t){t.executeSql("CREATE INDEX IF NOT EXISTS idx_"+i+"_id on "+i+" (id);",[],f,c)},c)}):t("[WebSQL] Unable to open database.")},d.prototype.getReadOnlyContext=function(){return new h(this.db,!0)},d.prototype.getReadWriteContext=function(){return new h(this.db,!1)},n.exports=d}).call(this,void 0!==e?e:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../buffer.js":14,"../constants.js":15,"../errors.js":18,"base64-arraybuffer":5}],30:[function(t,e,n){e.exports={guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}).toUpperCase()},u8toArray:function(t){for(var e=[],n=t.length,r=0;r<n;r++)e[r]=t[r];return e},nop:function(){}}},{}],31:[function(t,e,n){var r=t("../constants.js").ENVIRONMENT;e.exports=function(t){(t=t||{}).TMP=t.TMP||r.TMP,t.PATH=t.PATH||r.PATH,this.get=function(e){return t[e]},this.set=function(e,n){t[e]=n}}},{"../constants.js":15}],32:[function(t,e,n){var r=t("../path.js"),i=t("../errors.js"),o=t("./environment.js"),s=t("../../lib/async.js"),a=(t("../encoding.js"),t("minimatch"));function u(t,e){var n=new o((e=e||{}).env),s="/";Object.defineProperty(this,"fs",{get:function(){return t},enumerable:!0}),Object.defineProperty(this,"env",{get:function(){return n},enumerable:!0}),this.cd=function(e,n){e=r.resolve(s,e),t.stat(e,function(t,r){t?n(new i.ENOTDIR(null,e)):"DIRECTORY"===r.type?(s=e,n()):n(new i.ENOTDIR(null,e))})},this.pwd=function(){return s}}u.prototype.exec=function(t,e,n){var i=this.fs;"function"==typeof e&&(n=e,e=[]),e=e||[],n=n||function(){},t=r.resolve(this.pwd(),t),i.readFile(t,"utf8",function(t,r){if(t)n(t);else try{new Function("fs","args","callback",r)(i,e,n)}catch(t){n(t)}})},u.prototype.touch=function(t,e,n){var i=this.fs;"function"==typeof e&&(n=e,e={}),e=e||{},n=n||function(){},t=r.resolve(this.pwd(),t),i.stat(t,function(r,o){r?!0===e.updateOnly?n():function(t){i.writeFile(t,"",n)}(t):function(t){var r=Date.now(),o=e.date||r,s=e.date||r;i.utimes(t,o,s,n)}(t)})},u.prototype.cat=function(t,e){var n=this,o=n.fs,a="";e=e||function(){},t?(t="string"==typeof t?[t]:t,s.eachSeries(t,function(t,e){var i=r.resolve(n.pwd(),t);o.readFile(i,"utf8",function(t,n){t?e(t):(a+=n+"\n",e())})},function(t){t?e(t):e(null,a.replace(/\n$/,""))})):e(new i.EINVAL("Missing files argument"))},u.prototype.ls=function(t,e,n){var o=this,a=o.fs;"function"==typeof e&&(n=e,e={}),e=e||{},n=n||function(){},t?function t(n,i){var u=r.resolve(o.pwd(),n),c=[];a.readdir(u,function(n,o){n?i(n):s.eachSeries(o,function(n,i){n=r.join(u,n),a.stat(n,function(n,o){if(n)i(n);else{var s=o;e.recursive&&"DIRECTORY"===o.type?t(r.join(u,s.name),function(t,e){t?i(t):(s.contents=e,c.push(s),i())}):(c.push(s),i())}})},function(t){i(t,c)})})}(t,n):n(new i.EINVAL("Missing dir argument"))},u.prototype.rm=function(t,e,n){var o=this,a=o.fs;"function"==typeof e&&(n=e,e={}),e=e||{},n=n||function(){},t?function t(n,u){n=r.resolve(o.pwd(),n),a.stat(n,function(o,c){o?u(o):"FILE"!==c.type?a.readdir(n,function(o,c){o?u(o):0!==c.length?e.recursive?(c=c.map(function(t){return r.join(n,t)}),s.eachSeries(c,t,function(t){t?u(t):a.rmdir(n,u)})):u(new i.ENOTEMPTY(null,n)):a.rmdir(n,u)}):a.unlink(n,u)})}(t,n):n(new i.EINVAL("Missing path argument"))},u.prototype.tempDir=function(t){var e=this.fs,n=this.env.get("TMP");t=t||function(){},e.mkdir(n,function(e){t(null,n)})},u.prototype.mkdirp=function(t,e){var n=this.fs;e=e||function(){},t?"/"!==t?function t(e,o){n.stat(e,function(s,a){if(a){if(a.isDirectory())return void o();if(a.isFile())return void o(new i.ENOTDIR(null,e))}else{if(s&&"ENOENT"!==s.code)return void o(s);var u=r.dirname(e);"/"===u?n.mkdir(e,function(t){t&&"EEXIST"!=t.code?o(t):o()}):t(u,function(t){if(t)return o(t);n.mkdir(e,function(t){t&&"EEXIST"!=t.code?o(t):o()})})}})}(t,e):e():e(new i.EINVAL("Missing path argument"))},u.prototype.find=function(t,e,n){var o=this,u=o.fs;"function"==typeof e&&(n=e,e={}),e=e||{},n=n||function(){};var c=e.exec||function(t,e){e()},f=[];function h(t,n){var i=r.removeTrailing(t);!e.regex||e.regex.test(i)?e.name&&!a(r.basename(i),e.name)||e.path&&!a(r.dirname(i),e.path)?n():function(t,e){c(t,function(n){n?e(n):(f.push(t),e())})}(t,n):n()}function l(t,e){t=r.resolve(o.pwd(),t),u.readdir(t,function(n,i){n?"ENOTDIR"===n.code?h(t,e):e(n):h(r.addTrailing(t),function(n){n?e(n):(i=i.map(function(e){return r.join(t,e)}),s.eachSeries(i,l,function(t){e(t,f)}))})})}t?u.stat(t,function(e,r){e?n(e):r.isDirectory()?l(t,n):n(new i.ENOTDIR(null,t))}):n(new i.EINVAL("Missing path argument"))},e.exports=u},{"../../lib/async.js":1,"../encoding.js":17,"../errors.js":18,"../path.js":25,"./environment.js":31,minimatch:11}],33:[function(t,e,n){var r=t("./constants.js"),i=t("./path.js");function o(t,e,n){this.dev=n,this.node=e.id,this.type=e.type,this.size=e.size,this.nlinks=e.nlinks,this.atime=e.atime,this.mtime=e.mtime,this.ctime=e.ctime,this.version=e.version,this.mode=e.mode,this.uid=e.uid,this.gid=e.gid,this.name=i.basename(t)}o.prototype.isFile=function(){return this.type===r.NODE_TYPE_FILE},o.prototype.isDirectory=function(){return this.type===r.NODE_TYPE_DIRECTORY},o.prototype.isSymbolicLink=function(){return this.type===r.NODE_TYPE_SYMBOLIC_LINK},o.prototype.isSocket=o.prototype.isFIFO=o.prototype.isCharacterDevice=o.prototype.isBlockDevice=function(){return!1},e.exports=o},{"./constants.js":15,"./path.js":25}],34:[function(t,e,n){var r=t("./constants.js");function i(t){var e=Date.now();this.id=r.SUPER_NODE_ID,this.type=r.NODE_TYPE_META,this.atime=t.atime||e,this.ctime=t.ctime||e,this.mtime=t.mtime||e,this.rnode=t.rnode}i.create=function(t,e){t.guid(function(n,r){n?e(n):(t.rnode=t.rnode||r,e(null,new i(t)))})},e.exports=i},{"./constants.js":15}]},{},[22])(22)});
},{"process":70,"buffer":71}],65:[function(require,module,exports) {
var global = arguments[3];
var global=arguments[3];(function(){"use strict";var $jscomp=$jscomp||{},a;$jscomp.scope={},$jscomp.ASSUME_ES5=!1,$jscomp.ASSUME_NO_NATIVE_MAP=!1,$jscomp.ASSUME_NO_NATIVE_SET=!1,$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,r){e!=Array.prototype&&e!=Object.prototype&&(e[t]=r.value)},$jscomp.getGlobal=function(e){return"undefined"!=typeof window&&window===e?e:void 0!==global&&null!=global?global:e},$jscomp.global=$jscomp.getGlobal(this),$jscomp.SYMBOL_PREFIX="jscomp_symbol_",$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){},$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)},$jscomp.Symbol=(a=0,function(e){return $jscomp.SYMBOL_PREFIX+(e||"")+a++}),$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator")),"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}}),$jscomp.initSymbolIterator=function(){}},$jscomp.arrayIterator=function(e){var t=0;return $jscomp.iteratorPrototype(function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}})},$jscomp.iteratorPrototype=function(e){return $jscomp.initSymbolIterator(),(e={next:e})[$jscomp.global.Symbol.iterator]=function(){return this},e},$jscomp.makeIterator=function(e){$jscomp.initSymbolIterator();var t=e[Symbol.iterator];return t?t.call(e):$jscomp.arrayIterator(e)},$jscomp.polyfill=function(e,t,r,s){if(t){for(r=$jscomp.global,e=e.split("."),s=0;s<e.length-1;s++){var i=e[s];i in r||(r[i]={}),r=r[i]}(t=t(s=r[e=e[e.length-1]]))!=s&&null!=t&&$jscomp.defineProperty(r,e,{configurable:!0,writable:!0,value:t})}},$jscomp.FORCE_POLYFILL_PROMISE=!1,$jscomp.polyfill("Promise",function(e){function t(){this.batch_=null}function r(e){return e instanceof i?e:new i(function(t,r){t(e)})}if(e&&!$jscomp.FORCE_POLYFILL_PROMISE)return e;t.prototype.asyncExecute=function(e){return null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_()),this.batch_.push(e),this},t.prototype.asyncExecuteBatch_=function(){var e=this;this.asyncExecuteFunction(function(){e.executeBatch_()})};var s=$jscomp.global.setTimeout;t.prototype.asyncExecuteFunction=function(e){s(e,0)},t.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var e=this.batch_;this.batch_=[];for(var t=0;t<e.length;++t){var r=e[t];e[t]=null;try{r()}catch(e){this.asyncThrow_(e)}}}this.batch_=null},t.prototype.asyncThrow_=function(e){this.asyncExecuteFunction(function(){throw e})};var i=function(e){this.state_=0,this.result_=void 0,this.onSettledCallbacks_=[];var t=this.createResolveAndReject_();try{e(t.resolve,t.reject)}catch(e){t.reject(e)}};i.prototype.createResolveAndReject_=function(){function e(e){return function(s){r||(r=!0,e.call(t,s))}}var t=this,r=!1;return{resolve:e(this.resolveTo_),reject:e(this.reject_)}},i.prototype.resolveTo_=function(e){if(e===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(e instanceof i)this.settleSameAsPromise_(e);else{e:switch(typeof e){case"object":var t=null!=e;break e;case"function":t=!0;break e;default:t=!1}t?this.resolveToNonPromiseObj_(e):this.fulfill_(e)}},i.prototype.resolveToNonPromiseObj_=function(e){var t=void 0;try{t=e.then}catch(e){return void this.reject_(e)}"function"==typeof t?this.settleSameAsThenable_(t,e):this.fulfill_(e)},i.prototype.reject_=function(e){this.settle_(2,e)},i.prototype.fulfill_=function(e){this.settle_(1,e)},i.prototype.settle_=function(e,t){if(0!=this.state_)throw Error("Cannot settle("+e+", "+t+"): Promise already settled in state"+this.state_);this.state_=e,this.result_=t,this.executeOnSettledCallbacks_()},i.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var e=0;e<this.onSettledCallbacks_.length;++e)_.asyncExecute(this.onSettledCallbacks_[e]);this.onSettledCallbacks_=null}};var _=new t;return i.prototype.settleSameAsPromise_=function(e){var t=this.createResolveAndReject_();e.callWhenSettled_(t.resolve,t.reject)},i.prototype.settleSameAsThenable_=function(e,t){var r=this.createResolveAndReject_();try{e.call(t,r.resolve,r.reject)}catch(e){r.reject(e)}},i.prototype.then=function(e,t){function r(e,t){return"function"==typeof e?function(t){try{s(e(t))}catch(e){_(e)}}:t}var s,_,a=new i(function(e,t){s=e,_=t});return this.callWhenSettled_(r(e,s),r(t,_)),a},i.prototype.catch=function(e){return this.then(void 0,e)},i.prototype.callWhenSettled_=function(e,t){function r(){switch(s.state_){case 1:e(s.result_);break;case 2:t(s.result_);break;default:throw Error("Unexpected state: "+s.state_)}}var s=this;null==this.onSettledCallbacks_?_.asyncExecute(r):this.onSettledCallbacks_.push(r)},i.resolve=r,i.reject=function(e){return new i(function(t,r){r(e)})},i.race=function(e){return new i(function(t,s){for(var i=$jscomp.makeIterator(e),_=i.next();!_.done;_=i.next())r(_.value).callWhenSettled_(t,s)})},i.all=function(e){var t=$jscomp.makeIterator(e),s=t.next();return s.done?r([]):new i(function(e,i){function _(t){return function(r){a[t]=r,0==--o&&e(a)}}var a=[],o=0;do{a.push(void 0),o++,r(s.value).callWhenSettled_(_(a.length-1),i),s=t.next()}while(!s.done)})},i},"es6","es3"),$jscomp.polyfill("Math.trunc",function(e){return e||function(e){if(e=Number(e),isNaN(e)||1/0===e||-1/0===e||0===e)return e;var t=Math.floor(Math.abs(e));return 0>e?-t:t}},"es6","es3"),$jscomp.iteratorFromArray=function(e,t){$jscomp.initSymbolIterator(),e instanceof String&&(e+="");var r=0,s={next:function(){if(r<e.length){var i=r++;return{value:t(i,e[i]),done:!1}}return s.next=function(){return{done:!0,value:void 0}},s.next()}};return s[Symbol.iterator]=function(){return s},s},$jscomp.polyfill("Array.prototype.entries",function(e){return e||function(){return $jscomp.iteratorFromArray(this,function(e,t){return[e,t]})}},"es6","es3"),$jscomp.checkEs6ConformanceViaProxy=function(){try{var e={},t=Object.create(new $jscomp.global.Proxy(e,{get:function(r,s,i){return r==e&&"q"==s&&i==t}}));return!0===t.q}catch(e){return!1}},$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS=!1,$jscomp.ES6_CONFORMANCE=$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS&&$jscomp.checkEs6ConformanceViaProxy(),$jscomp.owns=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},$jscomp.polyfill("WeakMap",function(e){function t(e){$jscomp.owns(e,s)||$jscomp.defineProperty(e,s,{value:{}})}function r(e){var r=Object[e];r&&(Object[e]=function(e){return t(e),r(e)})}if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(e&&$jscomp.ES6_CONFORMANCE)return e}else if(function(){if(!e||!Object.seal)return!1;try{var t=Object.seal({}),r=Object.seal({}),s=new e([[t,2],[r,3]]);return 2==s.get(t)&&3==s.get(r)&&(s.delete(t),s.set(r,4),!s.has(t)&&4==s.get(r))}catch(e){return!1}}())return e;var s="$jscomp_hidden_"+Math.random();r("freeze"),r("preventExtensions"),r("seal");var i=0,_=function(e){if(this.id_=(i+=Math.random()+1).toString(),e){$jscomp.initSymbol(),$jscomp.initSymbolIterator(),e=$jscomp.makeIterator(e);for(var t;!(t=e.next()).done;)t=t.value,this.set(t[0],t[1])}};return _.prototype.set=function(e,r){if(t(e),!$jscomp.owns(e,s))throw Error("WeakMap key fail: "+e);return e[s][this.id_]=r,this},_.prototype.get=function(e){return $jscomp.owns(e,s)?e[s][this.id_]:void 0},_.prototype.has=function(e){return $jscomp.owns(e,s)&&$jscomp.owns(e[s],this.id_)},_.prototype.delete=function(e){return!(!$jscomp.owns(e,s)||!$jscomp.owns(e[s],this.id_))&&delete e[s][this.id_]},_},"es6","es3"),$jscomp.MapEntry=function(){},$jscomp.polyfill("Map",function(e){if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(e&&$jscomp.ES6_CONFORMANCE)return e}else if(function(){if($jscomp.ASSUME_NO_NATIVE_MAP||!e||"function"!=typeof e||!e.prototype.entries||"function"!=typeof Object.seal)return!1;try{var t=Object.seal({x:4}),r=new e($jscomp.makeIterator([[t,"s"]]));if("s"!=r.get(t)||1!=r.size||r.get({x:4})||r.set({x:4},"t")!=r||2!=r.size)return!1;var s=r.entries(),i=s.next();return!i.done&&i.value[0]==t&&"s"==i.value[1]&&!((i=s.next()).done||4!=i.value[0].x||"t"!=i.value[1]||!s.next().done)}catch(e){return!1}}())return e;$jscomp.initSymbol(),$jscomp.initSymbolIterator();var t=new WeakMap,r=function(e){if(this.data_={},this.head_=_(),this.size=0,e){e=$jscomp.makeIterator(e);for(var t;!(t=e.next()).done;)t=t.value,this.set(t[0],t[1])}};r.prototype.set=function(e,t){var r=s(this,e);return r.list||(r.list=this.data_[r.id]=[]),r.entry?r.entry.value=t:(r.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:e,value:t},r.list.push(r.entry),this.head_.previous.next=r.entry,this.head_.previous=r.entry,this.size++),this},r.prototype.delete=function(e){return!(!(e=s(this,e)).entry||!e.list)&&(e.list.splice(e.index,1),e.list.length||delete this.data_[e.id],e.entry.previous.next=e.entry.next,e.entry.next.previous=e.entry.previous,e.entry.head=null,this.size--,!0)},r.prototype.clear=function(){this.data_={},this.head_=this.head_.previous=_(),this.size=0},r.prototype.has=function(e){return!!s(this,e).entry},r.prototype.get=function(e){return(e=s(this,e).entry)&&e.value},r.prototype.entries=function(){return i(this,function(e){return[e.key,e.value]})},r.prototype.keys=function(){return i(this,function(e){return e.key})},r.prototype.values=function(){return i(this,function(e){return e.value})},r.prototype.forEach=function(e,t){for(var r,s=this.entries();!(r=s.next()).done;)r=r.value,e.call(t,r[1],r[0],this)},r.prototype[Symbol.iterator]=r.prototype.entries;var s=function(e,r){var s=r&&typeof r;"object"==s||"function"==s?t.has(r)?s=t.get(r):(s=""+ ++a,t.set(r,s)):s="p_"+r;var i=e.data_[s];if(i&&$jscomp.owns(e.data_,s))for(e=0;e<i.length;e++){var _=i[e];if(r!=r&&_.key!=_.key||r===_.key)return{id:s,list:i,index:e,entry:_}}return{id:s,list:i,index:-1,entry:void 0}},i=function(e,t){var r=e.head_;return $jscomp.iteratorPrototype(function(){if(r){for(;r.head!=e.head_;)r=r.previous;for(;r.next!=r.head;)return r=r.next,{done:!1,value:t(r)};r=null}return{done:!0,value:void 0}})},_=function(){var e={};return e.previous=e.next=e.head=e},a=0;return r},"es6","es3"),$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(e){var t=function(){};return t.prototype=e,new t},$jscomp.construct=function(){if("undefined"!=typeof Reflect&&Reflect.construct){if(function(){function e(){}return new e,Reflect.construct(e,[],function(){}),new e instanceof e}())return Reflect.construct;var e=Reflect.construct;return function(t,r,s){return t=e(t,r),s&&Reflect.setPrototypeOf(t,s.prototype),t}}return function(e,t,r){return void 0===r&&(r=e),r=$jscomp.objectCreate(r.prototype||Object.prototype),Function.prototype.apply.call(e,r,t)||r}}(),$jscomp.polyfill("Reflect.construct",function(e){return $jscomp.construct},"es6","es3"),$jscomp.underscoreProtoCanBeSet=function(){var e={};try{return e.__proto__={a:!0},e.a}catch(e){}return!1},$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null,$jscomp.polyfill("Reflect.setPrototypeOf",function(e){if(e)return e;if($jscomp.setPrototypeOf){var t=$jscomp.setPrototypeOf;return function(e,r){try{return t(e,r),!0}catch(e){return!1}}}return null},"es6","es5");var COMPILED=!0,goog=goog||{};goog.global=this,goog.isDef=function(e){return void 0!==e},goog.exportPath_=function(e,t,r){e=e.split("."),r=r||goog.global,e[0]in r||!r.execScript||r.execScript("var "+e[0]);for(var s;e.length&&(s=e.shift());)!e.length&&goog.isDef(t)?r[s]=t:r=r[s]?r[s]:r[s]={}},goog.define=function(e,t){COMPILED||(goog.global.CLOSURE_UNCOMPILED_DEFINES&&Object.prototype.hasOwnProperty.call(goog.global.CLOSURE_UNCOMPILED_DEFINES,e)?t=goog.global.CLOSURE_UNCOMPILED_DEFINES[e]:goog.global.CLOSURE_DEFINES&&Object.prototype.hasOwnProperty.call(goog.global.CLOSURE_DEFINES,e)&&(t=goog.global.CLOSURE_DEFINES[e])),goog.exportPath_(e,t)},goog.DEBUG=!0,goog.LOCALE="en",goog.TRUSTED_SITE=!0,goog.STRICT_MODE_COMPATIBLE=!1,goog.DISALLOW_TEST_ONLY_CODE=COMPILED&&!goog.DEBUG,goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING=!1,goog.provide=function(e){if(!COMPILED&&goog.isProvided_(e))throw Error('Namespace "'+e+'" already declared.');goog.constructNamespace_(e)},goog.constructNamespace_=function(e,t){if(!COMPILED){delete goog.implicitNamespaces_[e];for(var r=e;(r=r.substring(0,r.lastIndexOf(".")))&&!goog.getObjectByName(r);)goog.implicitNamespaces_[r]=!0}goog.exportPath_(e,t)},goog.VALID_MODULE_RE_=/^[a-zA-Z_$][a-zA-Z0-9._$]*$/,goog.module=function(e){if(!goog.isString(e)||!e||-1==e.search(goog.VALID_MODULE_RE_))throw Error("Invalid module identifier");if(!goog.isInModuleLoader_())throw Error("Module "+e+" has been loaded incorrectly.");if(goog.moduleLoaderState_.moduleName)throw Error("goog.module may only be called once per module.");if(goog.moduleLoaderState_.moduleName=e,!COMPILED){if(goog.isProvided_(e))throw Error('Namespace "'+e+'" already declared.');delete goog.implicitNamespaces_[e]}},goog.module.get=function(e){return goog.module.getInternal_(e)},goog.module.getInternal_=function(e){if(!COMPILED)return goog.isProvided_(e)?e in goog.loadedModules_?goog.loadedModules_[e]:goog.getObjectByName(e):null},goog.moduleLoaderState_=null,goog.isInModuleLoader_=function(){return null!=goog.moduleLoaderState_},goog.module.declareTestMethods=function(){if(!goog.isInModuleLoader_())throw Error("goog.module.declareTestMethods must be called from within a goog.module");goog.moduleLoaderState_.declareTestMethods=!0},goog.module.declareLegacyNamespace=function(){if(!COMPILED&&!goog.isInModuleLoader_())throw Error("goog.module.declareLegacyNamespace must be called from within a goog.module");if(!COMPILED&&!goog.moduleLoaderState_.moduleName)throw Error("goog.module must be called prior to goog.module.declareLegacyNamespace.");goog.moduleLoaderState_.declareLegacyNamespace=!0},goog.setTestOnly=function(e){if(goog.DISALLOW_TEST_ONLY_CODE)throw e=e||"",Error("Importing test-only code into non-debug environment"+(e?": "+e:"."))},goog.forwardDeclare=function(e){},COMPILED||(goog.isProvided_=function(e){return e in goog.loadedModules_||!goog.implicitNamespaces_[e]&&goog.isDefAndNotNull(goog.getObjectByName(e))},goog.implicitNamespaces_={"goog.module":!0}),goog.getObjectByName=function(e,t){e=e.split("."),t=t||goog.global;for(var r;r=e.shift();){if(!goog.isDefAndNotNull(t[r]))return null;t=t[r]}return t},goog.globalize=function(e,t){for(var r in t=t||goog.global,e)t[r]=e[r]},goog.addDependency=function(e,t,r,s){if(goog.DEPENDENCIES_ENABLED){var i;e=e.replace(/\\/g,"/");for(var _=goog.dependencies_,a=0;i=t[a];a++)_.nameToPath[i]=e,_.pathIsModule[e]=!!s;for(s=0;t=r[s];s++)e in _.requires||(_.requires[e]={}),_.requires[e][t]=!0}},goog.ENABLE_DEBUG_LOADER=!0,goog.logToConsole_=function(e){goog.global.console&&goog.global.console.error(e)},goog.require=function(e){if(!COMPILED){if(goog.ENABLE_DEBUG_LOADER&&goog.IS_OLD_IE_&&goog.maybeProcessDeferredDep_(e),goog.isProvided_(e))return goog.isInModuleLoader_()?goog.module.getInternal_(e):null;if(goog.ENABLE_DEBUG_LOADER){var t=goog.getPathFromDeps_(e);if(t)return goog.included_[t]=!0,goog.writeScripts_(),null}throw e="goog.require could not find: "+e,goog.logToConsole_(e),Error(e)}},goog.basePath="",goog.nullFunction=function(){},goog.abstractMethod=function(){throw Error("unimplemented abstract method")},goog.addSingletonGetter=function(e){e.getInstance=function(){return e.instance_?e.instance_:(goog.DEBUG&&(goog.instantiatedSingletons_[goog.instantiatedSingletons_.length]=e),e.instance_=new e)}},goog.instantiatedSingletons_=[],goog.LOAD_MODULE_USING_EVAL=!0,goog.SEAL_MODULE_EXPORTS=goog.DEBUG,goog.loadedModules_={},goog.DEPENDENCIES_ENABLED=!COMPILED&&goog.ENABLE_DEBUG_LOADER,goog.DEPENDENCIES_ENABLED&&(goog.included_={},goog.dependencies_={pathIsModule:{},nameToPath:{},requires:{},visited:{},written:{},deferred:{}},goog.inHtmlDocument_=function(){var e=goog.global.document;return void 0!==e&&"write"in e},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH)goog.basePath=goog.global.CLOSURE_BASE_PATH;else if(goog.inHtmlDocument_())for(var e=goog.global.document.getElementsByTagName("SCRIPT"),t=e.length-1;0<=t;--t){var r=e[t].src,s=r.lastIndexOf("?");if(s=-1==s?r.length:s,"base.js"==r.substr(s-7,7)){goog.basePath=r.substr(0,s-7);break}}},goog.importScript_=function(e,t){(goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_)(e,t)&&(goog.dependencies_.written[e]=!0)},goog.IS_OLD_IE_=!goog.global.atob&&goog.global.document&&goog.global.document.all,goog.importModule_=function(e){goog.importScript_("",'goog.retrieveAndExecModule_("'+e+'");')&&(goog.dependencies_.written[e]=!0)},goog.queuedModules_=[],goog.wrapModule_=function(e,t){return goog.LOAD_MODULE_USING_EVAL&&goog.isDef(goog.global.JSON)?"goog.loadModule("+goog.global.JSON.stringify(t+"\n//# sourceURL="+e+"\n")+");":'goog.loadModule(function(exports) {"use strict";'+t+"\n;return exports});\n//# sourceURL="+e+"\n"},goog.loadQueuedModules_=function(){var e=goog.queuedModules_.length;if(0<e){var t=goog.queuedModules_;goog.queuedModules_=[];for(var r=0;r<e;r++)goog.maybeProcessDeferredPath_(t[r])}},goog.maybeProcessDeferredDep_=function(e){goog.isDeferredModule_(e)&&goog.allDepsAreAvailable_(e)&&(e=goog.getPathFromDeps_(e),goog.maybeProcessDeferredPath_(goog.basePath+e))},goog.isDeferredModule_=function(e){return!(!(e=goog.getPathFromDeps_(e))||!goog.dependencies_.pathIsModule[e])&&goog.basePath+e in goog.dependencies_.deferred},goog.allDepsAreAvailable_=function(e){if((e=goog.getPathFromDeps_(e))&&e in goog.dependencies_.requires)for(var t in goog.dependencies_.requires[e])if(!goog.isProvided_(t)&&!goog.isDeferredModule_(t))return!1;return!0},goog.maybeProcessDeferredPath_=function(e){if(e in goog.dependencies_.deferred){var t=goog.dependencies_.deferred[e];delete goog.dependencies_.deferred[e],goog.globalEval(t)}},goog.loadModule=function(e){var t=goog.moduleLoaderState_;try{if(goog.moduleLoaderState_={moduleName:void 0,declareTestMethods:!1},goog.isFunction(e))var r=e.call(goog.global,{});else{if(!goog.isString(e))throw Error("Invalid module definition");r=goog.loadModuleFromSource_.call(goog.global,e)}var s=goog.moduleLoaderState_.moduleName;if(!goog.isString(s)||!s)throw Error('Invalid module name "'+s+'"');if(goog.moduleLoaderState_.declareLegacyNamespace?goog.constructNamespace_(s,r):goog.SEAL_MODULE_EXPORTS&&Object.seal&&Object.seal(r),goog.loadedModules_[s]=r,goog.moduleLoaderState_.declareTestMethods)for(var i in r)0!==i.indexOf("test",0)&&"tearDown"!=i&&"setUp"!=i&&"setUpPage"!=i&&"tearDownPage"!=i||(goog.global[i]=r[i])}finally{goog.moduleLoaderState_=t}},goog.loadModuleFromSource_=function(a){return eval(a),{}},goog.writeScriptSrcNode_=function(e){goog.global.document.write('<script type="text/javascript" src="'+e+'"><\/script>')},goog.appendScriptSrcNode_=function(e){var t=goog.global.document,r=t.createElement("script");r.type="text/javascript",r.src=e,r.defer=!1,r.async=!1,t.head.appendChild(r)},goog.writeScriptTag_=function(e,t){if(goog.inHtmlDocument_()){var r=goog.global.document;if(!goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING&&"complete"==r.readyState){if(/\bdeps.js$/.test(e))return!1;throw Error('Cannot write "'+e+'" after document load')}var s=goog.IS_OLD_IE_;return void 0===t?s?(t=" onreadystatechange='goog.onScriptLoad_(this, "+ ++goog.lastNonModuleScriptIndex_+")' ",r.write('<script type="text/javascript" src="'+e+'"'+t+"><\/script>")):goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING?goog.appendScriptSrcNode_(e):goog.writeScriptSrcNode_(e):r.write('<script type="text/javascript">'+t+"<\/script>"),!0}return!1},goog.lastNonModuleScriptIndex_=0,goog.onScriptLoad_=function(e,t){return"complete"==e.readyState&&goog.lastNonModuleScriptIndex_==t&&goog.loadQueuedModules_(),!0},goog.writeScripts_=function(){function e(i){if(!(i in s.written)){if(!(i in s.visited)&&(s.visited[i]=!0,i in s.requires))for(var _ in s.requires[i])if(!goog.isProvided_(_)){if(!(_ in s.nameToPath))throw Error("Undefined nameToPath for "+_);e(s.nameToPath[_])}i in r||(r[i]=!0,t.push(i))}}var t=[],r={},s=goog.dependencies_;for(_ in goog.included_)s.written[_]||e(_);for(var i=0;i<t.length;i++){var _=t[i];goog.dependencies_.written[_]=!0}var a=goog.moduleLoaderState_;for(goog.moduleLoaderState_=null,i=0;i<t.length;i++){if(!(_=t[i]))throw goog.moduleLoaderState_=a,Error("Undefined script input");s.pathIsModule[_]?goog.importModule_(goog.basePath+_):goog.importScript_(goog.basePath+_)}goog.moduleLoaderState_=a},goog.getPathFromDeps_=function(e){return e in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[e]:null},goog.findBasePath_(),goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js")),goog.normalizePath_=function(e){e=e.split("/");for(var t=0;t<e.length;)"."==e[t]?e.splice(t,1):t&&".."==e[t]&&e[t-1]&&".."!=e[t-1]?e.splice(--t,2):t++;return e.join("/")},goog.loadFileSync_=function(e){if(goog.global.CLOSURE_LOAD_FILE_SYNC)return goog.global.CLOSURE_LOAD_FILE_SYNC(e);var t=new goog.global.XMLHttpRequest;return t.open("get",e,!1),t.send(),t.responseText},goog.retrieveAndExecModule_=function(e){if(!COMPILED){var t=e;e=goog.normalizePath_(e);var r=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_,s=goog.loadFileSync_(e);if(null==s)throw Error("load of "+e+"failed");s=goog.wrapModule_(e,s),goog.IS_OLD_IE_?(goog.dependencies_.deferred[t]=s,goog.queuedModules_.push(t)):r(e,s)}},goog.typeOf=function(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var r=Object.prototype.toString.call(e);if("[object Window]"==r)return"object";if("[object Array]"==r||"number"==typeof e.length&&void 0!==e.splice&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("splice"))return"array";if("[object Function]"==r||void 0!==e.call&&void 0!==e.propertyIsEnumerable&&!e.propertyIsEnumerable("call"))return"function"}else if("function"==t&&void 0===e.call)return"object";return t},goog.isNull=function(e){return null===e},goog.isDefAndNotNull=function(e){return null!=e},goog.isArray=function(e){return"array"==goog.typeOf(e)},goog.isArrayLike=function(e){var t=goog.typeOf(e);return"array"==t||"object"==t&&"number"==typeof e.length},goog.isDateLike=function(e){return goog.isObject(e)&&"function"==typeof e.getFullYear},goog.isString=function(e){return"string"==typeof e},goog.isBoolean=function(e){return"boolean"==typeof e},goog.isNumber=function(e){return"number"==typeof e},goog.isFunction=function(e){return"function"==goog.typeOf(e)},goog.isObject=function(e){var t=typeof e;return"object"==t&&null!=e||"function"==t},goog.getUid=function(e){return e[goog.UID_PROPERTY_]||(e[goog.UID_PROPERTY_]=++goog.uidCounter_)},goog.hasUid=function(e){return!!e[goog.UID_PROPERTY_]},goog.removeUid=function(e){"removeAttribute"in e&&e.removeAttribute(goog.UID_PROPERTY_);try{delete e[goog.UID_PROPERTY_]}catch(e){}},goog.UID_PROPERTY_="closure_uid_"+(1e9*Math.random()>>>0),goog.uidCounter_=0,goog.getHashCode=goog.getUid,goog.removeHashCode=goog.removeUid,goog.cloneObject=function(e){var t=goog.typeOf(e);if("object"==t||"array"==t){if(e.clone)return e.clone();for(var r in t="array"==t?[]:{},e)t[r]=goog.cloneObject(e[r]);return t}return e},goog.bindNative_=function(e,t,r){return e.call.apply(e.bind,arguments)},goog.bindJs_=function(e,t,r){if(!e)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,s),e.apply(t,r)}}return function(){return e.apply(t,arguments)}},goog.bind=function(e,t,r){return Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_,goog.bind.apply(null,arguments)},goog.partial=function(e,t){var r=Array.prototype.slice.call(arguments,1);return function(){var t=r.slice();return t.push.apply(t,arguments),e.apply(this,t)}},goog.mixin=function(e,t){for(var r in t)e[r]=t[r]},goog.now=goog.TRUSTED_SITE&&Date.now||function(){return+new Date},goog.globalEval=function(e){if(goog.global.execScript)goog.global.execScript(e,"JavaScript");else{if(!goog.global.eval)throw Error("goog.globalEval not available");if(null==goog.evalWorksForGlobals_&&(goog.global.eval("var _et_ = 1;"),void 0!==goog.global._et_?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1),goog.evalWorksForGlobals_)goog.global.eval(e);else{var t=goog.global.document,r=t.createElement("SCRIPT");r.type="text/javascript",r.defer=!1,r.appendChild(t.createTextNode(e)),t.body.appendChild(r),t.body.removeChild(r)}}},goog.evalWorksForGlobals_=null,goog.getCssName=function(e,t){var r=function(e){return goog.cssNameMapping_[e]||e},s=function(e){e=e.split("-");for(var t=[],s=0;s<e.length;s++)t.push(r(e[s]));return t.join("-")};return s=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?r:s:function(e){return e},t?e+"-"+s(t):s(e)},goog.setCssNameMapping=function(e,t){goog.cssNameMapping_=e,goog.cssNameMappingStyle_=t},!COMPILED&&goog.global.CLOSURE_CSS_NAME_MAPPING&&(goog.cssNameMapping_=goog.global.CLOSURE_CSS_NAME_MAPPING),goog.getMsg=function(e,t){return t&&(e=e.replace(/\{\$([^}]+)}/g,function(e,r){return r in t?t[r]:e})),e},goog.getMsgWithFallback=function(e,t){return e},goog.exportSymbol=function(e,t,r){goog.exportPath_(e,t,r)},goog.exportProperty=function(e,t,r){e[t]=r},goog.inherits=function(e,t){function r(){}r.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.base=function(e,r,s){for(var i=Array(arguments.length-2),_=2;_<arguments.length;_++)i[_-2]=arguments[_];return t.prototype[r].apply(e,i)}},goog.base=function(e,t,r){var s=arguments.callee.caller;if(goog.STRICT_MODE_COMPATIBLE||goog.DEBUG&&!s)throw Error("arguments.caller not defined.  goog.base() cannot be used with strict mode code. See http://www.ecma-international.org/ecma-262/5.1/#sec-C");if(s.superClass_){for(var i=Array(arguments.length-1),_=1;_<arguments.length;_++)i[_-1]=arguments[_];return s.superClass_.constructor.apply(e,i)}for(i=Array(arguments.length-2),_=2;_<arguments.length;_++)i[_-2]=arguments[_];_=!1;for(var a=e.constructor;a;a=a.superClass_&&a.superClass_.constructor)if(a.prototype[t]===s)_=!0;else if(_)return a.prototype[t].apply(e,i);if(e[t]===s)return e.constructor.prototype[t].apply(e,i);throw Error("goog.base called from a method of one name to a method of a different name")},goog.scope=function(e){e.call(goog.global)},COMPILED||(goog.global.COMPILED=COMPILED),goog.defineClass=function(e,t){var r=t.constructor,s=t.statics;return r&&r!=Object.prototype.constructor||(r=function(){throw Error("cannot instantiate an interface (no constructor defined).")}),r=goog.defineClass.createSealingConstructor_(r,e),e&&goog.inherits(r,e),delete t.constructor,delete t.statics,goog.defineClass.applyProperties_(r.prototype,t),null!=s&&(s instanceof Function?s(r):goog.defineClass.applyProperties_(r,s)),r},goog.defineClass.SEAL_CLASS_INSTANCES=goog.DEBUG,goog.defineClass.createSealingConstructor_=function(e,t){if(goog.defineClass.SEAL_CLASS_INSTANCES&&Object.seal instanceof Function){if(t&&t.prototype&&t.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_])return e;var r=function(){var t=e.apply(this,arguments)||this;return t[goog.UID_PROPERTY_]=t[goog.UID_PROPERTY_],this.constructor===r&&Object.seal(t),t};return r}return e},goog.defineClass.OBJECT_PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),goog.defineClass.applyProperties_=function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);for(var s=0;s<goog.defineClass.OBJECT_PROTOTYPE_FIELDS_.length;s++)r=goog.defineClass.OBJECT_PROTOTYPE_FIELDS_[s],Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},goog.tagUnsealableClass=function(e){!COMPILED&&goog.defineClass.SEAL_CLASS_INSTANCES&&(e.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_]=!0)},goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_="goog_defineClass_legacy_unsealable";var LOG_ALL=-1,LOG_NONE=0,LOG_OTHER=1,LOG_CPU=2,LOG_FPU=4,LOG_MEM=8,LOG_DMA=16,LOG_IO=32,LOG_PS2=64,LOG_PIC=128,LOG_VGA=256,LOG_PIT=512,LOG_MOUSE=1024,LOG_PCI=2048,LOG_BIOS=4096,LOG_FLOPPY=8192,LOG_SERIAL=16384,LOG_DISK=32768,LOG_RTC=65536,LOG_HPET=131072,LOG_ACPI=262144,LOG_APIC=524288,LOG_NET=1048576,LOG_VIRTIO=2097152,LOG_9P=4194304,LOG_SB16=8388608,LOG_NAMES=[[1,""],[LOG_CPU,"CPU"],[LOG_DISK,"DISK"],[LOG_FPU,"FPU"],[LOG_MEM,"MEM"],[LOG_DMA,"DMA"],[LOG_IO,"IO"],[LOG_PS2,"PS2"],[LOG_PIC,"PIC"],[LOG_VGA,"VGA"],[LOG_PIT,"PIT"],[LOG_MOUSE,"MOUS"],[LOG_PCI,"PCI"],[LOG_BIOS,"BIOS"],[LOG_FLOPPY,"FLOP"],[LOG_SERIAL,"SERI"],[LOG_RTC,"RTC"],[LOG_HPET,"HPET"],[LOG_ACPI,"ACPI"],[LOG_APIC,"APIC"],[LOG_NET,"NET"],[LOG_VIRTIO,"VIO"],[LOG_9P,"9P"],[LOG_SB16,"SB16"]],TLB_SYSTEM_READ=1,TLB_SYSTEM_WRITE=2,TLB_USER_READ=4,TLB_USER_WRITE=8,flag_carry=1,flag_parity=4,flag_adjust=16,flag_zero=64,flag_sign=128,flag_trap=256,flag_interrupt=512,flag_direction=1024,flag_overflow=2048,flag_iopl=12288,flag_nt=16384,flag_rf=65536,flag_vm=131072,flag_ac=262144,flag_vif=524288,flag_vip=1048576,flag_id=2097152,flags_default=2,flags_mask=flag_carry|flag_parity|flag_adjust|flag_zero|flag_sign|flag_trap|flag_interrupt|flag_direction|flag_overflow|flag_iopl|flag_nt|flag_rf|flag_vm|flag_ac|flag_vif|flag_vip|flag_id,flags_all=flag_carry|flag_parity|flag_adjust|flag_zero|flag_sign|flag_overflow,OPSIZE_8=7,OPSIZE_16=15,OPSIZE_32=31,PSE_ENABLED=128,reg_eax=0,reg_ecx=1,reg_edx=2,reg_ebx=3,reg_esp=4,reg_ebp=5,reg_esi=6,reg_edi=7,reg_ax=0,reg_cx=2,reg_dx=4,reg_bx=6,reg_sp=8,reg_bp=10,reg_si=12,reg_di=14,reg_al=0,reg_cl=4,reg_dl=8,reg_bl=12,reg_ah=1,reg_ch=5,reg_dh=9,reg_bh=13,reg_es=0,reg_cs=1,reg_ss=2,reg_ds=3,reg_fs=4,reg_gs=5,reg_tr=6,reg_ldtr=7,MMAP_BLOCK_BITS=17,MMAP_BLOCK_SIZE=1<<MMAP_BLOCK_BITS,MEM_PAGE_WRITTEN=1,MAGIC_CPU_EXCEPTION=233495534,REPEAT_STRING_PREFIX_NONE=0,REPEAT_STRING_PREFIX_NZ=1,REPEAT_STRING_PREFIX_Z=2,CR0_PE=1,CR0_MP=2,CR0_EM=4,CR0_TS=8,CR0_ET=16,CR0_WP=65536,CR0_NW=536870912,CR0_CD=1073741824,CR0_PG=-2147483648,CR4_VME=1,CR4_PVI=2,CR4_TSD=4,CR4_PSE=16,CR4_DE=8,CR4_PAE=32,CR4_PGE=128,CR4_OSFXSR=512,CR4_OSXMMEXCPT=1024,SEG_PREFIX_NONE=-1,SEG_PREFIX_ZERO=7,IA32_SYSENTER_CS=372,IA32_SYSENTER_ESP=373,IA32_SYSENTER_EIP=374,IA32_TIME_STAMP_COUNTER=16,IA32_PLATFORM_ID=23,MSR_EBC_FREQUENCY_ID=44,IA32_APIC_BASE_MSR=27,IA32_BIOS_SIGN_ID=139,IA32_MISC_ENABLE=416,IA32_RTIT_CTL=1392,MSR_SMI_COUNT=52,IA32_MCG_CAP=377,IA32_KERNEL_GS_BASE=-1073741567,MSR_PKG_C2_RESIDENCY=1549,IA32_APIC_BASE_BSP=256,IA32_APIC_BASE_EXTD=1024,IA32_APIC_BASE_EN=2048,TSR_BACKLINK=0,TSR_CR3=28,TSR_EIP=32,TSR_EFLAGS=36,TSR_EAX=40,TSR_ECX=44,TSR_EDX=48,TSR_EBX=52,TSR_ESP=56,TSR_EBP=60,TSR_ESI=64,TSR_EDI=68,TSR_ES=72,TSR_CS=76,TSR_SS=80,TSR_DS=84,TSR_FS=88,TSR_GS=92,TSR_LDT=96,FW_CFG_SIGNATURE=0,FW_CFG_RAM_SIZE=3,FW_CFG_NB_CPUS=5,PREFIX_MASK_REP=24,PREFIX_REPZ=8,PREFIX_REPNZ=16,PREFIX_MASK_SEGMENT=7,PREFIX_MASK_OPSIZE=32,PREFIX_MASK_ADDRSIZE=64,PREFIX_F2=PREFIX_REPNZ,PREFIX_F3=PREFIX_REPZ,PREFIX_66=PREFIX_MASK_OPSIZE,MXCSR_MASK=65471,MIXER_CHANNEL_LEFT=0,MIXER_CHANNEL_RIGHT=1,MIXER_CHANNEL_BOTH=2,MIXER_SRC_MASTER=0,MIXER_SRC_PCSPEAKER=1,MIXER_SRC_DAC=2;function ScreenAdapter(e,t){function r(e){return e=e.toString(16),"#"+Array(7-e.length).join("0")+e}function s(e,t,r,s){e.style.width="",e.style.height="",s&&(e.style.transform=e.style.webkitTransform=e.style.MozTransform="");var i=e.getBoundingClientRect();s?e.style.transform=e.style.webkitTransform=e.style.MozTransform=(1===t?"":" scaleX("+t+")")+(1===r?"":" scaleY("+r+")"):(0==t%1&&0==r%1?(c.style.imageRendering="pixelated",c.style["-ms-interpolation-mode"]="nearest-neighbor"):(c.style.imageRendering="",c.style["-ms-interpolation-mode"]=""),0!=(s=window.devicePixelRatio||1)%1&&(t/=s,r/=s)),1!==t&&(e.style.width=i.width*t+"px"),1!==r&&(e.style.height=i.height*r+"px")}console.assert(e,"1st argument must be a DOM container");var i,_,a,o,n,d,h,g,c=e.getElementsByTagName("canvas")[0],p=c.getContext("2d"),u=e.getElementsByTagName("div")[0],l=document.createElement("div"),f=1,m=1,b=!1,y=this;e=new Uint16Array([199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var v,P=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),w=[],E=0;256>E;E++)v=127<E?e[E-128]:32>E?P[E]:E,w[E]=String.fromCharCode(v);p.imageSmoothingEnabled=!1,l.style.position="absolute",l.style.backgroundColor="#ccc",l.style.width="7px",l.style.display="inline-block",u.style.display="block",c.style.display="none",this.bus=t,t.register("screen-set-mode",function(e){this.set_mode(e)},this),t.register("screen-fill-buffer-end",function(e){this.update_buffer(e)},this),t.register("screen-put-char",function(e){this.put_char(e[0],e[1],e[2],e[3],e[4])},this),t.register("screen-update-cursor",function(e){this.update_cursor(e[0],e[1])},this),t.register("screen-update-cursor-scanline",function(e){this.update_cursor_scanline(e[0],e[1])},this),t.register("screen-clear",function(){this.clear_screen()},this),t.register("screen-set-size-text",function(e){this.set_size_text(e[0],e[1])},this),t.register("screen-set-size-graphical",function(e){this.set_size_graphical(e[0],e[1],e[2],e[3])},this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){try{window.open(c.toDataURL())}catch(e){}},this.put_char=function(e,t,r,s,i){e<g&&t<h&&(d[t=3*(e*h+t)]=r,d[t+1]=s,d[t+2]=i,n[e]=1)},this.timer=function(){requestAnimationFrame(b?x:S)};var S=function(){for(var e=0;e<g;e++)n[e]&&(y.text_update_row(e),n[e]=0);this.timer()}.bind(this),x=function(){this.bus.send("screen-fill-buffer"),this.timer()}.bind(this);this.destroy=function(){},this.set_mode=function(e){(b=e)?(u.style.display="none",c.style.display="block"):(u.style.display="block",c.style.display="none")},this.clear_screen=function(){p.fillStyle="#000",p.fillRect(0,0,c.width,c.height)},this.set_size_text=function(e,t){if(e!==h||t!==g){for(n=new Int8Array(t),d=new Int32Array(e*t*3),h=e,g=t;u.childNodes.length>t;)u.removeChild(u.firstChild);for(;u.childNodes.length<t;)u.appendChild(document.createElement("div"));for(e=0;e<t;e++)this.text_update_row(e);s(u,f,m,!0)}},this.set_size_graphical=function(e,t,r,a){DEBUG_SCREEN_LAYERS&&(e=r,t=a),c.style.display="block",c.width=e,c.height=t,i=p.createImageData(r,a),new Uint8Array(i.data.buffer),_=new Int32Array(i.data.buffer),this.bus.send("screen-tell-buffer",[_],[_.buffer]),s(c,f,m,!1)},this.set_scale=function(e,t){s(u,f=e,m=t,!0),s(c,f,m,!1)},this.set_scale(f,m),this.update_cursor_scanline=function(e,t){32&e?l.style.display="none":(l.style.display="inline",l.style.height=Math.min(15,t-e)+"px",l.style.marginTop=Math.min(15,e)+"px")},this.update_cursor=function(e,t){e===a&&t===o||(n[e]=1,n[a]=1,a=e,o=t)},this.text_update_row=function(e){for(var t,s=3*e*h,i=u.childNodes[e],_=document.createElement("div"),n=0;n<h;){var g=document.createElement("span"),c=d[s+1],p=d[s+2];for(g.style.backgroundColor=r(c),g.style.color=r(p),t="";n<h&&d[s+1]===c&&d[s+2]===p;)if(t+=w[d[s]],n++,s+=3,e===a){if(n===o)break;if(n===o+1){_.appendChild(l);break}}g.textContent=t,_.appendChild(g)}i.parentNode.replaceChild(_,i)},this.update_buffer=function(e){DEBUG_SCREEN_LAYERS?(p.putImageData(i,0,0),p.strokeStyle="#0F0",p.lineWidth=4,e.forEach(function(e){p.strokeRect(e.buffer_x,e.buffer_y,e.buffer_width,e.buffer_height)}),p.lineWidth=1):e.forEach(function(e){p.putImageData(i,e.screen_x-e.buffer_x,e.screen_y-e.buffer_y,e.buffer_x,e.buffer_y,e.buffer_width,e.buffer_height)})},this.init()}"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame);var V9FS_MAGIC=16914839,P9_TSTATFS=8,P9_TLOPEN=12,P9_TLCREATE=14,P9_TSYMLINK=16,P9_TMKNOD=18,P9_TREADLINK=22,P9_TGETATTR=24,P9_TSETATTR=26,P9_TXATTRWALK=30,P9_TXATTRCREATE=32,P9_TREADDIR=40,P9_TFSYNC=50,P9_TLOCK=52,P9_TGETLOCK=54,P9_TLINK=70,P9_TMKDIR=72,P9_TRENAMEAT=74,P9_TUNLINKAT=76,P9_TVERSION=100,P9_TATTACH=104,P9_TERROR=106,P9_TFLUSH=108,P9_TWALK=110,P9_TOPEN=112,P9_TREAD=116,P9_TWRITE=118,P9_TCLUNK=120,P9_TRENAME=20,P9_TAUTH=102,P9_TCREATE=114,P9_TREMOVE=122,P9_TSTAT=124,P9_TWSTAT=126,POSIX_ERR_CODE_MAP={EPERM:1,ENOENT:2,EBADF:9,EBUSY:11,EINVAL:22,ENOTDIR:20,EISDIR:21,EEXIST:17,ELOOP:40,ENOTEMPTY:39,EIO:5},P9_SETATTR_MODE=1,P9_SETATTR_UID=2,P9_SETATTR_GID=4,P9_SETATTR_SIZE=8,P9_SETATTR_ATIME=16,P9_SETATTR_MTIME=32,P9_SETATTR_CTIME=64,P9_SETATTR_ATIME_SET=128,P9_SETATTR_MTIME_SET=256,P9_STAT_MODE_DIR=2147483648,P9_STAT_MODE_APPEND=1073741824,P9_STAT_MODE_EXCL=536870912,P9_STAT_MODE_MOUNT=268435456,P9_STAT_MODE_AUTH=134217728,P9_STAT_MODE_TMP=67108864,P9_STAT_MODE_SYMLINK=33554432,P9_STAT_MODE_LINK=16777216,P9_STAT_MODE_DEVICE=8388608,P9_STAT_MODE_NAMED_PIPE=2097152,P9_STAT_MODE_SOCKET=1048576,P9_STAT_MODE_SETUID=524288,P9_STAT_MODE_SETGID=262144,P9_STAT_MODE_SETVTX=65536,P9_QTDIR=128,P9_QTAPPEND=64,P9_QTEXCL=32,P9_QTMOUNT=16,P9_QTAUTH=8,P9_QTTMP=4,P9_QTSYMLINK=2,P9_QTLINK=1,P9_QTFILE=0,FID_NONE=-1,FID_INODE=1,FID_XATTR=2;function hash32(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return t>>>0}function getQType(e){switch(e){case"FILE":return P9_QTFILE;case"DIRECTORY":return P9_QTDIR;case"SYMLINK":return P9_QTSYMLINK;default:return P9_QTFILE}}function formatQid(e,t){return{type:getQType(t.type),version:t.version,path:hash32(t.node)}}function Virtio9p(e,t){this.fs=e.fs,this.sh=e.sh,this.Path=e.Path,this.Buffer=e.Buffer,this.bus=t,this.deviceid=9,this.hostfeature=1,this.configspace=new Uint8Array([6,0,104,111,115,116,57,112]),this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids={},this.pendingTags={}}Virtio9p.prototype.addTag=function(e){this.pendingTags[e]={}},Virtio9p.prototype.flushTag=function(e){delete this.pendingTags[e]},Virtio9p.prototype.shouldAbortRequest=function(e){var t=!this.pendingTags[e];return t&&message.Debug("Request can be aborted tag="+e),t},Virtio9p.prototype.SendReply=function(e,t){message.Debug("Unexpected call to SendReply on Virtio9p",e,t)},Virtio9p.prototype.get_state=function(){var e=[];return e[0]=this.deviceid,e[1]=this.hostfeature,e[2]=this.configspace,e[3]=this.VERSION,e[4]=this.BLOCKSIZE,e[5]=this.msize,e[6]=this.replybuffer,e[7]=this.replybuffersize,e[8]=JSON.stringify(this.fids),e},Virtio9p.prototype.set_state=function(e){this.deviceid=e[0],this.hostfeature=e[1],this.configspace=e[2],this.VERSION=e[3],this.BLOCKSIZE=e[4],this.msize=e[5],this.replybuffer=e[6],this.replybuffersize=e[7],this.fids=JSON.parse(e[8])},Virtio9p.prototype.Createfid=function(e,t,r){return{path:e,type:t,uid:r}},Virtio9p.prototype.Reset=function(){this.fids={}},Virtio9p.prototype.BuildReply=function(e,t,r){marshall.Marshall(["w","b","h"],[r+7,e+1,t],this.replybuffer,0),r+7>=this.replybuffer.length&&message.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=r+7,this.flushTag(t)},Virtio9p.prototype.SendError=function(e,t){console.warn("ERROR REPLY",t),t=marshall.Marshall(["w"],[POSIX_ERR_CODE_MAP[t.code]],this.replybuffer,7),this.BuildReply(6,e,t)},Virtio9p.prototype.ReceiveRequest=function(e,t){var r=this,s=this.Path,i=this.Buffer,_=this.fs,a=this.sh,o=marshall.Unmarshall2(["w","b","h"],t),n=o[0],d=o[1],h=o[2];switch(this.addTag(h),d){case P9_TSTATFS:message.Debug("[statfs]"),a=this.BLOCKSIZE,o=Math.floor(274877906944/a),n=marshall.Marshall("wwddddddw".split(""),[V9FS_MAGIC,a,o,o-Math.floor(51200/a),o-Math.floor(51200/a),this.fs.inodes.length,1048576,0,256],this.replybuffer,7),this.BuildReply(d,h,n),this.SendReply(0,e);break;case P9_TLOPEN:var g=marshall.Unmarshall2(["w","w"],t),c=g[0],p=this.fids[c].path,u=g[1];message.Debug("[tlopen] fid="+c," path="+p," mode="+u),_.stat(p,function(t,s){r.shouldAbortRequest(h)||(t?r.SendError(h,t):(g[0]=formatQid(p,s),g[1]=r.msize-24,marshall.Marshall(["Q","w"],g,r.replybuffer,7),r.BuildReply(d,h,17)),r.SendReply(0,e))});break;case P9_TLINK:var l=(g=marshall.Unmarshall2(["w","w","s"],t))[0];o=r.fids[l].path,c=g[1],u=r.fids[c].path,a=g[2];var f=s.join(o,a);message.Debug("[link] existingPath="+u+", newPath="+f),_.link(u,f,function(t){r.shouldAbortRequest(h)||(t?r.SendError(h,t):r.BuildReply(d,h,0),r.SendReply(0,e))});break;case P9_TSYMLINK:l=(g=marshall.Unmarshall2(["w","s","s","w"],t))[0],o=r.fids[l].path,a=g[1],f=s.join(o,a),a=g[2],o=g[3],message.Debug("[symlink] symtgt="+a+", newPath="+f+", gid="+o),_.symlink(a,f,function(t){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):_.stat(f,function(t,s){r.shouldAbortRequest(h)||(t?r.SendError(h,t):(t=formatQid(f,s),marshall.Marshall(["Q"],[t],r.replybuffer,7),r.BuildReply(d,h,13)),r.SendReply(0,e))}))});break;case P9_TMKNOD:l=(g=marshall.Unmarshall2("wswwww".split(""),t))[0],o=r.fids[l].path,a=g[1];var m=s.join(o,a);u=g[2],a=g[3],u=g[4],o=g[5],message.Debug("[mknod] filePath="+m+", major="+a+", minor="+u+", gid="+o),_.mknod(m,"FILE",function(t){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):_.stat(m,function(t,s){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):(t=formatQid(m,s),marshall.Marshall(["Q"],[t],this.replybuffer,7),this.BuildReply(d,h,13),this.SendReply(0,e)))}))});break;case P9_TREADLINK:g=marshall.Unmarshall2(["w"],t),c=g[0],p=r.fids[c].path,message.Debug("[readlink] path="+p),_.readlink(p,function(t,s){r.shouldAbortRequest(h)||(t?r.SendError(h,t):(n=marshall.Marshall(["s"],[s],r.replybuffer,7),r.BuildReply(d,h,n)),r.SendReply(0,e))});break;case P9_TMKDIR:l=(g=marshall.Unmarshall2(["w","s","w","w"],t))[0],a=g[1],u=g[2],o=g[3],l=r.fids[l].path;var b=s.join(l,a);message.Debug("[mkdir] fid.path="+l+", name="+b+", mode="+u+", gid="+o),_.mkdir(b,function(t){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):_.stat(b,function(t,s){r.shouldAbortRequest(h)||(t?r.SendError(h,t):(t=formatQid(b,s),marshall.Marshall(["Q"],[t],r.replybuffer,7),r.BuildReply(d,h,13)),r.SendReply(0,e))}))});break;case P9_TLCREATE:g=marshall.Unmarshall2(["w","s","w","w","w"],t),c=g[0],a=g[1],o=g[2],u=g[3],o=g[4],message.Debug("[tlcreate] fid="+c+", name="+a+", mode="+u+", gid="+o);var y=s.join(r.fids[c].path,a);_.open(y,"w",function(t,s){r.shouldAbortRequest(h)?s&&_.close(s):t?(r.SendError(h,t),r.SendReply(0,e)):_.fstat(s,function(t,i){r.shouldAbortRequest(h)?s&&_.close(s):(t?r.SendError(h,t):(r.fids[c]=r.Createfid(y,FID_INODE,x),_.close(s),t=formatQid(y,i),marshall.Marshall(["Q","w"],[t,r.msize-24],r.replybuffer,7),r.BuildReply(d,h,17)),r.SendReply(0,e))})});break;case P9_TLOCK:message.Debug("lock file\n"),marshall.Marshall(["w"],[0],this.replybuffer,7),this.BuildReply(d,h,1),this.SendReply(0,e);break;case P9_TGETATTR:g=marshall.Unmarshall2(["w","d"],t),c=g[0],p=this.fids[c].path,message.Debug("[getattr]: fid="+c+" path="+p+" request mask="+g[1]),_.lstat(p,function(t,s){if(!r.shouldAbortRequest(h)){if(t)r.SendError(h,t);else{t=formatQid(p,s);var i=s.size;marshall.Marshall("dQwwwddddddddddddddd".split(""),[2047,t,s.mode,s.uid,s.gid,s.nlinks,0,i,r.BLOCKSIZE,Math.floor(i/512+1),Math.round(s.atime/1e3),1e6*s.atime,Math.round(s.mtime/1e3),1e6*s.mtime,Math.round(s.ctime/1e3),1e6*s.ctime,0,0,0,0],r.replybuffer,7),r.BuildReply(d,h,153)}r.SendReply(0,e)}});break;case P9_TSETATTR:var v,P;g=marshall.Unmarshall2("wwwwwddddd".split(""),t),c=g[0],p=r.fids[c].path,message.Debug("[setattr]: path="+p+" request mask="+g[1]),a=[],g[1]&P9_SETATTR_MODE&&a.push(new Promise(function(e,t){var s=g[2];message.Debug("[setattr]: mode="+s),r.shouldAbortRequest(h)||_.chmod(p,s,function(r){r?t(r):e()})})),g[1]&P9_SETATTR_UID&&g[1]&P9_SETATTR_GID&&a.push(new Promise(function(e,t){var s=g[3],i=g[4];message.Debug("[setattr]: uid="+s+" gid="+i),r.shouldAbortRequest(h)||_.chown(p,s,i,function(r){r?t(r):e()})})),o=Date.now(),g[1]&P9_SETATTR_ATIME&&(v=o),g[1]&P9_SETATTR_MTIME&&(P=o),g[1]&P9_SETATTR_CTIME&&console.warn("[TODO] requested to SETATTR for CTIME, ignoring"),g[1]&P9_SETATTR_ATIME_SET&&(v=1e3*g[6]),g[1]&P9_SETATTR_MTIME_SET&&(P=1e3*g[8]),(v||P)&&a.push(new Promise(function(e,t){r.shouldAbortRequest(h)||(message.Debug("[setattr]: atime="+v+" mtime="+P),_.utimes(p,v,P,function(r){r?t(r):e()}))})),g[1]&P9_SETATTR_SIZE&&a.push(new Promise(function(e,t){var r=g[5];message.Debug("[setattr]: size="+r),_.truncate(p,r,function(r){r?t(r):e()})})),Promise.all(a).then(function(){r.BuildReply(d,h,0),r.SendReply(0,e)}).catch(function(t){r.SendError(h,t),r.SendReply(0,e)});break;case P9_TFSYNC:g=marshall.Unmarshall2(["w","d"],t),c=g[0],this.BuildReply(d,h,0),this.SendReply(0,e);break;case P9_TREADDIR:g=marshall.Unmarshall2(["w","d","w"],t),c=g[0];var w=g[1],E=g[2];p=this.fids[c].path,message.Debug("[treaddir]: fid="+c+" path="+p+" offset="+w+" count="+E),a.ls(p,{recursive:!1},function(t,i){if(!r.shouldAbortRequest(h))if(t)r.SendError(h,t),r.SendReply(0,e);else{var a=i.reduce(function(e,t){return e+13+8+1+2+UTF8.UTF8Length(t.name)},0);a+=25,a+=26;var o=new Uint8Array(a);_.stat(p,function(t,n){if(!r.shouldAbortRequest(h))if(t)r.SendError(h,t),r.SendReply(0,e);else{var g=0;g+=marshall.Marshall(["Q","d","b","s"],[formatQid(p,n),g+13+8+1+2+1,n.mode>>12,"."],o,g);var c=s.resolve("..",p);_.stat(c,function(t,_){if(!r.shouldAbortRequest(h)){if(t)r.SendError(h,t);else{if(g+=marshall.Marshall(["Q","d","b","s"],[formatQid(c,_),g+13+8+1+2+2,_.mode>>12,".."],o,g),i.forEach(function(e){var t=s.join(p,e.name);g+=marshall.Marshall(["Q","d","b","s"],[formatQid(t,e),g+13+8+1+2+UTF8.UTF8Length(e.name),e.mode>>12,e.name],o,g)}),a<w+E&&(E=a-w),o)for(t=0;t<E;t++)r.replybuffer[11+t]=o[w+t];marshall.Marshall(["w"],[E],r.replybuffer,7),r.BuildReply(d,h,4+E)}r.SendReply(0,e)}})}})}});break;case P9_TREAD:var S=function(t){var s=t.length;for(w+E>s&&(E=s-w),s=0;s<E;s++)r.replybuffer[11+s]=t[w+s];marshall.Marshall(["w"],[E],r.replybuffer,7),r.BuildReply(d,h,4+E),r.SendReply(0,e)};if(g=marshall.Unmarshall2(["w","d","w"],t),c=g[0],w=g[1],E=g[2],p=this.fids[c].path,message.Debug("[tread]: fid="+c+" path="+p+" offset="+w+" count="+E),a=r.pendingTags[h].data){S(a);break}_.readFile(p,function(t,s){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):(r.pendingTags[h].data=s,S(s)))});break;case P9_TWRITE:g=marshall.Unmarshall2(["w","d","w"],t),c=g[0],w=g[1],E=g[2],p=r.fids[c].path,message.Debug("[twrite]: fid="+c+" path="+p+" offset="+w+" count="+E),_.open(p,"w",function(s,a){if(r.shouldAbortRequest(h))a&&_.close(a);else if(s)r.SendError(h,s),r.SendReply(0,e);else{s=new i(E);for(var o=0;o<E;o++)s[o]=t();_.write(a,s,0,E,w,function(t,s){r.shouldAbortRequest(h)?a&&_.close(a):(t?r.SendError(h,t):(_.close(a),marshall.Marshall(["w"],[s],r.replybuffer,7),r.BuildReply(d,h,4)),r.SendReply(0,e))})}});break;case P9_TRENAMEAT:g=marshall.Unmarshall2(["w","s","w","s"],t),a=s.join(r.fids[g[0]].path,g[1]),f=s.join(r.fids[g[2]].path,g[3]),message.Debug("[renameat]: oldPath="+a+" newPath="+f),_.rename(a,f,function(t){r.shouldAbortRequest(h)||(t?r.SendError(h,t):r.BuildReply(d,h,0),r.SendReply(0,e))});break;case P9_TUNLINKAT:u=(g=marshall.Unmarshall2(["w","s","w"],t))[0],a=g[1],o=g[2],p=s.join(r.fids[u].path,a),message.Debug("[tunlinkat]: path="+p),_.stat(p,function(t,s){r.shouldAbortRequest(h)||(t?(r.SendError(h,t),r.SendReply(0,e)):_["DIRECTORY"===s.type?"rmdir":"unlink"](p,function(t){r.shouldAbortRequest(h)||(t?r.SendError(h,t):r.BuildReply(d,h,0),r.SendReply(0,e))}))});break;case P9_TVERSION:a=marshall.Unmarshall2(["w","s"],t),message.Debug("[version]: msize="+a[0]+" version="+a[1]),this.msize=a[0],n=marshall.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(d,h,n),this.SendReply(0,e);break;case P9_TATTACH:g=marshall.Unmarshall2(["w","w","s","s","w"],t),c=g[0];var x=g[4];message.Debug("[attach]: fid="+c+" afid="+hex8(g[1])+" uname="+g[2]+" aname="+g[3]),this.fids[c]=this.Createfid("/",FID_INODE,x),_.stat("/",function(t,s){r.shouldAbortRequest(h)||(t?r.SendError(h,t):(t=formatQid("/",s),marshall.Marshall(["Q"],[t],r.replybuffer,7),r.BuildReply(d,h,13)),r.SendReply(0,e))});break;case P9_TFLUSH:g=marshall.Unmarshall2(["h"],t),this.flushTag(g[0]),message.Debug("[flush] "+h),this.BuildReply(d,h,0),this.SendReply(0,e);break;case P9_TWALK:var C=function(t,i){var a=i.shift();a?(t=s.join(t,a),_.stat(t,function(s,_){r.shouldAbortRequest(h)||(s?(r.SendError(h,s),r.SendReply(0,e)):(s=formatQid(t,_),r.fids[I]=r.Createfid(t,FID_INODE,_.uid),w+=marshall.Marshall(["Q"],[s],r.replybuffer,w),O++,C(t,i)))})):(marshall.Marshall(["h"],[O],r.replybuffer,7),r.BuildReply(d,h,w-7),r.SendReply(0,e))};g=marshall.Unmarshall2(["w","w","h"],t),c=g[0];var I=g[1];if(a=g[2],message.Debug("[walk]: fid="+g[0]+" nwfid="+g[1]+" nwname="+a),0==a){r.fids[I]=r.Createfid(r.fids[c].path,FID_INODE,r.fids[c].uid),marshall.Marshall(["h"],[0],r.replybuffer,7),r.BuildReply(d,h,2),r.SendReply(0,e);break}for(o=[],u=0;u<a;u++)o.push("s");a=marshall.Unmarshall2(o,t),p=this.fids[c].path,w=9;var O=0;message.Debug("walk in dir "+p+" to: "+a.toString()),C(p,a);break;case P9_TCLUNK:g=marshall.Unmarshall2(["w"],t),c=g[0],p=r.fids[c].path,message.Debug("[clunk]: fid="+c+" path="+p),delete r.fids[c],this.BuildReply(d,h,0),this.SendReply(0,e);break;case P9_TXATTRCREATE:g=marshall.Unmarshall2(["w","s","d","w"],t),c=g[0],a=g[1],u=g[2],o=g[3],message.Debug("[txattrcreate]: fid="+c+" name="+a+" attr_size="+u+" flags="+o),this.BuildReply(d,h,0),this.SendReply(0,e);break;case P9_TXATTRWALK:g=marshall.Unmarshall2(["w","w","s"],t),c=g[0],o=g[1],a=g[2],message.Debug("[xattrwalk]: fid="+g[0]+" newfid="+g[1]+" name="+g[2]),this.fids[o]=this.Createfid(this.fids[c].inodeid,FID_NONE,this.fids[c].uid),u=0,"security.capability"==a&&(u=this.fs.PrepareCAPs(this.fids[c].inodeid),this.fids[o].type=FID_XATTR),marshall.Marshall(["d"],[u],this.replybuffer,7),this.BuildReply(d,h,8),this.SendReply(0,e);break;default:message.Debug("Error in Virtio9p: Unknown id "+d+" received"),message.Abort()}};var DEBUG=!1,LOG_TO_FILE=!1,LOG_ALL_IO=!1,LOG_PAGE_FAULTS=!1,LOG_LEVEL=LOG_ALL&LOG_9P,DEBUG_SCREEN_LAYERS=DEBUG&&!1,ENABLE_HPET=DEBUG&&!1,ENABLE_ACPI=!1,LOOP_COUNTER=11001,TIME_PER_FRAME=1,TSC_RATE=8192,APIC_TIMER_FREQ=TSC_RATE,VMWARE_HYPERVISOR_PORT=!0;function IO(e){this.ports=[],this.cpu=e;for(var t=0;65536>t;t++)this.ports[t]=this.create_empty_entry();var r=e.memory_size;for(t=0;t<<MMAP_BLOCK_BITS<r;t++)e.memory_map_read8[t]=e.memory_map_write8[t]=void 0,e.memory_map_read32[t]=e.memory_map_write32[t]=void 0;this.mmap_register(r,4294967296-r,function(e){return dbg_log("Read from unmapped memory space, addr="+h(e>>>0,8),LOG_IO),255},function(e,t){dbg_log("Write to unmapped memory space, addr="+h(e>>>0,8)+" value="+h(t,2),LOG_IO)},function(e){return dbg_log("Read from unmapped memory space, addr="+h(e>>>0,8),LOG_IO),-1},function(e,t){dbg_log("Write to unmapped memory space, addr="+h(e>>>0,8)+" value="+h(t>>>0,8),LOG_IO)})}IO.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}},IO.prototype.empty_port_read8=function(){return 255},IO.prototype.empty_port_read16=function(){return 65535},IO.prototype.empty_port_read32=function(){return-1},IO.prototype.empty_port_write=function(e){},IO.prototype.register_read=function(e,t,r,s,i){if(dbg_assert("number"==typeof e),dbg_assert("object"==typeof t),dbg_assert(!r||"function"==typeof r),dbg_assert(!s||"function"==typeof s),dbg_assert(!i||"function"==typeof i),dbg_assert(r||s||i),DEBUG){var _=function(r){return dbg_assert(!1,"Overlapped read"+r+" "+h(e,4)+" ("+t.name+")"),-1>>>32-r|0};r||(r=_.bind(this,8)),s||(s=_.bind(this,16)),i||(i=_.bind(this,32))}r&&(this.ports[e].read8=r),s&&(this.ports[e].read16=s),i&&(this.ports[e].read32=i),this.ports[e].device=t},IO.prototype.register_write=function(e,t,r,s,i){if(dbg_assert("number"==typeof e),dbg_assert("object"==typeof t),dbg_assert(!r||"function"==typeof r),dbg_assert(!s||"function"==typeof s),dbg_assert(!i||"function"==typeof i),dbg_assert(r||s||i),DEBUG){var _=function(r){dbg_assert(!1,"Overlapped write"+r+" "+h(e)+" ("+t.name+")")};r||(r=_.bind(this,8)),s||(s=_.bind(this,16)),i||(i=_.bind(this,32))}r&&(this.ports[e].write8=r),s&&(this.ports[e].write16=s),i&&(this.ports[e].write32=i),this.ports[e].device=t},IO.prototype.register_read_consecutive=function(e,t,r,s,i,_){function a(){return r.call(this)|s.call(this)<<8}dbg_assert(4===arguments.length||6===arguments.length),i&&_?(this.register_read(e,t,r,a,function(){return r.call(this)|s.call(this)<<8|i.call(this)<<16|_.call(this)<<24}),this.register_read(e+1,t,s),this.register_read(e+2,t,i,function(){return i.call(this)|_.call(this)<<8}),this.register_read(e+3,t,_)):(this.register_read(e,t,r,a),this.register_read(e+1,t,s))},IO.prototype.register_write_consecutive=function(e,t,r,s,i,_){function a(e){r.call(this,255&e),s.call(this,e>>8&255)}dbg_assert(4===arguments.length||6===arguments.length),i&&_?(this.register_write(e,t,r,a,function(e){r.call(this,255&e),s.call(this,e>>8&255),i.call(this,e>>16&255),_.call(this,e>>>24)}),this.register_write(e+1,t,s),this.register_write(e+2,t,i,function(e){i.call(this,255&e),_.call(this,e>>8&255)}),this.register_write(e+3,t,_)):(this.register_write(e,t,r,a),this.register_write(e+1,t,s))},IO.prototype.in_mmap_range=function(e,t){if((t=(e>>>=0)+(t>>>0))>=this.cpu.memory_size)return!0;for(e&=~(MMAP_BLOCK_SIZE-1);e<t;){if(this.cpu.in_mapped_range(e))return!0;e+=MMAP_BLOCK_SIZE}return!1},IO.prototype.mmap_read32_shim=function(e){var t=this.cpu.memory_map_read8[e>>>MMAP_BLOCK_BITS];return t(e)|t(e+1)<<8|t(e+2)<<16|t(e+3)<<24},IO.prototype.mmap_write32_shim=function(e,t){var r=this.cpu.memory_map_write8[e>>>MMAP_BLOCK_BITS];r(e,255&t),r(e+1,t>>8&255),r(e+2,t>>16&255),r(e+3,t>>>24)},IO.prototype.mmap_register=function(e,t,r,s,i,_){for(dbg_log("mmap_register addr="+h(e>>>0,8)+" size="+h(t,8),LOG_IO),dbg_assert(0==(e&MMAP_BLOCK_SIZE-1)),dbg_assert(t&&0==(t&MMAP_BLOCK_SIZE-1)),i||(i=this.mmap_read32_shim.bind(this)),_||(_=this.mmap_write32_shim.bind(this)),e>>>=MMAP_BLOCK_BITS;0<t;e++)this.cpu.memory_map_read8[e]=r,this.cpu.memory_map_write8[e]=s,this.cpu.memory_map_read32[e]=i,this.cpu.memory_map_write32[e]=_,t-=MMAP_BLOCK_SIZE},IO.prototype.port_write8=function(e,t){var r=this.ports[e];return(r.write8===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write8 port #"+h(e,4)+" <- "+h(t,2)+this.get_port_description(e),LOG_IO),r.write8.call(r.device,t)},IO.prototype.port_write16=function(e,t){var r=this.ports[e];return(r.write16===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write16 port #"+h(e,4)+" <- "+h(t,4)+this.get_port_description(e),LOG_IO),r.write16.call(r.device,t)},IO.prototype.port_write32=function(e,t){var r=this.ports[e];return(r.write32===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write32 port #"+h(e,4)+" <- "+h(t>>>0,8)+this.get_port_description(e),LOG_IO),r.write32.call(r.device,t)},IO.prototype.port_read8=function(e){var t=this.ports[e];return(t.read8===this.empty_port_read8||LOG_ALL_IO)&&dbg_log("read8 port  #"+h(e,4)+this.get_port_description(e),LOG_IO),dbg_assert(256>(t=t.read8.call(t.device)),"8 bit port returned large value: "+h(e)),t},IO.prototype.port_read16=function(e){var t=this.ports[e];return(t.read16===this.empty_port_read16||LOG_ALL_IO)&&dbg_log("read16 port  #"+h(e,4)+this.get_port_description(e),LOG_IO),dbg_assert(65536>(t=t.read16.call(t.device))&&0<=t,"16 bit port returned large value: "+h(e)),t},IO.prototype.port_read32=function(e){var t=this.ports[e];return(t.read32===this.empty_port_read32||LOG_ALL_IO)&&dbg_log("read32 port  #"+h(e,4)+this.get_port_description(e),LOG_IO),dbg_assert((0|(e=t.read32.call(t.device)))===e),e};var debug_port_list={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1000:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};function v86(e){this.stopped=this.running=!1,this.cpu=new CPU(e),this.bus=e,e.register("cpu-init",this.init,this),e.register("cpu-run",this.run,this),e.register("cpu-stop",this.stop,this),e.register("cpu-restart",this.restart,this),this.register_tick()}if(IO.prototype.get_port_description=function(e){return debug_port_list[e]?"  ("+debug_port_list[e]+")":""},v86.prototype.run=function(){this.running||(this.bus.send("emulator-started"),this.fast_next_tick())},v86.prototype.do_tick=function(){if(this.stopped)this.stopped=this.running=!1,this.bus.send("emulator-stopped");else{this.running=!0;var e=this.cpu.main_run();0>=e?this.fast_next_tick():this.next_tick(e)}},v86.prototype.stop=function(){this.running&&(this.stopped=!0)},v86.prototype.restart=function(){this.cpu.reset(),this.cpu.load_bios()},v86.prototype.init=function(e){this.cpu.init(e,this.bus),this.bus.send("emulator-ready")},"undefined"!=typeof setImmediate)var fast_next_tick=function(){var e=this;setImmediate(function(){e.do_tick()})},register_tick=function(){};else if("undefined"!=typeof window&&"undefined"!=typeof postMessage){var MAGIC_POST_MESSAGE=43605;fast_next_tick=function(){window.postMessage(MAGIC_POST_MESSAGE,"*")},register_tick=function(){var e=this;window.addEventListener("message",function(t){t.source===window&&t.data===MAGIC_POST_MESSAGE&&e.do_tick()},!1)}}else fast_next_tick=function(){var e=this;setTimeout(function(){e.do_tick()},0)},register_tick=function(){};v86.prototype.fast_next_tick=fast_next_tick,v86.prototype.register_tick=register_tick;var next_tick="undefined"!=typeof document&&"boolean"==typeof document.hidden?function(e){var t=this;4>e||document.hidden?this.fast_next_tick():setTimeout(function(){t.do_tick()},e)}:function(e){var t=this;setTimeout(function(){t.do_tick()},e)};v86.prototype.next_tick=next_tick,v86.prototype.save_state=function(){return this.cpu.save_state()},v86.prototype.restore_state=function(e){return this.cpu.restore_state(e)},v86.microtick="object"==typeof performance&&performance.now?function(){return performance.now()}:Date.now;var v86util=v86util||{};function h(e,t){return e=e?e.toString(16):"","0x"+v86util.pad0(e.toUpperCase(),t||1)}if(v86util.pads=function(e,t){for(e=e?e+"":"";e.length<t;)e+=" ";return e},v86util.pad0=function(e,t){for(e=e?e+"":"";e.length<t;)e="0"+e;return e},"undefined"!=typeof window&&window.crypto&&window.crypto.getRandomValues){var rand_data=new Int32Array(1);v86util.has_rand_int=function(){return!0},v86util.get_rand_int=function(){return window.crypto.getRandomValues(rand_data),rand_data[0]}}else v86util.has_rand_int=function(){return!1},v86util.get_rand_int=function(){console.assert(!1)};function SyncBuffer(e){this.buffer=e,this.byteLength=e.byteLength,this.onprogress=this.onload=void 0}function ByteQueue(e){var t,r,s=new Uint8Array(e);dbg_assert(0==(e&e-1)),this.length=0,this.push=function(t){this.length!==e&&this.length++,s[r]=t,r=r+1&e-1},this.shift=function(){if(this.length){var r=s[t];return t=t+1&e-1,this.length--,r}return-1},this.peek=function(){return this.length?s[t]:-1},this.clear=function(){this.length=r=t=0},this.clear()}function FloatQueue(e){this.size=e,this.data=new Float32Array(e),this.length=this.end=this.start=0,dbg_assert(0==(e&e-1))}function CircularQueue(e){this.data=[],this.index=0,this.size=e}function dump_file(e,t){e instanceof Array||(e=[e]),download(e=new Blob(e),t)}function download(e,t){var r=document.createElement("a");r.download=t,r.href=window.URL.createObjectURL(e),r.dataset.downloadurl=["application/octet-stream",r.download,r.href].join(":"),document.createEvent?((e=document.createEvent("MouseEvent")).initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(e)):r.click(),window.URL.revokeObjectURL(r.href)}SyncBuffer.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})},SyncBuffer.prototype.get=function(e,t,r){dbg_assert(e+t<=this.byteLength),r(new Uint8Array(this.buffer,e,t))},SyncBuffer.prototype.set=function(e,t,r){dbg_assert(e+t.byteLength<=this.byteLength),new Uint8Array(this.buffer,e,t.byteLength).set(t),r()},SyncBuffer.prototype.get_buffer=function(e){e(this.buffer)},function(){for(var e=new Int8Array(256),t=0,r=-2;256>t;t++)t&t-1||r++,e[t]=r;v86util.int_log2_byte=function(t){return dbg_assert(0<t),dbg_assert(256>t),e[t]},v86util.int_log2=function(t){dbg_assert(0<t);var r=t>>>16;if(r){var s=r>>>8;return s?24+e[s]:16+e[r]}return(s=t>>>8)?8+e[s]:e[t]}}(),FloatQueue.prototype.push=function(e){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=e,this.end=this.end+1&this.size-1},FloatQueue.prototype.shift=function(){if(this.length){var e=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,e}},FloatQueue.prototype.shift_block=function(e){var t=new Float32Array(e);e>this.length&&(e=this.length);var r=this.start+e,s=this.data.subarray(this.start,r);return t.set(s),r>=this.size&&(r-=this.size,t.set(this.data.subarray(0,r),s.length)),this.start=r,this.length-=e,t},FloatQueue.prototype.peek=function(){if(this.length)return this.data[this.start]},FloatQueue.prototype.clear=function(){this.length=this.end=this.start=0},CircularQueue.prototype.add=function(e){this.data[this.index]=e,this.index=(this.index+1)%this.size},CircularQueue.prototype.toArray=function(){return[].slice.call(this.data,this.index).concat([].slice.call(this.data,0,this.index))},CircularQueue.prototype.clear=function(){this.data=[],this.index=0},CircularQueue.prototype.set=function(e){this.data=e,this.index=0};var FPU_LOG_OP=!1,FPU_C0=256,FPU_C1=512,FPU_C2=1024,FPU_C3=16384,FPU_RESULT_FLAGS=FPU_C0|FPU_C1|FPU_C2|FPU_C3,FPU_STACK_TOP=14336,FPU_PC=768,FPU_RC=3072,FPU_IF=4096,FPU_EX_SF=64,FPU_EX_P=32,FPU_EX_U=16,FPU_EX_O=8,FPU_EX_Z=4,FPU_EX_D=2,FPU_EX_I=1,TWO_POW_63=0x8000000000000000;function FPU(e){this.cpu=e,this.st=new Float64Array(8),this.float32=new Float32Array(1),this.float32_byte=new Uint8Array(this.float32.buffer),this.float32_int=new Int32Array(this.float32.buffer),this.float64=new Float64Array(1),this.float64_byte=new Uint8Array(this.float64.buffer),this.float64_int=new Int32Array(this.float64.buffer),this.st8=new Uint8Array(this.st.buffer),this.st32=new Int32Array(this.st.buffer),this.stack_empty=255,this.stack_ptr=0,this.control_word=895,this.fpu_dp_selector=this.fpu_dp=this.fpu_opcode=this.fpu_ip_selector=this.fpu_ip=this.status_word=0,this.indefinite_nan=NaN,this.constants=new Float64Array([1,Math.log(10)/Math.LN2,Math.LOG2E,Math.PI,Math.log(2)/Math.LN10,Math.LN2,0])}function hex_dump(e,t){var r=[];t=t||e.byteLength;for(var s,i,_=0;_<t>>4;_++){s=h(_<<4,5)+"   ";for(var a=0;16>a;a++)s+=h(i=e[(_<<4)+a],2)+" ";for(s+="  ",a=0;16>a;a++)s+=33>(i=e[(_<<4)+a])||126<i?".":String.fromCharCode(i);r.push(s)}return"\n"+r.join("\n")}FPU.prototype.get_state=function(){var e=[];return e[0]=this.st,e[1]=this.stack_empty,e[2]=this.stack_ptr,e[3]=this.control_word,e[4]=this.fpu_dp_selector,e[5]=this.fpu_ip,e[6]=this.fpu_ip_selector,e[7]=this.fpu_dp,e[8]=this.fpu_dp_selector,e[9]=this.fpu_opcode,e},FPU.prototype.set_state=function(e){this.st.set(e[0]),this.stack_empty=e[1],this.stack_ptr=e[2],this.control_word=e[3],this.fpu_ip=e[5],this.fpu_ip_selector=e[6],this.fpu_dp=e[7],this.fpu_dp_selector=e[8],this.fpu_opcode=e[9]},FPU.prototype.fpu_unimpl=function(){if(dbg_trace(),DEBUG)throw"fpu: unimplemented";this.cpu.trigger_ud()},FPU.prototype.stack_fault=function(){this.status_word=this.status_word|FPU_EX_SF|FPU_EX_I},FPU.prototype.invalid_arithmatic=function(){this.status_word|=FPU_EX_I},FPU.prototype.fcom=function(e){var t=this.get_st0();this.status_word&=~FPU_RESULT_FLAGS,t>e||(this.status_word=e>t?this.status_word|FPU_C0:t===e?this.status_word|FPU_C3:this.status_word|FPU_C0|FPU_C2|FPU_C3)},FPU.prototype.fucom=function(e){this.fcom(e)},FPU.prototype.fcomi=function(e){var t=this.st[this.stack_ptr];this.cpu.flags_changed&=~(1|flag_parity|flag_zero),this.cpu.flags&=~(1|flag_parity|flag_zero),t>e||(this.cpu.flags=e>t?1|this.cpu.flags:t===e?this.cpu.flags|flag_zero:1|this.cpu.flags|flag_parity|flag_zero)},FPU.prototype.fucomi=function(e){this.fcomi(e)},FPU.prototype.ftst=function(e){this.status_word&=~FPU_RESULT_FLAGS,isNaN(e)?this.status_word=this.status_word|FPU_C3|FPU_C2|FPU_C0:0===e?this.status_word|=FPU_C3:0>e&&(this.status_word|=FPU_C0)},FPU.prototype.fxam=function(e){this.status_word&=~FPU_RESULT_FLAGS,this.status_word|=this.sign(0)<<9,this.stack_empty>>this.stack_ptr&1?this.status_word=this.status_word|FPU_C3|FPU_C0:isNaN(e)?this.status_word|=FPU_C0:this.status_word=0===e?this.status_word|FPU_C3:1/0===e||-1/0===e?this.status_word|FPU_C2|FPU_C0:this.status_word|FPU_C2},FPU.prototype.finit=function(){this.control_word=895,this.fpu_opcode=this.fpu_dp=this.fpu_ip=this.status_word=0,this.stack_empty=255,this.stack_ptr=0},FPU.prototype.load_status_word=function(){return-14337&this.status_word|this.stack_ptr<<11},FPU.prototype.set_status_word=function(e){this.status_word=-14337&e,this.stack_ptr=e>>11&7},FPU.prototype.load_tag_word=function(){for(var e,t=0,r=0;8>r;r++)e=this.st[r],this.stack_empty>>r&1?t|=3<<(r<<1):0===e?t|=1<<(r<<1):isFinite(e)||(t|=2<<(r<<1));return t},FPU.prototype.set_tag_word=function(e){for(var t=this.stack_empty=0;8>t;t++)this.stack_empty|=e>>t&e>>t+1&1<<t},FPU.prototype.fstenv=function(e){this.cpu.is_osize_32()?(this.cpu.writable_or_pagefault(e,26),this.cpu.safe_write16(e,this.control_word),this.cpu.safe_write16(e+4,this.load_status_word()),this.cpu.safe_write16(e+8,this.load_tag_word()),this.cpu.safe_write32(e+12,this.fpu_ip),this.cpu.safe_write16(e+16,this.fpu_ip_selector),this.cpu.safe_write16(e+18,this.fpu_opcode),this.cpu.safe_write32(e+20,this.fpu_dp),this.cpu.safe_write16(e+24,this.fpu_dp_selector)):this.fpu_unimpl()},FPU.prototype.fldenv=function(e){this.cpu.is_osize_32()?(this.control_word=this.cpu.safe_read16(e),this.set_status_word(this.cpu.safe_read16(e+4)),this.set_tag_word(this.cpu.safe_read16(e+8)),this.fpu_ip=this.cpu.safe_read32s(e+12),this.fpu_ip_selector=this.cpu.safe_read16(e+16),this.fpu_opcode=this.cpu.safe_read16(e+18),this.fpu_dp=this.cpu.safe_read32s(e+20),this.fpu_dp_selector=this.cpu.safe_read16(e+24)):this.fpu_unimpl()},FPU.prototype.fsave=function(e){this.cpu.writable_or_pagefault(e,108),this.fstenv(e),e+=28;for(var t=0;8>t;t++)this.store_m80(e,this.st[this.stack_ptr+t&7]),e+=10;this.finit()},FPU.prototype.frstor=function(e){this.fldenv(e),e+=28;for(var t=0;8>t;t++)this.st[t+this.stack_ptr&7]=this.load_m80(e),e+=10},FPU.prototype.fxtract=function(){this.float64[0]=this.get_st0();var e=((127&this.float64_byte[7])<<4|this.float64_byte[6]>>4)-1023;this.float64_byte[7]=63|128&this.float64_byte[7],this.float64_byte[6]|=240,this.st[this.stack_ptr]=e,this.push(this.float64[0])},FPU.prototype.integer_round=function(e){var t=this.control_word>>10&3;return 0===t?(.5==(t=Math.round(e))-e&&t%2&&t--,t):1===t||3===t&&0<e?Math.floor(e):Math.ceil(e)},FPU.prototype.truncate=function(e){return 0<e?Math.floor(e):Math.ceil(e)},FPU.prototype.push=function(e){this.stack_ptr=this.stack_ptr-1&7,this.stack_empty>>this.stack_ptr&1?(this.status_word&=~FPU_C1,this.stack_empty&=~(1<<this.stack_ptr),this.st[this.stack_ptr]=e):(this.status_word|=FPU_C1,this.stack_fault(),this.st[this.stack_ptr]=this.indefinite_nan)},FPU.prototype.pop=function(){this.stack_empty|=1<<this.stack_ptr,this.stack_ptr=this.stack_ptr+1&7},FPU.prototype.get_sti=function(e){return dbg_assert("number"==typeof e&&0<=e&&8>e),e=e+this.stack_ptr&7,this.stack_empty>>e&1?(this.status_word&=~FPU_C1,this.stack_fault(),this.indefinite_nan):this.st[e]},FPU.prototype.get_st0=function(){return this.stack_empty>>this.stack_ptr&1?(this.status_word&=~FPU_C1,this.stack_fault(),this.indefinite_nan):this.st[this.stack_ptr]},FPU.prototype.load_m80=function(e){var t=this.cpu.safe_read16(e+8),r=this.cpu.safe_read32s(e)>>>0,s=this.cpu.safe_read32s(e+4)>>>0;return e=t>>15,0===(t&=-32769)?0:32767>t?(r+=4294967296*s,e&&(r=-r),r*Math.pow(2,t-16383-63)):(this.float64_byte[7]=127|e<<7,this.float64_byte[6]=240|s>>30<<3&8,this.float64_byte[5]=0,this.float64_byte[4]=0,this.float64_int[0]=0,this.float64[0])},FPU.prototype.store_m80=function(e,t){this.float64[0]=t,t=128&this.float64_byte[7];var r=(127&this.float64_byte[7])<<4|this.float64_byte[6]>>4;if(2047===r){r=32767;var s=0,i=2147483648|(524288&this.float64_int[1])<<11}else 0===r?i=s=0:(r+=15360,s=this.float64_int[0]<<11,i=2147483648|(1048575&this.float64_int[1])<<11|this.float64_int[0]>>>21);dbg_assert(0<=r&&32768>r),this.cpu.safe_write32(e,s),this.cpu.safe_write32(e+4,i),this.cpu.safe_write16(e+8,t<<8|r)},FPU.prototype.load_m64=function(e){var t=this.cpu.safe_read32s(e);return e=this.cpu.safe_read32s(e+4),this.float64_int[0]=t,this.float64_int[1]=e,this.float64[0]},FPU.prototype.store_m64=function(e,t){this.cpu.writable_or_pagefault(e,8),this.float64[0]=this.get_sti(t),this.cpu.safe_write32(e,this.float64_int[0]),this.cpu.safe_write32(e+4,this.float64_int[1])},FPU.prototype.load_m32=function(e){return this.float32_int[0]=this.cpu.safe_read32s(e),this.float32[0]},FPU.prototype.store_m32=function(e,t){this.float32[0]=t,this.cpu.safe_write32(e,this.float32_int[0])},FPU.prototype.sign=function(e){return this.st8[(this.stack_ptr+e&7)<<3|7]>>7},FPU.prototype.dbg_log_fpu_op=function(e,t){FPU_LOG_OP&&dbg_log(192<=t?h(e,2)+" "+h(t,2)+"/"+(t>>3&7)+"/"+(7&t)+" @"+h(this.cpu.instruction_pointer>>>0,8)+" sp="+this.stack_ptr+" st="+h(this.stack_empty,2):h(e,2)+" /"+(t>>3&7)+"     @"+h(this.cpu.instruction_pointer>>>0,8)+" sp="+this.stack_ptr+" st="+h(this.stack_empty,2),LOG_FPU)},FPU.prototype.fwait=function(){},FPU.prototype.op_D8_reg=function(e){this.dbg_log_fpu_op(216,e);var t=e>>3&7;e=this.get_sti(7&e);var r=this.get_st0();switch(t){case 0:this.st[this.stack_ptr]=r+e;break;case 1:this.st[this.stack_ptr]=r*e;break;case 2:this.fcom(e);break;case 3:this.fcom(e),this.pop();break;case 4:this.st[this.stack_ptr]=r-e;break;case 5:this.st[this.stack_ptr]=e-r;break;case 6:this.st[this.stack_ptr]=r/e;break;case 7:this.st[this.stack_ptr]=e/r;break;default:dbg_assert(!1)}},FPU.prototype.op_D8_mem=function(e,t){this.dbg_log_fpu_op(216,e),e=e>>3&7,t=this.load_m32(t);var r=this.get_st0();switch(e){case 0:this.st[this.stack_ptr]=r+t;break;case 1:this.st[this.stack_ptr]=r*t;break;case 2:this.fcom(t);break;case 3:this.fcom(t),this.pop();break;case 4:this.st[this.stack_ptr]=r-t;break;case 5:this.st[this.stack_ptr]=t-r;break;case 6:this.st[this.stack_ptr]=r/t;break;case 7:this.st[this.stack_ptr]=t/r;break;default:dbg_assert(!1)}},FPU.prototype.op_D9_reg=function(e){this.dbg_log_fpu_op(217,e);var t=7&e;switch(e>>3&7){case 0:e=this.get_sti(t),this.push(e);break;case 1:e=this.get_sti(t),this.st[this.stack_ptr+t&7]=this.get_st0(),this.st[this.stack_ptr]=e;break;case 2:switch(t){case 0:break;default:dbg_log(t),this.fpu_unimpl()}break;case 3:this.fpu_unimpl();break;case 4:switch(e=this.get_st0(),t){case 0:this.st[this.stack_ptr]=-e;break;case 1:this.st[this.stack_ptr]=Math.abs(e);break;case 4:this.ftst(e);break;case 5:this.fxam(e);break;default:dbg_log(t),this.fpu_unimpl()}break;case 5:this.push(this.constants[t]);break;case 6:switch(e=this.get_st0(),t){case 0:this.st[this.stack_ptr]=Math.pow(2,e)-1;break;case 1:this.st[this.stack_ptr+1&7]=this.get_sti(1)*Math.log(e)/Math.LN2,this.pop();break;case 2:this.st[this.stack_ptr]=Math.tan(e),this.push(1);break;case 3:this.st[this.stack_ptr+1&7]=Math.atan2(this.get_sti(1),e),this.pop();break;case 4:this.fxtract();break;case 5:this.st[this.stack_ptr]=e%this.get_sti(1);break;case 6:this.stack_ptr=this.stack_ptr-1&7,this.status_word&=~FPU_C1;break;case 7:this.stack_ptr=this.stack_ptr+1&7,this.status_word&=~FPU_C1;break;default:dbg_assert(!1)}break;case 7:switch(e=this.get_st0(),t){case 0:t=this.get_sti(1);var r=Math.trunc(e/t);this.st[this.stack_ptr]=e%t,this.status_word&=~(FPU_C0|FPU_C1|FPU_C3),1&r&&(this.status_word|=FPU_C1),2&r&&(this.status_word|=FPU_C3),4&r&&(this.status_word|=FPU_C0),this.status_word&=~FPU_C2;break;case 1:this.st[this.stack_ptr+1&7]=this.get_sti(1)*Math.log(e+1)/Math.LN2,this.pop();break;case 2:this.st[this.stack_ptr]=Math.sqrt(e);break;case 3:this.st[this.stack_ptr]=Math.sin(e),this.push(Math.cos(e));break;case 4:this.st[this.stack_ptr]=this.integer_round(e);break;case 5:this.st[this.stack_ptr]=e*Math.pow(2,this.truncate(this.get_sti(1)));break;case 6:this.st[this.stack_ptr]=Math.sin(e);break;case 7:this.st[this.stack_ptr]=Math.cos(e);break;default:dbg_assert(!1)}break;default:dbg_assert(!1)}},FPU.prototype.op_D9_mem=function(e,t){switch(this.dbg_log_fpu_op(217,e),e>>3&7){case 0:e=this.load_m32(t),this.push(e);break;case 1:this.fpu_unimpl();break;case 2:this.store_m32(t,this.get_st0());break;case 3:this.store_m32(t,this.get_st0()),this.pop();break;case 4:this.fldenv(t);break;case 5:this.control_word=this.cpu.safe_read16(t);break;case 6:this.fstenv(t);break;case 7:this.cpu.safe_write16(t,this.control_word);break;default:dbg_assert(!1)}},FPU.prototype.op_DA_reg=function(e){this.dbg_log_fpu_op(218,e);var t=e>>3&7;switch(e&=7,t){case 0:this.cpu.test_b()&&(this.st[this.stack_ptr]=this.get_sti(e),this.stack_empty&=~(1<<this.stack_ptr));break;case 1:this.cpu.test_z()&&(this.st[this.stack_ptr]=this.get_sti(e),this.stack_empty&=~(1<<this.stack_ptr));break;case 2:this.cpu.test_be()&&(this.st[this.stack_ptr]=this.get_sti(e),this.stack_empty&=~(1<<this.stack_ptr));break;case 3:this.cpu.test_p()&&(this.st[this.stack_ptr]=this.get_sti(e),this.stack_empty&=~(1<<this.stack_ptr));break;case 5:1===e?(this.fucom(this.get_sti(1)),this.pop(),this.pop()):(dbg_log(t),this.fpu_unimpl());break;default:dbg_log(t),this.fpu_unimpl()}},FPU.prototype.op_DA_mem=function(e,t){this.dbg_log_fpu_op(218,e),e=e>>3&7,t=this.cpu.safe_read32s(t);var r=this.get_st0();switch(e){case 0:this.st[this.stack_ptr]=r+t;break;case 1:this.st[this.stack_ptr]=r*t;break;case 2:this.fcom(t);break;case 3:this.fcom(t),this.pop();break;case 4:this.st[this.stack_ptr]=r-t;break;case 5:this.st[this.stack_ptr]=t-r;break;case 6:this.st[this.stack_ptr]=r/t;break;case 7:this.st[this.stack_ptr]=t/r;break;default:dbg_assert(!1)}},FPU.prototype.op_DB_reg=function(e){this.dbg_log_fpu_op(219,e);var t=e>>3&7,r=7&e;switch(t){case 0:this.cpu.test_b()||(this.st[this.stack_ptr]=this.get_sti(r),this.stack_empty&=~(1<<this.stack_ptr));break;case 1:this.cpu.test_z()||(this.st[this.stack_ptr]=this.get_sti(r),this.stack_empty&=~(1<<this.stack_ptr));break;case 2:this.cpu.test_be()||(this.st[this.stack_ptr]=this.get_sti(r),this.stack_empty&=~(1<<this.stack_ptr));break;case 3:this.cpu.test_p()||(this.st[this.stack_ptr]=this.get_sti(r),this.stack_empty&=~(1<<this.stack_ptr));break;case 4:227===e?this.finit():228!==e&&225!==e&&(226===e?this.status_word=0:(dbg_log(h(e)),this.fpu_unimpl()));break;case 5:this.fucomi(this.get_sti(r));break;case 6:this.fcomi(this.get_sti(r));break;default:dbg_log(t),this.fpu_unimpl()}},FPU.prototype.op_DB_mem=function(e,t){switch(this.dbg_log_fpu_op(219,e),e=e>>3&7){case 0:t=this.cpu.safe_read32s(t),this.push(t);break;case 2:2147483647>=(e=this.integer_round(this.get_st0()))&&-2147483648<=e?this.cpu.safe_write32(t,e):(this.invalid_arithmatic(),this.cpu.safe_write32(t,-2147483648));break;case 3:2147483647>=(e=this.integer_round(this.get_st0()))&&-2147483648<=e?this.cpu.safe_write32(t,e):(this.invalid_arithmatic(),this.cpu.safe_write32(t,-2147483648)),this.pop();break;case 5:this.push(this.load_m80(t));break;case 7:this.cpu.writable_or_pagefault(t,10),this.store_m80(t,this.get_st0()),this.pop();break;default:dbg_log(e),this.fpu_unimpl()}},FPU.prototype.op_DC_reg=function(e){this.dbg_log_fpu_op(220,e);var t=e>>3&7,r=7&e;e=this.stack_ptr+r&7,r=this.get_sti(r);var s=this.get_st0();switch(t){case 0:this.st[e]=r+s;break;case 1:this.st[e]=r*s;break;case 2:this.fcom(r);break;case 3:this.fcom(r),this.pop();break;case 4:this.st[e]=s-r;break;case 5:this.st[e]=r-s;break;case 6:this.st[e]=s/r;break;case 7:this.st[e]=r/s;break;default:dbg_assert(!1)}},FPU.prototype.op_DC_mem=function(e,t){this.dbg_log_fpu_op(220,e),e=e>>3&7,t=this.load_m64(t);var r=this.get_st0();switch(e){case 0:this.st[this.stack_ptr]=r+t;break;case 1:this.st[this.stack_ptr]=r*t;break;case 2:this.fcom(t);break;case 3:this.fcom(t),this.pop();break;case 4:this.st[this.stack_ptr]=r-t;break;case 5:this.st[this.stack_ptr]=t-r;break;case 6:this.st[this.stack_ptr]=r/t;break;case 7:this.st[this.stack_ptr]=t/r;break;default:dbg_assert(!1)}},FPU.prototype.op_DD_reg=function(e){this.dbg_log_fpu_op(221,e);var t=e>>3&7;switch(e&=7,t){case 0:this.stack_empty|=1<<(this.stack_ptr+e&7);break;case 2:this.st[this.stack_ptr+e&7]=this.get_st0();break;case 3:0!==e&&(this.st[this.stack_ptr+e&7]=this.get_st0()),this.pop();break;case 4:this.fucom(this.get_sti(e));break;case 5:this.fucom(this.get_sti(e)),this.pop();break;default:dbg_log(t),this.fpu_unimpl()}},FPU.prototype.op_DD_mem=function(e,t){switch(this.dbg_log_fpu_op(221,e),e>>3&7){case 0:e=this.load_m64(t),this.push(e);break;case 1:this.fpu_unimpl();break;case 2:this.store_m64(t,0);break;case 3:this.store_m64(t,0),this.pop();break;case 4:this.frstor(t);break;case 5:this.fpu_unimpl();break;case 6:this.fsave(t);break;case 7:this.cpu.safe_write16(t,this.load_status_word());break;default:dbg_assert(!1)}},FPU.prototype.op_DE_reg=function(e){this.dbg_log_fpu_op(222,e);var t=e>>3&7;e&=7;var r=this.stack_ptr+e&7,s=this.get_sti(e),i=this.get_st0();switch(t){case 0:this.st[r]=s+i;break;case 1:this.st[r]=s*i;break;case 2:this.fcom(s);break;case 3:1===e?(this.fcom(this.st[r]),this.pop()):(dbg_log(t),this.fpu_unimpl());break;case 4:this.st[r]=i-s;break;case 5:this.st[r]=s-i;break;case 6:this.st[r]=i/s;break;case 7:this.st[r]=s/i;break;default:dbg_assert(!1)}this.pop()},FPU.prototype.op_DE_mem=function(e,t){this.dbg_log_fpu_op(222,e),e=e>>3&7,t=this.cpu.safe_read16(t)<<16>>16;var r=this.get_st0();switch(e){case 0:this.st[this.stack_ptr]=r+t;break;case 1:this.st[this.stack_ptr]=r*t;break;case 2:this.fcom(t);break;case 3:this.fcom(t),this.pop();break;case 4:this.st[this.stack_ptr]=r-t;break;case 5:this.st[this.stack_ptr]=t-r;break;case 6:this.st[this.stack_ptr]=r/t;break;case 7:this.st[this.stack_ptr]=t/r;break;default:dbg_assert(!1)}},FPU.prototype.op_DF_reg=function(e){this.dbg_log_fpu_op(223,e);var t=e>>3&7,r=7&e;switch(t){case 4:224===e?this.cpu.reg16[reg_ax]=this.load_status_word():(dbg_log(e),this.fpu_unimpl());break;case 5:this.fucomi(this.get_sti(r)),this.pop();break;case 6:this.fcomi(this.get_sti(r)),this.pop();break;default:dbg_log(t),this.fpu_unimpl()}},FPU.prototype.op_DF_mem=function(e,t){switch(this.dbg_log_fpu_op(223,e),e>>3&7){case 0:t=this.cpu.safe_read16(t)<<16>>16,this.push(t);break;case 1:this.fpu_unimpl();break;case 2:32767>=(e=this.integer_round(this.get_st0()))&&-32768<=e?this.cpu.safe_write16(t,e):(this.invalid_arithmatic(),this.cpu.safe_write16(t,32768));break;case 3:32767>=(e=this.integer_round(this.get_st0()))&&-32768<=e?this.cpu.safe_write16(t,e):(this.invalid_arithmatic(),this.cpu.safe_write16(t,32768)),this.pop();break;case 4:this.fpu_unimpl();break;case 5:e=this.cpu.safe_read32s(t)>>>0,t=this.cpu.safe_read32s(t+4),this.push(e+4294967296*t);break;case 6:this.fpu_unimpl();break;case 7:if(this.cpu.writable_or_pagefault(t,8),(e=this.integer_round(this.get_st0()))<TWO_POW_63&&e>=-TWO_POW_63){var r=0|e,s=e/4294967296|0;0===s&&0>e&&(s=-1)}else r=0,s=-2147483648,this.invalid_arithmatic();this.cpu.safe_write32(t,r),this.cpu.safe_write32(t+4,s),this.pop();break;default:dbg_assert(!1)}};var CDROM_SECTOR_SIZE=2048,HD_SECTOR_SIZE=512;function IDEDevice(e,t,r,s,i){this.master=new IDEInterface(this,e,t,r,s,0,i),this.slave=new IDEInterface(this,e,void 0,!1,s,1,i),this.current_interface=this.master,this.cpu=e,0===s?(this.ata_port=496,this.irq=14,this.pci_id=240):1===s?(this.ata_port=368,this.irq=15,this.pci_id=248):dbg_assert(!1,"IDE device with nr "+s+" ignored",LOG_DISK),this.ata_port_high=516|this.ata_port,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,255&this.ata_port|1,this.ata_port>>8,0,0,255&this.ata_port_high|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,255&this.master_port|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+s,this.device_control=2,e.io.register_read(7|this.ata_port,this,function(){return dbg_log("lower irq",LOG_DISK),this.cpu.device_lower_irq(this.irq),this.read_status()}),e.io.register_read(2|this.ata_port_high,this,this.read_status),e.io.register_write(2|this.ata_port_high,this,this.write_control),e.io.register_read(0|this.ata_port,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),e.io.register_read(1|this.ata_port,this,function(){return dbg_log("Read error: "+h(255&this.current_interface.error)+" slave="+(this.current_interface===this.slave),LOG_DISK),this.current_interface.error}),e.io.register_read(2|this.ata_port,this,function(){return dbg_log("Read bytecount: "+h(255&this.current_interface.bytecount),LOG_DISK),255&this.current_interface.bytecount}),e.io.register_read(3|this.ata_port,this,function(){return dbg_log("Read sector: "+h(255&this.current_interface.sector),LOG_DISK),255&this.current_interface.sector}),e.io.register_read(4|this.ata_port,this,function(){return dbg_log("Read 1F4: "+h(255&this.current_interface.cylinder_low),LOG_DISK),255&this.current_interface.cylinder_low}),e.io.register_read(5|this.ata_port,this,function(){return dbg_log("Read 1F5: "+h(255&this.current_interface.cylinder_high),LOG_DISK),255&this.current_interface.cylinder_high}),e.io.register_read(6|this.ata_port,this,function(){return dbg_log("Read 1F6",LOG_DISK),this.current_interface.drive_head}),e.io.register_write(0|this.ata_port,this,function(e){this.current_interface.write_data_port8(e)},function(e){this.current_interface.write_data_port16(e)},function(e){this.current_interface.write_data_port32(e)}),e.io.register_write(1|this.ata_port,this,function(e){dbg_log("1F1/lba_count: "+h(e),LOG_DISK),this.master.lba_count=65535&(this.master.lba_count<<8|e),this.slave.lba_count=65535&(this.slave.lba_count<<8|e)}),e.io.register_write(2|this.ata_port,this,function(e){dbg_log("1F2/bytecount: "+h(e),LOG_DISK),this.master.bytecount=65535&(this.master.bytecount<<8|e),this.slave.bytecount=65535&(this.slave.bytecount<<8|e)}),e.io.register_write(3|this.ata_port,this,function(e){dbg_log("1F3/sector: "+h(e),LOG_DISK),this.master.sector=65535&(this.master.sector<<8|e),this.slave.sector=65535&(this.slave.sector<<8|e)}),e.io.register_write(4|this.ata_port,this,function(e){dbg_log("1F4/sector low: "+h(e),LOG_DISK),this.master.cylinder_low=65535&(this.master.cylinder_low<<8|e),this.slave.cylinder_low=65535&(this.slave.cylinder_low<<8|e)}),e.io.register_write(5|this.ata_port,this,function(e){dbg_log("1F5/sector high: "+h(e),LOG_DISK),this.master.cylinder_high=65535&(this.master.cylinder_high<<8|e),this.slave.cylinder_high=65535&(this.slave.cylinder_high<<8|e)}),e.io.register_write(6|this.ata_port,this,function(e){var t=16&e;dbg_log("1F6/drive: "+h(e,2),LOG_DISK),t?(dbg_log("Slave",LOG_DISK),this.current_interface=this.slave):this.current_interface=this.master,this.master.drive_head=e,this.slave.drive_head=e,this.master.is_lba=this.slave.is_lba=e>>6&1,this.master.head=this.slave.head=15&e}),this.dma_command=this.dma_status=this.prdt_addr=0,e.io.register_write(7|this.ata_port,this,function(e){dbg_log("lower irq",LOG_DISK),this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(e)}),e.io.register_read(4|this.master_port,this,void 0,void 0,this.dma_read_addr),e.io.register_write(4|this.master_port,this,void 0,void 0,this.dma_set_addr),e.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),e.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),e.io.register_read(2|this.master_port,this,this.dma_read_status),e.io.register_write(2|this.master_port,this,this.dma_write_status),e.io.register_read(8|this.master_port,this,function(){return dbg_log("DMA read 0x8",LOG_DISK),0}),e.io.register_read(10|this.master_port,this,function(){return dbg_log("DMA read 0xA",LOG_DISK),0}),e.devices.pci.register_device(this),DEBUG&&Object.seal(this)}function IDEInterface(e,t,r,s,i,_,a){this.device=e,this.bus=a,this.nr=i,this.cpu=t,this.buffer=r,this.sector_size=s?CDROM_SECTOR_SIZE:HD_SECTOR_SIZE,this.is_atapi=s,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(0|this.sector_count)&&(dbg_log("Warning: Disk size not aligned with sector size",LOG_DISK),this.sector_count=Math.ceil(this.sector_count)),s?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(0|this.cylinder_count)&&(dbg_log("Warning: Rounding up cylinder count. Choose different head number",LOG_DISK),this.cylinder_count=Math.floor(this.cylinder_count)),(e=t.devices.rtc).cmos_write(CMOS_BIOS_DISKTRANSFLAG,e.cmos_read(CMOS_BIOS_DISKTRANSFLAG)|1<<4*this.nr),e.cmos_write(CMOS_DISK_DATA,15&e.cmos_read(CMOS_DISK_DATA)|240),t=CMOS_DISK_DRIVE1_CYL,e.cmos_write(t+0,255&this.cylinder_count),e.cmos_write(t+1,this.cylinder_count>>8&255),e.cmos_write(t+2,255&this.head_count),e.cmos_write(t+3,255),e.cmos_write(t+4,255),e.cmos_write(t+5,200),e.cmos_write(t+6,255&this.cylinder_count),e.cmos_write(t+7,this.cylinder_count>>8&255),e.cmos_write(t+8,255&this.sectors_per_track)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=r,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.write_dest=0,Object.seal(this)}IDEDevice.prototype.read_status=function(){if(this.current_interface.buffer){var e=this.current_interface.status;return dbg_log("ATA read status: "+h(e,2),LOG_DISK),e}return 0},IDEDevice.prototype.write_control=function(e){dbg_log("set device control: "+h(e,2)+" interrupts "+(2&e?"disabled":"enabled"),LOG_DISK),4&e&&(dbg_log("Reset via control port",LOG_DISK),this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=e},IDEDevice.prototype.dma_read_addr=function(){return dbg_log("dma get address: "+h(this.prdt_addr,8),LOG_DISK),this.prdt_addr},IDEDevice.prototype.dma_set_addr=function(e){dbg_log("dma set address: "+h(e,8),LOG_DISK),this.prdt_addr=e},IDEDevice.prototype.dma_read_status=function(){return dbg_log("DMA read status: "+h(this.dma_status),LOG_DISK),this.dma_status},IDEDevice.prototype.dma_write_status=function(e){dbg_log("DMA set status: "+h(e),LOG_DISK),this.dma_status&=~(6&e)},IDEDevice.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16},IDEDevice.prototype.dma_read_command8=function(){return dbg_log("DMA read command: "+h(this.dma_command),LOG_DISK),this.dma_command},IDEDevice.prototype.dma_write_command=function(e){dbg_log("DMA write command: "+h(e),LOG_DISK),this.dma_write_command8(255&e),this.dma_write_status(e>>16&255)},IDEDevice.prototype.dma_write_command8=function(e){dbg_log("DMA write command8: "+h(e),LOG_DISK);var t=this.dma_command;if(this.dma_command=9&e,(1&t)!=(1&e))if(0==(1&e))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:dbg_log("Spurious dma command write, current command: "+h(this.current_interface.current_command),LOG_DISK),dbg_assert(!1)}},IDEDevice.prototype.push_irq=function(){0==(2&this.device_control)&&(dbg_log("push irq",LOG_DISK),this.dma_status|=4,this.cpu.device_raise_irq(this.irq))},IDEDevice.prototype.get_state=function(){var e=[];return e[0]=this.master,e[1]=this.slave,e[2]=this.ata_port,e[3]=this.irq,e[4]=this.pci_id,e[5]=this.ata_port_high,e[6]=this.master_port,e[7]=this.name,e[8]=this.device_control,e[9]=this.prdt_addr,e[10]=this.dma_status,e[11]=this.current_interface===this.master,e[12]=this.dma_command,e},IDEDevice.prototype.set_state=function(e){this.master=e[0],this.slave=e[1],this.ata_port=e[2],this.irq=e[3],this.pci_id=e[4],this.ata_port_high=e[5],this.master_port=e[6],this.name=e[7],this.device_control=e[8],this.prdt_addr=e[9],this.dma_status=e[10],this.current_interface=e[11]?this.master:this.slave,this.dma_command=e[12]},IDEInterface.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0)},IDEInterface.prototype.push_irq=function(){this.device.push_irq()},IDEInterface.prototype.ata_command=function(e){if(dbg_log("ATA Command: "+h(e)+" slave="+(this.drive_head>>4&1),LOG_DISK),this.buffer)switch(this.current_command=e,this.error=0,e){case 8:dbg_log("ATA device reset",LOG_DISK),this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,e=this.sector_count-1,this.sector=255&e,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.drive_head=240&this.drive_head|e>>24&15,this.push_irq();break;case 39:this.status=80,e=this.sector_count-1,this.sector=255&e,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.sector|=e>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(e);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(e);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:dbg_log("ATA identify packet device",LOG_DISK),this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:dbg_log("Logical sectors per DRQ Block: "+h(255&this.bytecount),LOG_DISK),this.sectors_per_drq=255&this.bytecount,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(e);break;case 53:case 202:this.ata_write_sectors_dma(e);break;case 64:dbg_log("read verify sectors",LOG_DISK),this.status=80,this.push_irq();break;case 218:dbg_log("Unimplemented: get media status",LOG_DISK),this.status=65,this.error=4,this.push_irq();break;case 224:dbg_log("ATA standby immediate",LOG_DISK),this.status=80,this.push_irq();break;case 225:dbg_log("ATA idle immediate",LOG_DISK),this.status=80,this.push_irq();break;case 231:dbg_log("ATA flush cache",LOG_DISK),this.status=80,this.push_irq();break;case 236:if(dbg_log("ATA identify device",LOG_DISK),this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 234:dbg_log("flush cache ext",LOG_DISK),this.status=80,this.push_irq();break;case 239:dbg_log("set features: "+h(255&this.bytecount),LOG_DISK),this.status=80,this.push_irq();break;case 245:dbg_log("security freeze lock",LOG_DISK),this.status=80,this.push_irq();break;case 249:dbg_log("Unimplemented: set max address",LOG_DISK),this.status=65,this.error=4;break;default:dbg_assert(!1,"New ATA cmd on 1F7: "+h(e),LOG_DISK),this.status=65,this.error=4}else dbg_log("abort: No buffer",LOG_DISK),this.error=4,this.status=65,this.push_irq()},IDEInterface.prototype.atapi_handle=function(){switch(dbg_log("ATAPI Command: "+h(this.data[0])+" slave="+(this.drive_head>>4&1),LOG_DISK),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:dbg_log("test unit ready",LOG_DISK),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var e=this.data[4];this.status=88,dbg_log("inquiry: "+h(this.data[1],2)+" length="+e,LOG_DISK),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,e);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 30:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 37:e=this.sector_count-1,this.data_set(new Uint8Array([e>>24&255,e>>16&255,e>>8&255,255&e,0,0,this.sector_size>>8&255,255&this.sector_size])),this.data_end=this.data_length,this.status=88;break;case 40:1&this.lba_count?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:e=this.data[8],this.data_allocate(Math.min(8,e)),this.data_end=this.data_length,dbg_log("read q subcode: length="+e,LOG_DISK),this.status=88;break;case 67:e=this.data[8]|this.data[7]<<8;var t=this.data[9]>>6;this.data_allocate(e),this.data_end=this.data_length,dbg_log("read toc: "+h(t,2)+" length="+e+" "+(2&this.data[1])+" "+h(this.data[6]),LOG_DISK),0===t?(e=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,e>>24,e>>16&255,e>>8&255,255&e]))):1===t?this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])):dbg_assert(!1,"Unimplemented format: "+t),this.status=88;break;case 70:e=this.data[8]|this.data[7]<<8,e=Math.min(e,32),this.data_allocate(e),this.data_end=this.data_length,this.data[0]=e-4>>24&255,this.data[1]=e-4>>16&255,this.data[2]=e-4>>8&255,this.data[3]=e-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 82:dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK),this.status=81,this.data_length=0,this.error=80;break;case 90:e=this.data[8]|this.data[7]<<8,t=this.data[2],dbg_log("mode sense: "+h(t)+" length="+e,LOG_DISK),42===t&&this.data_allocate(Math.min(30,e)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:this.status=81,this.data_length=0,this.error=80,dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK);break;default:this.status=81,this.data_length=0,this.error=80,dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK),dbg_assert(!1)}this.bytecount=-8&this.bytecount|2,0==(128&this.status)&&this.push_irq(),0==(128&this.status)&&0===this.data_length&&(this.bytecount|=1,this.status&=-9)},IDEInterface.prototype.do_write=function(){this.status=80,dbg_assert(this.data_length<=this.data.length);var e=this.data.subarray(0,this.data_length);dbg_assert(0==this.data_length%512),this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,e,function(){}),this.report_write(this.data_length)},IDEInterface.prototype.atapi_read=function(e){var t=this,r=e[2]<<24|e[3]<<16|e[4]<<8|e[5],s=e[7]<<8|e[8];e=e[1];var i=s*this.sector_size,_=r*this.sector_size;dbg_log("CD read lba="+h(r)+" lbacount="+h(s)+" bytecount="+h(i)+" flags="+h(e),LOG_DISK),this.data_length=0;var a=this.cylinder_high<<8&65280|255&this.cylinder_low;dbg_log(h(this.cylinder_high,2)+" "+h(this.cylinder_low,2),LOG_DISK),this.cylinder_low=this.cylinder_high=0,65535===a&&a--,a>i&&(a=i),_>=this.buffer.byteLength?(dbg_assert(!1,"CD read: Outside of disk  end="+h(_+i)+" size="+h(this.buffer.byteLength),LOG_DISK),this.status=255,this.push_irq()):0===i?(this.status=80,this.data_pointer=0):(i=Math.min(i,this.buffer.byteLength-_),this.status=208,this.report_read_start(),this.buffer.get(_,i,function(e){dbg_log("cd read: data arrived",LOG_DISK),t.data_set(e),t.status=88,t.bytecount=-8&t.bytecount|2,t.push_irq(),a&=-4,t.data_end=a,t.data_end>t.data_length&&(t.data_end=t.data_length),t.cylinder_low=255&t.data_end,t.cylinder_high=t.data_end>>8&255,t.report_read_end(i)}))},IDEInterface.prototype.atapi_read_dma=function(e){var t=this,r=e[2]<<24|e[3]<<16|e[4]<<8|e[5],s=e[7]<<8|e[8];e=e[1];var i=s*this.sector_size,_=r*this.sector_size;dbg_log("CD read DMA lba="+h(r)+" lbacount="+h(s)+" bytecount="+h(i)+" flags="+h(e),LOG_DISK),_>=this.buffer.byteLength?(dbg_assert(!1,"CD read: Outside of disk  end="+h(_+i)+" size="+h(this.buffer.byteLength),LOG_DISK),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.buffer.get(_,i,function(e){dbg_log("atapi_read_dma: Data arrived"),t.report_read_end(i),t.status=88,t.bytecount=-8&t.bytecount|2,t.data_set(e),t.do_atapi_dma()}))},IDEInterface.prototype.do_atapi_dma=function(){if(0==(1&this.device.dma_status))dbg_log("do_atapi_dma: Status not set",LOG_DISK);else if(0==(8&this.status))dbg_log("do_atapi_dma: DRQ not set",LOG_DISK);else{dbg_log("atapi dma transfer len="+this.data_length,LOG_DISK);var e=this.device.prdt_addr,t=0,r=this.data;do{var s=this.cpu.read32s(e),i=this.cpu.read16(e+4),_=128&this.cpu.read8(e+7);if(i||(i=65536),dbg_log("dma read dest="+h(s)+" count="+h(i)+" datalen="+h(this.data_length),LOG_DISK),this.cpu.write_blob(r.subarray(t,Math.min(t+i,this.data_length)),s),e+=8,(t+=i)>=this.data_length&&!_){dbg_log("leave early end="+ +_+" offset="+h(t)+" data_length="+h(this.data_length)+" cmd="+h(this.current_command),LOG_DISK);break}}while(!_);dbg_log("end offset="+t,LOG_DISK),this.status=80,this.device.dma_status&=-2,this.bytecount=-8&this.bytecount|3,this.push_irq()}},IDEInterface.prototype.read_data=function(e){if(this.data_pointer<this.data_end){dbg_assert(this.data_pointer+e-1<this.data_end),dbg_assert(0==this.data_pointer%e,h(this.data_pointer)+" "+e);var t=1===e?this.data[this.data_pointer]:2===e?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=e,0==(this.data_pointer&(0==(4095&this.data_end)?4095:255))&&dbg_log("Read 1F0: "+h(this.data[this.data_pointer],2)+" cur="+h(this.data_pointer)+" cnt="+h(this.data_length),LOG_DISK),this.data_pointer>=this.data_end&&this.read_end(),t}return dbg_log("Read 1F0: empty",LOG_DISK),this.data_pointer+=e,0},IDEInterface.prototype.read_end=function(){if(dbg_log("read_end cmd="+h(this.current_command)+" data_pointer="+h(this.data_pointer)+" end="+h(this.data_end)+" length="+h(this.data_length),LOG_DISK),160===this.current_command)if(this.data_end===this.data_length)this.status=80,this.bytecount=-8&this.bytecount|3,this.push_irq();else{this.status=88,this.bytecount=-8&this.bytecount|2,this.push_irq();var e=this.cylinder_high<<8&65280|255&this.cylinder_low;this.data_end+e>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=e,dbg_log("data_end="+h(this.data_end),LOG_DISK)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(196===this.current_command||41===this.current_command?dbg_assert(0==(e=Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512))%1):(dbg_assert(32===this.current_command||36===this.current_command),e=1),this.ata_advance(this.current_command,e),this.data_end+=512*e,this.status=88),this.push_irq()},IDEInterface.prototype.write_data_port=function(e,t){dbg_assert(0==this.data_pointer%t),this.data_pointer>=this.data_end?dbg_log("Redundant write to data port: "+h(e)+" count="+h(this.data_end)+" cur="+h(this.data_pointer),LOG_DISK):((0==(this.data_pointer+t&(0==(4095&this.data_end)?4095:255))||20>this.data_end)&&dbg_log("Data port: "+h(e>>>0)+" count="+h(this.data_end)+" cur="+h(this.data_pointer),LOG_DISK),1===t?this.data[this.data_pointer++]=e:2===t?(this.data16[this.data_pointer>>>1]=e,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=e,this.data_pointer+=4),dbg_assert(this.data_pointer<=this.data_end),this.data_pointer===this.data_end&&this.write_end())},IDEInterface.prototype.write_data_port8=function(e){this.write_data_port(e,1)},IDEInterface.prototype.write_data_port16=function(e){this.write_data_port(e,2)},IDEInterface.prototype.write_data_port32=function(e){this.write_data_port(e,4)},IDEInterface.prototype.write_end=function(){160===this.current_command?this.atapi_handle():(dbg_log("write_end data_pointer="+h(this.data_pointer)+" data_length="+h(this.data_length),LOG_DISK),this.data_pointer>=this.data_length?this.do_write():(dbg_assert(48===this.current_command||52===this.current_command),this.status=88,this.data_end+=512,this.push_irq()))},IDEInterface.prototype.ata_advance=function(e,t){dbg_log("Advance sectors="+t+" old_bytecount="+this.bytecount,LOG_DISK),this.bytecount-=t,36===e||41===e||52===e||57===e||37===e||53===e?(e=t+this.get_lba48(),this.sector=255&e|e>>16&65280,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255):this.is_lba?(e=t+this.get_lba28(),this.sector=255&e,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.head=-16&this.head|15&e):(t=(e=t+this.get_chs())/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=255&t,this.cylinder_high=t>>8&255,this.head=(e/this.sectors_per_track|0)%this.head_count&15,this.sector=e%this.sectors_per_track+1&255,dbg_assert(e===this.get_chs()))},IDEInterface.prototype.ata_read_sectors=function(e){var t=this,r=36===e||41===e,s=this.get_count(r);r=this.get_lba(r);var i=32===e||36===e,_=s*this.sector_size,a=r*this.sector_size;dbg_log("ATA read cmd="+h(e)+" mode="+(this.is_lba?"lba":"chs")+" lba="+h(r)+" lbacount="+h(s)+" bytecount="+h(_),LOG_DISK),a+_>this.buffer.byteLength?(dbg_assert(!1,"ATA read: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.buffer.get(a,_,function(r){dbg_log("ata_read: Data arrived",LOG_DISK),t.data_set(r),t.status=88,t.data_end=i?512:Math.min(_,512*t.sectors_per_drq),t.ata_advance(e,i?1:Math.min(s,t.sectors_per_track)),t.push_irq(),t.report_read_end(_)}))},IDEInterface.prototype.ata_read_sectors_dma=function(e){var t=37===e;e=this.get_count(t),t=this.get_lba(t);var r=e*this.sector_size,s=t*this.sector_size;dbg_log("ATA DMA read lba="+h(t)+" lbacount="+h(e)+" bytecount="+h(r),LOG_DISK),s+r>this.buffer.byteLength?(dbg_assert(!1,"ATA read: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},IDEInterface.prototype.do_ata_read_sectors_dma=function(){var e=this,t=37===this.current_command,r=this.get_count(t);t=this.get_lba(t);var s=r*this.sector_size,i=t*this.sector_size;dbg_assert(t<this.buffer.byteLength),this.report_read_start();var _=this.device.prdt_addr;this.buffer.get(i,s,function(t){dbg_log("do_ata_read_sectors_dma: Data arrived",LOG_DISK);var i=e.device.prdt_addr,a=0;dbg_assert(_===i);do{var o=e.cpu.read32s(i),n=e.cpu.read16(i+4),d=128&e.cpu.read8(i+7);n||(n=65536,dbg_log("dma: prd count was 0",LOG_DISK)),dbg_log("dma read transfer dest="+h(o)+" prd_count="+h(n),LOG_DISK),e.cpu.write_blob(t.subarray(a,a+n),o),a+=n,i+=8}while(!d);dbg_assert(a===s),e.ata_advance(e.current_command,r),e.status=80,e.device.dma_status&=-2,e.current_command=-1,e.push_irq(),e.report_read_end(s)})},IDEInterface.prototype.ata_write_sectors=function(e){var t=52===e||57===e,r=this.get_count(t);t=this.get_lba(t),e=48===e||52===e;var s=r*this.sector_size,i=t*this.sector_size;dbg_log("ATA write lba="+h(t)+" mode="+(this.is_lba?"lba":"chs")+" lbacount="+h(r)+" bytecount="+h(s),LOG_DISK),i+s>this.buffer.byteLength?(dbg_assert(!1,"ATA write: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(s),this.data_end=e?512:Math.min(s,512*this.sectors_per_drq),this.write_dest=i)},IDEInterface.prototype.ata_write_sectors_dma=function(e){var t=53===e;e=this.get_count(t),t=this.get_lba(t);var r=e*this.sector_size,s=t*this.sector_size;dbg_log("ATA DMA write lba="+h(t)+" lbacount="+h(e)+" bytecount="+h(r),LOG_DISK),s+r>this.buffer.byteLength?(dbg_assert(!1,"ATA DMA write: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},IDEInterface.prototype.do_ata_write_sectors_dma=function(){var e=53===this.current_command,t=this.get_count(e),r=this.get_lba(e);e=t*this.sector_size,r*=this.sector_size;var s=this.device.prdt_addr,i=0,_=0,a=0;dbg_log("prdt addr: "+h(s,8),LOG_DISK);do{var o=this.cpu.read32s(s),n=this.cpu.read16(s+4),d=128&this.cpu.read8(s+7);n||(n=65536,dbg_log("dma: prd count was 0",LOG_DISK)),dbg_log("dma write transfer dest="+h(o)+" prd_count="+h(n),LOG_DISK),dbg_assert((o=this.cpu.mem8.subarray(o,o+n)).length===n),this.buffer.set(r+a,o,function(){_++}),a+=n,s+=8,i++}while(!d);_===i?(dbg_log("dma write completed",LOG_DISK),this.ata_advance(this.current_command,t),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1):dbg_assert(!1,"dma write not completed",LOG_DISK),this.report_write(e)},IDEInterface.prototype.get_chs=function(){var e=255&this.cylinder_low|this.cylinder_high<<8&65280,t=this.head,r=255&this.sector;return dbg_log("get_chs: c="+e+" h="+t+" s="+r,LOG_DISK),(e*this.head_count+t)*this.sectors_per_track+r-1},IDEInterface.prototype.get_lba28=function(){return 255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(15&this.head)<<24},IDEInterface.prototype.get_lba48=function(){return(255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0},IDEInterface.prototype.get_lba=function(e){return e?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()},IDEInterface.prototype.get_count=function(e){return e?0===(e=this.bytecount)&&(e=65536):0===(e=255&this.bytecount)&&(e=256),e},IDEInterface.prototype.create_identify_packet=function(){if(16&this.drive_head)this.data_allocate(0);else{for(var e=0;512>e;e++)this.data[e]=0;e=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,e,e>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,e,e>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,160===this.current_command?0:7,160===this.current_command?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}},IDEInterface.prototype.data_allocate=function(e){this.data_allocate_noclear(e);for(var t=0;t<e+3>>2;t++)this.data32[t]=0},IDEInterface.prototype.data_allocate_noclear=function(e){this.data.length<e&&(this.data=new Uint8Array(e+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=e,this.data_pointer=0},IDEInterface.prototype.data_set=function(e){this.data_allocate_noclear(e.length),this.data.set(e)},IDEInterface.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")},IDEInterface.prototype.report_read_end=function(e){this.stats.loading=!1;var t=e/this.sector_size|0;this.stats.sectors_read+=t,this.stats.bytes_read+=e,this.bus.send("ide-read-end",[this.nr,e,t])},IDEInterface.prototype.report_write=function(e){var t=e/this.sector_size|0;this.stats.sectors_written+=t,this.stats.bytes_written+=e,this.bus.send("ide-write-end",[this.nr,e,t])},IDEInterface.prototype.get_state=function(){var e=[];return e[0]=this.bytecount,e[1]=this.cylinder_count,e[2]=this.cylinder_high,e[3]=this.cylinder_low,e[4]=this.data_pointer,e[5]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=this.drive_head,e[10]=this.error,e[11]=this.head,e[12]=this.head_count,e[13]=this.is_atapi,e[14]=this.is_lba,e[15]=this.lba_count,e[16]=this.data,e[17]=this.data_length,e[18]=this.sector,e[19]=this.sector_count,e[20]=this.sector_size,e[21]=this.sectors_per_drq,e[22]=this.sectors_per_track,e[23]=this.status,e[24]=this.write_dest,e[25]=this.current_command,e[26]=this.data_end,e[27]=this.current_atapi_command,e},IDEInterface.prototype.set_state=function(e){this.bytecount=e[0],this.cylinder_count=e[1],this.cylinder_high=e[2],this.cylinder_low=e[3],this.data_pointer=e[4],this.drive_head=e[9],this.error=e[10],this.head=e[11],this.head_count=e[12],this.is_atapi=e[13],this.is_lba=e[14],this.lba_count=e[15],this.data=e[16],this.data_length=e[17],this.sector=e[18],this.sector_count=e[19],this.sector_size=e[20],this.sectors_per_drq=e[21],this.sectors_per_track=e[22],this.status=e[23],this.write_dest=e[24],this.current_command=e[25],this.data_end=e[26],this.current_atapi_command=e[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)};var PCI_CONFIG_ADDRESS=3320,PCI_CONFIG_DATA=3324;function PCI(e){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=e;for(var t=0;256>t;t++)this.device_spaces[t]=void 0,this.devices[t]=void 0;this.io=e.io,e.io.register_write(PCI_CONFIG_DATA,this,function(e){this.pci_write8(this.pci_addr32[0],e)},function(e){this.pci_write16(this.pci_addr32[0],e)},function(e){this.pci_write32(this.pci_addr32[0],e)}),e.io.register_write(PCI_CONFIG_DATA+1,this,function(e){this.pci_write8(this.pci_addr32[0]+1|0,e)}),e.io.register_write(PCI_CONFIG_DATA+2,this,function(e){this.pci_write8(this.pci_addr32[0]+2|0,e)},function(e){this.pci_write16(this.pci_addr32[0]+2|0,e)}),e.io.register_write(PCI_CONFIG_DATA+3,this,function(e){this.pci_write8(this.pci_addr32[0]+3|0,e)}),e.io.register_read_consecutive(PCI_CONFIG_DATA,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),e.io.register_read_consecutive(PCI_CONFIG_ADDRESS,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),e.io.register_write_consecutive(PCI_CONFIG_ADDRESS,this,function(e){this.pci_addr[0]=252&e},function(e){this.pci_addr[1]=e},function(e){this.pci_addr[2]=e},function(e){this.pci_addr[3]=e,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}function FloppyController(e,t,r){if(this.io=e.io,this.cpu=e,this.dma=e.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.floppy_size=this.response_length=this.response_index=0,this.fda_image=t,this.fdb_image=r,this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=0,this.last_sector=1,this.dor=0,t){if(this.floppy_size=t.byteLength,!(r={160:{type:1,tracks:40,sectors:8,heads:1},180:{type:1,tracks:40,sectors:9,heads:1},200:{type:1,tracks:40,sectors:10,heads:1},320:{type:1,tracks:40,sectors:8,heads:2},360:{type:1,tracks:40,sectors:9,heads:2},400:{type:1,tracks:40,sectors:10,heads:2},720:{type:3,tracks:80,sectors:9,heads:2},1200:{type:2,tracks:80,sectors:15,heads:2},1440:{type:4,tracks:80,sectors:18,heads:2},1722:{type:5,tracks:82,sectors:21,heads:2},2880:{type:5,tracks:80,sectors:36,heads:2}}[this.floppy_size>>10])||0!=(1023&this.floppy_size))throw"Unknown floppy size: "+h(t.byteLength);e.devices.rtc.cmos_write(CMOS_FLOPPY_DRIVE_TYPE,r.type<<4),e=r.sectors,t=r.heads,r=r.tracks,this.sectors_per_track=e,this.number_of_heads=t,this.number_of_cylinders=r}else e.devices.rtc.cmos_write(CMOS_FLOPPY_DRIVE_TYPE,64),this.floppy_size=this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0;this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1013,this,this.port3F5_write)}PCI.prototype.get_state=function(){for(var e=[],t=0;256>t;t++)e[t]=this.device_spaces[t];return e[256]=this.pci_addr,e[257]=this.pci_value,e[258]=this.pci_response,e[259]=this.pci_status,e},PCI.prototype.set_state=function(e){for(var t=0;256>t;t++){var r=this.devices[t],s=e[t];if(r&&s){for(var i=0;i<r.pci_bars.length;i++){var _=s[4+i];if(1&_){var a=r.pci_bars[i];this.set_io_bars(a,65534&a.original_bar,65534&_)}}this.device_spaces[t].set(s)}else r&&dbg_log("Warning: While restoring PCI device: Device exists in current configuration but not in snapshot ("+r.name+")"),s&&dbg_log("Warning: While restoring PCI device: Device doesn't exist in current configuration but does in snapshot (device "+h(t,2)+")")}this.pci_addr.set(e[256]),this.pci_value.set(e[257]),this.pci_response.set(e[258]),this.pci_status.set(e[259])},PCI.prototype.pci_query=function(){var e=this.pci_addr[2]<<8|this.pci_addr[1],t=252&this.pci_addr[0],r=e>>3&31,s="query enabled="+(this.pci_addr[3]>>7)+" bdf="+h(e,4);s+=" dev="+h(r,2),s+=" addr="+h(t,2),void 0!==(r=this.device_spaces[e])?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=t<r.byteLength?r[t>>2]:0,s+=" "+h(this.pci_addr32[0]>>>0,8)+" -> "+h(this.pci_response32[0]>>>0,8),t>=r.byteLength&&(s+=" (undef)"),s+=" ("+this.devices[e].name+")",dbg_log(s,LOG_PCI)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)},PCI.prototype.pci_write8=function(e,t){var r=e>>8&65535;e&=255;var s=new Uint8Array(this.device_spaces[r].buffer),i=this.devices[r];s&&(dbg_assert(!(16<=e&&44>e||48<=e&&52>e),"PCI: Expected 32-bit write"),dbg_log("PCI write8 dev="+h(r>>3,2)+" ("+i.name+") addr="+h(e,4)+" value="+h(t,2),LOG_PCI),s[e]=t)},PCI.prototype.pci_write16=function(e,t){dbg_assert(0==(1&e));var r=e>>8&65535;e&=255;var s=new Uint16Array(this.device_spaces[r].buffer),i=this.devices[r];s&&(dbg_assert(!(16<=e&&44>e||48<=e&&52>e),"PCI: Expected 32-bit write"),dbg_log("PCI writ16 dev="+h(r>>3,2)+" ("+i.name+") addr="+h(e,4)+" value="+h(t,4),LOG_PCI),s[e>>>1]=t)},PCI.prototype.pci_write32=function(e,t){dbg_assert(0==(3&e));var r=e>>8&65535;e&=255;var s=this.device_spaces[r],i=this.devices[r];if(s)if(16<=e&&40>e){var _=e-16>>2,a=i.pci_bars[_];dbg_log("BAR"+_+" exists="+(a?"y":"n")+" changed to "+h(t>>>0)+" dev="+h(r>>3,2)+" ("+i.name+") ",LOG_PCI),a?(dbg_assert(!(a.size&a.size-1),"bar size should be power of 2"),i=1&s[r=e>>2],-1==(3|t|a.size-1)?(t=~(a.size-1)|i,0===i&&(s[r]=t)):0===i&&((-16&t)!=(-16&(_=a.original_bar))&&dbg_log("Warning: Changing memory bar not supported, ignored",LOG_PCI),s[r]=_),1===i&&(dbg_assert(1===i),i=65534&s[r],_=65534&t,dbg_log("io bar changed from "+h(i>>>0,8)+" to "+h(_>>>0,8)+" size="+a.size,LOG_PCI),this.set_io_bars(a,i,_),s[r]=1|t)):s[e>>2]=0,dbg_log("BAR effective value: "+h(s[e>>2]>>>0),LOG_PCI)}else 48===e?(dbg_log("PCI write rom address dev="+h(r>>3,2)+" ("+i.name+") value="+h(t>>>0,8),LOG_PCI),s[e>>2]=i.pci_rom_size?-1==(2047|t)?0|-i.pci_rom_size:0|i.pci_rom_address:0):(dbg_log("PCI write dev="+h(r>>3,2)+" ("+i.name+") addr="+h(e,4)+" value="+h(t>>>0,8),LOG_PCI),s[e>>>2]=t)},PCI.prototype.register_device=function(e){dbg_assert(void 0!==e.pci_id),dbg_assert(void 0!==e.pci_space),dbg_assert(void 0!==e.pci_bars);var t=e.pci_id;dbg_log("PCI register bdf="+h(t)+" ("+e.name+")",LOG_PCI),dbg_assert(!this.devices[t]),dbg_assert(64<=e.pci_space.length),dbg_assert(t<this.devices.length);var r=new Int32Array(64);r.set(new Int32Array(new Uint8Array(e.pci_space).buffer)),this.device_spaces[t]=r,this.devices[t]=e,t=r.slice(4,10);for(var s=0;s<e.pci_bars.length;s++){var i=e.pci_bars[s];if(i){var _=t[s],a=1&_;if(i.original_bar=_,i.entries=[],0!==a)for(dbg_assert(1===a),_&=-2,a=0;a<i.size;a++)i.entries[a]=this.io.ports[_+a]}}return r},PCI.prototype.set_io_bars=function(e,t,r){var s=e.size;dbg_log("Move io bars: from="+h(t)+" to="+h(r)+" count="+s,LOG_PCI);for(var i=this.io.ports,_=0;_<s;_++){var a=i[t+_];i[t+_]=this.io.create_empty_entry(),a.read8===this.io.empty_port_read8&&a.read16===this.io.empty_port_read16&&a.read32===this.io.empty_port_read32&&a.write8===this.io.empty_port_write&&a.write16===this.io.empty_port_write&&a.write32===this.io.empty_port_write&&dbg_log("Move IO bar: Source not mapped, port="+h(t+_,4),LOG_PCI),a=e.entries[_];var o=i[r+_];dbg_assert(a&&o),i[r+_]=a,dbg_assert(o.read8===this.io.empty_port_read8,"Bad IO bar: Target already mapped"),dbg_assert(o.read16===this.io.empty_port_read16,"Bad IO bar: Target already mapped"),dbg_assert(o.read32===this.io.empty_port_read32,"Bad IO bar: Target already mapped"),dbg_assert(o.write8===this.io.empty_port_write,"Bad IO bar: Target already mapped"),dbg_assert(o.write16===this.io.empty_port_write,"Bad IO bar: Target already mapped"),dbg_assert(o.write32===this.io.empty_port_write,"Bad IO bar: Target already mapped")}},PCI.prototype.raise_irq=function(e){var t=this.device_spaces[e];dbg_assert(t),this.cpu.device_raise_irq(this.isa_bridge_space8[96+((t[15]>>8&255)-1+((e>>3)-1&255)&3)])},PCI.prototype.lower_irq=function(e){var t=this.device_spaces[e];dbg_assert(t),this.cpu.device_lower_irq(this.isa_bridge_space8[96+((t[15]>>8&255)+(e>>3&255)-2&3)])},FloppyController.prototype.get_state=function(){var e=[];return e[0]=this.bytes_expecting,e[1]=this.receiving_command,e[2]=this.receiving_index,e[4]=this.response_data,e[5]=this.response_index,e[6]=this.response_length,e[7]=this.floppy_size,e[8]=this.status_reg0,e[9]=this.status_reg1,e[10]=this.status_reg2,e[11]=this.drive,e[12]=this.last_cylinder,e[13]=this.last_head,e[14]=this.last_sector,e[15]=this.dor,e[16]=this.sectors_per_track,e[17]=this.number_of_heads,e[18]=this.number_of_cylinders,e},FloppyController.prototype.set_state=function(e){this.bytes_expecting=e[0],this.receiving_command=e[1],this.receiving_index=e[2],this.next_command=e[3],this.response_data=e[4],this.response_index=e[5],this.response_length=e[6],this.floppy_size=e[7],this.status_reg0=e[8],this.status_reg1=e[9],this.status_reg2=e[10],this.drive=e[11],this.last_cylinder=e[12],this.last_head=e[13],this.last_sector=e[14],this.dor=e[15],this.sectors_per_track=e[16],this.number_of_heads=e[17],this.number_of_cylinders=e[18]},FloppyController.prototype.port3F0_read=function(){return dbg_log("3F0 read",LOG_FLOPPY),0},FloppyController.prototype.port3F4_read=function(){dbg_log("3F4 read",LOG_FLOPPY);var e=128;return this.response_index<this.response_length&&(e|=80),0==(8&this.dor)&&(e|=32),e},FloppyController.prototype.port3F7_read=function(){return dbg_log("3F7 read",LOG_FLOPPY),0},FloppyController.prototype.port3F5_read=function(){return this.response_index<this.response_length?(dbg_log("3F5 read: "+this.response_data[this.response_index],LOG_FLOPPY),this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):(dbg_log("3F5 read, empty",LOG_FLOPPY),255)},FloppyController.prototype.port3F5_write=function(e){if(this.fda_image)if(dbg_log("3F5 write "+h(e),LOG_FLOPPY),0<this.bytes_expecting){if(this.receiving_command[this.receiving_index++]=e,this.bytes_expecting--,0===this.bytes_expecting){if(DEBUG){e="3F5 command received: ";for(var t=0;t<this.receiving_index;t++)e+=h(this.receiving_command[t])+" ";dbg_log(e,LOG_FLOPPY)}this.next_command.call(this,this.receiving_command)}}else{switch(e){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 197:this.next_command=function(e){this.do_sector(!0,e)},this.bytes_expecting=8;break;case 230:this.next_command=function(e){this.do_sector(!1,e)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:dbg_log("dump registers",LOG_FLOPPY),this.response_data[0]=128,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:dbg_assert(!1,"Unimplemented floppy command call "+h(e))}this.receiving_index=0}},FloppyController.prototype.port3F2_read=function(){return dbg_log("read 3F2: DOR",LOG_FLOPPY),this.dor},FloppyController.prototype.port3F2_write=function(e){4==(4&e)&&0==(4&this.dor)&&this.cpu.device_raise_irq(6),dbg_log("start motors: "+h(e>>4),LOG_FLOPPY),dbg_log("enable dma: "+!!(8&e),LOG_FLOPPY),dbg_log("reset fdc: "+!!(4&e),LOG_FLOPPY),dbg_log("drive select: "+(3&e),LOG_FLOPPY),dbg_log("DOR = "+h(e),LOG_FLOPPY),this.dor=e},FloppyController.prototype.check_drive_status=function(e){dbg_log("check drive status",LOG_FLOPPY),this.response_index=0,this.response_length=1,this.response_data[0]=32},FloppyController.prototype.seek=function(e){dbg_log("seek",LOG_FLOPPY),dbg_assert(0==(3&e[0]),"Unhandled seek drive"),this.last_cylinder=e[1],this.last_head=e[0]>>2&1,this.raise_irq()},FloppyController.prototype.calibrate=function(e){dbg_log("floppy calibrate",LOG_FLOPPY),this.raise_irq()},FloppyController.prototype.check_interrupt_status=function(){dbg_log("floppy check interrupt status",LOG_FLOPPY),this.response_index=0,this.response_length=2,this.response_data[0]=32,this.response_data[1]=this.last_cylinder},FloppyController.prototype.do_sector=function(e,t){var r=t[2],s=t[1],i=t[3],_=128<<t[4],a=t[5]-t[3]+1,o=((r+this.number_of_heads*s)*this.sectors_per_track+i-1)*_;dbg_log("Floppy "+(e?"Write":"Read"),LOG_FLOPPY),dbg_log("from "+h(o)+" length "+h(a*_),LOG_FLOPPY),dbg_log(s+" / "+r+" / "+i,LOG_FLOPPY),t[4]||dbg_log("FDC: sector count is zero, use data length instead",LOG_FLOPPY),this.fda_image&&(e?this.dma.do_write(this.fda_image,o,a*_,2,this.done.bind(this,t,s,r,i)):this.dma.do_read(this.fda_image,o,a*_,2,this.done.bind(this,t,s,r,i)))},FloppyController.prototype.done=function(e,t,r,s,i){i||(++s>this.sectors_per_track&&(s=1,++r>=this.number_of_heads&&(r=0,t++)),this.last_cylinder=t,this.last_head=r,this.last_sector=s,this.response_index=0,this.response_length=7,this.response_data[0]=r<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=t,this.response_data[4]=r,this.response_data[5]=s,this.response_data[6]=e[4],this.raise_irq())},FloppyController.prototype.fix_drive_data=function(e){dbg_log("floppy fix drive data "+e,LOG_FLOPPY)},FloppyController.prototype.read_sector_id=function(e){dbg_log("floppy read sector id "+e,LOG_FLOPPY),this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()},FloppyController.prototype.raise_irq=function(){8&this.dor&&this.cpu.device_raise_irq(6)};var A20_MASK=-1048577,A20_MASK16=-524289,A20_MASK32=-262145,USE_A20=!1;function DMA(e){this.cpu=e,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,(e=e.io).register_write(0,this,this.port_addr_write.bind(this,0)),e.register_write(2,this,this.port_addr_write.bind(this,1)),e.register_write(4,this,this.port_addr_write.bind(this,2)),e.register_write(6,this,this.port_addr_write.bind(this,3)),e.register_write(1,this,this.port_count_write.bind(this,0)),e.register_write(3,this,this.port_count_write.bind(this,1)),e.register_write(5,this,this.port_count_write.bind(this,2)),e.register_write(7,this,this.port_count_write.bind(this,3)),e.register_read(0,this,this.port_addr_read.bind(this,0)),e.register_read(2,this,this.port_addr_read.bind(this,1)),e.register_read(4,this,this.port_addr_read.bind(this,2)),e.register_read(6,this,this.port_addr_read.bind(this,3)),e.register_read(1,this,this.port_count_read.bind(this,0)),e.register_read(3,this,this.port_count_read.bind(this,1)),e.register_read(5,this,this.port_count_read.bind(this,2)),e.register_read(7,this,this.port_count_read.bind(this,3)),e.register_write(192,this,this.port_addr_write.bind(this,4)),e.register_write(196,this,this.port_addr_write.bind(this,5)),e.register_write(200,this,this.port_addr_write.bind(this,6)),e.register_write(204,this,this.port_addr_write.bind(this,7)),e.register_write(194,this,this.port_count_write.bind(this,4)),e.register_write(198,this,this.port_count_write.bind(this,5)),e.register_write(202,this,this.port_count_write.bind(this,6)),e.register_write(206,this,this.port_count_write.bind(this,7)),e.register_read(192,this,this.port_addr_read.bind(this,4)),e.register_read(196,this,this.port_addr_read.bind(this,5)),e.register_read(200,this,this.port_addr_read.bind(this,6)),e.register_read(204,this,this.port_addr_read.bind(this,7)),e.register_read(194,this,this.port_count_read.bind(this,4)),e.register_read(198,this,this.port_count_read.bind(this,5)),e.register_read(202,this,this.port_count_read.bind(this,6)),e.register_read(206,this,this.port_count_read.bind(this,7)),e.register_write(135,this,this.port_page_write.bind(this,0)),e.register_write(131,this,this.port_page_write.bind(this,1)),e.register_write(129,this,this.port_page_write.bind(this,2)),e.register_write(130,this,this.port_page_write.bind(this,3)),e.register_write(143,this,this.port_page_write.bind(this,4)),e.register_write(139,this,this.port_page_write.bind(this,5)),e.register_write(137,this,this.port_page_write.bind(this,6)),e.register_write(138,this,this.port_page_write.bind(this,7)),e.register_read(135,this,this.port_page_read.bind(this,0)),e.register_read(131,this,this.port_page_read.bind(this,1)),e.register_read(129,this,this.port_page_read.bind(this,2)),e.register_read(130,this,this.port_page_read.bind(this,3)),e.register_read(143,this,this.port_page_read.bind(this,4)),e.register_read(139,this,this.port_page_read.bind(this,5)),e.register_read(137,this,this.port_page_read.bind(this,6)),e.register_read(138,this,this.port_page_read.bind(this,7)),e.register_write(1159,this,this.port_pagehi_write.bind(this,0)),e.register_write(1155,this,this.port_pagehi_write.bind(this,1)),e.register_write(1153,this,this.port_pagehi_write.bind(this,2)),e.register_write(1154,this,this.port_pagehi_write.bind(this,3)),e.register_write(1163,this,this.port_pagehi_write.bind(this,5)),e.register_write(1161,this,this.port_pagehi_write.bind(this,6)),e.register_write(1162,this,this.port_pagehi_write.bind(this,7)),e.register_read(1159,this,this.port_pagehi_read.bind(this,0)),e.register_read(1155,this,this.port_pagehi_read.bind(this,1)),e.register_read(1153,this,this.port_pagehi_read.bind(this,2)),e.register_read(1154,this,this.port_pagehi_read.bind(this,3)),e.register_read(1163,this,this.port_pagehi_read.bind(this,5)),e.register_read(1161,this,this.port_pagehi_read.bind(this,6)),e.register_read(1162,this,this.port_pagehi_read.bind(this,7)),e.register_write(10,this,this.port_singlemask_write.bind(this,0)),e.register_write(212,this,this.port_singlemask_write.bind(this,4)),e.register_write(15,this,this.port_multimask_write.bind(this,0)),e.register_write(222,this,this.port_multimask_write.bind(this,4)),e.register_read(15,this,this.port_multimask_read.bind(this,0)),e.register_read(222,this,this.port_multimask_read.bind(this,4)),e.register_write(11,this,this.port_mode_write.bind(this,0)),e.register_write(214,this,this.port_mode_write.bind(this,4)),e.register_write(12,this,this.portC_write),e.register_write(216,this,this.portC_write)}CPU.prototype.debug_write=function(e,t,r){DEBUG&&(dbg_assert("number"==typeof r&&!isNaN(r)),dbg_assert(-2147483648<=r&&2147483648>e),this.debug_read(e,t,!0))},CPU.prototype.debug_read=function(e,t,r){DEBUG&&(dbg_assert("number"==typeof e),dbg_assert(!isNaN(e)))},CPU.prototype.mmap_read8=function(e){return this.memory_map_read8[e>>>MMAP_BLOCK_BITS](e)},CPU.prototype.mmap_write8=function(e,t){this.memory_map_write8[e>>>MMAP_BLOCK_BITS](e,t)},CPU.prototype.mmap_read16=function(e){var t=this.memory_map_read8[e>>>MMAP_BLOCK_BITS];return t(e)|t(e+1|0)<<8},CPU.prototype.mmap_write16=function(e,t){var r=this.memory_map_write8[e>>>MMAP_BLOCK_BITS];r(e,255&t),r(e+1|0,t>>8&255)},CPU.prototype.mmap_read32=function(e){return this.memory_map_read32[e>>>MMAP_BLOCK_BITS](e)},CPU.prototype.mmap_write32=function(e,t){this.memory_map_write32[e>>>MMAP_BLOCK_BITS](e,t)},CPU.prototype.in_mapped_range=function(e){return 655360<=(0|e)&&786432>(0|e)||e>>>0>=this.memory_size>>>0},CPU.prototype.read8=function(e){return this.debug_read(e,1),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_read8(e):this.mem8[e]},CPU.prototype.read16=function(e){return this.debug_read(e,2),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_read16(e):this.mem8[e]|this.mem8[e+1|0]<<8},CPU.prototype.read_aligned16=function(e){return dbg_assert(0<=e&&2147483648>e),this.debug_read(e<<1,2),USE_A20&&!this.a20_enabled&&(e&=A20_MASK16),this.in_mapped_range(e<<1)?this.mmap_read16(e<<1):this.mem16[e]},CPU.prototype.read32s=function(e){return this.debug_read(e,4),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_read32(e):this.mem8[e]|this.mem8[e+1|0]<<8|this.mem8[e+2|0]<<16|this.mem8[e+3|0]<<24},CPU.prototype.read_aligned32=function(e){return dbg_assert(0<=e&&1073741824>e),this.debug_read(e<<2,4),USE_A20&&!this.a20_enabled&&(e&=A20_MASK32),this.in_mapped_range(e<<2)?this.mmap_read32(e<<2):this.mem32s[e]},CPU.prototype.write8=function(e,t){this.debug_write(e,1,t),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_write8(e,t):this.mem8[e]=t},CPU.prototype.write16=function(e,t){this.debug_write(e,2,t),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_write16(e,t):(this.mem8[e]=t,this.mem8[e+1|0]=t>>8)},CPU.prototype.write_aligned16=function(e,t){dbg_assert(0<=e&&2147483648>e),this.debug_write(e<<1,2,t),USE_A20&&!this.a20_enabled&&(e&=A20_MASK16),this.in_mapped_range(e<<1)?this.mmap_write16(e<<1,t):this.mem16[e]=t},CPU.prototype.write32=function(e,t){this.debug_write(e,4,t),USE_A20&&!this.a20_enabled&&(e&=A20_MASK),this.in_mapped_range(e)?this.mmap_write32(e,t):(this.mem8[e]=t,this.mem8[e+1|0]=t>>8,this.mem8[e+2|0]=t>>16,this.mem8[e+3|0]=t>>24)},CPU.prototype.write_aligned32=function(e,t){dbg_assert(0<=e&&1073741824>e),this.debug_write(e<<2,4,t),USE_A20&&!this.a20_enabled&&(e&=A20_MASK32),this.in_mapped_range(e<<2)?this.mmap_write32(e<<2,t):this.mem32s[e]=t},CPU.prototype.write_blob=function(e,t){this.debug_write(t,e.length,0),dbg_assert(e&&0<=e.length),this.mem8.set(e,t)},CPU.prototype.write_blob32=function(e,t){dbg_assert(e&&e.length),this.debug_write(t,e.length<<2,0),this.mem32s.set(e,t)},DMA.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]},DMA.prototype.set_state=function(e){this.channel_page=e[0],this.channel_pagehi=e[1],this.channel_addr=e[2],this.channel_addr_init=e[3],this.channel_count=e[4],this.channel_count_init=e[5],this.channel_mask=e[6],this.channel_mode=e[7],this.lsb_msb_flipflop=e[8]},DMA.prototype.port_count_write=function(e,t){dbg_log("count write ["+e+"] = "+h(t),LOG_DMA),this.channel_count[e]=this.flipflop_get(this.channel_count[e],t,!1),this.channel_count_init[e]=this.flipflop_get(this.channel_count_init[e],t,!0)},DMA.prototype.port_count_read=function(e){return dbg_log("count read ["+e+"] -> "+h(this.channel_count[e]),LOG_DMA),this.flipflop_read(this.channel_count[e])},DMA.prototype.port_addr_write=function(e,t){dbg_log("addr write ["+e+"] = "+h(t),LOG_DMA),this.channel_addr[e]=this.flipflop_get(this.channel_addr[e],t,!1),this.channel_addr_init[e]=this.flipflop_get(this.channel_addr_init[e],t,!0)},DMA.prototype.port_addr_read=function(e){return dbg_log("addr read ["+e+"] -> "+h(this.channel_addr[e]),LOG_DMA),this.flipflop_read(this.channel_addr[e])},DMA.prototype.port_pagehi_write=function(e,t){dbg_log("pagehi write ["+e+"] = "+h(t),LOG_DMA),this.channel_pagehi[e]=t},DMA.prototype.port_pagehi_read=function(e){return dbg_log("pagehi read ["+e+"]",LOG_DMA),this.channel_pagehi[e]},DMA.prototype.port_page_write=function(e,t){dbg_log("page write ["+e+"] = "+h(t),LOG_DMA),this.channel_page[e]=t},DMA.prototype.port_page_read=function(e){return dbg_log("page read ["+e+"]",LOG_DMA),this.channel_page[e]},DMA.prototype.port_singlemask_write=function(e,t){dbg_log("singlechannel mask write ["+(e=(3&t)+e)+"] = "+(t=4&t?1:0),LOG_DMA),this.update_mask(e,t)},DMA.prototype.port_multimask_write=function(e,t){dbg_log("multichannel mask write: "+h(t),LOG_DMA);for(var r=0;4>r;r++)this.update_mask(e+r,t&1<<r)},DMA.prototype.port_multimask_read=function(e){var t=0|this.channel_mask[e+0];return t|=this.channel_mask[e+1]<<1,t|=this.channel_mask[e+2]<<2,t|=this.channel_mask[e+3]<<3,dbg_log("multichannel mask read: "+h(t),LOG_DMA),t},DMA.prototype.port_mode_write=function(e,t){dbg_log("mode write ["+(e=(3&t)+e)+"] = "+h(t),LOG_DMA),this.channel_mode[e]=t},DMA.prototype.portC_write=function(e){dbg_log("flipflop reset",LOG_DMA),this.lsb_msb_flipflop=0},DMA.prototype.on_unmask=function(e,t){this.unmask_listeners.push({fn:e,this_value:t})},DMA.prototype.update_mask=function(e,t){if(this.channel_mask[e]!==t&&(this.channel_mask[e]=t,!t))for(dbg_log("firing on_unmask("+e+")",LOG_DMA),t=0;t<this.unmask_listeners.length;t++)this.unmask_listeners[t].fn.call(this.unmask_listeners[t].this_value,e)},DMA.prototype.do_read=function(e,t,r,s,i){var _=this.count_get_8bit(s),a=this.address_get_8bit(s);if(dbg_log("DMA write channel "+s,LOG_DMA),dbg_log("to "+h(a)+" len "+h(_),LOG_DMA),r<_&&dbg_log("DMA should read more than provided: "+h(r)+" "+h(_),LOG_DMA),t+_>e.byteLength)dbg_log("DMA read outside of buffer",LOG_DMA),i(!0);else{var o=this.cpu;this.channel_addr[s]+=_,e.get(t,_,function(e){o.write_blob(e,a),i(!1)})}},DMA.prototype.do_write=function(e,t,r,s,i){var _=this,a=this.channel_count[s]+1&65535,o=5<=s?2:1,n=a*o,d=this.address_get_8bit(s),g=!1,c=!1,p=16&this.channel_mode[s];dbg_log("DMA write channel "+s,LOG_DMA),dbg_log("to "+h(d)+" len "+h(n),LOG_DMA),r<n?(dbg_log("DMA should read more than provided",LOG_DMA),a=Math.floor(r/o),n=a*o,g=!0):r>n&&(dbg_log("DMA attempted to read more than provided",LOG_DMA),c=!0),t+n>e.byteLength?(dbg_log("DMA write outside of buffer",LOG_DMA),i(!0)):(this.channel_addr[s]+=a,this.channel_count[s]-=a,!g&&p&&(dbg_log("DMA autoinit",LOG_DMA),this.channel_addr[s]=this.channel_addr_init[s],this.channel_count[s]=this.channel_count_init[s]),e.set(t,this.cpu.mem8.subarray(d,d+n),function(){c&&p?(dbg_log("DMA continuing from start",LOG_DMA),_.do_write(e,t+n,r-n,s,i)):i(!1)}))},DMA.prototype.address_get_8bit=function(e){var t=this.channel_addr[e];return 5<=e&&(t<<=1),(t=65535&t|this.channel_page[e]<<16)|this.channel_pagehi[e]<<24},DMA.prototype.count_get_8bit=function(e){var t=this.channel_count[e]+1;return 5<=e&&(t*=2),t},DMA.prototype.flipflop_get=function(e,t,r){return r||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?-256&e|t:-65281&e|t<<8},DMA.prototype.flipflop_read=function(e){return(this.lsb_msb_flipflop^=1)?255&e:e>>8&255};var OSCILLATOR_FREQ=1193.1816666;function PIT(e,t){this.cpu=e,this.bus=t,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),e.io.register_read(97,this,function(){var e=v86.microtick();return(66.66666666666667*e&1)<<4|(e=this.did_rollover(2,e))<<5}),e.io.register_write(97,this,function(e){1&e?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),e.io.register_read(64,this,function(){return this.counter_read(0)}),e.io.register_read(65,this,function(){return this.counter_read(1)}),e.io.register_read(66,this,function(){return this.counter_read(2)}),e.io.register_write(64,this,function(e){this.counter_write(0,e)}),e.io.register_write(65,this,function(e){this.counter_write(1,e)}),e.io.register_write(66,this,function(e){this.counter_write(2,e)}),e.io.register_write(67,this,this.port43_write)}PIT.prototype.get_state=function(){var e=[];return e[0]=this.counter_next_low,e[1]=this.counter_enabled,e[2]=this.counter_mode,e[3]=this.counter_read_mode,e[4]=this.counter_latch,e[5]=this.counter_latch_value,e[6]=this.counter_reload,e[7]=this.counter_start_time,e[8]=this.counter_start_value,e},PIT.prototype.set_state=function(e){this.counter_next_low=e[0],this.counter_enabled=e[1],this.counter_mode=e[2],this.counter_read_mode=e[3],this.counter_latch=e[4],this.counter_latch_value=e[5],this.counter_reload=e[6],this.counter_start_time=e[7],this.counter_start_value=e[8]},PIT.prototype.timer=function(e,t){return t||(this.counter_enabled[0]&&this.did_rollover(0,e)?(this.counter_start_value[0]=this.get_counter_value(0,e),this.counter_start_time[0]=e,dbg_log("pit interrupt. new value: "+this.counter_start_value[0],LOG_PIT),this.cpu.device_raise_irq(0),0===this.counter_mode[0]&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0)),0},PIT.prototype.get_counter_value=function(e,t){if(!this.counter_enabled[e])return 0;var r=t-this.counter_start_time[e],s=Math.floor(r*OSCILLATOR_FREQ);return t=this.counter_start_value[e]-s,dbg_log("diff="+r+" dticks="+s+" value="+t+" reload="+this.counter_reload[e],LOG_PIT),t>=(r=this.counter_reload[e])?(dbg_log("Warning: Counter"+e+" value "+t+" is larger than reload "+r,LOG_PIT),t%=r):0>t&&(t=t%r+r),t},PIT.prototype.did_rollover=function(e,t){return 0>(t-=this.counter_start_time[e])?(dbg_log("Warning: PIT timer difference is negative, resetting"),!0):this.counter_start_value[e]<Math.floor(t*OSCILLATOR_FREQ)},PIT.prototype.counter_read=function(e){var t=this.counter_latch[e];return t?(this.counter_latch[e]--,2===t?255&this.counter_latch_value[e]:this.counter_latch_value[e]>>8):(t=this.counter_next_low[e],3===this.counter_mode[e]&&(this.counter_next_low[e]^=1),e=this.get_counter_value(e,v86.microtick()),t?255&e:e>>8)},PIT.prototype.counter_write=function(e,t){this.counter_reload[e]=this.counter_next_low[e]?-256&this.counter_reload[e]|t:255&this.counter_reload[e]|t<<8,3===this.counter_read_mode[e]&&this.counter_next_low[e]||(this.counter_reload[e]||(this.counter_reload[e]=65535),this.counter_start_value[e]=this.counter_reload[e],this.counter_enabled[e]=!0,this.counter_start_time[e]=v86.microtick(),dbg_log("counter"+e+" reload="+h(this.counter_reload[e])+" tick="+(this.counter_reload[e]||65536)/OSCILLATOR_FREQ+"ms",LOG_PIT)),3===this.counter_read_mode[e]&&(this.counter_next_low[e]^=1),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])},PIT.prototype.port43_write=function(e){var t=e>>1&7,r=1&e,s=e>>6&3;e=e>>4&3,1===s&&dbg_log("Unimplemented timer1",LOG_PIT),3===s?dbg_log("Unimplemented read back",LOG_PIT):0===e?(this.counter_latch[s]=2,t=this.get_counter_value(s,v86.microtick()),dbg_log("latch: "+t,LOG_PIT),this.counter_latch_value[s]=t?t-1:0):(6<=t&&(t&=-5),dbg_log("Control: mode="+t+" ctr="+s+" read_mode="+e+" bcd="+r,LOG_PIT),this.counter_next_low[s]=1===e?0:1,0===s&&this.cpu.device_lower_irq(0),0!==t&&3!==t&&2!==t&&dbg_log("Unimplemented counter mode: "+h(t),LOG_PIT),this.counter_mode[s]=t,this.counter_read_mode[s]=e,this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]]))};var VGA_BANK_SIZE=65536,MAX_XRES=2560,MAX_YRES=1600,MAX_BPP=32,VGA_LFB_ADDRESS=3758096384,VGA_PIXEL_BUFFER_START=4*VGA_BANK_SIZE,VGA_PIXEL_BUFFER_SIZE=8*VGA_BANK_SIZE,VGA_MIN_MEMORY_SIZE=VGA_PIXEL_BUFFER_START+VGA_PIXEL_BUFFER_SIZE,VGA_HOST_MEMORY_SPACE_START=Uint32Array.from([655360,655360,720896,753664]),VGA_HOST_MEMORY_SPACE_SIZE=Uint32Array.from([131072,65536,32768,32768]);function VGAScreen(e,t,r){var s=this;this.bus=t,this.vga_memory_size=r,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout(function(){t.send("screen-set-mode",s.graphical_mode)},0),this.vga256_palette=new Int32Array(256),this.svga_height=this.svga_width=this.latch_dword=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset=this.svga_bank_offset=0,this.pci_space=[222,16,32,10,7,0,0,0,162,0,0,3,0,0,128,0,8,VGA_LFB_ADDRESS>>>8,VGA_LFB_ADDRESS>>>16,VGA_LFB_ADDRESS>>>24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,1,0,0],this.pci_id=144,this.pci_bars=[{size:r}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,(r=e.io).register_write(960,this,this.port3C0_write),r.register_read(960,this,this.port3C0_read,this.port3C0_read16),r.register_read(961,this,this.port3C1_read),r.register_write(962,this,this.port3C2_write),r.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),r.register_read(964,this,this.port3C4_read),r.register_read(965,this,this.port3C5_read),r.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),r.register_read(974,this,this.port3CE_read),r.register_read(975,this,this.port3CF_read),r.register_write(967,this,this.port3C7_write),r.register_read(967,this,this.port3C7_read),r.register_write(968,this,this.port3C8_write),r.register_read(968,this,this.port3C8_read),r.register_write(969,this,this.port3C9_write),r.register_read(969,this,this.port3C9_read),r.register_read(972,this,this.port3CC_read),r.register_write_consecutive(980,this,this.port3D4_write,this.port3D5_write),r.register_read(980,this,this.port3D4_read),r.register_read(981,this,this.port3D5_read),r.register_read(970,this,function(){return dbg_log("3CA read",LOG_VGA),0}),r.register_read(986,this,this.port3DA_read),r.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,r.register_write(462,this,void 0,this.port1CE_write),r.register_write(463,this,void 0,this.port1CF_write),r.register_read(463,this,void 0,this.port1CF_read),void 0===this.vga_memory_size||this.vga_memory_size<VGA_MIN_MEMORY_SIZE?(this.vga_memory_size=VGA_MIN_MEMORY_SIZE,dbg_log("vga memory size rounded up to "+this.vga_memory_size,LOG_VGA)):this.vga_memory_size&VGA_BANK_SIZE-1&&(this.vga_memory_size|=VGA_BANK_SIZE-1,this.vga_memory_size++),this.svga_memory=new Uint8Array(this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.dest_buffer=void 0,t.register("screen-tell-buffer",function(e){this.dest_buffer&&e[0]&&e[0].set(this.dest_buffer.subarray(0,e[0].length)),this.dest_buffer=e[0]},this),t.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this),this.svga_memory16=new Uint16Array(this.svga_memory.buffer),this.svga_memory32=new Int32Array(this.svga_memory.buffer),this.vga_memory=new Uint8Array(this.svga_memory.buffer,0,4*VGA_BANK_SIZE),this.plane0=new Uint8Array(this.svga_memory.buffer,0*VGA_BANK_SIZE,VGA_BANK_SIZE),this.plane1=new Uint8Array(this.svga_memory.buffer,1*VGA_BANK_SIZE,VGA_BANK_SIZE),this.plane2=new Uint8Array(this.svga_memory.buffer,2*VGA_BANK_SIZE,VGA_BANK_SIZE),this.plane3=new Uint8Array(this.svga_memory.buffer,3*VGA_BANK_SIZE,VGA_BANK_SIZE),this.pixel_buffer=new Uint8Array(this.svga_memory.buffer,VGA_PIXEL_BUFFER_START,VGA_PIXEL_BUFFER_SIZE);var i=this;r.mmap_register(655360,131072,function(e){return i.vga_memory_read(e)},function(e,t){i.vga_memory_write(e,t)}),r.mmap_register(VGA_LFB_ADDRESS,this.vga_memory_size,function(e){return i.svga_memory_read8(e)},function(e,t){i.svga_memory_write8(e,t)},function(e){return i.svga_memory_read32(e)},function(e,t){i.svga_memory_write32(e,t)}),e.devices.pci.register_device(this)}function PS2(e,t){this.cpu=e,this.bus=t,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new ByteQueue(1024),this.last_port60_byte=0,this.sample_rate=100,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new ByteQueue(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",function(e){this.kbd_send_code(e)},this),this.bus.register("mouse-click",function(e){this.mouse_send_click(e[0],e[1],e[2])},this),this.bus.register("mouse-delta",function(e){this.mouse_send_delta(e[0],e[1])},this),this.bus.register("mouse-wheel",function(e){},this),this.command_register=5,this.read_command_register=this.read_output_register=!1,e.io.register_read(96,this,this.port60_read),e.io.register_read(100,this,this.port64_read),e.io.register_write(96,this,this.port60_write),e.io.register_write(100,this,this.port64_write)}VGAScreen.prototype.get_state=function(){var e=[];return e[0]=this.vga_memory_size,e[1]=this.cursor_address,e[2]=this.cursor_scanline_start,e[3]=this.cursor_scanline_end,e[4]=this.max_cols,e[5]=this.max_rows,e[6]=this.layers,e[7]=this.dac_state,e[8]=this.start_address,e[9]=this.graphical_mode,e[10]=this.vga256_palette,e[11]=this.latch_dword,e[12]=this.color_compare,e[13]=this.color_dont_care,e[14]=this.miscellaneous_graphics_register,e[15]=this.svga_width,e[16]=this.svga_height,e[17]=this.crtc_mode,e[18]=this.svga_enabled,e[19]=this.svga_bpp,e[20]=this.svga_bank_offset,e[21]=this.svga_offset,e[22]=this.index_crtc,e[23]=this.dac_color_index_write,e[24]=this.dac_color_index_read,e[25]=this.dac_map,e[26]=this.sequencer_index,e[27]=this.plane_write_bm,e[28]=this.sequencer_memory_mode,e[29]=this.graphics_index,e[30]=this.plane_read,e[31]=this.planar_mode,e[32]=this.planar_rotate_reg,e[33]=this.planar_bitmap,e[34]=this.max_scan_line,e[35]=this.miscellaneous_output_register,e[36]=this.port_3DA_value,e[37]=this.dispi_index,e[38]=this.dispi_enable_value,e[39]=this.svga_memory,e[40]=this.graphical_mode_is_linear,e[41]=this.attribute_controller_index,e[42]=this.offset_register,e[43]=this.planar_setreset,e[44]=this.planar_setreset_enable,e[45]=this.start_address_latched,e[46]=this.crtc,e[47]=this.horizontal_display_enable_end,e[48]=this.horizontal_blank_start,e[49]=this.vertical_display_enable_end,e[50]=this.vertical_blank_start,e[51]=this.underline_location_register,e[52]=this.preset_row_scan,e[53]=this.offset_register,e[54]=this.palette_source,e[55]=this.attribute_mode,e[56]=this.color_plane_enable,e[57]=this.horizontal_panning,e[58]=this.color_select,e[59]=this.clocking_mode,e[60]=this.line_compare,e},VGAScreen.prototype.set_state=function(e){this.vga_memory_size=e[0],this.cursor_address=e[1],this.cursor_scanline_start=e[2],this.cursor_scanline_end=e[3],this.max_cols=e[4],this.max_rows=e[5],this.layers=e[6],this.dac_state=e[7],this.start_address=e[8],this.graphical_mode=e[9],this.vga256_palette=e[10],this.latch_dword=e[11],this.color_compare=e[12],this.color_dont_care=e[13],this.miscellaneous_graphics_register=e[14],this.svga_width=e[15],this.svga_height=e[16],this.crtc_mode=e[17],this.svga_enabled=e[18],this.svga_bpp=e[19],this.svga_bank_offset=e[20],this.svga_offset=e[21],this.index_crtc=e[22],this.dac_color_index_write=e[23],this.dac_color_index_read=e[24],this.dac_map=e[25],this.sequencer_index=e[26],this.plane_write_bm=e[27],this.sequencer_memory_mode=e[28],this.graphics_index=e[29],this.plane_read=e[30],this.planar_mode=e[31],this.planar_rotate_reg=e[32],this.planar_bitmap=e[33],this.max_scan_line=e[34],this.miscellaneous_output_register=e[35],this.port_3DA_value=e[36],this.dispi_index=e[37],this.dispi_enable_value=e[38],this.svga_memory.set(e[39]),this.graphical_mode_is_linear=e[40],this.attribute_controller_index=e[41],this.offset_register=e[42],this.planar_setreset=e[43],this.planar_setreset_enable=e[44],this.start_address_latched=e[45],this.crtc.set(e[46]),this.horizontal_display_enable_end=e[47],this.horizontal_blank_start=e[48],this.vertical_display_enable_end=e[49],this.vertical_blank_start=e[50],this.underline_location_register=e[51],this.preset_row_scan=e[52],this.offset_register=e[53],this.palette_source=e[54],this.attribute_mode=e[55],this.color_plane_enable=e[56],this.horizontal_panning=e[57],this.color_select=e[58],this.clocking_mode=e[59],this.line_compare=e[60],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()},VGAScreen.prototype.vga_memory_read=function(e){if(this.svga_enabled&&this.graphical_mode_is_linear)return e=e-655360|this.svga_bank_offset,this.svga_memory[e];var t=this.miscellaneous_graphics_register>>2&3;return 0>(e-=VGA_HOST_MEMORY_SPACE_START[t])||e>=VGA_HOST_MEMORY_SPACE_SIZE[t]?(dbg_log("vga read outside memory space: addr:"+h(e),LOG_VGA),0):(this.latch_dword=this.plane0[e],this.latch_dword|=this.plane1[e]<<8,this.latch_dword|=this.plane2[e]<<16,this.latch_dword|=this.plane3[e]<<24,8&this.planar_mode?(t=255,1&this.color_dont_care&&(t&=this.plane0[e]^~(1&this.color_compare?255:0)),2&this.color_dont_care&&(t&=this.plane1[e]^~(2&this.color_compare?255:0)),4&this.color_dont_care&&(t&=this.plane2[e]^~(4&this.color_compare?255:0)),8&this.color_dont_care&&(t&=this.plane3[e]^~(8&this.color_compare?255:0)),t):(t=this.plane_read,this.graphical_mode?8&this.sequencer_memory_mode?(t=3&e,e&=-4):16&this.planar_mode&&(t=1&e,e&=-2):t=0,this.vga_memory[t<<16|e]))},VGAScreen.prototype.vga_memory_write=function(e,t){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.vga_memory_write_graphical_linear(e-655360,t);else{var r=this.miscellaneous_graphics_register>>2&3;0>(e-=VGA_HOST_MEMORY_SPACE_START[r])||e>=VGA_HOST_MEMORY_SPACE_SIZE[r]?dbg_log("vga write outside memory space: addr:"+h(e)+", value:"+h(t),LOG_VGA):this.graphical_mode?this.vga_memory_write_graphical(e,t):3&this.plane_write_bm&&this.vga_memory_write_text_mode(e,t)}},VGAScreen.prototype.vga_memory_write_graphical_linear=function(e,t){e|=this.svga_bank_offset,this.diff_addr_min=e<this.diff_addr_min?e:this.diff_addr_min,this.diff_addr_max=e>this.diff_addr_max?e:this.diff_addr_max,this.svga_memory[e]=t},VGAScreen.prototype.vga_memory_write_graphical=function(e,t){var r=3&this.planar_mode,s=this.apply_feed(this.planar_bitmap),i=this.apply_expand(this.planar_setreset),_=this.apply_expand(this.planar_setreset_enable);switch(r){case 0:t=this.apply_rotate(t);var a=this.apply_feed(t);a=this.apply_setreset(a,_),a=this.apply_logical(a,this.latch_dword),a=this.apply_bitmask(a,s);break;case 1:a=this.latch_dword;break;case 2:a=this.apply_expand(t),a=this.apply_logical(a,this.latch_dword),a=this.apply_bitmask(a,s);break;case 3:t=this.apply_rotate(t),s&=this.apply_feed(t),a=this.apply_bitmask(i,s)}switch(t=15,12&this.sequencer_memory_mode){case 0:t=5<<(1&e),e&=-2;break;case 8:case 12:t=1<<(3&e),e&=-4}1&(t&=this.plane_write_bm)&&(this.plane0[e]=a>>0&255),2&t&&(this.plane1[e]=a>>8&255),4&t&&(this.plane2[e]=a>>16&255),8&t&&(this.plane3[e]=a>>24&255),e=this.vga_addr_to_pixel(e),this.partial_replot(e,e+7)},VGAScreen.prototype.apply_feed=function(e){return e|e<<8|e<<16|e<<24},VGAScreen.prototype.apply_expand=function(e){return(1&e?255:0)|(2&e?255:0)<<8|(4&e?255:0)<<16|(8&e?255:0)<<24},VGAScreen.prototype.apply_rotate=function(e){return(e|e<<8)>>>(7&this.planar_rotate_reg)&255},VGAScreen.prototype.apply_setreset=function(e,t){var r=this.apply_expand(this.planar_setreset);return(e|t&r)&(~t|r)},VGAScreen.prototype.apply_logical=function(e,t){switch(24&this.planar_rotate_reg){case 8:return e&t;case 16:return e|t;case 24:return e^t}return e},VGAScreen.prototype.apply_bitmask=function(e,t){return t&e|~t&this.latch_dword},VGAScreen.prototype.text_mode_redraw=function(){for(var e,t,r=this.start_address<<1,s=0;s<this.max_rows;s++)for(var i=0;i<this.max_cols;i++)e=this.vga_memory[r],t=this.vga_memory[1|r],this.bus.send("screen-put-char",[s,i,e,this.vga256_palette[t>>4&15],this.vga256_palette[15&t]]),r+=2},VGAScreen.prototype.vga_memory_write_text_mode=function(e,t){var r=(e>>1)-this.start_address,s=r/this.max_cols|0;if(r%=this.max_cols,1&e)var i=t,_=this.vga_memory[-2&e];else _=t,i=this.vga_memory[1|e];this.bus.send("screen-put-char",[s,r,_,this.vga256_palette[i>>4&15],this.vga256_palette[15&i]]),this.vga_memory[e]=t},VGAScreen.prototype.update_cursor=function(){var e=(this.cursor_address-this.start_address)/this.max_cols|0,t=(this.cursor_address-this.start_address)%this.max_cols;e=Math.min(this.max_rows-1,e),this.bus.send("screen-update-cursor",[e,t])},VGAScreen.prototype.svga_memory_read8=function(e){return this.svga_memory[268435455&e]},VGAScreen.prototype.svga_memory_read32=function(e){return 3&(e&=268435455)?this.svga_memory[e]|this.svga_memory[e+1]<<8|this.svga_memory[e+2]<<16|this.svga_memory[e+3]<<24:this.svga_memory32[e>>2]},VGAScreen.prototype.svga_memory_write8=function(e,t){e&=268435455,this.svga_memory[e]=t,this.diff_addr_min=e<this.diff_addr_min?e:this.diff_addr_min,this.diff_addr_max=e>this.diff_addr_max?e:this.diff_addr_max},VGAScreen.prototype.svga_memory_write32=function(e,t){e&=268435455,this.diff_addr_min=e<this.diff_addr_min?e:this.diff_addr_min,this.diff_addr_max=e+3>this.diff_addr_max?e+3:this.diff_addr_max,this.svga_memory[e]=t,this.svga_memory[e+1]=t>>8,this.svga_memory[e+2]=t>>16,this.svga_memory[e+3]=t>>24},VGAScreen.prototype.complete_redraw=function(){dbg_log("complete redraw",LOG_VGA),this.graphical_mode?(this.diff_addr_min=0,this.diff_addr_max=this.svga_enabled?this.vga_memory_size:VGA_PIXEL_BUFFER_SIZE):this.text_mode_redraw()},VGAScreen.prototype.complete_replot=function(){dbg_log("complete replot",LOG_VGA),this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=VGA_PIXEL_BUFFER_SIZE,this.complete_redraw())},VGAScreen.prototype.partial_redraw=function(e,t){e<this.diff_addr_min&&(this.diff_addr_min=e),t>this.diff_addr_max&&(this.diff_addr_max=t)},VGAScreen.prototype.partial_replot=function(e,t){e<this.diff_plot_min&&(this.diff_plot_min=e),t>this.diff_plot_max&&(this.diff_plot_max=t),this.partial_redraw(e,t)},VGAScreen.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0},VGAScreen.prototype.destroy=function(){},VGAScreen.prototype.vga_bytes_per_line=function(){var e=this.offset_register<<2;return 64&this.underline_location_register?e<<=1:64&this.crtc_mode&&(e>>>=1),e},VGAScreen.prototype.vga_addr_shift_count=function(){var e=128+(~this.underline_location_register&this.crtc_mode&64);return e-=64&this.underline_location_register,(e-=64&this.attribute_mode)>>>6},VGAScreen.prototype.vga_addr_to_pixel=function(e){var t=this.vga_addr_shift_count();if(3&~this.crtc_mode){var r=e-this.start_address;r&=this.crtc_mode<<13|-24577;var s=(r<<=t)/this.virtual_width|0;switch(r%=this.virtual_width,3&this.crtc_mode){case 2:s=s<<1|e>>13&1;break;case 1:s=s<<1|e>>14&1;break;case 0:s=s<<2|e>>13&3}return s*this.virtual_width+r+(this.start_address<<t)}return e<<t},VGAScreen.prototype.scan_line_to_screen_row=function(e){return 128&this.max_scan_line&&(e>>>=1),e=Math.ceil(e/(1+(31&this.max_scan_line))),1&this.crtc_mode||(e<<=1),2&this.crtc_mode||(e<<=1),e},VGAScreen.prototype.set_size_text=function(e,t){this.max_cols=e,this.max_rows=t,this.bus.send("screen-set-size-text",[e,t])},VGAScreen.prototype.set_size_graphical=function(e,t,r,s,i){this.stats.is_graphical&&this.stats.bpp===r&&this.screen_width===e&&this.screen_height===t&&this.virtual_width===s&&this.virtual_height===i||(this.screen_width=e,this.screen_height=t,this.virtual_width=s,this.virtual_height=i,this.stats.bpp=r,this.stats.is_graphical=!0,this.stats.res_x=e,this.stats.res_y=t,this.bus.send("screen-set-size-graphical",[e,t,s,i,r]))},VGAScreen.prototype.update_vga_size=function(){if(!this.svga_enabled){var e=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),t=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(e&&t)if(this.graphical_mode){e<<=3;var r=this.offset_register<<4;64&this.attribute_mode&&(e>>>=1,r>>>=1),t=this.scan_line_to_screen_row(t);var s=Math.ceil(VGA_HOST_MEMORY_SPACE_SIZE[0]/this.vga_bytes_per_line());this.set_size_graphical(e,t,8,r,s),this.update_vertical_retrace(),this.update_layers()}else 128&this.max_scan_line&&(t>>>=1),r=t/(1+(31&this.max_scan_line))|0,e&&r&&this.set_size_text(e,r)}},VGAScreen.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||32&this.clocking_mode)this.layers=[],this.bus.send("screen-clear");else{var e=this.start_address_latched,t=this.horizontal_panning;64&this.attribute_mode&&(t>>>=1);var r=this.preset_row_scan>>5&3,s=this.vga_addr_to_pixel(e+r);e=s/this.virtual_width|0;var i=s%this.virtual_width+t;s=this.scan_line_to_screen_row(1+this.line_compare),s=Math.min(s,this.screen_height);var _=this.screen_height-s;this.layers=[],i=-i;for(var a=0;i<this.screen_width;i+=this.virtual_width,a++)this.layers.push({screen_x:i,screen_y:0,buffer_x:0,buffer_y:e+a,buffer_width:this.virtual_width,buffer_height:s});for(e=0,32&this.attribute_mode||(e=this.vga_addr_to_pixel(r)+t),i=-e,a=0;i<this.screen_width;i+=this.virtual_width,a++)this.layers.push({screen_x:i,screen_y:s,buffer_x:0,buffer_y:a,buffer_width:this.virtual_width,buffer_height:_})}},VGAScreen.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())},VGAScreen.prototype.update_cursor_scanline=function(){this.bus.send("screen-update-cursor-scanline",[this.cursor_scanline_start,this.cursor_scanline_end])},VGAScreen.prototype.port3C0_write=function(e){if(-1===this.attribute_controller_index)dbg_log("attribute controller index register: "+h(e),LOG_VGA),this.attribute_controller_index=31&e,dbg_log("attribute actual index: "+h(this.attribute_controller_index),LOG_VGA),this.palette_source!==(32&e)&&(this.palette_source=32&e,this.update_layers());else{if(16>this.attribute_controller_index)dbg_log("internal palette: "+h(this.attribute_controller_index)+" -> "+h(e),LOG_VGA),this.dac_map[this.attribute_controller_index]=e,64&this.attribute_mode||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(dbg_log("3C0 / attribute mode control: "+h(e),LOG_VGA),this.attribute_mode!==e){var t=this.attribute_mode;this.attribute_mode=e;var r=0<(1&e);this.svga_enabled||this.graphical_mode===r||(this.graphical_mode=r,this.bus.send("screen-set-mode",this.graphical_mode)),64&(t^e)&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:dbg_log("3C0 / color plane enable: "+h(e),LOG_VGA),this.color_plane_enable!==e&&(this.color_plane_enable=e,this.complete_redraw());break;case 19:dbg_log("3C0 / horizontal panning: "+h(e),LOG_VGA),this.horizontal_panning!==e&&(this.horizontal_panning=15&e,this.update_layers());break;case 20:dbg_log("3C0 / color select: "+h(e),LOG_VGA),this.color_select!==e&&(this.color_select=e,this.complete_redraw());break;default:dbg_log("3C0 / attribute controller write "+h(this.attribute_controller_index)+": "+h(e),LOG_VGA)}this.attribute_controller_index=-1}},VGAScreen.prototype.port3C0_read=function(){return dbg_log("3C0 read",LOG_VGA),this.attribute_controller_index|this.palette_source},VGAScreen.prototype.port3C0_read16=function(){return dbg_log("3C0 read16",LOG_VGA),255&this.port3C0_read()|this.port3C1_read()<<8&65280},VGAScreen.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return dbg_log("3C1 / internal palette read: "+h(this.attribute_controller_index)+" -> "+h(this.dac_map[this.attribute_controller_index]),LOG_VGA),this.dac_map[this.attribute_controller_index];switch(this.attribute_controller_index){case 16:return dbg_log("3C1 / attribute mode read: "+h(this.attribute_mode),LOG_VGA),this.attribute_mode;case 18:return dbg_log("3C1 / color plane enable read: "+h(this.color_plane_enable),LOG_VGA),this.color_plane_enable;case 19:return dbg_log("3C1 / horizontal panning read: "+h(this.horizontal_panning),LOG_VGA),this.horizontal_panning;case 20:return dbg_log("3C1 / color select read: "+h(this.color_select),LOG_VGA),this.color_select;default:dbg_log("3C1 / attribute controller read "+h(this.attribute_controller_index),LOG_VGA)}return-1},VGAScreen.prototype.port3C2_write=function(e){dbg_log("3C2 / miscellaneous output register = "+h(e),LOG_VGA),this.miscellaneous_output_register=e},VGAScreen.prototype.port3C4_write=function(e){this.sequencer_index=e},VGAScreen.prototype.port3C4_read=function(){return this.sequencer_index},VGAScreen.prototype.port3C5_write=function(e){switch(this.sequencer_index){case 1:dbg_log("clocking mode: "+h(e),LOG_VGA);var t=this.clocking_mode;this.clocking_mode=e,32&(t^e)&&this.update_layers();break;case 2:dbg_log("plane write mask: "+h(e),LOG_VGA),this.plane_write_bm=e;break;case 4:dbg_log("sequencer memory mode: "+h(e),LOG_VGA),this.sequencer_memory_mode=e;break;default:dbg_log("3C5 / sequencer write "+h(this.sequencer_index)+": "+h(e),LOG_VGA)}},VGAScreen.prototype.port3C5_read=function(){switch(dbg_log("3C5 / sequencer read "+h(this.sequencer_index),LOG_VGA),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0},VGAScreen.prototype.port3C7_write=function(e){dbg_log("3C7 write: "+h(e),LOG_VGA),this.dac_color_index_read=3*e,this.dac_state&=0},VGAScreen.prototype.port3C7_read=function(){return this.dac_state},VGAScreen.prototype.port3C8_write=function(e){this.dac_color_index_write=3*e,this.dac_state|=3},VGAScreen.prototype.port3C8_read=function(){return this.dac_color_index_write/3|0},VGAScreen.prototype.port3C9_write=function(e){var t=this.dac_color_index_write/3|0,r=this.dac_color_index_write%3,s=this.vga256_palette[t];e=255*(63&e)/63|0,0===r?s=-16711681&s|e<<16:1===r?s=-65281&s|e<<8:(s=-256&s|e,dbg_log("dac set color, index="+h(t)+" value="+h(s),LOG_VGA)),this.vga256_palette[t]!==s&&(this.vga256_palette[t]=s,this.complete_redraw()),this.dac_color_index_write++},VGAScreen.prototype.port3C9_read=function(){dbg_log("3C9 read",LOG_VGA);var e=this.dac_color_index_read%3,t=this.vga256_palette[this.dac_color_index_read/3|0];return this.dac_color_index_read++,(t>>8*(2-e)&255)/255*63|0},VGAScreen.prototype.port3CC_read=function(){return dbg_log("3CC read",LOG_VGA),this.miscellaneous_output_register},VGAScreen.prototype.port3CE_write=function(e){this.graphics_index=e},VGAScreen.prototype.port3CE_read=function(){return this.graphics_index},VGAScreen.prototype.port3CF_write=function(e){switch(this.graphics_index){case 0:this.planar_setreset=e,dbg_log("plane set/reset: "+h(e),LOG_VGA);break;case 1:this.planar_setreset_enable=e,dbg_log("plane set/reset enable: "+h(e),LOG_VGA);break;case 2:this.color_compare=e,dbg_log("color compare: "+h(e),LOG_VGA);break;case 3:this.planar_rotate_reg=e,dbg_log("plane rotate: "+h(e),LOG_VGA);break;case 4:this.plane_read=e,dbg_log("plane read: "+h(e),LOG_VGA);break;case 5:var t=this.planar_mode;this.planar_mode=e,dbg_log("planar mode: "+h(e),LOG_VGA),96&(t^e)&&this.complete_replot();break;case 6:dbg_log("miscellaneous graphics register: "+h(e),LOG_VGA),this.miscellaneous_graphics_register!==e&&(this.miscellaneous_graphics_register=e,this.update_vga_size());break;case 7:this.color_dont_care=e,dbg_log("color don't care: "+h(e),LOG_VGA);break;case 8:this.planar_bitmap=e,dbg_log("planar bitmap: "+h(e),LOG_VGA);break;default:dbg_log("3CF / graphics write "+h(this.graphics_index)+": "+h(e),LOG_VGA)}},VGAScreen.prototype.port3CF_read=function(){switch(dbg_log("3CF / graphics read "+h(this.graphics_index),LOG_VGA),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0},VGAScreen.prototype.port3D4_write=function(e){dbg_log("3D4 / crtc index: "+e,LOG_VGA),this.index_crtc=e},VGAScreen.prototype.port3D4_read=function(){return dbg_log("3D4 read / crtc index: "+this.index_crtc,LOG_VGA),this.index_crtc},VGAScreen.prototype.port3D5_write=function(e){switch(this.index_crtc){case 1:dbg_log("3D5 / hdisp enable end write: "+h(e),LOG_VGA),this.horizontal_display_enable_end!==e&&(this.horizontal_display_enable_end=e,this.update_vga_size());break;case 2:this.horizontal_blank_start!==e&&(this.horizontal_blank_start=e,this.update_vga_size());break;case 7:dbg_log("3D5 / overflow register write: "+h(e),LOG_VGA);var t=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|e<<3&512|e<<7&256,t!=this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=767&this.line_compare|e<<4&256,t=this.vertical_blank_start,this.vertical_blank_start=767&this.vertical_blank_start|e<<5&256,t!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:dbg_log("3D5 / preset row scan write: "+h(e),LOG_VGA),this.preset_row_scan=e,this.update_layers();break;case 9:dbg_log("3D5 / max scan line write: "+h(e),LOG_VGA),this.max_scan_line=e,this.line_compare=511&this.line_compare|e<<3&512,t=this.vertical_blank_start,this.vertical_blank_start=511&this.vertical_blank_start|e<<4&512,t!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 10:dbg_log("3D5 / cursor scanline start write: "+h(e),LOG_VGA),this.cursor_scanline_start=e,this.update_cursor_scanline();break;case 11:dbg_log("3D5 / cursor scanline end write: "+h(e),LOG_VGA),this.cursor_scanline_end=e,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==e&&(this.start_address=255&this.start_address|e<<8,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),dbg_log("3D5 / start addr hi write: "+h(e)+" -> "+h(this.start_address,4),LOG_VGA);break;case 13:(255&this.start_address)!==e&&(this.start_address=65280&this.start_address|e,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),dbg_log("3D5 / start addr lo write: "+h(e)+" -> "+h(this.start_address,4),LOG_VGA);break;case 14:dbg_log("3D5 / cursor address hi write: "+h(e),LOG_VGA),this.cursor_address=255&this.cursor_address|e<<8,this.update_cursor();break;case 15:dbg_log("3D5 / cursor address lo write: "+h(e),LOG_VGA),this.cursor_address=65280&this.cursor_address|e,this.update_cursor();break;case 18:dbg_log("3D5 / vdisp enable end write: "+h(e),LOG_VGA),(255&this.vertical_display_enable_end)!==e&&(this.vertical_display_enable_end=768&this.vertical_display_enable_end|e,this.update_vga_size());break;case 19:dbg_log("3D5 / offset register write: "+h(e),LOG_VGA),this.offset_register!==e&&(this.offset_register=e,this.update_vga_size(),3&~this.crtc_mode&&this.complete_replot());break;case 20:dbg_log("3D5 / underline location write: "+h(e),LOG_VGA),this.underline_location_register!==e&&(t=this.underline_location_register,this.underline_location_register=e,this.update_vga_size(),64&(t^e)&&this.complete_replot());break;case 21:dbg_log("3D5 / vertical blank start write: "+h(e),LOG_VGA),(255&this.vertical_blank_start)!==e&&(this.vertical_blank_start=768&this.vertical_blank_start|e,this.update_vga_size());break;case 23:dbg_log("3D5 / crtc mode write: "+h(e),LOG_VGA),this.crtc_mode!==e&&(t=this.crtc_mode,this.crtc_mode=e,this.update_vga_size(),67&(t^e)&&this.complete_replot());break;case 24:dbg_log("3D5 / line compare write: "+h(e),LOG_VGA),this.line_compare=768&this.line_compare|e,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=e),dbg_log("3D5 / CRTC write "+h(this.index_crtc)+": "+h(e),LOG_VGA)}},VGAScreen.prototype.port3D5_read=function(){switch(dbg_log("3D5 read "+h(this.index_crtc),LOG_VGA),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return 255&this.start_address;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return 255&this.cursor_address;case 18:return 255&this.vertical_display_enable_end;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return 255&this.vertical_blank_start;case 23:return this.crtc_mode;case 24:return 255&this.line_compare}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0},VGAScreen.prototype.port3DA_read=function(){dbg_log("3DA read - status 1 and clear attr index",LOG_VGA);var e=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(1&this.port_3DA_value&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,e},VGAScreen.prototype.svga_bytes_per_line=function(){return this.svga_width*(15===this.svga_bpp?16:this.svga_bpp)/8},VGAScreen.prototype.port1CE_write=function(e){this.dispi_index=e},VGAScreen.prototype.port1CF_write=function(e){switch(dbg_log("1CF / dispi write "+h(this.dispi_index)+": "+h(e),LOG_VGA),this.dispi_index){case 1:this.svga_width=e,this.svga_width>MAX_XRES&&(dbg_log("svga_width reduced from "+this.svga_width+" to "+MAX_XRES,LOG_VGA),this.svga_width=MAX_XRES);break;case 2:this.svga_height=e,this.svga_height>MAX_YRES&&(dbg_log("svga_height reduced from "+this.svga_height+" to "+MAX_YRES,LOG_VGA),this.svga_height=MAX_YRES);break;case 3:this.svga_bpp=e;break;case 4:this.svga_enabled=1==(1&e),this.dispi_enable_value=e;break;case 5:this.svga_bank_offset=e<<16;break;case 9:this.svga_offset=e*this.svga_bytes_per_line(),dbg_log("SVGA offset: "+h(this.svga_offset)+" y="+h(e),LOG_VGA),this.complete_redraw()}!this.svga_enabled||this.svga_width&&this.svga_height||(dbg_log("SVGA: disabled because of invalid width/height: "+this.svga_width+"x"+this.svga_height,LOG_VGA),this.svga_enabled=!1),dbg_assert(4!==this.svga_bpp,"unimplemented svga bpp: 4"),dbg_assert(15!==this.svga_bpp,"unimplemented svga bpp: 15"),dbg_assert(4===this.svga_bpp||8===this.svga_bpp||15===this.svga_bpp||16===this.svga_bpp||24===this.svga_bpp||32===this.svga_bpp,"unexpected svga bpp: "+this.svga_bpp),dbg_log("SVGA: enabled="+this.svga_enabled+", "+this.svga_width+"x"+this.svga_height+"x"+this.svga_bpp,LOG_VGA),this.svga_enabled&&4===this.dispi_index&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()},VGAScreen.prototype.port1CF_read=function(){return dbg_log("1CF / dispi read "+h(this.dispi_index),LOG_VGA),this.svga_register_read(this.dispi_index)},VGAScreen.prototype.svga_register_read=function(e){switch(e){case 0:return 45248;case 1:return 2&this.dispi_enable_value?MAX_XRES:this.svga_width;case 2:return 2&this.dispi_enable_value?MAX_YRES:this.svga_height;case 3:return 2&this.dispi_enable_value?MAX_BPP:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 10:return this.vga_memory_size/VGA_BANK_SIZE|0}return 255},VGAScreen.prototype.vga_replot=function(){for(var e=-16&this.diff_plot_min,t=Math.min(15|this.diff_plot_max,VGA_PIXEL_BUFFER_SIZE-1),r=this.vga_addr_shift_count(),s=3&~this.crtc_mode,i=96&this.planar_mode,_=64&this.attribute_mode;e<=t;){var a=e>>>r;if(s){var o=e/this.virtual_width|0,n=e-this.virtual_width*o;switch(s){case 1:a=(1&o)<<13,o>>>=1;break;case 2:a=(1&o)<<14,o>>>=1;break;case 3:a=(3&o)<<13,o>>>=2}a|=(o*this.virtual_width+n>>>r)+this.start_address}o=this.plane0[a],n=this.plane1[a];var d=this.plane2[a],h=this.plane3[a];switch(a=new Uint8Array(8),i){case 0:o<<=0,n<<=1,d<<=2,h<<=3;for(var g=7;0<=g;g--)a[7-g]=o>>g&1|n>>g&2|d>>g&4|h>>g&8;break;case 32:a[0]=o>>6&3|d>>4&12,a[1]=o>>4&3|d>>2&12,a[2]=o>>2&3|d>>0&12,a[3]=o>>0&3|d<<2&12,a[4]=n>>6&3|h>>4&12,a[5]=n>>4&3|h>>2&12,a[6]=n>>2&3|h>>0&12,a[7]=n>>0&3|h<<2&12;break;case 64:case 96:a[0]=o>>4&15,a[1]=o>>0&15,a[2]=n>>4&15,a[3]=n>>0&15,a[4]=d>>4&15,a[5]=d>>0&15,a[6]=h>>4&15,a[7]=h>>0&15}if(_)for(o=g=0;4>g;g++,e++,o+=2)this.pixel_buffer[e]=a[o]<<4|a[o+1];else for(g=0;8>g;g++,e++)this.pixel_buffer[e]=a[g]}},VGAScreen.prototype.vga_redraw=function(){var e=this.diff_addr_min,t=Math.min(this.diff_addr_max,VGA_PIXEL_BUFFER_SIZE-1),r=this.dest_buffer;if(r){var s=255,i=0;if(128&this.attribute_mode&&(s&=207,i|=this.color_select<<4&48),64&this.attribute_mode)for(;e<=t;e++){var _=this.pixel_buffer[e]&s|i;_=this.vga256_palette[_],r[e]=65280&_|_<<16|_>>16|4278190080}else for(s&=63,i|=this.color_select<<4&192;e<=t;e++)_=this.dac_map[this.pixel_buffer[e]&this.color_plane_enable]&s|i,_=this.vga256_palette[_],r[e]=65280&_|_<<16|_>>16|4278190080}},VGAScreen.prototype.screen_fill_buffer=function(){if(this.graphical_mode)if(this.dest_buffer)if(this.diff_addr_max<this.diff_addr_min&&this.diff_plot_max<this.diff_plot_min)this.bus.send("screen-fill-buffer-end",this.layers);else{if(this.svga_enabled){var e=this.svga_bpp,t=this.dest_buffer,r=this.diff_addr_min,s=this.diff_addr_max;switch(e){case 32:var i=r>>2,_=1+(s>>2);for(e=i;e<_;e++)s=this.svga_memory32[e],t[e]=s<<16|s>>16&255|65280&s|4278190080;break;case 24:_=1+(s/3|0);var a=3*(i=r/3|0);for(e=i;a<s;e++){var o=this.svga_memory[a++];r=this.svga_memory[a++];var n=this.svga_memory[a++];t[e]=o<<16|r<<8|n|4278190080}break;case 16:for(_=1+(s>>1),e=i=r>>1;e<_;e++)n=255*((s=this.svga_memory16[e])>>11)/31|0,r=255*(s>>5&63)/63|0,o=255*(31&s)/31|0,t[e]=o<<16|r<<8|n|4278190080;break;case 8:for(i=r,_=s+1,e=r;e<=s;e++)r=this.vga256_palette[this.svga_memory[e]],t[e]=65280&r|r<<16|r>>16|4278190080;break;default:dbg_assert(!1,"Unsupported BPP: "+e)}t=i/this.svga_width|0,this.bus.send("screen-fill-buffer-end",[{screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:(_/this.svga_width|0)-t+1}])}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}else dbg_log("Cannot fill buffer: No destination buffer",LOG_VGA);this.update_vertical_retrace()},PS2.prototype.get_state=function(){var e=[];return e[0]=this.enable_mouse_stream,e[1]=this.use_mouse,e[2]=this.have_mouse,e[3]=this.mouse_delta_x,e[4]=this.mouse_delta_y,e[5]=this.mouse_clicks,e[6]=this.have_keyboard,e[7]=this.enable_keyboard_stream,e[8]=this.next_is_mouse_command,e[9]=this.next_read_sample,e[10]=this.next_read_led,e[11]=this.next_handle_scan_code_set,e[12]=this.next_read_rate,e[13]=this.next_read_resolution,e[15]=this.last_port60_byte,e[16]=this.sample_rate,e[17]=this.resolution,e[18]=this.scaling2,e[20]=this.command_register,e[21]=this.read_output_register,e[22]=this.read_command_register,e},PS2.prototype.set_state=function(e){this.enable_mouse_stream=e[0],this.use_mouse=e[1],this.have_mouse=e[2],this.mouse_delta_x=e[3],this.mouse_delta_y=e[4],this.mouse_clicks=e[5],this.have_keyboard=e[6],this.enable_keyboard_stream=e[7],this.next_is_mouse_command=e[8],this.next_read_sample=e[9],this.next_read_led=e[10],this.next_handle_scan_code_set=e[11],this.next_read_rate=e[12],this.next_read_resolution=e[13],this.last_port60_byte=e[15],this.sample_rate=e[16],this.resolution=e[17],this.scaling2=e[18],this.command_register=e[20],this.read_output_register=e[21],this.read_command_register=e[22],this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)},PS2.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())},PS2.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,2&this.command_register&&(dbg_log("Mouse irq",LOG_PS2),this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))},PS2.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,1&this.command_register&&(dbg_log("Keyboard irq",LOG_PS2),this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))},PS2.prototype.kbd_send_code=function(e){this.enable_keyboard_stream&&(dbg_log("adding kbd code: "+h(e),LOG_PS2),this.kbd_buffer.push(e),this.raise_irq())},PS2.prototype.mouse_send_delta=function(e,t){if(this.have_mouse&&this.use_mouse){var r=this.resolution*this.sample_rate/80;this.mouse_delta_x+=e*r,this.mouse_delta_y+=t*r,this.enable_mouse_stream&&(e=0|this.mouse_delta_x,t=0|this.mouse_delta_y,e||t)&&(Date.now(),this.mouse_delta_x-=e,this.mouse_delta_y-=t,this.send_mouse_packet(e,t))}},PS2.prototype.mouse_send_click=function(e,t,r){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=e|r<<1|t<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))},PS2.prototype.send_mouse_packet=function(e,t){var r=(0>t)<<5|(0>e)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(r),this.mouse_buffer.push(e),this.mouse_buffer.push(t),dbg_log("adding mouse packets: "+[r,e,t],LOG_PS2),this.raise_irq()},PS2.prototype.apply_scaling2=function(e){var t=e>>31;switch(Math.abs(e)){case 0:case 1:case 3:return e;case 2:return t;case 4:return 6*t;case 5:return 9*t;default:return e<<1}},PS2.prototype.port60_read=function(){return this.next_byte_is_ready=!1,this.kbd_buffer.length||this.mouse_buffer.length?(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift(),dbg_log("Port 60 read (mouse): "+h(this.last_port60_byte),LOG_PS2)):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift(),dbg_log("Port 60 read (kbd)  : "+h(this.last_port60_byte),LOG_PS2)),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte):(dbg_log("Port 60 read: Empty",LOG_PS2),this.last_port60_byte)},PS2.prototype.port64_read=function(){var e=16;return this.next_byte_is_ready&&(e|=1),this.next_byte_is_aux&&(e|=32),dbg_log("port 64 read: "+h(e),LOG_PS2),e},PS2.prototype.port60_write=function(e){if(dbg_log("port 60 write: "+h(e),LOG_PS2),this.read_command_register)this.command_register=e,this.read_command_register=!1,dbg_log("Keyboard command register = "+h(this.command_register),LOG_PS2);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(e),this.mouse_irq();else if(this.next_read_sample)this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=e,dbg_log("mouse sample rate: "+h(e),LOG_PS2),this.sample_rate||(dbg_log("invalid sample rate, reset to 100",LOG_PS2),this.sample_rate=100),this.mouse_irq();else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),3<e?(this.resolution=4,dbg_log("invalid resolution, resetting to 4",LOG_PS2)):(this.resolution=1<<e,dbg_log("resolution: "+this.resolution,LOG_PS2)),this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),e||this.kbd_buffer.push(2);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,dbg_log("Port 60 data register write: "+h(e),LOG_PS2),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),e){case 230:dbg_log("Scaling 1:1",LOG_PS2),this.scaling2=!1;break;case 231:dbg_log("Scaling 2:1",LOG_PS2),this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:dbg_log("unimplemented request single packet",LOG_PS2),this.send_mouse_packet(0,0);break;case 242:this.mouse_buffer.push(0),this.mouse_buffer.push(0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:dbg_log("Mouse reset",LOG_PS2),this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:dbg_log("Unimplemented mouse command: "+h(e),LOG_PS2)}this.mouse_irq()}}else{switch(dbg_log("Port 60 data register write: "+h(e),LOG_PS2),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),e){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(83);break;case 243:this.next_read_rate=!0;break;case 244:dbg_log("kbd enable scanning",LOG_PS2),this.enable_keyboard_stream=!0;break;case 245:dbg_log("kbd disable scanning",LOG_PS2),this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:dbg_log("Unimplemented keyboard command: "+h(e),LOG_PS2)}this.kbd_irq()}},PS2.prototype.port64_write=function(e){switch(dbg_log("port 64 write: "+h(e),LOG_PS2),e){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:dbg_log("Disable second port",LOG_PS2),this.command_register|=32;break;case 168:dbg_log("Enable second port",LOG_PS2),this.command_register&=-33;break;case 169:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 173:dbg_log("Disable Keyboard",LOG_PS2),this.command_register|=16;break;case 174:dbg_log("Enable Keyboard",LOG_PS2),this.command_register&=-17;break;case 254:dbg_log("CPU reboot via PS2"),this.cpu.reboot_internal();break;default:dbg_log("port 64: Unimplemented command byte: "+h(e),LOG_PS2)}};var PIC_LOG_VERBOSE=!1;function PIC(e,t){this.irq_value=this.irr=this.isr=this.irq_map=this.irq_mask=0,this.requested_irq=-1,this.master=t,this.is_master=void 0===this.master,this.slave=void 0,this.name=this.is_master?"master":"slave ",this.expect_icw4=!1,this.read_isr=this.state=0,this.auto_eoi=1,this.elcr=this.special_mask_mode=0,this.cpu=e,this.is_master?(this.slave=new PIC(this.cpu,this),this.check_irqs=function(){if(0<=this.requested_irq)PIC_LOG_VERBOSE&&dbg_log("master> Already requested irq: "+this.requested_irq,LOG_PIC),this.cpu.handle_irqs();else{var e=this.irr&this.irq_mask;if(e){e&=-e;var t=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&t)<=e?dbg_log("master> higher prio: isr="+h(this.isr,2)+" mask="+h(255&this.irq_mask,2)+" irq="+h(e,2),LOG_PIC):(dbg_assert(0!==e),dbg_assert(e===1<<(t=v86util.int_log2_byte(e))),PIC_LOG_VERBOSE&&dbg_log("master> request irq "+t,LOG_PIC),this.requested_irq=t,this.cpu.handle_irqs())}else PIC_LOG_VERBOSE&&dbg_log("master> no unmasked irrs. irr="+h(this.irr,2)+" mask="+h(255&this.irq_mask,2)+" isr="+h(this.isr,2),LOG_PIC)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)PIC_LOG_VERBOSE&&dbg_log("master> spurious requested="+this.requested_irq,LOG_PIC),this.requested_irq=-1,this.cpu.pic_call_irq(7|this.irq_map);else{dbg_assert(this.irr),dbg_assert(0<=this.requested_irq);var e=1<<this.requested_irq;0==(this.elcr&e)&&(this.irr&=~e),this.auto_eoi||(this.isr|=e),PIC_LOG_VERBOSE&&dbg_log("master> acknowledge "+this.requested_irq,LOG_PIC),2===this.requested_irq?this.slave.acknowledge_irq():this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}):(this.check_irqs=function(){if(0<=this.requested_irq)PIC_LOG_VERBOSE&&dbg_log("slave > Already requested irq: "+this.requested_irq,LOG_PIC),this.cpu.handle_irqs();else{var e=this.irr&this.irq_mask;if(e){e&=-e;var t=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&t)<=e?PIC_LOG_VERBOSE&&dbg_log("slave > higher prio: isr="+h(this.isr,2)+" irq="+h(e,2),LOG_PIC):(dbg_assert(0!==e),dbg_assert(e===1<<(t=v86util.int_log2_byte(e))),PIC_LOG_VERBOSE&&dbg_log("slave > request irq "+t,LOG_PIC),this.requested_irq=t,this.master.set_irq(2))}else PIC_LOG_VERBOSE&&dbg_log("slave > no unmasked irrs. irr="+h(this.irr,2)+" mask="+h(255&this.irq_mask,2)+" isr="+h(this.isr,2),LOG_PIC)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)PIC_LOG_VERBOSE&&dbg_log("slave > spurious requested="+this.requested_irq,LOG_PIC),this.requested_irq=-1,this.master.irq_value&=-5,this.cpu.pic_call_irq(7|this.irq_map);else{dbg_assert(this.irr),dbg_assert(0<=this.requested_irq);var e=1<<this.requested_irq;0==(this.elcr&e)&&(this.irr&=~e),this.auto_eoi||(this.isr|=e),this.master.irq_value&=-5,PIC_LOG_VERBOSE&&dbg_log("slave > acknowledge "+this.requested_irq,LOG_PIC),this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}),this.dump=function(){dbg_log("mask: "+h(255&this.irq_mask),LOG_PIC),dbg_log("base: "+h(this.irq_map),LOG_PIC),dbg_log("requested: "+h(this.irr),LOG_PIC),dbg_log("serviced: "+h(this.isr),LOG_PIC),this.is_master&&this.slave.dump()},this.is_master?(e=32,t=1232):(e=160,t=1233),this.cpu.io.register_write(e,this,this.port20_write),this.cpu.io.register_read(e,this,this.port20_read),this.cpu.io.register_write(1|e,this,this.port21_write),this.cpu.io.register_read(1|e,this,this.port21_read),this.cpu.io.register_write(t,this,this.port4D0_write),this.cpu.io.register_read(t,this,this.port4D0_read),this.is_master?(this.set_irq=function(e){dbg_assert(0<=e&&16>e),8<=e?this.slave.set_irq(e-8):(PIC_LOG_VERBOSE&&dbg_log("master> set irq "+e,LOG_PIC),e=1<<e,0==(this.irq_value&e)&&(this.irr|=e,this.irq_value|=e,this.check_irqs()))},this.clear_irq=function(e){dbg_assert(0<=e&&16>e),PIC_LOG_VERBOSE&&dbg_log("master> clear irq "+e,LOG_PIC),8<=e?this.slave.clear_irq(e-8):(e=1<<e,this.irq_value&e&&(this.irq_value&=~e,this.irr&=~e,this.check_irqs()))}):(this.set_irq=function(e){dbg_assert(0<=e&&8>e),PIC_LOG_VERBOSE&&dbg_log("slave > set irq "+e,LOG_PIC),e=1<<e,0==(this.irq_value&e)&&(this.irr|=e,this.irq_value|=e,this.check_irqs())},this.clear_irq=function(e){dbg_assert(0<=e&&8>e),PIC_LOG_VERBOSE&&dbg_log("slave > clear irq "+e,LOG_PIC),e=1<<e,this.irq_value&e&&(this.irq_value&=~e,this.irr&=~e,this.check_irqs())}),this.get_isr=function(){return this.isr}}PIC.prototype.get_state=function(){var e=[];return e[0]=this.irq_mask,e[1]=this.irq_map,e[2]=this.isr,e[3]=this.irr,e[4]=this.is_master,e[5]=this.slave,e[6]=this.expect_icw4,e[7]=this.state,e[8]=this.read_isr,e[9]=this.auto_eoi,e[10]=this.elcr,e},PIC.prototype.set_state=function(e){this.irq_mask=e[0],this.irq_map=e[1],this.isr=e[2],this.irr=e[3],this.is_master=e[4],this.slave=e[5],this.expect_icw4=e[6],this.state=e[7],this.read_isr=e[8],this.auto_eoi=e[9],this.elcr=e[10]},PIC.prototype.port20_write=function(e){if(16&e)dbg_log("icw1 = "+h(e),LOG_PIC),this.irq_value=this.irq_mask=this.irr=this.isr=0,this.auto_eoi=1,this.requested_irq=-1,this.expect_icw4=1&e,this.state=1;else if(8&e)dbg_log("ocw3: "+h(e),LOG_PIC),2&e&&(this.read_isr=1&e),4&e&&dbg_assert(!1,"unimplemented: polling",LOG_PIC),64&e&&(this.special_mask_mode=32==(32&e),dbg_log("special mask mode: "+this.special_mask_mode,LOG_PIC));else{dbg_log("eoi: "+h(e)+" ("+this.name+")",LOG_PIC);var t=e>>5;1===t?(this.isr&=this.isr-1,dbg_log("new isr: "+h(this.isr,2),LOG_PIC)):3===t?this.isr&=~(1<<(7&e)):192==(200&e)?dbg_log("lowest priority: "+h(7&e),LOG_PIC):(dbg_log("Unknown eoi: "+h(e),LOG_PIC),dbg_assert(!1),this.isr&=this.isr-1),this.check_irqs()}},PIC.prototype.port20_read=function(){return this.read_isr?(dbg_log("read port 20h (isr): "+h(this.isr),LOG_PIC),this.isr):(dbg_log("read port 20h (irr): "+h(this.irr),LOG_PIC),this.irr)},PIC.prototype.port21_write=function(e){0===this.state?this.expect_icw4?(this.expect_icw4=!1,this.auto_eoi=2&e,dbg_log("icw4: "+h(e)+" autoeoi="+this.auto_eoi,LOG_PIC),0==(1&e)&&dbg_assert(!1,"unimplemented: not 8086 mode",LOG_PIC)):(this.irq_mask=~e,PIC_LOG_VERBOSE&&dbg_log("interrupt mask: "+(255&this.irq_mask).toString(2)+" ("+this.name+")",LOG_PIC),this.check_irqs()):1===this.state?(this.irq_map=e,dbg_log("interrupts are mapped to "+h(this.irq_map)+" ("+this.name+")",LOG_PIC),this.state++):2===this.state&&(this.state=0,dbg_log("icw3: "+h(e),LOG_PIC))},PIC.prototype.port21_read=function(){return dbg_log("21h read "+h(255&~this.irq_mask),LOG_PIC),255&~this.irq_mask},PIC.prototype.port4D0_read=function(){return dbg_log("elcr read: "+h(this.elcr,2),LOG_PIC),this.elcr},PIC.prototype.port4D0_write=function(e){dbg_log("elcr write: "+h(e,2),LOG_PIC),this.elcr=e};var CMOS_RTC_SECONDS=0,CMOS_RTC_SECONDS_ALARM=1,CMOS_RTC_MINUTES=2,CMOS_RTC_MINUTES_ALARM=3,CMOS_RTC_HOURS=4,CMOS_RTC_HOURS_ALARM=5,CMOS_RTC_DAY_WEEK=6,CMOS_RTC_DAY_MONTH=7,CMOS_RTC_MONTH=8,CMOS_RTC_YEAR=9,CMOS_STATUS_A=10,CMOS_STATUS_B=11,CMOS_STATUS_C=12,CMOS_STATUS_D=13,CMOS_RESET_CODE=15,CMOS_FLOPPY_DRIVE_TYPE=16,CMOS_DISK_DATA=18,CMOS_EQUIPMENT_INFO=20,CMOS_MEM_BASE_LOW=21,CMOS_MEM_BASE_HIGH=22,CMOS_MEM_OLD_EXT_LOW=23,CMOS_MEM_OLD_EXT_HIGH=24,CMOS_DISK_DRIVE1_TYPE=25,CMOS_DISK_DRIVE2_TYPE=26,CMOS_DISK_DRIVE1_CYL=27,CMOS_DISK_DRIVE2_CYL=36,CMOS_MEM_EXTMEM_LOW=48,CMOS_MEM_EXTMEM_HIGH=49,CMOS_CENTURY=50,CMOS_MEM_EXTMEM2_LOW=52,CMOS_MEM_EXTMEM2_HIGH=53,CMOS_BIOS_BOOTFLAG1=56,CMOS_BIOS_DISKTRANSFLAG=57,CMOS_BIOS_BOOTFLAG2=61,CMOS_MEM_HIGHMEM_LOW=91,CMOS_MEM_HIGHMEM_MID=92,CMOS_MEM_HIGHMEM_HIGH=93,CMOS_BIOS_SMP_COUNT=95;function RTC(e){this.cpu=e,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,e.io.register_write(112,this,function(e){this.cmos_index=127&e,this.nmi_disabled=e>>7}),e.io.register_write(113,this,this.cmos_port_write),e.io.register_read(113,this,this.cmos_port_read)}RTC.prototype.get_state=function(){var e=[];return e[0]=this.cmos_index,e[1]=this.cmos_data,e[2]=this.rtc_time,e[3]=this.last_update,e[4]=this.next_interrupt,e[6]=this.periodic_interrupt,e[7]=this.periodic_interrupt_time,e[8]=this.cmos_a,e[9]=this.cmos_b,e[10]=this.cmos_c,e[11]=this.nmi_disabled,e},RTC.prototype.set_state=function(e){this.cmos_index=e[0],this.cmos_data=e[1],this.rtc_time=e[2],this.last_update=e[3],this.next_interrupt=e[4],this.periodic_interrupt=e[6],this.periodic_interrupt_time=e[7],this.cmos_a=e[8],this.cmos_b=e[9],this.cmos_c=e[10],this.nmi_disabled=e[11]},RTC.prototype.timer=function(e,t){return e=Date.now(),this.rtc_time+=e-this.last_update,this.last_update=e,this.periodic_interrupt&&this.next_interrupt<e?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((e-this.next_interrupt)/this.periodic_interrupt_time),Math.max(0,e-this.next_interrupt)):100},RTC.prototype.bcd_pack=function(e){for(var t,r=0,s=0;e;)s|=(t=e%10)<<4*r,r++,e=(e-t)/10;return s},RTC.prototype.encode_time=function(e){return 4&this.cmos_b?e:this.bcd_pack(e)},RTC.prototype.cmos_port_read=function(){var e=this.cmos_index;switch(e){case CMOS_RTC_SECONDS:return this.encode_time(new Date(this.rtc_time).getUTCSeconds());case CMOS_RTC_MINUTES:return this.encode_time(new Date(this.rtc_time).getUTCMinutes());case CMOS_RTC_HOURS:return this.encode_time(new Date(this.rtc_time).getUTCHours());case CMOS_RTC_DAY_MONTH:return this.encode_time(new Date(this.rtc_time).getUTCDate());case CMOS_RTC_MONTH:return this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case CMOS_RTC_YEAR:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case CMOS_STATUS_A:return this.cmos_a;case CMOS_STATUS_B:return this.cmos_b;case CMOS_STATUS_C:return this.cpu.device_lower_irq(8),dbg_log("cmos reg C read",LOG_RTC),e=this.cmos_c,this.cmos_c&=-241,e;case CMOS_STATUS_D:return 255;case CMOS_CENTURY:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return dbg_log("cmos read from index "+h(e),LOG_RTC),this.cmos_data[this.cmos_index]}},RTC.prototype.cmos_port_write=function(e){switch(this.cmos_index){case 10:this.cmos_a=127&e,this.periodic_interrupt_time=1e3/(32768>>(15&this.cmos_a)-1),dbg_log("Periodic interrupt, a="+h(this.cmos_a,2)+" t="+this.periodic_interrupt_time,LOG_RTC);break;case 11:this.cmos_b=e,64&this.cmos_b&&(this.next_interrupt=Date.now()),32&this.cmos_b&&dbg_log("Unimplemented: alarm interrupt",LOG_RTC),16&this.cmos_b&&dbg_log("Unimplemented: updated interrupt",LOG_RTC),dbg_log("cmos b="+h(this.cmos_b,2),LOG_RTC);break;default:dbg_log("cmos write index "+h(this.cmos_index)+": "+h(e),LOG_RTC)}this.periodic_interrupt=64==(64&this.cmos_b)&&0<(15&this.cmos_a)},RTC.prototype.cmos_read=function(e){return dbg_assert(128>e),this.cmos_data[e]},RTC.prototype.cmos_write=function(e,t){dbg_log("cmos "+h(e)+" <- "+h(t),LOG_RTC),dbg_assert(128>e),this.cmos_data[e]=t};var DLAB=128,UART_IER_MSI=8,UART_IER_THRI=2,UART_IER_RDI=1,UART_IIR_MSI=0,UART_IIR_NO_INT=1,UART_IIR_THRI=2,UART_IIR_RDI=4,UART_IIR_RLSI=6,UART_IIR_CTI=12,UART_LSR_DATA_READY=1,UART_LSR_TX_EMPTY=32,UART_LSR_TRANSMITTER_EMPTY=64;function UART(e,t,r){if(this.bus=r,this.cpu=e,this.ints=1<<UART_IIR_THRI,this.line_control=this.baud_rate=0,this.lsr=UART_LSR_TRANSMITTER_EMPTY|UART_LSR_TX_EMPTY,this.ier=this.fifo_control=0,this.iir=UART_IIR_NO_INT,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=new ByteQueue(4096),this.current_line=[],1e3===t||1016===t)this.irq=4;else{if(1e3!==t&&1e3!==t)return void dbg_log("Invalid port: "+h(t),LOG_SERIAL);this.irq=3}this.bus.register("serial0-input",function(e){this.data_received(e)},this),(e=e.io).register_write(t,this,function(e){this.write_data(e)},function(e){this.write_data(255&e),this.write_data(e>>8)}),e.register_write(1|t,this,function(e){this.line_control&DLAB?(this.baud_rate=255&this.baud_rate|e<<8,dbg_log("baud rate: "+h(this.baud_rate),LOG_SERIAL)):(this.ier=15&e,dbg_log("interrupt enable: "+h(e),LOG_SERIAL),this.CheckInterrupt())}),e.register_read(t,this,function(){if(this.line_control&DLAB)return 255&this.baud_rate;var e=this.input.shift();return dbg_log(-1===e?"Read input empty":"Read input: "+h(e),LOG_SERIAL),0===this.input.length&&(this.lsr&=~UART_LSR_DATA_READY,this.ClearInterrupt(UART_IIR_CTI)),e}),e.register_read(1|t,this,function(){return this.line_control&DLAB?this.baud_rate>>8:15&this.ier}),e.register_read(2|t,this,function(){var e=15&this.iir|192;return dbg_log("read interrupt identification: "+h(this.iir),LOG_SERIAL),this.iir==UART_IIR_THRI&&this.ClearInterrupt(UART_IIR_THRI),e}),e.register_write(2|t,this,function(e){dbg_log("fifo control: "+h(e),LOG_SERIAL),this.fifo_control=e}),e.register_read(3|t,this,function(){return dbg_log("read line control: "+h(this.line_control),LOG_SERIAL),this.line_control}),e.register_write(3|t,this,function(e){dbg_log("line control: "+h(e),LOG_SERIAL),this.line_control=e}),e.register_read(4|t,this,function(){return this.modem_control}),e.register_write(4|t,this,function(e){dbg_log("modem control: "+h(e),LOG_SERIAL),this.modem_control=e}),e.register_read(5|t,this,function(){return dbg_log("read line status: "+h(this.lsr),LOG_SERIAL),this.lsr}),e.register_write(5|t,this,function(e){dbg_log("Factory test write",LOG_SERIAL)}),e.register_read(6|t,this,function(){return dbg_log("read modem status: "+h(this.modem_status),LOG_SERIAL),this.modem_status}),e.register_write(6|t,this,function(e){dbg_log("Unkown register write (base+6)",LOG_SERIAL)}),e.register_read(7|t,this,function(){return this.scratch_register}),e.register_write(7|t,this,function(e){this.scratch_register=e})}UART.prototype.get_state=function(){var e=[];return e[0]=this.ints,e[1]=this.baud_rate,e[2]=this.line_control,e[3]=this.lsr,e[4]=this.fifo_control,e[5]=this.ier,e[6]=this.iir,e[7]=this.modem_control,e[8]=this.modem_status,e[9]=this.scratch_register,e[10]=this.irq,e},UART.prototype.set_state=function(e){this.ints=e[0],this.baud_rate=e[1],this.line_control=e[2],this.lsr=e[3],this.fifo_control=e[4],this.ier=e[5],this.iir=e[6],this.modem_control=e[7],this.modem_status=e[8],this.scratch_register=e[9],this.irq=e[10]},UART.prototype.CheckInterrupt=function(){this.ints&1<<UART_IIR_CTI&&this.ier&UART_IER_RDI?(this.iir=UART_IIR_CTI,this.cpu.device_raise_irq(this.irq)):this.ints&1<<UART_IIR_THRI&&this.ier&UART_IER_THRI?(this.iir=UART_IIR_THRI,this.cpu.device_raise_irq(this.irq)):this.ints&1<<UART_IIR_MSI&&this.ier&UART_IER_MSI?(this.iir=UART_IIR_MSI,this.cpu.device_raise_irq(this.irq)):(this.iir=UART_IIR_NO_INT,this.cpu.device_lower_irq(this.irq))},UART.prototype.ThrowInterrupt=function(e){this.ints|=1<<e,this.CheckInterrupt()},UART.prototype.ClearInterrupt=function(e){this.ints&=~(1<<e),this.CheckInterrupt()},UART.prototype.data_received=function(e){dbg_log("input: "+h(e),LOG_SERIAL),this.input.push(e),this.lsr|=UART_LSR_DATA_READY,this.ThrowInterrupt(UART_IIR_CTI)},UART.prototype.write_data=function(e){if(this.line_control&DLAB)this.baud_rate=-256&this.baud_rate|e;else if(dbg_log("data: "+h(e),LOG_SERIAL),this.ThrowInterrupt(UART_IIR_THRI),255!==e){var t=String.fromCharCode(e);this.bus.send("serial0-output-char",t),this.current_line.push(e),"\n"===t&&(dbg_log("SERIAL: "+String.fromCharCode.apply("",this.current_line).trimRight()),this.bus.send("serial0-output-line",String.fromCharCode.apply("",this.current_line)),this.current_line=[])}};var HPET_ADDR=4275044352,HPET_PERIOD=1e8,HPET_FREQ_MS=1e12/HPET_PERIOD,HPET_SUPPORT_64=0,HPET_COUNTER_CONFIG=16|HPET_SUPPORT_64<<5,HPET_COUNTER_CONFIG_MASK=32816,HPET_NUM_COUNTERS=4;function HPET(e){function t(){return i?(Date.now()-_)*HPET_FREQ_MS+a|0:a}function r(){return HPET_SUPPORT_64?i?(Date.now()-_)*(HPET_FREQ_MS/4294967296)+o|0:o:0}var s=this,i=!1,_=Date.now(),a=0,o=0,n=!1,d=0,g=new Int32Array(HPET_NUM_COUNTERS<<1),c=new Int32Array(HPET_NUM_COUNTERS<<1),p=new Int32Array(HPET_NUM_COUNTERS<<1),u=0;this.legacy_mode=!1,this.timer=function(r){if(i){r=t()>>>0;for(var s,_,a=0;a<HPET_NUM_COUNTERS;a++)s=g[a<<1],_=c[a<<1]>>>0,(u<=r?_>u&&_<=r:_>u||_<=r)&&(_=4&s,2&s?(_=_&&!(d&1<<a),d|=1<<a):d&=~(1<<a),8&s&&(c[a<<1]+=p[a<<1]),_&&e.device_raise_irq(0));u=r}},e.io.mmap_register(HPET_ADDR,16384,function(e){switch(dbg_log("Read "+h(e,4)+" (ctr="+h(t()>>>0)+")",LOG_HPET),e){case 0:return HPET_NUM_COUNTERS-1<<8|98305|HPET_SUPPORT_64<<13;case 4:return HPET_PERIOD;case 16:return s.legacy_mode<<1|i;case 240:return t();case 244:return r()}var _=e>>2&7,a=e-256>>5;if(256>e||a>=HPET_NUM_COUNTERS||5<_)return dbg_log("Read reserved address: "+h(e),LOG_HPET),0;switch(dbg_log("Read counter: addr="+h(e)+" counter="+h(a,2)+" reg="+h(_),LOG_HPET),_){case 0:return g[a<<1]&~HPET_COUNTER_CONFIG_MASK|HPET_COUNTER_CONFIG;case 1:return g[a<<1|1];case 2:return c[a<<1];case 3:return c[a<<1|1];case 4:case 5:return 0}},function(e,u){switch(dbg_log("Write "+h(e,4)+": "+h(u,2),LOG_HPET),e){case 16:return dbg_log("conf: enabled="+(1&u)+" legacy="+(u>>1&1),LOG_HPET),1&(i^u)&&(1&u?_=Date.now():(a=t(),o=r())),i=1==(1&u),void(s.legacy_mode=2==(2&u));case 32:return void(d&=~u);case 240:return void(a=u);case 244:return void(o=u)}var l=e>>2&7,f=e-256>>5;if(256>e||f>=HPET_NUM_COUNTERS||2<l)dbg_log("Write reserved address: "+h(e)+" data="+h(u),LOG_HPET);else switch(dbg_log("Write counter: addr="+h(e)+" counter="+h(f,2)+" reg="+h(l)+" data="+h(u,2),LOG_HPET),l){case 0:g[f<<1]=u;break;case 2:n?(p[f<<1]=u,n=!1,dbg_log("Accumulator acc="+h(u>>>0,8)+" ctr="+h(f,2),LOG_HPET)):(c[f<<1]=u,64&g[f<<1]&&(n=!0,g[f<<1]&=-65));break;case 3:c[f<<1|1]=u}})}var PMTIMER_FREQ=3579545;function ACPI(e){this.cpu=e;var t=e.io;e.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(v86.microtick()),this.gpe=new Uint8Array(4),t.register_read(45056,this,void 0,function(){return dbg_log("ACPI pm1_status read",LOG_ACPI),this.pm1_status}),t.register_write(45056,this,void 0,function(e){dbg_log("ACPI pm1_status write: "+h(e,4),LOG_ACPI),this.pm1_status&=~e}),t.register_read(45058,this,void 0,function(){return dbg_log("ACPI pm1_enable read",LOG_ACPI),this.pm1_enable}),t.register_write(45058,this,void 0,function(e){dbg_log("ACPI pm1_enable write: "+h(e),LOG_ACPI),this.pm1_enable=e}),t.register_read(45060,this,void 0,function(){return dbg_log("ACPI status read",LOG_ACPI),this.status}),t.register_write(45060,this,void 0,function(e){dbg_log("ACPI status write: "+h(e),LOG_ACPI),this.status=e}),t.register_read(45064,this,void 0,void 0,function(){return 16777215&this.get_timer(v86.microtick())}),t.register_read(45024,this,function(){return dbg_log("Read gpe#0",LOG_ACPI),this.gpe[0]}),t.register_read(45025,this,function(){return dbg_log("Read gpe#1",LOG_ACPI),this.gpe[1]}),t.register_read(45026,this,function(){return dbg_log("Read gpe#2",LOG_ACPI),this.gpe[2]}),t.register_read(45027,this,function(){return dbg_log("Read gpe#3",LOG_ACPI),this.gpe[3]}),t.register_write(45024,this,function(e){dbg_log("Write gpe#0: "+h(e),LOG_ACPI),this.gpe[0]=e}),t.register_write(45025,this,function(e){dbg_log("Write gpe#1: "+h(e),LOG_ACPI),this.gpe[1]=e}),t.register_write(45026,this,function(e){dbg_log("Write gpe#2: "+h(e),LOG_ACPI),this.gpe[2]=e}),t.register_write(45027,this,function(e){dbg_log("Write gpe#3: "+h(e),LOG_ACPI),this.gpe[3]=e})}ACPI.prototype.timer=function(e){var t=0!=(8388608&((e=this.get_timer(e))^this.last_timer));1&this.pm1_enable&&t?(dbg_log("ACPI raise irq",LOG_ACPI),this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=e},ACPI.prototype.get_timer=function(e){return PMTIMER_FREQ/1e3*e|0},ACPI.prototype.get_state=function(){var e=[];return e[0]=this.status,e[1]=this.pm1_status,e[2]=this.pm1_enable,e},ACPI.prototype.set_state=function(e){this.status=e[0],this.pm1_status=e[1],this.pm1_enable=e[2]};var APIC_LOG_VERBOSE=!1,APIC_ADDRESS=4276092928,APIC_TIMER_MODE_MASK=393216,APIC_TIMER_MODE_ONE_SHOT=0,APIC_TIMER_MODE_PERIODIC=131072,APIC_TIMER_MODE_TSC=262144,DELIVERY_MODES="Fixed (0);Lowest Prio (1);SMI (2);Reserved (3);NMI (4);INIT (5);Reserved (6);ExtINT (7)".split(";"),DESTINATION_MODES=["physical","logical"];function APIC(e){var t=this;this.cpu=e,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=v86.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=IOAPIC_CONFIG_MASKED,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,e.io.mmap_register(APIC_ADDRESS,1048576,function(e){dbg_log("Unsupported read8 from apic: "+h(e>>>0),LOG_APIC);var r=3&e;return t.read32(-4&e)>>8*r&255},function(e,t){dbg_log("Unsupported write8 from apic: "+h(e)+" <- "+h(t),LOG_APIC),dbg_trace(),dbg_assert(!1)},function(e){return t.read32(e)},function(e,r){return t.write32(e,r)})}APIC.prototype.read32=function(e){switch(e=e-APIC_ADDRESS|0){case 32:return dbg_log("APIC read id",LOG_APIC),this.apic_id;case 48:return dbg_log("APIC read version",LOG_APIC),327700;case 128:return APIC_LOG_VERBOSE&&dbg_log("APIC read tpr",LOG_APIC),this.tpr;case 208:return dbg_log("Read local destination",LOG_APIC),this.local_destination;case 224:return dbg_log("Read destination format",LOG_APIC),this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return dbg_log("Read isr "+(e=e-256>>4)+": "+h(this.isr[e]>>>0,8),LOG_APIC),this.isr[e];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return dbg_log("Read tmr "+(e=e-384>>4)+": "+h(this.tmr[e]>>>0,8),LOG_APIC),this.tmr[e];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return dbg_log("Read irr "+(e=e-512>>4)+": "+h(this.irr[e]>>>0,8),LOG_APIC),this.irr[e];case 640:return dbg_log("Read error: "+h(this.read_error>>>0,8),LOG_APIC),this.read_error;case 768:return APIC_LOG_VERBOSE&&dbg_log("APIC read icr0",LOG_APIC),this.icr0;case 784:return dbg_log("APIC read icr1",LOG_APIC),this.icr1;case 800:return dbg_log("read timer lvt",LOG_APIC),this.lvt_timer;case 832:return dbg_log("read lvt perf counter",LOG_APIC),this.lvt_perf_counter;case 848:return dbg_log("read lvt int0",LOG_APIC),this.lvt_int0;case 864:return dbg_log("read lvt int1",LOG_APIC),this.lvt_int1;case 880:return dbg_log("read lvt error",LOG_APIC),this.lvt_error;case 992:return dbg_log("read timer divider",LOG_APIC),this.timer_divider;case 896:return dbg_log("read timer initial count",LOG_APIC),this.timer_initial_count;case 912:return dbg_log("read timer current count: "+h(this.timer_current_count>>>0,8),LOG_APIC),this.timer_current_count;default:return dbg_log("APIC read "+h(e),LOG_APIC),dbg_assert(!1),0}},APIC.prototype.write32=function(e,t){switch(e=e-APIC_ADDRESS|0){case 48:dbg_log("APIC write version: "+h(t>>>0,8)+", ignored",LOG_APIC);break;case 128:APIC_LOG_VERBOSE&&dbg_log("Set tpr: "+h(255&t,2),LOG_APIC),this.tpr=255&t,this.check_vector();break;case 176:-1!==(e=this.highest_isr())?(APIC_LOG_VERBOSE&&dbg_log("eoi: "+h(t>>>0,8)+" for vector "+h(e),LOG_APIC),this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector()):dbg_log("Bad eoi: No isr set",LOG_APIC);break;case 208:dbg_log("Set local destination: "+h(t>>>0,8),LOG_APIC),this.local_destination=4278190080&t;break;case 224:dbg_log("Set destination format: "+h(t>>>0,8),LOG_APIC),this.destination_format=16777215|t;break;case 240:dbg_log("Set spurious vector: "+h(t>>>0,8),LOG_APIC),this.spurious_vector=t;break;case 640:dbg_log("Write error: "+h(t>>>0,8),LOG_APIC),this.read_error=this.error,this.error=0;break;case 768:e=255&t;var r=t>>8&7,s=t>>11&1,i=t>>15&1,_=t>>18&3,a=this.icr1>>>24;dbg_log("APIC write icr0: "+h(t,8)+" vector="+h(e,2)+" destination_mode="+DESTINATION_MODES[s]+" delivery_mode="+DELIVERY_MODES[r]+" destination_shorthand="+["no","self","all with self","all without self"][_],LOG_APIC),this.icr0=-4097&t,0===_?this.route(e,r,i,a,s):1===_?this.deliver(e,IOAPIC_DELIVERY_FIXED,i):2===_?this.deliver(e,r,i):3!==_&&dbg_assert(!1);break;case 784:dbg_log("APIC write icr1: "+h(t>>>0,8),LOG_APIC),this.icr1=t;break;case 800:dbg_log("timer lvt: "+h(t>>>0,8),LOG_APIC),this.lvt_timer=t;break;case 832:dbg_log("lvt perf counter: "+h(t>>>0,8),LOG_APIC),this.lvt_perf_counter=t;break;case 848:dbg_log("lvt int0: "+h(t>>>0,8),LOG_APIC),this.lvt_int0=t;break;case 864:dbg_log("lvt int1: "+h(t>>>0,8),LOG_APIC),this.lvt_int1=t;break;case 880:dbg_log("lvt error: "+h(t>>>0,8),LOG_APIC),this.lvt_error=t;break;case 992:dbg_log("timer divider: "+h(t>>>0,8),LOG_APIC),this.timer_divider=t,t=3&t|(8&t)>>1,this.timer_divider_shift=7===t?0:t+1;break;case 896:dbg_log("timer initial: "+h(t>>>0,8),LOG_APIC),this.timer_initial_count=t>>>0,this.timer_current_count=t>>>0,this.next_tick=v86.microtick(),this.timer_active=!0;break;case 912:dbg_log("timer current: "+h(t>>>0,8),LOG_APIC),dbg_assert(!1,"read-only register");break;default:dbg_log("APIC write32 "+h(e)+" <- "+h(t>>>0,8),LOG_APIC),dbg_assert(!1)}},APIC.prototype.timer=function(e){0!==this.timer_current_count&&(0!==(e=(e-this.next_tick)*TSC_RATE/(1<<this.timer_divider_shift)>>>0)&&(this.next_tick+=e/TSC_RATE*(1<<this.timer_divider_shift),this.timer_current_count-=e,0>=this.timer_current_count&&((e=this.lvt_timer&APIC_TIMER_MODE_MASK)===APIC_TIMER_MODE_PERIODIC?(this.timer_current_count=this.timer_initial_count,0==(this.lvt_timer&IOAPIC_CONFIG_MASKED)&&this.deliver(255&this.lvt_timer,IOAPIC_DELIVERY_FIXED,!1)):e===APIC_TIMER_MODE_ONE_SHOT&&(this.timer_current_count=0,dbg_log("APIC timer one shot end",LOG_APIC),0==(this.lvt_timer&IOAPIC_CONFIG_MASKED)&&this.deliver(255&this.lvt_timer,IOAPIC_DELIVERY_FIXED,!1)))))},APIC.prototype.route=function(e,t,r,s,i){this.deliver(e,t,r)},APIC.prototype.deliver=function(e,t,r){APIC_LOG_VERBOSE&&dbg_log("Deliver "+h(e,2)+" mode="+t+" level="+r,LOG_APIC),t!==IOAPIC_DELIVERY_INIT&&t!==IOAPIC_DELIVERY_NMI&&((16>e||255===e)&&dbg_assert(!1,"TODO: Invalid vector"),this.register_get_bit(this.irr,e)?dbg_log("Not delivered: irr already set, vector="+h(e,2),LOG_APIC):(this.register_set_bit(this.irr,e),r?this.register_set_bit(this.tmr,e):this.register_clear_bit(this.tmr,e),this.check_vector()))},APIC.prototype.highest_irr=function(){var e=this.register_get_highest_bit(this.irr);return dbg_assert(255!==e),dbg_assert(16<=e||-1===e),e},APIC.prototype.highest_isr=function(){var e=this.register_get_highest_bit(this.isr);return dbg_assert(255!==e),dbg_assert(16<=e||-1===e),e},APIC.prototype.check_vector=function(){var e=this.highest_irr();if(-1!==e){var t=this.highest_isr();t>=e?APIC_LOG_VERBOSE&&dbg_log("Higher isr, isr="+h(t)+" irr="+h(e),LOG_APIC):(240&e)<=(240&this.tpr)?APIC_LOG_VERBOSE&&dbg_log("Higher tpr, tpr="+h(240&this.tpr)+" irr="+h(e),LOG_APIC):this.cpu.handle_irqs()}},APIC.prototype.acknowledge_irq=function(){var e=this.highest_irr();if(-1!==e){var t=this.highest_isr();t>=e?APIC_LOG_VERBOSE&&dbg_log("Higher isr, isr="+h(t)+" irr="+h(e),LOG_APIC):(240&e)<=(240&this.tpr)?APIC_LOG_VERBOSE&&dbg_log("Higher tpr, tpr="+h(240&this.tpr)+" irr="+h(e),LOG_APIC):(this.register_clear_bit(this.irr,e),this.register_set_bit(this.isr,e),APIC_LOG_VERBOSE&&dbg_log("Calling vector "+h(e),LOG_APIC),this.cpu.pic_call_irq(e),this.check_vector())}},APIC.prototype.get_state=function(){var e=[];return e[0]=this.apic_id,e[1]=this.timer_divider,e[2]=this.timer_divider_shift,e[3]=this.timer_initial_count,e[4]=this.timer_current_count,e[5]=this.next_tick,e[6]=this.lvt_timer,e[7]=this.lvt_perf_counter,e[8]=this.lvt_int0,e[9]=this.lvt_int1,e[10]=this.lvt_error,e[11]=this.tpr,e[12]=this.icr0,e[13]=this.icr1,e[14]=this.irr,e[15]=this.isr,e[16]=this.tmr,e[17]=this.spurious_vector,e[18]=this.destination_format,e[19]=this.local_destination,e[20]=this.error,e[21]=this.read_error,e},APIC.prototype.set_state=function(e){this.apic_id=e[0],this.timer_divider=e[1],this.timer_divider_shift=e[2],this.timer_initial_count=e[3],this.timer_current_count=e[4],this.next_tick=e[5],this.lvt_timer=e[6],this.lvt_perf_counter=e[7],this.lvt_int0=e[8],this.lvt_int1=e[9],this.lvt_error=e[10],this.tpr=e[11],this.icr0=e[12],this.icr1=e[13],this.irr=e[14],this.isr=e[15],this.tmr=e[16],this.spurious_vector=e[17],this.destination_format=e[18],this.local_destination=e[19],this.error=e[20],this.read_error=e[21]},APIC.prototype.register_get_bit=function(e,t){return dbg_assert(0<=t&&256>t),e[t>>5]>>(31&t)&1},APIC.prototype.register_set_bit=function(e,t){dbg_assert(0<=t&&256>t),e[t>>5]|=1<<(31&t)},APIC.prototype.register_clear_bit=function(e,t){dbg_assert(0<=t&&256>t),e[t>>5]&=~(1<<(31&t))},APIC.prototype.register_get_highest_bit=function(e){for(var t=7;0<=t;t--){var r=e[t];if(r)return v86util.int_log2(r>>>0)|t<<5}return-1};var IOAPIC_ADDRESS=4273995776,IOREGSEL=0,IOWIN=16,IOAPIC_IRQ_COUNT=24,IOAPIC_ID=0,IOAPIC_CONFIG_TRIGGER_MODE_LEVEL=32768,IOAPIC_CONFIG_MASKED=65536,IOAPIC_CONFIG_DELIVS=4096,IOAPIC_CONFIG_REMOTE_IRR=16384,IOAPIC_CONFIG_READONLY_MASK=IOAPIC_CONFIG_REMOTE_IRR|IOAPIC_CONFIG_DELIVS|4294836224,IOAPIC_DELIVERY_FIXED=0,IOAPIC_DELIVERY_LOWEST_PRIORITY=1,IOAPIC_DELIVERY_NMI=4,IOAPIC_DELIVERY_INIT=5;function IOAPIC(e){var t=this;this.cpu=e,this.ioredtbl_config=new Int32Array(IOAPIC_IRQ_COUNT),this.ioredtbl_destination=new Int32Array(IOAPIC_IRQ_COUNT);for(var r=0;r<this.ioredtbl_config.length;r++)this.ioredtbl_config[r]=IOAPIC_CONFIG_MASKED;this.ioregsel=0,this.ioapic_id=IOAPIC_ID,this.irq_value=this.irr=0,dbg_assert(32<=MMAP_BLOCK_SIZE),e.io.mmap_register(IOAPIC_ADDRESS,MMAP_BLOCK_SIZE,function(e){return dbg_assert(!1,"unsupported read8 from ioapic: "+h(e)),0},function(e,t){dbg_assert(!1,"unsupported write8 from ioapic: "+h(e))},function(e){return(e=e-IOAPIC_ADDRESS|0)===IOREGSEL?t.ioregsel:e===IOWIN?t.read(t.ioregsel):(dbg_log("Unexpected IOAPIC register read: "+h(e),LOG_APIC),dbg_assert(!1),0)},function(e,r){(e=e-IOAPIC_ADDRESS|0)===IOREGSEL?t.ioregsel=r:e===IOWIN?t.write(t.ioregsel,r):(dbg_log("Unexpected IOAPIC register write: "+h(e)+" <- "+h(r>>>0,8),LOG_APIC),dbg_assert(!1))})}IOAPIC.prototype.remote_eoi=function(e){for(var t=0;t<IOAPIC_IRQ_COUNT;t++){var r=this.ioredtbl_config[t];(255&r)===e&&r&IOAPIC_CONFIG_REMOTE_IRR&&(dbg_log("Clear remote IRR for irq="+h(t),LOG_APIC),this.ioredtbl_config[t]&=~IOAPIC_CONFIG_REMOTE_IRR,this.check_irq(t))}},IOAPIC.prototype.check_irq=function(e){var t=1<<e;if(0!=(this.irr&t)){var r=this.ioredtbl_config[e];if(0==(r&IOAPIC_CONFIG_MASKED)){var s=r>>8&7,i=r>>11&1,_=255&r,a=this.ioredtbl_destination[e]>>>24,o=(r&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL)===IOAPIC_CONFIG_TRIGGER_MODE_LEVEL;if(0==(r&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL))this.irr&=~t;else if(this.ioredtbl_config[e]|=IOAPIC_CONFIG_REMOTE_IRR,r&IOAPIC_CONFIG_REMOTE_IRR)return void dbg_log("No route: level interrupt and remote IRR still set",LOG_APIC);s===IOAPIC_DELIVERY_FIXED||s===IOAPIC_DELIVERY_LOWEST_PRIORITY?this.cpu.devices.apic.route(_,s,o,a,i):dbg_assert(!1,"TODO"),this.ioredtbl_config[e]&=~IOAPIC_CONFIG_DELIVS}}},IOAPIC.prototype.set_irq=function(e){if(e>=IOAPIC_IRQ_COUNT)dbg_assert(!1,"Bad irq: "+e,LOG_APIC);else{var t=1<<e;0==(this.irq_value&t)&&(APIC_LOG_VERBOSE&&dbg_log("apic set irq "+e,LOG_APIC),this.irq_value|=t,(this.ioredtbl_config[e]&(IOAPIC_CONFIG_TRIGGER_MODE_LEVEL|IOAPIC_CONFIG_MASKED))!==IOAPIC_CONFIG_MASKED&&(this.irr|=t,this.check_irq(e)))}},IOAPIC.prototype.clear_irq=function(e){if(e>=IOAPIC_IRQ_COUNT)dbg_assert(!1,"Bad irq: "+e,LOG_APIC);else{var t=1<<e;(this.irq_value&t)===t&&(this.irq_value&=~t,this.ioredtbl_config[e]&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL&&(this.irr&=~t))}},IOAPIC.prototype.read=function(e){if(0===e)return dbg_log("IOAPIC Read id",LOG_APIC),this.ioapic_id<<24;if(1===e)return dbg_log("IOAPIC Read version",LOG_APIC),17|IOAPIC_IRQ_COUNT-1<<16;if(2===e)return dbg_log("IOAPIC Read arbitration id",LOG_APIC),this.ioapic_id<<24;if(16<=e&&e<16+2*IOAPIC_IRQ_COUNT){var t=e-16>>1;return 1&e?(e=this.ioredtbl_destination[t],dbg_log("IOAPIC Read destination irq="+h(t)+" -> "+h(e,8),LOG_APIC)):(e=this.ioredtbl_config[t],dbg_log("IOAPIC Read config irq="+h(t)+" -> "+h(e,8),LOG_APIC)),e}return dbg_log("IOAPIC register read outside of range "+h(e),LOG_APIC),dbg_assert(!1),0},IOAPIC.prototype.write=function(e,t){if(0===e)this.ioapic_id=t>>>24&15;else if(1===e||2===e)dbg_log("Invalid write: "+e,LOG_APIC);else if(16<=e&&e<16+2*IOAPIC_IRQ_COUNT){var r=e-16>>1;if(1&e)this.ioredtbl_destination[r]=4278190080&t,dbg_log("Write destination "+h(t>>>0,8)+" irq="+h(r)+" dest="+h(t>>>24,2),LOG_APIC);else{this.ioredtbl_config[r]=t&~IOAPIC_CONFIG_READONLY_MASK|this.ioredtbl_config[r]&IOAPIC_CONFIG_READONLY_MASK,e=255&t;var s=t>>8&7,i=t>>11&1,_=t>>15&1,a=t>>16&1;dbg_log("Write config "+h(t>>>0,8)+" irq="+h(r)+" vector="+h(e,2)+" deliverymode="+DELIVERY_MODES[s]+" destmode="+DESTINATION_MODES[i]+" is_level="+_+" disabled="+a,LOG_APIC),this.check_irq(r)}}else dbg_log("IOAPIC register write outside of range "+h(e)+": "+h(t>>>0,8),LOG_APIC),dbg_assert(!1)},IOAPIC.prototype.get_state=function(){var e=[];return e[0]=this.ioredtbl_config,e[1]=this.ioredtbl_destination,e[2]=this.ioregsel,e[3]=this.ioapic_id,e[4]=this.irr,e[5]=this.irq_value,e},IOAPIC.prototype.set_state=function(e){this.ioredtbl_config=e[0],this.ioredtbl_destination=e[1],this.ioregsel=e[2],this.ioapic_id=e[3],this.irr=e[4],this.irq_value=e[5]};var STATE_VERSION=5,STATE_MAGIC=-2039052682,STATE_INDEX_MAGIC=0,STATE_INDEX_VERSION=1,STATE_INDEX_TOTAL_LEN=2,STATE_INDEX_INFO_LEN=3,STATE_INFO_BLOCK_START=16;function StateLoadError(e){this.message=e}function save_object(e,t){if("object"!=typeof e||null===e||e instanceof Array)return e;if(dbg_assert(e.constructor!==Object),e.BYTES_PER_ELEMENT){var r=new Uint8Array(e.buffer,e.byteOffset,e.length*e.BYTES_PER_ELEMENT);return{__state_type__:e.constructor.name,buffer_id:t.push(r)-1}}DEBUG&&!e.get_state&&console.log("Object without get_state: ",e),e=e.get_state(),r=[];for(var s=0;s<e.length;s++){var i=e[s];dbg_assert("function"!=typeof i),r[s]=save_object(i,t)}return r}function restore_object(e,t,r){if("object"!=typeof t||null===t)return t;if(e instanceof Array)return t;var s=t.__state_type__;if(void 0===s){DEBUG&&void 0===e&&(console.log("Cannot restore (base doesn't exist)",t),dbg_assert(!1)),DEBUG&&!e.get_state&&console.log("No get_state:",e);var i=e.get_state();for(dbg_assert(i.length===t.length,"Cannot restore: Different number of properties"),s=0;s<t.length;s++)t[s]=restore_object(i[s],t[s],r);return e.set_state(t),e}return dbg_assert(i={Uint8Array:Uint8Array,Int8Array:Int8Array,Uint16Array:Uint16Array,Int16Array:Int16Array,Uint32Array:Uint32Array,Int32Array:Int32Array,Float32Array:Float32Array,Float64Array:Float64Array}[s],"Unkown type: "+s),t=r.infos[t.buffer_id],dbg_assert(e),dbg_assert(e.constructor===i),1048576<=t.length&&i===Uint8Array?new Uint8Array(r.full,t.offset,t.length):new i(e=r.full.slice(t.offset,t.offset+t.length))}StateLoadError.prototype=Error(),CPU.prototype.save_state=function(){for(var e=[],t=save_object(this,e),r=[],s=0,i=0;i<e.length;i++){var _=e[i].byteLength;r[i]={offset:s,length:_},s=(s+=_)+3&-4}t=JSON.stringify({buffer_infos:r,state:t});var a=(i=(i=STATE_INFO_BLOCK_START+2*t.length)+3&-4)+s;s=new ArrayBuffer(a);var o=new Int32Array(s,0,STATE_INFO_BLOCK_START/4);_=new Uint16Array(s,STATE_INFO_BLOCK_START,t.length);var n=new Uint8Array(s,i);for(o[STATE_INDEX_MAGIC]=STATE_MAGIC,o[STATE_INDEX_VERSION]=STATE_VERSION,o[STATE_INDEX_TOTAL_LEN]=a,o[STATE_INDEX_INFO_LEN]=2*t.length,i=0;i<t.length;i++)_[i]=t.charCodeAt(i);for(i=0;i<e.length;i++)dbg_assert((t=e[i]).constructor===Uint8Array),n.set(t,r[i].offset);return s},CPU.prototype.restore_state=function(e){var t=e.byteLength;if(t<STATE_INFO_BLOCK_START)throw new StateLoadError("Invalid length: "+t);var r=new Int32Array(e,0,4);if(r[STATE_INDEX_MAGIC]!==STATE_MAGIC)throw new StateLoadError("Invalid header: "+h(r[STATE_INDEX_MAGIC]>>>0));if(r[STATE_INDEX_VERSION]!==STATE_VERSION)throw new StateLoadError("Version mismatch: dump="+r[STATE_INDEX_VERSION]+" we="+STATE_VERSION);if(r[STATE_INDEX_TOTAL_LEN]!==t)throw new StateLoadError("Length doesn't match header: real="+t+" header="+r[STATE_INDEX_TOTAL_LEN]);if(0>(r=r[STATE_INDEX_INFO_LEN])||r+12>=t||r%2)throw new StateLoadError("Invalid info block length: "+r);var s=r/2,i=new Uint16Array(e,STATE_INFO_BLOCK_START,s),_="";for(t=0;t<s-8;)_+=String.fromCharCode(i[t++],i[t++],i[t++],i[t++],i[t++],i[t++],i[t++],i[t++]);for(;t<s;)_+=String.fromCharCode(i[t++]);for(s=(t=JSON.parse(_)).state,i=t.buffer_infos,r=(r=STATE_INFO_BLOCK_START+r)+3&-4,t=0;t<i.length;t++)i[t].offset+=r;restore_object(this,s,{full:e,infos:i})};var E8390_CMD=0,EN0_CLDALO=1,EN0_STARTPG=1,EN0_CLDAHI=2,EN0_STOPPG=2,EN0_BOUNDARY=3,EN0_TSR=4,EN0_TPSR=4,EN0_NCR=5,EN0_TCNTLO=5,EN0_FIFO=6,EN0_TCNTHI=6,EN0_ISR=7,EN0_CRDALO=8,EN0_RSARLO=8,EN0_CRDAHI=9,EN0_RSARHI=9,EN0_RCNTLO=10,EN0_RCNTHI=11,EN0_RSR=12,EN0_RXCR=12,EN0_TXCR=13,EN0_COUNTER0=13,EN0_DCFG=14,EN0_COUNTER1=14,EN0_IMR=15,EN0_COUNTER2=15,NE_DATAPORT=16,NE_RESET=31,ENISR_RX=1,ENISR_TX=2,ENISR_RX_ERR=4,ENISR_TX_ERR=8,ENISR_OVER=16,ENISR_COUNTERS=32,ENISR_RDC=64,ENISR_RESET=128,ENISR_ALL=63,ENRSR_RXOK=1,START_PAGE=64,START_RX_PAGE=76,STOP_PAGE=128;function Ne2k(e,t){this.cpu=e,this.pci=e.devices.pci,this.bus=t,this.bus.register("net0-receive",function(e){this.receive(e)},this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,255&this.port|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,t=[0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0];for(var r=0;6>r;r++)this.memory[r<<1]=this.memory[r<<1|1]=t[r];this.memory[14]=this.memory[15]=87,dbg_log("Mac: "+h(t[0],2)+":"+h(t[1],2)+":"+h(t[2],2)+":"+h(t[3],2)+":"+h(t[4],2)+":"+h(t[5],2),LOG_NET),this.rsar=0,this.pstart=START_PAGE,this.pstop=STOP_PAGE,this.boundary=this.curpg=START_RX_PAGE,(t=e.io).register_read(this.port|E8390_CMD,this,function(){return dbg_log("Read cmd",LOG_NET),this.cr}),t.register_write(this.port|E8390_CMD,this,function(e){this.cr=-5&e,dbg_log("Write command: "+h(e,2)+" newpg="+(this.cr>>6)+" txcr="+h(this.txcr,2),LOG_NET),1&this.cr||(24|e&&0===this.rcnt&&this.do_interrupt(ENISR_RDC),4&e&&(e=this.tpsr<<8,e=this.memory.subarray(e,e+this.tcnt),this.bus.send("net0-send",e),this.bus.send("eth-transmit-end",[e.length]),this.do_interrupt(ENISR_TX),dbg_log("Command: Transfer. length="+h(e.byteLength),LOG_NET)))}),t.register_read(this.port|EN0_COUNTER0,this,function(){return dbg_log("Read counter0",LOG_NET),0}),t.register_read(this.port|EN0_COUNTER1,this,function(){return dbg_log("Read counter1",LOG_NET),0}),t.register_read(this.port|EN0_COUNTER2,this,function(){return dbg_log("Read counter2",LOG_NET),0}),t.register_read(this.port|NE_RESET,this,function(){return 0===this.get_page()?(dbg_log("Read reset",LOG_NET),this.do_interrupt(ENISR_RESET)):dbg_log("Read pg1/1f",LOG_NET),0}),t.register_write(this.port|NE_RESET,this,function(e){0===this.get_page()?dbg_log("Write reset: "+h(e,2),LOG_NET):dbg_log("Write pg1/1f: "+h(e),LOG_NET)}),t.register_write(this.port|EN0_STARTPG,this,function(e){0===this.get_page()?(dbg_log("start page: "+h(e,2),LOG_NET),this.pstart=e):dbg_log("pg1/1: "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_STOPPG,this,function(e){0===this.get_page()?(dbg_log("stop page: "+h(e,2),LOG_NET),this.pstop=e):dbg_log("pg1/2: "+h(e,2),LOG_NET)}),t.register_read(this.port|EN0_ISR,this,function(){return 0===this.get_page()?(dbg_log("Read isr: "+h(this.isr,2),LOG_NET),this.isr):(dbg_log("Read curpg: "+h(this.curpg,2),LOG_NET),this.curpg)}),t.register_write(this.port|EN0_ISR,this,function(e){0===this.get_page()?(dbg_log("Write isr: "+h(e,2),LOG_NET),this.isr&=~e,this.update_irq()):(dbg_log("Write curpg: "+h(e,2),LOG_NET),this.curpg=e)}),t.register_write(this.port|EN0_TXCR,this,function(e){0===this.get_page()?(this.txcr=e,dbg_log("Write tx config: "+h(e,2),LOG_NET)):dbg_log("Write pg1/0x0d "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_DCFG,this,function(e){0===this.get_page()?(dbg_log("Write data configuration: "+h(e,2),LOG_NET),this.dcfg=e):dbg_log("Write pg1/0x0e "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_RCNTLO,this,function(e){0===this.get_page()?(dbg_log("Write remote byte count low: "+h(e,2),LOG_NET),this.rcnt=65280&this.rcnt|255&e):dbg_log("Write pg1/0x0a "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_RCNTHI,this,function(e){0===this.get_page()?(dbg_log("Write remote byte count high: "+h(e,2),LOG_NET),this.rcnt=255&this.rcnt|e<<8&65280):dbg_log("Write pg1/0x0b "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_RSARLO,this,function(e){0===this.get_page()?(dbg_log("Write remote start address low: "+h(e,2),LOG_NET),this.rsar=65280&this.rsar|255&e):dbg_log("Write pg1/0x08 "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_RSARHI,this,function(e){0===this.get_page()?(dbg_log("Write start addresse count high: "+h(e,2),LOG_NET),this.rsar=255&this.rsar|e<<8&65280):dbg_log("Write pg1/0x09 "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_IMR,this,function(e){0===this.get_page()?(dbg_log("Write interrupt mask register: "+h(e,2)+" isr="+h(this.isr,2),LOG_NET),this.imr=e,this.update_irq()):dbg_log("Write pg1/0x0f "+h(e,2),LOG_NET)}),t.register_read(this.port|EN0_BOUNDARY,this,function(){return 0===this.get_page()?(dbg_log("Read boundary: "+h(this.boundary,2),LOG_NET),this.boundary):(dbg_log("Read pg1/0x03",LOG_NET),0)}),t.register_write(this.port|EN0_BOUNDARY,this,function(e){0===this.get_page()?(dbg_log("Write boundary: "+h(e,2),LOG_NET),this.boundary=e):dbg_log("Write pg1/0x03 "+h(e,2),LOG_NET)}),t.register_read(this.port|EN0_TSR,this,function(){return 0===this.get_page()?this.tsr:(dbg_log("Read pg1/0x04",LOG_NET),0)}),t.register_write(this.port|EN0_TPSR,this,function(e){0===this.get_page()?(dbg_log("Write tpsr: "+h(e,2),LOG_NET),this.tpsr=e):dbg_log("Write pg1/0x04 "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_TCNTLO,this,function(e){0===this.get_page()?(dbg_log("Write tcnt low: "+h(e,2),LOG_NET),this.tcnt=-256&this.tcnt|e):dbg_log("Write pg1/0x05 "+h(e,2),LOG_NET)}),t.register_write(this.port|EN0_TCNTHI,this,function(e){0===this.get_page()?(dbg_log("Write tcnt high: "+h(e,2),LOG_NET),this.tcnt=255&this.tcnt|e<<8):dbg_log("Write pg1/0x06 "+h(e,2),LOG_NET)}),t.register_read(this.port|EN0_RSR,this,function(){return 0===this.get_page()?9:(dbg_log("Read pg1/0x0c",LOG_NET),0)}),t.register_write(this.port|EN0_RXCR,this,function(e){dbg_log("RX configuration reg write: "+h(e,2),LOG_NET),this.rxcr=e}),t.register_read(this.port|NE_DATAPORT|0,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),t.register_write(this.port|NE_DATAPORT|0,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),e.devices.pci.register_device(this)}Ne2k.prototype.get_state=function(){var e=[];return e[0]=this.isr,e[1]=this.imr,e[2]=this.cr,e[3]=this.dcfg,e[4]=this.rcnt,e[5]=this.tcnt,e[6]=this.tpsr,e[7]=this.rsar,e[8]=this.pstart,e[9]=this.curpg,e[10]=this.boundary,e},Ne2k.prototype.set_state=function(e){this.isr=e[0],this.imr=e[1],this.cr=e[2],this.dcfg=e[3],this.rcnt=e[4],this.tcnt=e[5],this.tpsr=e[6],this.rsar=e[7],this.pstart=e[8],this.curpg=e[9],this.boundary=e[10]},Ne2k.prototype.do_interrupt=function(e){dbg_log("Do interrupt "+h(e,2),LOG_NET),this.isr|=e,this.update_irq()},Ne2k.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)},Ne2k.prototype.data_port_write=function(e){dbg_log("Write data port: data="+h(255&e,2)+" rsar="+h(this.rsar,4)+" rcnt="+h(this.rcnt,4),LOG_NET),16<this.rsar&&this.rsar<START_PAGE<<8||(this.rcnt--,this.memory[this.rsar++]=e,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(ENISR_RDC))},Ne2k.prototype.data_port_write16=function(e){this.data_port_write(e),1&this.dcfg&&this.data_port_write(e>>8)},Ne2k.prototype.data_port_write32=function(e){this.data_port_write(e),this.data_port_write(e>>8),this.data_port_write(e>>16),this.data_port_write(e>>24)},Ne2k.prototype.data_port_read=function(){var e=this.memory[this.rsar++];return dbg_log("Read data port: data="+h(e,2)+" rsar="+h(this.rsar-1,4)+" rcnt="+h(this.rcnt,4),LOG_NET),this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(ENISR_RDC),e},Ne2k.prototype.data_port_read8=function(){return 255&this.data_port_read16()},Ne2k.prototype.data_port_read16=function(){return 1&this.dcfg?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()},Ne2k.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24},Ne2k.prototype.receive=function(e){if(!(1&this.cr)&&(this.bus.send("eth-receive-end",[e.length]),16&this.rxcr||4&this.rxcr&&255===e[0]&&255===e[1]&&255===e[2]&&255===e[3]&&255===e[4]&&255===e[5]||!(8&this.rxcr&&1==(1&e[0])||e[0]!==this.memory[0]||e[1]!==this.memory[2]||e[2]!==this.memory[4]||e[3]!==this.memory[6]||e[4]!==this.memory[8]||e[5]!==this.memory[10]))){var t=this.curpg<<8,r=Math.max(60,e.length)+4,s=t+4,i=this.curpg+1+(r>>8);if(t+r>this.memory.length){dbg_assert(60<=e.length);var _=this.memory.length-s;this.memory.set(e.subarray(0,_),s),this.memory.set(e.subarray(_),START_RX_PAGE),dbg_log("rcv cut="+h(_),LOG_NET)}else if(this.memory.set(e,s),60>e.length)for(e=e.length;60>e;e++)this.memory[s+e]=0;i>=this.pstop&&(i+=this.pstart-this.pstop),this.memory[t]=ENRSR_RXOK,this.memory[t+1]=i,this.memory[t+2]=r,this.memory[t+3]=r>>8,this.curpg=i,dbg_log("rcv offset="+h(t)+" len="+h(r)+" next="+h(i),LOG_NET),this.do_interrupt(ENISR_RX)}},Ne2k.prototype.get_page=function(){return 192&this.cr};var DSP_COPYRIGHT="COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.",DSP_NO_COMMAND=0,DSP_BUFSIZE=64,DSP_DACSIZE=65536,SB_DMA_BUFSIZE=65536,SB_DMA_BLOCK_SAMPLES=1024,SB_DMA0=0,SB_DMA1=1,SB_DMA3=3,SB_DMA5=5,SB_DMA6=6,SB_DMA7=7,SB_DMA_CHANNEL_8BIT=SB_DMA1,SB_DMA_CHANNEL_16BIT=SB_DMA5,SB_IRQ2=2,SB_IRQ5=5,SB_IRQ7=7,SB_IRQ10=10,SB_IRQ=SB_IRQ5,SB_IRQ_8BIT=1,SB_IRQ_16BIT=2,SB_IRQ_MIDI=1,SB_IRQ_MPU=4,DSP_COMMAND_SIZES=new Uint8Array(256),DSP_COMMAND_HANDLERS=[],MIXER_READ_HANDLERS=[],MIXER_WRITE_HANDLERS=[],FM_HANDLERS=[];function SB16(e,t){this.cpu=e,this.bus=t,this.write_buffer=new ByteQueue(DSP_BUFSIZE),this.read_buffer=new ByteQueue(DSP_BUFSIZE),this.read_buffer_lastvalue=0,this.command=DSP_NO_COMMAND,this.mixer_current_address=this.command_size=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new FloatQueue(DSP_DACSIZE),new FloatQueue(DSP_DACSIZE)],this.dma=e.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=SB_DMA_CHANNEL_8BIT,this.dma_channel_16bit=SB_DMA_CHANNEL_16BIT,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(SB_DMA_BUFSIZE),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new SyncBuffer(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,t.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new ByteQueue(DSP_BUFSIZE),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=SB_IRQ,this.irq_triggered=new Uint8Array(16),e.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),e.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),e.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),e.io.register_read(550,this,this.port2x6_read),e.io.register_read(551,this,this.port2x7_read),e.io.register_read(552,this,this.port2x8_read),e.io.register_read(553,this,this.port2x9_read),e.io.register_read(554,this,this.port2xA_read),e.io.register_read(555,this,this.port2xB_read),e.io.register_read(556,this,this.port2xC_read),e.io.register_read(557,this,this.port2xD_read),e.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),e.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),e.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),e.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),e.io.register_write(550,this,this.port2x6_write),e.io.register_write(551,this,this.port2x7_write),e.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),e.io.register_write(554,this,this.port2xA_write),e.io.register_write(555,this,this.port2xB_write),e.io.register_write(556,this,this.port2xC_write),e.io.register_write(557,this,this.port2xD_write),e.io.register_write(558,this,this.port2xE_write),e.io.register_write(559,this,this.port2xF_write),e.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),e.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),t.register("dac-request-data",function(){this.dac_handle_request()},this),t.register("speaker-has-initialized",function(){this.mixer_reset()},this),t.send("speaker-confirm-initialized"),this.dsp_reset()}function register_dsp_command(e,t,r){r||(r=SB16.prototype.dsp_default_handler);for(var s=0;s<e.length;s++)DSP_COMMAND_SIZES[e[s]]=t,DSP_COMMAND_HANDLERS[e[s]]=r}function any_first_digit(e){for(var t=[],r=0;16>r;r++)t.push(e+r);return t}SB16.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command=DSP_NO_COMMAND,this.command_size=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(SB_IRQ_8BIT),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248},SB16.prototype.get_state=function(){var e=[];return e[2]=this.read_buffer_lastvalue,e[3]=this.command,e[4]=this.command_size,e[5]=this.mixer_current_address,e[6]=this.mixer_registers,e[7]=this.dummy_speaker_enabled,e[8]=this.test_register,e[9]=this.dsp_highspeed,e[10]=this.dsp_stereo,e[11]=this.dsp_16bit,e[12]=this.dsp_signed,e[15]=this.dma_sample_count,e[16]=this.dma_bytes_count,e[17]=this.dma_bytes_left,e[18]=this.dma_bytes_block,e[19]=this.dma_irq,e[20]=this.dma_channel,e[21]=this.dma_channel_8bit,e[22]=this.dma_channel_16bit,e[23]=this.dma_autoinit,e[24]=this.dma_buffer_uint8,e[25]=this.dma_waiting_transfer,e[26]=this.dma_paused,e[27]=this.sampling_rate,e[28]=this.bytes_per_sample,e[29]=this.e2_value,e[30]=this.e2_count,e[31]=this.asp_registers,e[33]=this.mpu_read_buffer_last_value,e[34]=this.irq,e[35]=this.irq_triggered,e},SB16.prototype.set_state=function(e){this.read_buffer_lastvalue=e[2],this.command=e[3],this.command_size=e[4],this.mixer_current_address=e[5],this.mixer_registers=e[6],this.mixer_full_update(),this.dummy_speaker_enabled=e[7],this.test_register=e[8],this.dsp_highspeed=e[9],this.dsp_stereo=e[10],this.dsp_16bit=e[11],this.dsp_signed=e[12],this.dma_sample_count=e[15],this.dma_bytes_count=e[16],this.dma_bytes_left=e[17],this.dma_bytes_block=e[18],this.dma_irq=e[19],this.dma_channel=e[20],this.dma_channel_8bit=e[21],this.dma_channel_16bit=e[22],this.dma_autoinit=e[23],this.dma_buffer_uint8=e[24],this.dma_waiting_transfer=e[25],this.dma_paused=e[26],this.sampling_rate=e[27],this.bytes_per_sample=e[28],this.e2_value=e[29],this.e2_count=e[30],this.asp_registers=e[31],this.mpu_read_buffer_last_value=e[33],this.irq=e[34],this.irq_triggered=e[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new SyncBuffer(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")},SB16.prototype.port2x0_read=function(){return dbg_log("220 read: fm music status port (unimplemented)",LOG_SB16),255},SB16.prototype.port2x1_read=function(){return dbg_log("221 read: fm music data port (write only)",LOG_SB16),255},SB16.prototype.port2x2_read=function(){return dbg_log("222 read: advanced fm music status port (unimplemented)",LOG_SB16),255},SB16.prototype.port2x3_read=function(){return dbg_log("223 read: advanced music data port (write only)",LOG_SB16),255},SB16.prototype.port2x4_read=function(){return dbg_log("224 read: mixer address port",LOG_SB16),this.mixer_current_address},SB16.prototype.port2x5_read=function(){return dbg_log("225 read: mixer data port",LOG_SB16),this.mixer_read(this.mixer_current_address)},SB16.prototype.port2x6_read=function(){return dbg_log("226 read: (write only)",LOG_SB16),255},SB16.prototype.port2x7_read=function(){return dbg_log("227 read: undocumented",LOG_SB16),255},SB16.prototype.port2x8_read=function(){return dbg_log("228 read: fm music status port (unimplemented)",LOG_SB16),255},SB16.prototype.port2x9_read=function(){return dbg_log("229 read: fm music data port (write only)",LOG_SB16),255},SB16.prototype.port2xA_read=function(){return dbg_log("22A read: read data",LOG_SB16),this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),dbg_log(" <- "+this.read_buffer_lastvalue+" "+h(this.read_buffer_lastvalue)+" '"+String.fromCharCode(this.read_buffer_lastvalue)+"'",LOG_SB16),this.read_buffer_lastvalue},SB16.prototype.port2xB_read=function(){return dbg_log("22B read: undocumented",LOG_SB16),255},SB16.prototype.port2xC_read=function(){return dbg_log("22C read: write-buffer status",LOG_SB16),127},SB16.prototype.port2xD_read=function(){return dbg_log("22D read: undocumented",LOG_SB16),255},SB16.prototype.port2xE_read=function(){return dbg_log("22E read: read-buffer status / irq 8bit ack.",LOG_SB16),this.irq_triggered[SB_IRQ_8BIT]&&this.lower_irq(SB_IRQ_8BIT),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127},SB16.prototype.port2xF_read=function(){return dbg_log("22F read: irq 16bit ack",LOG_SB16),this.lower_irq(SB_IRQ_16BIT),0},SB16.prototype.port2x0_write=function(e){dbg_log("220 write: (unimplemented) fm register 0 address = "+h(e),LOG_SB16),this.fm_current_address0=0},SB16.prototype.port2x1_write=function(e){dbg_log("221 write: (unimplemented) fm register 0 data = "+h(e),LOG_SB16);var t=FM_HANDLERS[this.fm_current_address0];t||(t=this.fm_default_write),t.call(this,e,0,this.fm_current_address0)},SB16.prototype.port2x2_write=function(e){dbg_log("222 write: (unimplemented) fm register 1 address = "+h(e),LOG_SB16),this.fm_current_address1=0},SB16.prototype.port2x3_write=function(e){dbg_log("223 write: (unimplemented) fm register 1 data ="+h(e),LOG_SB16);var t=FM_HANDLERS[this.fm_current_address1];t||(t=this.fm_default_write),t.call(this,e,1,this.fm_current_address1)},SB16.prototype.port2x4_write=function(e){dbg_log("224 write: mixer address = "+h(e),LOG_SB16),this.mixer_current_address=e},SB16.prototype.port2x5_write=function(e){dbg_log("225 write: mixer data = "+h(e),LOG_SB16),this.mixer_write(this.mixer_current_address,e)},SB16.prototype.port2x6_write=function(e){dbg_log("226 write: reset = "+h(e),LOG_SB16),this.dsp_highspeed?(dbg_log(" -> exit highspeed",LOG_SB16),this.dsp_highspeed=!1):e&&(dbg_log(" -> reset",LOG_SB16),this.dsp_reset()),this.read_buffer.clear(),this.read_buffer.push(170)},SB16.prototype.port2x7_write=function(e){dbg_log("227 write: undocumented",LOG_SB16)},SB16.prototype.port2x8_write=function(e){dbg_log("228 write: fm music register port (unimplemented)",LOG_SB16)},SB16.prototype.port2x9_write=function(e){dbg_log("229 write: fm music data port (unimplemented)",LOG_SB16)},SB16.prototype.port2xA_write=function(e){dbg_log("22A write: dsp read data port (read only)",LOG_SB16)},SB16.prototype.port2xB_write=function(e){dbg_log("22B write: undocumented",LOG_SB16)},SB16.prototype.port2xC_write=function(e){dbg_log("22C write: write command/data",LOG_SB16),this.command===DSP_NO_COMMAND?(dbg_log("22C write: command = "+h(e),LOG_SB16),this.command=e,this.write_buffer.clear(),this.command_size=DSP_COMMAND_SIZES[e]):(dbg_log("22C write: data: "+h(e),LOG_SB16),this.write_buffer.push(e)),this.write_buffer.length>=this.command_size&&this.command_do()},SB16.prototype.port2xD_write=function(e){dbg_log("22D write: undocumented",LOG_SB16)},SB16.prototype.port2xE_write=function(e){dbg_log("22E write: dsp read buffer status (read only)",LOG_SB16)},SB16.prototype.port2xF_write=function(e){dbg_log("22F write: undocumented",LOG_SB16)},SB16.prototype.port3x0_read=function(){return dbg_log("330 read: mpu data",LOG_SB16),this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),dbg_log(" <- "+h(this.mpu_read_buffer_lastvalue),LOG_SB16),this.mpu_read_buffer_lastvalue},SB16.prototype.port3x0_write=function(e){dbg_log("330 write: mpu data (unimplemented) : "+h(e),LOG_SB16)},SB16.prototype.port3x1_read=function(){return dbg_log("331 read: mpu status",LOG_SB16),0|128*!this.mpu_read_buffer.length},SB16.prototype.port3x1_write=function(e){dbg_log("331 write: mpu command: "+h(e),LOG_SB16),255==e&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))},SB16.prototype.command_do=function(){var e=DSP_COMMAND_HANDLERS[this.command];e||(e=this.dsp_default_handler),e.call(this),this.command=DSP_NO_COMMAND,this.command_size=0,this.write_buffer.clear()},SB16.prototype.dsp_default_handler=function(){dbg_log("Unhandled command: "+h(this.command),LOG_SB16)},register_dsp_command([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()}),register_dsp_command([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])}),register_dsp_command([16],1,function(){var e=audio_normalize(this.write_buffer.shift(),127.5,-1);this.dac_buffers[0].push(e),this.dac_buffers[1].push(e),this.bus.send("dac-enable")}),register_dsp_command([20,21],2,function(){this.dma_irq=SB_IRQ_8BIT,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}),register_dsp_command([22],2),register_dsp_command([23],2),register_dsp_command([28],0,function(){this.dma_irq=SB_IRQ_8BIT,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()}),register_dsp_command([31],0),register_dsp_command([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)}),register_dsp_command([36],2),register_dsp_command([44],0),register_dsp_command([48],0),register_dsp_command([49],0),register_dsp_command([52],0),register_dsp_command([53],0),register_dsp_command([54],0),register_dsp_command([55],0),register_dsp_command([56],0),register_dsp_command([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())}),register_dsp_command([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())}),register_dsp_command([72],2,function(){this.dma_transfer_size_set()}),register_dsp_command([116],2),register_dsp_command([117],2),register_dsp_command([118],2),register_dsp_command([119],2),register_dsp_command([125],0),register_dsp_command([127],0),register_dsp_command([128],2),register_dsp_command([144],0,function(){this.dma_irq=SB_IRQ_8BIT,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()}),register_dsp_command([145],0),register_dsp_command([152],0),register_dsp_command([153],0),register_dsp_command([160],0),register_dsp_command([168],0),register_dsp_command(any_first_digit(176),3,function(){if(8&this.command)this.dsp_default_handler();else{var e=this.write_buffer.shift();this.dma_irq=SB_IRQ_16BIT,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&e),this.dsp_stereo=!!(32&e),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}}),register_dsp_command(any_first_digit(192),3,function(){if(8&this.command)this.dsp_default_handler();else{var e=this.write_buffer.shift();this.dma_irq=SB_IRQ_8BIT,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&e),this.dsp_stereo=!!(32&e),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}}),register_dsp_command([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),register_dsp_command([209],0,function(){this.dummy_speaker_enabled=!0}),register_dsp_command([211],0,function(){this.dummy_speaker_enabled=!1}),register_dsp_command([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),register_dsp_command([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")}),register_dsp_command([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")}),register_dsp_command([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)}),register_dsp_command([217,218],0,function(){this.dma_autoinit=!1}),register_dsp_command([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())}),register_dsp_command([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)}),register_dsp_command([226],1),register_dsp_command([227],0,function(){this.read_buffer.clear();for(var e=0;e<DSP_COPYRIGHT.length;e++)this.read_buffer.push(DSP_COPYRIGHT.charCodeAt(e));this.read_buffer.push(0)}),register_dsp_command([228],1,function(){this.test_register=this.write_buffer.shift()}),register_dsp_command([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)}),register_dsp_command([242,243],0,function(){this.raise_irq()});var SB_F9=new Uint8Array(256);function register_mixer_read(e,t){t||(t=SB16.prototype.mixer_default_read),MIXER_READ_HANDLERS[e]=t}function register_mixer_write(e,t){t||(t=SB16.prototype.mixer_default_write),MIXER_WRITE_HANDLERS[e]=t}function register_mixer_legacy(e,t,r){MIXER_READ_HANDLERS[e]=function(){return 240&this.mixer_registers[t]|this.mixer_registers[r]>>>4},MIXER_WRITE_HANDLERS[e]=function(s){this.mixer_registers[e]=s;var i=s<<4&240|15&this.mixer_registers[r];this.mixer_write(t,240&s|15&this.mixer_registers[t]),this.mixer_write(r,i)}}function register_mixer_volume(e,t,r){MIXER_READ_HANDLERS[e]=SB16.prototype.mixer_default_read,MIXER_WRITE_HANDLERS[e]=function(s){this.mixer_registers[e]=s,this.bus.send("mixer-volume",[t,r,(s>>>2)-62])}}function register_fm_write(e,t){t||(t=SB16.prototype.fm_default_write);for(var r=0;r<e.length;r++)FM_HANDLERS[e[r]]=t}function between(e,t){for(var r=[];e<=t;e++)r.push(e);return r}SB_F9[14]=255,SB_F9[15]=7,SB_F9[55]=56,register_dsp_command([249],1,function(){var e=this.write_buffer.shift();dbg_log("dsp 0xf9: unknown function. input: "+e,LOG_SB16),this.read_buffer.clear(),this.read_buffer.push(SB_F9[e])}),SB16.prototype.mixer_read=function(e){var t=MIXER_READ_HANDLERS[e];return t?t=t.call(this):(t=this.mixer_registers[e],dbg_log("unhandled mixer register read. addr:"+h(e)+" data:"+h(t),LOG_SB16)),t},SB16.prototype.mixer_write=function(e,t){var r=MIXER_WRITE_HANDLERS[e];r?r.call(this,t):dbg_log("unhandled mixer register write. addr:"+h(e)+" data:"+h(t),LOG_SB16)},SB16.prototype.mixer_default_read=function(){return dbg_log("mixer register read. addr:"+h(this.mixer_current_address),LOG_SB16),this.mixer_registers[this.mixer_current_address]},SB16.prototype.mixer_default_write=function(e){dbg_log("mixer register write. addr:"+h(this.mixer_current_address)+" data:"+h(e),LOG_SB16),this.mixer_registers[this.mixer_current_address]=e},SB16.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()},SB16.prototype.mixer_full_update=function(){for(var e=1;e<this.mixer_registers.length;e++)this.mixer_write(e,this.mixer_registers[e])},register_mixer_read(0,function(){return this.mixer_reset(),0}),register_mixer_write(0),register_mixer_legacy(4,50,51),register_mixer_legacy(34,48,49),register_mixer_legacy(38,52,53),register_mixer_legacy(40,54,55),register_mixer_legacy(46,56,57),register_mixer_volume(48,MIXER_SRC_MASTER,MIXER_CHANNEL_LEFT),register_mixer_volume(49,MIXER_SRC_MASTER,MIXER_CHANNEL_RIGHT),register_mixer_volume(50,MIXER_SRC_DAC,MIXER_CHANNEL_LEFT),register_mixer_volume(51,MIXER_SRC_DAC,MIXER_CHANNEL_RIGHT),register_mixer_read(59),register_mixer_write(59,function(e){this.mixer_registers[59]=e,this.bus.send("mixer-volume",[MIXER_SRC_PCSPEAKER,MIXER_CHANNEL_BOTH,6*(e>>>6)-18])}),register_mixer_read(65),register_mixer_write(65,function(e){this.mixer_registers[65]=e,this.bus.send("mixer-gain-left",6*(e>>>6))}),register_mixer_read(66),register_mixer_write(66,function(e){this.mixer_registers[66]=e,this.bus.send("mixer-gain-right",6*(e>>>6))}),register_mixer_read(68),register_mixer_write(68,function(e){this.mixer_registers[68]=e,e>>>=3,this.bus.send("mixer-treble-left",e-(16>e?14:16))}),register_mixer_read(69),register_mixer_write(69,function(e){this.mixer_registers[69]=e,e>>>=3,this.bus.send("mixer-treble-right",e-(16>e?14:16))}),register_mixer_read(70),register_mixer_write(70,function(e){this.mixer_registers[70]=e,e>>>=3,this.bus.send("mixer-bass-right",e-(16>e?14:16))}),register_mixer_read(71),register_mixer_write(71,function(e){this.mixer_registers[71]=e,e>>>=3,this.bus.send("mixer-bass-right",e-(16>e?14:16))}),register_mixer_read(128,function(){switch(this.irq){case SB_IRQ2:return 1;case SB_IRQ5:return 2;case SB_IRQ7:return 4;case SB_IRQ10:return 8;default:return 0}}),register_mixer_write(128,function(e){1&e&&(this.irq=SB_IRQ2),2&e&&(this.irq=SB_IRQ5),4&e&&(this.irq=SB_IRQ7),8&e&&(this.irq=SB_IRQ10)}),register_mixer_read(129,function(){var e=0;switch(this.dma_channel_8bit){case SB_DMA0:e|=1;break;case SB_DMA1:e|=2;break;case SB_DMA3:e|=8}switch(this.dma_channel_16bit){case SB_DMA5:e|=32;break;case SB_DMA6:e|=64;break;case SB_DMA7:e|=128}return e}),register_mixer_write(129,function(e){1&e&&(this.dma_channel_8bit=SB_DMA0),2&e&&(this.dma_channel_8bit=SB_DMA1),8&e&&(this.dma_channel_8bit=SB_DMA3),32&e&&(this.dma_channel_16bit=SB_DMA5),64&e&&(this.dma_channel_16bit=SB_DMA6),128&e&&(this.dma_channel_16bit=SB_DMA7)}),register_mixer_read(130,function(){for(var e=32,t=0;16>t;t++)e|=t*this.irq_triggered[t];return e}),SB16.prototype.fm_default_write=function(e,t,r){dbg_log("unhandled fm register write. addr:"+t+"|"+h(r)+" data:"+h(e),LOG_SB16)};var SB_FM_OPERATORS_BY_OFFSET=new Uint8Array(32);function get_fm_operator(e,t){return 18*e+SB_FM_OPERATORS_BY_OFFSET[t]}function audio_normalize(e,t,r){return audio_clip(e/t+r,-1,1)}function audio_clip(e,t,r){return(e<t)*t+(e>r)*r+(t<=e&&e<=r)*e}function VirtIO(e,t,r){this.pci_space=[244,26,9,16,7,5,16,0,0,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,9,0,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=48,this.pci_bars=[{size:256}],this.name="virtio";var s=e.io;s.register_read(43008,this,function(){return dbg_log("Read device features",LOG_VIRTIO),1},void 0,function(){return dbg_log("Read device features",LOG_VIRTIO),1}),s.register_write(43012,this,void 0,void 0,function(e){dbg_log("Guest feature selection: "+h(e,8),LOG_VIRTIO)}),s.register_write(43022,this,void 0,function(e){dbg_log("Queue select: "+h(e,4),LOG_VIRTIO),this.queue_select=e},void 0),s.register_read(43020,this,void 0,function(){return dbg_log("Read queue size",LOG_VIRTIO),this.queue_size},void 0),s.register_read(43016,this,void 0,void 0,function(){return dbg_log("Read queue address",LOG_VIRTIO),0===this.queue_select?this.queue_address:0}),s.register_write(43016,this,void 0,void 0,function(e){dbg_log("Write queue address: "+h(e,8),LOG_VIRTIO),this.queue_address=e}),s.register_write(43026,this,function(e){dbg_log("Write device status: "+h(e,2),LOG_VIRTIO),0===e?(dbg_log("Reset",LOG_VIRTIO),this.reset()):dbg_log(128&e?"Warning: Device status failed":(1&e?"ACKNOWLEDGE ":"")+(2&e?"DRIVER ":"")+(4&e?"DRIVER_OK":""),LOG_VIRTIO),this.device_status=e}),s.register_read(43026,this,function(){return dbg_log("Read device status: "+h(this.device_status),LOG_VIRTIO),this.device_status}),s.register_read(43027,this,function(){dbg_log("Read isr",LOG_VIRTIO);var e=this.isr;return this.isr=0,this.pci.lower_irq(this.pci_id),e}),s.register_write(43024,this,void 0,function(e){dbg_log("Write queue notify: "+h(e,4),LOG_VIRTIO),dbg_assert(0===e);var t=(this.queue_address<<12)+16*this.queue_size;e=t+4,t=this.cpu.read16(t+2),dbg_log("idx="+h(t,4),LOG_VIRTIO);var r=this.queue_size-1;for(t&=r;this.last_idx!==t;){var s=this.cpu.read16(e+2*this.last_idx);this.handle_descriptor(s),this.last_idx=this.last_idx+1&r}}),this.cpu=e,this.pci=e.devices.pci,this.bus=t,this.last_idx=this.isr=this.device_status=this.queue_select=0,this.queue_size=32;for(var i=this.queue_address=0;128>i;i++)s.register_read(43028+i,this,function(e){return dbg_log("Read device "+h(e),LOG_VIRTIO),e<this.device.configspace.length?this.device.configspace[e]:0}.bind(this,i),void 0,void 0),s.register_write(43028+i,this,function(e,t){dbg_log("Write device "+h(e)+": "+h(t,2),LOG_VIRTIO)}.bind(this,i),void 0,void 0);this.device=new Virtio9p(r,t),this.device.SendReply=this.device_reply.bind(this),e.devices.pci.register_device(this)}SB_FM_OPERATORS_BY_OFFSET[0]=0,SB_FM_OPERATORS_BY_OFFSET[1]=1,SB_FM_OPERATORS_BY_OFFSET[2]=2,SB_FM_OPERATORS_BY_OFFSET[3]=3,SB_FM_OPERATORS_BY_OFFSET[4]=4,SB_FM_OPERATORS_BY_OFFSET[5]=5,SB_FM_OPERATORS_BY_OFFSET[8]=6,SB_FM_OPERATORS_BY_OFFSET[9]=7,SB_FM_OPERATORS_BY_OFFSET[10]=8,SB_FM_OPERATORS_BY_OFFSET[11]=9,SB_FM_OPERATORS_BY_OFFSET[12]=10,SB_FM_OPERATORS_BY_OFFSET[13]=11,SB_FM_OPERATORS_BY_OFFSET[16]=12,SB_FM_OPERATORS_BY_OFFSET[17]=13,SB_FM_OPERATORS_BY_OFFSET[18]=14,SB_FM_OPERATORS_BY_OFFSET[19]=15,SB_FM_OPERATORS_BY_OFFSET[20]=16,SB_FM_OPERATORS_BY_OFFSET[21]=17,register_fm_write([1],function(e,t,r){this.fm_waveform_select_enable[t]=1&e,this.fm_update_waveforms()}),register_fm_write([2]),register_fm_write([3]),register_fm_write([4],function(e,t,r){}),register_fm_write([5],function(e,t,r){0===t&&this.fm_default_write(e,t,r)}),register_fm_write([8],function(e,t,r){}),register_fm_write(between(32,53),function(e,t,r){get_fm_operator(t,r-32)}),register_fm_write(between(64,85),function(e,t,r){get_fm_operator(t,r-64)}),register_fm_write(between(96,117),function(e,t,r){get_fm_operator(t,r-96)}),register_fm_write(between(128,149),function(e,t,r){get_fm_operator(t,r-128)}),register_fm_write(between(160,168),function(e,t,r){}),register_fm_write(between(176,184),function(e,t,r){}),register_fm_write([189],function(e,t,r){}),register_fm_write(between(192,200),function(e,t,r){}),register_fm_write(between(224,245),function(e,t,r){get_fm_operator(t,r-224)}),SB16.prototype.fm_update_waveforms=function(){},SB16.prototype.sampling_rate_change=function(e){this.sampling_rate=e,this.bus.send("dac-tell-sampling-rate",e)},SB16.prototype.get_channel_count=function(){return this.dsp_stereo?2:1},SB16.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)},SB16.prototype.dma_transfer_start=function(){dbg_log("begin dma transfer",LOG_SB16),this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=SB_DMA_BLOCK_SAMPLES*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)},SB16.prototype.dma_on_unmask=function(e){e===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))},SB16.prototype.dma_transfer_next=function(){var e=this;dbg_log("dma transfering next block",LOG_SB16);var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),r=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,function(s){dbg_log("dma block transfer "+(s?"unsuccessful":"successful"),LOG_SB16),s||(e.dma_to_dac(r),e.dma_bytes_left-=t,e.dma_bytes_left||(e.raise_irq(e.dma_irq),e.dma_autoinit&&(e.dma_bytes_left=e.dma_bytes_count)))})},SB16.prototype.dma_to_dac=function(e){for(var t=this.dsp_16bit?32767.5:127.5,r=this.dsp_signed?0:-1,s=this.dsp_stereo?1:2,i=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,_=0,a=0;a<e;a++)for(var o=audio_normalize(i[a],t,r),n=0;n<s;n++)this.dac_buffers[_].push(o),_^=1;this.dac_send()},SB16.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()},SB16.prototype.dac_send=function(){if(this.dac_buffers[0].length){var e=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),t=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[e,t],[e.buffer,t.buffer])}},SB16.prototype.raise_irq=function(e){dbg_log("raise irq",LOG_SB16),this.irq_triggered[e]=1,this.cpu.device_raise_irq(this.irq)},SB16.prototype.lower_irq=function(e){dbg_log("lower irq",LOG_SB16),this.irq_triggered[e]=0,this.cpu.device_lower_irq(this.irq)},VirtIO.prototype.get_state=function(){var e=[0];return e[1]=this.queue_select,e[2]=this.device_status,e[3]=this.isr,e[4]=this.last_idx,e[5]=this.queue_size,e[6]=this.queue_address,e[7]=this.device,e},VirtIO.prototype.set_state=function(e){this.queue_select=e[1],this.device_status=e[2],this.isr=e[3],this.last_idx=e[4],this.queue_size=e[5],this.queue_address=e[6],this.device=e[7],this.device.SendReply=this.device_reply.bind(this)},VirtIO.prototype.reset=function(){this.last_idx=this.isr=this.device_status=this.queue_select=0,this.queue_size=32,this.queue_address=0},VirtIO.prototype.handle_descriptor=function(e){for(var t=e,r=this.queue_address<<12,s=0,i=[];;){var _=r+16*t,a=this.cpu.read16(_+12);if(a&VRING_DESC_F_WRITE)break;a&VRING_DESC_F_INDIRECT&&dbg_assert(!1,"unsupported");var o=this.cpu.read32s(_),n=this.cpu.read32s(_+4),d=this.cpu.read32s(_+8)>>>0;if(i.push({addr_low:o,addr_high:n,len:d}),dbg_log("descriptor: addr="+h(n,8)+":"+h(o,8)+" len="+h(d,8)+" flags="+h(a,4)+" next="+h(t,4),LOG_VIRTIO),!(a&VRING_DESC_F_NEXT)){t=-1;break}dbg_assert((t=this.cpu.read16(_+14))<this.queue_size)}var g=-1,c=0;this.device.ReceiveRequest({start:e,next:t},function(){if(c>=g){if(s===i.length)return dbg_log("Read more data than descriptor has",LOG_VIRTIO),0;var e=i[s++];o=e.addr_low,g=e.len,c=0}return this.cpu.read8(o+c++)}.bind(this))},VirtIO.prototype.device_reply=function(e,t){if(-1===t.next)dbg_log("Reply to invalid index",LOG_VIRTIO);else{var r=this.queue_size-1;e=this.device.replybuffersize;for(var s=t.next,i=this.queue_address<<12,_=0,a=[];;){var o=i+16*s,n=this.cpu.read16(o+12);if(0==(n&VRING_DESC_F_WRITE)){dbg_log("Bug: Readonly ring after writeonly ring",LOG_VIRTIO);break}var d=this.cpu.read32s(o),g=this.cpu.read32s(o+4),c=this.cpu.read32s(o+8)>>>0;if(a.push({addr_low:d,addr_high:g,len:c}),dbg_log("descriptor: addr="+h(g,8)+":"+h(d,8)+" len="+h(c,8)+" flags="+h(n,4)+" next="+h(s,4),LOG_VIRTIO),!(n&VRING_DESC_F_NEXT))break;dbg_assert((s=this.cpu.read16(o+14))<this.queue_size)}for(i=-1,n=o=0;n<e;n++){if(s=this.device.replybuffer[n],o>=i){if(_===a.length)return dbg_log("Write more data than descriptor has",LOG_VIRTIO),0;d=(i=a[_++]).addr_low,i=i.len,o=0}this.cpu.write8(d+o++,s)}d=(d=(this.queue_address<<12)+16*this.queue_size+4+2*this.queue_size)+4095&-4096,n=this.cpu.read16(d),_=this.cpu.read16(d+2),this.cpu.write16(d+2,_+1),dbg_log("used descriptor: addr="+h(d,8)+" flags="+h(n,4)+" idx="+h(_,4),LOG_VIRTIO),r=d+4+8*(_&r),this.cpu.write32(r,t.start),this.cpu.write32(r+4,e),this.isr|=1,this.pci.raise_irq(this.pci_id)}};var Bus={};function BusConnector(){this.listeners={},this.pair=void 0}BusConnector.prototype.register=function(e,t,r){var s=this.listeners[e];void 0===s&&(s=this.listeners[e]=[]),s.push({fn:t,this_value:r})},BusConnector.prototype.unregister=function(e,t){var r=this.listeners[e];void 0!==r&&(this.listeners[e]=r.filter(function(e){return e.fn!==t}))},BusConnector.prototype.send=function(e,t,r){if(this.pair&&void 0!==(e=this.pair.listeners[e]))for(r=0;r<e.length;r++){var s=e[r];s.fn.call(s.this_value,t)}},BusConnector.prototype.send_async=function(e,t){dbg_assert(1===arguments.length||2===arguments.length),setTimeout(this.send.bind(this,e,t),0)},Bus.create=function(){var e=new BusConnector,t=new BusConnector;return e.pair=t,t.pair=e,[e,t]};var log_data=[];function do_the_log(e){LOG_TO_FILE?log_data.push(e,"\n"):console.log(e)}var dbg_log=function(){if(!DEBUG)return function(){};var e=LOG_NAMES.reduce(function(e,t){return e[t[0]]=t[1],e},{}),t="",r=0;return function(s,i){if(DEBUG&&(i=i||1)&LOG_LEVEL){if((s="["+v86util.pads(e[i]||"",4)+"] "+s)===t&&2048>++r)return;i=new Date,i=v86util.pad0(i.getHours(),2)+":"+v86util.pad0(i.getMinutes(),2)+":"+v86util.pad0(i.getSeconds(),2)+"+"+v86util.pad0(i.getMilliseconds(),3)+" ",r&&(do_the_log(1===r?i+t:"Previous message repeated "+r+" times"),r=0),do_the_log(i+s),t=s}}}();function dbg_trace(e){DEBUG&&dbg_log(Error().stack.replace(/(?:(?:t|t16|t32)\.\(anonymous function\)\.)+/g,"t.(anonymous function)."),e)}function dbg_assert(e,t,r){DEBUG&&(e||dbg_assert_failed(t))}function dbg_assert_failed(e){if(console.trace(),e)throw"Assert failed: "+e;throw"Assert failed"}var instruction_count,instruction_total,CPU_LOG_VERBOSE=!1;function CPU(e){this.memory_size=0,this.a20_enabled=!0,this.mem_page_infos=void 0,this.mem8=new Uint8Array(0),this.mem16=new Uint16Array(this.mem8.buffer),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=new Uint8Array(8),this.segment_limits=new Uint32Array(8),this.segment_offsets=new Int32Array(8),this.tlb_data=new Int32Array(1048576),this.tlb_info=new Uint8Array(1048576),this.tlb_info_global=new Uint8Array(1048576),this.protected_mode=!1,this.gdtr_offset=this.gdtr_size=this.idtr_offset=this.idtr_size=0,this.page_fault=this.tss_size_32=!1,this.cr=new Int32Array(8),this.cr[0]=0,this.cr[2]=0,this.cr[3]=0,this.page_size_extensions=this.cpl=this.cr[4]=0,this.in_hlt=this.stack_size_32=this.is_32=!1,this.last_result=this.last_add_result=this.last_op_size=this.last_op2=this.last_op1=this.flags_changed=this.flags=this.prefixes=this.sysenter_eip=this.sysenter_esp=this.sysenter_cs=this.esp_phys=this.last_virt_esp=this.eip_phys=this.last_virt_eip=0,this.mul32_result=new Int32Array(2),this.div32_result=new Float64Array(2),this.phys_addr_high=this.phys_addr=this.modrm_byte=this.tsc_offset=0,this.devices={},this.table=[],this.paging=!1,this.previous_ip=this.instruction_pointer=0,this.apic_enabled=!0,this.timestamp_counter=0,this.reg32s=new Int32Array(8),this.reg32=new Uint32Array(this.reg32s.buffer),this.reg16s=new Int16Array(this.reg32s.buffer),this.reg16=new Uint16Array(this.reg32s.buffer),this.reg8s=new Int8Array(this.reg32s.buffer),this.reg8=new Uint8Array(this.reg32s.buffer),this.reg_mmxs=new Int32Array(16),this.reg_mmx=new Uint32Array(this.reg_mmxs.buffer),this.reg_mmx8s=new Int8Array(this.reg_mmxs.buffer),this.reg_mmx8=new Uint8Array(this.reg_mmxs.buffer),this.reg_xmm32s=new Int32Array(32),this.mxcsr=8064,this.sreg=new Uint16Array(8),this.dreg=new Int32Array(8),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.fw_value=0,this.fpu=this.io=void 0,this.bus=e,dbg_assert(this.table16&&this.table32),dbg_assert(this.table0F_16&&this.table0F_32),this.update_operand_size(),this.tsc_offset=v86.microtick(),this.debug_init(),this.init2()}CPU.prototype.get_state=function(){var e=[];return e[0]=this.memory_size,e[1]=this.segment_is_null,e[2]=this.segment_offsets,e[3]=this.segment_limits,e[4]=this.protected_mode,e[5]=this.idtr_offset,e[6]=this.idtr_size,e[7]=this.gdtr_offset,e[8]=this.gdtr_size,e[9]=this.page_fault,e[10]=this.cr,e[11]=this.cpl,e[12]=this.page_size_extensions,e[13]=this.is_32,e[16]=this.stack_size_32,e[17]=this.in_hlt,e[18]=this.last_virt_eip,e[19]=this.eip_phys,e[20]=this.last_virt_esp,e[21]=this.esp_phys,e[22]=this.sysenter_cs,e[23]=this.sysenter_eip,e[24]=this.sysenter_esp,e[25]=this.prefixes,e[26]=this.flags,e[27]=this.flags_changed,e[28]=this.last_op1,e[29]=this.last_op2,e[30]=this.last_op_size,e[31]=this.last_add_result,e[32]=this.modrm_byte,e[36]=this.paging,e[37]=this.instruction_pointer,e[38]=this.previous_ip,e[39]=this.reg32s,e[40]=this.sreg,e[41]=this.dreg,e[42]=this.mem8,e[43]=this.fpu,e[45]=this.devices.virtio,e[46]=this.devices.apic,e[47]=this.devices.rtc,e[48]=this.devices.pci,e[49]=this.devices.dma,e[50]=this.devices.acpi,e[51]=this.devices.hpet,e[52]=this.devices.vga,e[53]=this.devices.ps2,e[54]=this.devices.uart,e[55]=this.devices.fdc,e[56]=this.devices.cdrom,e[57]=this.devices.hda,e[58]=this.devices.pit,e[59]=this.devices.net,e[60]=this.devices.pic,e[61]=this.devices.sb16,e[62]=this.a20_enabled,e[63]=this.fw_value,e[64]=this.devices.ioapic,e[65]=this.tss_size_32,e[66]=this.reg_mmxs,e},CPU.prototype.set_state=function(e){this.memory_size=e[0],this.segment_is_null=e[1],this.segment_offsets=e[2],this.segment_limits=e[3],this.protected_mode=e[4],this.idtr_offset=e[5],this.idtr_size=e[6],this.gdtr_offset=e[7],this.gdtr_size=e[8],this.page_fault=e[9],this.cr=e[10],this.cpl=e[11],this.page_size_extensions=e[12],this.is_32=e[13],this.stack_size_32=e[16],this.in_hlt=e[17],this.last_virt_eip=e[18],this.eip_phys=e[19],this.last_virt_esp=e[20],this.esp_phys=e[21],this.sysenter_cs=e[22],this.sysenter_eip=e[23],this.sysenter_esp=e[24],this.prefixes=e[25],this.flags=e[26],this.flags_changed=e[27],this.last_op1=e[28],this.last_op2=e[29],this.last_op_size=e[30],this.last_add_result=e[31],this.modrm_byte=e[32],this.paging=e[36],this.instruction_pointer=e[37],this.previous_ip=e[38],this.reg32s=e[39],this.sreg=e[40],this.dreg=e[41],this.mem8=e[42],this.fpu=e[43],this.devices.virtio=e[45],this.devices.apic=e[46],this.devices.rtc=e[47],this.devices.pci=e[48],this.devices.dma=e[49],this.devices.acpi=e[50],this.devices.hpet=e[51],this.devices.vga=e[52],this.devices.ps2=e[53],this.devices.uart=e[54],this.devices.fdc=e[55],this.devices.cdrom=e[56],this.devices.hda=e[57],this.devices.pit=e[58],this.devices.net=e[59],this.devices.pic=e[60],this.devices.sb16=e[61],this.a20_enabled=e[62],this.fw_value=e[63],this.devices.ioapic=e[64],this.tss_size_32=e[65],this.reg_mmxs=e[66],this.mem16=new Uint16Array(this.mem8.buffer,this.mem8.byteOffset,this.mem8.length>>1),this.mem32s=new Int32Array(this.mem8.buffer,this.mem8.byteOffset,this.mem8.length>>2),this.full_clear_tlb(),this.reg32=new Uint32Array(this.reg32s.buffer),this.reg16s=new Int16Array(this.reg32s.buffer),this.reg16=new Uint16Array(this.reg32s.buffer),this.reg8s=new Int8Array(this.reg32s.buffer),this.reg8=new Uint8Array(this.reg32s.buffer),this.reg_mmx=new Uint32Array(this.reg_mmxs.buffer),this.reg_mmx8s=new Int8Array(this.reg_mmxs.buffer),this.reg_mmx8=new Uint8Array(this.reg_mmxs.buffer),this.update_operand_size()},CPU.prototype.main_run=function(){if(this.in_hlt){var e=this.hlt_loop();if(this.in_hlt)return e}return this.do_run(),0},CPU.prototype.exception_cleanup=function(e){if(e!==MAGIC_CPU_EXCEPTION)throw console.log(e),console.log(e.stack),e;this.page_fault=!1,this.clear_prefixes()},CPU.prototype.reboot_internal=function(){throw this.reset(),this.load_bios(),MAGIC_CPU_EXCEPTION},CPU.prototype.reset=function(){this.a20_enabled=!0;for(var e=0;8>e;e++)this.segment_is_null[e]=0,this.segment_limits[e]=0,this.segment_offsets[e]=0;for(this.full_clear_tlb(),e=0;8>e;e++)this.reg32s[e]=0,this.sreg[e]=0,this.cr[e]=0,this.dreg[e]=0;for(e=0;e<this.reg_mmxs.length;e++)this.reg_mmxs[e]=0;for(e=0;e<this.reg_xmm32s.length;e++)this.reg_xmm32s[e]=0;this.mxcsr=8064,this.protected_mode=!1,this.gdtr_offset=this.gdtr_size=this.idtr_offset=this.idtr_size=0,this.page_fault=!1,this.cr[0]=1610612752,this.cr[2]=0,this.cr[3]=0,this.cr[4]=0,this.dreg[6]=-61456,this.dreg[7]=1024,this.cpl=0,this.paging=!1,this.page_size_extensions=0,this.stack_size_32=this.is_32=!1,this.prefixes=0,this.last_virt_esp=this.last_virt_eip=-1,this.update_operand_size(),this.previous_ip=this.timestamp_counter=0,this.in_hlt=!1,this.sysenter_eip=this.sysenter_esp=this.sysenter_cs=0,this.flags=flags_default,this.last_op_size=this.last_op2=this.last_op1=this.last_add_result=this.last_result=this.flags_changed=0,this.tsc_offset=v86.microtick(),this.instruction_pointer=1048560,this.switch_cs_real_mode(61440),this.switch_seg(reg_ss,48),this.reg16[reg_sp]=256,this.devices.virtio&&this.devices.virtio.reset(),this.fw_value=0},CPU.prototype.create_memory=function(e){1048576>e?e=1048576:0>(0|e)&&(e=Math.pow(2,31)-MMAP_BLOCK_SIZE),dbg_assert(0<(0|(e=1+(e-1|MMAP_BLOCK_SIZE-1)|0))),dbg_assert(0==(e&MMAP_BLOCK_SIZE-1)),this.memory_size=e,e=new ArrayBuffer(e),this.mem8=new Uint8Array(e),this.mem16=new Uint16Array(e),this.mem32s=new Int32Array(e)},goog.exportProperty(CPU.prototype,"create_memory",CPU.prototype.create_memory),CPU.prototype.init=function(e,t){this.create_memory("number"==typeof e.memory_size?e.memory_size:67108864),this.reset();var r=new IO(this);this.io=r,this.bios.main=e.bios,this.bios.vga=e.vga_bios,this.load_bios();var s=0;r.register_read(179,this,function(){return dbg_log("port 0xB3 read"),0}),r.register_read(146,this,function(){return s}),r.register_write(146,this,function(e){s=e}),r.register_read(1297,this,function(){var e=255&this.fw_value;return this.fw_value>>>=8,e}),r.register_write(1296,this,void 0,function(e){dbg_log("bios config port, index="+h(e)),e===FW_CFG_SIGNATURE?this.fw_value=-89064784:e===FW_CFG_RAM_SIZE?this.fw_value=this.memory_size:e===FW_CFG_NB_CPUS?this.fw_value=1:(dbg_assert(!1,"Unimplemented fw index: "+h(e)),this.fw_value=0)}),DEBUG&&r.register_write(128,this,function(e){}),this.devices={},e.load_devices&&(this.devices.pic=new PIC(this),this.devices.pci=new PCI(this),ENABLE_ACPI&&(this.devices.ioapic=new IOAPIC(this),this.devices.apic=new APIC(this),this.devices.acpi=new ACPI(this)),this.devices.rtc=new RTC(this),this.fill_cmos(this.devices.rtc,e),this.devices.dma=new DMA(this),ENABLE_HPET&&(this.devices.hpet=new HPET(this)),this.devices.vga=new VGAScreen(this,t,e.vga_memory_size||8388608),this.fpu=new FPU(this),this.devices.ps2=new PS2(this,t),this.devices.uart=new UART(this,1016,t),this.devices.fdc=new FloppyController(this,e.fda,e.fdb),r=0,e.hda&&(this.devices.hda=new IDEDevice(this,e.hda,!1,r++,t)),e.cdrom&&(this.devices.cdrom=new IDEDevice(this,e.cdrom,!0,r++,t)),e.hdb&&(this.devices.hdb=new IDEDevice(this,e.hdb,!1,r++,t)),this.devices.pit=new PIT(this,t),e.enable_ne2k&&(this.devices.net=new Ne2k(this,t)),e.fs9p&&(this.devices.virtio=new VirtIO(this,t,e.fs9p)),this.devices.sb16=new SB16(this,t)),e.multiboot&&(dbg_assert(e.multiboot.buffer),this.load_multiboot(e.multiboot.buffer)),DEBUG&&this.debug.init()},CPU.prototype.load_multiboot=function(e){if(dbg_log("Trying multiboot from buffer of size "+e.byteLength,LOG_CPU),8192>e.byteLength){var t=new Int32Array(2048);new Uint8Array(t.buffer).set(new Uint8Array(e))}else t=new Int32Array(e,0,2048);for(var r=0;8192>r;r+=4)if(464367618===t[r>>2]){var s=t[r+4>>2];if(!(464367618+s+t[r+8>>2]|0)){dbg_log("Multiboot magic found, flags: "+h(s>>>0,8),LOG_CPU),dbg_assert(0==(-65537&s),"TODO"),this.reg32s[reg_eax]=732803074,this.reg32s[reg_ebx]=31744,this.write32(31744,0),this.cr[0]=1,this.protected_mode=!0,this.flags=flags_default,this.update_cs_size(!0),this.stack_size_32=!0;for(var i=0;6>i;i++)this.segment_is_null[i]=0,this.segment_offsets[i]=0,this.segment_limits[i]=4294967295,this.sreg[i]=45058;if(65536&s){dbg_log("Multiboot specifies its own address table",LOG_CPU);var _=t[r+12>>2];s=t[r+16>>2],i=t[r+20>>2];var a=t[r+24>>2];t=t[r+28>>2],dbg_log("header="+h(_,8)+" load="+h(s,8)+" load_end="+h(i,8)+" bss_end="+h(a,8)+" entry="+h(t,8)),dbg_assert(s<=_),r-=_-s,0===i?i=void 0:(dbg_assert(i>=s),i-=s),e=new Uint8Array(e,r,i),this.write_blob(e,s),this.instruction_pointer=this.get_seg(reg_cs)+t|0}else if(1179403647===t[0])for(dbg_log("Multiboot image is in elf format",LOG_CPU),s=read_elf(e),this.instruction_pointer=this.get_seg(reg_cs)+s.header.entry|0,r=(s=$jscomp.makeIterator(s.program_headers)).next();!r.done;r=s.next())0!==(r=r.value).type&&(1===r.type?(dbg_assert(r.paddr===r.vaddr),dbg_assert(r.filesz<=r.memsz),t=new Uint8Array(e,r.offset,r.filesz),this.write_blob(t,r.paddr)):4!==r.type&&1685382480!==r.type&&1685382481!==r.type&&dbg_assert(!1,"unimplemented elf section type"));else dbg_assert(!1,"Not a bootable multiboot format");for(this.io.register_write_consecutive(244,this,function(e){throw console.log("Test exited with code "+h(e,2)),"HALT"},function(){},function(){},function(){}),e={i$10:14};15>=e.i$10;(e={i$10:e.i$10}).i$10++)this.io.register_write(8192+e.i$10,this,function(e){return function(t){dbg_log("kvm-unit-test: Set irq "+h(e.i$10)+" to "+h(t,2)),t?this.device_raise_irq(e.i$10):this.device_lower_irq(e.i$10)}}(e));dbg_log("Starting multiboot kernel at:",LOG_CPU),this.debug.dump_state(),this.debug.dump_regs();break}dbg_log("Multiboot checksum check failed",LOG_CPU)}},CPU.prototype.fill_cmos=function(e,t){var r=t.boot_order||531;e.cmos_write(CMOS_BIOS_BOOTFLAG1,1|r>>4&240),e.cmos_write(CMOS_BIOS_BOOTFLAG2,255&r),e.cmos_write(CMOS_MEM_BASE_LOW,128),e.cmos_write(CMOS_MEM_BASE_HIGH,2),r=0,1048576<=this.memory_size&&(r=this.memory_size-1048576>>10,r=Math.min(r,65535)),e.cmos_write(CMOS_MEM_OLD_EXT_LOW,255&r),e.cmos_write(CMOS_MEM_OLD_EXT_HIGH,r>>8&255),e.cmos_write(CMOS_MEM_EXTMEM_LOW,255&r),e.cmos_write(CMOS_MEM_EXTMEM_HIGH,r>>8&255),r=0,16777216<=this.memory_size&&(r=this.memory_size-16777216>>16,r=Math.min(r,65535)),e.cmos_write(CMOS_MEM_EXTMEM2_LOW,255&r),e.cmos_write(CMOS_MEM_EXTMEM2_HIGH,r>>8&255),e.cmos_write(CMOS_MEM_HIGHMEM_LOW,0),e.cmos_write(CMOS_MEM_HIGHMEM_MID,0),e.cmos_write(CMOS_MEM_HIGHMEM_HIGH,0),e.cmos_write(CMOS_EQUIPMENT_INFO,47),e.cmos_write(CMOS_BIOS_SMP_COUNT,0),t.fastboot&&e.cmos_write(63,1)},CPU.prototype.load_bios=function(){var e=this.bios.main,t=this.bios.vga;if(e){var r=new Uint8Array(e);if(this.write_blob(r,1048576-e.byteLength),t){var s=new Uint8Array(t);this.write_blob(s,786432),this.io.mmap_register(4272947200,1048576,function(e){return(e=e-4272947200|0)<s.length?s[e]:0},function(e,t){dbg_assert(!1,"Unexpected write to VGA rom")})}else dbg_log("Warning: No VGA BIOS");this.io.mmap_register(4293918720,1048576,function(e){return this.mem8[1048575&e]}.bind(this),function(e,t){this.mem8[1048575&e]=t}.bind(this))}else dbg_log("Warning: No BIOS")},CPU.prototype.do_run=function(){for(var e=v86.microtick(),t=e;t-e<TIME_PER_FRAME&&(this.run_hardware_timers(t),this.handle_irqs(),this.do_many_cycles(),!this.in_hlt);)t=v86.microtick()},CPU.prototype.do_many_cycles=function(){try{this.do_many_cycles_unsafe()}catch(e){this.exception_cleanup(e)}},CPU.prototype.do_many_cycles_unsafe=function(){for(var e=LOOP_COUNTER;e--;)this.cycle_internal()},"undefined"!=typeof window&&(window.__no_inline_for_closure_compiler__=[CPU.prototype.exception_cleanup,CPU.prototype.do_many_cycles_unsafe,CPU.prototype.do_many_cycles]);var PROFILING=!1;function DynamicTranslator(e){dbg_assert(!1),this.clear_cache=function(){},this.cycle_translated=function(){}}CPU.prototype.cycle_internal=function(){if(this.previous_ip=this.instruction_pointer,this.timestamp_counter++,PROFILING)var e=performance.now();var t=this.read_imm8();if(DEBUG&&this.debug.logop(this.instruction_pointer-1>>>0,t),this.table[t](this),PROFILING){var r=performance.now();instruction_total[t]+=r-e,instruction_count[t]++}this.flags&flag_trap&&dbg_log("Trap flag: Ignored",LOG_CPU)},CPU.prototype.cycle=function(){try{this.cycle_internal()}catch(e){this.exception_cleanup(e)}},goog.exportProperty(CPU.prototype,"cycle",CPU.prototype.cycle),CPU.prototype.segment_prefix_op=function(e){dbg_assert(5>=e),this.prefixes|=e+1,this.run_prefix_instruction(),this.prefixes=0},CPU.prototype.run_prefix_instruction=function(){this.is_osize_32()?this.table32[this.read_imm8()](this):this.table16[this.read_imm8()](this)},CPU.prototype.hlt_loop=function(){return dbg_assert(this.flags&flag_interrupt),this.run_hardware_timers(v86.microtick()),this.handle_irqs(),0},CPU.prototype.run_hardware_timers=function(e){ENABLE_HPET?(this.devices.pit.timer(e,this.devices.hpet.legacy_mode),this.devices.rtc.timer(e,this.devices.hpet.legacy_mode),this.devices.hpet.timer(e)):(this.devices.pit.timer(e,!1),this.devices.rtc.timer(e,!1)),ENABLE_ACPI&&(this.devices.acpi.timer(e),this.devices.apic.timer(e))},CPU.prototype.clear_prefixes=function(){this.prefixes=0},CPU.prototype.set_cr0=function(e){if((e&(CR0_PE|CR0_PG))===CR0_PG)throw this.debug.unimpl("#GP handler");this.cr[0]=e,this.fpu||(this.cr[0]|=CR0_EM),this.cr[0]|=CR0_ET,e=(this.cr[0]&CR0_PG)===CR0_PG,dbg_assert("boolean"==typeof this.paging),e!==this.paging&&(this.paging=e,this.full_clear_tlb()),this.protected_mode=(this.cr[0]&CR0_PE)===CR0_PE},CPU.prototype.set_cr4=function(e){if(-3565568&e&&this.trigger_gp(0),(this.cr[4]^e)&CR4_PGE&&(e&CR4_PGE?this.clear_tlb():this.full_clear_tlb()),this.cr[4]=e,this.page_size_extensions=e&CR4_PSE?PSE_ENABLED:0,e&CR4_PAE)throw this.debug.unimpl("PAE");4294965504&e&&(dbg_assert(!1,"Unimplemented CR4 bits: "+h(e)),this.trigger_ud()),dbg_log("cr4="+h(e>>>0),LOG_CPU)},CPU.prototype.cpl_changed=function(){this.last_virt_esp=this.last_virt_eip=-1},CPU.prototype.read_imm8=function(){-4096&this.instruction_pointer^this.last_virt_eip&&(this.eip_phys=this.translate_address_read(this.instruction_pointer)^this.instruction_pointer,this.last_virt_eip=-4096&this.instruction_pointer);var e=this.read8(this.eip_phys^this.instruction_pointer);return this.instruction_pointer=this.instruction_pointer+1|0,e},CPU.prototype.read_imm8s=function(){return this.read_imm8()<<24>>24},CPU.prototype.read_imm16=function(){if(4094<(this.instruction_pointer^this.last_virt_eip)>>>0)return this.read_imm8()|this.read_imm8()<<8;var e=this.read16(this.eip_phys^this.instruction_pointer);return this.instruction_pointer=this.instruction_pointer+2|0,e},CPU.prototype.read_imm32s=function(){if(4092<(this.instruction_pointer^this.last_virt_eip)>>>0)return this.read_imm16()|this.read_imm16()<<16;var e=this.read32s(this.eip_phys^this.instruction_pointer);return this.instruction_pointer=this.instruction_pointer+4|0,e},CPU.prototype.create_atom64s=function(e,t){var r=new Int32Array(2);return r[0]=e,r[1]=t,r},CPU.prototype.create_atom128s=function(e,t,r,s){var i=new Int32Array(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=s,i},CPU.prototype.read_modrm_byte=function(){this.modrm_byte=this.read_imm8()},CPU.prototype.read_op0F=CPU.prototype.read_imm8,CPU.prototype.read_sib=CPU.prototype.read_imm8,CPU.prototype.read_op8=CPU.prototype.read_imm8,CPU.prototype.read_op8s=CPU.prototype.read_imm8s,CPU.prototype.read_op16=CPU.prototype.read_imm16,CPU.prototype.read_op32s=CPU.prototype.read_imm32s,CPU.prototype.read_disp8=CPU.prototype.read_imm8,CPU.prototype.read_disp8s=CPU.prototype.read_imm8s,CPU.prototype.read_disp16=CPU.prototype.read_imm16,CPU.prototype.read_disp32s=CPU.prototype.read_imm32s,CPU.prototype.init2=function(){},CPU.prototype.branch_taken=function(){},CPU.prototype.branch_not_taken=function(){},CPU.prototype.diverged=function(){},CPU.prototype.modrm_resolve=function(e){return dbg_assert(192>e),(this.is_asize_32()?this.modrm_table32:this.modrm_table16)[e](this)},CPU.prototype.sib_resolve=function(e){return this.sib_table[this.read_sib()](this,e)},CPU.prototype.clear_instruction_cache=function(){},CPU.prototype.virt_boundary_read16=function(e,t){return dbg_assert(4095==(4095&e)),dbg_assert(0==(4095&t)),this.read8(e)|this.read8(t)<<8},CPU.prototype.virt_boundary_read32s=function(e,t){dbg_assert(4093<=(4095&e)),dbg_assert((t-3&4095)==(4095&e));var r=1&e?2&e?this.read_aligned16(t-2>>1):this.read_aligned16(e+1>>1):this.virt_boundary_read16(e+1|0,t-1|0);return this.read8(e)|r<<8|this.read8(t)<<24},CPU.prototype.virt_boundary_write16=function(e,t,r){dbg_assert(4095==(4095&e)),dbg_assert(0==(4095&t)),this.write8(e,r),this.write8(t,r>>8)},CPU.prototype.virt_boundary_write32=function(e,t,r){dbg_assert(4093<=(4095&e)),dbg_assert((t-3&4095)==(4095&e)),this.write8(e,r),this.write8(t,r>>24),1&e?2&e?(this.write8(t-2,r>>8),this.write8(t-1,r>>16)):(this.write8(e+1|0,r>>8),this.write8(e+2|0,r>>16)):(this.write8(e+1|0,r>>8),this.write8(t-1,r>>16))},CPU.prototype.safe_read8=function(e){return dbg_assert(2147483648>e),this.read8(this.translate_address_read(e))},CPU.prototype.safe_read16=function(e){return this.paging&&4095==(4095&e)?this.safe_read8(e)|this.safe_read8(e+1|0)<<8:this.read16(this.translate_address_read(e))},CPU.prototype.safe_read32s=function(e){return this.paging&&4093<=(4095&e)?this.safe_read16(e)|this.safe_read16(e+2|0)<<16:this.read32s(this.translate_address_read(e))},CPU.prototype.safe_read64s=function(e){var t=this.create_atom64s(0,0);return this.paging&&4089<=(4095&e)?(t[0]=this.safe_read32s(e),t[1]=this.safe_read32s(e+4|0)):(t[0]=this.read32s(this.translate_address_read(e)),t[1]=this.read32s(this.translate_address_read(e+4|0))),t},CPU.prototype.safe_read128s_aligned=function(e){return dbg_assert(0==(15&e)),e=this.translate_address_read(e),this.create_atom128s(this.read32s(e),this.read32s(e+4|0),this.read32s(e+8|0),this.read32s(e+12|0))},CPU.prototype.safe_read128s_unaligned=function(e){return this.create_atom128s(this.safe_read32s(e),this.safe_read32s(e+4|0),this.safe_read32s(e+8|0),this.safe_read32s(e+12|0))},CPU.prototype.safe_write8=function(e,t){dbg_assert(2147483648>e),this.write8(this.translate_address_write(e),t)},CPU.prototype.safe_write16=function(e,t){var r=this.translate_address_write(e);4095==(4095&e)?this.virt_boundary_write16(r,this.translate_address_write(e+1|0),t):this.write16(r,t)},CPU.prototype.safe_write32=function(e,t){var r=this.translate_address_write(e);4093<=(4095&e)?this.virt_boundary_write32(r,this.translate_address_write(e+3&-4)|e+3&3,t):this.write32(r,t)},CPU.prototype.safe_write64=function(e,t,r){this.writable_or_pagefault(e,8),this.safe_write32(e,t),this.safe_write32(e+4|0,r)},CPU.prototype.safe_write128=function(e,t,r,s,i){this.writable_or_pagefault(e,16),this.safe_write32(e,t),this.safe_write32(e+4|0,r),this.safe_write32(e+8|0,s),this.safe_write32(e+12|0,i)},CPU.prototype.read_moffs=function(){return this.is_asize_32()?this.get_seg_prefix(reg_ds)+this.read_op32s()|0:this.get_seg_prefix(reg_ds)+this.read_op16()|0},CPU.prototype.getiopl=function(){return this.flags>>12&3},CPU.prototype.vm86_mode=function(){return!!(this.flags&flag_vm)},CPU.prototype.get_eflags=function(){return this.flags&~flags_all|!!this.getcf()|!!this.getpf()<<2|!!this.getaf()<<4|!!this.getzf()<<6|!!this.getsf()<<7|!!this.getof()<<11},CPU.prototype.update_eflags=function(e){var t=flag_rf|flag_vm|flag_vip|flag_vif,r=~flag_vip&~flag_vif&flags_mask;this.flags&flag_vm?(dbg_assert(3===this.getiopl()),t|=flag_iopl,r|=flag_vip|flag_vif):(this.protected_mode||dbg_assert(0===this.cpl),this.cpl&&(t|=flag_iopl,this.cpl>this.getiopl()&&(t|=flag_interrupt))),this.flags=(e^(this.flags^e)&t)&r|flags_default,this.flags_changed=0},CPU.prototype.get_stack_reg=function(){return this.stack_size_32?this.reg32s[reg_esp]:this.reg16[reg_sp]},CPU.prototype.set_stack_reg=function(e){this.stack_size_32?this.reg32s[reg_esp]=e:this.reg16[reg_sp]=e},CPU.prototype.adjust_stack_reg=function(e){this.stack_size_32?this.reg32s[reg_esp]+=e:this.reg16[reg_sp]+=e},CPU.prototype.get_stack_pointer=function(e){return this.stack_size_32?this.get_seg(reg_ss)+this.reg32s[reg_esp]+e|0:this.get_seg(reg_ss)+(this.reg16[reg_sp]+e&65535)|0},CPU.prototype.get_real_eip=function(){return this.instruction_pointer-this.get_seg(reg_cs)|0},CPU.prototype.call_interrupt_vector=function(e,t,r){if(CPU_LOG_VERBOSE&&this.debug.dump_state("int "+h(e)+" start ("+(t?"soft":"hard")+"ware)"),CPU_LOG_VERBOSE&&this.debug.dump_regs(),this.debug.debug_interrupt(e),dbg_assert(!1===r||"number"==typeof r),this.in_hlt=!1,this.protected_mode){if(this.vm86_mode()&&this.cr[4]&CR4_VME)throw this.debug.unimpl("VME");if(this.vm86_mode()&&t&&3>this.getiopl()&&(dbg_log("call_interrupt_vector #GP. vm86 && software int && iopl < 3",LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0)),(e<<3|7)>this.idtr_size)throw dbg_log(e,LOG_CPU),dbg_trace(LOG_CPU),this.debug.unimpl("#GP handler");var s=this.idtr_offset+(e<<3)|0;dbg_assert(4088>(4095&s)),this.paging&&(s=this.translate_address_system_read(s));var i=this.read16(s)|this.read16(s+6|0)<<16,_=this.read16(s+2|0),a=this.read8(s+5|0),o=a>>5&3,n=31&a;if(0==(128&a))throw this.debug.unimpl("#NP handler");if(t&&o<this.cpl&&(dbg_log("#gp software interrupt ("+h(e,2)+") and dpl < cpl",LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(e<<3|2)),5===n)return dbg_log("interrupt to task gate: int="+h(e,2)+" sel="+h(_,4)+" dpl="+o,LOG_CPU),dbg_trace(LOG_CPU),this.do_task_switch(_,r),void(CPU_LOG_VERBOSE&&this.debug.dump_state("int end"));if(6!=(-10&n))throw dbg_trace(LOG_CPU),dbg_log("invalid type: "+h(n)),dbg_log(h(s)+" "+h(i>>>0)+" "+h(_)),this.debug.unimpl("#GP handler");if(t=1==(1&n),n=0==(8&n),dbg_assert(i>>>0<=(s=this.lookup_segment_selector(_)).effective_limit),dbg_assert(s.is_valid),s.is_null)throw dbg_log("is null"),this.debug.unimpl("#GP handler");if(!s.is_executable||s.dpl>this.cpl)throw dbg_log("not exec"),this.debug.unimpl("#GP handler");if(s.is_present||(dbg_log("not present"),this.trigger_np(e<<3|2)),e=this.get_eflags(),!s.dc_bit&&s.dpl<this.cpl){o=this.get_tss_stack_addr(s.dpl),this.tss_size_32?(a=this.read32s(o),o=this.read16(o+4|0)):(a=this.read16(o),o=this.read16(o+2|0));var d=this.lookup_segment_selector(o);if(dbg_assert(d.is_valid&&!d.is_system&&d.is_writable),d.is_null)throw this.debug.unimpl("#TS handler");if(d.rpl!==s.dpl)throw this.debug.unimpl("#TS handler");if(d.dpl!==s.dpl||!d.rw_bit)throw this.debug.unimpl("#TS handler");if(!d.is_present)throw this.debug.unimpl("#TS handler");var g=this.reg32s[reg_esp],c=this.sreg[reg_ss];e&flag_vm&&dbg_assert(0===s.dpl,"switch to non-0 dpl from vm86 mode");var p=(n?2:4)*(5+(!1!==r)+4*((e&flag_vm)===flag_vm));this.translate_address_system_write(d.base+(d.size?a-p:a-p&65535)),this.translate_address_system_write(d.base+a-1),this.cpl=s.dpl,this.cpl_changed(),this.update_cs_size(s.size),this.flags=this.flags&~flag_vm&~flag_rf,this.switch_seg(reg_ss,o),this.set_stack_reg(a),e&flag_vm&&(n?dbg_assert(!1):(this.push32(this.sreg[reg_gs]),this.push32(this.sreg[reg_fs]),this.push32(this.sreg[reg_ds]),this.push32(this.sreg[reg_es]))),n?(this.push16(c),this.push16(g)):(this.push32(c),this.push32(g))}else{if(!s.dc_bit&&s.dpl!==this.cpl)throw this.debug.unimpl("#GP handler");this.flags&flag_vm&&(dbg_assert(!1,"check error code"),this.trigger_gp(-4&_)),p=(n?2:4)*(3+(!1!==r)),this.writable_or_pagefault(this.get_stack_pointer(-p),p)}n?(this.push16(e),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()),!1!==r&&this.push16(r),i&=65535):(this.push32(e),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip()),!1!==r&&this.push32(r)),e&flag_vm&&(this.switch_seg(reg_gs,0),this.switch_seg(reg_fs,0),this.switch_seg(reg_ds,0),this.switch_seg(reg_es,0)),this.sreg[reg_cs]=-4&_|this.cpl,dbg_assert((3&this.sreg[reg_cs])===this.cpl),this.update_cs_size(s.size),this.segment_limits[reg_cs]=s.effective_limit,this.segment_offsets[reg_cs]=s.base,this.instruction_pointer=this.get_seg(reg_cs)+i|0,this.flags=this.flags&~flag_nt&~flag_vm&~flag_rf&~flag_trap,t?this.page_fault||this.handle_irqs():this.flags&=~flag_interrupt}else i=e<<2,r=this.read16(i),i=this.read16(i+2|0),this.push16(this.get_eflags()),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()),this.flags&=~flag_interrupt,this.switch_cs_real_mode(i),this.instruction_pointer=this.get_seg(reg_cs)+r|0;CPU_LOG_VERBOSE&&this.debug.dump_state("int end")},CPU.prototype.iret16=function(){this.iret(!0)},CPU.prototype.iret32=function(){this.iret(!1)},CPU.prototype.iret=function(e){if(CPU_LOG_VERBOSE&&this.debug.dump_state("iret"+(e?"16":"32")+" start"),this.vm86_mode()&&3>this.getiopl()&&(dbg_log("#gp iret vm86 mode, iopl != 3",LOG_CPU),this.trigger_gp(0)),e)var t=this.safe_read16(this.get_stack_pointer(0)),r=this.safe_read16(this.get_stack_pointer(2)),s=this.safe_read16(this.get_stack_pointer(4));else t=this.safe_read32s(this.get_stack_pointer(0)),r=this.safe_read16(this.get_stack_pointer(4)),s=this.safe_read32s(this.get_stack_pointer(8));if(!this.protected_mode||this.vm86_mode()&&3===this.getiopl()){if(4294901760&t)throw this.debug.unimpl("#GP handler");this.switch_cs_real_mode(r),this.instruction_pointer=t+this.get_seg(reg_cs)|0,e?(this.update_eflags(s|-65536&this.flags),this.adjust_stack_reg(6)):(this.update_eflags(s),this.adjust_stack_reg(12)),CPU_LOG_VERBOSE&&this.debug.dump_state("iret end")}else{if(dbg_assert(!this.vm86_mode()),this.flags&flag_nt){if(DEBUG)throw this.debug.unimpl("nt");this.trigger_gp(0)}if(s&flag_vm){if(0===this.cpl){dbg_assert(!e),dbg_assert(0==(-65536&t));var i=this.safe_read32s(this.get_stack_pointer(12)),_=this.safe_read16(this.get_stack_pointer(16));e=this.safe_read16(this.get_stack_pointer(20));var a=this.safe_read16(this.get_stack_pointer(24)),o=this.safe_read16(this.get_stack_pointer(28)),n=this.safe_read16(this.get_stack_pointer(32));return this.update_eflags(s),this.flags|=flag_vm,this.switch_cs_real_mode(r),this.instruction_pointer=(65535&t)+this.get_seg(reg_cs)|0,this.switch_seg(reg_es,e),this.switch_seg(reg_ds,a),this.switch_seg(reg_fs,o),this.switch_seg(reg_gs,n),this.adjust_stack_reg(36),this.reg32s[reg_esp]=i,this.switch_seg(reg_ss,_),this.cpl=3,this.cpl_changed(),this.update_cs_size(!1),void(CPU_LOG_VERBOSE&&this.debug.dump_state("iret end"))}dbg_log("vm86 flag ignored because cpl != 0",LOG_CPU),s&=~flag_vm}if(dbg_assert((a=this.lookup_segment_selector(r)).is_valid),dbg_assert(t>>>0<=a.effective_limit),a.is_null)throw this.debug.unimpl("is null");if(!a.is_present)throw this.debug.unimpl("not present");if(!a.is_executable)throw this.debug.unimpl("not exec");if(a.rpl<this.cpl)throw this.debug.unimpl("rpl < cpl");if(a.dc_bit&&a.dpl>a.rpl)throw this.debug.unimpl("conforming and dpl > rpl");a.dc_bit||a.rpl===a.dpl||(dbg_log("#gp iret: non-conforming cs and rpl != dpl, dpl="+a.dpl+" rpl="+a.rpl,LOG_CPU),this.trigger_gp(-4&r)),a.rpl>this.cpl?(e?(i=this.safe_read16(this.get_stack_pointer(6)),_=this.safe_read16(this.get_stack_pointer(8))):(i=this.safe_read32s(this.get_stack_pointer(12)),_=this.safe_read16(this.get_stack_pointer(16))),o=this.lookup_segment_selector(_),n=a.rpl,o.is_null&&(dbg_log("#GP for loading 0 in SS sel="+h(_,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0)),o.is_valid&&!o.is_system&&o.rpl===n&&o.is_writable&&o.dpl===n||(dbg_log("#GP for loading invalid in SS sel="+h(_,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(-4&_)),o.is_present||(dbg_log("#SS for loading non-present in SS sel="+h(_,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_ss(-4&_)),e?this.update_eflags(s|-65536&this.flags):this.update_eflags(s),this.cpl=a.rpl,this.cpl_changed(),this.switch_seg(reg_ss,_),this.set_stack_reg(i),0===this.cpl&&(this.flags=this.flags&~flag_vif&~flag_vip|s&(flag_vif|flag_vip))):a.rpl===this.cpl?(e?(this.adjust_stack_reg(6),this.update_eflags(s|-65536&this.flags)):(this.adjust_stack_reg(12),this.update_eflags(s)),0===this.cpl&&(this.flags=this.flags&~flag_vif&~flag_vip|s&(flag_vif|flag_vip))):dbg_assert(!1),this.sreg[reg_cs]=r,dbg_assert((3&r)===this.cpl),this.update_cs_size(a.size),this.segment_limits[reg_cs]=a.effective_limit,this.segment_offsets[reg_cs]=a.base,this.instruction_pointer=t+this.get_seg(reg_cs)|0,CPU_LOG_VERBOSE&&this.debug.dump_state("iret"+(e?"16":"32")+" end")}this.handle_irqs()},CPU.prototype.switch_cs_real_mode=function(e){dbg_assert(!this.protected_mode||this.vm86_mode()),this.sreg[reg_cs]=e,this.segment_is_null[reg_cs]=0,this.segment_offsets[reg_cs]=e<<4},CPU.prototype.far_return=function(e,t,r){if(dbg_assert("number"==typeof t&&65536>t&&0<=t),CPU_LOG_VERBOSE&&this.debug.dump_state("far ret start"),this.protected_mode||dbg_assert(!this.is_32),!this.protected_mode||this.vm86_mode())this.switch_cs_real_mode(t),this.instruction_pointer=this.get_seg(reg_cs)+e|0,this.adjust_stack_reg(2*(this.is_osize_32()?4:2)+r);else{var s=this.lookup_segment_selector(t);if(s.is_null&&(dbg_log("null cs",LOG_CPU),this.trigger_gp(0)),s.is_valid||(dbg_log("invalid cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.is_system&&(dbg_assert(!1,"is system in far return"),this.trigger_gp(-4&t)),s.is_executable||(dbg_log("non-executable cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.rpl<this.cpl&&(dbg_log("cs rpl < cpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.dc_bit&&s.dpl>s.rpl&&(dbg_log("cs conforming and dpl > rpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.dc_bit||s.dpl===s.rpl||(dbg_log("cs non-conforming and dpl != rpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.is_present||(dbg_log("#NP for loading not-present in cs sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_np(-4&t)),s.rpl>this.cpl){if(dbg_log("far return privilege change cs: "+h(t)+" from="+this.cpl+" to="+s.rpl+" is_16="+this.is_osize_32(),LOG_CPU),this.is_osize_32())var i=this.safe_read32s(this.get_stack_pointer(r+8)),_=this.safe_read16(this.get_stack_pointer(r+12));else i=this.safe_read16(this.get_stack_pointer(r+4)),_=this.safe_read16(this.get_stack_pointer(r+6));this.cpl=s.rpl,this.cpl_changed(),this.switch_seg(reg_ss,_),this.set_stack_reg(i+r)}else this.is_osize_32()?this.adjust_stack_reg(8+r):this.adjust_stack_reg(4+r);this.update_cs_size(s.size),this.segment_is_null[reg_cs]=0,this.segment_limits[reg_cs]=s.effective_limit,this.segment_offsets[reg_cs]=s.base,this.sreg[reg_cs]=t,dbg_assert((3&t)===this.cpl),this.instruction_pointer=this.get_seg(reg_cs)+e|0,CPU_LOG_VERBOSE&&this.debug.dump_state("far ret end")}},CPU.prototype.far_jump=function(e,t,r){if(dbg_assert("number"==typeof t&&65536>t&&0<=t),CPU_LOG_VERBOSE&&this.debug.dump_state("far "+["jump","call"][+r]),!this.protected_mode||this.vm86_mode())r&&(this.is_osize_32()?(this.writable_or_pagefault(this.get_stack_pointer(-8),8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()))),this.switch_cs_real_mode(t),this.instruction_pointer=this.get_seg(reg_cs)+e|0;else{var s=this.lookup_segment_selector(t);if(s.is_null&&(dbg_log("#gp null cs",LOG_CPU),this.trigger_gp(0)),s.is_valid||(dbg_log("#gp invalid cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.is_system){if(dbg_assert(r,"TODO: Jump"),dbg_log("system type cs: "+h(t),LOG_CPU),12!==s.type&&4!==s.type)throw this.debug.unimpl("load system segment descriptor, type = "+(15&s.access)+" ("+{9:"Available 386 TSS",11:"Busy 386 TSS",4:"286 Call Gate",12:"386 Call Gate"}[15&s.access]+")");e=4===s.type,(s.dpl<this.cpl||s.dpl<s.rpl)&&(dbg_log("#gp cs gate dpl < cpl or dpl < rpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.is_present||(dbg_log("#NP for loading not-present in gate cs sel="+h(t,4),LOG_CPU),this.trigger_np(-4&t)),t=s.raw0>>>16;var i=this.lookup_segment_selector(t);if(i.is_null&&(dbg_log("#gp null cs",LOG_CPU),this.trigger_gp(0)),i.is_valid||(dbg_log("#gp invalid cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),i.is_executable||(dbg_log("#gp non-executable cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),i.dpl>this.cpl&&(dbg_log("#gp dpl > cpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),i.is_present||(dbg_log("#NP for loading not-present in cs sel="+h(t,4),LOG_CPU),this.trigger_np(-4&t)),!i.dc_bit&&i.dpl<this.cpl){dbg_log("more privilege call gate is_16="+e+" from="+this.cpl+" to="+i.dpl);var _=this.get_tss_stack_addr(i.dpl);if(this.tss_size_32){var a=this.read32s(_);_=this.read16(_+4|0)}else a=this.read16(_),_=this.read16(_+2|0);var o=this.lookup_segment_selector(_);if(dbg_assert(o.is_valid&&!o.is_system&&o.is_writable),o.is_null)throw this.debug.unimpl("#TS handler");if(o.rpl!==i.dpl)throw this.debug.unimpl("#TS handler");if(o.dpl!==i.dpl||!o.rw_bit)throw this.debug.unimpl("#TS handler");if(!o.is_present)throw this.debug.unimpl("#SS handler");var n=31&s.raw1,d=e?4:8;r&&(d+=e?4+2*n:8+4*n),o.size?this.writable_or_pagefault(o.base+a-d|0,d):this.writable_or_pagefault(o.base+(a-d&65535)|0,d),d=this.reg32s[reg_esp];var g=this.sreg[reg_ss];if(o=this.get_stack_pointer(0),this.cpl=i.dpl,this.cpl_changed(),this.update_cs_size(i.size),this.switch_seg(reg_ss,_),this.set_stack_reg(a),e?(this.push16(g),this.push16(d)):(this.push32(g),this.push32(d)),r)if(e){for(a=n-1;0<=a;a--)_=this.safe_read16(o+2*a),this.push16(_);this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip())}else{for(a=n-1;0<=a;a--)_=this.safe_read32s(o+4*a),this.push32(_);this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())}}else dbg_log("same privilege call gate is_16="+e+" from="+this.cpl+" to="+i.dpl+" conforming="+i.dc_bit),r&&(e?(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-8),8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())));a=65535&s.raw0,e||(a|=4294901760&s.raw1),dbg_log("call gate eip="+h(a>>>0)+" cs="+h(t)+" conforming="+i.dc_bit),dbg_assert(a>>>0<=i.effective_limit,"todo: #gp"),this.update_cs_size(i.size),this.segment_is_null[reg_cs]=0,this.segment_limits[reg_cs]=i.effective_limit,this.segment_offsets[reg_cs]=i.base,this.sreg[reg_cs]=-4&t|this.cpl,dbg_assert((3&this.sreg[reg_cs])===this.cpl),this.instruction_pointer=this.get_seg(reg_cs)+a|0}else s.is_executable||(dbg_log("#gp non-executable cs: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.dc_bit?s.dpl>this.cpl&&(dbg_log("#gp cs dpl > cpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)):(s.rpl>this.cpl||s.dpl!==this.cpl)&&(dbg_log("#gp cs rpl > cpl or dpl != cpl: "+h(t),LOG_CPU),this.trigger_gp(-4&t)),s.is_present||(dbg_log("#NP for loading not-present in cs sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_np(-4&t)),r&&(this.is_osize_32()?(this.writable_or_pagefault(this.get_stack_pointer(-8),8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()))),dbg_assert(e>>>0<=s.effective_limit,"todo: #gp"),this.update_cs_size(s.size),this.segment_is_null[reg_cs]=0,this.segment_limits[reg_cs]=s.effective_limit,this.segment_offsets[reg_cs]=s.base,this.sreg[reg_cs]=-4&t|this.cpl,this.instruction_pointer=this.get_seg(reg_cs)+e|0;CPU_LOG_VERBOSE&&this.debug.dump_state("far "+["jump","call"][+r]+" end")}},CPU.prototype.get_tss_stack_addr=function(e){if(this.tss_size_32){if(((e=4+(e<<3)|0)+5|0)>this.segment_limits[reg_tr])throw this.debug.unimpl("#TS handler");dbg_assert(4090>=(4095&(e=e+this.segment_offsets[reg_tr]|0)))}else{if(((e=2+(e<<2)|0)+5|0)>this.segment_limits[reg_tr])throw this.debug.unimpl("#TS handler");dbg_assert(4092>=(4095&(e=e+this.segment_offsets[reg_tr]|0)))}return this.paging&&(e=this.translate_address_system_read(e)),e},CPU.prototype.do_task_switch=function(e,t){dbg_assert(this.tss_size_32,"TODO"),dbg_log("do_task_switch sel="+h(e),LOG_CPU);var r=this.lookup_segment_selector(e);dbg_assert(3==(2|r.type)||11==(2|r.type));var s=3>=r.type,i=2==(2&r.type);if(!r.is_valid||r.is_null||!r.from_gdt)throw this.debug.unimpl("#GP handler");if(11==(31&r.access))throw this.debug.unimpl("#GP handler");if(!r.is_present)throw this.debug.unimpl("#NP handler");if(103>r.effective_limit)throw this.debug.unimpl("#NP handler");var _=this.segment_offsets[reg_tr],a=this.get_eflags();i&&(a&=~flag_nt),this.writable_or_pagefault(_,102),this.safe_write32(_+TSR_EIP,this.get_real_eip()),this.safe_write32(_+TSR_EFLAGS,a),this.safe_write32(_+TSR_EAX,this.reg32s[reg_eax]),this.safe_write32(_+TSR_ECX,this.reg32s[reg_ecx]),this.safe_write32(_+TSR_EDX,this.reg32s[reg_edx]),this.safe_write32(_+TSR_EBX,this.reg32s[reg_ebx]),this.safe_write32(_+TSR_ESP,this.reg32s[reg_esp]),this.safe_write32(_+TSR_EBP,this.reg32s[reg_ebp]),this.safe_write32(_+TSR_ESI,this.reg32s[reg_esi]),this.safe_write32(_+TSR_EDI,this.reg32s[reg_edi]),this.safe_write32(_+TSR_ES,this.sreg[reg_es]),this.safe_write32(_+TSR_CS,this.sreg[reg_cs]),this.safe_write32(_+TSR_SS,this.sreg[reg_ss]),this.safe_write32(_+TSR_DS,this.sreg[reg_ds]),this.safe_write32(_+TSR_FS,this.sreg[reg_fs]),this.safe_write32(_+TSR_GS,this.sreg[reg_gs]),this.write8(r.table_offset+5|0,2|this.read8(r.table_offset+5|0)),i=r.base,dbg_assert(!s,"unimplemented"),this.safe_write16(i+TSR_BACKLINK,this.sreg[reg_tr]),a=this.safe_read32s(i+TSR_CR3),this.flags&=~flag_vm;var o=this.safe_read32s(i+TSR_EIP),n=this.safe_read16(i+TSR_CS),d=this.lookup_segment_selector(n);if(d.is_null)throw dbg_log("null cs",LOG_CPU),this.debug.unimpl("#TS handler");if(!d.is_valid)throw dbg_log("invalid cs: "+h(e),LOG_CPU),this.debug.unimpl("#TS handler");if(d.is_system)throw this.debug.unimpl("#TS handler");if(!d.is_executable)throw this.debug.unimpl("#TS handler");if(d.dc_bit&&d.dpl>d.rpl)throw dbg_log("cs conforming and dpl > rpl: "+h(e),LOG_CPU),this.debug.unimpl("#TS handler");if(!d.dc_bit&&d.dpl!==d.rpl)throw dbg_log("cs non-conforming and dpl != rpl: "+h(e),LOG_CPU),this.debug.unimpl("#TS handler");if(!d.is_present)throw dbg_log("#NP for loading not-present in cs sel="+h(e,4),LOG_CPU),this.debug.unimpl("#TS handler");if(this.segment_is_null[reg_cs]=0,this.segment_limits[reg_cs]=d.effective_limit,this.segment_offsets[reg_cs]=d.base,this.sreg[reg_cs]=n,this.cpl=d.dpl,this.cpl_changed(),dbg_assert((3&this.sreg[reg_cs])===this.cpl),dbg_assert(o>>>0<=d.effective_limit,"todo: #gp"),this.update_cs_size(d.size),n=this.safe_read32s(i+TSR_EFLAGS),this.safe_write32(_+TSR_BACKLINK,e),(n|=flag_nt)&flag_vm)throw this.debug.unimpl("task switch to VM mode");this.update_eflags(n),this.flags|=flag_nt,_=this.safe_read16(i+TSR_LDT),this.load_ldt(_),this.reg32s[reg_eax]=this.safe_read32s(i+TSR_EAX),this.reg32s[reg_ecx]=this.safe_read32s(i+TSR_ECX),this.reg32s[reg_edx]=this.safe_read32s(i+TSR_EDX),this.reg32s[reg_ebx]=this.safe_read32s(i+TSR_EBX),this.reg32s[reg_esp]=this.safe_read32s(i+TSR_ESP),this.reg32s[reg_ebp]=this.safe_read32s(i+TSR_EBP),this.reg32s[reg_esi]=this.safe_read32s(i+TSR_ESI),this.reg32s[reg_edi]=this.safe_read32s(i+TSR_EDI),this.switch_seg(reg_es,this.safe_read16(i+TSR_ES)),this.switch_seg(reg_ss,this.safe_read16(i+TSR_SS)),this.switch_seg(reg_ds,this.safe_read16(i+TSR_DS)),this.switch_seg(reg_fs,this.safe_read16(i+TSR_FS)),this.switch_seg(reg_gs,this.safe_read16(i+TSR_GS)),this.instruction_pointer=this.get_seg(reg_cs)+o|0,this.segment_offsets[reg_tr]=r.base,this.segment_limits[reg_tr]=r.effective_limit,this.sreg[reg_tr]=e,this.cr[3]=a,dbg_assert(0==(4095&this.cr[3])),this.clear_tlb(),this.cr[0]|=CR0_TS,!1!==t&&(s?this.push16(65535&t):this.push32(t))},CPU.prototype.hlt_op=function(){if(this.cpl&&this.trigger_gp(0),0==(this.flags&flag_interrupt))throw this.debug.show("cpu halted"),this.bus.send("cpu-event-halt"),DEBUG&&this.debug.dump_regs(),"HALT";throw this.in_hlt=!0,MAGIC_CPU_EXCEPTION},CPU.prototype.raise_exception=function(e){throw this.call_interrupt_vector(e,!1,!1),MAGIC_CPU_EXCEPTION},CPU.prototype.raise_exception_with_code=function(e,t){throw dbg_assert("number"==typeof t),this.call_interrupt_vector(e,!1,t),MAGIC_CPU_EXCEPTION},CPU.prototype.trigger_de=function(){this.instruction_pointer=this.previous_ip,this.raise_exception(0)},CPU.prototype.trigger_ud=function(){this.instruction_pointer=this.previous_ip,this.raise_exception(6)},CPU.prototype.trigger_nm=function(){this.instruction_pointer=this.previous_ip,this.raise_exception(7)},CPU.prototype.trigger_ts=function(e){this.instruction_pointer=this.previous_ip,this.raise_exception_with_code(10,e)},CPU.prototype.trigger_gp=function(e){this.instruction_pointer=this.previous_ip,this.raise_exception_with_code(13,e)},CPU.prototype.trigger_np=function(e){this.instruction_pointer=this.previous_ip,this.raise_exception_with_code(11,e)},CPU.prototype.trigger_ss=function(e){this.instruction_pointer=this.previous_ip,this.raise_exception_with_code(12,e)},CPU.prototype.task_switch_test=function(){this.cr[0]&(CR0_EM|CR0_TS)&&this.trigger_nm()},CPU.prototype.task_switch_test_mmx=function(){this.cr[0]&(CR0_EM|CR0_TS)&&(this.cr[0]&CR0_TS?this.trigger_nm():this.trigger_ud())},CPU.prototype.todo=function(){if(DEBUG)throw dbg_trace(),"TODO";this.trigger_ud()},CPU.prototype.undefined_instruction=function(){dbg_assert(!1,"Possible fault: undefined instruction"),this.trigger_ud()},CPU.prototype.unimplemented_sse=function(){dbg_log("No SSE",LOG_CPU),dbg_assert(!1),this.trigger_ud()},CPU.prototype.get_seg_prefix_ds=function(){return this.get_seg_prefix(reg_ds)},CPU.prototype.get_seg_prefix_ss=function(){return this.get_seg_prefix(reg_ss)},CPU.prototype.get_seg_prefix_cs=function(){return this.get_seg_prefix(reg_cs)},CPU.prototype.get_seg_prefix=function(e){var t=this.prefixes&PREFIX_MASK_SEGMENT;return t?t===SEG_PREFIX_ZERO?0:this.get_seg(t-1):this.get_seg(e)},CPU.prototype.get_seg=function(e){return dbg_assert(0<=e&&8>e),this.protected_mode&&this.segment_is_null[e]&&(dbg_assert(e!==reg_cs&&e!==reg_ss),dbg_trace(),dbg_log("#gp Use null segment: "+e+" sel="+h(this.sreg[e],4),LOG_CPU),this.trigger_gp(0)),this.segment_offsets[e]},CPU.prototype.read_e8=function(){return 192>this.modrm_byte?this.safe_read8(this.modrm_resolve(this.modrm_byte)):this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]},CPU.prototype.read_e8s=function(){return this.read_e8()<<24>>24},CPU.prototype.read_e16=function(){return 192>this.modrm_byte?this.safe_read16(this.modrm_resolve(this.modrm_byte)):this.reg16[this.modrm_byte<<1&14]},CPU.prototype.read_e16s=function(){return this.read_e16()<<16>>16},CPU.prototype.read_e32s=function(){return 192>this.modrm_byte?this.safe_read32s(this.modrm_resolve(this.modrm_byte)):this.reg32s[7&this.modrm_byte]},CPU.prototype.read_e32=function(){return this.read_e32s()>>>0},CPU.prototype.read_mmx_mem32s=function(){return 192>this.modrm_byte?this.safe_read32s(this.modrm_resolve(this.modrm_byte)):this.reg_mmxs[2*(7&this.modrm_byte)]},CPU.prototype.read_mmx_mem64s=function(){return 192>this.modrm_byte?this.safe_read64s(this.modrm_resolve(this.modrm_byte)):this.create_atom64s(this.reg_mmxs[2*(7&this.modrm_byte)],this.reg_mmxs[2*(7&this.modrm_byte)+1])},CPU.prototype.read_xmm_mem64s=function(){if(192>this.modrm_byte)return this.safe_read64s(this.modrm_resolve(this.modrm_byte));var e=(7&this.modrm_byte)<<2;return this.create_atom64s(this.reg_xmm32s[e],this.reg_xmm32s[1|e])},CPU.prototype.read_xmm_mem128s=function(){if(192>this.modrm_byte)return this.safe_read128s_aligned(this.modrm_resolve(this.modrm_byte));var e=(7&this.modrm_byte)<<2;return this.create_atom128s(this.reg_xmm32s[e],this.reg_xmm32s[1|e],this.reg_xmm32s[2|e],this.reg_xmm32s[3|e])},CPU.prototype.read_xmm_mem128s_unaligned=function(){if(192>this.modrm_byte)return this.safe_read128s_unaligned(this.modrm_resolve(this.modrm_byte));var e=(7&this.modrm_byte)<<2;return this.create_atom128s(this.reg_xmm32s[e],this.reg_xmm32s[1|e],this.reg_xmm32s[2|e],this.reg_xmm32s[3|e])},CPU.prototype.set_e8=function(e){if(192>this.modrm_byte){var t=this.modrm_resolve(this.modrm_byte);this.safe_write8(t,e)}else this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]=e},CPU.prototype.set_e16=function(e){if(192>this.modrm_byte){var t=this.modrm_resolve(this.modrm_byte);this.safe_write16(t,e)}else this.reg16[this.modrm_byte<<1&14]=e},CPU.prototype.set_e32=function(e){if(192>this.modrm_byte){var t=this.modrm_resolve(this.modrm_byte);this.safe_write32(t,e)}else this.reg32s[7&this.modrm_byte]=e},CPU.prototype.set_mmx_mem64s=function(e,t){if(192>this.modrm_byte){var r=this.modrm_resolve(this.modrm_byte);this.safe_write64(r,e,t)}else this.reg_mmxs[2*(7&this.modrm_byte)]=e,this.reg_mmxs[2*(7&this.modrm_byte)+1]=t},CPU.prototype.read_write_e8=function(){if(192>this.modrm_byte){var e=this.modrm_resolve(this.modrm_byte);return this.phys_addr=this.translate_address_write(e),this.read8(this.phys_addr)}return this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]},CPU.prototype.write_e8=function(e){192>this.modrm_byte?this.write8(this.phys_addr,e):this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]=e},CPU.prototype.read_write_e16=function(){if(192>this.modrm_byte){var e=this.modrm_resolve(this.modrm_byte);return this.phys_addr=this.translate_address_write(e),this.paging&&4095==(4095&e)?(this.phys_addr_high=this.translate_address_write(e+1|0),dbg_assert(this.phys_addr_high),this.virt_boundary_read16(this.phys_addr,this.phys_addr_high)):(this.phys_addr_high=0,this.read16(this.phys_addr))}return this.reg16[this.modrm_byte<<1&14]},CPU.prototype.write_e16=function(e){192>this.modrm_byte?this.phys_addr_high?this.virt_boundary_write16(this.phys_addr,this.phys_addr_high,e):this.write16(this.phys_addr,e):this.reg16[this.modrm_byte<<1&14]=e},CPU.prototype.read_write_e32=function(){if(192>this.modrm_byte){var e=this.modrm_resolve(this.modrm_byte);return this.phys_addr=this.translate_address_write(e),this.paging&&4093<=(4095&e)?(this.phys_addr_high=this.translate_address_write(e+3&-4)|e+3&3,dbg_assert(this.phys_addr_high),this.virt_boundary_read32s(this.phys_addr,this.phys_addr_high)):(this.phys_addr_high=0,this.read32s(this.phys_addr))}return this.reg32s[7&this.modrm_byte]},CPU.prototype.write_e32=function(e){192>this.modrm_byte?this.phys_addr_high?this.virt_boundary_write32(this.phys_addr,this.phys_addr_high,e):this.write32(this.phys_addr,e):this.reg32s[7&this.modrm_byte]=e},CPU.prototype.read_reg_e16=function(){return this.reg16[this.modrm_byte<<1&14]},CPU.prototype.write_reg_e16=function(e){this.reg16[this.modrm_byte<<1&14]=e},CPU.prototype.read_reg_e32s=function(){return this.reg32s[7&this.modrm_byte]},CPU.prototype.write_reg_e32=function(e){this.reg32s[7&this.modrm_byte]=e},CPU.prototype.read_g8=function(){return this.reg8[this.modrm_byte>>1&12|this.modrm_byte>>5&1]},CPU.prototype.write_g8=function(e){this.reg8[this.modrm_byte>>1&12|this.modrm_byte>>5&1]=e},CPU.prototype.read_g16=function(){return this.reg16[this.modrm_byte>>2&14]},CPU.prototype.read_g16s=function(){return this.reg16s[this.modrm_byte>>2&14]},CPU.prototype.write_g16=function(e){this.reg16[this.modrm_byte>>2&14]=e},CPU.prototype.read_g32s=function(){return this.reg32s[this.modrm_byte>>3&7]},CPU.prototype.write_g32=function(e){this.reg32[this.modrm_byte>>3&7]=e},CPU.prototype.read_xmm64s=function(){return this.create_atom64s(this.reg_xmm32s[(this.modrm_byte>>3&7)<<2],this.reg_xmm32s[(this.modrm_byte>>3&7)<<2|1])},CPU.prototype.read_xmm128s=function(){var e=(this.modrm_byte>>3&7)<<2;return this.create_atom128s(this.reg_xmm32s[0|e],this.reg_xmm32s[1|e],this.reg_xmm32s[2|e],this.reg_xmm32s[3|e])},CPU.prototype.read_mmx64s=function(){return this.create_atom64s(this.reg_mmxs[2*(this.modrm_byte>>3&7)],this.reg_mmxs[2*(this.modrm_byte>>3&7)+1])},CPU.prototype.write_mmx64s=function(e,t){this.reg_mmxs[2*(this.modrm_byte>>3&7)]=e,this.reg_mmxs[2*(this.modrm_byte>>3&7)+1]=t},CPU.prototype.write_xmm64=function(e,t){var r=(this.modrm_byte>>3&7)<<2;this.reg_xmm32s[r]=e,this.reg_xmm32s[r+1]=t},CPU.prototype.write_xmm128s=function(e,t,r,s){var i=(this.modrm_byte>>3&7)<<2;this.reg_xmm32s[i]=e,this.reg_xmm32s[i+1]=t,this.reg_xmm32s[i+2]=r,this.reg_xmm32s[i+3]=s},CPU.prototype.pic_call_irq=function(e){try{this.previous_ip=this.instruction_pointer,this.call_interrupt_vector(e,!1,!1)}catch(e){this.exception_cleanup(e)}},CPU.prototype.handle_irqs=function(){dbg_assert(!this.page_fault),this.diverged(),this.flags&flag_interrupt&&!this.page_fault&&(this.devices.pic&&this.devices.pic.acknowledge_irq(),this.devices.apic&&this.devices.apic.acknowledge_irq())},CPU.prototype.device_raise_irq=function(e){dbg_assert(1===arguments.length),this.devices.pic&&this.devices.pic.set_irq(e),this.devices.ioapic&&this.devices.ioapic.set_irq(e)},CPU.prototype.device_lower_irq=function(e){this.devices.pic&&this.devices.pic.clear_irq(e),this.devices.ioapic&&this.devices.ioapic.clear_irq(e)},CPU.prototype.test_privileges_for_io=function(e,t){if(this.protected_mode&&(this.cpl>this.getiopl()||this.flags&flag_vm)){this.tss_size_32||(dbg_log("#GP for port io, 16-bit TSS  port="+h(e)+" size="+t,LOG_CPU),CPU_LOG_VERBOSE&&this.debug.dump_state(),this.trigger_gp(0));var r=this.segment_limits[reg_tr],s=this.segment_offsets[reg_tr];if(103<=r){dbg_assert(4095>(s+100+2&4095));var i=this.read16(this.translate_address_system_read(s+100+2|0));if(r>=(i+((e+t-1|0)>>3)|0)&&(r=(1<<t)-1<<(7&e),s=this.translate_address_system_read(s+i+(e>>3)|0),i=65280&r?this.read16(s):this.read8(s),dbg_assert(4095>(4095&s)),!(i&r)))return}dbg_log("#GP for port io  port="+h(e)+" size="+t,LOG_CPU),CPU_LOG_VERBOSE&&this.debug.dump_state(),this.trigger_gp(0)}},CPU.prototype.cpuid=function(){var e=0,t=0,r=0,s=0;switch(this.reg32s[reg_eax]){case 0:e=5,s=1970169159,r=1231384169,t=1818588270;break;case 1:e=3939,s=67584,t=1082130432,VMWARE_HYPERVISOR_PORT&&(t|=-2147483648),r=43320|(this.fpu?1:0),ENABLE_ACPI&&this.apic_enabled&&(r|=512);break;case 2:e=1717260289,t=s=0,r=8024064;break;case 4:switch(this.reg32s[reg_ecx]){case 0:e=289,s=29360191,t=63,r=1;break;case 1:e=290,s=29360191,t=63,r=1;break;case 2:e=323,s=96469055,t=4095,r=1}break;case 5:s=e=64,t=3,r=1319200;break;case-2147483648:e=5;break;case 1073741824:VMWARE_HYPERVISOR_PORT&&(s=1635208534,t=1297507698,r=1701994871);break;default:dbg_log("cpuid: unimplemented eax: "+h(this.reg32[reg_eax]),LOG_CPU)}dbg_log("cpuid: eax="+h(this.reg32[reg_eax],8)+" cl="+h(this.reg8[reg_cl],2),LOG_CPU),this.reg32s[reg_eax]=e,this.reg32s[reg_ecx]=t,this.reg32s[reg_edx]=r,this.reg32s[reg_ebx]=s},CPU.prototype.update_cs_size=function(e){dbg_assert("boolean"==typeof e),this.is_32!==e&&(this.clear_instruction_cache(),this.is_32=e,this.update_operand_size())},CPU.prototype.update_operand_size=function(){this.table=this.is_32?this.table32:this.table16},CPU.prototype.lookup_segment_selector=function(e){dbg_assert("number"==typeof e&&0<=e&&65536>e);var t=0==(4&e),r=-8&e,s={rpl:3&e,from_gdt:t,is_null:!1,is_valid:!0,base:0,access:0,flags:0,type:0,dpl:0,is_system:!1,is_present:!1,is_executable:!1,rw_bit:!1,dc_bit:!1,size:!1,is_conforming_executable:!1,effective_limit:0,is_writable:!1,is_readable:!1,table_offset:0,raw0:0,raw1:0};if(t)var i=this.gdtr_offset,_=this.gdtr_size;else i=this.segment_offsets[reg_ldtr],_=this.segment_limits[reg_ldtr];return t&&0===r?(s.is_null=!0,s):(7|e)>_?(dbg_log("Selector "+h(e,4)+" is outside of the "+(t?"g":"l")+"dt limits",LOG_CPU),s.is_valid=!1,s):(i=i+r|0,this.paging&&(i=this.translate_address_system_read(i)),s.table_offset=i,s.base=this.read16(i+2|0)|this.read8(i+4|0)<<16|this.read8(i+7|0)<<24,s.access=this.read8(i+5|0),s.flags=this.read8(i+6|0)>>4,s.raw0=this.read32s(0|i),s.raw1=this.read32s(i+4|0),s.type=15&s.access,s.dpl=s.access>>5&3,s.is_system=0==(16&s.access),s.is_present=128==(128&s.access),s.is_executable=8==(8&s.access),s.rw_bit=2==(2&s.access),s.dc_bit=4==(4&s.access),s.is_conforming_executable=s.dc_bit&&s.is_executable,s.size=4==(4&s.flags),e=this.read16(i)|(15&this.read8(i+6|0))<<16,s.effective_limit=8&s.flags?(e<<12|4095)>>>0:e,s.is_writable=s.rw_bit&&!s.is_executable,s.is_readable=s.rw_bit||!s.is_executable,s)},CPU.prototype.switch_seg=function(e,t){if(dbg_assert(0<=e&&5>=e),dbg_assert("number"==typeof t&&65536>t&&0<=t),!this.protected_mode||this.vm86_mode())this.sreg[e]=t,this.segment_is_null[e]=0,this.segment_offsets[e]=t<<4,e===reg_ss&&(this.stack_size_32=!1);else{var r=this.lookup_segment_selector(t);if(e===reg_ss)r.is_null&&(dbg_log("#GP for loading 0 in SS sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0)),r.is_valid&&!r.is_system&&r.rpl===this.cpl&&r.is_writable&&r.dpl===this.cpl||(dbg_log("#GP for loading invalid in SS sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(-4&t)),r.is_present||(dbg_log("#SS for loading non-present in SS sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_ss(-4&t)),this.stack_size_32=r.size;else if(e===reg_cs)dbg_assert(!1);else{if(r.is_null)return this.sreg[e]=t,void(this.segment_is_null[e]=1);(!r.is_valid||r.is_system||!r.is_readable||!r.is_conforming_executable&&(r.rpl>r.dpl||this.cpl>r.dpl))&&(dbg_log("#GP for loading invalid in seg "+e+" sel="+h(t,4),LOG_CPU),this.debug.dump_state(),this.debug.dump_regs(),dbg_trace(LOG_CPU),this.trigger_gp(-4&t)),r.is_present||(dbg_log("#NP for loading not-present in seg "+e+" sel="+h(t,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_np(-4&t))}this.segment_is_null[e]=0,this.segment_limits[e]=r.effective_limit,this.segment_offsets[e]=r.base,this.sreg[e]=t}},CPU.prototype.load_tr=function(e){var t=this.lookup_segment_selector(e);if(dbg_assert(t.is_valid),!t.from_gdt)throw this.debug.unimpl("TR can only be loaded from GDT");if(t.is_null)throw dbg_log("#GP(0) | tried to load null selector (ltr)"),this.debug.unimpl("#GP handler");if(!t.is_system)throw dbg_log("#GP | ltr: not a system entry"),this.debug.unimpl("#GP handler (happens when running kvm-unit-test without ACPI)");if(9!==t.type&&1!==t.type)throw dbg_log("#GP | ltr: invalid type (type = "+h(t.type)+")"),this.debug.unimpl("#GP handler");if(!t.is_present)throw dbg_log("#NT | present bit not set (ltr)"),this.debug.unimpl("#NT handler");this.tss_size_32=9===t.type,this.segment_offsets[reg_tr]=t.base,this.segment_limits[reg_tr]=t.effective_limit,this.sreg[reg_tr]=e,this.write8(t.table_offset+5|0,2|this.read8(t.table_offset+5|0))},CPU.prototype.load_ldt=function(e){var t=this.lookup_segment_selector(e);if(t.is_null)this.segment_offsets[reg_ldtr]=0,this.segment_limits[reg_ldtr]=0;else{if(dbg_assert(t.is_valid),!t.from_gdt)throw this.debug.unimpl("LDTR can only be loaded from GDT");if(!t.is_present)throw dbg_log("lldt: present bit not set"),this.debug.unimpl("#GP handler");if(!t.is_system)throw dbg_log("lldt: not a system entry"),this.debug.unimpl("#GP handler");if(2!==t.type)throw dbg_log("lldt: invalid type ("+t.type+")"),this.debug.unimpl("#GP handler");this.segment_offsets[reg_ldtr]=t.base,this.segment_limits[reg_ldtr]=t.effective_limit,this.sreg[reg_ldtr]=e}},CPU.prototype.arpl=function(e,t){return this.flags_changed&=~flag_zero,(3&e)<(3&this.reg16[t])?(this.flags|=flag_zero,-4&e|3&this.reg16[t]):(this.flags&=~flag_zero,e)},CPU.prototype.lar=function(e,t){dbg_log("lar sel="+h(e,4),LOG_CPU);var r=this.lookup_segment_selector(e);this.flags_changed&=~flag_zero;var s=r.dpl<this.cpl||r.dpl<r.rpl;return r.is_null||!r.is_valid||(r.is_system?58817>>r.type&1||s:!r.is_conforming_executable&&s)?(this.flags&=~flag_zero,dbg_log("lar: invalid selector="+h(e,4)+" is_null="+r.is_null,LOG_CPU),t):(this.flags|=flag_zero,16776960&r.raw1)},CPU.prototype.lsl=function(e,t){dbg_log("lsl sel="+h(e,4),LOG_CPU);var r=this.lookup_segment_selector(e);this.flags_changed&=~flag_zero;var s=r.dpl<this.cpl||r.dpl<r.rpl;return r.is_null||!r.is_valid||(r.is_system?62833>>r.type&1||s:!r.is_conforming_executable&&s)?(this.flags&=~flag_zero,dbg_log("lsl: invalid  selector="+h(e,4)+" is_null="+r.is_null,LOG_CPU),t):(this.flags|=flag_zero,0|r.effective_limit)},CPU.prototype.verr=function(e){var t=this.lookup_segment_selector(e);this.flags_changed&=~flag_zero,t.is_null||!t.is_valid||t.is_system||!t.is_readable||!t.is_conforming_executable&&(t.dpl<this.cpl||t.dpl<t.rpl)?(dbg_log("verr -> invalid. selector="+h(e,4),LOG_CPU),this.flags&=~flag_zero):(dbg_log("verr -> valid. selector="+h(e,4),LOG_CPU),this.flags|=flag_zero)},CPU.prototype.verw=function(e){var t=this.lookup_segment_selector(e);this.flags_changed&=~flag_zero,t.is_null||!t.is_valid||t.is_system||!t.is_writable||t.dpl<this.cpl||t.dpl<t.rpl?(dbg_log("verw invalid  "+h(e)+" "+t.is_null+" "+!t.is_valid+" "+t.is_system+" "+!t.is_writable+" "+(t.dpl<this.cpl)+" "+(t.dpl<t.rpl)+" "+LOG_CPU),this.flags&=~flag_zero):(dbg_log("verw valid",LOG_CPU),this.flags|=flag_zero)},CPU.prototype.clear_tlb=function(){this.last_virt_esp=this.last_virt_eip=-1,this.tlb_info.set(this.tlb_info_global)},CPU.prototype.full_clear_tlb=function(){for(var e=new Int32Array(this.tlb_info_global.buffer),t=0;262144>t;)e[t++]=e[t++]=e[t++]=e[t++]=0;this.clear_tlb()},CPU.prototype.invlpg=function(e){e>>>=12,this.tlb_info[e]=0,this.tlb_info_global[e]=0,this.last_virt_esp=this.last_virt_eip=-1},CPU.prototype.translate_address_read=function(e){return this.paging?3===this.cpl?this.translate_address_user_read(e):this.translate_address_system_read(e):e},CPU.prototype.translate_address_write=function(e){return this.paging?3===this.cpl?this.translate_address_user_write(e):this.translate_address_system_write(e):e},CPU.prototype.translate_address_user_write=function(e){if(!this.paging)return e;var t=e>>>12;return this.tlb_info[t]&TLB_USER_WRITE?this.tlb_data[t]^e:this.do_page_translation(e,1,1)|4095&e},CPU.prototype.translate_address_user_read=function(e){if(!this.paging)return e;var t=e>>>12;return this.tlb_info[t]&TLB_USER_READ?this.tlb_data[t]^e:this.do_page_translation(e,0,1)|4095&e},CPU.prototype.translate_address_system_write=function(e){if(!this.paging)return e;var t=e>>>12;return this.tlb_info[t]&TLB_SYSTEM_WRITE?this.tlb_data[t]^e:this.do_page_translation(e,1,0)|4095&e},CPU.prototype.translate_address_system_read=function(e){if(!this.paging)return e;var t=e>>>12;return this.tlb_info[t]&TLB_SYSTEM_READ?this.tlb_data[t]^e:this.do_page_translation(e,0,0)|4095&e},CPU.prototype.do_page_translation=function(e,t,r){var s=e>>>12,i=(this.cr[3]>>>2)+(s>>10)|0,_=this.mem32s[i],a=!0,o=!0;if(dbg_assert(2147483648>e),1&_||(this.cr[2]=e,this.trigger_pagefault(t,r,0),dbg_assert(!1)),0==(2&_)&&(a=!1,t&&(r||this.cr[0]&CR0_WP)&&(this.cr[2]=e,this.trigger_pagefault(t,r,1),dbg_assert(!1))),0==(4&_)&&(o=!1,r&&(this.cr[2]=e,this.trigger_pagefault(t,r,1),dbg_assert(!1))),_&this.page_size_extensions)this.mem32s[i]=32|_|t<<6,e=4290772992&_|4190208&e,_&=256;else{var n=((4294963200&_)>>>2)+(1023&s)|0,d=this.mem32s[n];0==(1&d)&&(this.cr[2]=e,this.trigger_pagefault(t,r,0),dbg_assert(!1)),0==(2&d)&&(a=!1,t&&(r||this.cr[0]&CR0_WP)&&(this.cr[2]=e,this.trigger_pagefault(t,r,1),dbg_assert(!1))),0==(4&d)&&(o=!1,r&&(this.cr[2]=e,this.trigger_pagefault(t,r,1),dbg_assert(!1))),this.write_aligned32(i,32|_),this.write_aligned32(n,32|d|t<<6),e=4294963200&d,_=256&d}return this.tlb_data[s]=e^s<<12,a=o?a?TLB_SYSTEM_READ|TLB_SYSTEM_WRITE|TLB_USER_READ|TLB_USER_WRITE:TLB_SYSTEM_READ|TLB_USER_READ:a?TLB_SYSTEM_READ|TLB_SYSTEM_WRITE:TLB_SYSTEM_READ,this.tlb_info[s]=a,_&&this.cr[4]&CR4_PGE&&(this.tlb_info_global[s]=a),e},CPU.prototype.writable_or_pagefault=function(e,t){if(dbg_assert(4096>t,"not supported yet"),dbg_assert(0<t),this.paging){var r=3===this.cpl?1:0,s=r?TLB_USER_WRITE:TLB_SYSTEM_WRITE,i=e>>>12;0==(this.tlb_info[i]&s)&&this.do_page_translation(e,1,r),4096<=(4095&e)+t-1&&0==(this.tlb_info[i+1|0]&s)&&this.do_page_translation(e+t-1|0,1,r)}},CPU.prototype.trigger_pagefault=function(e,t,r){if(LOG_PAGE_FAULTS&&(dbg_log("page fault w="+e+" u="+t+" p="+r+" eip="+h(this.previous_ip>>>0,8)+" cr2="+h(this.cr[2]>>>0,8),LOG_CPU),dbg_trace(LOG_CPU)),this.page_fault)throw dbg_trace(LOG_CPU),this.debug.unimpl("Double fault");var s=this.cr[2]>>>12;throw this.tlb_info[s]=0,this.tlb_info_global[s]=0,this.instruction_pointer=this.previous_ip,this.page_fault=!0,this.call_interrupt_vector(14,!1,t<<2|e<<1|r),MAGIC_CPU_EXCEPTION},CPU.prototype.is_osize_32=function(){return this.is_32!==((this.prefixes&PREFIX_MASK_OPSIZE)===PREFIX_MASK_OPSIZE)},CPU.prototype.is_asize_32=function(){return this.is_32!==((this.prefixes&PREFIX_MASK_ADDRSIZE)===PREFIX_MASK_ADDRSIZE)},CPU.prototype.get_reg_asize=function(e){return dbg_assert(e===reg_ecx||e===reg_esi||e===reg_edi),e=this.reg32s[e],this.is_asize_32()?e:65535&e},CPU.prototype.set_ecx_asize=function(e){this.is_asize_32()?this.reg32s[reg_ecx]=e:this.reg16[reg_cx]=e},CPU.prototype.add_reg_asize=function(e,t){dbg_assert(e===reg_ecx||e===reg_esi||e===reg_edi),this.is_asize_32()?this.reg32s[e]+=t:this.reg16[e<<1]+=t},CPU.prototype.decr_ecx_asize=function(){return this.is_asize_32()?--this.reg32s[reg_ecx]:--this.reg16[reg_cx]},"undefined"!=typeof window?window.CPU=CPU:"undefined"!=typeof module&&void 0!==module.exports?module.exports.CPU=CPU:"function"==typeof importScripts&&(self.CPU=CPU),function(){CPU.prototype.modrm_table16=Array(192),CPU.prototype.modrm_table32=Array(192),CPU.prototype.sib_table=Array(256),CPU.prototype.modrm_table16[0]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_si]&65535)|0},CPU.prototype.modrm_table16[64]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_si]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[128]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_si]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[1]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_di]&65535)|0},CPU.prototype.modrm_table16[65]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_di]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[129]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.reg16[reg_di]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[2]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_si]&65535)|0},CPU.prototype.modrm_table16[66]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_si]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[130]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_si]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[3]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_di]&65535)|0},CPU.prototype.modrm_table16[67]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_di]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[131]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.reg16[reg_di]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[4]=function(e){return e.get_seg_prefix_ds()+(65535&e.reg16[reg_si])|0},CPU.prototype.modrm_table16[68]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_si]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[132]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_si]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[5]=function(e){return e.get_seg_prefix_ds()+(65535&e.reg16[reg_di])|0},CPU.prototype.modrm_table16[69]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_di]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[133]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_di]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[6]=function(e){return e.get_seg_prefix_ss()+(65535&e.reg16[reg_bp])|0},CPU.prototype.modrm_table16[70]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[134]=function(e){return e.get_seg_prefix_ss()+(e.reg16[reg_bp]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table16[7]=function(e){return e.get_seg_prefix_ds()+(65535&e.reg16[reg_bx])|0},CPU.prototype.modrm_table16[71]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.read_disp8s()&65535)|0},CPU.prototype.modrm_table16[135]=function(e){return e.get_seg_prefix_ds()+(e.reg16[reg_bx]+e.read_disp16()&65535)|0},CPU.prototype.modrm_table32[0]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.modrm_table32[64]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]+e.read_disp8s()|0},CPU.prototype.modrm_table32[128]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]+e.read_disp32s()|0},CPU.prototype.modrm_table32[1]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.modrm_table32[65]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]+e.read_disp8s()|0},CPU.prototype.modrm_table32[129]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]+e.read_disp32s()|0},CPU.prototype.modrm_table32[2]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.modrm_table32[66]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]+e.read_disp8s()|0},CPU.prototype.modrm_table32[130]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]+e.read_disp32s()|0},CPU.prototype.modrm_table32[3]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.modrm_table32[67]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]+e.read_disp8s()|0},CPU.prototype.modrm_table32[131]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]+e.read_disp32s()|0},CPU.prototype.modrm_table32[5]=function(e){return e.get_seg_prefix_ss()+e.reg32s[reg_ebp]|0},CPU.prototype.modrm_table32[69]=function(e){return e.get_seg_prefix_ss()+e.reg32s[reg_ebp]+e.read_disp8s()|0},CPU.prototype.modrm_table32[133]=function(e){return e.get_seg_prefix_ss()+e.reg32s[reg_ebp]+e.read_disp32s()|0},CPU.prototype.modrm_table32[6]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.modrm_table32[70]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]+e.read_disp8s()|0},CPU.prototype.modrm_table32[134]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]+e.read_disp32s()|0},CPU.prototype.modrm_table32[7]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.modrm_table32[71]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]+e.read_disp8s()|0},CPU.prototype.modrm_table32[135]=function(e){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]+e.read_disp32s()|0},CPU.prototype.modrm_table16[6]=function(e){return e.get_seg_prefix_ds()+e.read_disp16()|0},CPU.prototype.modrm_table32[5]=function(e){return e.get_seg_prefix_ds()+e.read_disp32s()|0},CPU.prototype.modrm_table32[4]=function(e){return 0|e.sib_resolve(!1)},CPU.prototype.modrm_table32[68]=function(e){return e.sib_resolve(!0)+e.read_disp8s()|0},CPU.prototype.modrm_table32[132]=function(e){return e.sib_resolve(!0)+e.read_disp32s()|0};for(var e=0;8>e;e++)for(var t=0;3>t;t++)for(var r=e|t<<6,s=1;8>s;s++)CPU.prototype.modrm_table32[r|s<<3]=CPU.prototype.modrm_table32[r],CPU.prototype.modrm_table16[r|s<<3]=CPU.prototype.modrm_table16[r];CPU.prototype.sib_table[0]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[1]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[2]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[3]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[4]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[5]=function(e,t){return e.reg32s[reg_eax]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[6]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[7]=function(e,t){return e.reg32s[reg_eax]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[64]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[65]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[66]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[67]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[68]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[69]=function(e,t){return(e.reg32s[reg_eax]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[70]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[71]=function(e,t){return(e.reg32s[reg_eax]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[128]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[129]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[130]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[131]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[132]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[133]=function(e,t){return(e.reg32s[reg_eax]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[134]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[135]=function(e,t){return(e.reg32s[reg_eax]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[192]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[193]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[194]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[195]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[196]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[197]=function(e,t){return(e.reg32s[reg_eax]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[198]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[199]=function(e,t){return(e.reg32s[reg_eax]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[8]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[9]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[10]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[11]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[12]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[13]=function(e,t){return e.reg32s[reg_ecx]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[14]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[15]=function(e,t){return e.reg32s[reg_ecx]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[72]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[73]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[74]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[75]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[76]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[77]=function(e,t){return(e.reg32s[reg_ecx]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[78]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[79]=function(e,t){return(e.reg32s[reg_ecx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[136]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[137]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[138]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[139]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[140]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[141]=function(e,t){return(e.reg32s[reg_ecx]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[142]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[143]=function(e,t){return(e.reg32s[reg_ecx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[200]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[201]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[202]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[203]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[204]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[205]=function(e,t){return(e.reg32s[reg_ecx]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[206]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[207]=function(e,t){return(e.reg32s[reg_ecx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[16]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[17]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[18]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[19]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[20]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[21]=function(e,t){return e.reg32s[reg_edx]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[22]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[23]=function(e,t){return e.reg32s[reg_edx]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[80]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[81]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[82]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[83]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[84]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[85]=function(e,t){return(e.reg32s[reg_edx]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[86]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[87]=function(e,t){return(e.reg32s[reg_edx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[144]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[145]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[146]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[147]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[148]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[149]=function(e,t){return(e.reg32s[reg_edx]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[150]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[151]=function(e,t){return(e.reg32s[reg_edx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[208]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[209]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[210]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[211]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[212]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[213]=function(e,t){return(e.reg32s[reg_edx]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[214]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[215]=function(e,t){return(e.reg32s[reg_edx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[24]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[25]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[26]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[27]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[28]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[29]=function(e,t){return e.reg32s[reg_ebx]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[30]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[31]=function(e,t){return e.reg32s[reg_ebx]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[88]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[89]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[90]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[91]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[92]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[93]=function(e,t){return(e.reg32s[reg_ebx]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[94]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[95]=function(e,t){return(e.reg32s[reg_ebx]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[152]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[153]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[154]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[155]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[156]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[157]=function(e,t){return(e.reg32s[reg_ebx]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[158]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[159]=function(e,t){return(e.reg32s[reg_ebx]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[216]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[217]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[218]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[219]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[220]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[221]=function(e,t){return(e.reg32s[reg_ebx]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[222]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[223]=function(e,t){return(e.reg32s[reg_ebx]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[32]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[33]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[34]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[35]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[36]=function(e,t){return e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[37]=function(e,t){return 0|(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())},CPU.prototype.sib_table[38]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[39]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[96]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[97]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[98]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[99]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[100]=function(e,t){return e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[101]=function(e,t){return 0|(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())},CPU.prototype.sib_table[102]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[103]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[160]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[161]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[162]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[163]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[164]=function(e,t){return e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[165]=function(e,t){return 0|(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())},CPU.prototype.sib_table[166]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[167]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[224]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[225]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[226]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[227]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[228]=function(e,t){return e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[229]=function(e,t){return 0|(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())},CPU.prototype.sib_table[230]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[231]=function(e,t){return e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[40]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[41]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[42]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[43]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[44]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[45]=function(e,t){return e.reg32s[reg_ebp]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[46]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[47]=function(e,t){return e.reg32s[reg_ebp]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[104]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[105]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[106]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[107]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[108]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[109]=function(e,t){return(e.reg32s[reg_ebp]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[110]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[111]=function(e,t){return(e.reg32s[reg_ebp]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[168]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[169]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[170]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[171]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[172]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[173]=function(e,t){return(e.reg32s[reg_ebp]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[174]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[175]=function(e,t){return(e.reg32s[reg_ebp]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[232]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[233]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[234]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[235]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[236]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[237]=function(e,t){return(e.reg32s[reg_ebp]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[238]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[239]=function(e,t){return(e.reg32s[reg_ebp]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[48]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[49]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[50]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[51]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[52]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[53]=function(e,t){return e.reg32s[reg_esi]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[54]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[55]=function(e,t){return e.reg32s[reg_esi]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[112]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[113]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[114]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[115]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[116]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[117]=function(e,t){return(e.reg32s[reg_esi]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[118]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[119]=function(e,t){return(e.reg32s[reg_esi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[176]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[177]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[178]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[179]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[180]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[181]=function(e,t){return(e.reg32s[reg_esi]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[182]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[183]=function(e,t){return(e.reg32s[reg_esi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[240]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[241]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[242]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[243]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[244]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[245]=function(e,t){return(e.reg32s[reg_esi]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[246]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[247]=function(e,t){return(e.reg32s[reg_esi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[56]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[57]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[58]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[59]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[60]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[61]=function(e,t){return e.reg32s[reg_edi]+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[62]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[63]=function(e,t){return e.reg32s[reg_edi]+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[120]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[121]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[122]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[123]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[124]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[125]=function(e,t){return(e.reg32s[reg_edi]<<1)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[126]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[127]=function(e,t){return(e.reg32s[reg_edi]<<1)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[184]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[185]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[186]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[187]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[188]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[189]=function(e,t){return(e.reg32s[reg_edi]<<2)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[190]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[191]=function(e,t){return(e.reg32s[reg_edi]<<2)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0},CPU.prototype.sib_table[248]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_eax]|0},CPU.prototype.sib_table[249]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ecx]|0},CPU.prototype.sib_table[250]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edx]|0},CPU.prototype.sib_table[251]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_ebx]|0},CPU.prototype.sib_table[252]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ss()+e.reg32s[reg_esp]|0},CPU.prototype.sib_table[253]=function(e,t){return(e.reg32s[reg_edi]<<3)+(t?e.get_seg_prefix_ss()+e.reg32s[reg_ebp]:e.get_seg_prefix_ds()+e.read_disp32s())|0},CPU.prototype.sib_table[254]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_esi]|0},CPU.prototype.sib_table[255]=function(e,t){return(e.reg32s[reg_edi]<<3)+e.get_seg_prefix_ds()+e.reg32s[reg_edi]|0}}();var MAX_COUNT_PER_CYCLE=4096;function string_get_cycle_count(e,t){return dbg_assert(e&&4>=e&&-4<=e),0>e?(4095&t)>>(-e>>1):(4095&~t)>>e}function string_get_cycle_count2(e,t,r){return dbg_assert(3===arguments.length),Math.min(string_get_cycle_count(e,t),string_get_cycle_count(e,r))}function cmpsb(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-1:1;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE,n=e.translate_address_read(t),d=e.translate_address_read(r);e.paging&&(o=string_get_cycle_count2(s,t,r));do{r=e.read8(d),t=e.read8(n),d+=s,n+=s;var h=0!=--i&&t===r===a}while(h&&o--);s=s*(_-i)|0,e.add_reg_asize(reg_edi,s),e.add_reg_asize(reg_esi,s),e.set_ecx_asize(i),e.timestamp_counter+=_-i,h&&(e.instruction_pointer=e.previous_ip)}else t=e.safe_read8(t),r=e.safe_read8(r),e.add_reg_asize(reg_edi,s),e.add_reg_asize(reg_esi,s);e.cmp8(t,r),e.diverged()}function cmpsw(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-2:2;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE;if(1&r||1&t)do{var n=e.safe_read16(r),d=e.safe_read16(t);r+=s,e.add_reg_asize(reg_edi,s),t+=s,e.add_reg_asize(reg_esi,s);var h=0!==e.decr_ecx_asize()&&d===n===a}while(h&&o--);else{var g=0>s?-1:1,c=e.translate_address_read(t)>>>1,p=e.translate_address_read(r)>>>1;e.paging&&(o=string_get_cycle_count2(s,t,r));do{n=e.read_aligned16(p),d=e.read_aligned16(c),p+=g,c+=g,h=0!=--i&&d===n===a}while(h&&o--);t=s*(_-i)|0,e.add_reg_asize(reg_edi,t),e.add_reg_asize(reg_esi,t),e.set_ecx_asize(i),e.timestamp_counter+=_-i}h&&(e.instruction_pointer=e.previous_ip)}else n=e.safe_read16(r),d=e.safe_read16(t),e.add_reg_asize(reg_edi,s),e.add_reg_asize(reg_esi,s);e.cmp16(d,n),e.diverged()}function cmpsd(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-4:4;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE;if(3&r||3&t)do{var n=e.safe_read32s(r),d=e.safe_read32s(t);r+=s,e.add_reg_asize(reg_edi,s),t+=s,e.add_reg_asize(reg_esi,s);var h=0!==e.decr_ecx_asize()&&d===n===a}while(h&&o--);else{var g=0>s?-1:1,c=e.translate_address_read(t)>>>2,p=e.translate_address_read(r)>>>2;e.paging&&(o=string_get_cycle_count2(s,t,r));do{n=e.read_aligned32(p),d=e.read_aligned32(c),p+=g,c+=g,h=0!=--i&&d===n===a}while(h&&o--);t=s*(_-i)|0,e.add_reg_asize(reg_edi,t),e.add_reg_asize(reg_esi,t),e.set_ecx_asize(i),e.timestamp_counter+=_-i}h&&(e.instruction_pointer=e.previous_ip)}else n=e.safe_read32s(r),d=e.safe_read32s(t),e.add_reg_asize(reg_edi,s),e.add_reg_asize(reg_esi,s);e.cmp32(d,n),e.diverged()}function stosb(e){var t=e.reg8[reg_al],r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-1:1;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE,o=e.translate_address_write(r);e.paging&&(a=string_get_cycle_count(s,r));do{e.write8(o,t),o+=s,r=0!=--i}while(r&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i,r&&(e.instruction_pointer=e.previous_ip)}else e.safe_write8(r,t),e.add_reg_asize(reg_edi,s);e.diverged()}function stosw(e){var t=e.reg16[reg_ax],r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-2:2;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(1&r)do{e.safe_write16(r,t),r+=s,e.add_reg_asize(reg_edi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_write(r)>>>1;e.paging&&(a=string_get_cycle_count(s,r));do{e.write_aligned16(d,t),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.safe_write16(r,t),e.add_reg_asize(reg_edi,s);e.diverged()}function stosd(e){var t=e.reg32s[reg_eax],r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-4:4;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(3&r)do{e.safe_write32(r,t),r+=s,e.add_reg_asize(reg_edi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_write(r)>>>2;e.paging&&(a=string_get_cycle_count(s,r));do{e.write_aligned32(d,t),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.safe_write32(r,t),e.add_reg_asize(reg_edi,s);e.diverged()}function lodsb(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.flags&flag_direction?-1:1;if(e.prefixes&PREFIX_MASK_REP){var s=e.get_reg_asize(reg_ecx)>>>0;if(0===s)return;var i=s,_=MAX_COUNT_PER_CYCLE,a=e.translate_address_read(t);e.paging&&(_=string_get_cycle_count(r,t));do{e.reg8[reg_al]=e.read8(a),a+=r,t=0!=--s}while(t&&_--);e.add_reg_asize(reg_esi,r*(i-s)|0),e.set_ecx_asize(s),e.timestamp_counter+=i-s,t&&(e.instruction_pointer=e.previous_ip)}else e.reg8[reg_al]=e.safe_read8(t),e.add_reg_asize(reg_esi,r);e.diverged()}function lodsw(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.flags&flag_direction?-2:2;if(e.prefixes&PREFIX_MASK_REP){if(0==e.get_reg_asize(reg_ecx)>>>0)return;var s=MAX_COUNT_PER_CYCLE;do{e.reg16[reg_ax]=e.safe_read16(t),t+=r,e.add_reg_asize(reg_esi,r);var i=0!==e.decr_ecx_asize()}while(i&&s--);i&&(e.instruction_pointer=e.previous_ip)}else e.reg16[reg_ax]=e.safe_read16(t),e.add_reg_asize(reg_esi,r);e.diverged()}function lodsd(e){var t=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,r=e.flags&flag_direction?-4:4;if(e.prefixes&PREFIX_MASK_REP){if(0==e.get_reg_asize(reg_ecx)>>>0)return;var s=MAX_COUNT_PER_CYCLE;do{e.reg32s[reg_eax]=e.safe_read32s(t),t+=r,e.add_reg_asize(reg_esi,r);var i=0!==e.decr_ecx_asize()}while(i&&s--);i&&(e.instruction_pointer=e.previous_ip)}else e.reg32s[reg_eax]=e.safe_read32s(t),e.add_reg_asize(reg_esi,r);e.diverged()}function scasb(e){var t=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,r=e.flags&flag_direction?-1:1,s=e.reg8[reg_al];if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE,n=e.translate_address_read(t);e.paging&&(o=string_get_cycle_count(r,t));do{t=e.read8(n),n+=r;var d=0!=--i&&s===t===a}while(d&&o--);e.add_reg_asize(reg_edi,r*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i,d&&(e.instruction_pointer=e.previous_ip)}else t=e.safe_read8(t),e.add_reg_asize(reg_edi,r);e.cmp8(s,t),e.diverged()}function scasw(e){var t=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,r=e.flags&flag_direction?-2:2,s=e.reg16[reg_al];if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE;if(1&t)do{var n=e.safe_read16(t);t+=r,e.add_reg_asize(reg_edi,r);var d=0!==e.decr_ecx_asize()&&s===n===a}while(d&&o--);else{var h=0>r?-1:1,g=e.translate_address_read(t)>>>1;e.paging&&(o=string_get_cycle_count(r,t));do{n=e.read_aligned16(g),g+=h,d=0!=--i&&s===n===a}while(d&&o--);e.add_reg_asize(reg_edi,r*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}d&&(e.instruction_pointer=e.previous_ip)}else n=e.safe_read16(t),e.add_reg_asize(reg_edi,r);e.cmp16(s,n),e.diverged()}function scasd(e){var t=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,r=e.flags&flag_direction?-4:4,s=e.reg32s[reg_eax];if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=(e.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,o=MAX_COUNT_PER_CYCLE;if(3&t)do{var n=e.safe_read32s(t);t+=r,e.add_reg_asize(reg_edi,r);var d=0!==e.decr_ecx_asize()&&s===n===a}while(d&&o--);else{var h=0>r?-1:1,g=e.translate_address_read(t)>>>2;e.paging&&(o=string_get_cycle_count(r,t));do{n=e.read_aligned32(g),g+=h,d=0!=--i&&s===n===a}while(d&&o--);e.add_reg_asize(reg_edi,r*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}d&&(e.instruction_pointer=e.previous_ip)}else n=e.safe_read32s(t),e.add_reg_asize(reg_edi,r);e.cmp32(s,n),e.diverged()}function insb(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,1);var r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-1:1;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE,o=e.translate_address_write(r);e.paging&&(a=string_get_cycle_count(s,r));do{e.write8(o,e.io.port_read8(t)),o+=s,r=0!=--i}while(r&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i,r&&(e.instruction_pointer=e.previous_ip)}else e.writable_or_pagefault(r,1),e.safe_write8(r,e.io.port_read8(t)),e.add_reg_asize(reg_edi,s);e.diverged()}function insw(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,2);var r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-2:2;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(1&r)do{e.safe_write16(r,e.io.port_read16(t)),r+=s,e.add_reg_asize(reg_edi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_write(r)>>>1;e.paging&&(a=string_get_cycle_count(s,r));do{e.write_aligned16(d,e.io.port_read16(t)),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.writable_or_pagefault(r,2),e.safe_write16(r,e.io.port_read16(t)),e.add_reg_asize(reg_edi,s);e.diverged()}function insd(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,4);var r=e.get_seg(reg_es)+e.get_reg_asize(reg_edi)|0,s=e.flags&flag_direction?-4:4;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(3&r)do{e.safe_write32(r,e.io.port_read32(t)),r+=s,e.add_reg_asize(reg_edi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_write(r)>>>2;e.paging&&(a=string_get_cycle_count(s,r));do{e.write_aligned32(d,e.io.port_read32(t)),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_edi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.writable_or_pagefault(r,4),e.safe_write32(r,e.io.port_read32(t)),e.add_reg_asize(reg_edi,s);e.diverged()}function outsb(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,1);var r=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,s=e.flags&flag_direction?-1:1;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE,o=e.translate_address_read(r);e.paging&&(a=string_get_cycle_count(s,r));do{e.io.port_write8(t,e.read8(o)),o+=s,r=0!=--i}while(r&&a--);e.add_reg_asize(reg_esi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i,r&&(e.instruction_pointer=e.previous_ip)}else e.io.port_write8(t,e.safe_read8(r)),e.add_reg_asize(reg_esi,s);e.diverged()}function outsw(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,2);var r=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,s=e.flags&flag_direction?-2:2;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(1&r)do{e.io.port_write16(t,e.safe_read16(r)),r+=s,e.add_reg_asize(reg_esi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_read(r)>>>1;e.paging&&(a=string_get_cycle_count(s,r));do{e.io.port_write16(t,e.read_aligned16(d)),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_esi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.io.port_write16(t,e.safe_read16(r)),e.add_reg_asize(reg_esi,s);e.diverged()}function outsd(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,4);var r=e.get_seg_prefix(reg_ds)+e.get_reg_asize(reg_esi)|0,s=e.flags&flag_direction?-4:4;if(e.prefixes&PREFIX_MASK_REP){var i=e.get_reg_asize(reg_ecx)>>>0;if(0===i)return;var _=i,a=MAX_COUNT_PER_CYCLE;if(3&r)do{e.io.port_write32(t,e.safe_read32s(r)),r+=s,e.add_reg_asize(reg_esi,s);var o=0!==e.decr_ecx_asize()}while(o&&a--);else{var n=0>s?-1:1,d=e.translate_address_read(r)>>>2;e.paging&&(a=string_get_cycle_count(s,r));do{e.io.port_write32(t,e.read_aligned32(d)),d+=n,o=0!=--i}while(o&&a--);e.add_reg_asize(reg_esi,s*(_-i)|0),e.set_ecx_asize(i),e.timestamp_counter+=_-i}o&&(e.instruction_pointer=e.previous_ip)}else e.io.port_write32(t,e.safe_read32s(r)),e.add_reg_asize(reg_esi,s);e.diverged()}CPU.prototype.movsb=function(){var e=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,t=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,r=this.flags&flag_direction?-1:1;if(this.prefixes&PREFIX_MASK_REP){var s=this.get_reg_asize(reg_ecx)>>>0;if(0===s)return;var i=s,_=MAX_COUNT_PER_CYCLE,a=this.translate_address_read(e),o=this.translate_address_write(t);this.paging&&(_=string_get_cycle_count2(r,e,t));do{this.write8(o,this.read8(a)),o+=r,a+=r,e=0!=--s}while(e&&_--);r=r*(i-s)|0,this.add_reg_asize(reg_edi,r),this.add_reg_asize(reg_esi,r),this.set_ecx_asize(s),this.timestamp_counter+=i-s,e&&(this.instruction_pointer=this.previous_ip)}else this.safe_write8(t,this.safe_read8(e)),this.add_reg_asize(reg_edi,r),this.add_reg_asize(reg_esi,r);this.diverged()},CPU.prototype.movsw=function(){var e=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,t=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,r=this.flags&flag_direction?-2:2;if(this.prefixes&PREFIX_MASK_REP){var s=this.get_reg_asize(reg_ecx)>>>0;if(0===s)return;var i=s,_=MAX_COUNT_PER_CYCLE;if(1&t||1&e)do{this.safe_write16(t,this.safe_read16(e)),t+=r,this.add_reg_asize(reg_edi,r),e+=r,this.add_reg_asize(reg_esi,r);var a=0!==this.decr_ecx_asize()}while(a&&_--);else{var o=0>r?-1:1,n=this.translate_address_read(e)>>>1,d=this.translate_address_write(t)>>>1;this.paging&&(_=string_get_cycle_count2(r,e,t));do{this.write_aligned16(d,this.read_aligned16(n)),d+=o,n+=o,a=0!=--s}while(a&&_--);e=r*(i-s)|0,this.add_reg_asize(reg_edi,e),this.add_reg_asize(reg_esi,e),this.set_ecx_asize(s),this.timestamp_counter+=i-s}a&&(this.instruction_pointer=this.previous_ip)}else this.safe_write16(t,this.safe_read16(e)),this.add_reg_asize(reg_edi,r),this.add_reg_asize(reg_esi,r);this.diverged()},CPU.prototype.movsd=function(){if(this.prefixes&PREFIX_MASK_REP){var e=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,t=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,r=this.get_reg_asize(reg_ecx)>>>0;if(!r)return;var s=this.paging?4095:3;if(0==(t&s)&&0==(e&s)&&0==(this.flags&flag_direction)&&(s=!1,this.paging&&(e=this.translate_address_read(e),t=this.translate_address_write(t),1024<r&&(r=1024,s=!0)),!this.io.in_mmap_range(e,r)&&!this.io.in_mmap_range(t,r))){var i=r<<2;return this.add_reg_asize(reg_ecx,-r),this.add_reg_asize(reg_edi,i),this.add_reg_asize(reg_esi,i),t>>>=2,e>>>=2,this.write_blob32(this.mem32s.subarray(e,e+r),t),void(s&&(this.instruction_pointer=this.previous_ip))}}if(e=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,t=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,i=this.flags&flag_direction?-4:4,this.prefixes&PREFIX_MASK_REP){if(0===(r=this.get_reg_asize(reg_ecx)>>>0))return;var _=r,a=MAX_COUNT_PER_CYCLE;if(3&t||3&e)do{this.safe_write32(t,this.safe_read32s(e)),t+=i,this.add_reg_asize(reg_edi,i),e+=i,this.add_reg_asize(reg_esi,i),s=0!==this.decr_ecx_asize()}while(s&&a--);else{var o=0>i?-1:1,n=this.translate_address_read(e)>>>2,d=this.translate_address_write(t)>>>2;this.paging&&(a=string_get_cycle_count2(i,e,t));do{this.write_aligned32(d,this.read_aligned32(n)),d+=o,n+=o,s=0!=--r}while(s&&a--);i=i*(_-r)|0,this.add_reg_asize(reg_edi,i),this.add_reg_asize(reg_esi,i),this.set_ecx_asize(r),this.timestamp_counter+=_-r}s&&(this.instruction_pointer=this.previous_ip)}else this.safe_write32(t,this.safe_read32s(e)),this.add_reg_asize(reg_edi,i),this.add_reg_asize(reg_esi,i);this.diverged()},CPU.prototype.add8=function(e,t){return this.add(e,t,OPSIZE_8)},CPU.prototype.add16=function(e,t){return this.add(e,t,OPSIZE_16)},CPU.prototype.add32=function(e,t){return this.add(e,t,OPSIZE_32)},CPU.prototype.adc8=function(e,t){return this.adc(e,t,OPSIZE_8)},CPU.prototype.adc16=function(e,t){return this.adc(e,t,OPSIZE_16)},CPU.prototype.adc32=function(e,t){return this.adc(e,t,OPSIZE_32)},CPU.prototype.sub8=function(e,t){return this.sub(e,t,OPSIZE_8)},CPU.prototype.sub16=function(e,t){return this.sub(e,t,OPSIZE_16)},CPU.prototype.sub32=function(e,t){return this.sub(e,t,OPSIZE_32)},CPU.prototype.cmp8=function(e,t){return this.sub(e,t,OPSIZE_8)},CPU.prototype.cmp16=function(e,t){return this.sub(e,t,OPSIZE_16)},CPU.prototype.cmp32=function(e,t){return this.sub(e,t,OPSIZE_32)},CPU.prototype.sbb8=function(e,t){return this.sbb(e,t,OPSIZE_8)},CPU.prototype.sbb16=function(e,t){return this.sbb(e,t,OPSIZE_16)},CPU.prototype.sbb32=function(e,t){return this.sbb(e,t,OPSIZE_32)},CPU.prototype.add=function(e,t,r){return this.last_op1=e,this.last_op2=t,this.last_add_result=this.last_result=e+t|0,this.last_op_size=r,this.flags_changed=flags_all,this.last_result},CPU.prototype.adc=function(e,t,r){var s=this.getcf();return this.last_op1=e,this.last_op2=t,this.last_add_result=this.last_result=(e+t|0)+s|0,this.last_op_size=r,this.flags_changed=flags_all,this.last_result},CPU.prototype.sub=function(e,t,r){return this.last_add_result=e,this.last_op2=t,this.last_op1=this.last_result=e-t|0,this.last_op_size=r,this.flags_changed=flags_all,this.last_result},CPU.prototype.sbb=function(e,t,r){var s=this.getcf();return this.last_add_result=e,this.last_op2=t,this.last_op1=this.last_result=e-t-s|0,this.last_op_size=r,this.flags_changed=flags_all,this.last_result},CPU.prototype.inc8=function(e){return this.inc(e,OPSIZE_8)},CPU.prototype.inc16=function(e){return this.inc(e,OPSIZE_16)},CPU.prototype.inc32=function(e){return this.inc(e,OPSIZE_32)},CPU.prototype.dec8=function(e){return this.dec(e,OPSIZE_8)},CPU.prototype.dec16=function(e){return this.dec(e,OPSIZE_16)},CPU.prototype.dec32=function(e){return this.dec(e,OPSIZE_32)},CPU.prototype.inc=function(e,t){return this.flags=-2&this.flags|this.getcf(),this.last_op1=e,this.last_op2=1,this.last_add_result=this.last_result=e+1|0,this.last_op_size=t,this.flags_changed=-2&flags_all,this.last_result},CPU.prototype.dec=function(e,t){return this.flags=-2&this.flags|this.getcf(),this.last_add_result=e,this.last_op2=1,this.last_op1=this.last_result=e-1|0,this.last_op_size=t,this.flags_changed=-2&flags_all,this.last_result},CPU.prototype.neg8=function(e){return this.neg(e,OPSIZE_8)},CPU.prototype.neg16=function(e){return this.neg(e,OPSIZE_16)},CPU.prototype.neg32=function(e){return this.neg(e,OPSIZE_32)},CPU.prototype.neg=function(e,t){return this.last_op1=this.last_result=0|-e,this.flags_changed=flags_all,this.last_add_result=0,this.last_op2=e,this.last_op_size=t,this.last_result},CPU.prototype.mul8=function(e){e*=this.reg8[reg_al],this.reg16[reg_ax]=e,this.last_result=255&e,this.last_op_size=OPSIZE_8,this.flags=256>e?-2&this.flags&~flag_overflow:1|this.flags|flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.imul8=function(e){e*=this.reg8s[reg_al],this.reg16[reg_ax]=e,this.last_result=255&e,this.last_op_size=OPSIZE_8,this.flags=127<e||-128>e?1|this.flags|flag_overflow:-2&this.flags&~flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.mul16=function(e){var t=(e*=this.reg16[reg_ax])>>>16;this.reg16[reg_ax]=e,this.reg16[reg_dx]=t,this.last_result=65535&e,this.last_op_size=OPSIZE_16,this.flags=0===t?-2&this.flags&~flag_overflow:1|this.flags|flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.imul16=function(e){e*=this.reg16s[reg_ax],this.reg16[reg_ax]=e,this.reg16[reg_dx]=e>>16,this.last_result=65535&e,this.last_op_size=OPSIZE_16,this.flags=32767<e||-32768>e?1|this.flags|flag_overflow:-2&this.flags&~flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.imul_reg16=function(e,t){return dbg_assert(32768>e&&-32768<=e),dbg_assert(32768>t&&-32768<=t),e*=t,this.last_result=65535&e,this.last_op_size=OPSIZE_16,this.flags=32767<e||-32768>e?1|this.flags|flag_overflow:-2&this.flags&~flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow,e},CPU.prototype.do_mul32=function(e,t){var r=65535&e,s=65535&t,i=r*s,_=(s=(i>>>16)+((e>>>=16)*s|0)|0)>>>16;return s=(65535&s)+(r*(t>>>=16)|0)|0,this.mul32_result[0]=s<<16|65535&i,this.mul32_result[1]=((s>>>16)+(e*t|0)|0)+_|0,this.mul32_result},CPU.prototype.do_imul32=function(e,t){var r=!1;return 0>e&&(r=!0,e=0|-e),0>t&&(r=!r,t=0|-t),e=this.do_mul32(e,t),r&&(e[0]=0|-e[0],e[1]=~e[1]+!e[0]|0),e},CPU.prototype.mul32=function(e){e=this.do_mul32(this.reg32s[reg_eax],e),this.reg32s[reg_eax]=e[0],this.reg32s[reg_edx]=e[1],this.last_result=e[0],this.last_op_size=OPSIZE_32,this.flags=0===e[1]?-2&this.flags&~flag_overflow:1|this.flags|flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.imul32=function(e){dbg_assert(2147483648>e&&-2147483648<=e),e=this.do_imul32(this.reg32s[reg_eax],e),this.reg32s[reg_eax]=e[0],this.reg32s[reg_edx]=e[1],this.last_result=e[0],this.last_op_size=OPSIZE_32,this.flags=e[1]===e[0]>>31?-2&this.flags&~flag_overflow:1|this.flags|flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow},CPU.prototype.imul_reg32=function(e,t){return dbg_assert(2147483648>e&&-2147483648<=e),dbg_assert(2147483648>t&&-2147483648<=t),e=this.do_imul32(e,t),this.last_result=e[0],this.last_op_size=OPSIZE_32,this.flags=e[1]===e[0]>>31?-2&this.flags&~flag_overflow:1|this.flags|flag_overflow,this.flags_changed=-2&flags_all&~flag_overflow,e[0]},CPU.prototype.div8=function(e){if(dbg_assert(0<=e&&256>e),0===e)this.trigger_de();else{var t=this.reg16[reg_ax],r=t/e|0;256<=r?this.trigger_de():(this.reg8[reg_al]=r,this.reg8[reg_ah]=t%e)}},CPU.prototype.idiv8=function(e){if(dbg_assert(-128<=e&&128>e),0===e)this.trigger_de();else{var t=this.reg16s[reg_ax],r=t/e|0;128<=r||-129>=r?this.trigger_de():(this.reg8[reg_al]=r,this.reg8[reg_ah]=t%e)}},CPU.prototype.div16=function(e){if(dbg_assert(0<=e&&65536>e),0===e)this.trigger_de();else{var t=(this.reg16[reg_ax]|this.reg16[reg_dx]<<16)>>>0,r=t/e|0;65536<=r||0>r?this.trigger_de():(this.reg16[reg_ax]=r,this.reg16[reg_dx]=t%e)}},CPU.prototype.idiv16=function(e){if(dbg_assert(-32768<=e&&32768>e),0===e)this.trigger_de();else{var t=this.reg16[reg_ax]|this.reg16[reg_dx]<<16,r=t/e|0;32768<=r||-32769>=r?this.trigger_de():(this.reg16[reg_ax]=r,this.reg16[reg_dx]=t%e)}},CPU.prototype.do_div32=function(e,t,r){(t>=r||0===r)&&(dbg_log("div32 #DE: "+h(t,8)+":"+h(e,8)+" div "+h(r,8)),this.trigger_de());var s=0;if(1048576<t){for(var i=32,_=r;_>t;)_>>>=1,i--;for(;1048576<t;){if(t>=_){t-=_;var a=r<<i>>>0;a>e&&t--,e=e-a>>>0,s|=1<<i}i--,_>>=1}s>>>=0}return e+=4294967296*t,this.div32_result[0]=s+(e/r|0),this.div32_result[1]=e%r,this.div32_result},CPU.prototype.div32=function(e){dbg_assert(0<=e&&4294967295>=e);var t=this.reg32[reg_eax],r=this.reg32[reg_edx],s=this.do_div32(t,r,e),i=s[0];s=s[1],dbg_assert(e),4294967296<=i?(dbg_log("div32 #DE: "+h(r,8)+":"+h(t,8)+" div "+h(e,8)),dbg_log("-> "+h(i)),this.trigger_de()):(this.reg32s[reg_eax]=i,this.reg32s[reg_edx]=s)},CPU.prototype.idiv32=function(e){dbg_assert(2147483648>e&&-2147483648<=e);var t=this.reg32[reg_eax],r=this.reg32s[reg_edx],s=!1,i=!1;0>e&&(i=!0,e=-e),0>r&&(s=!0,i=!i,r=~r+!(t=-t>>>0));var _=this.do_div32(t,r,e),a=_[0];_=_[1],i&&(a=0|-a),s&&(_=0|-_),dbg_assert(e),2147483648<=a||-2147483649>=a?(dbg_log("div32 #DE: "+h(r,8)+":"+h(t,8)+" div "+h(e,8)),dbg_log("-> "+h(a)),this.trigger_de()):(this.reg32s[reg_eax]=a,this.reg32s[reg_edx]=_)},CPU.prototype.xadd8=function(e,t){var r=this.reg8[t];return this.reg8[t]=e,this.add(e,r,OPSIZE_8)},CPU.prototype.xadd16=function(e,t){var r=this.reg16[t];return this.reg16[t]=e,this.add(e,r,OPSIZE_16)},CPU.prototype.xadd32=function(e,t){var r=this.reg32s[t];return this.reg32s[t]=e,this.add(e,r,OPSIZE_32)},CPU.prototype.bcd_daa=function(){var e=this.reg8[reg_al],t=this.getcf(),r=this.getaf();this.flags=-2&this.flags&~flag_adjust,(9<(15&e)||r)&&(this.reg8[reg_al]+=6,this.flags|=flag_adjust),(153<e||t)&&(this.reg8[reg_al]+=96,this.flags|=1),this.last_result=this.reg8[reg_al],this.last_op_size=OPSIZE_8,this.last_op1=this.last_op2=0,this.flags_changed=-2&flags_all&~flag_adjust&~flag_overflow},CPU.prototype.bcd_das=function(){var e=this.reg8[reg_al],t=this.getcf();this.flags&=-2,9<(15&e)||this.getaf()?(this.reg8[reg_al]-=6,this.flags|=flag_adjust,this.flags=-2&this.flags|t|6>e):this.flags&=~flag_adjust,(153<e||t)&&(this.reg8[reg_al]-=96,this.flags|=1),this.last_result=this.reg8[reg_al],this.last_op_size=OPSIZE_8,this.last_op1=this.last_op2=0,this.flags_changed=-2&flags_all&~flag_adjust&~flag_overflow},CPU.prototype.bcd_aam=function(e){if(0===e)this.trigger_de();else{var t=this.reg8[reg_al];this.reg8[reg_ah]=t/e,this.reg8[reg_al]=t%e,this.last_result=this.reg8[reg_al],this.flags_changed=-2&flags_all&~flag_adjust&~flag_overflow,this.flags=-2&this.flags&~flag_adjust&~flag_overflow}},CPU.prototype.bcd_aad=function(e){e=this.reg8[reg_al]+this.reg8[reg_ah]*e,this.last_result=255&e,this.reg16[reg_ax]=this.last_result,this.last_op_size=OPSIZE_8,this.flags_changed=-2&flags_all&~flag_adjust&~flag_overflow,this.flags=-2&this.flags&~flag_adjust&~flag_overflow,65535<e&&(this.flags|=1)},CPU.prototype.bcd_aaa=function(){9<(15&this.reg8[reg_al])||this.getaf()?(this.reg16[reg_ax]+=6,this.reg8[reg_ah]+=1,this.flags=this.flags|flag_adjust|1):this.flags=this.flags&~flag_adjust&-2,this.reg8[reg_al]&=15,this.flags_changed=this.flags_changed&~flag_adjust&-2},CPU.prototype.bcd_aas=function(){9<(15&this.reg8[reg_al])||this.getaf()?(this.reg16[reg_ax]-=6,--this.reg8[reg_ah],this.flags=this.flags|flag_adjust|1):this.flags=this.flags&~flag_adjust&-2,this.reg8[reg_al]&=15,this.flags_changed=this.flags_changed&~flag_adjust&-2},CPU.prototype.and8=function(e,t){return this.and(e,t,OPSIZE_8)},CPU.prototype.and16=function(e,t){return this.and(e,t,OPSIZE_16)},CPU.prototype.and32=function(e,t){return this.and(e,t,OPSIZE_32)},CPU.prototype.test8=function(e,t){return this.and(e,t,OPSIZE_8)},CPU.prototype.test16=function(e,t){return this.and(e,t,OPSIZE_16)},CPU.prototype.test32=function(e,t){return this.and(e,t,OPSIZE_32)},CPU.prototype.or8=function(e,t){return this.or(e,t,OPSIZE_8)},CPU.prototype.or16=function(e,t){return this.or(e,t,OPSIZE_16)},CPU.prototype.or32=function(e,t){return this.or(e,t,OPSIZE_32)},CPU.prototype.xor8=function(e,t){return this.xor(e,t,OPSIZE_8)},CPU.prototype.xor16=function(e,t){return this.xor(e,t,OPSIZE_16)},CPU.prototype.xor32=function(e,t){return this.xor(e,t,OPSIZE_32)},CPU.prototype.and=function(e,t,r){return this.last_result=e&t,this.last_op_size=r,this.flags=-2&this.flags&~flag_overflow&~flag_adjust,this.flags_changed=-2&flags_all&~flag_overflow&~flag_adjust,this.last_result},CPU.prototype.or=function(e,t,r){return this.last_result=e|t,this.last_op_size=r,this.flags=-2&this.flags&~flag_overflow&~flag_adjust,this.flags_changed=-2&flags_all&~flag_overflow&~flag_adjust,this.last_result},CPU.prototype.xor=function(e,t,r){return this.last_result=e^t,this.last_op_size=r,this.flags=-2&this.flags&~flag_overflow&~flag_adjust,this.flags_changed=-2&flags_all&~flag_overflow&~flag_adjust,this.last_result},CPU.prototype.rol8=function(e,t){return t?(e=e<<(t&=7)|e>>8-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|1&e|(e<<11^e<<4)&flag_overflow,e):e},CPU.prototype.rol16=function(e,t){return t?(e=e<<(t&=15)|e>>16-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|1&e|(e<<11^e>>4)&flag_overflow,e):e},CPU.prototype.rol32=function(e,t){return t?(e=e<<t|e>>>32-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|1&e|(e<<11^e>>20)&flag_overflow,e):e},CPU.prototype.rcl8=function(e,t){return(t%=9)?(e=e<<t|this.getcf()<<t-1|e>>9-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>8&1|(e<<3^e<<4)&flag_overflow,e):e},CPU.prototype.rcl16=function(e,t){return(t%=17)?(e=e<<t|this.getcf()<<t-1|e>>17-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>16&1|(e>>5^e>>4)&flag_overflow,e):e},CPU.prototype.rcl32=function(e,t){if(!t)return e;var r=e<<t|this.getcf()<<t-1;return 1<t&&(r|=e>>>33-t),this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>>32-t&1,this.flags|=(this.flags<<11^r>>20)&flag_overflow,r},CPU.prototype.ror8=function(e,t){return t?(e=e>>(t&=7)|e<<8-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>7&1|(e<<4^e<<5)&flag_overflow,e):e},CPU.prototype.ror16=function(e,t){return t?(e=e>>(t&=15)|e<<16-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>15&1|(e>>4^e>>3)&flag_overflow,e):e},CPU.prototype.ror32=function(e,t){return t?(e=e>>>t|e<<32-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>31&1|(e>>20^e>>19)&flag_overflow,e):e},CPU.prototype.rcr8=function(e,t){return(t%=9)?(e=e>>t|this.getcf()<<8-t|e<<9-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>8&1|(e<<4^e<<5)&flag_overflow,e):e},CPU.prototype.rcr16=function(e,t){return(t%=17)?(e=e>>t|this.getcf()<<16-t|e<<17-t,this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>16&1|(e>>4^e>>3)&flag_overflow,e):e},CPU.prototype.rcr32=function(e,t){if(!t)return e;var r=e>>>t|this.getcf()<<32-t;return 1<t&&(r|=e<<33-t),this.flags_changed=-2&this.flags_changed&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>t-1&1|(r>>20^r>>19)&flag_overflow,r},CPU.prototype.shl8=function(e,t){return 0===t?e:(this.last_result=e<<t,this.last_op_size=OPSIZE_8,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|this.last_result>>8&1|(this.last_result<<3^this.last_result<<4)&flag_overflow,this.last_result)},CPU.prototype.shl16=function(e,t){return 0===t?e:(this.last_result=e<<t,this.last_op_size=OPSIZE_16,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|this.last_result>>16&1|(this.last_result>>5^this.last_result>>4)&flag_overflow,this.last_result)},CPU.prototype.shl32=function(e,t){return 0===t?e:(this.last_result=e<<t,this.last_op_size=OPSIZE_32,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>>32-t&1,this.flags|=(1&this.flags^this.last_result>>31&1)<<11&flag_overflow,this.last_result)},CPU.prototype.shr8=function(e,t){return 0===t?e:(this.last_result=e>>t,this.last_op_size=OPSIZE_8,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>t-1&1|(e>>7&1)<<11&flag_overflow,this.last_result)},CPU.prototype.shr16=function(e,t){return 0===t?e:(this.last_result=e>>t,this.last_op_size=OPSIZE_16,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>t-1&1|e>>4&flag_overflow,this.last_result)},CPU.prototype.shr32=function(e,t){return 0===t?e:(this.last_result=e>>>t,this.last_op_size=OPSIZE_32,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>>t-1&1|e>>20&flag_overflow,this.last_result)},CPU.prototype.sar8=function(e,t){return 0===t?e:(8>t?(this.last_result=e<<24>>t+24,this.flags=-2&this.flags&~flag_overflow|e>>t-1&1):(this.last_result=e<<24>>31,this.flags=-2&this.flags&~flag_overflow|1&this.last_result),this.last_op_size=OPSIZE_8,this.flags_changed=-2&flags_all&~flag_overflow,this.last_result)},CPU.prototype.sar16=function(e,t){return 0===t?e:(16>t?(this.last_result=e<<16>>t+16,this.flags=-2&this.flags&~flag_overflow|e>>t-1&1):(this.last_result=e<<16>>31,this.flags=-2&this.flags&~flag_overflow|1&this.last_result),this.last_op_size=OPSIZE_16,this.flags_changed=-2&flags_all&~flag_overflow,this.last_result)},CPU.prototype.sar32=function(e,t){return 0===t?e:(this.last_result=e>>t,this.last_op_size=OPSIZE_32,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags&~flag_overflow|e>>>t-1&1,this.last_result)},CPU.prototype.shrd16=function(e,t,r){return 0===r?e:(16>=r?(this.last_result=e>>r|t<<16-r,this.flags=-2&this.flags|e>>r-1&1):(this.last_result=e<<32-r|t>>r-16,this.flags=-2&this.flags|t>>r-17&1),this.last_op_size=OPSIZE_16,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=this.flags&~flag_overflow|(this.last_result^e)>>4&flag_overflow,this.last_result)},CPU.prototype.shrd32=function(e,t,r){return 0===r?e:(this.last_result=e>>>r|t<<32-r,this.last_op_size=OPSIZE_32,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags|e>>>r-1&1,this.flags=this.flags&~flag_overflow|(this.last_result^e)>>20&flag_overflow,this.last_result)},CPU.prototype.shld16=function(e,t,r){return 0===r?e:(16>=r?(this.last_result=e<<r|t>>>16-r,this.flags=-2&this.flags|e>>>16-r&1):(this.last_result=e>>32-r|t<<r-16,this.flags=-2&this.flags|t>>>32-r&1),this.last_op_size=OPSIZE_16,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=this.flags&~flag_overflow|(1&this.flags^this.last_result>>15&1)<<11,this.last_result)},CPU.prototype.shld32=function(e,t,r){return 0===r?e:(this.last_result=e<<r|t>>>32-r,this.last_op_size=OPSIZE_32,this.flags_changed=-2&flags_all&~flag_overflow,this.flags=-2&this.flags|e>>>32-r&1,this.flags=1===r?this.flags&~flag_overflow|(1&this.flags^this.last_result>>31&1)<<11:this.flags&~flag_overflow,this.last_result)},CPU.prototype.bt_reg=function(e,t){this.flags=-2&this.flags|e>>t&1,this.flags_changed&=-2},CPU.prototype.btc_reg=function(e,t){return this.flags=-2&this.flags|e>>t&1,this.flags_changed&=-2,e^1<<t},CPU.prototype.bts_reg=function(e,t){return this.flags=-2&this.flags|e>>t&1,this.flags_changed&=-2,e|1<<t},CPU.prototype.btr_reg=function(e,t){return this.flags=-2&this.flags|e>>t&1,this.flags_changed&=-2,e&~(1<<t)},CPU.prototype.bt_mem=function(e,t){e=this.safe_read8(e+(t>>3)|0),this.flags=-2&this.flags|e>>(7&t)&1,this.flags_changed&=-2},CPU.prototype.btc_mem=function(e,t){e=this.translate_address_write(e+(t>>3)|0);var r=this.read8(e);t&=7,this.flags=-2&this.flags|r>>t&1,this.flags_changed&=-2,this.write8(e,r^1<<t)},CPU.prototype.btr_mem=function(e,t){e=this.translate_address_write(e+(t>>3)|0);var r=this.read8(e);t&=7,this.flags=-2&this.flags|r>>t&1,this.flags_changed&=-2,this.write8(e,r&~(1<<t))},CPU.prototype.bts_mem=function(e,t){e=this.translate_address_write(e+(t>>3)|0);var r=this.read8(e);t&=7,this.flags=-2&this.flags|r>>t&1,this.flags_changed&=-2,this.write8(e,r|1<<t)},CPU.prototype.bsf16=function(e,t){return this.flags_changed=flags_all&~flag_zero,this.last_op_size=OPSIZE_16,0===t?(this.flags|=flag_zero,this.last_result=t,e):(this.flags&=~flag_zero,this.last_result=v86util.int_log2(-t&t))},CPU.prototype.bsf32=function(e,t){return this.flags_changed=flags_all&~flag_zero,this.last_op_size=OPSIZE_32,0===t?(this.flags|=flag_zero,this.last_result=t,e):(this.flags&=~flag_zero,this.last_result=v86util.int_log2((-t&t)>>>0))},CPU.prototype.bsr16=function(e,t){return this.flags_changed=flags_all&~flag_zero,this.last_op_size=OPSIZE_16,0===t?(this.flags|=flag_zero,this.last_result=t,e):(this.flags&=~flag_zero,this.last_result=v86util.int_log2(t))},CPU.prototype.bsr32=function(e,t){return this.flags_changed=flags_all&~flag_zero,this.last_op_size=OPSIZE_32,0===t?(this.flags|=flag_zero,this.last_result=t,e):(this.flags&=~flag_zero,this.last_result=v86util.int_log2(t>>>0))},CPU.prototype.popcnt=function(e){return this.flags_changed=0,this.flags&=~flags_all,e?16843009*((e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135)>>24:(this.flags|=flag_zero,0)},CPU.prototype.saturate_sw_to_ub=function(e){return dbg_assert(0==(4294901760&e)),32768<=(e>>>=0)?e=0:255<e&&(e=255),dbg_assert(0==(4294967040&e)),e},CPU.prototype.saturate_sw_to_sb=function(e){return dbg_assert(0==(4294901760&e)),65408<e?e&=255:32767<e?e=128:127<e&&(e=127),dbg_assert(0==(4294967040&e)),e},CPU.prototype.saturate_sd_to_sw=function(e){return 4294934528<(e>>>=0)?e&=65535:2147483647<e?e=32768:32767<e&&(e=32767),dbg_assert(0==(4294901760&e)),e},CPU.prototype.saturate_sd_to_sb=function(e){return 4294967168<(e>>>=0)?e&=255:2147483647<e?e=128:127<e&&(e=127),dbg_assert(0==(4294967040&e)),e},CPU.prototype.saturate_sd_to_ub=function(e){return 0>(e|=0)&&(e=0),dbg_assert(0==(4294967040&e)),e},CPU.prototype.saturate_ud_to_ub=function(e){return 255<(e>>>=0)&&(e=255),dbg_assert(0==(4294967040&e)),e},CPU.prototype.saturate_uw=function(e){return dbg_assert(0<=e),65535<e?65535:e},CPU.prototype.jmpcc8=function(e){var t=this.read_op8s();e?(this.instruction_pointer=this.instruction_pointer+t|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.jmp_rel16=function(e){var t=this.get_seg(reg_cs);this.instruction_pointer-=t,this.instruction_pointer=this.instruction_pointer+e&65535,this.instruction_pointer=this.instruction_pointer+t|0},CPU.prototype.jmpcc16=function(e){var t=this.read_op16();e?(this.jmp_rel16(t),this.branch_taken()):this.branch_not_taken()},CPU.prototype.jmpcc32=function(e){var t=this.read_op32s();e?(this.instruction_pointer=this.instruction_pointer+t|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.cmovcc16=function(e){var t=this.read_e16();e&&this.write_g16(t)},CPU.prototype.cmovcc32=function(e){var t=this.read_e32s();e&&this.write_g32(t)},CPU.prototype.setcc=function(e){this.set_e8(e?1:0)},CPU.prototype.loopne=function(e){this.decr_ecx_asize()&&!this.getzf()?(this.instruction_pointer=this.instruction_pointer+e|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.loope=function(e){this.decr_ecx_asize()&&this.getzf()?(this.instruction_pointer=this.instruction_pointer+e|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.loop=function(e){this.decr_ecx_asize()?(this.instruction_pointer=this.instruction_pointer+e|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.jcxz=function(e){0===this.get_reg_asize(reg_ecx)?(this.instruction_pointer=this.instruction_pointer+e|0,this.branch_taken()):this.branch_not_taken()},CPU.prototype.getcf=function(){return 1&this.flags_changed?(this.last_op1^(this.last_op1^this.last_op2)&(this.last_op2^this.last_add_result))>>>this.last_op_size&1:1&this.flags},CPU.prototype.getpf=function(){return this.flags_changed&flag_parity?154020>>(15&(this.last_result^this.last_result>>4))&flag_parity:this.flags&flag_parity},CPU.prototype.getaf=function(){return this.flags_changed&flag_adjust?(this.last_op1^this.last_op2^this.last_add_result)&flag_adjust:this.flags&flag_adjust},CPU.prototype.getzf=function(){return this.flags_changed&flag_zero?(~this.last_result&this.last_result-1)>>>this.last_op_size&1:this.flags&flag_zero},CPU.prototype.getsf=function(){return this.flags_changed&flag_sign?this.last_result>>>this.last_op_size&1:this.flags&flag_sign},CPU.prototype.getof=function(){return this.flags_changed&flag_overflow?((this.last_op1^this.last_add_result)&(this.last_op2^this.last_add_result))>>>this.last_op_size&1:this.flags&flag_overflow},CPU.prototype.test_o=CPU.prototype.getof,CPU.prototype.test_b=CPU.prototype.getcf,CPU.prototype.test_z=CPU.prototype.getzf,CPU.prototype.test_s=CPU.prototype.getsf,CPU.prototype.test_p=CPU.prototype.getpf,CPU.prototype.test_be=function(){return this.getcf()||this.getzf()},CPU.prototype.test_l=function(){return!this.getsf()!=!this.getof()},CPU.prototype.test_le=function(){return this.getzf()||!this.getsf()!=!this.getof()},CPU.prototype.push16=function(e){var t=this.get_stack_pointer(-2);this.safe_write16(t,e),this.adjust_stack_reg(-2)},CPU.prototype.push32=function(e){var t=this.get_stack_pointer(-4);this.safe_write32(t,e),this.adjust_stack_reg(-4)},CPU.prototype.pop16=function(){var e=this.get_seg(reg_ss)+this.get_stack_reg()|0;return e=this.safe_read16(e),this.adjust_stack_reg(2),e},CPU.prototype.pop32s=function(){var e=this.get_seg(reg_ss)+this.get_stack_reg()|0;return e=this.safe_read32s(e),this.adjust_stack_reg(4),e},CPU.prototype.pusha16=function(){var e=this.reg16[reg_sp];this.writable_or_pagefault(this.get_stack_pointer(-16),16),this.push16(this.reg16[reg_ax]),this.push16(this.reg16[reg_cx]),this.push16(this.reg16[reg_dx]),this.push16(this.reg16[reg_bx]),this.push16(e),this.push16(this.reg16[reg_bp]),this.push16(this.reg16[reg_si]),this.push16(this.reg16[reg_di])},CPU.prototype.pusha32=function(){var e=this.reg32s[reg_esp];this.writable_or_pagefault(this.get_stack_pointer(-32),32),this.push32(this.reg32s[reg_eax]),this.push32(this.reg32s[reg_ecx]),this.push32(this.reg32s[reg_edx]),this.push32(this.reg32s[reg_ebx]),this.push32(e),this.push32(this.reg32s[reg_ebp]),this.push32(this.reg32s[reg_esi]),this.push32(this.reg32s[reg_edi])},CPU.prototype.popa16=function(){this.translate_address_read(this.get_stack_pointer(0)),this.translate_address_read(this.get_stack_pointer(15)),this.reg16[reg_di]=this.pop16(),this.reg16[reg_si]=this.pop16(),this.reg16[reg_bp]=this.pop16(),this.adjust_stack_reg(2),this.reg16[reg_bx]=this.pop16(),this.reg16[reg_dx]=this.pop16(),this.reg16[reg_cx]=this.pop16(),this.reg16[reg_ax]=this.pop16()},CPU.prototype.popa32=function(){this.translate_address_read(this.get_stack_pointer(0)),this.translate_address_read(this.get_stack_pointer(31)),this.reg32s[reg_edi]=this.pop32s(),this.reg32s[reg_esi]=this.pop32s(),this.reg32s[reg_ebp]=this.pop32s(),this.adjust_stack_reg(4),this.reg32s[reg_ebx]=this.pop32s(),this.reg32s[reg_edx]=this.pop32s(),this.reg32s[reg_ecx]=this.pop32s(),this.reg32s[reg_eax]=this.pop32s()},CPU.prototype.xchg8=function(e,t){t=t>>1&12|t>>5&1;var r=this.reg8[t];return this.reg8[t]=e,r},CPU.prototype.xchg16=function(e,t){t=t>>2&14;var r=this.reg16[t];return this.reg16[t]=e,r},CPU.prototype.xchg16r=function(e){var t=this.reg16[reg_ax];this.reg16[reg_ax]=this.reg16[e],this.reg16[e]=t},CPU.prototype.xchg32=function(e,t){t=t>>3&7;var r=this.reg32s[t];return this.reg32s[t]=e,r},CPU.prototype.xchg32r=function(e){var t=this.reg32s[reg_eax];this.reg32s[reg_eax]=this.reg32s[e],this.reg32s[e]=t},CPU.prototype.lss16=function(e){192<=this.modrm_byte&&this.trigger_ud();var t=this.modrm_resolve(this.modrm_byte),r=this.safe_read16(t);t=this.safe_read16(t+2|0),this.switch_seg(e,t),this.reg16[this.modrm_byte>>2&14]=r},CPU.prototype.lss32=function(e){192<=this.modrm_byte&&this.trigger_ud();var t=this.modrm_resolve(this.modrm_byte),r=this.safe_read32s(t);t=this.safe_read16(t+4|0),this.switch_seg(e,t),this.reg32s[this.modrm_byte>>3&7]=r},CPU.prototype.enter16=function(e,t){(t&=31)&&dbg_log("enter16 stack="+(this.stack_size_32?32:16)+" size="+e+" nest="+t,LOG_CPU),this.push16(this.reg16[reg_bp]);var r=this.reg16[reg_sp];if(0<t){for(var s=this.reg16[reg_ebp],i=1;i<t;i++)s-=2,this.push16(this.safe_read16(this.get_seg(reg_ss)+s|0));this.push16(r)}this.reg16[reg_bp]=r,this.adjust_stack_reg(-e)},CPU.prototype.enter32=function(e,t){(t&=31)&&dbg_log("enter32 stack="+(this.stack_size_32?32:16)+" size="+e+" nest="+t,LOG_CPU),this.push32(this.reg32s[reg_ebp]);var r=this.reg32s[reg_esp];if(0<t){for(var s=this.reg32s[reg_ebp],i=1;i<t;i++)s-=4,this.push32(this.safe_read32s(this.get_seg(reg_ss)+s|0));this.push32(r)}this.reg32s[reg_ebp]=r,this.adjust_stack_reg(-e)},CPU.prototype.bswap=function(e){var t=this.reg32s[e];this.reg32s[e]=t>>>24|t<<24|t>>8&65280|t<<8&16711680},CPU.prototype.fxsave=function(e){this.writable_or_pagefault(e,512),this.safe_write16(e+0|0,this.fpu.control_word),this.safe_write16(e+2|0,this.fpu.load_status_word()),this.safe_write8(e+4|0,255&~this.fpu.stack_empty),this.safe_write16(e+6|0,this.fpu.fpu_opcode),this.safe_write32(e+8|0,this.fpu.fpu_ip),this.safe_write16(e+12|0,this.fpu.fpu_ip_selector),this.safe_write32(e+16|0,this.fpu.fpu_dp),this.safe_write16(e+20|0,this.fpu.fpu_dp_selector),this.safe_write32(e+24|0,this.mxcsr),this.safe_write32(e+28|0,MXCSR_MASK);for(var t=0;8>t;t++)this.fpu.store_m80(e+32+(t<<4)|0,this.fpu.st[this.fpu.stack_ptr+t&7]);for(t=0;8>t;t++)this.safe_write32(e+160+(t<<4)+0|0,this.reg_xmm32s[t<<2|0]),this.safe_write32(e+160+(t<<4)+4|0,this.reg_xmm32s[t<<2|1]),this.safe_write32(e+160+(t<<4)+8|0,this.reg_xmm32s[t<<2|2]),this.safe_write32(e+160+(t<<4)+12|0,this.reg_xmm32s[t<<2|3])},CPU.prototype.fxrstor=function(e){this.translate_address_read(0|e),this.translate_address_read(e+511|0);var t=this.safe_read32s(e+24|0);for(t&~MXCSR_MASK&&(dbg_log("Invalid mxcsr bits: "+h((t&~MXCSR_MASK)>>>0,8)),this.trigger_gp(0)),this.fpu.control_word=this.safe_read16(e+0|0),this.fpu.set_status_word(this.safe_read16(e+2|0)),this.fpu.stack_empty=255&~this.safe_read8(e+4|0),this.fpu.fpu_opcode=this.safe_read16(e+6|0),this.fpu.fpu_ip=this.safe_read32s(e+8|0),this.fpu.fpu_ip=this.safe_read16(e+12|0),this.fpu.fpu_dp=this.safe_read32s(e+16|0),this.fpu.fpu_dp_selector=this.safe_read16(e+20|0),this.mxcsr=t,t=0;8>t;t++)this.fpu.st[this.fpu.stack_ptr+t&7]=this.fpu.load_m80(e+32+(t<<4)|0);for(t=0;8>t;t++)this.reg_xmm32s[t<<2|0]=this.safe_read32s(e+160+(t<<4)+0|0),this.reg_xmm32s[t<<2|1]=this.safe_read32s(e+160+(t<<4)+4|0),this.reg_xmm32s[t<<2|2]=this.safe_read32s(e+160+(t<<4)+8|0),this.reg_xmm32s[t<<2|3]=this.safe_read32s(e+160+(t<<4)+12|0)};var t=[],t16=[],t32=[];t[0]=function(e){e.read_modrm_byte(),e.write_e8(e.add8(e.read_write_e8(),e.read_g8()))},t16[1]=function(e){e.read_modrm_byte(),e.write_e16(e.add16(e.read_write_e16(),e.read_g16()))},t32[1]=function(e){e.read_modrm_byte(),e.write_e32(e.add32(e.read_write_e32(),e.read_g32s()))},t[2]=function(e){e.read_modrm_byte(),e.write_g8(e.add8(e.read_g8(),e.read_e8()))},t16[3]=function(e){e.read_modrm_byte(),e.write_g16(e.add16(e.read_g16(),e.read_e16()))},t32[3]=function(e){e.read_modrm_byte(),e.write_g32(e.add32(e.read_g32s(),e.read_e32s()))},t[4]=function(e){e.reg8[reg_al]=e.add8(e.reg8[reg_al],e.read_op8())},t16[5]=function(e){e.reg16[reg_ax]=e.add16(e.reg16[reg_ax],e.read_op16())},t32[5]=function(e){e.reg32s[reg_eax]=e.add32(e.reg32s[reg_eax],e.read_op32s())},t16[6]=function(e){e.push16(e.sreg[reg_es])},t32[6]=function(e){e.push32(e.sreg[reg_es])},t16[7]=function(e){e.switch_seg(reg_es,e.safe_read16(e.get_stack_pointer(0))),e.adjust_stack_reg(2)},t32[7]=function(e){e.switch_seg(reg_es,65535&e.safe_read32s(e.get_stack_pointer(0))),e.adjust_stack_reg(4)},t[8]=function(e){e.read_modrm_byte(),e.write_e8(e.or8(e.read_write_e8(),e.read_g8()))},t16[9]=function(e){e.read_modrm_byte(),e.write_e16(e.or16(e.read_write_e16(),e.read_g16()))},t32[9]=function(e){e.read_modrm_byte(),e.write_e32(e.or32(e.read_write_e32(),e.read_g32s()))},t[10]=function(e){e.read_modrm_byte(),e.write_g8(e.or8(e.read_g8(),e.read_e8()))},t16[11]=function(e){e.read_modrm_byte(),e.write_g16(e.or16(e.read_g16(),e.read_e16()))},t32[11]=function(e){e.read_modrm_byte(),e.write_g32(e.or32(e.read_g32s(),e.read_e32s()))},t[12]=function(e){e.reg8[reg_al]=e.or8(e.reg8[reg_al],e.read_op8())},t16[13]=function(e){e.reg16[reg_ax]=e.or16(e.reg16[reg_ax],e.read_op16())},t32[13]=function(e){e.reg32s[reg_eax]=e.or32(e.reg32s[reg_eax],e.read_op32s())},t16[14]=function(e){e.push16(e.sreg[reg_cs])},t32[14]=function(e){e.push32(e.sreg[reg_cs])},t16[15]=function(e){e.table0F_16[e.read_op0F()](e)},t32[15]=function(e){e.table0F_32[e.read_op0F()](e)},t[16]=function(e){e.read_modrm_byte(),e.write_e8(e.adc8(e.read_write_e8(),e.read_g8()))},t16[17]=function(e){e.read_modrm_byte(),e.write_e16(e.adc16(e.read_write_e16(),e.read_g16()))},t32[17]=function(e){e.read_modrm_byte(),e.write_e32(e.adc32(e.read_write_e32(),e.read_g32s()))},t[18]=function(e){e.read_modrm_byte(),e.write_g8(e.adc8(e.read_g8(),e.read_e8()))},t16[19]=function(e){e.read_modrm_byte(),e.write_g16(e.adc16(e.read_g16(),e.read_e16()))},t32[19]=function(e){e.read_modrm_byte(),e.write_g32(e.adc32(e.read_g32s(),e.read_e32s()))},t[20]=function(e){e.reg8[reg_al]=e.adc8(e.reg8[reg_al],e.read_op8())},t16[21]=function(e){e.reg16[reg_ax]=e.adc16(e.reg16[reg_ax],e.read_op16())},t32[21]=function(e){e.reg32s[reg_eax]=e.adc32(e.reg32s[reg_eax],e.read_op32s())},t16[22]=function(e){e.push16(e.sreg[reg_ss])},t32[22]=function(e){e.push32(e.sreg[reg_ss])},t16[23]=function(e){e.switch_seg(reg_ss,e.safe_read16(e.get_stack_pointer(0))),e.adjust_stack_reg(2),e.clear_prefixes(),e.cycle_internal()},t32[23]=function(e){e.switch_seg(reg_ss,65535&e.safe_read32s(e.get_stack_pointer(0))),e.adjust_stack_reg(4),e.clear_prefixes(),e.cycle_internal()},t[24]=function(e){e.read_modrm_byte(),e.write_e8(e.sbb8(e.read_write_e8(),e.read_g8()))},t16[25]=function(e){e.read_modrm_byte(),e.write_e16(e.sbb16(e.read_write_e16(),e.read_g16()))},t32[25]=function(e){e.read_modrm_byte(),e.write_e32(e.sbb32(e.read_write_e32(),e.read_g32s()))},t[26]=function(e){e.read_modrm_byte(),e.write_g8(e.sbb8(e.read_g8(),e.read_e8()))},t16[27]=function(e){e.read_modrm_byte(),e.write_g16(e.sbb16(e.read_g16(),e.read_e16()))},t32[27]=function(e){e.read_modrm_byte(),e.write_g32(e.sbb32(e.read_g32s(),e.read_e32s()))},t[28]=function(e){e.reg8[reg_al]=e.sbb8(e.reg8[reg_al],e.read_op8())},t16[29]=function(e){e.reg16[reg_ax]=e.sbb16(e.reg16[reg_ax],e.read_op16())},t32[29]=function(e){e.reg32s[reg_eax]=e.sbb32(e.reg32s[reg_eax],e.read_op32s())},t16[30]=function(e){e.push16(e.sreg[reg_ds])},t32[30]=function(e){e.push32(e.sreg[reg_ds])},t16[31]=function(e){e.switch_seg(reg_ds,e.safe_read16(e.get_stack_pointer(0))),e.adjust_stack_reg(2)},t32[31]=function(e){e.switch_seg(reg_ds,65535&e.safe_read32s(e.get_stack_pointer(0))),e.adjust_stack_reg(4)},t[32]=function(e){e.read_modrm_byte(),e.write_e8(e.and8(e.read_write_e8(),e.read_g8()))},t16[33]=function(e){e.read_modrm_byte(),e.write_e16(e.and16(e.read_write_e16(),e.read_g16()))},t32[33]=function(e){e.read_modrm_byte(),e.write_e32(e.and32(e.read_write_e32(),e.read_g32s()))},t[34]=function(e){e.read_modrm_byte(),e.write_g8(e.and8(e.read_g8(),e.read_e8()))},t16[35]=function(e){e.read_modrm_byte(),e.write_g16(e.and16(e.read_g16(),e.read_e16()))},t32[35]=function(e){e.read_modrm_byte(),e.write_g32(e.and32(e.read_g32s(),e.read_e32s()))},t[36]=function(e){e.reg8[reg_al]=e.and8(e.reg8[reg_al],e.read_op8())},t16[37]=function(e){e.reg16[reg_ax]=e.and16(e.reg16[reg_ax],e.read_op16())},t32[37]=function(e){e.reg32s[reg_eax]=e.and32(e.reg32s[reg_eax],e.read_op32s())},t[38]=function(e){e.segment_prefix_op(reg_es)},t[39]=function(e){e.bcd_daa()},t[40]=function(e){e.read_modrm_byte(),e.write_e8(e.sub8(e.read_write_e8(),e.read_g8()))},t16[41]=function(e){e.read_modrm_byte(),e.write_e16(e.sub16(e.read_write_e16(),e.read_g16()))},t32[41]=function(e){e.read_modrm_byte(),e.write_e32(e.sub32(e.read_write_e32(),e.read_g32s()))},t[42]=function(e){e.read_modrm_byte(),e.write_g8(e.sub8(e.read_g8(),e.read_e8()))},t16[43]=function(e){e.read_modrm_byte(),e.write_g16(e.sub16(e.read_g16(),e.read_e16()))},t32[43]=function(e){e.read_modrm_byte(),e.write_g32(e.sub32(e.read_g32s(),e.read_e32s()))},t[44]=function(e){e.reg8[reg_al]=e.sub8(e.reg8[reg_al],e.read_op8())},t16[45]=function(e){e.reg16[reg_ax]=e.sub16(e.reg16[reg_ax],e.read_op16())},t32[45]=function(e){e.reg32s[reg_eax]=e.sub32(e.reg32s[reg_eax],e.read_op32s())},t[46]=function(e){e.segment_prefix_op(reg_cs)},t[47]=function(e){e.bcd_das()},t[48]=function(e){e.read_modrm_byte(),e.write_e8(e.xor8(e.read_write_e8(),e.read_g8()))},t16[49]=function(e){e.read_modrm_byte(),e.write_e16(e.xor16(e.read_write_e16(),e.read_g16()))},t32[49]=function(e){e.read_modrm_byte(),e.write_e32(e.xor32(e.read_write_e32(),e.read_g32s()))},t[50]=function(e){e.read_modrm_byte(),e.write_g8(e.xor8(e.read_g8(),e.read_e8()))},t16[51]=function(e){e.read_modrm_byte(),e.write_g16(e.xor16(e.read_g16(),e.read_e16()))},t32[51]=function(e){e.read_modrm_byte(),e.write_g32(e.xor32(e.read_g32s(),e.read_e32s()))},t[52]=function(e){e.reg8[reg_al]=e.xor8(e.reg8[reg_al],e.read_op8())},t16[53]=function(e){e.reg16[reg_ax]=e.xor16(e.reg16[reg_ax],e.read_op16())},t32[53]=function(e){e.reg32s[reg_eax]=e.xor32(e.reg32s[reg_eax],e.read_op32s())},t[54]=function(e){e.segment_prefix_op(reg_ss)},t[55]=function(e){e.bcd_aaa()},t[56]=function(e){e.read_modrm_byte(),e.cmp8(e.read_e8(),e.read_g8())},t16[57]=function(e){e.read_modrm_byte(),e.cmp16(e.read_e16(),e.read_g16())},t32[57]=function(e){e.read_modrm_byte(),e.cmp32(e.read_e32s(),e.read_g32s())},t[58]=function(e){e.read_modrm_byte(),e.cmp8(e.read_g8(),e.read_e8())},t16[59]=function(e){e.read_modrm_byte(),e.cmp16(e.read_g16(),e.read_e16())},t32[59]=function(e){e.read_modrm_byte(),e.cmp32(e.read_g32s(),e.read_e32s())},t[60]=function(e){e.cmp8(e.reg8[reg_al],e.read_op8())},t16[61]=function(e){e.cmp16(e.reg16[reg_ax],e.read_op16())},t32[61]=function(e){e.cmp32(e.reg32s[reg_eax],e.read_op32s())},t[62]=function(e){e.segment_prefix_op(reg_ds)},t[63]=function(e){e.bcd_aas()},t16[64]=function(e){e.reg16[reg_ax]=e.inc16(e.reg16[reg_ax])},t32[64]=function(e){e.reg32s[reg_eax]=e.inc32(e.reg32s[reg_eax])},t16[65]=function(e){e.reg16[reg_cx]=e.inc16(e.reg16[reg_cx])},t32[65]=function(e){e.reg32s[reg_ecx]=e.inc32(e.reg32s[reg_ecx])},t16[66]=function(e){e.reg16[reg_dx]=e.inc16(e.reg16[reg_dx])},t32[66]=function(e){e.reg32s[reg_edx]=e.inc32(e.reg32s[reg_edx])},t16[67]=function(e){e.reg16[reg_bx]=e.inc16(e.reg16[reg_bx])},t32[67]=function(e){e.reg32s[reg_ebx]=e.inc32(e.reg32s[reg_ebx])},t16[68]=function(e){e.reg16[reg_sp]=e.inc16(e.reg16[reg_sp])},t32[68]=function(e){e.reg32s[reg_esp]=e.inc32(e.reg32s[reg_esp])},t16[69]=function(e){e.reg16[reg_bp]=e.inc16(e.reg16[reg_bp])},t32[69]=function(e){e.reg32s[reg_ebp]=e.inc32(e.reg32s[reg_ebp])},t16[70]=function(e){e.reg16[reg_si]=e.inc16(e.reg16[reg_si])},t32[70]=function(e){e.reg32s[reg_esi]=e.inc32(e.reg32s[reg_esi])},t16[71]=function(e){e.reg16[reg_di]=e.inc16(e.reg16[reg_di])},t32[71]=function(e){e.reg32s[reg_edi]=e.inc32(e.reg32s[reg_edi])},t16[72]=function(e){e.reg16[reg_ax]=e.dec16(e.reg16[reg_ax])},t32[72]=function(e){e.reg32s[reg_eax]=e.dec32(e.reg32s[reg_eax])},t16[73]=function(e){e.reg16[reg_cx]=e.dec16(e.reg16[reg_cx])},t32[73]=function(e){e.reg32s[reg_ecx]=e.dec32(e.reg32s[reg_ecx])},t16[74]=function(e){e.reg16[reg_dx]=e.dec16(e.reg16[reg_dx])},t32[74]=function(e){e.reg32s[reg_edx]=e.dec32(e.reg32s[reg_edx])},t16[75]=function(e){e.reg16[reg_bx]=e.dec16(e.reg16[reg_bx])},t32[75]=function(e){e.reg32s[reg_ebx]=e.dec32(e.reg32s[reg_ebx])},t16[76]=function(e){e.reg16[reg_sp]=e.dec16(e.reg16[reg_sp])},t32[76]=function(e){e.reg32s[reg_esp]=e.dec32(e.reg32s[reg_esp])},t16[77]=function(e){e.reg16[reg_bp]=e.dec16(e.reg16[reg_bp])},t32[77]=function(e){e.reg32s[reg_ebp]=e.dec32(e.reg32s[reg_ebp])},t16[78]=function(e){e.reg16[reg_si]=e.dec16(e.reg16[reg_si])},t32[78]=function(e){e.reg32s[reg_esi]=e.dec32(e.reg32s[reg_esi])},t16[79]=function(e){e.reg16[reg_di]=e.dec16(e.reg16[reg_di])},t32[79]=function(e){e.reg32s[reg_edi]=e.dec32(e.reg32s[reg_edi])},t16[80]=function(e){e.push16(e.reg16[reg_ax])},t32[80]=function(e){e.push32(e.reg32s[reg_eax])},t16[81]=function(e){e.push16(e.reg16[reg_cx])},t32[81]=function(e){e.push32(e.reg32s[reg_ecx])},t16[82]=function(e){e.push16(e.reg16[reg_dx])},t32[82]=function(e){e.push32(e.reg32s[reg_edx])},t16[83]=function(e){e.push16(e.reg16[reg_bx])},t32[83]=function(e){e.push32(e.reg32s[reg_ebx])},t16[84]=function(e){e.push16(e.reg16[reg_sp])},t32[84]=function(e){e.push32(e.reg32s[reg_esp])},t16[85]=function(e){e.push16(e.reg16[reg_bp])},t32[85]=function(e){e.push32(e.reg32s[reg_ebp])},t16[86]=function(e){e.push16(e.reg16[reg_si])},t32[86]=function(e){e.push32(e.reg32s[reg_esi])},t16[87]=function(e){e.push16(e.reg16[reg_di])},t32[87]=function(e){e.push32(e.reg32s[reg_edi])},t16[88]=function(e){e.reg16[reg_ax]=e.pop16()},t32[88]=function(e){e.reg32s[reg_eax]=e.pop32s()},t16[89]=function(e){e.reg16[reg_cx]=e.pop16()},t32[89]=function(e){e.reg32s[reg_ecx]=e.pop32s()},t16[90]=function(e){e.reg16[reg_dx]=e.pop16()},t32[90]=function(e){e.reg32s[reg_edx]=e.pop32s()},t16[91]=function(e){e.reg16[reg_bx]=e.pop16()},t32[91]=function(e){e.reg32s[reg_ebx]=e.pop32s()},t16[92]=function(e){e.reg16[reg_sp]=e.pop16()},t32[92]=function(e){e.reg32s[reg_esp]=e.pop32s()},t16[93]=function(e){e.reg16[reg_bp]=e.pop16()},t32[93]=function(e){e.reg32s[reg_ebp]=e.pop32s()},t16[94]=function(e){e.reg16[reg_si]=e.pop16()},t32[94]=function(e){e.reg32s[reg_esi]=e.pop32s()},t16[95]=function(e){e.reg16[reg_di]=e.pop16()},t32[95]=function(e){e.reg32s[reg_edi]=e.pop32s()},t16[96]=function(e){e.pusha16()},t32[96]=function(e){e.pusha32()},t16[97]=function(e){e.popa16()},t32[97]=function(e){e.popa32()},t[98]=function(e){dbg_log("Unimplemented BOUND instruction",LOG_CPU),dbg_assert(!1)},t[99]=function(e){e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()?e.write_e16(e.arpl(e.read_write_e16(),e.modrm_byte>>2&14)):(dbg_log("arpl #ud",LOG_CPU),e.trigger_ud())},t[100]=function(e){e.segment_prefix_op(reg_fs)},t[101]=function(e){e.segment_prefix_op(reg_gs)},t[102]=function(e){e.prefixes|=PREFIX_MASK_OPSIZE,e.run_prefix_instruction(),e.prefixes=0},t[103]=function(e){dbg_assert(e.is_asize_32()===e.is_32),e.prefixes|=PREFIX_MASK_ADDRSIZE,e.run_prefix_instruction(),e.prefixes=0},t16[104]=function(e){e.push16(e.read_op16())},t32[104]=function(e){e.push32(e.read_op32s())},t16[105]=function(e){e.read_modrm_byte(),e.write_g16(e.imul_reg16(e.read_e16s(),e.read_op16()<<16>>16))},t32[105]=function(e){e.read_modrm_byte(),e.write_g32(e.imul_reg32(e.read_e32s(),e.read_op32s()))},t16[106]=function(e){e.push16(e.read_op8s())},t32[106]=function(e){e.push32(e.read_op8s())},t16[107]=function(e){e.read_modrm_byte(),e.write_g16(e.imul_reg16(e.read_e16s(),e.read_op8s()))},t32[107]=function(e){e.read_modrm_byte(),e.write_g32(e.imul_reg32(e.read_e32s(),e.read_op8s()))},t[108]=function(e){insb(e)},t16[109]=function(e){insw(e)},t32[109]=function(e){insd(e)},t[110]=function(e){outsb(e)},t16[111]=function(e){outsw(e)},t32[111]=function(e){outsd(e)},t[112]=function(e){e.jmpcc8(e.test_o())},t[113]=function(e){e.jmpcc8(!e.test_o())},t[114]=function(e){e.jmpcc8(e.test_b())},t[115]=function(e){e.jmpcc8(!e.test_b())},t[116]=function(e){e.jmpcc8(e.test_z())},t[117]=function(e){e.jmpcc8(!e.test_z())},t[118]=function(e){e.jmpcc8(e.test_be())},t[119]=function(e){e.jmpcc8(!e.test_be())},t[120]=function(e){e.jmpcc8(e.test_s())},t[121]=function(e){e.jmpcc8(!e.test_s())},t[122]=function(e){e.jmpcc8(e.test_p())},t[123]=function(e){e.jmpcc8(!e.test_p())},t[124]=function(e){e.jmpcc8(e.test_l())},t[125]=function(e){e.jmpcc8(!e.test_l())},t[126]=function(e){e.jmpcc8(e.test_le())},t[127]=function(e){e.jmpcc8(!e.test_le())},t[128]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:e.write_e8(e.add8(e.read_write_e8(),e.read_op8()));break;case 1:e.write_e8(e.or8(e.read_write_e8(),e.read_op8()));break;case 2:e.write_e8(e.adc8(e.read_write_e8(),e.read_op8()));break;case 3:e.write_e8(e.sbb8(e.read_write_e8(),e.read_op8()));break;case 4:e.write_e8(e.and8(e.read_write_e8(),e.read_op8()));break;case 5:e.write_e8(e.sub8(e.read_write_e8(),e.read_op8()));break;case 6:e.write_e8(e.xor8(e.read_write_e8(),e.read_op8()));break;case 7:e.cmp8(e.read_e8(),e.read_op8())}},t16[129]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:e.write_e16(e.add16(e.read_write_e16(),e.read_op16()));break;case 1:e.write_e16(e.or16(e.read_write_e16(),e.read_op16()));break;case 2:e.write_e16(e.adc16(e.read_write_e16(),e.read_op16()));break;case 3:e.write_e16(e.sbb16(e.read_write_e16(),e.read_op16()));break;case 4:e.write_e16(e.and16(e.read_write_e16(),e.read_op16()));break;case 5:e.write_e16(e.sub16(e.read_write_e16(),e.read_op16()));break;case 6:e.write_e16(e.xor16(e.read_write_e16(),e.read_op16()));break;case 7:e.cmp16(e.read_e16(),e.read_op16())}},t32[129]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:e.write_e32(e.add32(e.read_write_e32(),e.read_op32s()));break;case 1:e.write_e32(e.or32(e.read_write_e32(),e.read_op32s()));break;case 2:e.write_e32(e.adc32(e.read_write_e32(),e.read_op32s()));break;case 3:e.write_e32(e.sbb32(e.read_write_e32(),e.read_op32s()));break;case 4:e.write_e32(e.and32(e.read_write_e32(),e.read_op32s()));break;case 5:e.write_e32(e.sub32(e.read_write_e32(),e.read_op32s()));break;case 6:e.write_e32(e.xor32(e.read_write_e32(),e.read_op32s()));break;case 7:e.cmp32(e.read_e32s(),e.read_op32s())}},t[130]=t[128],t16[131]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:e.write_e16(e.add16(e.read_write_e16(),e.read_op8s()));break;case 1:e.write_e16(e.or16(e.read_write_e16(),e.read_op8s()));break;case 2:e.write_e16(e.adc16(e.read_write_e16(),e.read_op8s()));break;case 3:e.write_e16(e.sbb16(e.read_write_e16(),e.read_op8s()));break;case 4:e.write_e16(e.and16(e.read_write_e16(),e.read_op8s()));break;case 5:e.write_e16(e.sub16(e.read_write_e16(),e.read_op8s()));break;case 6:e.write_e16(e.xor16(e.read_write_e16(),e.read_op8s()));break;case 7:e.cmp16(e.read_e16(),e.read_op8s())}},t32[131]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:e.write_e32(e.add32(e.read_write_e32(),e.read_op8s()));break;case 1:e.write_e32(e.or32(e.read_write_e32(),e.read_op8s()));break;case 2:e.write_e32(e.adc32(e.read_write_e32(),e.read_op8s()));break;case 3:e.write_e32(e.sbb32(e.read_write_e32(),e.read_op8s()));break;case 4:e.write_e32(e.and32(e.read_write_e32(),e.read_op8s()));break;case 5:e.write_e32(e.sub32(e.read_write_e32(),e.read_op8s()));break;case 6:e.write_e32(e.xor32(e.read_write_e32(),e.read_op8s()));break;case 7:e.cmp32(e.read_e32s(),e.read_op8s())}},t[132]=function(e){e.read_modrm_byte();var t=e.read_e8();e.test8(t,e.read_g8())},t16[133]=function(e){e.read_modrm_byte();var t=e.read_e16();e.test16(t,e.read_g16())},t32[133]=function(e){e.read_modrm_byte();var t=e.read_e32s();e.test32(t,e.read_g32s())},t[134]=function(e){e.read_modrm_byte();var t=e.read_write_e8();e.write_e8(e.xchg8(t,e.modrm_byte))},t16[135]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.xchg16(t,e.modrm_byte))},t32[135]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.xchg32(t,e.modrm_byte))},t[136]=function(e){e.read_modrm_byte(),e.set_e8(e.read_g8())},t16[137]=function(e){e.read_modrm_byte(),e.set_e16(e.read_g16())},t32[137]=function(e){e.read_modrm_byte(),e.set_e32(e.read_g32s())},t[138]=function(e){e.read_modrm_byte();var t=e.read_e8();e.write_g8(t)},t16[139]=function(e){e.read_modrm_byte();var t=e.read_e16();e.write_g16(t)},t32[139]=function(e){e.read_modrm_byte();var t=e.read_e32s();e.write_g32(t)},t16[140]=function(e){e.read_modrm_byte(),e.set_e16(e.sreg[e.modrm_byte>>3&7])},t32[140]=function(e){e.read_modrm_byte(),e.set_e32(e.sreg[e.modrm_byte>>3&7])},t16[141]=function(e){e.read_modrm_byte(),192<=e.modrm_byte&&(dbg_log("lea #ud",LOG_CPU),e.trigger_ud());var t=e.modrm_byte>>3&7;e.prefixes|=SEG_PREFIX_ZERO,e.reg16[t<<1]=e.modrm_resolve(e.modrm_byte),e.prefixes=0},t32[141]=function(e){e.read_modrm_byte(),192<=e.modrm_byte&&(dbg_log("lea #ud",LOG_CPU),e.trigger_ud());var t=e.modrm_byte>>3&7;e.prefixes|=SEG_PREFIX_ZERO,e.reg32s[t]=e.modrm_resolve(e.modrm_byte),e.prefixes=0},t[142]=function(e){e.read_modrm_byte();var t=e.modrm_byte>>3&7,r=e.read_e16();e.switch_seg(t,r),t===reg_ss&&(e.clear_prefixes(),e.cycle_internal())},t16[143]=function(e){e.read_modrm_byte();var t=e.safe_read16(e.get_stack_pointer(0));if(e.adjust_stack_reg(2),192>e.modrm_byte){var r=e.modrm_resolve(e.modrm_byte);e.adjust_stack_reg(-2),e.safe_write16(r,t),e.adjust_stack_reg(2)}else e.write_reg_e16(t)},t32[143]=function(e){e.read_modrm_byte();var t=e.safe_read32s(e.get_stack_pointer(0));if(e.adjust_stack_reg(4),192>e.modrm_byte){var r=e.modrm_resolve(e.modrm_byte);e.adjust_stack_reg(-4),e.safe_write32(r,t),e.adjust_stack_reg(4)}else e.write_reg_e32(t)},t[144]=function(e){},t16[145]=function(e){e.xchg16r(reg_cx)},t32[145]=function(e){e.xchg32r(reg_ecx)},t16[146]=function(e){e.xchg16r(reg_dx)},t32[146]=function(e){e.xchg32r(reg_edx)},t16[147]=function(e){e.xchg16r(reg_bx)},t32[147]=function(e){e.xchg32r(reg_ebx)},t16[148]=function(e){e.xchg16r(reg_sp)},t32[148]=function(e){e.xchg32r(reg_esp)},t16[149]=function(e){e.xchg16r(reg_bp)},t32[149]=function(e){e.xchg32r(reg_ebp)},t16[150]=function(e){e.xchg16r(reg_si)},t32[150]=function(e){e.xchg32r(reg_esi)},t16[151]=function(e){e.xchg16r(reg_di)},t32[151]=function(e){e.xchg32r(reg_edi)},t16[152]=function(e){e.reg16[reg_ax]=e.reg8s[reg_al]},t32[152]=function(e){e.reg32s[reg_eax]=e.reg16s[reg_ax]},t16[153]=function(e){e.reg16[reg_dx]=e.reg16s[reg_ax]>>15},t32[153]=function(e){e.reg32s[reg_edx]=e.reg32s[reg_eax]>>31},t16[154]=function(e){var t=e.read_op16(),r=e.read_disp16();e.far_jump(t,r,!0),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t32[154]=function(e){var t=e.read_op32s(),r=e.read_disp16();if((!e.protected_mode||e.vm86_mode())&&4294901760&t)throw e.debug.unimpl("#GP handler");e.far_jump(t,r,!0),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t[155]=function(e){(e.cr[0]&(CR0_MP|CR0_TS))==(CR0_MP|CR0_TS)?e.trigger_nm():e.fpu&&e.fpu.fwait()},t16[156]=function(e){e.flags&flag_vm&&3>e.getiopl()?(dbg_assert(e.protected_mode),dbg_log("pushf #gp",LOG_CPU),e.trigger_gp(0)):e.push16(e.get_eflags())},t32[156]=function(e){e.flags&flag_vm&&3>e.getiopl()?(dbg_assert(e.protected_mode),dbg_log("pushf #gp",LOG_CPU),e.trigger_gp(0)):e.push32(16580607&e.get_eflags())},t16[157]=function(e){e.flags&flag_vm&&3>e.getiopl()&&(dbg_log("popf #gp",LOG_CPU),e.trigger_gp(0)),e.update_eflags(-65536&e.flags|e.pop16()),e.flags&flag_trap?e.flags&=~flag_trap:e.handle_irqs()},t32[157]=function(e){e.flags&flag_vm&&3>e.getiopl()&&(dbg_log("popf #gp",LOG_CPU),e.trigger_gp(0)),e.update_eflags(e.pop32s()),e.handle_irqs()},t[158]=function(e){e.flags=-256&e.flags|e.reg8[reg_ah],e.flags=e.flags&flags_mask|flags_default,e.flags_changed=0},t[159]=function(e){e.reg8[reg_ah]=e.get_eflags()},t[160]=function(e){var t=e.safe_read8(e.read_moffs());e.reg8[reg_al]=t},t16[161]=function(e){var t=e.safe_read16(e.read_moffs());e.reg16[reg_ax]=t},t32[161]=function(e){var t=e.safe_read32s(e.read_moffs());e.reg32s[reg_eax]=t},t[162]=function(e){e.safe_write8(e.read_moffs(),e.reg8[reg_al])},t16[163]=function(e){e.safe_write16(e.read_moffs(),e.reg16[reg_ax])},t32[163]=function(e){e.safe_write32(e.read_moffs(),e.reg32s[reg_eax])},t[164]=function(e){e.movsb()},t16[165]=function(e){e.movsw()},t32[165]=function(e){e.movsd()},t[166]=function(e){cmpsb(e)},t16[167]=function(e){cmpsw(e)},t32[167]=function(e){cmpsd(e)},t[168]=function(e){e.test8(e.reg8[reg_al],e.read_op8())},t16[169]=function(e){e.test16(e.reg16[reg_ax],e.read_op16())},t32[169]=function(e){e.test32(e.reg32s[reg_eax],e.read_op32s())},t[170]=function(e){stosb(e)},t16[171]=function(e){stosw(e)},t32[171]=function(e){stosd(e)},t[172]=function(e){lodsb(e)},t16[173]=function(e){lodsw(e)},t32[173]=function(e){lodsd(e)},t[174]=function(e){scasb(e)},t16[175]=function(e){scasw(e)},t32[175]=function(e){scasd(e)},t[176]=function(e){e.reg8[reg_al]=e.read_op8()},t[177]=function(e){e.reg8[reg_cl]=e.read_op8()},t[178]=function(e){e.reg8[reg_dl]=e.read_op8()},t[179]=function(e){e.reg8[reg_bl]=e.read_op8()},t[180]=function(e){e.reg8[reg_ah]=e.read_op8()},t[181]=function(e){e.reg8[reg_ch]=e.read_op8()},t[182]=function(e){e.reg8[reg_dh]=e.read_op8()},t[183]=function(e){e.reg8[reg_bh]=e.read_op8()},t16[184]=function(e){e.reg16[reg_ax]=e.read_op16()},t32[184]=function(e){e.reg32s[reg_eax]=e.read_op32s()},t16[185]=function(e){e.reg16[reg_cx]=e.read_op16()},t32[185]=function(e){e.reg32s[reg_ecx]=e.read_op32s()},t16[186]=function(e){e.reg16[reg_dx]=e.read_op16()},t32[186]=function(e){e.reg32s[reg_edx]=e.read_op32s()},t16[187]=function(e){e.reg16[reg_bx]=e.read_op16()},t32[187]=function(e){e.reg32s[reg_ebx]=e.read_op32s()},t16[188]=function(e){e.reg16[reg_sp]=e.read_op16()},t32[188]=function(e){e.reg32s[reg_esp]=e.read_op32s()},t16[189]=function(e){e.reg16[reg_bp]=e.read_op16()},t32[189]=function(e){e.reg32s[reg_ebp]=e.read_op32s()},t16[190]=function(e){e.reg16[reg_si]=e.read_op16()},t32[190]=function(e){e.reg32s[reg_esi]=e.read_op32s()},t16[191]=function(e){e.reg16[reg_di]=e.read_op16()},t32[191]=function(e){e.reg32s[reg_edi]=e.read_op32s()},t[192]=function(e){e.read_modrm_byte();var t=e.read_write_e8(),r=31&e.read_op8(),s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol8(t,r);break;case 1:s=e.ror8(t,r);break;case 2:s=e.rcl8(t,r);break;case 3:s=e.rcr8(t,r);break;case 4:s=e.shl8(t,r);break;case 5:s=e.shr8(t,r);break;case 6:s=e.shl8(t,r);break;case 7:s=e.sar8(t,r)}e.write_e8(s)},t16[193]=function(e){e.read_modrm_byte();var t=e.read_write_e16(),r=31&e.read_op8(),s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol16(t,r);break;case 1:s=e.ror16(t,r);break;case 2:s=e.rcl16(t,r);break;case 3:s=e.rcr16(t,r);break;case 4:s=e.shl16(t,r);break;case 5:s=e.shr16(t,r);break;case 6:s=e.shl16(t,r);break;case 7:s=e.sar16(t,r)}e.write_e16(s)},t32[193]=function(e){e.read_modrm_byte();var t=e.read_write_e32(),r=31&e.read_op8(),s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol32(t,r);break;case 1:s=e.ror32(t,r);break;case 2:s=e.rcl32(t,r);break;case 3:s=e.rcr32(t,r);break;case 4:s=e.shl32(t,r);break;case 5:s=e.shr32(t,r);break;case 6:s=e.shl32(t,r);break;case 7:s=e.sar32(t,r)}e.write_e32(s)},t16[194]=function(e){var t=e.read_op16();e.instruction_pointer=e.get_seg(reg_cs)+e.pop16()|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.adjust_stack_reg(t),e.diverged()},t32[194]=function(e){var t=e.read_op16(),r=e.pop32s();dbg_assert(e.is_asize_32()||65536>r),e.instruction_pointer=e.get_seg(reg_cs)+r|0,e.adjust_stack_reg(t),e.diverged()},t16[195]=function(e){e.instruction_pointer=e.get_seg(reg_cs)+e.pop16()|0,e.diverged()},t32[195]=function(e){var t=e.pop32s();dbg_assert(e.is_asize_32()||65536>t),e.instruction_pointer=e.get_seg(reg_cs)+t|0,e.diverged()},t16[196]=function(e){e.read_modrm_byte(),e.lss16(reg_es)},t32[196]=function(e){e.read_modrm_byte(),e.lss32(reg_es)},t16[197]=function(e){e.read_modrm_byte(),e.lss16(reg_ds)},t32[197]=function(e){e.read_modrm_byte(),e.lss32(reg_ds)},t[198]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.safe_write8(e.modrm_resolve(e.modrm_byte),e.read_op8()):e.reg8[e.modrm_byte<<2&12|e.modrm_byte>>2&1]=e.read_op8()},t16[199]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.safe_write16(e.modrm_resolve(e.modrm_byte),e.read_op16()):e.reg16[e.modrm_byte<<1&14]=e.read_op16()},t32[199]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.safe_write32(e.modrm_resolve(e.modrm_byte),e.read_op32s()):e.reg32s[7&e.modrm_byte]=e.read_op32s()},t16[200]=function(e){e.enter16(e.read_op16(),e.read_disp8())},t32[200]=function(e){e.enter32(e.read_op16(),e.read_disp8())},t16[201]=function(e){var t=e.stack_size_32?e.reg32s[reg_ebp]:e.reg16[reg_bp],r=e.safe_read16(e.get_seg(reg_ss)+t|0);e.set_stack_reg(t+2|0),e.reg16[reg_bp]=r},t32[201]=function(e){var t=e.stack_size_32?e.reg32s[reg_ebp]:e.reg16[reg_bp],r=e.safe_read32s(e.get_seg(reg_ss)+t|0);e.set_stack_reg(t+4|0),e.reg32s[reg_ebp]=r},t16[202]=function(e){var t=e.read_op16(),r=e.safe_read16(e.get_stack_pointer(0)),s=e.safe_read16(e.get_stack_pointer(2));e.far_return(r,s,t),e.diverged()},t32[202]=function(e){var t=e.read_op16(),r=e.safe_read32s(e.get_stack_pointer(0)),s=65535&e.safe_read32s(e.get_stack_pointer(4));e.far_return(r,s,t),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t16[203]=function(e){var t=e.safe_read16(e.get_stack_pointer(0)),r=e.safe_read16(e.get_stack_pointer(2));e.far_return(t,r,0),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t32[203]=function(e){var t=e.safe_read32s(e.get_stack_pointer(0)),r=65535&e.safe_read32s(e.get_stack_pointer(4));e.far_return(t,r,0),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t[204]=function(e){dbg_log("INT3",LOG_CPU),e.call_interrupt_vector(3,!0,!1),e.diverged()},t[205]=function(e){var t=e.read_op8();e.call_interrupt_vector(t,!0,!1),e.diverged()},t[206]=function(e){dbg_log("INTO",LOG_CPU),e.getof()&&e.call_interrupt_vector(4,!0,!1),e.diverged()},t16[207]=function(e){e.iret16(),e.diverged()},t32[207]=function(e){e.iret32(),e.diverged()},t[208]=function(e){e.read_modrm_byte();var t=e.read_write_e8(),r=0;switch(e.modrm_byte>>3&7){case 0:r=e.rol8(t,1);break;case 1:r=e.ror8(t,1);break;case 2:r=e.rcl8(t,1);break;case 3:r=e.rcr8(t,1);break;case 4:r=e.shl8(t,1);break;case 5:r=e.shr8(t,1);break;case 6:r=e.shl8(t,1);break;case 7:r=e.sar8(t,1)}e.write_e8(r)},t16[209]=function(e){e.read_modrm_byte();var t=e.read_write_e16(),r=0;switch(e.modrm_byte>>3&7){case 0:r=e.rol16(t,1);break;case 1:r=e.ror16(t,1);break;case 2:r=e.rcl16(t,1);break;case 3:r=e.rcr16(t,1);break;case 4:r=e.shl16(t,1);break;case 5:r=e.shr16(t,1);break;case 6:r=e.shl16(t,1);break;case 7:r=e.sar16(t,1)}e.write_e16(r)},t32[209]=function(e){e.read_modrm_byte();var t=e.read_write_e32(),r=0;switch(e.modrm_byte>>3&7){case 0:r=e.rol32(t,1);break;case 1:r=e.ror32(t,1);break;case 2:r=e.rcl32(t,1);break;case 3:r=e.rcr32(t,1);break;case 4:r=e.shl32(t,1);break;case 5:r=e.shr32(t,1);break;case 6:r=e.shl32(t,1);break;case 7:r=e.sar32(t,1)}e.write_e32(r)},t[210]=function(e){e.read_modrm_byte();var t=e.read_write_e8(),r=31&e.reg8[reg_cl],s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol8(t,r);break;case 1:s=e.ror8(t,r);break;case 2:s=e.rcl8(t,r);break;case 3:s=e.rcr8(t,r);break;case 4:s=e.shl8(t,r);break;case 5:s=e.shr8(t,r);break;case 6:s=e.shl8(t,r);break;case 7:s=e.sar8(t,r)}e.write_e8(s)},t16[211]=function(e){e.read_modrm_byte();var t=e.read_write_e16(),r=31&e.reg8[reg_cl],s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol16(t,r);break;case 1:s=e.ror16(t,r);break;case 2:s=e.rcl16(t,r);break;case 3:s=e.rcr16(t,r);break;case 4:s=e.shl16(t,r);break;case 5:s=e.shr16(t,r);break;case 6:s=e.shl16(t,r);break;case 7:s=e.sar16(t,r)}e.write_e16(s)},t32[211]=function(e){e.read_modrm_byte();var t=e.read_write_e32(),r=31&e.reg8[reg_cl],s=0;switch(e.modrm_byte>>3&7){case 0:s=e.rol32(t,r);break;case 1:s=e.ror32(t,r);break;case 2:s=e.rcl32(t,r);break;case 3:s=e.rcr32(t,r);break;case 4:s=e.shl32(t,r);break;case 5:s=e.shr32(t,r);break;case 6:s=e.shl32(t,r);break;case 7:s=e.sar32(t,r)}e.write_e32(s)},t[212]=function(e){e.bcd_aam(e.read_op8())},t[213]=function(e){e.bcd_aad(e.read_op8())},t[214]=function(e){e.reg8[reg_al]=-e.getcf()},t[215]=function(e){e.is_asize_32()?e.reg8[reg_al]=e.safe_read8(e.get_seg_prefix(reg_ds)+e.reg32s[reg_ebx]+e.reg8[reg_al]|0):e.reg8[reg_al]=e.safe_read8(e.get_seg_prefix(reg_ds)+(e.reg16[reg_bx]+e.reg8[reg_al]&65535)|0)},t[216]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_D8_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_D8_reg(e.modrm_byte)},t[217]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_D9_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_D9_reg(e.modrm_byte)},t[218]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DA_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DA_reg(e.modrm_byte)},t[219]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DB_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DB_reg(e.modrm_byte)},t[220]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DC_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DC_reg(e.modrm_byte)},t[221]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DD_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DD_reg(e.modrm_byte)},t[222]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DE_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DE_reg(e.modrm_byte)},t[223]=function(e){e.read_modrm_byte(),e.task_switch_test(),192>e.modrm_byte?e.fpu.op_DF_mem(e.modrm_byte,e.modrm_resolve(e.modrm_byte)):e.fpu.op_DF_reg(e.modrm_byte)},t[224]=function(e){e.loopne(e.read_op8s())},t[225]=function(e){e.loope(e.read_op8s())},t[226]=function(e){e.loop(e.read_op8s())},t[227]=function(e){e.jcxz(e.read_op8s())},t[228]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,1),e.reg8[reg_al]=e.io.port_read8(t),e.diverged()},t16[229]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,2),e.reg16[reg_ax]=e.io.port_read16(t),e.diverged()},t32[229]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,4),e.reg32s[reg_eax]=e.io.port_read32(t),e.diverged()},t[230]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,1),e.io.port_write8(t,e.reg8[reg_al]),e.diverged()},t16[231]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,2),e.io.port_write16(t,e.reg16[reg_ax]),e.diverged()},t32[231]=function(e){var t=e.read_op8();e.test_privileges_for_io(t,4),e.io.port_write32(t,e.reg32s[reg_eax]),e.diverged()},t16[232]=function(e){var t=e.read_op16();e.push16(e.get_real_eip()),e.jmp_rel16(t),e.diverged()},t32[232]=function(e){var t=e.read_op32s();e.push32(e.get_real_eip()),e.instruction_pointer=e.instruction_pointer+t|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t16[233]=function(e){var t=e.read_op16();e.jmp_rel16(t),e.diverged()},t32[233]=function(e){var t=e.read_op32s();e.instruction_pointer=e.instruction_pointer+t|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t16[234]=function(e){var t=e.read_op16(),r=e.read_disp16();e.far_jump(t,r,!1),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t32[234]=function(e){var t=e.read_op32s(),r=e.read_disp16();e.far_jump(t,r,!1),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t[235]=function(e){var t=e.read_op8s();e.instruction_pointer=e.instruction_pointer+t|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged()},t[236]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,1),e.reg8[reg_al]=e.io.port_read8(t),e.diverged()},t16[237]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,2),e.reg16[reg_ax]=e.io.port_read16(t),e.diverged()},t32[237]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,4),e.reg32s[reg_eax]=e.io.port_read32(t),e.diverged()},t[238]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,1),e.io.port_write8(t,e.reg8[reg_al]),e.diverged()},t16[239]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,2),e.io.port_write16(t,e.reg16[reg_ax]),e.diverged()},t32[239]=function(e){var t=e.reg16[reg_dx];e.test_privileges_for_io(t,4),e.io.port_write32(t,e.reg32s[reg_eax]),e.diverged()},t[240]=function(e){e.run_prefix_instruction()},t[241]=function(e){throw e.debug.unimpl("int1 instruction")},t[242]=function(e){dbg_assert(0==(e.prefixes&PREFIX_MASK_REP)),e.prefixes|=PREFIX_REPNZ,e.run_prefix_instruction(),e.prefixes=0},t[243]=function(e){dbg_assert(0==(e.prefixes&PREFIX_MASK_REP)),e.prefixes|=PREFIX_REPZ,e.run_prefix_instruction(),e.prefixes=0},t[244]=function(e){e.hlt_op()},t[245]=function(e){e.flags=(1|e.flags)^e.getcf(),e.flags_changed&=-2},t[246]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:var t=e.read_e8();e.test8(t,e.read_op8());break;case 1:t=e.read_e8(),e.test8(t,e.read_op8());break;case 2:t=e.read_write_e8(),e.write_e8(~t);break;case 3:t=e.read_write_e8(),e.write_e8(e.neg8(t));break;case 4:t=e.read_e8(),e.mul8(t);break;case 5:t=e.read_e8s(),e.imul8(t);break;case 6:t=e.read_e8(),e.div8(t);break;case 7:t=e.read_e8s(),e.idiv8(t)}},t16[247]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:var t=e.read_e16();e.test16(t,e.read_op16());break;case 1:t=e.read_e16(),e.test16(t,e.read_op16());break;case 2:t=e.read_write_e16(),e.write_e16(~t);break;case 3:t=e.read_write_e16(),e.write_e16(e.neg16(t));break;case 4:t=e.read_e16(),e.mul16(t);break;case 5:t=e.read_e16s(),e.imul16(t);break;case 6:t=e.read_e16(),e.div16(t);break;case 7:t=e.read_e16s(),e.idiv16(t)}},t32[247]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:var t=e.read_e32s();e.test32(t,e.read_op32s());break;case 1:t=e.read_e32s(),e.test32(t,e.read_op32s());break;case 2:t=e.read_write_e32(),e.write_e32(~t);break;case 3:t=e.read_write_e32(),e.write_e32(e.neg32(t));break;case 4:t=e.read_e32(),e.mul32(t);break;case 5:t=e.read_e32s(),e.imul32(t);break;case 6:t=e.read_e32(),e.div32(t);break;case 7:t=e.read_e32s(),e.idiv32(t)}},t[248]=function(e){e.flags&=~flag_carry,e.flags_changed&=-2},t[249]=function(e){e.flags|=flag_carry,e.flags_changed&=-2},t[250]=function(e){!e.protected_mode||(e.flags&flag_vm?3===e.getiopl():e.getiopl()>=e.cpl)?e.flags&=~flag_interrupt:(dbg_log("cli #gp",LOG_CPU),e.trigger_gp(0))},t[251]=function(e){!e.protected_mode||(e.flags&flag_vm?3===e.getiopl():e.getiopl()>=e.cpl)?(e.flags|=flag_interrupt,e.clear_prefixes(),e.cycle_internal(),e.handle_irqs()):(dbg_log("sti #gp",LOG_CPU),e.trigger_gp(0))},t[252]=function(e){e.flags&=~flag_direction},t[253]=function(e){e.flags|=flag_direction},t[254]=function(e){e.read_modrm_byte();var t=56&e.modrm_byte;0===t?(t=e.read_write_e8(),e.write_e8(e.inc8(t))):8===t?(t=e.read_write_e8(),e.write_e8(e.dec8(t))):e.todo()},t16[255]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:var t=e.read_write_e16();e.write_e16(e.inc16(t));break;case 1:t=e.read_write_e16(),e.write_e16(e.dec16(t));break;case 2:t=e.read_e16(),e.push16(e.get_real_eip()),e.instruction_pointer=e.get_seg(reg_cs)+t|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged();break;case 3:192<=e.modrm_byte&&(dbg_log("callf #ud",LOG_CPU),e.trigger_ud(),dbg_assert(!1,"unreachable"));var r=e.modrm_resolve(e.modrm_byte);t=e.safe_read16(r),r=e.safe_read16(r+2|0),e.far_jump(t,r,!0),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged();break;case 4:t=e.read_e16(),e.instruction_pointer=e.get_seg(reg_cs)+t|0,dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged();break;case 5:192<=e.modrm_byte&&(dbg_log("jmpf #ud",LOG_CPU),e.trigger_ud(),dbg_assert(!1,"unreachable")),r=e.modrm_resolve(e.modrm_byte),t=e.safe_read16(r),r=e.safe_read16(r+2|0),e.far_jump(t,r,!1),dbg_assert(e.is_asize_32()||65536>e.get_real_eip()),e.diverged();break;case 6:t=e.read_e16(),e.push16(t);break;case 7:e.todo()}},t32[255]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 0:var t=e.read_write_e32();e.write_e32(e.inc32(t));break;case 1:t=e.read_write_e32(),e.write_e32(e.dec32(t));break;case 2:t=e.read_e32s(),e.push32(e.get_real_eip()),dbg_assert(e.is_asize_32()||65536>t),e.instruction_pointer=e.get_seg(reg_cs)+t|0,e.diverged();break;case 3:192<=e.modrm_byte&&(dbg_log("callf #ud",LOG_CPU),e.trigger_ud(),dbg_assert(!1,"unreachable"));var r=e.modrm_resolve(e.modrm_byte);if(t=e.safe_read32s(r),r=e.safe_read16(r+4|0),(!e.protected_mode||e.vm86_mode())&&4294901760&t)throw e.debug.unimpl("#GP handler");e.far_jump(t,r,!0),dbg_assert(e.is_asize_32()||65536>t),e.diverged();break;case 4:t=e.read_e32s(),dbg_assert(e.is_asize_32()||65536>t),e.instruction_pointer=e.get_seg(reg_cs)+t|0,e.diverged();break;case 5:if(192<=e.modrm_byte&&(dbg_log("jmpf #ud",LOG_CPU),e.trigger_ud(),dbg_assert(!1,"unreachable")),r=e.modrm_resolve(e.modrm_byte),t=e.safe_read32s(r),r=e.safe_read16(r+4|0),(!e.protected_mode||e.vm86_mode())&&4294901760&t)throw e.debug.unimpl("#GP handler");e.far_jump(t,r,!1),dbg_assert(e.is_asize_32()||65536>t),e.diverged();break;case 6:t=e.read_e32s(),e.push32(t);break;case 7:e.todo()}};var table16=[],table32=[];CPU.prototype.table16=table16,CPU.prototype.table32=table32;for(var i=0;256>i;i++)t[i]?table16[i]=table32[i]=t[i]:t16[i]&&(table16[i]=t16[i],table32[i]=t32[i]);t=[],t16=[],t32=[],t[0]=function(e){switch(e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()||(dbg_log("0f 00 #ud",LOG_CPU),e.trigger_ud()),e.modrm_byte>>3&7){case 0:e.set_e16(e.sreg[reg_ldtr]),e.is_osize_32()&&192<=e.modrm_byte&&(e.reg32s[7&e.modrm_byte]&=65535);break;case 1:e.set_e16(e.sreg[reg_tr]),e.is_osize_32()&&192<=e.modrm_byte&&(e.reg32s[7&e.modrm_byte]&=65535);break;case 2:e.cpl&&e.trigger_gp(0);var t=e.read_e16();e.load_ldt(t);break;case 3:e.cpl&&e.trigger_gp(0),t=e.read_e16(),e.load_tr(t);break;case 4:e.verr(e.read_e16());break;case 5:e.verw(e.read_e16());break;default:dbg_log(e.modrm_byte>>3&7,LOG_CPU),e.todo()}},t[1]=function(e){e.read_modrm_byte();var t=e.modrm_byte>>3&7;if(4===t)192<=e.modrm_byte&&e.is_osize_32()?e.set_e32(e.cr[0]):e.set_e16(e.cr[0]);else if(6===t){e.cpl&&e.trigger_gp(0);var r=e.read_e16();r=-16&e.cr[0]|15&r,e.protected_mode&&(r|=CR0_PE),e.set_cr0(r)}else switch(192<=e.modrm_byte&&(dbg_log("0f 01 #ud",LOG_CPU),e.trigger_ud()),r=e.modrm_resolve(e.modrm_byte),t){case 0:e.writable_or_pagefault(r,6),e.safe_write16(r,e.gdtr_size),t=e.is_osize_32()?-1:16777215,e.safe_write32(r+2,e.gdtr_offset&t);break;case 1:e.writable_or_pagefault(r,6),e.safe_write16(r,e.idtr_size),t=e.is_osize_32()?-1:16777215,e.safe_write32(r+2,e.idtr_offset&t);break;case 2:e.cpl&&e.trigger_gp(0),t=e.safe_read16(r),r=e.safe_read32s(r+2),e.gdtr_size=t,e.gdtr_offset=r,e.is_osize_32()||(e.gdtr_offset&=16777215);break;case 3:e.cpl&&e.trigger_gp(0),t=e.safe_read16(r),r=e.safe_read32s(r+2),e.idtr_size=t,e.idtr_offset=r,e.is_osize_32()||(e.idtr_offset&=16777215);break;case 7:e.cpl&&e.trigger_gp(0),e.invlpg(r);break;default:dbg_log(t),e.todo()}},t16[2]=function(e){e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()||(dbg_log("lar #ud",LOG_CPU),e.trigger_ud());var t=e.read_e16();e.write_g16(e.lar(t,e.read_g16()))},t32[2]=function(e){e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()||(dbg_log("lar #ud",LOG_CPU),e.trigger_ud());var t=e.read_e16();e.write_g32(e.lar(t,e.read_g32s()))},t16[3]=function(e){e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()||(dbg_log("lsl #ud",LOG_CPU),e.trigger_ud());var t=e.read_e16();e.write_g16(e.lsl(t,e.read_g16()))},t32[3]=function(e){e.read_modrm_byte(),e.protected_mode&&!e.vm86_mode()||(dbg_log("lsl #ud",LOG_CPU),e.trigger_ud());var t=e.read_e16();e.write_g32(e.lsl(t,e.read_g32s()))},t[4]=function(e){e.undefined_instruction()},t[5]=function(e){e.undefined_instruction()},t[6]=function(e){e.cpl?(dbg_log("clts #gp",LOG_CPU),e.trigger_gp(0)):e.cr[0]&=~CR0_TS},t[7]=function(e){e.undefined_instruction()},t[8]=function(e){e.todo()},t[9]=function(e){e.cpl&&(dbg_log("wbinvd #gp",LOG_CPU),e.trigger_gp(0))},t[10]=function(e){e.undefined_instruction()},t[11]=function(e){e.trigger_ud()},t[12]=function(e){e.undefined_instruction()},t[13]=function(e){e.todo()},t[14]=function(e){e.undefined_instruction()},t[15]=function(e){e.undefined_instruction()},t[16]=function(e){e.unimplemented_sse()},t[17]=function(e){e.unimplemented_sse()},t[18]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm_mem64s();e.write_xmm64(t[0],t[1])},t[19]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm64s();dbg_assert(192>e.modrm_byte);var r=e.modrm_resolve(e.modrm_byte);e.safe_write64(r,t[0],t[1])},t[20]=function(e){e.unimplemented_sse()},t[21]=function(e){e.unimplemented_sse()},t[22]=function(e){e.unimplemented_sse()},t[23]=function(e){e.unimplemented_sse()},t[24]=function(e){e.read_modrm_byte(),192>e.modrm_byte&&e.modrm_resolve(e.modrm_byte)},t[25]=function(e){e.unimplemented_sse()},t[26]=function(e){e.unimplemented_sse()},t[27]=function(e){e.unimplemented_sse()},t[28]=function(e){e.unimplemented_sse()},t[29]=function(e){e.unimplemented_sse()},t[30]=function(e){e.unimplemented_sse()},t[31]=function(e){e.read_modrm_byte(),192>e.modrm_byte&&e.modrm_resolve(e.modrm_byte)},t[32]=function(e){switch(e.read_modrm_byte(),e.cpl&&e.trigger_gp(0),e.modrm_byte>>3&7){case 0:e.write_reg_e32(e.cr[0]);break;case 2:e.write_reg_e32(e.cr[2]);break;case 3:e.write_reg_e32(e.cr[3]);break;case 4:e.write_reg_e32(e.cr[4]);break;default:dbg_log(e.modrm_byte>>3&7),dbg_assert(!1),e.trigger_ud()}},t[33]=function(e){e.read_modrm_byte(),e.cpl&&e.trigger_gp(0);var t=e.modrm_byte>>3&7;e.cr[4]&CR4_DE&&(4===t||5===t)&&(dbg_log("#ud mov dreg 4/5 with cr4.DE set",LOG_CPU),e.trigger_ud()),e.reg32s[7&e.modrm_byte]=e.dreg[t]},t[34]=function(e){e.read_modrm_byte(),e.cpl&&e.trigger_gp(0);var t=e.read_reg_e32s();switch(e.modrm_byte>>3&7){case 0:e.set_cr0(t);break;case 2:e.cr[2]=t;break;case 3:dbg_assert(0==(4095&(t&=-4072)),"TODO"),e.cr[3]=t,e.clear_tlb();break;case 4:e.set_cr4(t);break;default:dbg_log(e.modrm_byte>>3&7),dbg_assert(!1),e.trigger_ud()}},t[35]=function(e){e.read_modrm_byte(),e.cpl&&e.trigger_gp(0);var t=e.modrm_byte>>3&7;e.cr[4]&CR4_DE&&(4===t||5===t)&&(dbg_log("#ud mov dreg 4/5 with cr4.DE set",LOG_CPU),e.trigger_ud()),e.dreg[t]=e.read_reg_e32s()},t[36]=function(e){e.undefined_instruction()},t[37]=function(e){e.undefined_instruction()},t[38]=function(e){e.undefined_instruction()},t[39]=function(e){e.undefined_instruction()},t[40]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm_mem128s();e.write_xmm128s(t[0],t[1],t[2],t[3])},t[41]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var t=e.read_xmm128s();dbg_assert(192>e.modrm_byte);var r=e.modrm_resolve(e.modrm_byte);e.safe_write128(r,t[0],t[1],t[2],t[3])}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_xmm128s(),dbg_assert(192>e.modrm_byte),r=e.modrm_resolve(e.modrm_byte),e.safe_write128(r,t[0],t[1],t[2],t[3])},t[42]=function(e){e.unimplemented_sse()},t[43]=function(e){e.unimplemented_sse()},t[44]=function(e){e.unimplemented_sse()},t[45]=function(e){e.unimplemented_sse()},t[46]=function(e){e.unimplemented_sse()},t[47]=function(e){e.unimplemented_sse()},t[48]=function(e){e.cpl&&e.trigger_gp(0);var t=e.reg32s[reg_ecx],r=e.reg32s[reg_eax],s=e.reg32s[reg_edx];switch(t!==IA32_SYSENTER_ESP&&dbg_log("wrmsr ecx="+h(t>>>0,8)+" data="+h(s>>>0,8)+":"+h(r>>>0,8),LOG_CPU),t){case IA32_SYSENTER_CS:e.sysenter_cs=65535&r;break;case IA32_SYSENTER_EIP:e.sysenter_eip=r;break;case IA32_SYSENTER_ESP:e.sysenter_esp=r;break;case IA32_APIC_BASE_MSR:dbg_assert(0===s,"Changing APIC address (high 32 bits) not supported"),dbg_assert((r&~(IA32_APIC_BASE_BSP|IA32_APIC_BASE_EXTD|IA32_APIC_BASE_EN))>>>0===APIC_ADDRESS,"Changing APIC address not supported"),dbg_assert(0==(r&IA32_APIC_BASE_EXTD),"x2apic not supported"),e.apic_enabled=(r&IA32_APIC_BASE_EN)===IA32_APIC_BASE_EN;break;case IA32_TIME_STAMP_COUNTER:t=(r>>>0)+4294967296*(s>>>0),e.tsc_offset=v86.microtick()-t/TSC_RATE;break;case IA32_BIOS_SIGN_ID:break;case IA32_MISC_ENABLE:dbg_log("IA32_MISC_ENABLE="+h(r>>>0,8),LOG_CPU);break;case IA32_MCG_CAP:break;case IA32_KERNEL_GS_BASE:dbg_log("GS Base written",LOG_CPU);break;default:dbg_assert(!1,"Unknown msr: "+h(t>>>0,8))}},t[49]=function(e){if(e.cpl&&e.cr[4]&CR4_TSD)e.trigger_gp(0);else{var t=v86.microtick()-e.tsc_offset;dbg_assert(isFinite(t),"non-finite tsc: "+t),e.reg32s[reg_eax]=t*TSC_RATE,e.reg32s[reg_edx]=TSC_RATE/4294967296*t}},t[50]=function(e){e.cpl&&e.trigger_gp(0);var t=e.reg32s[reg_ecx];dbg_log("rdmsr ecx="+h(t>>>0,8),LOG_CPU);var r=0,s=0;switch(t){case IA32_SYSENTER_CS:r=e.sysenter_cs;break;case IA32_SYSENTER_EIP:r=e.sysenter_eip;break;case IA32_SYSENTER_ESP:r=e.sysenter_esp;break;case IA32_TIME_STAMP_COUNTER:r=(t=v86.microtick()-e.tsc_offset)*TSC_RATE,s=TSC_RATE/4294967296*t;break;case IA32_PLATFORM_ID:break;case IA32_APIC_BASE_MSR:ENABLE_ACPI&&(r=APIC_ADDRESS,e.apic_enabled&&(r|=IA32_APIC_BASE_EN));break;case IA32_BIOS_SIGN_ID:case IA32_MISC_ENABLE:case IA32_RTIT_CTL:case MSR_SMI_COUNT:case IA32_MCG_CAP:case MSR_PKG_C2_RESIDENCY:break;case MSR_EBC_FREQUENCY_ID:r=16777216;break;default:dbg_assert(!1,"Unknown msr: "+h(t>>>0,8))}e.reg32s[reg_eax]=r,e.reg32s[reg_edx]=s},t[51]=function(e){e.todo()},t[52]=function(e){var t=65532&e.sysenter_cs;e.protected_mode&&0!==t||e.trigger_gp(0),e.flags=e.flags&~flag_vm&~flag_interrupt,e.instruction_pointer=e.sysenter_eip,e.reg32s[reg_esp]=e.sysenter_esp,e.sreg[reg_cs]=t,e.segment_is_null[reg_cs]=0,e.segment_limits[reg_cs]=-1,e.segment_offsets[reg_cs]=0,e.update_cs_size(!0),e.cpl=0,e.cpl_changed(),e.sreg[reg_ss]=t+8,e.segment_is_null[reg_ss]=0,e.segment_limits[reg_ss]=-1,e.segment_offsets[reg_ss]=0,e.stack_size_32=!0,e.diverged()},t[53]=function(e){var t=65532&e.sysenter_cs;e.protected_mode&&!e.cpl&&0!==t||e.trigger_gp(0),e.instruction_pointer=e.reg32s[reg_edx],e.reg32s[reg_esp]=e.reg32s[reg_ecx],e.sreg[reg_cs]=t+16|3,e.segment_is_null[reg_cs]=0,e.segment_limits[reg_cs]=-1,e.segment_offsets[reg_cs]=0,e.update_cs_size(!0),e.cpl=3,e.cpl_changed(),e.sreg[reg_ss]=t+24|3,e.segment_is_null[reg_ss]=0,e.segment_limits[reg_ss]=-1,e.segment_offsets[reg_ss]=0,e.stack_size_32=!0,e.diverged()},t[54]=function(e){e.undefined_instruction()},t[55]=function(e){e.todo()},t[56]=function(e){e.unimplemented_sse()},t[57]=function(e){e.unimplemented_sse()},t[58]=function(e){e.unimplemented_sse()},t[59]=function(e){e.unimplemented_sse()},t[60]=function(e){e.unimplemented_sse()},t[61]=function(e){e.unimplemented_sse()},t[62]=function(e){e.unimplemented_sse()},t[63]=function(e){e.unimplemented_sse()},t16[64]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_o())},t32[64]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_o())},t16[65]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_o())},t32[65]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_o())},t16[66]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_b())},t32[66]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_b())},t16[67]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_b())},t32[67]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_b())},t16[68]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_z())},t32[68]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_z())},t16[69]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_z())},t32[69]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_z())},t16[70]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_be())},t32[70]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_be())},t16[71]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_be())},t32[71]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_be())},t16[72]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_s())},t32[72]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_s())},t16[73]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_s())},t32[73]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_s())},t16[74]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_p())},t32[74]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_p())},t16[75]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_p())},t32[75]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_p())},t16[76]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_l())},t32[76]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_l())},t16[77]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_l())},t32[77]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_l())},t16[78]=function(e){e.read_modrm_byte(),e.cmovcc16(e.test_le())},t32[78]=function(e){e.read_modrm_byte(),e.cmovcc32(e.test_le())},t16[79]=function(e){e.read_modrm_byte(),e.cmovcc16(!e.test_le())},t32[79]=function(e){e.read_modrm_byte(),e.cmovcc32(!e.test_le())},t[80]=function(e){e.unimplemented_sse()},t[81]=function(e){e.unimplemented_sse()},t[82]=function(e){e.unimplemented_sse()},t[83]=function(e){e.unimplemented_sse()},t[84]=function(e){e.unimplemented_sse()},t[85]=function(e){e.unimplemented_sse()},t[86]=function(e){e.unimplemented_sse()},t[87]=function(e){e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm_mem128s(),r=e.read_xmm128s();e.write_xmm128s(t[0]^r[0],t[1]^r[1],t[2]^r[2],t[3]^r[3])},t[88]=function(e){e.unimplemented_sse()},t[89]=function(e){e.unimplemented_sse()},t[90]=function(e){e.unimplemented_sse()},t[91]=function(e){e.unimplemented_sse()},t[92]=function(e){e.unimplemented_sse()},t[93]=function(e){e.unimplemented_sse()},t[94]=function(e){e.unimplemented_sse()},t[95]=function(e){e.unimplemented_sse()},t[96]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem64s();t=new Uint8Array(t.buffer);var r=e.read_xmm64s();r=new Uint8Array(r.buffer),e.write_xmm128s(r[0]|t[0]<<8|r[1]<<16|t[1]<<24,r[2]|t[2]<<8|r[3]<<16|t[3]<<24,r[4]|t[4]<<8|r[5]<<16|t[5]<<24,r[6]|t[6]<<8|r[7]<<16|t[7]<<24)}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem32s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],e.write_mmx64s(255&r|(255&t)<<8|(r>>8&255)<<16|(t>>8&255)<<24,r>>16&255|(t>>16&255)<<8|r>>>24<<16|t>>>24<<24)},t[97]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem64s();t=new Uint16Array(t.buffer);var r=e.read_xmm64s();r=new Uint16Array(r.buffer),e.write_xmm128s(r[0]|t[0]<<16,r[1]|t[1]<<16,r[2]|t[2]<<16,r[3]|t[3]<<16)}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem32s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],e.write_mmx64s(65535&r|(65535&t)<<16,r>>>16|t>>>16<<16)},t[98]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem32s();e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)],t)},t[99]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=0|e.saturate_sw_to_sb(65535&r);i|=e.saturate_sw_to_sb(r>>>16)<<8,i|=e.saturate_sw_to_sb(65535&s)<<16,i|=e.saturate_sw_to_sb(s>>>16)<<24,r=0|e.saturate_sw_to_sb(65535&t[0]),r|=e.saturate_sw_to_sb(t[0]>>>16)<<8,r|=e.saturate_sw_to_sb(65535&t[1])<<16,r|=e.saturate_sw_to_sb(t[1]>>>16)<<24,e.write_mmx64s(i,r)},t[100]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();t=new Int8Array(t.buffer);var r=8*(e.modrm_byte>>3&7),s=e.reg_mmx8s;e.write_mmx64s((s[r]>t[0]?255:0)|(s[r+1]>t[1]?255:0)<<8|(s[r+2]>t[2]?255:0)<<16|(s[r+3]>t[3]?255:0)<<24,(s[r+4]>t[4]?255:0)|(s[r+5]>t[5]?255:0)<<8|(s[r+6]>t[6]?255:0)<<16|(s[r+7]>t[7]?255:0)<<24)},t[101]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s((r<<16>>16>t[0]<<16>>16?65535:0)|(r>>16>t[0]>>16?65535:0)<<16,(s<<16>>16>t[1]<<16>>16?65535:0)|(s>>16>t[1]>>16?65535:0)<<16)},t[102]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)]>t[0]?-1:0,e.reg_mmxs[2*(e.modrm_byte>>3&7)+1]>t[1]?-1:0)},t[103]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Int16Array(t.buffer);var r=e.read_xmm128s();r=new Int16Array(r.buffer);for(var s=e.create_atom128s(0,0,0,0),i=new Uint8Array(s.buffer),_=0;8>_;_++)i[_]=e.saturate_sw_to_ub(r[_]),i[8|_]=e.saturate_sw_to_ub(t[_]);e.write_xmm128s(s[0],s[1],s[2],s[3])}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),s=e.reg_mmxs[2*(e.modrm_byte>>3&7)],i=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],r=0|e.saturate_sw_to_ub(65535&s),r|=e.saturate_sw_to_ub(s>>>16)<<8,r|=e.saturate_sw_to_ub(65535&i)<<16,r|=e.saturate_sw_to_ub(i>>>16)<<24,s=0|e.saturate_sw_to_ub(65535&t[0]),s|=e.saturate_sw_to_ub(t[0]>>>16)<<8,s|=e.saturate_sw_to_ub(65535&t[1])<<16,s|=e.saturate_sw_to_ub(t[1]>>>16)<<24,e.write_mmx64s(r,s)},t[104]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer);var r=e.read_xmm128s();r=new Uint8Array(r.buffer),e.write_xmm128s(r[8]|t[8]<<8|r[9]<<16|t[9]<<24,r[10]|t[10]<<8|r[11]<<16|t[11]<<24,r[12]|t[12]<<8|r[13]<<16|t[13]<<24,r[14]|t[14]<<8|r[15]<<16|t[15]<<24)}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],e.write_mmx64s(255&r|(255&t[1])<<8|(r>>8&255)<<16|(t[1]>>8&255)<<24,r>>16&255|(t[1]>>16&255)<<8|r>>>24<<16|t[1]>>>24<<24)},t[105]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s(65535&r|(65535&t[1])<<16,r>>>16|t[1]>>>16<<16)},t[106]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],t[1])},t[107]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],s=0|e.saturate_sd_to_sw(e.reg_mmxs[2*(e.modrm_byte>>3&7)]);s|=e.saturate_sd_to_sw(r)<<16,r=0|e.saturate_sd_to_sw(t[0]),r|=e.saturate_sd_to_sw(t[1])<<16,e.write_mmx64s(s,r)},t[108]=function(e){e.unimplemented_sse()},t[109]=function(e){e.unimplemented_sse()},t[110]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var t=e.read_e32s();e.write_xmm128s(t,0,0,0)}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_e32s(),e.write_mmx64s(t,0)},t[111]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();e.write_xmm128s(t[0],t[1],t[2],t[3])}else(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_REPZ?(t=e.read_xmm_mem128s_unaligned(),e.write_xmm128s(t[0],t[1],t[2],t[3])):(dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),e.write_mmx64s(t[0],t[1]))},t[112]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s(),r=e.read_op8();e.write_xmm128s(t[3&r],t[r>>2&3],t[r>>4&3],t[r>>6&3])}else if((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_REPNZ){t=e.read_xmm_mem128s(),r=new Uint16Array(t.buffer);var s=e.read_op8();e.write_xmm128s(r[3&s]|r[s>>2&3]<<16,r[s>>4&3]|r[s>>6&3]<<16,t[2],t[3])}else if((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_REPZ)t=e.read_xmm_mem128s(),r=new Uint16Array(t.buffer),s=e.read_op8(),e.write_xmm128s(t[0],t[1],r[3&s|4]|r[s>>2&3|4]<<16,r[s>>4&3|4]|r[s>>6&3|4]<<16);else{dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s();var i=e.read_op8();r=3&i,s=i>>2&3;var _=i>>4&3;i>>>=6,e.write_mmx64s(t[r>>1]>>>16*(1&r)&65535|t[s>>1]>>>16*(1&s)<<16,t[_>>1]>>>16*(1&_)&65535|t[i>>1]>>>16*(1&i)<<16)}},t[113]=function(e){switch(e.read_modrm_byte(),dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),192>e.modrm_byte&&e.trigger_ud(),e.modrm_byte>>3&7){case 2:var t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],_=0,a=0;15>=t&&(_=(65535&s)>>>t|s>>>16>>>t<<16,a=(65535&i)>>>t|i>>>16>>>t<<16),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;case 4:t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],15<t&&(t=16),e.reg_mmxs[2*r]=s<<16>>16>>t&65535|(s>>16>>t&65535)<<16,e.reg_mmxs[2*r+1]=i<<16>>16>>t&65535|(i>>16>>t&65535)<<16;break;case 6:t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],a=_=0,15>=t&&(_=(65535&s)<<t&65535|s>>>16<<t<<16,a=(65535&i)<<t&65535|i>>>16<<t<<16),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;default:e.unimplemented_sse()}},t[114]=function(e){switch(e.read_modrm_byte(),dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),192>e.modrm_byte&&e.trigger_ud(),e.modrm_byte>>3&7){case 2:var t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],_=0,a=0;31>=t&&(_=s>>>t,a=i>>>t),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;case 4:t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],31<t&&(t=31),e.reg_mmxs[2*r]=s>>t,e.reg_mmxs[2*r+1]=i>>t;break;case 6:t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],a=_=0,31>=t&&(_=s<<t,a=i<<t),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;default:e.unimplemented_sse()}},t[115]=function(e){switch(e.read_modrm_byte(),dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),192>e.modrm_byte&&e.trigger_ud(),e.modrm_byte>>3&7){case 2:var t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],_=0,a=0;31>=t?(_=s>>>t|i<<32-t,a=i>>>t):63>=t&&(_=i>>>(31&t),a=0),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;case 6:t=e.read_op8(),r=7&e.modrm_byte,s=e.reg_mmxs[2*r],i=e.reg_mmxs[2*r+1],a=_=0,31>=t?(_=s<<t,a=i<<t|s>>>32-t):63>=t&&(a=s<<(31&t),_=0),e.reg_mmxs[2*r]=_,e.reg_mmxs[2*r+1]=a;break;default:e.unimplemented_sse()}},t[116]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer);var r=e.read_xmm128s();r=new Uint8Array(r.buffer);for(var s=e.create_atom128s(0,0,0,0),i=new Uint8Array(s.buffer),_=0;16>_;_++)i[_]=t[_]===r[_]?255:0;e.write_xmm128s(s[0],s[1],s[2],s[3])}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),t=new Int8Array(t.buffer),r=8*(e.modrm_byte>>3&7),s=e.reg_mmx8s,e.write_mmx64s((s[r]===t[0]?255:0)|(s[r+1]===t[1]?255:0)<<8|(s[r+2]===t[2]?255:0)<<16|(s[r+3]===t[3]?255:0)<<24,(s[r+4]===t[4]?255:0)|(s[r+5]===t[5]?255:0)<<8|(s[r+6]===t[6]?255:0)<<16|(s[r+7]===t[7]?255:0)<<24)},t[117]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s(((65535&r)==(65535&t[0])?65535:0)|((4294901760&r)==(4294901760&t[0])?65535:0)<<16,((65535&s)==(65535&t[1])?65535:0)|((4294901760&s)==(4294901760&t[1])?65535:0)<<16)},t[118]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s(),r=e.read_xmm128s();e.write_xmm128s(t[0]===r[0]?-1:0,t[1]===r[1]?-1:0,t[2]===r[2]?-1:0,t[3]===r[3]?-1:0)}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)]===t[0]?-1:0,e.reg_mmxs[2*(e.modrm_byte>>3&7)+1]===t[1]?-1:0)},t[119]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.fpu.stack_empty=255},t[120]=function(e){e.unimplemented_sse()},t[121]=function(e){e.unimplemented_sse()},t[122]=function(e){e.unimplemented_sse()},t[123]=function(e){e.unimplemented_sse()},t[124]=function(e){e.unimplemented_sse()},t[125]=function(e){e.unimplemented_sse()},t[126]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_REPZ){var t=e.read_xmm_mem64s();e.write_xmm128s(t[0],t[1],0,0)}else(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE?(t=e.read_xmm64s(),e.set_e32(t[0])):(dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx64s(),e.set_e32(t[0]))},t[127]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_REPZ){var t=e.read_xmm128s();dbg_assert(192>e.modrm_byte);var r=e.modrm_resolve(e.modrm_byte);e.safe_write128(r,t[0],t[1],t[2],t[3])}else(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE?(t=e.read_xmm128s(),dbg_assert(192>e.modrm_byte),r=e.modrm_resolve(e.modrm_byte),e.safe_write128(r,t[0],t[1],t[2],t[3])):(dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx64s(),e.set_mmx_mem64s(t[0],t[1]))},t16[128]=function(e){e.jmpcc16(e.test_o())},t32[128]=function(e){e.jmpcc32(e.test_o())},t16[129]=function(e){e.jmpcc16(!e.test_o())},t32[129]=function(e){e.jmpcc32(!e.test_o())},t16[130]=function(e){e.jmpcc16(e.test_b())},t32[130]=function(e){e.jmpcc32(e.test_b())},t16[131]=function(e){e.jmpcc16(!e.test_b())},t32[131]=function(e){e.jmpcc32(!e.test_b())},t16[132]=function(e){e.jmpcc16(e.test_z())},t32[132]=function(e){e.jmpcc32(e.test_z())},t16[133]=function(e){e.jmpcc16(!e.test_z())},t32[133]=function(e){e.jmpcc32(!e.test_z())},t16[134]=function(e){e.jmpcc16(e.test_be())},t32[134]=function(e){e.jmpcc32(e.test_be())},t16[135]=function(e){e.jmpcc16(!e.test_be())},t32[135]=function(e){e.jmpcc32(!e.test_be())},t16[136]=function(e){e.jmpcc16(e.test_s())},t32[136]=function(e){e.jmpcc32(e.test_s())},t16[137]=function(e){e.jmpcc16(!e.test_s())},t32[137]=function(e){e.jmpcc32(!e.test_s())},t16[138]=function(e){e.jmpcc16(e.test_p())},t32[138]=function(e){e.jmpcc32(e.test_p())},t16[139]=function(e){e.jmpcc16(!e.test_p())},t32[139]=function(e){e.jmpcc32(!e.test_p())},t16[140]=function(e){e.jmpcc16(e.test_l())},t32[140]=function(e){e.jmpcc32(e.test_l())},t16[141]=function(e){e.jmpcc16(!e.test_l())},t32[141]=function(e){e.jmpcc32(!e.test_l())},t16[142]=function(e){e.jmpcc16(e.test_le())},t32[142]=function(e){e.jmpcc32(e.test_le())},t16[143]=function(e){e.jmpcc16(!e.test_le())},t32[143]=function(e){e.jmpcc32(!e.test_le())},t[144]=function(e){e.read_modrm_byte(),e.setcc(e.test_o())},t[145]=function(e){e.read_modrm_byte(),e.setcc(!e.test_o())},t[146]=function(e){e.read_modrm_byte(),e.setcc(e.test_b())},t[147]=function(e){e.read_modrm_byte(),e.setcc(!e.test_b())},t[148]=function(e){e.read_modrm_byte(),e.setcc(e.test_z())},t[149]=function(e){e.read_modrm_byte(),e.setcc(!e.test_z())},t[150]=function(e){e.read_modrm_byte(),e.setcc(e.test_be())},t[151]=function(e){e.read_modrm_byte(),e.setcc(!e.test_be())},t[152]=function(e){e.read_modrm_byte(),e.setcc(e.test_s())},t[153]=function(e){e.read_modrm_byte(),e.setcc(!e.test_s())},t[154]=function(e){e.read_modrm_byte(),e.setcc(e.test_p())},t[155]=function(e){e.read_modrm_byte(),e.setcc(!e.test_p())},t[156]=function(e){e.read_modrm_byte(),e.setcc(e.test_l())},t[157]=function(e){e.read_modrm_byte(),e.setcc(!e.test_l())},t[158]=function(e){e.read_modrm_byte(),e.setcc(e.test_le())},t[159]=function(e){e.read_modrm_byte(),e.setcc(!e.test_le())},t16[160]=function(e){e.push16(e.sreg[reg_fs])},t32[160]=function(e){e.push32(e.sreg[reg_fs])},t16[161]=function(e){e.switch_seg(reg_fs,e.safe_read16(e.get_stack_pointer(0))),e.adjust_stack_reg(2)},t32[161]=function(e){e.switch_seg(reg_fs,65535&e.safe_read32s(e.get_stack_pointer(0))),e.adjust_stack_reg(4)},t[162]=function(e){e.cpuid()},t16[163]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.bt_mem(e.modrm_resolve(e.modrm_byte),e.read_g16s()):e.bt_reg(e.read_reg_e16(),15&e.read_g16())},t32[163]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.bt_mem(e.modrm_resolve(e.modrm_byte),e.read_g32s()):e.bt_reg(e.read_reg_e32s(),31&e.read_g32s())},t16[164]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.shld16(t,e.read_g16(),31&e.read_op8()))},t32[164]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.shld32(t,e.read_g32s(),31&e.read_op8()))},t16[165]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.shld16(t,e.read_g16(),31&e.reg8[reg_cl]))},t32[165]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.shld32(t,e.read_g32s(),31&e.reg8[reg_cl]))},t[166]=function(e){e.trigger_ud()},t[167]=function(e){e.undefined_instruction()},t16[168]=function(e){e.push16(e.sreg[reg_gs])},t32[168]=function(e){e.push32(e.sreg[reg_gs])},t16[169]=function(e){e.switch_seg(reg_gs,e.safe_read16(e.get_stack_pointer(0))),e.adjust_stack_reg(2)},t32[169]=function(e){e.switch_seg(reg_gs,65535&e.safe_read32s(e.get_stack_pointer(0))),e.adjust_stack_reg(4)},t[170]=function(e){e.todo()},t16[171]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.bts_mem(e.modrm_resolve(e.modrm_byte),e.read_g16s()):e.write_reg_e16(e.bts_reg(e.read_reg_e16(),15&e.read_g16s()))},t32[171]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.bts_mem(e.modrm_resolve(e.modrm_byte),e.read_g32s()):e.write_reg_e32(e.bts_reg(e.read_reg_e32s(),31&e.read_g32s()))},t16[172]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.shrd16(t,e.read_g16(),31&e.read_op8()))},t32[172]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.shrd32(t,e.read_g32s(),31&e.read_op8()))},t16[173]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.shrd16(t,e.read_g16(),31&e.reg8[reg_cl]))},t32[173]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.shrd32(t,e.read_g32s(),31&e.reg8[reg_cl]))},t[174]=function(e){switch(e.read_modrm_byte(),e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)&&e.todo(),e.modrm_byte>>3&7){case 0:192<=e.modrm_byte&&e.trigger_ud();var t=e.modrm_resolve(e.modrm_byte);e.fxsave(t);break;case 1:192<=e.modrm_byte&&e.trigger_ud(),t=e.modrm_resolve(e.modrm_byte),e.fxrstor(t);break;case 2:192<=e.modrm_byte&&e.trigger_ud(),t=e.modrm_resolve(e.modrm_byte),(t=e.safe_read32s(t))&~MXCSR_MASK&&(dbg_log("Invalid mxcsr bits: "+h((t&~MXCSR_MASK)>>>0,8)),e.trigger_gp(0)),e.mxcsr=t;break;case 3:192<=e.modrm_byte&&e.trigger_ud(),t=e.modrm_resolve(e.modrm_byte),e.safe_write32(t,e.mxcsr);break;case 5:dbg_assert(192<=e.modrm_byte,"Unexpected lfence encoding"),192>e.modrm_byte&&e.trigger_ud();break;case 6:dbg_assert(192<=e.modrm_byte,"Unexpected mfence encoding"),192>e.modrm_byte&&e.trigger_ud();break;case 7:dbg_assert(192<=e.modrm_byte,"Unexpected sfence encoding"),192>e.modrm_byte&&e.trigger_ud();break;default:dbg_log("missing "+(e.modrm_byte>>3&7),LOG_CPU),e.todo()}},t16[175]=function(e){e.read_modrm_byte();var t=e.read_e16s();e.write_g16(e.imul_reg16(e.read_g16s(),t))},t32[175]=function(e){e.read_modrm_byte();var t=e.read_e32s();e.write_g32(e.imul_reg32(e.read_g32s(),t))},t[176]=function(e){if(e.read_modrm_byte(),192>e.modrm_byte){var t=e.modrm_resolve(e.modrm_byte);e.writable_or_pagefault(t,1);var r=e.safe_read8(t)}else r=e.reg8[e.modrm_byte<<2&12|e.modrm_byte>>2&1];e.cmp8(e.reg8[reg_al],r),e.getzf()?192>e.modrm_byte?e.safe_write8(t,e.read_g8()):e.reg8[e.modrm_byte<<2&12|e.modrm_byte>>2&1]=e.read_g8():(192>e.modrm_byte&&e.safe_write8(t,r),e.reg8[reg_al]=r)},t16[177]=function(e){if(e.read_modrm_byte(),192>e.modrm_byte){var t=e.modrm_resolve(e.modrm_byte);e.writable_or_pagefault(t,2);var r=e.safe_read16(t)}else r=e.read_reg_e16();e.cmp16(e.reg16[reg_ax],r),e.getzf()?192>e.modrm_byte?e.safe_write16(t,e.read_g16()):e.write_reg_e16(e.read_g16()):(192>e.modrm_byte&&e.safe_write16(t,r),e.reg16[reg_ax]=r)},t32[177]=function(e){if(e.read_modrm_byte(),192>e.modrm_byte){var t=e.modrm_resolve(e.modrm_byte);e.writable_or_pagefault(t,4);var r=e.safe_read32s(t)}else r=e.read_reg_e32s();e.cmp32(e.reg32s[reg_eax],r),e.getzf()?192>e.modrm_byte?e.safe_write32(t,e.read_g32s()):e.write_reg_e32(e.read_g32s()):(192>e.modrm_byte&&e.safe_write32(t,r),e.reg32s[reg_eax]=r)},t16[178]=function(e){e.read_modrm_byte(),e.lss16(reg_ss)},t32[178]=function(e){e.read_modrm_byte(),e.lss32(reg_ss)},t16[179]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.btr_mem(e.modrm_resolve(e.modrm_byte),e.read_g16s()):e.write_reg_e16(e.btr_reg(e.read_reg_e16(),15&e.read_g16s()))},t32[179]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.btr_mem(e.modrm_resolve(e.modrm_byte),e.read_g32s()):e.write_reg_e32(e.btr_reg(e.read_reg_e32s(),31&e.read_g32s()))},t16[180]=function(e){e.read_modrm_byte(),e.lss16(reg_fs)},t32[180]=function(e){e.read_modrm_byte(),e.lss32(reg_fs)},t16[181]=function(e){e.read_modrm_byte(),e.lss16(reg_gs)},t32[181]=function(e){e.read_modrm_byte(),e.lss32(reg_gs)},t16[182]=function(e){e.read_modrm_byte();var t=e.read_e8();e.write_g16(t)},t32[182]=function(e){e.read_modrm_byte();var t=e.read_e8();e.write_g32(t)},t16[183]=function(e){e.read_modrm_byte(),dbg_assert(!1,"Possibly invalid encoding");var t=e.read_e16();e.write_g16(t)},t32[183]=function(e){e.read_modrm_byte();var t=e.read_e16();e.write_g32(t)},t16[184]=function(e){e.read_modrm_byte(),0==(e.prefixes&PREFIX_REPZ)&&e.trigger_ud();var t=e.read_e16();e.write_g16(e.popcnt(t))},t32[184]=function(e){e.read_modrm_byte(),0==(e.prefixes&PREFIX_REPZ)&&e.trigger_ud();var t=e.read_e32s();e.write_g32(e.popcnt(t))},t[185]=function(e){e.todo()},t16[186]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 4:192>e.modrm_byte?e.bt_mem(e.modrm_resolve(e.modrm_byte),15&e.read_op8()):e.bt_reg(e.read_reg_e16(),15&e.read_op8());break;case 5:192>e.modrm_byte?e.bts_mem(e.modrm_resolve(e.modrm_byte),15&e.read_op8()):e.write_reg_e16(e.bts_reg(e.read_reg_e16(),15&e.read_op8()));break;case 6:192>e.modrm_byte?e.btr_mem(e.modrm_resolve(e.modrm_byte),15&e.read_op8()):e.write_reg_e16(e.btr_reg(e.read_reg_e16(),15&e.read_op8()));break;case 7:192>e.modrm_byte?e.btc_mem(e.modrm_resolve(e.modrm_byte),15&e.read_op8()):e.write_reg_e16(e.btc_reg(e.read_reg_e16(),15&e.read_op8()));break;default:dbg_log(e.modrm_byte>>3&7),e.todo()}},t32[186]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 4:192>e.modrm_byte?e.bt_mem(e.modrm_resolve(e.modrm_byte),31&e.read_op8()):e.bt_reg(e.read_reg_e32s(),31&e.read_op8());break;case 5:192>e.modrm_byte?e.bts_mem(e.modrm_resolve(e.modrm_byte),31&e.read_op8()):e.write_reg_e32(e.bts_reg(e.read_reg_e32s(),31&e.read_op8()));break;case 6:192>e.modrm_byte?e.btr_mem(e.modrm_resolve(e.modrm_byte),31&e.read_op8()):e.write_reg_e32(e.btr_reg(e.read_reg_e32s(),31&e.read_op8()));break;case 7:192>e.modrm_byte?e.btc_mem(e.modrm_resolve(e.modrm_byte),31&e.read_op8()):e.write_reg_e32(e.btc_reg(e.read_reg_e32s(),31&e.read_op8()));break;default:dbg_log(e.modrm_byte>>3&7),e.todo()}},t16[187]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.btc_mem(e.modrm_resolve(e.modrm_byte),e.read_g16s()):e.write_reg_e16(e.btc_reg(e.read_reg_e16(),15&e.read_g16s()))},t32[187]=function(e){e.read_modrm_byte(),192>e.modrm_byte?e.btc_mem(e.modrm_resolve(e.modrm_byte),e.read_g32s()):e.write_reg_e32(e.btc_reg(e.read_reg_e32s(),31&e.read_g32s()))},t16[188]=function(e){e.read_modrm_byte();var t=e.read_e16();e.write_g16(e.bsf16(e.read_g16(),t))},t32[188]=function(e){e.read_modrm_byte();var t=e.read_e32s();e.write_g32(e.bsf32(e.read_g32s(),t))},t16[189]=function(e){e.read_modrm_byte();var t=e.read_e16();e.write_g16(e.bsr16(e.read_g16(),t))},t32[189]=function(e){e.read_modrm_byte();var t=e.read_e32s();e.write_g32(e.bsr32(e.read_g32s(),t))},t16[190]=function(e){e.read_modrm_byte();var t=e.read_e8s();e.write_g16(t)},t32[190]=function(e){e.read_modrm_byte();var t=e.read_e8s();e.write_g32(t)},t16[191]=function(e){e.read_modrm_byte(),dbg_assert(!1,"Possibly invalid encoding");var t=e.read_e16();e.write_g16(t)},t32[191]=function(e){e.read_modrm_byte();var t=e.read_e16s();e.write_g32(t)},t[192]=function(e){e.read_modrm_byte();var t=e.read_write_e8();e.write_e8(e.xadd8(t,e.modrm_byte>>1&12|e.modrm_byte>>5&1))},t16[193]=function(e){e.read_modrm_byte();var t=e.read_write_e16();e.write_e16(e.xadd16(t,e.modrm_byte>>2&14))},t32[193]=function(e){e.read_modrm_byte();var t=e.read_write_e32();e.write_e32(e.xadd32(t,e.modrm_byte>>3&7))},t[194]=function(e){e.unimplemented_sse()},t[195]=function(e){e.read_modrm_byte(),192<=e.modrm_byte&&e.trigger_ud(),e.set_e32(e.read_g32s())},t[196]=function(e){e.unimplemented_sse()},t[197]=function(e){e.unimplemented_sse()},t[198]=function(e){e.unimplemented_sse()},t[199]=function(e){switch(e.read_modrm_byte(),e.modrm_byte>>3&7){case 1:192<=e.modrm_byte&&e.trigger_ud();var t=e.modrm_resolve(e.modrm_byte);e.writable_or_pagefault(t,8);var r=e.safe_read32s(t),s=e.safe_read32s(t+4|0);e.reg32s[reg_eax]===r&&e.reg32s[reg_edx]===s?(e.flags|=flag_zero,e.safe_write32(t,e.reg32s[reg_ebx]),e.safe_write32(t+4|0,e.reg32s[reg_ecx])):(e.flags&=~flag_zero,e.reg32s[reg_eax]=r,e.reg32s[reg_edx]=s,e.safe_write32(t,r),e.safe_write32(t+4|0,s)),e.flags_changed&=~flag_zero;break;case 6:r=(t=v86util.has_rand_int())?v86util.get_rand_int():0,e.is_osize_32()?e.set_e32(r):e.set_e16(r),e.flags&=~flags_all,e.flags|=t,e.flags_changed=0;break;default:dbg_log(e.modrm_byte>>3&7,LOG_CPU),e.todo()}},t[200]=function(e){e.bswap(reg_eax)},t[201]=function(e){e.bswap(reg_ecx)},t[202]=function(e){e.bswap(reg_edx)},t[203]=function(e){e.bswap(reg_ebx)},t[204]=function(e){e.bswap(reg_esp)},t[205]=function(e){e.bswap(reg_ebp)},t[206]=function(e){e.bswap(reg_esi)},t[207]=function(e){e.bswap(reg_edi)},t[208]=function(e){e.unimplemented_sse()},t[209]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=0,_=0;15>=(t=t[0]>>>0)&&(i=(65535&r)>>>t|r>>>16>>>t<<16,_=(65535&s)>>>t|s>>>16>>>t<<16),e.write_mmx64s(i,_)},t[210]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=0,_=0;31>=(t=t[0]>>>0)&&(i=r>>>t,_=s>>>t),e.write_mmx64s(i,_)},t[211]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];if(0!==(t=t[0]>>>0)){var i=0,_=0;31>=t?(i=r>>>t|s<<32-t,_=s>>>t):63>=t&&(i=s>>>(31&t),_=0),e.write_mmx64s(i,_)}},t[212]=function(e){e.unimplemented_sse()},t[213]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Int16Array(t.buffer);var r=e.read_xmm128s();r=new Int16Array(r.buffer),e.write_xmm128s(t[0]*r[0]&65535|t[1]*r[1]<<16,t[2]*r[2]&65535|t[3]*r[3]<<16,t[4]*r[4]&65535|t[5]*r[5]<<16,t[6]*r[6]&65535|t[7]*r[7]<<16)}else{dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)];var s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s((65535&r)*(65535&t[0])&65535|((r>>>16)*(t[0]>>>16)&65535)<<16,(65535&s)*(65535&t[1])&65535|((s>>>16)*(t[1]>>>16)&65535)<<16)}},t[214]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm64s();dbg_assert(192>e.modrm_byte);var r=e.modrm_resolve(e.modrm_byte);e.safe_write64(r,t[0],t[1])},t[215]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte(),192>e.modrm_byte&&e.trigger_ud();var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer),e.write_g32(t[0]>>7<<0|t[1]>>7<<1|t[2]>>7<<2|t[3]>>7<<3|t[4]>>7<<4|t[5]>>7<<5|t[6]>>7<<6|t[7]>>7<<7|t[8]>>7<<8|t[9]>>7<<9|t[10]>>7<<10|t[11]>>7<<11|t[12]>>7<<12|t[13]>>7<<13|t[14]>>7<<14|t[15]>>7<<15)},t[216]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=new Uint8Array(t.buffer),s=8*(e.modrm_byte>>3&7),i=e.reg_mmx8;t=e.saturate_sd_to_ub(i[s]-r[0]);var _=e.saturate_sd_to_ub(i[s+1]-r[1]),a=e.saturate_sd_to_ub(i[s+2]-r[2]),o=e.saturate_sd_to_ub(i[s+3]-r[3]),n=e.saturate_sd_to_ub(i[s+4]-r[4]),d=e.saturate_sd_to_ub(i[s+5]-r[5]),h=e.saturate_sd_to_ub(i[s+6]-r[6]);r=e.saturate_sd_to_ub(i[s+7]-r[7]),e.write_mmx64s(t|_<<8|a<<16|o<<24,n|d<<8|h<<16|r<<24)},t[217]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=(65535&r)-(65535&t[0]);r=(r>>>16)-(t[0]>>>16),0>i&&(i=0),0>r&&(r=0);var _=(65535&s)-(65535&t[1]);t=(s>>>16)-(t[1]>>>16),0>_&&(_=0),0>t&&(t=0),e.write_mmx64s(i|r<<16,_|t<<16)},t[218]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer);var r=e.read_xmm128s();r=new Uint8Array(r.buffer);for(var s=e.create_atom128s(0,0,0,0),i=new Uint8Array(s.buffer),_=0;16>_;_++)i[_]=t[_]<r[_]?t[_]:r[_];e.write_xmm128s(s[0],s[1],s[2],s[3])},t[219]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(t[0]&e.reg_mmxs[2*(e.modrm_byte>>3&7)],t[1]&e.reg_mmxs[2*(e.modrm_byte>>3&7)+1])},t[220]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer);var r=e.read_xmm128s();r=new Uint8Array(r.buffer);for(var s=e.create_atom128s(0,0,0,0),i=new Uint8Array(s.buffer),_=0;16>_;_++)i[_]=e.saturate_ud_to_ub(t[_]+r[_]);e.write_xmm128s(s[0],s[1],s[2],s[3])}else{dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s();var a=new Uint8Array(t.buffer),o=8*(e.modrm_byte>>3&7),n=e.reg_mmx8;t=e.saturate_ud_to_ub(n[o]+a[0]),r=e.saturate_ud_to_ub(n[o+1]+a[1]),s=e.saturate_ud_to_ub(n[o+2]+a[2]),i=e.saturate_ud_to_ub(n[o+3]+a[3]),_=e.saturate_ud_to_ub(n[o+4]+a[4]);var d=e.saturate_ud_to_ub(n[o+5]+a[5]),h=e.saturate_ud_to_ub(n[o+6]+a[6]);a=e.saturate_ud_to_ub(n[o+7]+a[7]),e.write_mmx64s(t|r<<8|s<<16|i<<24,_|d<<8|h<<16|a<<24)}},t[221]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Uint16Array(t.buffer);var r=e.read_xmm128s();r=new Uint16Array(r.buffer),e.write_xmm128s(e.saturate_uw(t[0]+r[0])|e.saturate_uw(t[1]+r[1])<<16,e.saturate_uw(t[2]+r[2])|e.saturate_uw(t[3]+r[3])<<16,e.saturate_uw(t[4]+r[4])|e.saturate_uw(t[5]+r[5])<<16,e.saturate_uw(t[6]+r[6])|e.saturate_uw(t[7]+r[7])<<16)}else{dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),r=e.read_mmx_mem64s();var s=e.reg_mmxs[2*(e.modrm_byte>>3&7)],i=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];t=e.saturate_uw((65535&s)+(65535&r[0])),s=e.saturate_uw((s>>>16)+(r[0]>>>16));var _=e.saturate_uw((65535&i)+(65535&r[1]));r=e.saturate_uw((i>>>16)+(r[1]>>>16)),e.write_mmx64s(t|s<<16,_|r<<16)}},t[222]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s();t=new Uint8Array(t.buffer);var r=e.read_xmm128s();r=new Uint8Array(r.buffer);for(var s=e.create_atom128s(0,0,0,0),i=new Uint8Array(s.buffer),_=0;16>_;_++)i[_]=t[_]>r[_]?t[_]:r[_];e.write_xmm128s(s[0],s[1],s[2],s[3])}else dbg_assert(!1)},t[223]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(t[0]&~e.reg_mmxs[2*(e.modrm_byte>>3&7)],t[1]&~e.reg_mmxs[2*(e.modrm_byte>>3&7)+1])},t[224]=function(e){e.unimplemented_sse()},t[225]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];15<(t=t[0]>>>0)&&(t=16),e.write_mmx64s(r<<16>>16>>t&65535|(r>>16>>t&65535)<<16,s<<16>>16>>t&65535|(s>>16>>t&65535)<<16)},t[226]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];31<(t=t[0]>>>0)&&(t=31),e.write_mmx64s(r>>t,s>>t)},t[227]=function(e){e.unimplemented_sse()},t[228]=function(e){dbg_assert((e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_xmm_mem128s();t=new Uint16Array(t.buffer);var r=e.read_xmm128s();r=new Uint16Array(r.buffer),e.write_xmm128s(t[0]*r[0]>>>16|t[1]*r[1]&4294901760,t[2]*r[2]>>>16|t[3]*r[3]&4294901760,t[4]*r[4]>>>16|t[5]*r[5]&4294901760,t[6]*r[6]>>>16|t[7]*r[7]&4294901760)},t[229]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s((r<<16>>16)*(t[0]<<16>>16)>>>16|(r>>16)*(t[0]>>16)>>>16<<16,(s<<16>>16)*(t[1]<<16>>16)>>>16|(s>>16)*(t[1]>>16)>>>16<<16)},t[230]=function(e){e.unimplemented_sse()},t[231]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),192<=e.modrm_byte&&e.trigger_ud(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm128s(),r=e.modrm_resolve(e.modrm_byte);e.safe_write128(r,t[0],t[1],t[2],t[3])}else dbg_assert(!1)},t[232]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=new Int8Array(t.buffer),s=8*(e.modrm_byte>>3&7),i=e.reg_mmx8s;t=e.saturate_sd_to_sb(i[s]-r[0]);var _=e.saturate_sd_to_sb(i[s+1]-r[1]),a=e.saturate_sd_to_sb(i[s+2]-r[2]),o=e.saturate_sd_to_sb(i[s+3]-r[3]),n=e.saturate_sd_to_sb(i[s+4]-r[4]),d=e.saturate_sd_to_sb(i[s+5]-r[5]),h=e.saturate_sd_to_sb(i[s+6]-r[6]);r=e.saturate_sd_to_sb(i[s+7]-r[7]),e.write_mmx64s(t|_<<8|a<<16|o<<24,n|d<<8|h<<16|r<<24)},t[233]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=e.saturate_sd_to_sw((r<<16>>16)-(t[0]<<16>>16));r=e.saturate_sd_to_sw((r>>16)-(t[0]>>16));var _=e.saturate_sd_to_sw((s<<16>>16)-(t[1]<<16>>16));t=e.saturate_sd_to_sw((s>>16)-(t[1]>>16)),e.write_mmx64s(i|r<<16,_|t<<16)},t[234]=function(e){e.unimplemented_sse()},t[235]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s(),r=e.read_xmm128s();e.write_xmm128s(t[0]|r[0],t[1]|r[1],t[2]|r[2],t[3]|r[3])}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),e.write_mmx64s(t[0]|e.reg_mmxs[2*(e.modrm_byte>>3&7)],t[1]|e.reg_mmxs[2*(e.modrm_byte>>3&7)+1])},t[236]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=new Int8Array(t.buffer),s=8*(e.modrm_byte>>3&7),i=e.reg_mmx8s;t=e.saturate_sd_to_sb(i[s]+r[0]);var _=e.saturate_sd_to_sb(i[s+1]+r[1]),a=e.saturate_sd_to_sb(i[s+2]+r[2]),o=e.saturate_sd_to_sb(i[s+3]+r[3]),n=e.saturate_sd_to_sb(i[s+4]+r[4]),d=e.saturate_sd_to_sb(i[s+5]+r[5]),h=e.saturate_sd_to_sb(i[s+6]+r[6]);r=e.saturate_sd_to_sb(i[s+7]+r[7]),e.write_mmx64s(t|_<<8|a<<16|o<<24,n|d<<8|h<<16|r<<24)},t[237]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=e.saturate_sd_to_sw((r<<16>>16)+(t[0]<<16>>16));r=e.saturate_sd_to_sw((r>>16)+(t[0]>>16));var _=e.saturate_sd_to_sw((s<<16>>16)+(t[1]<<16>>16));t=e.saturate_sd_to_sw((s>>16)+(t[1]>>16)),e.write_mmx64s(i|r<<16,_|t<<16)},t[238]=function(e){e.unimplemented_sse()},t[239]=function(e){if(e.task_switch_test_mmx(),e.read_modrm_byte(),(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var t=e.read_xmm_mem128s(),r=e.read_xmm128s();e.write_xmm128s(t[0]^r[0],t[1]^r[1],t[2]^r[2],t[3]^r[3])}else dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),t=e.read_mmx_mem64s(),e.write_mmx64s(t[0]^e.reg_mmxs[2*(e.modrm_byte>>3&7)],t[1]^e.reg_mmxs[2*(e.modrm_byte>>3&7)+1])},t[240]=function(e){e.unimplemented_sse()},t[241]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=0,_=0;15>=(t=t[0]>>>0)&&(i=(65535&r)<<t&65535|r>>>16<<t<<16,_=(65535&s)<<t&65535|s>>>16<<t<<16),e.write_mmx64s(i,_)},t[242]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1],i=0,_=0;31>=(t=t[0]>>>0)&&(i=r<<t,_=s<<t),e.write_mmx64s(i,_)},t[243]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];if(0!==(t=t[0]>>>0)){var i=0,_=0;31>=t?(i=r<<t,_=s<<t|r>>>32-t):63>=t&&(_=r<<(31&t),i=0),e.write_mmx64s(i,_)}},t[244]=function(e){e.unimplemented_sse()},t[245]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s((r<<16>>16)*(t[0]<<16>>16)+(r>>16)*(t[0]>>16)|0,(s<<16>>16)*(t[1]<<16>>16)+(s>>16)*(t[1]>>16)|0)},t[246]=function(e){e.unimplemented_sse()},t[247]=function(e){e.unimplemented_sse()},t[248]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();t=new Int8Array(t.buffer);var r=8*(e.modrm_byte>>3&7),s=e.reg_mmx8s;e.write_mmx64s(s[r]-t[0]&255|(s[r+1]-t[1]&255)<<8|(s[r+2]-t[2]&255)<<16|(s[r+3]-t[3]&255)<<24,s[r+4]-t[4]&255|(s[r+5]-t[5]&255)<<8|(s[r+6]-t[6]&255)<<16|(s[r+7]-t[7]&255)<<24)},t[249]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s(r-t[0]&65535|((r>>>16)-(t[0]>>>16)&65535)<<16,s-t[1]&65535|((s>>>16)-(t[1]>>>16)&65535)<<16)},t[250]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)]-t[0],e.reg_mmxs[2*(e.modrm_byte>>3&7)+1]-t[1])},t[251]=function(e){e.unimplemented_sse()},t[252]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();t=new Int8Array(t.buffer);var r=8*(e.modrm_byte>>3&7),s=e.reg_mmx8s;e.write_mmx64s(s[r]+t[0]&255|(s[r+1]+t[1]&255)<<8|(s[r+2]+t[2]&255)<<16|(s[r+3]+t[3]&255)<<24,s[r+4]+t[4]&255|(s[r+5]+t[5]&255)<<8|(s[r+6]+t[6]&255)<<16|(s[r+7]+t[7]&255)<<24)},t[253]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s(),r=e.reg_mmxs[2*(e.modrm_byte>>3&7)],s=e.reg_mmxs[2*(e.modrm_byte>>3&7)+1];e.write_mmx64s(r+t[0]&65535|((r>>>16)+(t[0]>>>16)&65535)<<16,s+t[1]&65535|((s>>>16)+(t[1]>>>16)&65535)<<16)},t[254]=function(e){dbg_assert(0==(e.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),e.task_switch_test_mmx(),e.read_modrm_byte();var t=e.read_mmx_mem64s();e.write_mmx64s(e.reg_mmxs[2*(e.modrm_byte>>3&7)]+t[0]|0,e.reg_mmxs[2*(e.modrm_byte>>3&7)+1]+t[1]|0)},t[255]=function(e){dbg_log("#ud: 0F FF"),e.trigger_ud()};var table0F_16=[],table0F_32=[];for(CPU.prototype.table0F_16=table0F_16,CPU.prototype.table0F_32=table0F_32,i=0;256>i;i++)t[i]?table0F_16[i]=table0F_32[i]=t[i]:t16[i]&&(table0F_16[i]=t16[i],table0F_32[i]=t32[i]);CPU.prototype.debug_init=function(){function e(){DEBUG&&(o.running||o.cycle(),s(),Date.now(),o.running=!1,_())}function t(e){var t=o.flags&flag_vm?1:0;t=o.protected_mode?t?"vm86":"prot":"real";var r=o.get_eflags(),s=o.getiopl(),i=o.cpl,_=h(o.sreg[reg_cs],4)+":"+h(o.get_real_eip()>>>0,8),a=h(o.sreg[reg_ss],4)+":"+h(o.get_stack_reg()>>>0,8),n=o.is_32?"32":"16",d=o.flags&flag_interrupt?1:0,g={};g[flag_carry]="c",g[flag_parity]="p",g[flag_adjust]="a",g[flag_zero]="z",g[flag_sign]="s",g[flag_trap]="t",g[flag_interrupt]="i",g[flag_direction]="d",g[flag_overflow]="o",g=g;for(var c="",p=0;16>p;p++)g[1<<p]&&(c=r&1<<p?c+g[1<<p]:c+" ");return"mode="+t+"/"+n+" paging="+ +o.paging+" iopl="+s+" cpl="+i+" if="+d+" cs:eip="+_+" cs_off="+h(o.get_seg(reg_cs)>>>0,8)+" flgs="+h(o.get_eflags()>>>0,6)+" ("+c+") ss:esp="+a+" ssize="+ +o.stack_size_32+(e?" in "+e:"")}function r(){for(var e={eax:reg_eax,ecx:reg_ecx,edx:reg_edx,ebx:reg_ebx,esp:reg_esp,ebp:reg_ebp,esi:reg_esi,edi:reg_edi},t="eax ecx edx ebx esp ebp esi edi".split(" "),r="",s="",i=0;4>i;i++)r+=t[i]+"="+h(o.reg32[e[t[i]]],8)+" ",s+=t[i+4]+"="+h(o.reg32[e[t[i+4]]],8)+" ";return[r+="  ds="+h(o.sreg[reg_ds],4)+" es="+h(o.sreg[reg_es],4)+" fs="+h(o.sreg[reg_fs],4),s+="  gs="+h(o.sreg[reg_gs],4)+" cs="+h(o.sreg[reg_cs],4)+" ss="+h(o.sreg[reg_ss],4)]}function s(){if(DEBUG){var e=r();dbg_log(e[0],LOG_CPU),dbg_log(e[1],LOG_CPU)}}function i(){if(DEBUG){n.step_mode=!0;var e,t="";if(n.trace_all&&n.all_ops?e=n.all_ops:n.ops&&(e=n.ops.toArray()),!e)return"";for(var r=0;r<e.length;r+=2){var s=e[r+1];t+=h(e[r],8)+":        "+v86util.pads(d[s]||"unkown",20)+h(s,2)+"\n"}return n.ops.clear(),n.all_ops=[],t}}function _(){DEBUG&&n.show(i())}function a(e,t){if(DEBUG){if(!(1&e))return!1;var r=128==(128&e);return{size:r,global:256==(256&e),accessed:32==(32&e),dirty:64==(64&e),cache_disable:16==(16&e),user:4==(4&e),read_write:2==(2&e),address:(r&&!t?4290772992&e:4294963200&e)>>>0}}}var o=this,n={};this.debug=n,n.step_mode=!1,n.ops=void 0,n.all_ops=[],n.trace_all=!1,n.show=function(e){if("undefined"!=typeof document){var t=document.getElementById("log");if(t)return t.textContent+=e+"\n",void(t.scrollTop=1e9)}console.log(e)},n.init=function(){function e(e){10===e?(dbg_log(t,LOG_BIOS),t=""):t+=String.fromCharCode(e)}if(DEBUG&&(n.ops=new CircularQueue(2e5),o.io)){var t="";o.io.register_write(1026,this,e),o.io.register_write(1280,this,e)}},n.get_regs_short=r,n.dump_regs=s,n.dump_instructions=_,n.get_instructions=i,n.get_state=t,n.dump_state=function(e){DEBUG&&dbg_log(t(e),LOG_CPU)},n.dump_stack=function(e,t){if(DEBUG){var r=o.reg32[reg_esp];for(dbg_log("========= STACK =========="),(t>=e||void 0===t)&&(e=5,t=-5);e>t;e--){var s="    ";e||(s="=>  "),s+=h(e,2)+" | ",dbg_log(s+h(r+4*e,8)+" | "+h(o.read32s(r+4*e)>>>0))}}},n.dump_page_directory=function(){if(DEBUG)for(var e=0;1024>e;e++){var t=o.read32s(o.cr[3]+4*e),r=a(t,!0);if(r)if(t="",t+=r.size?"S ":"  ",t+=r.accessed?"A ":"  ",t+=r.cache_disable?"Cd ":"  ",t+=r.user?"U ":"  ",t+=r.read_write?"Rw ":"   ",r.size)dbg_log("=== "+h(e<<22>>>0,8)+" -> "+h(r.address>>>0,8)+" | "+t);else{dbg_log("=== "+h(e<<22>>>0,8)+" | "+t);for(var s=0;1024>s;s++){var i=r.address+4*s,_=a(t=o.read32s(i),!1);_&&(t="",t+=_.cache_disable?"Cd ":"   ",t+=_.user?"U ":"  ",t+=_.read_write?"Rw ":"   ",t+=_.global?"G ":"  ",t+=_.accessed?"A ":"  ",t+=_.dirty?"Di ":"   ",dbg_log("# "+h((e<<22|s<<12)>>>0,8)+" -> "+h(_.address,8)+" | "+t+"        (at "+h(i,8)+")"))}}}},n.dump_gdt_ldt=function(){function e(e,t){for(var r=0;r<t;r+=8,e+=8){var s=o.read16(e+2)|o.read8(e+4)<<16|o.read8(e+7)<<24,i=o.read16(e)|(15&o.read8(e+6))<<16,_=o.read8(e+5),a=o.read8(e+6)>>4,n="",d=_>>5&3;n=128&_?n+" P ":n+"NP ",16&_?(n=4&a?n+"32b ":n+"16b ",8&_?(n+="X ",4&_&&(n+="C ")):n+="R ",n+="RW "):n+="sys: "+h(15&_),8&a&&(i=i<<12|4095),dbg_log(h(-8&r,4)+" "+h(s>>>0,8)+" ("+h(i>>>0,8)+" bytes) "+n+";  dpl = "+d+", a = "+_.toString(2)+", f = "+a.toString(2))}}DEBUG&&(dbg_log("gdt: (len = "+h(o.gdtr_size)+")"),e(o.translate_address_system_read(o.gdtr_offset),o.gdtr_size),dbg_log("\nldt: (len = "+h(o.segment_limits[reg_ldtr])+")"),e(o.translate_address_system_read(o.segment_offsets[reg_ldtr]),o.segment_limits[reg_ldtr]))},n.dump_idt=function(){if(DEBUG)for(var e=0;e<o.idtr_size;e+=8){var t=o.translate_address_system_read(o.idtr_offset+e),r=o.read16(t)|o.read16(t+6)<<16,s=o.read16(t+2),i=(t=o.read8(t+5))>>5&3,_=5==(31&t)?"task gate ":14==(31&t)?"intr gate ":15==(31&t)?"trap gate ":"invalid   ";_=128&t?_+" P":_+"NP",dbg_log(h(e>>3,4)+" "+h(r>>>0,8)+", "+h(s,4)+"; "+_+";  dpl = "+i+", t = "+t.toString(2))}},n.get_memory_dump=function(e,t){if(DEBUG)return void 0===e?(e=0,t=o.memory_size):void 0===t&&(t=e,e=0),o.mem8.slice(e,e+t).buffer},n.memory_hex_dump=function(e,t){if(DEBUG){t=t||64;for(var r,s,i=0;i<t>>4;i++){r=h(e+(i<<4),5)+"   ";for(var _=0;16>_;_++)r+=h(s=o.read8(e+(i<<4)+_),2)+" ";for(r+="  ",_=0;16>_;_++)r+=33>(s=o.read8(e+(i<<4)+_))||126<s?".":String.fromCharCode(s);dbg_log(r)}}},n.used_memory_dump=function(){if(DEBUG)for(var e,t=o.memory_size/128/16|0,r=0;16>r;r++){e=h(128*r*t,8)+" | ";for(var s=0;128>s;s++)e+=0<o.mem32s[(128*r+s)*t]?"X":" ";dbg_log(e)}},n.step=e,n.run_until=function(){if(DEBUG){o.running=!1;var t=parseInt(prompt("input hex",""),16);if(t)for(;o.instruction_pointer!=t;)e()}},n.unimpl=function(e){return e="Unimplemented"+(e?": "+e:""),n.show(e),DEBUG?console.trace():n.show("Execution stopped"),e};var d="ADD ADD ADD ADD ADD ADD PUSH POP OR OR OR OR OR OR PUSH 0F: ADC ADC ADC ADC ADC ADC PUSH POP SBB SBB SBB SBB SBB SBB PUSH POP AND AND AND AND AND AND ES DAA SUB SUB SUB SUB SUB SUB CS DAS XOR XOR XOR XOR XOR XOR SS AAA CMP CMP CMP CMP CMP CMP DS AAS INC INC INC INC INC INC INC INC DEC DEC DEC DEC DEC DEC DEC DEC PUSH PUSH PUSH PUSH PUSH PUSH PUSH PUSH POP POP POP POP POP POP POP POP PUSHA POPA BOUND ARPL FS GS none none PUSH IMUL PUSH IMUL INS INS OUTS OUTS JO JNO JB JNB JZ JNZ JBE JNBE JS JNS JP JNP JL JNL JLE JNLE ADD ADD ADD ADD TEST TEST XCHG XCHG MOV MOV MOV MOV MOV LEA MOV POP NOP XCHG XCHG XCHG XCHG XCHG XCHG XCHG CBW CWD CALLF FWAIT PUSHF POPF SAHF LAHF MOV MOV MOV MOV MOVS MOVS CMPS CMPS TEST TEST STOS STOS LODS LODS SCAS SCAS MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV ROL ROL RETN RETN LES LDS MOV MOV ENTER LEAVE RETF RETF INT INT INTO IRET ROL ROL ROL ROL AAM AAD none XLAT FADD FLD FIADD FILD FADD FLD FIADD FILD LOOPNZ LOOPZ LOOP JCXZ IN IN OUT OUT CALL JMP JMPF JMP IN IN OUT OUT LOCK none REPNZ REPZ HLT CMC TEST TEST CLC STC CLI STI CLD STD INC INC".split(" ");n.logop=function(e,t){DEBUG&&n.step_mode&&(n.trace_all&&n.all_ops?n.all_ops.push(e,t):n.ops&&(n.ops.add(e),n.ops.add(t)))},n.debug_interrupt=function(e){}};var ELF_MAGIC=1179403647,types=DataView.prototype,U8={size:1,get:types.getUint8,set:types.setUint8},U16={size:2,get:types.getUint16,set:types.setUint16},U32={size:4,get:types.getUint32,set:types.setUint32},pad=function(e){return{size:e,get:function(e){return-1}}},Header=create_struct([{magic:U32},{class:U8},{data:U8},{version0:U8},{osabi:U8},{abiversion:U8},{pad0:pad(7)},{type:U16},{machine:U16},{version1:U32},{entry:U32},{phoff:U32},{shoff:U32},{flags:U32},{ehsize:U16},{phentsize:U16},{phnum:U16},{shentsize:U16},{shnum:U16},{shstrndx:U16}]);console.assert(52===Header.reduce(function(e,t){return e+t.size},0));var ProgramHeader=create_struct([{type:U32},{offset:U32},{vaddr:U32},{paddr:U32},{filesz:U32},{memsz:U32},{flags:U32},{align:U32}]);console.assert(32===ProgramHeader.reduce(function(e,t){return e+t.size},0));var SectionHeader=create_struct([{name:U32},{type:U32},{flags:U32},{addr:U32},{offset:U32},{size:U32},{link:U32},{info:U32},{addralign:U32},{entsize:U32}]);function create_struct(e){return e.map(function(e){var t=Object.keys(e);return console.assert(1===t.length),e=e[t=t[0]],console.assert(0<e.size),{name:t,type:e,size:e.size,get:e.get,set:e.set}})}function read_elf(e){var t=new DataView(e),r=$jscomp.makeIterator(read_struct(t,Header));if(e=r.next().value,r=r.next().value,console.assert(52===r),DEBUG){for(var s in e)console.log(s+": 0x"+e[s].toString(16));console.log(e)}if(console.assert(e.magic===ELF_MAGIC,"Bad magic"),console.assert(1===e.class,"Unimplemented: 64 bit elf"),console.assert(1===e.data,"Unimplemented: big endian"),console.assert(1===e.version0,"Bad version0"),console.assert(2===e.type,"Unimplemented type"),console.assert(1===e.version1,"Bad version1"),console.assert(52===e.ehsize,"Bad header size"),console.assert(32===e.phentsize,"Bad program header size"),console.assert(40===e.shentsize,"Bad section header size"),s=(r=$jscomp.makeIterator(read_structs(view_slice(t,e.phoff,e.phentsize*e.phnum),ProgramHeader,e.phnum))).next().value,r.next(),t=(r=$jscomp.makeIterator(read_structs(view_slice(t,e.shoff,e.shentsize*e.shnum),SectionHeader,e.shnum))).next().value,r.next(),DEBUG){console.log("%d program headers:",s.length);for(var i=(r=$jscomp.makeIterator(s)).next();!i.done;i=r.next())i=i.value,console.log("type=%s offset=%s vaddr=%s paddr=%s filesz=%s memsz=%s flags=%s align=%s",i.type.toString(16),i.offset.toString(16),i.vaddr.toString(16),i.paddr.toString(16),i.filesz.toString(16),i.memsz.toString(16),i.flags.toString(16),i.align.toString(16));for(console.log("%d program headers:",t.length),i=(r=$jscomp.makeIterator(t)).next();!i.done;i=r.next())i=i.value,console.log("name=%s type=%s flags=%s addr=%s offset=%s size=%s link=%s info=%s addralign=%s entsize=%s",i.name.toString(16),i.type.toString(16),i.flags.toString(16),i.addr.toString(16),i.offset.toString(16),i.size.toString(16),i.link.toString(16),i.info.toString(16),i.addralign.toString(16),i.entsize.toString(16))}return{header:e,program_headers:s,sections_headers:t}}function read_struct(e,t){for(var r={},s=0,i=(t=$jscomp.makeIterator(t)).next();!i.done;i=t.next()){var _=(i=i.value).get.call(e,s,!0);console.assert(void 0===r[i.name]),r[i.name]=_,s+=i.size}return[r,s]}function read_structs(e,t,r){for(var s=[],i=0,_=0;_<r;_++){var a=$jscomp.makeIterator(read_struct(view_slice(e,i),t)),o=a.next().value;a=a.next().value,s.push(o),i+=a}return[s,i]}function view_slice(e,t,r){return new DataView(e.buffer,e.byteOffset+t,r)}console.assert(40===SectionHeader.reduce(function(e,t){return e+t.size},0));var SHIFT_SCAN_CODE=42,SCAN_CODE_RELEASE=128;function KeyboardAdapter(e){function t(e){return!e.altKey&&o[56]&&_(56,!1),i(e,!1)}function r(e){return!e.altKey&&o[56]&&_(56,!1),i(e,!0)}function s(e){e=Object.keys(o);for(var t,r=0;r<e.length;r++)t=+e[r],o[t]&&_(t,!1);o={}}function i(e,t){if(n.bus&&(!e.shiftKey||!e.ctrlKey||74!==e.keyCode&&75!==e.keyCode)&&n.emu_enabled&&(!e.target||("phone_keyboard"===e.target.className||"INPUT"!==e.target.nodeName&&"TEXTAREA"!==e.target.nodeName))){e:{if(void 0!==e.code){var r=c[e.code];if(void 0!==r)break e}r=d[e.keyCode]}if(r)return _(r,t),e.preventDefault&&e.preventDefault(),!1;console.log("Missing char in map: "+e.keyCode.toString(16))}}function _(e,t){if(t)o[e]&&_(e,!1);else if(!o[e])return;(o[e]=t)||(e|=128),255<e?(a(e>>8),a(255&e)):a(e)}function a(e){n.bus.send("keyboard-code",e)}var o={},n=this;this.emu_enabled=!0;var d=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),h={10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},g={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},c={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57423,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=e,this.destroy=function(){"undefined"!=typeof window&&(window.removeEventListener("keyup",t,!1),window.removeEventListener("keydown",r,!1),window.removeEventListener("blur",s,!1))},this.init=function(){"undefined"!=typeof window&&(this.destroy(),window.addEventListener("keyup",t,!1),window.addEventListener("keydown",r,!1),window.addEventListener("blur",s,!1))},this.init(),this.simulate_press=function(e){i(e={keyCode:e},!0),i(e,!1)},this.simulate_char=function(e){var t=e.charCodeAt(0);t in h?this.simulate_press(h[t]):t in g?(a(SHIFT_SCAN_CODE),this.simulate_press(g[t]),a(SHIFT_SCAN_CODE|SCAN_CODE_RELEASE)):console.log("ascii -> keyCode not found: ",t,e)}}function MouseAdapter(e,t){function r(e){if(!l.enabled||!l.emu_enabled)return!1;if("mousemove"===e.type||"touchmove"===e.type)return!0;if("mousewheel"===e.type||"DOMMouseScroll"===e.type){var r=t||document.body;e:{for(e=e.target;e.parentNode;){if(e===r){r=!0;break e}e=e.parentNode}r=!1}return r}return!e.target||"INPUT"!==e.target.nodeName&&"TEXTAREA"!==e.target.nodeName}function s(e){r(e)&&(e=e.changedTouches)&&e.length&&(e=e[e.length-1],p=e.clientX,u=e.clientY)}function i(e){(h||c||g)&&(l.bus.send("mouse-click",[!1,!1,!1]),h=c=g=!1)}function _(e){if(l.bus&&r(e)){var s=0,i=0,_=e.changedTouches;_?_.length&&(s=(_=_[_.length-1]).clientX-p,i=_.clientY-u,p=_.clientX,u=_.clientY,e.preventDefault()):"number"==typeof e.movementX?(s=e.movementX,i=e.movementY):"number"==typeof e.webkitMovementX?(s=e.webkitMovementX,i=e.webkitMovementY):"number"==typeof e.mozMovementX?(s=e.mozMovementX,i=e.mozMovementY):(s=e.clientX-p,i=e.clientY-u,p=e.clientX,u=e.clientY),l.bus.send("mouse-delta",[.15*s,-.15*i]),l.bus.send("mouse-absolute",[e.pageX-t.offsetLeft,e.pageY-t.offsetTop,t.offsetWidth,t.offsetHeight])}}function a(e){r(e)&&n(e,!0)}function o(e){r(e)&&n(e,!1)}function n(e,t){l.bus&&(1===e.which?h=t:2===e.which?c=t:3===e.which?g=t:console.log("Unknown event.which: "+e.which),l.bus.send("mouse-click",[h,c,g]))}function d(e){if(r(e)){var t=e.wheelDelta||-e.detail;0>t?t=-1:0<t&&(t=1),l.bus.send("mouse-wheel",[t,0]),e.preventDefault()}}var h=!1,g=!1,c=!1,p=0,u=0,l=this;this.enabled=!1,this.emu_enabled=!0,this.bus=e,this.bus.register("mouse-enable",function(e){this.enabled=e},this),this.destroy=function(){window.removeEventListener("touchstart",s,!1),window.removeEventListener("touchend",i,!1),window.removeEventListener("touchmove",_,!1),window.removeEventListener("mousemove",_,!1),window.removeEventListener("mousedown",a,!1),window.removeEventListener("mouseup",o,!1),window.removeEventListener("DOMMouseScroll",d,!1),window.removeEventListener("mousewheel",d,!1)},this.init=function(){"undefined"!=typeof window&&(this.destroy(),window.addEventListener("touchstart",s,!1),window.addEventListener("touchend",i,!1),window.addEventListener("touchmove",_,!1),window.addEventListener("mousemove",_,!1),window.addEventListener("mousedown",a,!1),window.addEventListener("mouseup",o,!1),window.addEventListener("DOMMouseScroll",d,!1),window.addEventListener("mousewheel",d,!1))},this.init()}var DAC_QUEUE_RESERVE=.2,AUDIOBUFFER_MINIMUM_SAMPLING_RATE=8e3;function SpeakerAdapter(e){if("undefined"!=typeof window)if(window.AudioContext||window.webkitAudioContext){var t=window.AudioWorklet?SpeakerWorkletDAC:SpeakerBufferSourceDAC;this.bus=e,this.audio_context=new(window.AudioContext||window.webkitAudioContext),this.mixer=new SpeakerMixer(e,this.audio_context),this.pcspeaker=new PCSpeaker(e,this.audio_context,this.mixer),this.dac=new t(e,this.audio_context,this.mixer),this.pcspeaker.start(),e.register("emulator-stopped",function(){this.audio_context.suspend()},this),e.register("emulator-started",function(){this.audio_context.resume()},this),e.register("speaker-confirm-initialized",function(){e.send("speaker-has-initialized")},this),e.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}function SpeakerMixer(e,t){function r(e){return function(t){e.gain.setValueAtTime(t,this.audio_context.currentTime)}}this.audio_context=t,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),e.register("mixer-connect",function(e){this.connect_source(e[0],e[1])},this),e.register("mixer-disconnect",function(e){this.disconnect_source(e[0],e[1])},this),e.register("mixer-volume",function(e){var t=e[0],r=e[1];e=Math.pow(10,e[2]/20);var s=t===MIXER_SRC_MASTER?this:this.sources.get(t);void 0===s?dbg_assert(!1,"Mixer set volume - cannot set volume for undefined source: "+t):s.set_volume(e,r)},this),e.register("mixer-gain-left",function(e){this.gain_left=Math.pow(10,e/20),this.update()},this),e.register("mixer-gain-right",function(e){this.gain_right=Math.pow(10,e/20),this.update()},this),e.register("mixer-treble-left",r(this.node_treble_left),this),e.register("mixer-treble-right",r(this.node_treble_right),this),e.register("mixer-bass-left",r(this.node_bass_left),this),e.register("mixer-bass-right",r(this.node_bass_right),this)}function SpeakerMixerSource(e,t,r,s){this.audio_context=e,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=e.createChannelSplitter(2),this.node_gain_left=e.createGain(),this.node_gain_right=e.createGain(),t.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(r),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(s)}function PCSpeaker(e,t,r){this.node_oscillator=t.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,t.currentTime),this.mixer_connection=r.add_source(this.node_oscillator,MIXER_SRC_PCSPEAKER),this.mixer_connection.disconnect(),e.register("pcspeaker-enable",function(){r.connect_source(MIXER_SRC_PCSPEAKER)},this),e.register("pcspeaker-disable",function(){r.disconnect_source(MIXER_SRC_PCSPEAKER)},this),e.register("pcspeaker-update",function(e){var r=e[1],s=0;3===e[0]&&(s=1e3*OSCILLATOR_FREQ/r,s=Math.min(s,this.node_oscillator.frequency.maxValue),s=Math.max(s,0)),this.node_oscillator.frequency.setValueAtTime(s,t.currentTime)},this)}function SpeakerWorkletDAC(e,t,r){var s=this;this.bus=e,this.audio_context=t,this.enabled=!1,this.sampling_rate=48e3;var i=(t=function(){function e(e){return 0===e?1:(e*=Math.PI,Math.sin(e)/e)}function t(){var e=Reflect.construct(AudioWorkletProcessor,[],t);return e.kernel_size=3,e.queue_data=Array(1024),e.queue_start=0,e.queue_end=0,e.queue_length=0,e.queue_size=e.queue_data.length,e.queued_samples=0,e.source_buffer_previous=r,e.source_buffer_current=r,e.source_samples_per_destination=1,e.source_block_start=0,e.source_time=0,e.source_offset=0,e.port.onmessage=function(t){switch(t.data.type){case"queue":e.queue_push(t.data.value);break;case"sampling-rate":e.source_samples_per_destination=t.data.value/sampleRate}},e}var r=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(t.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(t,AudioWorkletProcessor),t.prototype.process=t.prototype.process=function(e,t,r){for(e=0;e<t[0][0].length;e++){for(var s=r=0,i=this.source_offset+this.kernel_size,_=this.source_offset-this.kernel_size+1;_<=i;_++){var a=this.source_block_start+_;r+=this.get_sample(a,0)*this.kernel(this.source_time-_),s+=this.get_sample(a,1)*this.kernel(this.source_time-_)}(isNaN(r)||isNaN(s))&&(r=s=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),t[0][0][e]=r,t[0][1][e]=s,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return t=this.source_offset,t+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(t),!0},t.prototype.kernel=function(t){return e(t)*e(t/this.kernel_size)},t.prototype.get_sample=function(e,t){return 0>e?(e+=this.source_buffer_previous[0].length,this.source_buffer_previous[t][e]):this.source_buffer_current[t][e]},t.prototype.ensure_enough_data=function(e){var t=this.source_buffer_current[0].length;t-this.source_block_start<e&&(this.prepare_next_buffer(),this.source_block_start-=t)},t.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var e=this.source_buffer_current[0].length;if(256>e){for(var t=this.queue_start,r=0;256>e&&r<this.queue_length;)e+=this.queue_data[t][0].length,t=t+1&this.queue_size-1,r++;e=Math.max(e,256),(e=[new Float32Array(e),new Float32Array(e)])[0].set(this.source_buffer_current[0]),e[1].set(this.source_buffer_current[1]),t=this.source_buffer_current[0].length;for(var s=0;s<r;s++){var i=this.queue_shift();e[0].set(i[0],t),e[1].set(i[1],t),t+=i[0].length}this.source_buffer_current=e}this.pump()},t.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},t.prototype.queue_push=function(e){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=e,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=e[0].length,this.pump())},t.prototype.queue_shift=function(){if(!this.queue_length)return r;var e=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=e[0].length,e},t.prototype.dbg_log=function(e){DEBUG&&this.port.postMessage({type:"debug-log",value:e})},registerProcessor("dac-processor",t)}.toString()).indexOf("{")+1,_=t.lastIndexOf("}");t=t.substring(i,_),DEBUG&&(t="var DEBUG = true;\n"+t),t=new Blob([t],{type:"application/javascript"});var a=URL.createObjectURL(t);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(a).then(function(){URL.revokeObjectURL(a),s.node_processor=new AudioWorkletNode(s.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),s.node_processor.port.postMessage({type:"sampling-rate",value:s.sampling_rate}),s.node_processor.port.onmessage=function(e){switch(e.data.type){case"pump":s.pump();break;case"debug-log":dbg_log("SpeakerWorkletDAC - Worklet: "+e.data.value)}},s.node_processor.connect(s.node_output)}),this.mixer_connection=r.add_source(this.node_output,MIXER_SRC_DAC),this.mixer_connection.set_gain_hidden(3),e.register("dac-send-data",function(e){this.queue(e)},this),e.register("dac-enable",function(e){this.enabled=!0},this),e.register("dac-disable",function(){this.enabled=!1},this),e.register("dac-tell-sampling-rate",function(e){dbg_assert(0<e,"Sampling rate should be nonzero"),this.sampling_rate=e,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:e})},this),DEBUG&&(this.debugger=new SpeakerDACDebugger(this.audio_context,this.node_output))}function SpeakerBufferSourceDAC(e,t,r){this.bus=e,this.audio_context=t,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=r.add_source(this.node_output,MIXER_SRC_DAC),this.mixer_connection.set_gain_hidden(3),e.register("dac-send-data",function(e){this.queue(e)},this),e.register("dac-enable",function(e){this.enabled=!0,this.pump()},this),e.register("dac-disable",function(){this.enabled=!1},this),e.register("dac-tell-sampling-rate",function(e){dbg_assert(0<e,"Sampling rate should be nonzero"),this.sampling_rate=e,this.rate_ratio=Math.ceil(AUDIOBUFFER_MINIMUM_SAMPLING_RATE/e),this.node_lowpass.frequency.setValueAtTime(e/2,this.audio_context.currentTime)},this),DEBUG&&(this.debugger=new SpeakerDACDebugger(this.audio_context,this.node_output))}function SpeakerDACDebugger(e,t){this.audio_context=e,this.node_source=t,this.node_processor=null,this.node_gain=this.audio_context.createGain(),this.node_gain.gain.setValueAtTime(0,this.audio_context.currentTime),this.node_gain.connect(this.audio_context.destination),this.is_active=!1,this.queued_history=[],this.output_history=[],this.queued=[[],[]],this.output=[[],[]]}function SerialAdapter(e,t){function r(e){a.bus&&a.enabled&&(a.send_char(e.which),e.preventDefault())}function s(e){var t=e.which;8===t?(a.send_char(127),e.preventDefault()):9===t&&(a.send_char(9),e.preventDefault())}function i(e){if(a.enabled){for(var t=e.clipboardData.getData("text/plain"),r=0;r<t.length;r++)a.send_char(t.charCodeAt(r));e.preventDefault()}}function _(t){t.target!==e&&e.blur()}var a=this;this.enabled=!0,this.bus=t,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-char",function(e){this.show_char(e)},this),this.destroy=function(){e.removeEventListener("keypress",r,!1),e.removeEventListener("keydown",s,!1),e.removeEventListener("paste",i,!1),window.removeEventListener("mousedown",_,!1)},this.init=function(){this.destroy(),e.addEventListener("keypress",r,!1),e.addEventListener("keydown",s,!1),e.addEventListener("paste",i,!1),window.addEventListener("mousedown",_,!1)},this.init(),this.show_char=function(e){"\b"===e?(this.text=this.text.slice(0,-1),this.update()):"\r"!==e&&(this.text+=e,"\n"===e&&(this.text_new_line=!0),this.update())},this.update=function(){var e=this,t=Date.now(),r=t-this.last_update;16>r?void 0===this.update_timer&&(this.update_timer=setTimeout(function(){e.update_timer=void 0;var t=Date.now();dbg_assert(16<=t-e.last_update),e.last_update=t,e.render()},16-r)):(void 0!==this.update_timer&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=t,this.render())},this.render=function(){e.value=this.text,this.text_new_line&&(this.text_new_line=!1,e.scrollTop=1e9)},this.send_char=function(e){a.bus&&a.bus.send("serial0-input",e)}}function NetworkAdapter(e,t){this.send_data=function(e){},this.bus=t,this.socket=void 0,this.send_queue=[],this.url=e,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",function(e){this.send(e)},this)}SpeakerMixer.prototype.add_source=function(e,t){return e=new SpeakerMixerSource(this.audio_context,e,this.input_left,this.input_right),dbg_assert(!this.sources.has(t),"Mixer add source - overwritting source: "+t),this.sources.set(t,e),e},SpeakerMixer.prototype.connect_source=function(e,t){var r=this.sources.get(e);void 0===r?dbg_assert(!1,"Mixer connect - cannot connect undefined source: "+e):r.connect(t)},SpeakerMixer.prototype.disconnect_source=function(e,t){var r=this.sources.get(e);void 0===r?dbg_assert(!1,"Mixer disconnect - cannot disconnect undefined source: "+e):r.disconnect(t)},SpeakerMixer.prototype.set_volume=function(e,t){switch(void 0===t&&(t=MIXER_CHANNEL_BOTH),t){case MIXER_CHANNEL_LEFT:this.volume_left=e;break;case MIXER_CHANNEL_RIGHT:this.volume_right=e;break;case MIXER_CHANNEL_BOTH:this.volume_both=e;break;default:return void dbg_assert(!1,"Mixer set master volume - unknown channel: "+t)}this.update()},SpeakerMixer.prototype.update=function(){var e=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(e,this.audio_context.currentTime)},SpeakerMixerSource.prototype.update=function(){var e=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(e,this.audio_context.currentTime)},SpeakerMixerSource.prototype.connect=function(e){var t=!e||e===MIXER_CHANNEL_BOTH;(t||e===MIXER_CHANNEL_LEFT)&&(this.connected_left=!0),(t||e===MIXER_CHANNEL_RIGHT)&&(this.connected_right=!0),this.update()},SpeakerMixerSource.prototype.disconnect=function(e){var t=!e||e===MIXER_CHANNEL_BOTH;(t||e===MIXER_CHANNEL_LEFT)&&(this.connected_left=!1),(t||e===MIXER_CHANNEL_RIGHT)&&(this.connected_right=!1),this.update()},SpeakerMixerSource.prototype.set_volume=function(e,t){switch(void 0===t&&(t=MIXER_CHANNEL_BOTH),t){case MIXER_CHANNEL_LEFT:this.volume_left=e;break;case MIXER_CHANNEL_RIGHT:this.volume_right=e;break;case MIXER_CHANNEL_BOTH:this.volume_both=e;break;default:return void dbg_assert(!1,"Mixer set volume - unknown channel: "+t)}this.update()},SpeakerMixerSource.prototype.set_gain_hidden=function(e){this.gain_hidden=e},PCSpeaker.prototype.start=function(){this.node_oscillator.start()},SpeakerWorkletDAC.prototype.queue=function(e){this.node_processor&&(DEBUG&&this.debugger.push_queued_data(e),this.node_processor.port.postMessage({type:"queue",value:e},[e[0].buffer,e[1].buffer]))},SpeakerWorkletDAC.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")},SpeakerBufferSourceDAC.prototype.queue=function(e){var t=this;DEBUG&&this.debugger.push_queued_data(e);var r=e[0].length,s=r/this.sampling_rate;if(1<this.rate_ratio)for(var i=this.audio_context.createBuffer(2,r*this.rate_ratio,this.sampling_rate*this.rate_ratio),_=i.getChannelData(0),a=i.getChannelData(1),o=0,n=0;n<r;n++)for(var d=0;d<this.rate_ratio;d++,o++)_[o]=e[0][n],a[o]=e[1][n];else(i=this.audio_context.createBuffer(2,r,this.sampling_rate)).copyToChannel(e[0],0),i.copyToChannel(e[1],1);if((e=this.audio_context.createBufferSource()).buffer=i,e.connect(this.node_lowpass),e.addEventListener("ended",this.pump.bind(this)),i=this.audio_context.currentTime,this.buffered_time<i)for(dbg_log("Speaker DAC - Creating/Recreating reserve - shouldn't occur frequently during playback"),this.buffered_time=i,i=DAC_QUEUE_RESERVE-s,r=0;r<=i;)r+=s,this.buffered_time+=s,setTimeout(function(){return t.pump()},1e3*r);e.start(this.buffered_time),this.buffered_time+=s,setTimeout(function(){return t.pump()},0)},SpeakerBufferSourceDAC.prototype.pump=function(){this.enabled&&(this.buffered_time-this.audio_context.currentTime>DAC_QUEUE_RESERVE||this.bus.send("dac-request-data"))},SpeakerDACDebugger.prototype.start=function(e){var t=this;this.is_active=!0,this.queued=[[],[]],this.output=[[],[]],this.queued_history.push(this.queued),this.output_history.push(this.output),this.node_processor=this.audio_context.createScriptProcessor(1024,2,2),this.node_processor.onaudioprocess=function(e){t.output[0].push(e.inputBuffer.getChannelData(0).slice()),t.output[1].push(e.inputBuffer.getChannelData(1).slice())},this.node_source.connect(this.node_processor),this.node_processor.connect(this.node_gain),setTimeout(function(){t.stop()},e)},SpeakerDACDebugger.prototype.stop=function(){this.is_active=!1,this.node_source.disconnect(this.node_processor),this.node_processor.disconnect(),this.node_processor=null},SpeakerDACDebugger.prototype.push_queued_data=function(e){this.is_active&&(this.queued[0].push(e[0].slice()),this.queued[1].push(e[1].slice()))},SpeakerDACDebugger.prototype.download_txt=function(e,t){dump_file(e=this.output_history[e][t].map(function(e){return e.join(" ")}).join(" "),"dacdata.txt")},SpeakerDACDebugger.prototype.download_csv=function(e){e=this.output_history[e];for(var t=[],r=0;r<e[0].length;r++)for(var s=0;s<e[0][r].length;s++)t.push(e[0][r][s]+","+e[1][r][s]);dump_file(t.join("\n"),"dacdata.csv")},NetworkAdapter.prototype.handle_message=function(e){this.bus&&this.bus.send("net0-receive",new Uint8Array(e.data))},NetworkAdapter.prototype.handle_close=function(e){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)},NetworkAdapter.prototype.handle_open=function(e){for(e=0;e<this.send_queue.length;e++)this.send(this.send_queue[e]);this.send_queue=[]},NetworkAdapter.prototype.handle_error=function(e){},NetworkAdapter.prototype.destroy=function(){this.socket&&this.socket.close()},NetworkAdapter.prototype.connect=function(){if(this.socket){var e=this.socket.readyState;if(0===e||1===e)return}if(e=Date.now(),!(this.last_connect_attempt+this.reconnect_interval>e)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(e){return void this.handle_close(void 0)}this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this)}},NetworkAdapter.prototype.send=function(e){this.socket&&1===this.socket.readyState?this.socket.send(e):(this.send_queue.push(e),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())};var ASYNC_SAFE=!1;function V86Starter(e){function t(e,t){switch(e){case"hda":o.hda=this.disk_images.hda=t;break;case"hdb":o.hdb=this.disk_images.hdb=t;break;case"cdrom":o.cdrom=this.disk_images.cdrom=t;break;case"fda":o.fda=this.disk_images.fda=t;break;case"fdb":o.fdb=this.disk_images.fdb=t;break;case"multiboot":o.multiboot=this.disk_images.multiboot=t;break;case"bios":o.bios=t.buffer;break;case"vga_bios":o.vga_bios=t.buffer;break;case"initial_state":o.initial_state=t.buffer;break;case"fs9p_json":o.fs9p_json=t.buffer;break;default:dbg_assert(!1,e)}}function r(e,t){t&&(t.get&&t.set&&t.load?n.push({name:e,loadable:t}):(t={buffer:t.buffer,async:t.async,url:t.url,size:t.size},"bios"!==e&&"vga_bios"!==e&&"initial_state"!==e&&"multiboot"!==e||(t.async=!1),t.buffer instanceof ArrayBuffer?(t=new SyncBuffer(t.buffer),n.push({name:e,loadable:t})):"undefined"!=typeof File&&t.buffer instanceof File?(void 0===t.async&&(t.async=268435456<=t.buffer.size),t=t.async?new v86util.AsyncFileBuffer(t.buffer):new v86util.SyncFileBuffer(t.buffer),n.push({name:e,loadable:t})):t.url?t.async?(t=new v86util.AsyncXHRBuffer(t.url,t.size),n.push({name:e,loadable:t})):n.push({name:e,url:t.url,size:t.size}):dbg_log("Ignored file: url="+t.url+" buffer="+t.buffer)))}function s(){o.initial_state&&(o.memory_size=0),this.bus.send("cpu-init",o),setTimeout(function(){o.initial_state&&a.restore_state(o.initial_state),setTimeout(function(){o.fs9p&&o.fs9p_json&&o.fs9p.OnJSONLoaded(o.fs9p_json),e.autostart&&this.bus.send("cpu-run")}.bind(this),0)}.bind(this),0)}this.cpu_is_running=!1;var i=Bus.create(),_=this.bus=i[0];this.emulator_bus=i[1];var a=this.v86=new v86(this.emulator_bus);this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var o={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0},o.load_devices=!0,o.memory_size=e.memory_size||67108864,o.vga_memory_size=e.vga_memory_size||8388608,o.boot_order=e.boot_order||531,o.fastboot=e.fastboot||!1,o.fda=void 0,o.fdb=void 0,e.network_relay_url&&(this.network_adapter=new NetworkAdapter(e.network_relay_url,_),o.enable_ne2k=!0),e.disable_keyboard||(this.keyboard_adapter=new KeyboardAdapter(_)),e.disable_mouse||(this.mouse_adapter=new MouseAdapter(_,e.screen_container)),e.screen_container?this.screen_adapter=new ScreenAdapter(e.screen_container,_):e.screen_dummy&&(this.screen_adapter=new DummyScreenAdapter(_)),e.serial_container&&(this.serial_adapter=new SerialAdapter(e.serial_container,_)),e.disable_speaker||(this.speaker_adapter=new SpeakerAdapter(_));var n=[];for(i="bios vga_bios cdrom hda hdb fda fdb initial_state multiboot".split(" "),_=0;_<i.length;_++)r(i[_],e[i[_]]);e.filesystem&&(o.fs9p=e.filesystem);var d=this,h=n.length,g=function(e){if(e===h)setTimeout(s.bind(this),0);else{var r=n[e];r.loadable?(r.loadable.onload=function(s){t.call(this,r.name,r.loadable),g(e+1)}.bind(this),r.loadable.load()):v86util.load_file(r.url,{done:function(s){t.call(this,r.name,new SyncBuffer(s)),g(e+1)}.bind(this),progress:function(t){200===t.target.status?d.emulator_bus.send("download-progress",{file_index:e,file_count:h,file_name:r.url,lengthComputable:t.lengthComputable,total:t.total||r.size,loaded:t.loaded}):d.emulator_bus.send("download-error",{file_index:e,file_count:h,file_name:r.url,request:t.target})},as_text:r.as_text})}}.bind(this);g(0)}!function(){function e(e,t){this.filename=e,this.block_size=256,this.byteLength=t,this.loaded_blocks={},this.onprogress=this.onload=void 0}function t(e){this.file=e,this.byteLength=e.size,1073741824<e.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(e.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(e.size),this.onprogress=this.onload=void 0}function r(e){this.file=e,this.byteLength=e.size,this.block_size=256,this.loaded_blocks={},this.onprogress=this.onload=void 0}v86util.load_file="undefined"==typeof XMLHttpRequest?function(e,t){var r=require("fs");t.range?(dbg_assert(!t.as_text),r.open(e,"r",function(e,s){if(e)throw e;var i=t.range.length,_=new global.Buffer(i);r.read(s,_,0,i,t.range.start,function(e,a){if(e)throw e;dbg_assert(a===i),t.done&&t.done(new Uint8Array(_)),r.close(s,function(e){if(e)throw e})})})):r.readFile(e,{encoding:t.as_text?"utf-8":null},function(r,s){r?console.log("Could not read file:",e,r):(r=s,t.as_text||(r=new Uint8Array(r).buffer),t.done(r))})}:function(e,t){var r=new XMLHttpRequest;if(r.open(t.method||"get",e,!0),t.as_text||(r.responseType="arraybuffer"),t.headers)for(var s=Object.keys(t.headers),i=0;i<s.length;i++){var _=s[i];r.setRequestHeader(_,t.headers[_])}t.range&&(s=t.range.start,r.setRequestHeader("Range","bytes="+s+"-"+(s+t.range.length-1))),r.onload=function(s){4===r.readyState&&(200!==r.status&&206!==r.status?console.error("Loading the image `"+e+"` failed (status %d)",r.status):r.response&&t.done&&t.done(r.response,r))},t.progress&&(r.onprogress=function(e){t.progress(e)}),r.send(null)},v86util.AsyncXHRBuffer=e,v86util.AsyncFileBuffer=r,v86util.SyncFileBuffer=t;var s="undefined"==typeof XMLHttpRequest?function(e,t){require("fs").stat(e,function(e,r){e?t(e):t(null,r.size)})}:function(e,t){v86util.load_file(e,{done:function(e,r){(r=(e=r.getResponseHeader("Content-Range")||"").match(/\/(\d+)\s*$/))?t(null,+r[1]):t({header:e})},headers:{Range:"bytes=0-0"}})};e.prototype.load=function(){var e=this;void 0!==this.byteLength?this.onload&&this.onload({}):s(this.filename,function(t,r){t?console.assert(!1,"Cannot use: "+e.filename+". `Range: bytes=...` header not supported (Got `"+t.header+"`)"):(dbg_assert(0<=r),e.byteLength=r,e.onload&&e.onload({}))})},e.prototype.get_from_cache=function(e,t,r){r=t/this.block_size,e/=this.block_size;for(var s=0;s<r;s++)if(!this.loaded_blocks[e+s])return;if(1===r)return this.loaded_blocks[e];for(t=new Uint8Array(t),s=0;s<r;s++)t.set(this.loaded_blocks[e+s],s*this.block_size);return t},e.prototype.get=function(e,t,r){console.assert(e+t<=this.byteLength),console.assert(0==e%this.block_size),console.assert(0==t%this.block_size),console.assert(t);var s=this.get_from_cache(e,t,r);s?ASYNC_SAFE?setTimeout(r.bind(this,s),0):r(s):v86util.load_file(this.filename,{done:function(s){s=new Uint8Array(s),this.handle_read(e,t,s),r(s)}.bind(this),range:{start:e,length:t}})},e.prototype.set=function(e,t,r){console.assert(e+t.byteLength<=this.byteLength);var s=t.length;console.assert(0==e%this.block_size),console.assert(0==s%this.block_size),console.assert(s),e/=this.block_size,s/=this.block_size;for(var i=0;i<s;i++){var _=this.loaded_blocks[e+i];void 0===_&&(_=this.loaded_blocks[e+i]=new Uint8Array(this.block_size));var a=t.subarray(i*this.block_size,(i+1)*this.block_size);_.set(a),console.assert(_.byteLength===a.length)}r()},e.prototype.handle_read=function(e,t,r){e/=this.block_size,t/=this.block_size;for(var s=0;s<t;s++){var i=this.loaded_blocks[e+s];i&&r.set(i,s*this.block_size)}},e.prototype.get_buffer=function(e){e()},e.prototype.get_written_blocks=function(){var e=0;for(t in this.loaded_blocks)e++;e=new Uint8Array(e*this.block_size);var t=[],r=0;for(i in this.loaded_blocks){var s=this.loaded_blocks[i];dbg_assert(s.length===this.block_size);var i=+i;t.push(i),e.set(s,r*this.block_size),r++}return{buffer:e,indices:t,block_size:this.block_size}},t.prototype.load=function(){this.load_next(0)},t.prototype.load_next=function(e){var t=new FileReader;if(t.onload=function(t){t=new Uint8Array(t.target.result),new Uint8Array(this.buffer,e).set(t),this.load_next(e+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:e,total:this.byteLength,lengthComputable:!0}),e<this.byteLength){var r=this.file.slice(e,Math.min(e+4194304,this.byteLength));t.readAsArrayBuffer(r)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},t.prototype.get=function(e,t,r){console.assert(e+t<=this.byteLength),r(new Uint8Array(this.buffer,e,t))},t.prototype.set=function(e,t,r){console.assert(e+t.byteLength<=this.byteLength),new Uint8Array(this.buffer,e,t.byteLength).set(t),r()},t.prototype.get_buffer=function(e){e(this.buffer)},r.prototype.load=function(){this.onload&&this.onload({})},r.prototype.get=function(e,t,r){console.assert(0==e%this.block_size),console.assert(0==t%this.block_size),console.assert(t);var s=this.get_from_cache(e,t,r);s?r(s):((s=new FileReader).onload=function(s){s=new Uint8Array(s.target.result),this.handle_read(e,t,s),r(s)}.bind(this),s.readAsArrayBuffer(this.file.slice(e,e+t)))},r.prototype.get_from_cache=e.prototype.get_from_cache,r.prototype.set=e.prototype.set,r.prototype.handle_read=e.prototype.handle_read,r.prototype.get_buffer=function(e){e()},r.prototype.get_as_file=function(e){for(var t=[],r=Object.keys(this.loaded_blocks).map(Number).sort(function(e,t){return e-t}),s=0,i=0;i<r.length;i++){var _=r[i],a=this.loaded_blocks[_];_*=this.block_size,console.assert(_>=s),_!==s&&(t.push(this.file.slice(s,_)),s=_),t.push(a),s+=a.length}return s!==this.file.size&&t.push(this.file.slice(s)),e=new File(t,e),console.assert(e.size===this.file.size),e}}(),V86Starter.prototype.run=function(){this.bus.send("cpu-run")},goog.exportProperty(V86Starter.prototype,"run",V86Starter.prototype.run),V86Starter.prototype.stop=function(){this.bus.send("cpu-stop")},goog.exportProperty(V86Starter.prototype,"stop",V86Starter.prototype.stop),V86Starter.prototype.destroy=function(){this.keyboard_adapter.destroy()},goog.exportProperty(V86Starter.prototype,"destroy",V86Starter.prototype.destroy),V86Starter.prototype.restart=function(){this.bus.send("cpu-restart")},goog.exportProperty(V86Starter.prototype,"restart",V86Starter.prototype.restart),V86Starter.prototype.add_listener=function(e,t){this.bus.register(e,t,this)},goog.exportProperty(V86Starter.prototype,"add_listener",V86Starter.prototype.add_listener),V86Starter.prototype.remove_listener=function(e,t){this.bus.unregister(e,t)},goog.exportProperty(V86Starter.prototype,"remove_listener",V86Starter.prototype.remove_listener),V86Starter.prototype.restore_state=function(e){this.v86.restore_state(e)},goog.exportProperty(V86Starter.prototype,"restore_state",V86Starter.prototype.restore_state),V86Starter.prototype.save_state=function(e){setTimeout(function(){try{e(null,this.v86.save_state())}catch(t){e(t,null)}}.bind(this),0)},goog.exportProperty(V86Starter.prototype,"save_state",V86Starter.prototype.save_state),V86Starter.prototype.is_running=function(){return this.cpu_is_running},goog.exportProperty(V86Starter.prototype,"is_running",V86Starter.prototype.is_running),V86Starter.prototype.serial0_send=function(e){for(var t=0;t<e.length;t++)this.bus.send("serial0-input",e.charCodeAt(t))},goog.exportProperty(V86Starter.prototype,"serial0_send",V86Starter.prototype.serial0_send),"undefined"!=typeof module&&void 0!==module.exports?(module.exports.V86Starter=V86Starter,module.exports.V86=V86Starter):(self.V86Starter=V86Starter,self.V86=V86Starter);var WorkerBus={Connector:function(e){this.listeners={},this.pair=e,e.addEventListener("message",function(e){e=e.data;for(var t=this.listeners[e[0]],r=0;r<t.length;r++){var s=t[r];s.fn.call(s.this_value,e[1])}}.bind(this),!1)}};function DummyScreenAdapter(e){var t,r,s,i,_,a,o;this.bus=e,e.register("screen-set-mode",function(e){this.set_mode(e)},this),e.register("screen-fill-buffer-end",function(e){this.update_buffer(e[0],e[1])},this),e.register("screen-put-char",function(e){this.put_char(e[0],e[1],e[2],e[3],e[4])},this),e.register("screen-text-scroll",function(e){console.log("scroll",e)},this),e.register("screen-update-cursor",function(e){this.update_cursor(e[0],e[1])},this),e.register("screen-update-cursor-scanline",function(e){this.update_cursor_scanline(e[0],e[1])},this),e.register("screen-set-size-text",function(e){this.set_size_text(e[0],e[1])},this),e.register("screen-set-size-graphical",function(e){this.set_size_graphical(e[0],e[1])},this),this.put_char=function(e,t,r,s,i){e<o&&t<a&&(_[e=3*(e*a+t)]=r,_[e+1]=s,_[e+2]=i)},this.destroy=function(){},this.set_mode=function(e){},this.clear_screen=function(){},this.set_size_text=function(e,t){e===a&&t===o||(_=new Int32Array(e*t*3),a=e,o=t)},this.set_size_graphical=function(e,s){t=new Uint8Array(4*e*s),r=new Int32Array(t.buffer),this.bus.send("screen-tell-buffer",[r],[r.buffer])},this.set_scale=function(e,t){},this.update_cursor_scanline=function(e,t){},this.update_cursor=function(e,t){e===s&&t===i||(s=e,i=t)},this.update_buffer=function(e,t){},this.get_text_screen=function(){for(var e=[],t=0;t<o;t++)e.push(this.get_text_row(t));return e},this.get_text_row=function(e){var t="";e=3*e*a;for(var r=0;r<a;r++)t+=String.fromCharCode(_[e+3*r]);return t}}WorkerBus.Connector.prototype.register=function(e,t,r){var s=this.listeners[e];void 0===s&&(s=this.listeners[e]=[]),s.push({fn:t,this_value:r})},WorkerBus.Connector.prototype.send=function(e,t,r){dbg_assert(1<=arguments.length),this.pair&&this.pair.postMessage([e,t],r)},WorkerBus.init=function(e){return new WorkerBus.Connector(e)};var VIRTIO_MAGIC_REG=0,VIRTIO_VERSION_REG=4,VIRTIO_DEVICE_REG=8,VIRTIO_VENDOR_REG=12,VIRTIO_HOSTFEATURES_REG=16,VIRTIO_HOSTFEATURESSEL_REG=20,VIRTIO_GUESTFEATURES_REG=32,VIRTIO_GUESTFEATURESSEL_REG=36,VIRTIO_GUEST_PAGE_SIZE_REG=40,VIRTIO_QUEUESEL_REG=48,VIRTIO_QUEUENUMMAX_REG=52,VIRTIO_QUEUENUM_REG=56,VIRTIO_QUEUEALIGN_REG=60,VIRTIO_QUEUEPFN_REG=64,VIRTIO_QUEUENOTIFY_REG=80,VIRTIO_INTERRUPTSTATUS_REG=96,VIRTIO_INTERRUPTACK_REG=100,VIRTIO_STATUS_REG=112,VRING_DESC_F_NEXT=1,VRING_DESC_F_WRITE=2,VRING_DESC_F_INDIRECT=4;function hex8(e){return h(e)}var message={Debug:function(e){dbg_log([].slice.apply(arguments).join(" "),LOG_9P)},Abort:function(){if(DEBUG)throw"abort"}},LoadBinaryResource;LoadBinaryResource="undefined"!=typeof XMLHttpRequest?function(e,t,r){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){if(4==s.readyState)if(200!=s.status&&0!=s.status)r("Error: Could not load file "+e);else{var i=s.response;i?t(i):r("Error: No data received from: "+e)}},s.send(null)}:function(e,t,r){require("fs").readFile(e,function(e,s){e?r(e):t(new Uint8Array(s).buffer)})};var marshall={Marshall:function(e,t,r,s){for(var i,_=0,a=0;a<e.length;a++)switch(i=t[a],e[a]){case"w":r[s++]=255&i,r[s++]=i>>8&255,r[s++]=i>>16&255,r[s++]=i>>24&255,_+=4;break;case"d":r[s++]=255&i,r[s++]=i>>8&255,r[s++]=i>>16&255,r[s++]=i>>24&255,r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=0,_+=8;break;case"h":r[s++]=255&i,r[s++]=i>>8,_+=2;break;case"b":r[s++]=i,_+=1;break;case"s":var o=s,n=0;for(var d in r[s++]=0,r[s++]=0,_+=2,i)UnicodeToUTF8Stream(i.charCodeAt(d)).forEach(function(e){r[s++]=e,_+=1,n++});r[o+0]=255&n,r[o+1]=n>>8&255;break;case"Q":marshall.Marshall(["b","w","d"],[i.type,i.version,i.path],r,s),s+=13,_+=13;break;default:message.Debug("Marshall: Unknown type="+e[a])}return _},Unmarshall:function(e,t,r){for(var s=[],i=0;i<e.length;i++)switch(e[i]){case"w":var _=t[r++];_+=t[r++]<<8,_+=t[r++]<<16,_+=t[r++]<<24>>>0,s.push(_);break;case"d":_=t[r++],_+=t[r++]<<8,_+=t[r++]<<16,_+=t[r++]<<24>>>0,r+=4,s.push(_);break;case"h":_=t[r++],s.push(_+(t[r++]<<8));break;case"b":s.push(t[r++]);break;case"s":_=t[r++],_+=t[r++]<<8;for(var a="",o=new UTF8StreamToUnicode,n=0;n<_;n++){var d=o.Put(t[r++]);-1!=d&&(a+=String.fromCharCode(d))}s.push(a);break;default:message.Debug("Error in Unmarshall: Unknown type="+e[i])}return s},Unmarshall2:function(e,t){for(var r=[],s=0;s<e.length;s++)switch(e[s]){case"w":var i=t();i+=t()<<8,i+=t()<<16,i+=t()<<24>>>0,r.push(i);break;case"d":i=t(),i+=t()<<8,i+=t()<<16,i+=t()<<24>>>0,t(),t(),t(),t(),r.push(i);break;case"h":i=t(),r.push(i+(t()<<8));break;case"b":r.push(t());break;case"s":i=t(),i+=t()<<8;for(var _="",a=new UTF8StreamToUnicode,o=0;o<i;o++){var n=a.Put(t());-1!=n&&(_+=String.fromCharCode(n))}r.push(_);break;default:message.Debug("Error in Unmarshall2: Unknown type="+e[s])}return r}},UTF8={};function UTF8StreamToUnicode(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(e){switch(this.stream[this.ofs]=e,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if(192==(224&this.stream[0])&&128==(192&this.stream[1]))return this.ofs=0,(31&this.stream[0])<<6|63&this.stream[1]}return-1}}function UnicodeToUTF8Stream(e){return 128>e?[e]:2048>e?[192|e>>6&31,128|63&e]:void 0}UTF8.UTF8Length=function(e){for(var t=0,r=0;r<e.length;r++){t+=128>e.charCodeAt(r)?1:2}return t}}).call(this);
},{"fs":77}],11:[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("babel-runtime/regenerator"),t=l(e),r=require("babel-runtime/helpers/asyncToGenerator"),n=l(r),u=require("babel-runtime/helpers/classCallCheck"),a=l(u),i=void 0,o=require("../../node_modules/filer/dist/filer"),s=l(o);require("v86");var c=require("./config");function l(e){return e&&e.__esModule?e:{default:e}}window.Filer=s.default;var f="/ # ",d=function(){return new URL(c.stateUrl,window.location)},p=function e(r){var u=this;(0,a.default)(this,e),this.emulator=null,this.term=r,this.boot=(0,n.default)(t.default.mark(function e(){return t.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!u.emulator){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,b();case 4:if(!e.sent){e.next=9;break}u.emulator=w(u.term),e.next=12;break;case 9:return e.next=11,h(u.term);case 11:u.emulator=e.sent;case 12:case"end":return e.stop()}},e,u)})),this.suspend=function(){u.emulator&&u.emulator.is_running()&&u.emulator.stop()},this.resume=function(){u.emulator&&!u.emulator.is_running()&&u.emulator.run()}};exports.default=p;var m=function(e,t){t.reset(),t.writeln("Linux 4.15.7. Shared browser files are located in /mnt"),t.write(f),t.focus(),t.on("key",function(t){return e.serial0_send(t)}),e.add_listener("serial0-output-char",function(e){return t.write(e)})},h=function(){var e=(0,n.default)(t.default.mark(function e(r){var n,u;return t.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.write("Booting Linux"),n=setInterval(function(){r.write(".")},500),u=new window.V86Starter(c.defaultEmulatorOptions),e.next=5,x(u,r,n);case 5:return e.abrupt("return",u);case 6:case"end":return e.stop()}},e,i)}));return function(t){return e.apply(this,arguments)}}(),w=function(e){var t=c.defaultEmulatorOptions;t.initial_state={url:c.stateUrl};var r=new window.V86Starter(t);return m(r,e),r},v=function(){var e=(0,n.default)(t.default.mark(function e(r){return t.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){var t="";r.add_listener("serial0-output-char",function n(u){(t+=u).endsWith(f)&&(r.remove_listener("serial0-output-char",n),e())})}));case 1:case"end":return e.stop()}},e,i)}));return function(t){return e.apply(this,arguments)}}(),x=function(){var e=(0,n.default)(t.default.mark(function e(r,n,u){return t.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v(r);case 2:clearTimeout(u),m(r,n),r.save_state(_);case 5:case"end":return e.stop()}},e,i)}));return function(t,r,n){return e.apply(this,arguments)}}(),b=function(){return caches.open("vm-state").then(function(e){return e.match(d()).then(function(e){return!!e})})},_=function(e,t){var r=new Blob([new Uint8Array(t)],{type:"application/octet-stream"}),n=new Response(r,{status:200,statusText:"OK, Linux VM machine state cached (safe to delete)."}),u=new Headers;u.append("Content-Type","application/octet-stream"),u.append("Content-Length",r.size);var a=d(),i=new Request(a,{method:"GET",headers:u});caches.open("vm-state").then(function(e){return e.put(i,n)}).catch(function(e){return console.error(e)})};
},{"babel-runtime/regenerator":76,"babel-runtime/helpers/asyncToGenerator":66,"babel-runtime/helpers/classCallCheck":67,"../../node_modules/filer/dist/filer":64,"v86":65,"./config":10}],5:[function(require,module,exports) {
"use strict";var e=require("xterm"),r=require("xterm/lib/addons/fit/fit"),n=a(r),t=require("./config"),o=require("./vm"),i=u(o);function u(e){return e&&e.__esModule?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r.default=e,r}window.addEventListener("DOMContentLoaded",function(){e.Terminal.applyAddon(n);var r=window.term=new e.Terminal({theme:t.molokaiTheme});r.open(document.getElementById("terminal")),r.fit();var o=new i.default(r);r.on("focus",o.resume),r.on("blur",o.suspend),o.boot()});
},{"xterm":9,"xterm/lib/addons/fit/fit":12,"./config":10,"./vm":11}]},{},[5], null)
//# sourceMappingURL=/next/ui.1dedc83f.map